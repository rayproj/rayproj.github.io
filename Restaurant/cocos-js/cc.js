System.register([],(function(e,t){"use strict";return{execute:function(){function n(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function i(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}function r(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function a(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}e({BitMask:it,CCClass:Zt,CacheMode:void 0,DebugMode:void 0,Enum:rt,Eventify:$l,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,NodeEventType:void 0,NodeSpace:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,TransformBit:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:kb,WorldNode3DToWorldNodeUI:Gb,absMax:Cn,absMaxComponent:Tn,approx:sn,assert:E,assertID:L,bezier:b_,bezierByTime:W_,ccenum:st,clamp:cn,clamp01:ln,color:wn,computeRatioByType:R1,createDefaultPipeline:UO,debug:T,deserialize:Oh,earcut:jW,enumerableProps:An,equals:on,error:x,errorID:O,find:LR,fragmentText:EB,getBaselineOffset:function(){return 0},getEnglishWordPartAtFirst:SB,getEnglishWordPartAtLast:xB,getError:F,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[Rc]},getWorldTransformUntilRoot:nZ,instantiate:Kh,inverseLerp:En,isDisplayStats:B,isEnglishWordPartAtFirst:function(e){return pB.test(e)},isEnglishWordPartAtLast:function(e){return dB.test(e)},isUnicodeCJK:mB,isUnicodeSpace:vB,isValid:pl,lerp:un,log:y,logID:w,markAsWarning:void 0,mat4:qn,murmurhash2_32_gc:Sa,nextPow2:yn,pingPong:xn,pseudoRandom:mn,pseudoRandomRange:vn,pseudoRandomRangeInt:gn,quat:Hn,randomRange:dn,randomRangeInt:pn,rect:ri,removeProperty:void 0,repeat:Sn,replaceProperty:void 0,safeMeasureText:gB,sampleAnimationCurve:P1,setDefaultLogTimes:function(e){e>0&&(X=e)},setDisplayStats:z,size:ni,toDegree:fn,toRadian:hn,tween:hne,tweenUtil:fne,v2:Jn,v3:On,v4:$n,warn:S,warnID:R});var o=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(o);var s=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(e){return(e>0)-(e<0)},abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:n,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:i,countTrailingZeros:r,nextPow2:a,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return o[255&e]<<24|o[e>>>8&255]<<16|o[e>>>16&255]<<8|o[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>r(e)+1}});e("bits",s);var c="undefined"==typeof window?global:window,l=e("cclegacy",{_global:c});l.internal={},c.CC_BUILD=!0,c.CC_TEST=!1,c.CC_EDITOR=false,c.CC_PREVIEW=!1,c.CC_DEV=!1,c.CC_DEBUG=!1,c.CC_JSB=!1,c.CC_BYTEDANCE=!1,c.CC_WECHAT=!1,c.CC_ALIPAY=!1,c.CC_XIAOMI=!1,c.CC_BAIDU=!1,c.CC_COCOSPLAY=!1,c.CC_HUAWEI=!1,c.CC_OPPO=!1,c.CC_VIVO=!1,c.CC_MINIGAME=!1,c.CC_RUNTIME_BASED=!1,c.CC_SUPPORT_JIT=!0;var u=e("VERSION","3.5.2");c.CocosEngine=l.ENGINE_VERSION=u,c.cc=l;var h="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",f=null,_=console.log.bind(console),d=_,p=_,m=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+g.apply(void 0,[t].concat(i)))}},v=_;function g(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return l.js.formatStr.apply(null,[e].concat(n))}function y(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return _.apply(void 0,[e].concat(n))}function S(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return d.apply(void 0,[e].concat(n))}function x(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return p.apply(void 0,[e].concat(n))}function E(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return m.apply(void 0,[e,t].concat(i))}function T(){return v.apply(void 0,arguments)}function C(e){if(_=d=p=m=v=function(){},e!==N.NONE){if(e>N.ERROR){var t=function(e){if(l.game.canvas){if(!f){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",l.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(f=document.createElement("textarea")).setAttribute("rows","20"),f.setAttribute("cols","30"),f.setAttribute("disabled","true");var i=f.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(f),l.game.canvas.parentNode.appendChild(t)}f.value=f.value+e+"\r\n",f.scrollTop=f.scrollHeight}};p=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+g.apply(void 0,[e].concat(i)))},m=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),a=2;a<i;a++)r[a-2]=arguments[a];t("ASSERT: "+g.apply(void 0,[n].concat(r)))}},e!==N.ERROR_FOR_WEB_PAGE&&(d=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+g.apply(void 0,[e].concat(i)))}),e===N.INFO_FOR_WEB_PAGE&&(_=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(g.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),p=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},m=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var a=g.apply(void 0,[t].concat(i));throw new Error(a)}});if(e!==N.ERROR&&(d=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=N.INFO&&(_=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=N.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);v=function(){return n.apply(void 0,arguments)}}}}function A(e){x(e.stack||e)}function b(e){return function(t){for(var n=e+" "+t+", please go to "+h+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),a=1;a<i;a++)r[a-1]=arguments[a];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var I=b("Log");function w(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];y(I.apply(void 0,[e].concat(n)))}var P=b("Warning");function R(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];S(P.apply(void 0,[e].concat(n)))}var D=b("Error");function O(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];x(D.apply(void 0,[e].concat(n)))}var N,M=b("Assert");function L(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];E(!1,M.apply(void 0,[t].concat(i)))}}function F(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return D.apply(void 0,[e].concat(n))}function B(){return!!l.profiler&&l.profiler.isShowingStats()}function z(e){l.profiler&&(e?l.profiler.showStats():l.profiler.hideStats(),l.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(N||(N=e("DebugMode",{})));var U,k,G,H,V,W,j=Object.freeze({__proto__:null,log:y,warn:S,error:x,assert:E,debug:T,_resetDebugSetting:C,_throw:A,logID:w,warnID:R,errorID:O,assertID:L,get DebugMode(){return N},getError:F,isDisplayStats:B,setDisplayStats:z}),X=10,q=0,Y=new Map;function K(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Q(e,t,n){return t&&K(e.prototype,t),n&&K(e,n),e}function J(){return(J=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function Z(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ee(e,t)}function $(e){return($=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ee(e,t){return(ee=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function te(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function ne(e,t,n){return(ne=te()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&ee(r,n.prototype),r}).apply(null,arguments)}function ie(e){var t="function"==typeof Map?new Map:void 0;return(ie=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return ne(e,arguments,$(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),ee(i,e)})(e)}function re(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ae(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function oe(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ae(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ae(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function se(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function ce(e,t,n,i,r){var a={};return Object.keys(i).forEach((function(e){a[e]=i[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}H=function(e,t,n,i,r,a,o){var s=Y.get(a);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+o,e+"."+t,n+"."+i),s.count++)},U=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=q++;Y.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var r=null!=n.target?n.target:e,a=null!=n.newName?n.newName:n.name,o=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return H(t,n.name,o,a,S,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return H(t,n.name,o,a,S,i,c),n.customGetter.call(this)},set:function(e){H(t,n.name,o,a,S,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){H(t,n.name,o,a,S,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return H(t,n.name,o,a,S,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return H(t,n.name,o,a,S,i,c),s?this[a]:r[a]},set:function(e){H(t,n.name,o,a,S,i,c),s?this[a]=e:r[a]=e},enumerable:!1})}))})),W=function(e,t,n,i,r){var a=Y.get(i);a&&a.logTimes>a.count&&(n("'%s' has been removed. "+r,e+"."+t),a.count++)},k=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=q++;Y.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return W(t,n.name,x,i,r)},set:function(){W(t,n.name,x,i,r)},enumerable:!1})}))})),V=function(e,t,n,i,r){var a=Y.get(i);a&&a.logTimes>a.count&&(n("'%s' is deprecated. "+r,e+"."+t),a.count++)},G=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var a=q++;Y.set(a,{id:a,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var o=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return V(t,i,S,a,o),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return V(t,i,S,a,o),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){V(t,i,S,a,o),c=e}})}else!function(t,n,i,r,a,o){if(t.get){var s=t.get;t.get=function(){return V(n,i,r,a,o),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){V(n,i,r,a,o),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,S,a,o);Object.defineProperty(e,i,{enumerable:!1})}}))}));var le=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},Q(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function ue(e,t){e.splice(t,1)}function he(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function fe(e,t){var n=e.indexOf(t);return n>=0&&(ue(e,n),!0)}function _e(e,t){return e.indexOf(t)>=0}var de=Object.freeze({__proto__:null,removeAt:ue,fastRemoveAt:he,remove:fe,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return ue(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=oe(e);!(n=i()).done;)if(!(n.value instanceof t))return w(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)fe(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:_e,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:le}),pe=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();pe.global=new pe("global");var me=new pe("TmpCId."),ve="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),ge="__cid__";function ye(e){return"number"==typeof e||e instanceof Number}function Se(e){return"string"==typeof e||e instanceof String}function xe(e){for(var t in e)return!1;return!0}var Ee,Te=(Ee={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){Ee.value=n,Ee.writable=i,Ee.enumerable=r,Object.defineProperty(e,t,Ee),Ee.value=void 0}),Ce=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,a,o){void 0===a&&(a=!1),void 0===o&&(o=!1),"boolean"==typeof r&&(a=r,r=void 0),e.get=i,e.set=r,e.enumerable=a,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),Ae=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,a){e.get=i,e.enumerable=r,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0}}(),be=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,a){e.set=i,e.enumerable=r,e.configurable=a,Object.defineProperty(t,n,e),e.set=void 0}}();function Ie(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function we(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?/\[\w+\s*(\w+)\]/.exec(r):/function\s*(\w+)/.exec(r))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?we(e.constructor):""}function Pe(e,t,n,i){var r=/([^.]+)$/,a=r.exec(t)[0],o=r.exec(n)[0];function s(){return this[o]}i?Ce(e,a,s,(function(e){this[o]=e})):Ae(e,a,s)}function Re(e,t,n,i){for(var r in n)Pe(e,t+"."+r,n[r],i)}var De=/(%d)|(%s)/,Oe=/%s/;function Ne(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&De.test(e);if(r)for(var a,o=oe(n);!(a=o()).done;){var s=a.value,c="number"==typeof s?De:Oe;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=oe(n);!(u=h()).done;){var f=u.value;e+=" "+f}return e}function Me(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function Le(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Fe(e,t,n){var i=Le(t,e);i&&Object.defineProperty(n,e,i)}function Be(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];if(o){if("object"!=typeof o){O(5402,o);continue}for(var s in o)s in e||Fe(s,o,e)}}return e}function ze(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];if(o){if("object"!=typeof o){O(5403,o);continue}for(var s in o)Fe(s,o,e)}}return e}function Ue(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function ke(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function Ge(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=ke(e)))return!1;if(e===t)return!0}}return!1}function He(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Ve=Ie(!0),We=Ie(!0);function je(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],Te(i.prototype,e,n),n){var r=t[n];r&&r!==i?x("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var Xe=je("__cid__",Ve),qe=je("__classname__",We);function Ye(e,t){if(qe(e,t),!t.prototype.hasOwnProperty(ge)){var n=e||me.getNewId();n&&Xe(n,t)}}function Ke(e,t){var n=We[t],i=Ve[t],r=!0;if(n&&n!==e&&(x('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(x('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var a=e[ve];a||(a=[],e[ve]=a),a.push(t),We[t]=e,Ve[t]=e}}function Qe(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var a=r[i],o=a.prototype,s=o.__cid__;s&&delete Ve[s];var c=o.__classname__;c&&delete We[c];var l=o[ve];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete We[h],delete Ve[h]}}}function Je(e){return Ve[e]}function Ze(e){return We[e]}function $e(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(ge))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(ge))return e.__cid__}return""}var et=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),tt=de,nt={IDGenerator:pe,Pool:et,array:de,isNumber:ye,isString:Se,isEmptyObject:xe,getPropertyDescriptor:Le,addon:Be,mixin:ze,extend:Ue,getSuper:ke,isChildClassOf:Ge,clear:He,value:Te,getset:Ce,get:Ae,set:be,unregisterClass:Qe,getClassName:we,setClassName:Ye,setClassAlias:Ke,getClassByName:Ze,get _registeredClassNames(){return J({},We)},set _registeredClassNames(e){He(We),Object.assign(We,e)},get _registeredClassIds(){return J({},Ve)},set _registeredClassIds(e){He(Ve),Object.assign(Ve,e)},_getClassId:$e,_setClassId:Xe,_getClassById:Je,obsolete:Pe,obsoletes:Re,formatStr:Ne,shiftArguments:Me,createMap:Ie};function it(e){if("__bitmask__"in e)return e;Te(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o=""+a;r!==o&&Te(e,o,r)}return e}function rt(e){return"__enums__"in e?e:(Te(e,"__enums__",null,!0),rt.update(e))}function at(e){e.hasOwnProperty("__enums__")}function ot(e){at(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function st(e){"__enums__"in e||Te(e,"__enums__",null,!0)}l.js=nt,e("js",Object.freeze({__proto__:null,array:tt,js:nt,IDGenerator:pe,Pool:et,isNumber:ye,isString:Se,isEmptyObject:xe,value:Te,getset:Ce,get:Ae,set:be,createMap:Ie,getClassName:we,obsolete:Pe,obsoletes:Re,formatStr:Ne,shiftArguments:Me,getPropertyDescriptor:Le,addon:Be,mixin:ze,extend:Ue,getSuper:ke,isChildClassOf:Ge,clear:He,_idToClass:Ve,_nameToClass:We,_setClassId:Xe,setClassName:Ye,setClassAlias:Ke,unregisterClass:Qe,_getClassById:Je,getClassByName:Ze,_getClassId:$e})),it.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},it.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},l.BitMask=it,rt.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o=""+a;r!==o&&Te(e,o,r)}return Array.isArray(e.__enums__)&&ot(e),e},rt||(rt=e("Enum",{})),rt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},rt.getList=function(e){return at(e),e.__enums__?e.__enums__:ot(e)},l.Enum=rt;var ct=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return O(100,we(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){O(100,we(this)+".set")},t.toString=function(){return""},e}());Ye("cc.ValueType",ct),l.ValueType=ct;var lt=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});l.macro=lt;for(var ut=/^(?:cc|dragonBones|sp|ccsg)\..+/,ht=new Array(123),ft=0;ft<123;++ft)ht[ft]=64;for(var _t=0;_t<64;++_t)ht["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(_t)]=_t;var dt=ht;function pt(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var a=e[n];Ce(e,t,a,e[i])}}for(var r,a=e.prototype,o=0;o<t.length;o++){var s=(r=t[o])[0].toUpperCase()+r.slice(1);i(a,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(a,r,c[0],c[1])}}function mt(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function vt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function gt(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function yt(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function St(e){return!(!e||e.constructor!==Object)&&xe(e)}function xt(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function Et(e){return e*lt.RAD}function Tt(e){return e*lt.DEG}l.misc={BUILTIN_CLASSID_RE:ut,BASE64_VALUES:dt,propertyDefine:pt,pushToMap:mt,contains:vt,isDomNode:gt,callInNextTick:yt,isPlainEmptyObj_DEV:St,clampf:xt,degreesToRadians:Et,radiansToDegrees:Tt},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:ut,BASE64_VALUES:dt,propertyDefine:pt,pushToMap:mt,contains:vt,isDomNode:gt,callInNextTick:yt,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:St,clampf:xt,degreesToRadians:Et,radiansToDegrees:Tt}));var Ct="$_$";function At(e,t){var n=t?Object.create(t):{};return Te(e,"__attrs__",n),n}function bt(e){if("function"!=typeof e)return At(e,wt(e.constructor));for(var t,n=l.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||At(r,(t=n[i+1])&&t.__attrs__)}return At(e,(t=n[0])&&t.__attrs__),e.__attrs__}function It(e,t){var n=wt(e),i=t+Ct,r={};for(var a in n)a.startsWith(i)&&(r[a.slice(i.length)]=n[a]);return r}function wt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||bt(e)}function Pt(e,t,n,i){wt(e)[t+Ct+n]=i}var Rt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),Dt=e("CCInteger",new Rt("Integer",0));l.Integer=Dt,l.CCInteger=Dt;var Ot=e("CCFloat",new Rt("Float",0));l.Float=Ot,l.CCFloat=Ot;var Nt=e("CCBoolean",new Rt("Boolean",!1));l.Boolean=Nt,l.CCBoolean=Nt;var Mt=e("CCString",new Rt("String",""));function Lt(e,t){return function(n,i){var r='"'+we(n)+"."+i+'"',a=It(n,i),o=a.type;if(o===Dt||o===Ot?o="Number":o!==Mt&&o!==Nt||(o=""+o),o===e){if(a.hasOwnProperty("default")){var s=a.default;if(void 0!==s&&!Array.isArray(s)&&!St(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof a.ctor)return;R(3605,r,we(a.ctor))}else"Number"!==e&&R(3606,t,r,e);else{if("function"===c)return;e===Mt.default&&null==s?R(3607,r):R(3611,t,r,c)}delete a.type}}}else R(3604,r)}}l.String=Mt,l.CCString=Mt;var Ft=Object.freeze({__proto__:null,DELIMETER:Ct,createAttrsSingle:At,createAttrs:bt,attr:It,getClassAttrs:wt,setClassAttr:Pt,PrimitiveType:Rt,CCInteger:Dt,CCFloat:Ot,CCBoolean:Nt,CCString:Mt,getTypeChecker_ET:Lt,getObjTypeChecker_ET:function(e){return function(t,n){Lt("Object","type")(t,n);var i=wt(t)[n+Ct+"default"],r=l.Class.getDefault(i);if(!Array.isArray(r)&&Ge(e,l.ValueType)){var a=we(e),o=Ne('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',we(t),n,a);i?y(o):R(3612,o,a,we(t),n,a)}}}}),Bt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function zt(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var a={};for(var o in i[r]=a,Bt){var s=Bt[o];e.hasOwnProperty(o)&&(a[o]=e[o],s.canUsedInGet||delete e[o])}}}function Ut(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return O(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=l.String:t===Boolean?e.type=l.Boolean:t===Number&&(e.type=l.Float))}function kt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Gt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return kt(t,[],e);if("function"==typeof e){var n=e;return kt(t,Ge(n,l.ValueType)?new n:null,n)}return kt(t,e instanceof Rt?e.default:e)}return null}var Ht,Vt=[];function Wt(){return Vt[Vt.length-1]}l._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Vt.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Vt.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Wt},function(e){e[e.STANDALONE=1]="STANDALONE",e[e.IMPLICIT_VISIBLE=2]="IMPLICIT_VISIBLE",e[e.IMPLICIT_SERIALIZABLE=4]="IMPLICIT_SERIALIZABLE"}(Ht||(Ht={}));var jt=Ct,Xt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var a=we(i);r?Jt(i,a,r,i.$super,n.mixins):O(3633,a)}this.datas=null}}};function qt(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),tn(e,i,t,n)}function Yt(e,t,n,i){var r=i.get;i.set,r&&(tn(e,i,t,n),Pt(e,n,"serializable",!1))}function Kt(e){return"function"==typeof e?e():e}function Qt(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,Le(t,i))}function Jt(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var a=0;a<r.length;++a){var o=r[a];o.__props__&&(e.__props__=e.__props__.concat(o.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Gt(i,!1);if(r&&(i=e[n]=r),i){var a=i.notify;a&&zt(i,n,a,e),"type"in i&&Ut(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?Yt(e,t,s,c):qt(e,t,s,c)}var l=wt(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+jt+"serializable"]}))}function Zt(e){var t=e.name,n=e.extends,i=e.mixins,r=function(e,t,n,i){var r=l.Component,a=Wt();if(a&&Ge(t,r)){if(Ge(a.cls,r))return O(3615),null;e=e||a.script}var o=function(e,t,n,i){var r=i.ctor,a=[r],o=r;Te(o,"__ctors__",a.length>0?a:null,!0);var s=o.prototype;if(t&&(o.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Qt(s,l.prototype),Zt._isCCClass(l)&&Qt(wt(o),wt(l))}s.constructor=o}return Ye(e,o),o}(e,t,n,i);if(a)if(Ge(t,r)){var s=a.uuid;s&&Xe(s,o),a.cls=o}else Ge(a.cls,r)||(a.cls=o);return o}(t,n,i,e);t||(t=l.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var a=e.properties;"function"==typeof a||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(Xt.push({cls:r,props:a,mixins:i}),r.__props__=r.__values__=null):Jt(r,t,a,n,e.mixins);var o=e.editor;return o&&Ge(n,l.Component)&&l.Component._registerEditorProps(r,o),r}function $t(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__values__")}Zt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},Zt.fastDefine=function(e,t,n){Ye(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=wt(t),a=0;a<i.length;a++){var o=i[a];r[o+jt+"visible"]=!1,r[o+jt+"default"]=n[o]}},Zt.Attr=Ft,Zt.attr=It,Zt.getInheritanceChain=function(e){for(var t=[];e=ke(e);)e!==Object&&t.push(e);return t};var en={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function tn(e,t,n,i){var r=null,a="";function o(){return a=i+jt,r=wt(e)}"type"in t&&void 0===t.type&&R(3660,i,n);var s=t.type;s&&(en[s]?(r||o())[a+"type"]=s:"Object"===s||("object"==typeof s?rt.isEnum(s)?((r||o())[a+"type"]="Enum",r[a+"enumList"]=rt.getList(s)):it.isBitMask(s)&&((r||o())[a+"type"]="BitMask",r[a+"bitmaskList"]=it.getList(s)):"function"==typeof s&&((r||o())[a+"type"]="Object",r[a+"ctor"]=s))),"default"in t&&((r||o())[a+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||o())[a+e]=i)}};t.editorOnly&&((r||o())[a+"editorOnly"]=!0),t.__internalFlags&Ht.STANDALONE?c=!0===t.serializable||0!=(t.__internalFlags&Ht.IMPLICIT_SERIALIZABLE):!1===t.serializable&&(c=!1),void 0!==c&&((r||o())[a+"serializable"]=c),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||o())[a+"min"]=u[0],r[a+"max"]=u[1],u.length>2&&(r[a+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Zt.isArray=function(e){return e=Kt(e),Array.isArray(e)},Zt.getDefault=Kt,Zt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Zt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Zt.getNewValueTypeCode=function(e){for(var t=we(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},l.Class=Zt;var nn=Math.PI/180,rn=180/Math.PI,an=e("EPSILON",1e-6);function on(e,t){return Math.abs(e-t)<=an*Math.max(1,Math.abs(e),Math.abs(t))}function sn(e,t,n){return n=n||an,Math.abs(e-t)<=n}function cn(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function ln(e){return e<0?0:e>1?1:e}function un(e,t,n){return e+(t-e)*n}function hn(e){return e*nn}function fn(e){return e*rn}var _n=e("random",Math.random);function dn(e,t){return Math.random()*(t-e)+e}function pn(e,t){return Math.floor(dn(e,t))}function mn(e){return(e=(9301*e+49297)%233280)/233280}function vn(e,t,n){return mn(e)*(n-t)+t}function gn(e,t,n){return Math.floor(vn(e,t,n))}function yn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Sn(e,t){return e-Math.floor(e/t)*t}function xn(e,t){return e=Sn(e,2*t),t-Math.abs(e-t)}function En(e,t,n){return(n-e)/(t-e)}function Tn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function Cn(e,t){return Math.abs(e)>Math.abs(t)?e:t}function An(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var bn=1/255,In=e("Color",function(e){function t(t,n,i,r){var a;return(a=e.call(this)||this)._val=0,"string"==typeof t?a.fromHEX(t):void 0!==n?a.set(t,n,i,r):a.set(t),a}Z(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var n=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(n)?255:n,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,a=t.g,o=t.b,s=t.a;return r+=(n.r-r)*i,a+=(n.g-a)*i,o+=(n.b-o)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(o<<16)+(a<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,a=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,a+=(e.a-a)*t,this._val=Math.floor((a<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*bn).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,a=0;if(0===t)i=r=a=n;else if(0===n)i=r=a=0;else{1===e&&(e=0),e*=6;var o=Math.floor(e),s=e-o,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(o){case 0:i=n,r=u,a=c;break;case 1:i=l,r=n,a=c;break;case 2:i=c,r=n,a=u;break;case 3:i=c,r=l,a=n;break;case 4:i=u,r=c,a=n;break;case 5:i=n,r=c,a=l}}return i*=255,r*=255,a*=255,this._val=(this.a<<24>>>0)+(a<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*bn,t=this.g*bn,n=this.b*bn,i={h:0,s:0,v:0},r=Math.max(e,t,n),a=Math.min(e,t,n),o=0;return i.v=r,i.s=r?(r-a)/r:0,i.s?(o=r-a,i.h=e===r?(t-n)/o:t===r?2+(n-e)/o:4+(e-t)/o,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},Q(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~cn(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~cn(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~cn(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~cn(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*bn},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*bn},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*bn},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*bn},set:function(e){this.a=255*e}}]),t}(ct));function wn(e,t,n,i){return new In(e,t,n,i)}In.WHITE=Object.freeze(new In(255,255,255,255)),In.GRAY=Object.freeze(new In(127,127,127,255)),In.BLACK=Object.freeze(new In(0,0,0,255)),In.TRANSPARENT=Object.freeze(new In(0,0,0,0)),In.RED=Object.freeze(new In(255,0,0,255)),In.GREEN=Object.freeze(new In(0,255,0,255)),In.BLUE=Object.freeze(new In(0,0,255,255)),In.CYAN=Object.freeze(new In(0,255,255,255)),In.MAGENTA=Object.freeze(new In(255,0,255,255)),In.YELLOW=Object.freeze(new In(255,255,0,255)),Zt.fastDefine("cc.Color",In,{r:0,g:0,b:0,a:255}),l.Color=In,l.color=wn;var Pn=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}Z(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<an?e.x=0:e.x=1/n,Math.abs(i)<an?e.y=0:e.y=1/i,Math.abs(r)<an?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,a=n*n+i*i+r*r;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.x,s=n.y,c=n.z;return e.x=r*c-a*s,e.y=a*o-i*c,e.z=i*s-r*o,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*_n()*Math.PI,i=2*_n()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.m03*i+n.m07*r+n.m11*a+n.m15;return o=o?Math.abs(1/o):1,e.x=(n.m00*i+n.m04*r+n.m08*a+n.m12)*o,e.y=(n.m01*i+n.m05*r+n.m09*a+n.m13)*o,e.z=(n.m02*i+n.m06*r+n.m10*a+n.m14)*o,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.m03*i+n.m07*r+n.m11*a;return o=o?Math.abs(1/o):1,e.x=(n.m00*i+n.m04*r+n.m08*a)*o,e.y=(n.m01*i+n.m05*r+n.m09*a)*o,e.z=(n.m02*i+n.m06*r+n.m10*a)*o,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,a=t.z;return e.x=i*n.m00+r*n.m03+a*n.m06,e.y=i*n.m01+r*n.m04+a*n.m07,e.z=i*n.m02+r*n.m05+a*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,a=t.z;return e.x=n.m00*i+n.m04*r+n.m08*a+n.m12,e.y=n.m01*i+n.m05*r+n.m09*a+n.m13,e.z=n.m02*i+n.m06*r+n.m10*a+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,a=n.w*t.z+n.x*t.y-n.y*t.x,o=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+o*-n.x+r*-n.z-a*-n.y,e.y=r*n.w+o*-n.y+a*-n.x-i*-n.z,e.z=a*n.w+o*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var a=t.x*r.x,o=t.y*r.y,s=t.z*r.z,c=n.w*a+n.y*s-n.z*o,l=n.w*o+n.z*a-n.x*s,u=n.w*s+n.x*o-n.y*a,h=-n.x*a-n.y*o-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var a=t.x-i.x,o=t.y-i.y,s=t.z-i.z,c=n.w*a-n.y*s+n.z*o,l=n.w*o-n.z*a+n.x*s,u=n.w*s-n.x*o+n.y*a,h=n.x*a+n.y*o+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=a*s-o*c,h=a*c+o*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=o*c+r*s,u=a,h=o*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,a=t.y-n.y,o=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-a*c,u=r*c+a*s,h=o;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=an);var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,c=t.z;return Math.abs(i-o)<=n*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(a-c)<=n*Math.max(1,Math.abs(a),Math.abs(c))},t.angle=function(e,n){t.normalize(Rn,e),t.normalize(Dn,n);var i=t.dot(Rn,Dn);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=an),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=cn(this.x,e.x,t.x),this.y=cn(this.y,e.y,t.y),this.z=cn(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,a=e.y,o=e.z;return this.x=n*o-i*a,this.y=i*r-t*o,this.z=t*a-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(ct));Pn.UNIT_X=Object.freeze(new Pn(1,0,0)),Pn.UNIT_Y=Object.freeze(new Pn(0,1,0)),Pn.UNIT_Z=Object.freeze(new Pn(0,0,1)),Pn.RIGHT=Object.freeze(new Pn(1,0,0)),Pn.UP=Object.freeze(new Pn(0,1,0)),Pn.FORWARD=Object.freeze(new Pn(0,0,-1)),Pn.ZERO=Object.freeze(new Pn(0,0,0)),Pn.ONE=Object.freeze(new Pn(1,1,1)),Pn.NEG_ONE=Object.freeze(new Pn(-1,-1,-1));var Rn=new Pn,Dn=new Pn;function On(e,t,n){return new Pn(e,t,n)}Zt.fastDefine("cc.Vec3",Pn,{x:0,y:0,z:0}),l.Vec3=Pn,l.v3=On;var Nn=e("Mat3",function(e){function t(t,n,i,r,a,o,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=a,u.m05=o,u.m06=s,u.m07=c,u.m08=l),u}Z(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,a,o,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*o-s*l,f=-u*a+s*c,_=l*a-o*c,d=n*h+i*f+r*_;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=h*d,e.m01=(-u*i+r*l)*d,e.m02=(s*i-r*o)*d,e.m03=f*d,e.m04=(u*n-r*c)*d,e.m05=(-s*n+r*a)*d,e.m06=_*d,e.m07=(-l*n+i*c)*d,e.m08=(o*n-i*a)*d,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*a-o*c)+n*(-l*r+o*s)+i*(c*r-a*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.m00,_=n.m01,d=n.m02,p=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,S=n.m08;return e.m00=f*i+_*o+d*l,e.m01=f*r+_*s+d*u,e.m02=f*a+_*c+d*h,e.m03=p*i+m*o+v*l,e.m04=p*r+m*s+v*u,e.m05=p*a+m*c+v*h,e.m06=g*i+y*o+S*l,e.m07=g*r+y*s+S*u,e.m08=g*a+y*c+S*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.m00,_=n.m01,d=n.m02,p=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,S=n.m10;return e.m00=f*i+_*o+d*l,e.m01=f*r+_*s+d*u,e.m02=f*a+_*c+d*h,e.m03=p*i+m*o+v*l,e.m04=p*r+m*s+v*u,e.m05=p*a+m*c+v*h,e.m06=g*i+y*o+S*l,e.m07=g*r+y*s+S*u,e.m08=g*a+y*c+S*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.x,_=n.y;return e.m00=i,e.m01=r,e.m02=a,e.m03=o,e.m04=s,e.m05=c,e.m06=f*i+_*o+l,e.m07=f*r+_*s+u,e.m08=f*a+_*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=Math.sin(n),_=Math.cos(n);return e.m00=_*i+f*o,e.m01=_*r+f*s,e.m02=_*a+f*c,e.m03=_*o-f*i,e.m04=_*s-f*r,e.m05=_*c-f*a,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return Pn.lengthSqr(n)<an*an?(t.identity(e),e):(i=i||Pn.UNIT_Y,Pn.normalize(Mn,Pn.cross(Mn,i,n)),Pn.lengthSqr(Mn)<an*an?(t.identity(e),e):(Pn.cross(Ln,n,Mn),t.set(e,Mn.x,Mn.y,Mn.z,Ln.x,Ln.y,Ln.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n+n,s=i+i,c=r+r,l=n*o,u=i*o,h=i*s,f=r*o,_=r*s,d=r*c,p=a*o,m=a*s,v=a*c;return e.m00=1-h-d,e.m03=u-v,e.m06=f+m,e.m01=u+v,e.m04=1-l-d,e.m07=_-p,e.m02=f-m,e.m05=_+p,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,S=n*l-a*o,x=i*c-r*s,E=i*l-a*s,T=r*l-a*c,C=u*p-h*d,A=u*m-f*d,b=u*v-_*d,I=h*m-f*p,w=h*v-_*p,P=f*v-_*m,R=g*P-y*w+S*I+x*b-E*A+T*C;return R?(R=1/R,e.m00=(s*P-c*w+l*I)*R,e.m01=(c*b-o*P-l*A)*R,e.m02=(o*w-s*b+l*C)*R,e.m03=(r*w-i*P-a*I)*R,e.m04=(n*P-r*b+a*A)*R,e.m05=(i*b-n*w-a*C)*R,e.m06=(p*T-m*E+v*x)*R,e.m07=(m*S-d*T-v*y)*R,e.m08=(d*E-p*S+v*g)*R,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,a,o,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=a,this.m06=o,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=c*r-a*s,u=-c*i+a*o,h=s*i-r*o,f=e*l+t*u+n*h;return 0===f?(this.set(0,0,0,0,0,0,0,0,0),this):(f=1/f,this.m00=l*f,this.m01=(-c*t+n*s)*f,this.m02=(a*t-n*r)*f,this.m03=u*f,this.m04=(c*e-n*o)*f,this.m05=(-a*e+n*i)*f,this.m06=h*f,this.m07=(-s*e+t*o)*f,this.m08=(r*e-t*i)*f,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08;return e*(c*r-a*s)+t*(-c*i+a*o)+n*(s*i-r*o)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,f=e.m02,_=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+f*s,this.m01=u*n+h*a+f*c,this.m02=u*i+h*o+f*l,this.m03=_*t+d*r+p*s,this.m04=_*n+d*a+p*c,this.m05=_*i+d*o+p*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*a+g*c,this.m08=m*i+v*o+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*a,this.m02=h*i+u*o,this.m03=h*r-u*t,this.m04=h*a-u*n,this.m05=h*o-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,a=t+t,o=n+n,s=i+i,c=t*a,l=n*a,u=n*o,h=i*a,f=i*o,_=i*s,d=r*a,p=r*o,m=r*s;return this.m00=1-u-_,this.m03=l-m,this.m06=h+p,this.m01=l+m,this.m04=1-c-_,this.m07=f-d,this.m02=h-p,this.m05=f+d,this.m08=1-c-u,this},t}(ct));Nn.IDENTITY=Object.freeze(new Nn);var Mn=new Pn,Ln=new Pn;Zt.fastDefine("cc.Mat3",Nn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),l.Mat3=Nn;var Fn=e("Quat",function(e){function t(t,n,i,r){var a;return a=e.call(this)||this,t&&"object"==typeof t?(a.x=t.x,a.y=t.y,a.z=t.z,a.w=t.w):(a.x=t||0,a.y=n||0,a.z=i||0,a.w=null!=r?r:1),a}Z(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=Pn.dot(n,i);return r<-.999999?(Pn.cross(Un,Pn.UNIT_X,n),Un.length()<1e-6&&Pn.cross(Un,Pn.UNIT_Y,n),Pn.normalize(Un,Un),t.fromAxisAngle(e,Un,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Pn.cross(Un,n,i),e.x=Un.x,e.y=Un.y,e.z=Un.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,a=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,o=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=a,e.w=o,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r+c*i,e.y=o*r+s*i,e.z=s*r-o*i,e.w=c*r-a*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r-s*i,e.y=o*r+c*i,e.z=s*r+a*i,e.w=c*r-o*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),a=t.x,o=t.y,s=t.z,c=t.w;return e.x=a*r+o*i,e.y=o*r-a*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(Bn,n),Pn.transformQuat(Un,i,Bn),t.fromAxisAngle(Bn,Un,r),t.multiply(e,n,Bn),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(Bn,i,r),t.multiply(e,n,Bn),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,a=0,o=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,o=-o,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),f=Math.sin(h);r=Math.sin((1-i)*h)/f,a=Math.sin(i*h)/f}else r=1-i,a=i;return e.x=r*t.x+a*o,e.y=r*t.y+a*s,e.z=r*t.z+a*c,e.w=r*t.w+a*l,e},t.sqlerp=function(e,n,i,r,a,o){return t.slerp(Bn,n,a,o),t.slerp(zn,i,r,o),t.slerp(e,Bn,zn,2*o*(1-o)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return Nn.set(kn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,kn))},t.fromViewUp=function(e,n,i){return Nn.fromViewUp(kn,n,i),t.normalize(e,t.fromMat3(e,kn))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,a=t.m01,o=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+o+u;if(h>0){var f=.5/Math.sqrt(h+1);e.w=.25/f,e.x=(l-s)*f,e.y=(r-c)*f,e.z=(a-i)*f}else if(n>o&&n>u){var _=2*Math.sqrt(1+n-o-u);e.w=(l-s)/_,e.x=.25*_,e.y=(i+a)/_,e.z=(r+c)/_}else if(o>u){var d=2*Math.sqrt(1+o-n-u);e.w=(r-c)/d,e.x=(i+a)/d,e.y=.25*d,e.z=(s+l)/d}else{var p=2*Math.sqrt(1+u-n-o);e.w=(a-i)/p,e.x=(r+c)/p,e.y=(s+l)/p,e.z=.25*p}return e},t.fromEuler=function(e,t,n,i){t*=Gn,n*=Gn,i*=Gn;var r=Math.sin(t),a=Math.cos(t),o=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+a*o*c,e.y=a*o*l+r*s*c,e.z=a*s*c-r*o*l,e.w=a*s*l-r*o*c,e},t.fromAngleZ=function(e,t){return t*=Gn,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w,s=0,c=0,l=0,u=i*r+a*o;if(u>.499999)s=0,c=fn(2*Math.atan2(i,o)),l=90;else if(u<-.499999)s=0,c=-fn(2*Math.atan2(i,o)),l=-90;else{var h=i*i,f=r*r,_=a*a;s=fn(Math.atan2(2*i*o-2*r*a,1-2*h-2*_)),c=fn(Math.atan2(2*r*o-2*i*a,1-2*f-2*_)),l=fn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(ct));Fn.IDENTITY=Object.freeze(new Fn);var Bn=new Fn,zn=new Fn,Un=new Pn,kn=new Nn,Gn=.5*Math.PI/180;function Hn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new Fn(e,t,n,i)}Zt.fastDefine("cc.Quat",Fn,{x:0,y:0,z:0,w:1}),l.Quat=Fn,l.quat=Hn;var Vn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Wn=e("Mat4",function(e){function t(t,n,i,r,a,o,s,c,l,u,h,f,_,d,p,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===f&&(f=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=a,v.m05=o,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=f,v.m12=_,v.m13=d,v.m14=p,v.m15=m),v}Z(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,a,o,s,c,l,u,h,f,_,d,p,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=f,e.m12=_,e.m13=d,e.m14=p,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,a=t.m06,o=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=o,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,S=n*l-a*o,x=i*c-r*s,E=i*l-a*s,T=r*l-a*c,C=u*p-h*d,A=u*m-f*d,b=u*v-_*d,I=h*m-f*p,w=h*v-_*p,P=f*v-_*m,R=g*P-y*w+S*I+x*b-E*A+T*C;return 0===R?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(R=1/R,e.m00=(s*P-c*w+l*I)*R,e.m01=(r*w-i*P-a*I)*R,e.m02=(p*T-m*E+v*x)*R,e.m03=(f*E-h*T-_*x)*R,e.m04=(c*b-o*P-l*A)*R,e.m05=(n*P-r*b+a*A)*R,e.m06=(m*S-d*T-v*y)*R,e.m07=(u*T-f*S+_*y)*R,e.m08=(o*w-s*b+l*C)*R,e.m09=(i*b-n*w-a*C)*R,e.m10=(d*E-p*S+v*g)*R,e.m11=(h*S-u*E-_*g)*R,e.m12=(s*A-o*I-c*C)*R,e.m13=(n*I-i*A+r*C)*R,e.m14=(p*y-d*x-m*g)*R,e.m15=(u*x-h*y+f*g)*R,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,f=e.m11,_=e.m12,d=e.m13,p=e.m14,m=e.m15;return(t*o-n*a)*(h*m-f*p)-(t*s-i*a)*(u*m-f*d)+(t*c-r*a)*(u*p-h*d)+(n*s-i*o)*(l*m-f*_)-(n*c-r*o)*(l*p-h*_)+(i*c-r*s)*(l*d-u*_)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=t.m09,_=t.m10,d=t.m11,p=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,S=n.m01,x=n.m02,E=n.m03;return e.m00=y*i+S*s+x*h+E*p,e.m01=y*r+S*c+x*f+E*m,e.m02=y*a+S*l+x*_+E*v,e.m03=y*o+S*u+x*d+E*g,y=n.m04,S=n.m05,x=n.m06,E=n.m07,e.m04=y*i+S*s+x*h+E*p,e.m05=y*r+S*c+x*f+E*m,e.m06=y*a+S*l+x*_+E*v,e.m07=y*o+S*u+x*d+E*g,y=n.m08,S=n.m09,x=n.m10,E=n.m11,e.m08=y*i+S*s+x*h+E*p,e.m09=y*r+S*c+x*f+E*m,e.m10=y*a+S*l+x*_+E*v,e.m11=y*o+S*u+x*d+E*g,y=n.m12,S=n.m13,x=n.m14,E=n.m15,e.m12=y*i+S*s+x*h+E*p,e.m13=y*r+S*c+x*f+E*m,e.m14=y*a+S*l+x*_+E*v,e.m15=y*o+S*u+x*d+E*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,a=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*a+t.m15;else{var o=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,f=t.m06,_=t.m07,d=t.m08,p=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=o,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=f,e.m07=_,e.m08=d,e.m09=p,e.m10=m,e.m11=v,e.m12=o*i+u*r+d*a+t.m12,e.m13=s*i+h*r+p*a+t.m13,e.m14=c*i+f*r+m*a+t.m14,e.m15=l*i+_*r+v*a+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,a=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,a=i.y,o=i.z,s=Math.sqrt(r*r+a*a+o*o);if(Math.abs(s)<an)return null;r*=s=1/s,a*=s,o*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,f=t.m01,_=t.m02,d=t.m03,p=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,S=t.m09,x=t.m10,E=t.m11,T=r*r*u+l,C=a*r*u+o*c,A=o*r*u-a*c,b=r*a*u-o*c,I=a*a*u+l,w=o*a*u+r*c,P=r*o*u+a*c,R=a*o*u-r*c,D=o*o*u+l;return e.m00=h*T+p*C+y*A,e.m01=f*T+m*C+S*A,e.m02=_*T+v*C+x*A,e.m03=d*T+g*C+E*A,e.m04=h*b+p*I+y*w,e.m05=f*b+m*I+S*w,e.m06=_*b+v*I+x*w,e.m07=d*b+g*I+E*w,e.m08=h*P+p*R+y*D,e.m09=f*P+m*R+S*D,e.m10=_*P+v*R+x*D,e.m11=d*P+g*R+E*D,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m04,o=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+l*i,e.m05=o*r+u*i,e.m06=s*r+h*i,e.m07=c*r+f*i,e.m08=l*r-a*i,e.m09=u*r-o*i,e.m10=h*r-s*i,e.m11=f*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m00,o=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-l*i,e.m01=o*r-u*i,e.m02=s*r-h*i,e.m03=c*r-f*i,e.m08=a*i+l*r,e.m09=o*i+u*r,e.m10=s*i+h*r,e.m11=c*i+f*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),a=t.m00,o=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,f=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+l*i,e.m01=o*r+u*i,e.m02=s*r+h*i,e.m03=c*r+f*i,e.m04=l*r-a*i,e.m05=u*r-o*i,e.m06=h*r-s*i,e.m07=f*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,a=n.z,o=Math.sqrt(i*i+r*r+a*a);if(Math.abs(o)<an)return null;i*=o=1/o,r*=o,a*=o;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+a*s,e.m02=a*i*l-r*s,e.m03=0,e.m04=i*r*l-a*s,e.m05=r*r*l+c,e.m06=a*r*l+i*s,e.m07=0,e.m08=i*a*l+r*s,e.m09=r*a*l-i*s,e.m10=a*a*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w,s=i+i,c=r+r,l=a+a,u=i*s,h=i*c,f=i*l,_=r*c,d=r*l,p=a*l,m=o*s,v=o*c,g=o*l;return e.m00=1-(_+p),e.m01=h+g,e.m02=f-v,e.m03=0,e.m04=h-g,e.m05=1-(u+p),e.m06=d+m,e.m07=0,e.m08=f+v,e.m09=d-m,e.m10=1-(u+_),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Xn.m00=t.m00,i=Xn.m01=t.m01,r=Xn.m02=t.m02,a=Xn.m03=t.m04,o=Xn.m04=t.m05,s=Xn.m05=t.m06,c=Xn.m06=t.m08,l=Xn.m07=t.m09,u=Xn.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Nn.determinant(Xn)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=Pn.set(jn,e.m00,e.m01,e.m02).length(),Xn.m00=e.m00/i.x,Xn.m01=e.m01/i.x,Xn.m02=e.m02/i.x,i.y=Pn.set(jn,e.m04,e.m05,e.m06).length(),Xn.m03=e.m04/i.y,Xn.m04=e.m05/i.y,Xn.m05=e.m06/i.y,i.z=Pn.set(jn,e.m08,e.m09,e.m10).length(),Xn.m06=e.m08/i.z,Xn.m07=e.m09/i.z,Xn.m08=e.m10/i.z,Nn.determinant(Xn)<0&&(i.x*=-1,Xn.m00*=-1,Xn.m01*=-1,Xn.m02*=-1),Fn.fromMat3(t,Xn),Pn.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,a=t.y,o=t.z,s=t.w,c=r+r,l=a+a,u=o+o,h=r*c,f=r*l,_=r*u,d=a*l,p=a*u,m=o*u,v=s*c,g=s*l,y=s*u,S=i.x,x=i.y,E=i.z;return e.m00=(1-(d+m))*S,e.m01=(f+y)*S,e.m02=(_-g)*S,e.m03=0,e.m04=(f-y)*x,e.m05=(1-(h+m))*x,e.m06=(p+v)*x,e.m07=0,e.m08=(_+g)*E,e.m09=(p-v)*E,e.m10=(1-(h+d))*E,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var a=t.x,o=t.y,s=t.z,c=t.w,l=a+a,u=o+o,h=s+s,f=a*l,_=a*u,d=a*h,p=o*u,m=o*h,v=s*h,g=c*l,y=c*u,S=c*h,x=i.x,E=i.y,T=i.z,C=r.x,A=r.y,b=r.z;return e.m00=(1-(p+v))*x,e.m01=(_+S)*x,e.m02=(d-y)*x,e.m03=0,e.m04=(_-S)*E,e.m05=(1-(f+v))*E,e.m06=(m+g)*E,e.m07=0,e.m08=(d+y)*T,e.m09=(m-g)*T,e.m10=(1-(f+p))*T,e.m11=0,e.m12=n.x+C-(e.m00*C+e.m04*A+e.m08*b),e.m13=n.y+A-(e.m01*C+e.m05*A+e.m09*b),e.m14=n.z+b-(e.m02*C+e.m06*A+e.m10*b),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n+n,s=i+i,c=r+r,l=n*o,u=i*o,h=i*s,f=r*o,_=r*s,d=r*c,p=a*o,m=a*s,v=a*c;return e.m00=1-h-d,e.m01=u+v,e.m02=f-m,e.m03=0,e.m04=u-v,e.m05=1-l-d,e.m06=_+p,e.m07=0,e.m08=f+m,e.m09=_-p,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,a,o){var s=1/(n-t),c=1/(r-i),l=1/(a-o);return e.m00=2*a*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(o+a)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=o*a*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,a,o,s,c){void 0===a&&(a=!0),void 0===o&&(o=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=a?l/n:l,f=(a?l:l*n)*s,_=Vn[c];return e.m00=h*_[0],e.m01=h*_[1],e.m02=0,e.m03=0,e.m04=f*_[2],e.m05=f*_[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-o*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-o),e.m15=0,e},t.ortho=function(e,t,n,i,r,a,o,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,f=1/(a-o),_=-2*u,d=-2*h,p=(t+n)*u,m=(r+i)*h,v=Vn[l];return e.m00=_*v[0],e.m01=_*v[1],e.m02=0,e.m03=0,e.m04=d*v[2],e.m05=d*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=f*(1-s),e.m11=0,e.m12=p*v[0]+m*v[2],e.m13=p*v[1]+m*v[3],e.m14=(a-s*o)*f,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,a=t.y,o=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=a-n.y,f=o-n.z,_=1/Math.sqrt(u*u+h*h+f*f),d=c*(f*=_)-l*(h*=_),p=l*(u*=_)-s*f,m=s*h-c*u,v=h*(m*=_=1/Math.sqrt(d*d+p*p+m*m))-f*(p*=_),g=f*(d*=_)-u*m,y=u*p-h*d;return e.m00=d,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=f,e.m11=0,e.m12=-(d*r+p*a+m*o),e.m13=-(v*r+g*a+y*o),e.m14=-(u*r+h*a+f*o),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*o,y=n*c-r*o,S=n*l-a*o,x=i*c-r*s,E=i*l-a*s,T=r*l-a*c,C=u*p-h*d,A=u*m-f*d,b=u*v-_*d,I=h*m-f*p,w=h*v-_*p,P=f*v-_*m,R=g*P-y*w+S*I+x*b-E*A+T*C;return R?(R=1/R,e.m00=(s*P-c*w+l*I)*R,e.m01=(c*b-o*P-l*A)*R,e.m02=(o*w-s*b+l*C)*R,e.m03=0,e.m04=(r*w-i*P-a*I)*R,e.m05=(n*P-r*b+a*A)*R,e.m06=(i*b-n*w-a*C)*R,e.m07=0,e.m08=(p*T-m*E+v*x)*R,e.m09=(m*S-d*T-v*y)*R,e.m10=(d*E-p*S+v*g)*R,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,a,o,s,c,l,u,h,f,_,d,p){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===p&&(p=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=a,this.m06=o,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=f,this.m13=_,this.m14=d,this.m15=p,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=a,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,_=this.m13,d=this.m14,p=this.m15,m=e*a-t*r,v=e*o-n*r,g=e*s-i*r,y=t*o-n*a,S=t*s-i*a,x=n*s-i*o,E=c*_-l*f,T=c*d-u*f,C=c*p-h*f,A=l*d-u*_,b=l*p-h*_,I=u*p-h*d,w=m*I-v*b+g*A+y*C-S*T+x*E;return 0===w?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(w=1/w,this.m00=(a*I-o*b+s*A)*w,this.m01=(n*b-t*I-i*A)*w,this.m02=(_*x-d*S+p*y)*w,this.m03=(u*S-l*x-h*y)*w,this.m04=(o*C-r*I-s*T)*w,this.m05=(e*I-n*C+i*T)*w,this.m06=(d*g-f*x-p*v)*w,this.m07=(c*x-u*g+h*v)*w,this.m08=(r*b-a*C+s*E)*w,this.m09=(t*C-e*b-i*E)*w,this.m10=(f*S-_*g+p*m)*w,this.m11=(l*g-c*S-h*m)*w,this.m12=(a*T-r*A-o*E)*w,this.m13=(e*A-t*T+n*E)*w,this.m14=(_*v-f*y-d*m)*w,this.m15=(c*y-l*v+u*m)*w,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,_=this.m13,d=this.m14,p=this.m15;return(e*a-t*r)*(u*p-h*d)-(e*o-n*r)*(l*p-h*_)+(e*s-i*r)*(l*d-u*_)+(t*o-n*a)*(c*p-h*f)-(t*s-i*a)*(c*d-u*f)+(n*s-i*o)*(c*_-l*f)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,f=this.m11,_=this.m12,d=this.m13,p=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,S=e.m03;return this.m00=v*t+g*a+y*l+S*_,this.m01=v*n+g*o+y*u+S*d,this.m02=v*i+g*s+y*h+S*p,this.m03=v*r+g*c+y*f+S*m,v=e.m04,g=e.m05,y=e.m06,S=e.m07,this.m04=v*t+g*a+y*l+S*_,this.m05=v*n+g*o+y*u+S*d,this.m06=v*i+g*s+y*h+S*p,this.m07=v*r+g*c+y*f+S*m,v=e.m08,g=e.m09,y=e.m10,S=e.m11,this.m08=v*t+g*a+y*l+S*_,this.m09=v*n+g*o+y*u+S*d,this.m10=v*i+g*s+y*h+S*p,this.m11=v*r+g*c+y*f+S*m,v=e.m12,g=e.m13,y=e.m14,S=e.m15,this.m12=v*t+g*a+y*l+S*_,this.m13=v*n+g*o+y*u+S*d,this.m14=v*i+g*s+y*h+S*p,this.m15=v*r+g*c+y*f+S*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,a=Math.sqrt(n*n+i*i+r*r);if(Math.abs(a)<an)return null;n*=a=1/a,i*=a,r*=a;var o=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,f=this.m03,_=this.m04,d=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,S=this.m11,x=n*n*c+s,E=i*n*c+r*o,T=r*n*c-i*o,C=n*i*c-r*o,A=i*i*c+s,b=r*i*c+n*o,I=n*r*c+i*o,w=i*r*c-n*o,P=r*r*c+s;return this.m00=l*x+_*E+v*T,this.m01=u*x+d*E+g*T,this.m02=h*x+p*E+y*T,this.m03=f*x+m*E+S*T,this.m04=l*C+_*A+v*b,this.m05=u*C+d*A+g*b,this.m06=h*C+p*A+y*b,this.m07=f*C+m*A+S*b,this.m08=l*I+_*w+v*P,this.m09=u*I+d*w+g*P,this.m10=h*I+p*w+y*P,this.m11=f*I+m*w+S*P,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Xn.m00=this.m00,n=Xn.m01=this.m01,i=Xn.m02=this.m02,r=Xn.m03=this.m04,a=Xn.m04=this.m05,o=Xn.m05=this.m06,s=Xn.m06=this.m08,c=Xn.m07=this.m09,l=Xn.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+a*a+o*o),e.z=Math.sqrt(s*s+c*c+l*l),Nn.determinant(Xn)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,c=r+r,l=a+a,u=i*s,h=i*c,f=i*l,_=r*c,d=r*l,p=a*l,m=o*s,v=o*c,g=o*l,y=n.x,S=n.y,x=n.z;return this.m00=(1-(_+p))*y,this.m01=(h+g)*y,this.m02=(f-v)*y,this.m03=0,this.m04=(h-g)*S,this.m05=(1-(u+p))*S,this.m06=(d+m)*S,this.m07=0,this.m08=(f+v)*x,this.m09=(d-m)*x,this.m10=(1-(u+_))*x,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,a=t+t,o=n+n,s=i+i,c=t*a,l=n*a,u=n*o,h=i*a,f=i*o,_=i*s,d=r*a,p=r*o,m=r*s;return this.m00=1-u-_,this.m01=l+m,this.m02=h-p,this.m03=0,this.m04=l-m,this.m05=1-c-_,this.m06=f+d,this.m07=0,this.m08=h+p,this.m09=f-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(ct));Wn.IDENTITY=Object.freeze(new Wn);var jn=new Pn,Xn=new Nn;function qn(e,t,n,i,r,a,o,s,c,l,u,h,f,_,d,p){return new Wn(e,t,n,i,r,a,o,s,c,l,u,h,f,_,d,p)}Zt.fastDefine("cc.Mat4",Wn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),l.Mat4=Wn,l.mat4=qn;var Yn=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}Z(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<an?e.x=0:e.x=1/n,Math.abs(i)<an?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof Pn?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,a=t.y;return e.x=r+i*(n.x-r),e.y=a+i*(n.y-a),e},t.random=function(e,t){t=t||1;var n=2*_n()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(Kn,e),t.normalize(Qn,n);var i=t.dot(Kn,Qn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=an),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=cn(this.x,e.x,t.x),this.y=cn(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=cn(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(ct));Yn.ZERO=Object.freeze(new Yn(0,0)),Yn.ONE=Object.freeze(new Yn(1,1)),Yn.NEG_ONE=Object.freeze(new Yn(-1,-1)),Yn.UNIT_X=Object.freeze(new Yn(1,0)),Yn.UNIT_Y=Object.freeze(new Yn(0,1));var Kn=new Yn,Qn=new Yn;function Jn(e,t){return new Yn(e,t)}Zt.fastDefine("cc.Vec2",Yn,{x:0,y:0}),l.Vec2=Yn,l.v2=Jn;var Zn=e("Vec4",function(e){function t(t,n,i,r){var a;return a=e.call(this)||this,t&&"object"==typeof t?(a.x=t.x,a.y=t.y,a.z=t.z,a.w=t.w):(a.x=t||0,a.y=n||0,a.z=i||0,a.w=r||0),a}Z(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+a*a)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return n*n+i*i+r*r+a*a},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w;return Math.abs(n)<an?e.x=0:e.x=1/n,Math.abs(i)<an?e.y=0:e.y=1/i,Math.abs(r)<an?e.z=0:e.z=1/r,Math.abs(a)<an?e.w=0:e.w=1/a,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,a=t.w,o=n*n+i*i+r*r+a*a;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o,e.w=a*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*_n()*Math.PI,i=2*_n()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w;return e.x=n.m00*i+n.m04*r+n.m08*a+n.m12*o,e.y=n.m01*i+n.m05*r+n.m09*a+n.m13*o,e.z=n.m02*i+n.m06*r+n.m10*a+n.m14*o,e.w=n.m03*i+n.m07*r+n.m11*a+n.m15*o,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w;return e.x=n.m00*i+n.m04*r+n.m08*a+n.m12*o,e.y=n.m01*i+n.m05*r+n.m09*a+n.m13*o,e.z=n.m02*i+n.m06*r+n.m10*a+n.m14*o,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,a=t.z,o=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*a-c*r,h=l*r+c*i-o*a,f=l*a+o*r-s*i,_=-o*i-s*r-c*a;return e.x=u*l+_*-o+h*-c-f*-s,e.y=h*l+_*-s+f*-o-u*-c,e.z=f*l+_*-c+u*-s-h*-o,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=an),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,a=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=a+t*(e.w-a),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=cn(this.x,e.x,t.x),this.y=cn(this.y,e.y,t.y),this.z=cn(this.z,e.z,t.z),this.w=cn(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,a=e.y,o=e.z;return this.x=n*o-i*a,this.y=i*r-t*o,this.z=t*a-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(ct));function $n(e,t,n,i){return new Zn(e,t,n,i)}Zn.ZERO=Object.freeze(new Zn(0,0,0,0)),Zn.ONE=Object.freeze(new Zn(1,1,1,1)),Zn.NEG_ONE=Object.freeze(new Zn(-1,-1,-1,-1)),Zt.fastDefine("cc.Vec4",Zn,{x:0,y:0,z:0,w:0}),l.Vec4=Zn,l.v4=$n,U(Yn,"Vec2",[{name:"sub",newName:"subtract",target:Yn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Yn,targetName:"Vec2"},{name:"div",newName:"divide",target:Yn,targetName:"Vec2"},{name:"dist",newName:"distance",target:Yn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Yn,targetName:"Vec2"},{name:"mag",newName:"len",target:Yn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Yn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Yn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Yn,targetName:"Vec2"}]),U(Yn.prototype,"Vec2",[{name:"mag",newName:"length",target:Yn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Yn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Yn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Yn.prototype,targetName:"Vec2"}]),U(Pn,"Vec3",[{name:"sub",newName:"subtract",target:Pn,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Pn,targetName:"Vec3"},{name:"div",newName:"divide",target:Pn,targetName:"Vec3"},{name:"dist",newName:"distance",target:Pn,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Pn,targetName:"Vec3"},{name:"mag",newName:"len",target:Pn,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Pn,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Pn,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Pn,targetName:"Vec3"}]),U(Pn.prototype,"Vec3",[{name:"mag",newName:"length",target:Pn.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Pn.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Pn.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Pn.prototype,targetName:"Vec3"}]),U(Zn,"Vec4",[{name:"sub",newName:"subtract",target:Zn,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Zn,targetName:"Vec4"},{name:"div",newName:"divide",target:Zn,targetName:"Vec4"},{name:"dist",newName:"distance",target:Zn,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Zn,targetName:"Vec4"},{name:"mag",newName:"len",target:Zn,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Zn,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Zn,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Zn,targetName:"Vec4"}]),U(Zn.prototype,"Vec4",[{name:"mag",newName:"length",target:Zn.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Zn.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Zn.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Zn.prototype,targetName:"Vec4"}]),U(Fn,"Quat",[{name:"mag",newName:"len",target:Fn,targetName:"Quat"},{name:"mul",newName:"multiply",target:Fn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Fn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Fn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Fn,targetName:"Quat"}]),U(Fn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Fn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Fn.prototype,targetName:"Quat"}]),U(In,"Color",[{name:"sub",newName:"subtract",target:In,targetName:"Color"},{name:"mul",newName:"multiply",target:In,targetName:"Color"},{name:"div",newName:"divide",target:In,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:In,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[1].toString(16);return l.Color.fromHEX(t[0],i)}}]),U(Nn,"Mat3",[{name:"sub",newName:"subtract",target:Nn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Nn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Nn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Nn,targetName:"Mat3"}]),U(Nn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Nn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Nn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Nn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Nn.prototype,targetName:"Mat3"}]),U(Wn,"Mat4",[{name:"sub",newName:"subtract",target:Wn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Wn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Wn,targetName:"Mat4"}]),U(Wn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Wn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Wn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Wn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Wn.prototype,targetName:"Mat4"}]);var ei=e("AffineTransform",function(){function e(e,t,n,i,r,a){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=a}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,a=t.c,o=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=a*n.a+o*n.c,e.d=a*n.b+o*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,a;i?(r=t,a=n):(i=n,r=t.x,a=t.y),e.x=i.a*r+i.c*a+i.tx,e.y=i.b*r+i.d*a+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,a=n.a*t.x+n.c*t.y+n.tx,o=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,f=n.b*i+n.d*r+n.ty,_=Math.min(a,s,l,h),d=Math.max(a,s,l,h),p=Math.min(o,c,u,f),m=Math.max(o,c,u,f);e.x=_,e.y=p,e.width=d-_,e.height=m-p},e.transformObb=function(e,t,n,i,r,a){var o=a.a*r.x+a.c*r.y+a.tx,s=a.b*r.x+a.d*r.y+a.ty,c=a.a*r.width,l=a.b*r.width,u=a.c*r.height,h=a.d*r.height;t.x=o,t.y=s,n.x=c+o,n.y=l+s,e.x=u+o,e.y=h+s,i.x=c+u+o,i.y=l+h+s},e}());l.AffineTransform=ei;var ti=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}Z(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},Q(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(ct));function ni(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new ti(e,t)}ti.ZERO=Object.freeze(new ti(0,0)),ti.ONE=Object.freeze(new ti(1,1)),Zt.fastDefine("cc.Size",ti,{width:0,height:0}),l.size=ni,l.Size=ti;var ii=e("Rect",function(e){function t(t,n,i,r){var a;return a=e.call(this)||this,t&&"object"==typeof t?(a.y=t.y,a.width=t.width,a.height=t.height,a.x=t.x):(a.x=t||0,a.y=n||0,a.width=i||0,a.height=r||0),a}Z(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),a=Math.max(t.x,n.x),o=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=a-i,e.height=o-r,e},t.lerp=function(e,t,n,i){var r=t.x,a=t.y,o=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=a+(n.y-a)*i,e.width=o+(n.width-o)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,a=t.x+t.width,o=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(a,l)-e.x,e.height=Math.min(o,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,a=t.width,o=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+a,s+l)-e.x,e.height=Math.max(r+o,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,a=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=a+(e.height-a)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,a=e.m00*t+e.m04*n+e.m12,o=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,f=e.m01*i+e.m05*r+e.m13,_=Math.min(a,s,l,h),d=Math.max(a,s,l,h),p=Math.min(o,c,u,f),m=Math.max(o,c,u,f);return this.x=_,this.y=p,this.width=d-_,this.height=m-p,this},n.transformMat4ToPoints=function(e,t,n,i,r){var a=this.x,o=this.y,s=a+this.width,c=o+this.height;t.x=e.m00*a+e.m04*o+e.m12,t.y=e.m01*a+e.m05*o+e.m13,r.x=e.m00*s+e.m04*o+e.m12,r.y=e.m01*s+e.m05*o+e.m13,n.x=e.m00*a+e.m04*c+e.m12,n.y=e.m01*a+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},Q(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Yn(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new Yn(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new ti(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(ct));function ri(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new ii(e,t,n,i)}Zt.fastDefine("cc.Rect",ii,{x:0,y:0,width:0,height:0}),l.Rect=ii,l.rect=ri;var ai=e("MATH_FLOAT_ARRAY",Float64Array),oi=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.createFloatArray=function(e){return new ai(e)},Q(t,[{key:"array",get:function(){return this._array}}]),t}(ct)),si=Object.freeze({__proto__:null,bits:s,Vec2:Yn,v2:Jn,Vec3:Pn,v3:On,Vec4:Zn,v4:$n,Quat:Fn,quat:Hn,Mat3:Nn,Mat4:Wn,mat4:qn,AffineTransform:ei,Size:ti,size:ni,Rect:ii,rect:ri,Color:In,color:wn,EPSILON:an,equals:on,approx:sn,clamp:cn,clamp01:ln,lerp:un,toRadian:hn,toDegree:fn,random:_n,randomRange:dn,randomRangeInt:pn,pseudoRandom:mn,pseudoRandomRange:vn,pseudoRandomRangeInt:gn,nextPow2:yn,repeat:Sn,pingPong:xn,inverseLerp:En,absMaxComponent:Tn,absMax:Cn,enumerableProps:An,MATH_FLOAT_ARRAY:ai,MathBase:oi});e("math",si);var ci,li,ui,hi,fi,_i,di,pi,mi,vi,gi,yi,Si,xi,Ei,Ti,Ci,Ai,bi,Ii,wi,Pi,Ri,Di,Oi,Ni,Mi,Li,Fi,Bi,zi,Ui,ki,Gi,Hi,Vi,Wi,ji,Xi,qi,Yi,Ki,Qi=new(function(){function e(){this._finalizationRegistry=null,this._gcObjects=new WeakMap}var t=e.prototype;return t.registerGCObject=function(e){return e},t.init=function(){},t.finalizationRegistryCallback=function(e){var t=this._gcObjects.get(e);t&&(this._gcObjects.delete(e),t.destroy()),this._finalizationRegistry.unregister(e)},t.destroy=function(){},e}()),Ji=function(){function e(){return Qi.registerGCObject(this)}return e.prototype.destroy=function(){},e}(),Zi=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(ci||(ci={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(li||(li={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.NVN=5]="NVN",e[e.WEBGL=6]="WEBGL",e[e.WEBGL2=7]="WEBGL2",e[e.WEBGPU=8]="WEBGPU"}(ui||(ui={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(hi||(hi={})),function(e){e[e.ELEMENT_INDEX_UINT=0]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=1]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=2]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=3]="BLEND_MINMAX",e[e.COMPUTE_SHADER=4]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=5]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=6]="COUNT"}(fi||(fi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(_i||(_i={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(di||(di={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(pi||(pi={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(mi||(mi={})),function(e){e[e.NONE=0]="NONE"}(vi||(vi={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(gi||(gi={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(yi||(yi={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Si||(Si={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(xi||(xi={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Ei||(Ei={})),function(e){e[e.NONE=0]="NONE",e[e.RENDER_TARGET=1]="RENDER_TARGET",e[e.SAMPLED_TEXTURE=2]="SAMPLED_TEXTURE",e[e.LINEAR_FILTER=4]="LINEAR_FILTER",e[e.STORAGE_TEXTURE=8]="STORAGE_TEXTURE",e[e.VERTEX_ATTRIBUTE=16]="VERTEX_ATTRIBUTE"}(Ti||(Ti={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Ci||(Ci={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Ai||(Ai={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(bi||(bi={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Ii||(Ii={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(wi||(wi={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Pi||(Pi={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ri||(Ri={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Di||(Di={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Oi||(Oi={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Ni||(Ni={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Mi||(Mi={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Li||(Li={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=4]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=8]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=16]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=32]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=64]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=128]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=256]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=512]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=1024]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=2048]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=4096]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=8192]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=16384]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=32768]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=65536]="TRANSFER_READ",e[e.HOST_READ=131072]="HOST_READ",e[e.PRESENT=262144]="PRESENT",e[e.VERTEX_SHADER_WRITE=524288]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=1048576]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=2097152]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=4194304]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=8388608]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=16777216]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=33554432]="HOST_PREINITIALIZED",e[e.HOST_WRITE=67108864]="HOST_WRITE"}(Fi||(Fi={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Bi||(Bi={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(zi||(zi={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Ui||(Ui={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(ki||(ki={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Gi||(Gi={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Hi||(Hi={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Vi||(Vi={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(Wi||(Wi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(ji||(ji={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Xi||(Xi={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(qi||(qi={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(Yi||(Yi={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Ki||(Ki={}));var $i,er=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),tr=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h,f,_,d,p,m,v,g,y,S,x){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=1),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=new er),void 0===v&&(v=new er),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===S&&(S=1),void 0===x&&(x=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=a,this.maxColorRenderTargets=o,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=f,this.uboOffsetAlignment=_,this.maxComputeSharedMemorySize=d,this.maxComputeWorkGroupInvocations=p,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=S,this.clipSpaceSignY=x}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),nr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),ir=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),rr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),ar=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),or=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),sr=function(){function e(e,t,n,i,r){void 0===e&&(e=new ar),void 0===t&&(t=new nr),void 0===n&&(n=new ar),void 0===i&&(i=new nr),void 0===r&&(r=new rr),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),cr=function(){function e(e,t,n,i,r,a){void 0===e&&(e=new ar),void 0===t&&(t=new nr),void 0===n&&(n=new rr),void 0===i&&(i=new ar),void 0===r&&(r=new nr),void 0===a&&(a=new rr),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=a}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),lr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new nr),void 0===i&&(i=new rr),void 0===r&&(r=new ar),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),ur=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=a}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),hr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),fr=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=[0]),void 0===t&&(t=[0]),void 0===n&&(n=[0]),void 0===i&&(i=[0]),void 0===r&&(r=[0]),void 0===a&&(a=[0]),void 0===o&&(o=[0]),void 0===s&&(s=[0]),this.maxBlockCounts=e,this.maxSamplerTextureCounts=t,this.maxSamplerCounts=n,this.maxTextureCounts=i,this.maxBufferCounts=r,this.maxImageCounts=a,this.maxSubpassInputCounts=o,this.setIndices=s}return e.prototype.copy=function(e){return this.maxBlockCounts=e.maxBlockCounts.slice(),this.maxSamplerTextureCounts=e.maxSamplerTextureCounts.slice(),this.maxSamplerCounts=e.maxSamplerCounts.slice(),this.maxTextureCounts=e.maxTextureCounts.slice(),this.maxBufferCounts=e.maxBufferCounts.slice(),this.maxImageCounts=e.maxImageCounts.slice(),this.maxSubpassInputCounts=e.maxSubpassInputCounts.slice(),this.setIndices=e.setIndices.slice(),this},e}(),_r=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=Ai.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),dr=function(){function e(e){void 0===e&&(e=new fr),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),pr=function(){function e(e,t,n,i,r){void 0===e&&(e=mi.NONE),void 0===t&&(t=yi.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=vi.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),mr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),vr=function(){function e(e,t,n,i,r,a,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=a,this.firstInstance=o}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),gr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),yr=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return Zi(this.drawInfos,e.drawInfos,vr),this},e}(),Sr=function(){function e(e,t,n,i,r,a,o,s,c,l,u){void 0===e&&(e=Si.TEX2D),void 0===t&&(t=xi.NONE),void 0===n&&(n=_i.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=Ei.NONE),void 0===o&&(o=1),void 0===s&&(s=1),void 0===c&&(c=Ci.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=a,this.layerCount=o,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),xr=function(){function e(e,t,n,i,r,a,o){void 0===e&&(e=null),void 0===t&&(t=Si.TEX2D),void 0===n&&(n=_i.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===o&&(o=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=a,this.layerCount=o}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),Er=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=bi.LINEAR),void 0===t&&(t=bi.LINEAR),void 0===n&&(n=bi.NONE),void 0===i&&(i=Ii.WRAP),void 0===r&&(r=Ii.WRAP),void 0===a&&(a=Ii.WRAP),void 0===o&&(o=0),void 0===s&&(s=wi.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=a,this.maxAnisotropy=o,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),Tr=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=pi.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Cr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,Zi(this.members,e.members,Tr),this.count=e.count,this},e}(),Ar=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=pi.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),br=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Ir=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=pi.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),wr=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=pi.UNKNOWN),void 0===r&&(r=0),void 0===a&&(a=gi.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=a}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Pr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=gi.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Rr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Dr=function(){function e(e,t){void 0===e&&(e=Ni.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),Or=function(){function e(e,t,n,i,r,a){void 0===e&&(e=""),void 0===t&&(t=_i.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===a&&(a=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=a}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),Nr=function(){function e(e,t,n,i,r,a,o,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===a&&(a=[]),void 0===o&&(o=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=a,this.samplers=o,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,Zi(this.stages,e.stages,Dr),Zi(this.attributes,e.attributes,Or),Zi(this.blocks,e.blocks,Cr),Zi(this.buffers,e.buffers,Pr),Zi(this.samplerTextures,e.samplerTextures,Ar),Zi(this.samplers,e.samplers,br),Zi(this.textures,e.textures,Ir),Zi(this.images,e.images,wr),Zi(this.subpassInputs,e.subpassInputs,Rr),this},e}(),Mr=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return Zi(this.attributes,e.attributes,Or),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),Lr=function(){function e(e,t,n,i,r,a){void 0===e&&(e=_i.UNKNOWN),void 0===t&&(t=Ci.ONE),void 0===n&&(n=Mi.CLEAR),void 0===i&&(i=Li.STORE),void 0===r&&(r=null),void 0===a&&(a=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.barrier=r,this.isGeneralLayout=a}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this},e}(),Fr=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=_i.UNKNOWN),void 0===t&&(t=Ci.ONE),void 0===n&&(n=Mi.CLEAR),void 0===i&&(i=Li.STORE),void 0===r&&(r=Mi.CLEAR),void 0===a&&(a=Li.STORE),void 0===o&&(o=null),void 0===s&&(s=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=a,this.barrier=o,this.isGeneralLayout=s}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this},e}(),Br=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===a&&(a=-1),void 0===o&&(o=Bi.NONE),void 0===s&&(s=Bi.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=a,this.depthResolveMode=o,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),zr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=null),this.srcSubpass=e,this.dstSubpass=t,this.barrier=n}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.barrier=e.barrier,this},e}(),Ur=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Fr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return Zi(this.colorAttachments,e.colorAttachments,Lr),this.depthStencilAttachment.copy(e.depthStencilAttachment),Zi(this.subpasses,e.subpasses,Br),Zi(this.dependencies,e.dependencies,zr),this},e}(),kr=function(){function e(e,t){void 0===e&&(e=Fi.NONE),void 0===t&&(t=Fi.NONE),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this},e}(),Gr=function(){function e(e,t,n,i,r){void 0===e&&(e=Fi.NONE),void 0===t&&(t=Fi.NONE),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),Hr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),Vr=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=ji.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Ni.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),Wr=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return Zi(this.bindings,e.bindings,Vr),this},e}(),jr=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),Xr=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),qr=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return Zi(this.attributes,e.attributes,Or),this},e}(),Yr=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=Yi.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),Kr=function(){function e(e){void 0===e&&(e=Xi.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),Qr=function(){function e(e,t,n){void 0===e&&(e=qi.OCCLUSION),void 0===t&&(t=32767),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),Jr=function(e,t,n,i,r,a,o,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=di.NONE),void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===o&&(o=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=a,this.hasStencil=o,this.isCompressed=s},Zr=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),$r=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),ea=function(){function e(e,t,n,i,r,a,o,s,c,l,u){void 0===e&&(e=new ur),void 0===t&&(t=new ir),void 0===n&&(n=new hr),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new $r),void 0===u&&(u=new $r),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=a,this.depthBiasSlope=o,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),ta=function(e){function t(n){var i;return(i=e.call(this)||this)._objectType=ci.UNKNOWN,i._objectID=0,i._typedID=0,i._objectType=n,i._objectID=t._idTable[ci.UNKNOWN]++,i._typedID=t._idTable[n]++,i}return Z(t,e),Q(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}(Ji);ta._idTable=Array(ci.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}($i||($i={}));var na=Object.freeze([new Jr("UNKNOWN",0,0,di.NONE,!1,!1,!1,!1),new Jr("A8",1,1,di.UNORM,!0,!1,!1,!1),new Jr("L8",1,1,di.UNORM,!1,!1,!1,!1),new Jr("LA8",1,2,di.UNORM,!0,!1,!1,!1),new Jr("R8",1,1,di.UNORM,!1,!1,!1,!1),new Jr("R8SN",1,1,di.SNORM,!1,!1,!1,!1),new Jr("R8UI",1,1,di.UINT,!1,!1,!1,!1),new Jr("R8I",1,1,di.INT,!1,!1,!1,!1),new Jr("R16F",2,1,di.FLOAT,!1,!1,!1,!1),new Jr("R16UI",2,1,di.UINT,!1,!1,!1,!1),new Jr("R16I",2,1,di.INT,!1,!1,!1,!1),new Jr("R32F",4,1,di.FLOAT,!1,!1,!1,!1),new Jr("R32UI",4,1,di.UINT,!1,!1,!1,!1),new Jr("R32I",4,1,di.INT,!1,!1,!1,!1),new Jr("RG8",2,2,di.UNORM,!1,!1,!1,!1),new Jr("RG8SN",2,2,di.SNORM,!1,!1,!1,!1),new Jr("RG8UI",2,2,di.UINT,!1,!1,!1,!1),new Jr("RG8I",2,2,di.INT,!1,!1,!1,!1),new Jr("RG16F",4,2,di.FLOAT,!1,!1,!1,!1),new Jr("RG16UI",4,2,di.UINT,!1,!1,!1,!1),new Jr("RG16I",4,2,di.INT,!1,!1,!1,!1),new Jr("RG32F",8,2,di.FLOAT,!1,!1,!1,!1),new Jr("RG32UI",8,2,di.UINT,!1,!1,!1,!1),new Jr("RG32I",8,2,di.INT,!1,!1,!1,!1),new Jr("RGB8",3,3,di.UNORM,!1,!1,!1,!1),new Jr("SRGB8",3,3,di.UNORM,!1,!1,!1,!1),new Jr("RGB8SN",3,3,di.SNORM,!1,!1,!1,!1),new Jr("RGB8UI",3,3,di.UINT,!1,!1,!1,!1),new Jr("RGB8I",3,3,di.INT,!1,!1,!1,!1),new Jr("RGB16F",6,3,di.FLOAT,!1,!1,!1,!1),new Jr("RGB16UI",6,3,di.UINT,!1,!1,!1,!1),new Jr("RGB16I",6,3,di.INT,!1,!1,!1,!1),new Jr("RGB32F",12,3,di.FLOAT,!1,!1,!1,!1),new Jr("RGB32UI",12,3,di.UINT,!1,!1,!1,!1),new Jr("RGB32I",12,3,di.INT,!1,!1,!1,!1),new Jr("RGBA8",4,4,di.UNORM,!0,!1,!1,!1),new Jr("BGRA8",4,4,di.UNORM,!0,!1,!1,!1),new Jr("SRGB8_A8",4,4,di.UNORM,!0,!1,!1,!1),new Jr("RGBA8SN",4,4,di.SNORM,!0,!1,!1,!1),new Jr("RGBA8UI",4,4,di.UINT,!0,!1,!1,!1),new Jr("RGBA8I",4,4,di.INT,!0,!1,!1,!1),new Jr("RGBA16F",8,4,di.FLOAT,!0,!1,!1,!1),new Jr("RGBA16UI",8,4,di.UINT,!0,!1,!1,!1),new Jr("RGBA16I",8,4,di.INT,!0,!1,!1,!1),new Jr("RGBA32F",16,4,di.FLOAT,!0,!1,!1,!1),new Jr("RGBA32UI",16,4,di.UINT,!0,!1,!1,!1),new Jr("RGBA32I",16,4,di.INT,!0,!1,!1,!1),new Jr("R5G6B5",2,3,di.UNORM,!1,!1,!1,!1),new Jr("R11G11B10F",4,3,di.FLOAT,!1,!1,!1,!1),new Jr("RGB5A1",2,4,di.UNORM,!0,!1,!1,!1),new Jr("RGBA4",2,4,di.UNORM,!0,!1,!1,!1),new Jr("RGB10A2",2,4,di.UNORM,!0,!1,!1,!1),new Jr("RGB10A2UI",2,4,di.UINT,!0,!1,!1,!1),new Jr("RGB9E5",2,4,di.FLOAT,!0,!1,!1,!1),new Jr("DEPTH",4,1,di.FLOAT,!1,!0,!1,!1),new Jr("DEPTH_STENCIL",5,2,di.FLOAT,!1,!0,!0,!1),new Jr("BC1",1,3,di.UNORM,!1,!1,!1,!0),new Jr("BC1_ALPHA",1,4,di.UNORM,!0,!1,!1,!0),new Jr("BC1_SRGB",1,3,di.UNORM,!1,!1,!1,!0),new Jr("BC1_SRGB_ALPHA",1,4,di.UNORM,!0,!1,!1,!0),new Jr("BC2",1,4,di.UNORM,!0,!1,!1,!0),new Jr("BC2_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Jr("BC3",1,4,di.UNORM,!0,!1,!1,!0),new Jr("BC3_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Jr("BC4",1,1,di.UNORM,!1,!1,!1,!0),new Jr("BC4_SNORM",1,1,di.SNORM,!1,!1,!1,!0),new Jr("BC5",1,2,di.UNORM,!1,!1,!1,!0),new Jr("BC5_SNORM",1,2,di.SNORM,!1,!1,!1,!0),new Jr("BC6H_UF16",1,3,di.UFLOAT,!1,!1,!1,!0),new Jr("BC6H_SF16",1,3,di.FLOAT,!1,!1,!1,!0),new Jr("BC7",1,4,di.UNORM,!0,!1,!1,!0),new Jr("BC7_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ETC_RGB8",1,3,di.UNORM,!1,!1,!1,!0),new Jr("ETC2_RGB8",1,3,di.UNORM,!1,!1,!1,!0),new Jr("ETC2_SRGB8",1,3,di.UNORM,!1,!1,!1,!0),new Jr("ETC2_RGB8_A1",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ETC2_SRGB8_A1",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ETC2_RGBA8",2,4,di.UNORM,!0,!1,!1,!0),new Jr("ETC2_SRGB8_A8",2,4,di.UNORM,!0,!1,!1,!0),new Jr("EAC_R11",1,1,di.UNORM,!1,!1,!1,!0),new Jr("EAC_R11SN",1,1,di.SNORM,!1,!1,!1,!0),new Jr("EAC_RG11",2,2,di.UNORM,!1,!1,!1,!0),new Jr("EAC_RG11SN",2,2,di.SNORM,!1,!1,!1,!0),new Jr("PVRTC_RGB2",2,3,di.UNORM,!1,!1,!1,!0),new Jr("PVRTC_RGBA2",2,4,di.UNORM,!0,!1,!1,!0),new Jr("PVRTC_RGB4",2,3,di.UNORM,!1,!1,!1,!0),new Jr("PVRTC_RGBA4",2,4,di.UNORM,!0,!1,!1,!0),new Jr("PVRTC2_2BPP",2,4,di.UNORM,!0,!1,!1,!0),new Jr("PVRTC2_4BPP",2,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_4x4",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_5x4",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_5x5",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_6x5",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_6x6",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_8x5",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_8x6",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_8x8",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_10x5",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_10x6",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_10x8",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_10x10",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_12x10",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_RGBA_12x12",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_4x4",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_5x4",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_5x5",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_6x5",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_6x6",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_8x5",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_8x6",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_8x8",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_10x5",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_10x6",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_10x8",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_10x10",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_12x10",1,4,di.UNORM,!0,!1,!1,!0),new Jr("ASTC_SRGBA_12x12",1,4,di.UNORM,!0,!1,!1,!0)]),ia=ji.UNIFORM_BUFFER|ji.DYNAMIC_UNIFORM_BUFFER|ji.STORAGE_BUFFER|ji.DYNAMIC_STORAGE_BUFFER,ra=ji.SAMPLER_TEXTURE|ji.SAMPLER|ji.TEXTURE|ji.STORAGE_IMAGE|ji.INPUT_ATTACHMENT,aa=ji.DYNAMIC_STORAGE_BUFFER|ji.DYNAMIC_UNIFORM_BUFFER;function oa(e){return e>0&&0==(e&e-1)}function sa(e,t,n,i){if(!na[e].isCompressed)return t*n*i*na[e].size;switch(e){case _i.BC1:case _i.BC1_ALPHA:case _i.BC1_SRGB:case _i.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case _i.BC2:case _i.BC2_SRGB:case _i.BC3:case _i.BC3_SRGB:case _i.BC4:case _i.BC4_SNORM:case _i.BC6H_SF16:case _i.BC6H_UF16:case _i.BC7:case _i.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case _i.BC5:case _i.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case _i.ETC_RGB8:case _i.ETC2_RGB8:case _i.ETC2_SRGB8:case _i.ETC2_RGB8_A1:case _i.EAC_R11:case _i.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case _i.ETC2_RGBA8:case _i.ETC2_SRGB8_A1:case _i.EAC_RG11:case _i.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case _i.PVRTC_RGB2:case _i.PVRTC_RGBA2:case _i.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case _i.PVRTC_RGB4:case _i.PVRTC_RGBA4:case _i.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case _i.ASTC_RGBA_4X4:case _i.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case _i.ASTC_RGBA_5X4:case _i.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case _i.ASTC_RGBA_5X5:case _i.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case _i.ASTC_RGBA_6X5:case _i.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case _i.ASTC_RGBA_6X6:case _i.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case _i.ASTC_RGBA_8X5:case _i.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case _i.ASTC_RGBA_8X6:case _i.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case _i.ASTC_RGBA_8X8:case _i.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case _i.ASTC_RGBA_10X5:case _i.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case _i.ASTC_RGBA_10X6:case _i.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case _i.ASTC_RGBA_10X8:case _i.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case _i.ASTC_RGBA_10X10:case _i.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case _i.ASTC_RGBA_12X10:case _i.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case _i.ASTC_RGBA_12X12:case _i.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function ca(e,t,n,i,r){for(var a=0,o=0;o<r;++o)a+=sa(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return a}var la=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function ua(e){return la[e]||0}function ha(e){var t=e.size/e.count;switch(e.type){case di.UNORM:case di.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case di.SNORM:case di.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case di.FLOAT:return Float32Array}return Float32Array}var fa=Object.freeze({__proto__:null,get ObjectType(){return ci},get Status(){return li},get API(){return ui},get SurfaceTransform(){return hi},get Feature(){return fi},get Format(){return _i},get FormatType(){return di},get Type(){return pi},get BufferUsageBit(){return mi},get BufferFlagBit(){return vi},get MemoryAccessBit(){return gi},get MemoryUsageBit(){return yi},get TextureType(){return Si},get TextureUsageBit(){return xi},get TextureFlagBit(){return Ei},get FormatFeatureBit(){return Ti},get SampleCount(){return Ci},get VsyncMode(){return Ai},get Filter(){return bi},get Address(){return Ii},get ComparisonFunc(){return wi},get StencilOp(){return Pi},get BlendFactor(){return Ri},get BlendOp(){return Di},get ColorMask(){return Oi},get ShaderStageFlagBit(){return Ni},get LoadOp(){return Mi},get StoreOp(){return Li},get AccessFlagBit(){return Fi},get ResolveMode(){return Bi},get PipelineBindPoint(){return zi},get PrimitiveMode(){return Ui},get PolygonMode(){return ki},get ShadeModel(){return Gi},get CullMode(){return Hi},get DynamicStateFlagBit(){return Vi},get StencilFace(){return Wi},get DescriptorType(){return ji},get QueueType(){return Xi},get QueryType(){return qi},get CommandBufferType(){return Yi},get ClearFlagBit(){return Ki},Size:er,DeviceCaps:tr,Offset:nr,Rect:ir,Extent:rr,TextureSubresLayers:ar,TextureSubresRange:or,TextureCopy:sr,TextureBlit:cr,BufferTextureCopy:lr,Viewport:ur,Color:hr,BindingMappingInfo:fr,SwapchainInfo:_r,DeviceInfo:dr,BufferInfo:pr,BufferViewInfo:mr,DrawInfo:vr,DispatchInfo:gr,IndirectBuffer:yr,TextureInfo:Sr,TextureViewInfo:xr,SamplerInfo:Er,Uniform:Tr,UniformBlock:Cr,UniformSamplerTexture:Ar,UniformSampler:br,UniformTexture:Ir,UniformStorageImage:wr,UniformStorageBuffer:Pr,UniformInputAttachment:Rr,ShaderStage:Dr,Attribute:Or,ShaderInfo:Nr,InputAssemblerInfo:Mr,ColorAttachment:Lr,DepthStencilAttachment:Fr,SubpassInfo:Br,SubpassDependency:zr,RenderPassInfo:Ur,GeneralBarrierInfo:kr,TextureBarrierInfo:Gr,FramebufferInfo:Hr,DescriptorSetLayoutBinding:Vr,DescriptorSetLayoutInfo:Wr,DescriptorSetInfo:jr,PipelineLayoutInfo:Xr,InputState:qr,CommandBufferInfo:Yr,QueueInfo:Kr,QueryPoolInfo:Qr,FormatInfo:Jr,MemoryStatus:Zr,DynamicStencilStates:$r,DynamicStates:ea,GFXObject:ta,get AttributeName(){return $i},FormatInfos:na,DESCRIPTOR_BUFFER_TYPE:ia,DESCRIPTOR_SAMPLER_TYPE:ra,DESCRIPTOR_DYNAMIC_TYPE:aa,DRAW_INFO_SIZE:28,IsPowerOf2:oa,FormatSize:sa,FormatSurfaceSize:ca,GetTypeSize:ua,getTypedArrayConstructor:ha}),_a=function(e){function t(){var t;return(t=e.call(this,ci.BUFFER)||this)._usage=mi.NONE,t._memUsage=yi.NONE,t._size=0,t._stride=1,t._count=0,t._flags=vi.NONE,t._isBufferView=!1,t}return Z(t,e),Q(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(ta),da=function(e){function t(){var t;return(t=e.call(this,ci.COMMAND_BUFFER)||this)._queue=null,t._type=Yi.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return Z(t,e),Q(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(ta),pa=function(){function e(){this._gfxAPI=ui.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(fi.COUNT),this._formatFeatures=new Array(_i.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Zr,this._caps=new tr,this._bindingMappingInfo=new fr,this._samplers=new Map,this._generalBarrierss=new Map,this._textureBarriers=new Map}var t=e.prototype;return t.hasFeature=function(e){return this._features[e]},t.getFormatFeatures=function(e){return this._formatFeatures[e]},Q(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();pa.canvas=void 0;var ma=function(e){function t(){var t;return(t=e.call(this,ci.SWAPCHAIN)||this)._transform=hi.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return Z(t,e),Q(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}(ta),va=function(e){function t(){var t;return(t=e.call(this,ci.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return Z(t,e),Q(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(ta),ga=String.prototype.charCodeAt;function ya(e){return this[e]}function Sa(e,t){for(var n=e.length,i=t^n,r=0,a="string"==typeof e?ga:ya;n>=4;){var o=255&a.call(e,r)|(255&a.call(e,++r))<<8|(255&a.call(e,++r))<<16|(255&a.call(e,++r))<<24;o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(o=1540483477*(65535&(o^=o>>>24))+((1540483477*(o>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&a.call(e,r+2))<<16;case 2:i^=(255&a.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&a.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var xa=function(e){function t(){var t;return(t=e.call(this,ci.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new vr,t}Z(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return Sa(e,666)},Q(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}(ta),Ea=function(e){function t(){var t;return(t=e.call(this,ci.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}Z(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ia){var a=this._layout.descriptorIndices[e];this._buffers[a+n]!==t&&(this._buffers[a+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ra){var a=this._layout.descriptorIndices[e];this._samplers[a+n]!==t&&(this._samplers[a+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ra){var a=this._layout.descriptorIndices[e];this._textures[a+n]!==t&&(this._textures[a+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},Q(t,[{key:"layout",get:function(){return this._layout}}]),t}(ta),Ta=function(e){function t(){var t;return(t=e.call(this,ci.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return Z(t,e),Q(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(ta),Ca=function(e){function t(){var t;return(t=e.call(this,ci.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return Z(t,e),Q(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(ta),Aa=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=ki.FILL),void 0===n&&(n=Gi.GOURAND),void 0===i&&(i=Hi.BACK),void 0===r&&(r=!0),void 0===a&&(a=!1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=a,this.depthBias=o,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=ki.FILL,this.shadeModel=Gi.GOURAND,this.cullMode=Hi.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},Q(e,[{key:"native",get:function(){return this}}]),e}(),ba=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h,f,_,d,p,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=wi.LESS),void 0===i&&(i=!1),void 0===r&&(r=wi.ALWAYS),void 0===a&&(a=65535),void 0===o&&(o=65535),void 0===s&&(s=Pi.KEEP),void 0===c&&(c=Pi.KEEP),void 0===l&&(l=Pi.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===f&&(f=wi.ALWAYS),void 0===_&&(_=65535),void 0===d&&(d=65535),void 0===p&&(p=Pi.KEEP),void 0===m&&(m=Pi.KEEP),void 0===v&&(v=Pi.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=a,this.stencilWriteMaskFront=o,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=f,this.stencilReadMaskBack=_,this.stencilWriteMaskBack=d,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=wi.LESS,this.stencilTestFront=!1,this.stencilFuncFront=wi.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Pi.KEEP,this.stencilZFailOpFront=Pi.KEEP,this.stencilPassOpFront=Pi.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=wi.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Pi.KEEP,this.stencilZFailOpBack=Pi.KEEP,this.stencilPassOpBack=Pi.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},Q(e,[{key:"native",get:function(){return this}}]),e}(),Ia=function(){function e(e,t,n,i,r,a,o,s){void 0===e&&(e=!1),void 0===t&&(t=Ri.ONE),void 0===n&&(n=Ri.ZERO),void 0===i&&(i=Di.ADD),void 0===r&&(r=Ri.ONE),void 0===a&&(a=Ri.ZERO),void 0===o&&(o=Di.ADD),void 0===s&&(s=Oi.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=a,this.blendAlphaEq=o,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Ri.ONE,this.blendDst=Ri.ZERO,this.blendEq=Di.ADD,this.blendSrcAlpha=Ri.ONE,this.blendDstAlpha=Ri.ZERO,this.blendAlphaEq=Di.ADD,this.blendColorMask=Oi.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),wa=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new hr),void 0===i&&(i=[new Ia]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new Ia),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},Q(e,[{key:"native",get:function(){return this}}]),e}(),Pa=function(e,t,n,i,r,a,o,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new qr),void 0===r&&(r=new Aa),void 0===a&&(a=new ba),void 0===o&&(o=new wa),void 0===s&&(s=Ui.TRIANGLE_LIST),void 0===c&&(c=Vi.NONE),void 0===l&&(l=zi.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=a,this.blendState=o,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Ra=function(e){function t(){var t;return(t=e.call(this,ci.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=Ui.TRIANGLE_LIST,t._is=null,t._rs=new Aa,t._dss=new ba,t._bs=new wa,t._dynamicStates=Vi.NONE,t._renderPass=null,t}return Z(t,e),Q(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(ta),Da=function(e){function t(){var t;return(t=e.call(this,ci.QUEUE)||this)._type=Xi.GRAPHICS,t}return Z(t,e),Q(t,[{key:"type",get:function(){return this._type}}]),t}(ta),Oa=function(e){function t(){var t;return(t=e.call(this,ci.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return Z(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var a=0;a<n.inputs.length;++a){var o=this._colorInfos[n.inputs[a]];e+=","+o.format+","+o.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return Sa(e,666)},Q(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(ta),Na=function(e){function t(t,n){var i;return(i=e.call(this,ci.SAMPLER)||this)._info=new Er,i._hash=0,i._info.copy(t),i._hash=n,i}return Z(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new Er;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},Q(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(ta),Ma=function(e){function t(){var t;return(t=e.call(this,ci.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return Z(t,e),Q(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(ta),La=function(e){function t(){var t;return(t=e.call(this,ci.TEXTURE)||this)._info=new Sr,t._viewInfo=new xr,t._isPowerOf2=!1,t._isTextureView=!1,t._size=0,t}return Z(t,e),t.getLevelCount=function(e,t){return Math.floor(Math.log2(Math.max(e,t)))},Q(t,[{key:"type",get:function(){return this._info.type}},{key:"usage",get:function(){return this._info.usage}},{key:"format",get:function(){return this._info.format}},{key:"width",get:function(){return this._info.width}},{key:"height",get:function(){return this._info.height}},{key:"depth",get:function(){return this._info.depth}},{key:"layerCount",get:function(){return this._info.layerCount}},{key:"levelCount",get:function(){return this._info.levelCount}},{key:"samples",get:function(){return this._info.samples}},{key:"flags",get:function(){return this._info.flags}},{key:"size",get:function(){return this._size}},{key:"info",get:function(){return this._info}},{key:"viewInfo",get:function(){return this._viewInfo}},{key:"isTextureView",get:function(){return this._isTextureView}}]),t}(ta),Fa=function(e){function t(t,n){var i;return(i=e.call(this,ci.GLOBAL_BARRIER)||this)._info=new kr,i._hash=0,i._info.copy(t),i._hash=n,i}return Z(t,e),t.computeHash=function(e){return Sa(e.prevAccesses+" "+e.nextAccesses,666)},Q(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(ta),Ba=function(e){function t(t,n){var i;return(i=e.call(this,ci.TEXTURE_BARRIER)||this)._info=new Gr,i._hash=0,i._info.copy(t),i._hash=n,i}return Z(t,e),t.computeHash=function(e){var t=e.prevAccesses+" "+e.nextAccesses;return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,Sa(t+=e.dstQueue?e.dstQueue.type:0,666)},Q(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(ta),za={Device:pa,Swapchain:ma,Buffer:_a,Texture:La,Sampler:Na,Shader:Ma,InputAssembler:xa,RenderPass:Oa,Framebuffer:va,DescriptorSet:Ea,DescriptorSetLayout:Ta,PipelineLayout:Ca,PipelineState:Ra,CommandBuffer:da,Queue:Da,GeneralBarrier:Fa,TextureBarrier:Ba,RasterizerState:Aa,BlendState:wa,BlendTarget:Ia,DepthStencilState:ba,PipelineStateInfo:Pa};Object.assign(za,fa),l.gfx=za;var Ua={GFXDevice:!0,GFXBuffer:!0,GFXTexture:!0,GFXSampler:!0,GFXShader:!0,GFXInputAssembler:!0,GFXRenderPass:!0,GFXFramebuffer:!0,GFXPipelineState:!0,GFXCommandBuffer:!0,GFXQueue:!0,GFXObjectType:!0,GFXObject:!1,GFXAttributeName:!0,GFXType:!0,GFXFormat:!0,GFXBufferUsageBit:!0,GFXMemoryUsageBit:!0,GFXBufferFlagBit:!0,GFXBufferAccessBit:"MemoryAccessBit",GFXPrimitiveMode:!0,GFXPolygonMode:!0,GFXShadeModel:!0,GFXCullMode:!0,GFXComparisonFunc:!0,GFXStencilOp:!0,GFXBlendOp:!0,GFXBlendFactor:!0,GFXColorMask:!0,GFXFilter:!0,GFXAddress:!0,GFXTextureType:!0,GFXTextureUsageBit:!0,GFXSampleCount:!0,GFXTextureFlagBit:!0,GFXShaderStageFlagBit:!0,GFXDescriptorType:!0,GFXCommandBufferType:!0,GFXLoadOp:!0,GFXStoreOp:!0,GFXPipelineBindPoint:!0,GFXDynamicStateFlagBit:!0,GFXStencilFace:!0,GFXQueueType:!0,GFXRect:!0,GFXViewport:!0,GFXColor:!0,GFXClearFlag:!0,GFXOffset:!0,GFXExtent:!0,GFXTextureSubres:"TextureSubresLayers",GFXTextureCopy:!0,GFXBufferTextureCopy:!0,GFXFormatType:!0,GFXFormatInfo:!0,GFXMemoryStatus:!0,GFXFormatInfos:!0,GFXFormatSize:!0,GFXFormatSurfaceSize:!0,GFXGetTypeSize:!0,getTypedArrayConstructor:!1};for(var ka in Ua){var Ga=Ua[ka];!0===Ga?Ga=ka.slice(3):!1===Ga&&(Ga=ka),U(l,"cc",[{name:ka,newName:Ga,target:l.gfx,targetName:"cc.gfx"}])}k(l,"cc",[{name:"GFX_MAX_VERTEX_ATTRIBUTES"},{name:"GFX_MAX_TEXTURE_UNITS"},{name:"GFX_MAX_ATTACHMENTS"},{name:"GFX_MAX_BUFFER_BINDINGS"},{name:"GFXTextureLayout"}]),k(fi,"Feature",[{name:"COLOR_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.RENDER_TARGET;"},{name:"COLOR_HALF_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.RENDER_TARGET;"},{name:"TEXTURE_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R32F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);"},{name:"TEXTURE_HALF_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R16F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);"},{name:"TEXTURE_FLOAT_LINEAR",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.LINEAR_FILTER;"},{name:"TEXTURE_HALF_FLOAT_LINEAR",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.LINEAR_FILTER;"},{name:"FORMAT_R11G11B10F",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R11G11B10F) !== FormatFeatureBit.NONE;"},{name:"FORMAT_SRGB",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.SRGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ETC1",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC_RGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ETC2",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC2_RGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_DXT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.BC1) !== FormatFeatureBit.NONE;"},{name:"FORMAT_PVRTC",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.PVRTC_RGB2) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ASTC",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ASTC_RGBA_4x4) !== FormatFeatureBit.NONE;"},{name:"FORMAT_RGB8",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.RGB8) !== FormatFeatureBit.NONE;"}]),k(Lr.prototype,"ColorAttachment",[{name:"beginAccesses",suggest:"Please assign to ColorAttachment.barrier instead"},{name:"endAccesses",suggest:"Please assign to ColorAttachment.barrier instead"}]),k(Fr.prototype,"DepthStencilAttachment",[{name:"beginAccesses",suggest:"Please assign to DepthStencilAttachment.barrier instead"},{name:"endAccesses",suggest:"Please assign to DepthStencilAttachment.barrier instead"}]),U(pa.prototype,"Device",[{name:"getGlobalBarrier",newName:"getGeneralBarrier"}]),e("gfx",Object.freeze({__proto__:null,DescriptorSet:Ea,Buffer:_a,CommandBuffer:da,get ObjectType(){return ci},get Status(){return li},get API(){return ui},get SurfaceTransform(){return hi},get Feature(){return fi},get Format(){return _i},get FormatType(){return di},get Type(){return pi},get BufferUsageBit(){return mi},get BufferFlagBit(){return vi},get MemoryAccessBit(){return gi},get MemoryUsageBit(){return yi},get TextureType(){return Si},get TextureUsageBit(){return xi},get TextureFlagBit(){return Ei},get FormatFeatureBit(){return Ti},get SampleCount(){return Ci},get VsyncMode(){return Ai},get Filter(){return bi},get Address(){return Ii},get ComparisonFunc(){return wi},get StencilOp(){return Pi},get BlendFactor(){return Ri},get BlendOp(){return Di},get ColorMask(){return Oi},get ShaderStageFlagBit(){return Ni},get LoadOp(){return Mi},get StoreOp(){return Li},get AccessFlagBit(){return Fi},get ResolveMode(){return Bi},get PipelineBindPoint(){return zi},get PrimitiveMode(){return Ui},get PolygonMode(){return ki},get ShadeModel(){return Gi},get CullMode(){return Hi},get DynamicStateFlagBit(){return Vi},get StencilFace(){return Wi},get DescriptorType(){return ji},get QueueType(){return Xi},get QueryType(){return qi},get CommandBufferType(){return Yi},get ClearFlagBit(){return Ki},Size:er,DeviceCaps:tr,Offset:nr,Rect:ir,Extent:rr,TextureSubresLayers:ar,TextureSubresRange:or,TextureCopy:sr,TextureBlit:cr,BufferTextureCopy:lr,Viewport:ur,Color:hr,BindingMappingInfo:fr,SwapchainInfo:_r,DeviceInfo:dr,BufferInfo:pr,BufferViewInfo:mr,DrawInfo:vr,DispatchInfo:gr,IndirectBuffer:yr,TextureInfo:Sr,TextureViewInfo:xr,SamplerInfo:Er,Uniform:Tr,UniformBlock:Cr,UniformSamplerTexture:Ar,UniformSampler:br,UniformTexture:Ir,UniformStorageImage:wr,UniformStorageBuffer:Pr,UniformInputAttachment:Rr,ShaderStage:Dr,Attribute:Or,ShaderInfo:Nr,InputAssemblerInfo:Mr,ColorAttachment:Lr,DepthStencilAttachment:Fr,SubpassInfo:Br,SubpassDependency:zr,RenderPassInfo:Ur,GeneralBarrierInfo:kr,TextureBarrierInfo:Gr,FramebufferInfo:Hr,DescriptorSetLayoutBinding:Vr,DescriptorSetLayoutInfo:Wr,DescriptorSetInfo:jr,PipelineLayoutInfo:Xr,InputState:qr,CommandBufferInfo:Yr,QueueInfo:Kr,QueryPoolInfo:Qr,FormatInfo:Jr,MemoryStatus:Zr,DynamicStencilStates:$r,DynamicStates:ea,GFXObject:ta,get AttributeName(){return $i},FormatInfos:na,DESCRIPTOR_BUFFER_TYPE:ia,DESCRIPTOR_SAMPLER_TYPE:ra,DESCRIPTOR_DYNAMIC_TYPE:aa,DRAW_INFO_SIZE:28,IsPowerOf2:oa,FormatSize:sa,FormatSurfaceSize:ca,GetTypeSize:ua,getTypedArrayConstructor:ha,Device:pa,Swapchain:ma,Framebuffer:va,InputAssembler:xa,DescriptorSetLayout:Ta,PipelineLayout:Ca,RasterizerState:Aa,DepthStencilState:ba,BlendTarget:Ia,BlendState:wa,PipelineStateInfo:Pa,PipelineState:Ra,Queue:Da,RenderPass:Oa,Sampler:Na,Shader:Ma,Texture:La,GeneralBarrier:Fa,TextureBarrier:Ba}));var Ha=new Pn,Va=new Pn,Wa=new Pn,ja=new Pn,Xa=new Pn,qa=new Pn,Ya=new Array(3),Ka=new Array(3);function Qa(e,t){return Pn.dot(t.n,e)-t.d}function Ja(e,t,n){return Pn.copy(e,t),Pn.subtract(Xa,n.center,n.halfExtents),Pn.add(qa,n.center,n.halfExtents),e.x=e.x<Xa.x?Xa.x:e.x,e.y=e.y<Xa.y?Xa.y:e.y,e.z=e.z<Xa.z?Xa.z:e.z,e.x=e.x>qa.x?qa.x:e.x,e.y=e.y>qa.y?qa.y:e.y,e.z=e.z>qa.z?qa.z:e.z,e}function Za(e,t,n){Pn.set(Ha,n.orientation.m00,n.orientation.m01,n.orientation.m02),Pn.set(Va,n.orientation.m03,n.orientation.m04,n.orientation.m05),Pn.set(Wa,n.orientation.m06,n.orientation.m07,n.orientation.m08),Ya[0]=Ha,Ya[1]=Va,Ya[2]=Wa,Ka[0]=n.halfExtents.x,Ka[1]=n.halfExtents.y,Ka[2]=n.halfExtents.z,Pn.subtract(ja,t,n.center),Pn.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=Pn.dot(ja,Ya[i]);r>Ka[i]&&(r=Ka[i]),r<-Ka[i]&&(r=-Ka[i]),e.x+=r*Ya[i].x,e.y+=r*Ya[i].y,e.z+=r*Ya[i].z}return e}var $a=Object.freeze({__proto__:null,point_plane:Qa,pt_point_plane:function(e,t,n){var i=Qa(t,n);return Pn.subtract(e,t,Pn.multiplyScalar(e,n.n,i))},pt_point_aabb:Ja,pt_point_obb:Za,pt_point_line:function(e,t,n,i){Pn.subtract(Ha,n,i);var r=Ha,a=Pn.lengthSqr(r);if(0==a)Pn.copy(e,n);else{Pn.subtract(Ha,t,n);var o=Pn.dot(Ha,r)/a;o<0?Pn.copy(e,n):o>1?Pn.copy(e,i):Pn.scaleAndAdd(e,n,r,o)}}}),eo={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},to=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=eo.SHAPE_LINE,this.s=new Pn(e,t,n),this.e=new Pn(i,r,a)}return e.create=function(t,n,i,r,a,o){return new e(t,n,i,r,a,o)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return Pn.copy(e.s,t.s),Pn.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return Pn.copy(e.s,t),Pn.copy(e.e,n),e},e.set=function(e,t,n,i,r,a,o){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=a,e.e.z=o,e},e.len=function(e){return Pn.distance(e.s,e.e)},e.prototype.length=function(){return Pn.distance(this.s,this.e)},Q(e,[{key:"type",get:function(){return this._type}}]),e}(),no=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=eo.SHAPE_RAY,this.o=new Pn(e,t,n),this.d=new Pn(i,r,a)}return e.create=function(t,n,i,r,a,o){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=1),new e(t,n,i,r,a,o)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return Pn.copy(e.o,t.o),Pn.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return Pn.copy(e.o,t),Pn.normalize(e.d,Pn.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,a,o){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=a,e.d.z=o,e},e.prototype.computeHit=function(e,t){Pn.normalize(e,this.d),Pn.scaleAndAdd(e,this.o,e,t)},Q(e,[{key:"type",get:function(){return this._type}}]),e}(),io=new Pn,ro=new Pn,ao=new Pn,oo=new Pn;function so(e){return Math.max(Math.max(e.x,e.y),e.z)}var co,lo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new Pn(0,0,0),this._radius=0,this._type=void 0,this._type=eo.SHAPE_SPHERE,this._center=new Pn(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return Pn.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return Pn.multiplyScalar(e.center,Pn.add(io,t,n),.5),e.radius=.5*Pn.subtract(io,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){Pn.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Pn.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){Pn.transformMat4(r.center,this.center,e),r.radius=this.radius*so(i)},t.translateAndRotate=function(e,t,n){Pn.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*so(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),Pn.subtract(ro,e,this.center);var t=ro.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,Pn.multiplyScalar(ro,ro,n/t),Pn.add(this.center,this.center,ro)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(ao,oo),this.mergePoint(ao),this.mergePoint(oo)},Q(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),uo=function(){function e(e,t,n,i,r,a,o,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=eo.SHAPE_TRIANGLE,this.a=new Pn(e,t,n),this.b=new Pn(i,r,a),this.c=new Pn(o,s,c)}return e.create=function(t,n,i,r,a,o,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,a,o,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return Pn.copy(e.a,t.a),Pn.copy(e.b,t.b),Pn.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return Pn.copy(e.a,t),Pn.copy(e.b,n),Pn.copy(e.c,i),e},e.set=function(e,t,n,i,r,a,o,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=a,e.b.z=o,e.c.x=s,e.c.y=c,e.c.z=l,e},Q(e,[{key:"type",get:function(){return this._type}}]),e}();!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(co||(co={}));var ho,fo,_o,po,mo,vo,go,yo,So=(ho=new Pn(0,0,0),function(e,t){var n=Pn.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;Pn.multiplyScalar(ho,t.n,t.d);var i=Pn.dot(Pn.subtract(ho,ho,e.o),t.n)/n;return i<0?0:i}),xo=(fo=new Pn(0,0,0),_o=new Pn(0,0,0),po=new Pn(0,0,0),mo=new Pn(0,0,0),vo=new Pn(0,0,0),function(e,t,n){Pn.subtract(fo,t.b,t.a),Pn.subtract(_o,t.c,t.a),Pn.cross(po,e.d,_o);var i=Pn.dot(fo,po);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;Pn.subtract(mo,e.o,t.a);var a=Pn.dot(mo,po)*r;if(a<0||a>1)return 0;Pn.cross(vo,mo,fo);var o=Pn.dot(e.d,vo)*r;if(o<0||a+o>1)return 0;var s=Pn.dot(_o,vo)*r;return s<0?0:s}),Eo=function(){var e=new Pn(0,0,0);return function(t,n){var i=n.radius,r=n.center,a=t.o,o=t.d,s=i*i;Pn.subtract(e,r,a);var c=e.lengthSqr(),l=Pn.dot(e,o),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),f=c<s?l+h:l-h;return f<0?0:f}}(),To=(go=new Pn,yo=new Pn,function(e,t){return Pn.subtract(go,t.center,t.halfExtents),Pn.add(yo,t.center,t.halfExtents),Co(e,go,yo)});function Co(e,t,n){var i=e.o,r=e.d,a=1/r.x,o=1/r.y,s=1/r.z,c=(t.x-i.x)*a,l=(n.x-i.x)*a,u=(t.y-i.y)*o,h=(n.y-i.y)*o,f=(t.z-i.z)*s,_=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(f,_)),p=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(f,_));return p<0||d>p?0:d>0?d:p}var Ao,bo,Io,wo,Po=function(){var e=new Pn,t=new Pn,n=new Pn,i=new Pn,r=new Pn,a=new Pn,o=new Pn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,f){s[0]=f.halfExtents.x,s[1]=f.halfExtents.y,s[2]=f.halfExtents.z,e=f.center,t=h.o,n=h.d,Pn.set(i,f.orientation.m00,f.orientation.m01,f.orientation.m02),Pn.set(r,f.orientation.m03,f.orientation.m04,f.orientation.m05),Pn.set(a,f.orientation.m06,f.orientation.m07,f.orientation.m08),Pn.subtract(o,e,t),c[0]=Pn.dot(i,n),c[1]=Pn.dot(r,n),c[2]=Pn.dot(a,n),l[0]=Pn.dot(i,o),l[1]=Pn.dot(r,o),l[2]=Pn.dot(a,o);for(var _=0;_<3;++_){if(0===c[_]){if(-l[_]-s[_]>0||-l[_]+s[_]<0)return 0;c[_]=1e-7}u[2*_+0]=(l[_]+s[_])/c[_],u[2*_+1]=(l[_]-s[_])/c[_]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||d>p?0:d>0?d:p}}(),Ro=function(){var e=new Pn,t=new Pn,n=new Pn,i=new Pn,r=new Pn,a=new Pn,o=new Pn,s=new lo;return function(c,l){var u=l.radius*l.radius,h=Pn.normalize(e,c.d),f=l.ellipseCenter0,_=l.ellipseCenter1,d=Pn.subtract(t,_,f);if(d.equals(Pn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),ds.raySphere(c,s);var p=c.o,m=Pn.subtract(n,p,f),v=Pn.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=Pn.subtract(r,_,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ds.raySphere(c,s)}var S=Pn.cross(r,m,d),x=d.lengthSqr(),E=2*Pn.dot(v,S),T=E*E-4*g*(S.lengthSqr()-u*x);if(T<0)return 0;var C=(-E-Math.sqrt(T))/(2*g);if(C<0){s.radius=l.radius;var A=Pn.subtract(a,_,p);return m.lengthSqr()<A.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ds.raySphere(c,s)}var b=Pn.scaleAndAdd(a,c.o,h,C),I=Pn.subtract(o,b,f),w=Pn.dot(I,d)/x;return w>=0&&w<=1?C:w<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),ds.raySphere(c,s)):w>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),ds.raySphere(c,s)):0}}(),Do=(Ao=uo.create(),bo={distance:1/0,doubleSided:!1,mode:co.ANY},Io=0,wo=function(e,t,n,i,r,a){e===co.CLOSEST?(Io>t||0===Io)&&(Io=t,a&&(0===a.length?a.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(a[0].distance=t,a[0].vertexIndex0=n/3,a[0].vertexIndex1=i/3,a[0].vertexIndex2=r/3))):(Io=t,a&&a.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(Io=0,0===t.geometricInfo.positions.length)return Io;var i=void 0===n?bo:n;if(Co(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,a=t.geometricInfo;!function(e,t,n,i,r){if(n===Ui.TRIANGLE_LIST)for(var a=t.length,o=0;o<a;o+=3){var s=3*t[o],c=3*t[o+1],l=3*t[o+2];Pn.set(Ao.a,e[s],e[s+1],e[s+2]),Pn.set(Ao.b,e[c],e[c+1],e[c+2]),Pn.set(Ao.c,e[l],e[l+1],e[l+2]);var u=ds.rayTriangle(i,Ao,r.doubleSided);if(!(0===u||u>r.distance)&&(wo(r.mode,u,s,c,l,r.result),r.mode===co.ANY))return u}else if(n===Ui.TRIANGLE_STRIP)for(var h=t.length-2,f=0,_=0;_<h;_+=1){var d=3*t[_-f],p=3*t[_+f+1],m=3*t[_+2];Pn.set(Ao.a,e[d],e[d+1],e[d+2]),Pn.set(Ao.b,e[p],e[p+1],e[p+2]),Pn.set(Ao.c,e[m],e[m+1],e[m+2]),f=~f;var v=ds.rayTriangle(i,Ao,r.doubleSided);if(!(0===v||v>r.distance)&&(wo(r.mode,v,d,p,m,r.result),r.mode===co.ANY))return v}else if(n===Ui.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];Pn.set(Ao.a,e[y],e[y+1],e[y+2]);for(var S=1;S<g;S+=1){var x=3*t[S],E=3*t[S+1];Pn.set(Ao.b,e[x],e[x+1],e[x+2]),Pn.set(Ao.c,e[E],e[E+1],e[E+2]);var T=ds.rayTriangle(i,Ao,r.doubleSided);if(!(0===T||T>r.distance)&&(wo(r.mode,T,y,x,E,r.result),r.mode===co.ANY))return T}}}(a.positions,a.indices,r,e,i)}return Io}),Oo=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:co.ANY};return function(n,i,r){e=0;var a=void 0===r?t:r,o=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!Co(n,s,c))return e;for(var l=0;l<o;l++){var u=i.renderingSubMeshes[l],h=Do(n,u,a);if(h)if(a.mode===co.CLOSEST)(0===e||e>h)&&(e=h,a.subIndices&&(a.subIndices[0]=l));else if(e=h,a.subIndices&&a.subIndices.push(l),a.mode===co.ANY)return h}return e&&a.mode===co.CLOSEST&&(a.result&&(a.result[0].distance=e,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),e}}(),No=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:co.ANY},n=new no,i=new Wn;return function(r,a,o){e=0;var s=void 0===o?t:o,c=a.worldBounds;if(c&&!To(r,c))return e;no.copy(n,r),a.node&&(Wn.invert(i,a.node.getWorldMatrix(i)),Pn.transformMat4(n.o,r.o,i),Pn.transformMat4Normal(n.d,r.d,i));for(var l=a.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,f=Do(n,h,s);if(f)if(s.mode===co.CLOSEST)(0===e||e>f)&&(e=f,s.subIndices&&(s.subIndices[0]=u));else if(e=f,s.subIndices&&s.subIndices.push(u),s.mode===co.ANY)return f}return e&&s.mode===co.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),Mo=function(){var e=new Pn(0,0,0);return function(t,n){Pn.subtract(e,t.e,t.s);var i=(n.d-Pn.dot(t.s,n.n))/Pn.dot(e,n.n);return i<0||i>1?0:i}}(),Lo=function(){var e=new Pn(0,0,0),t=new Pn(0,0,0),n=new Pn(0,0,0),i=new Pn(0,0,0),r=new Pn(0,0,0),a=new Pn(0,0,0);return function(o,s,c){Pn.subtract(e,s.b,s.a),Pn.subtract(t,s.c,s.a),Pn.subtract(n,o.s,o.e),Pn.cross(r,e,t);var l=Pn.dot(n,r);if(l<=0)return 0;Pn.subtract(i,o.s,s.a);var u=Pn.dot(i,r);if(u<0||u>l)return 0;Pn.cross(a,n,i);var h=Pn.dot(t,a);if(h<0||h>l)return 0;var f=-Pn.dot(e,a);if(f<0||h+f>l)return 0;if(c){var _=1/l,d=1-(h*=_)-(f*=_);Pn.set(c,s.a.x*d+s.b.x*h+s.c.x*f,s.a.y*d+s.b.y*h+s.c.y*f,s.a.z*d+s.b.z*h+s.c.z*f)}return 1}}(),Fo=new no;function Bo(e,t){Fo.o.set(e.s),Pn.subtract(Fo.d,e.e,e.s),Fo.d.normalize();var n=To(Fo,t);return n<=e.length()?n:0}function zo(e,t){Fo.o.set(e.s),Pn.subtract(Fo.d,e.e,e.s),Fo.d.normalize();var n=Po(Fo,t);return n<=e.length()?n:0}function Uo(e,t){Fo.o.set(e.s),Pn.subtract(Fo.d,e.e,e.s),Fo.d.normalize();var n=Eo(Fo,t);return n<=e.length()?n:0}var ko,Go,Ho,Vo,Wo=(ko=new Pn,Go=new Pn,Ho=new Pn,Vo=new Pn,function(e,t){return Pn.subtract(ko,e.center,e.halfExtents),Pn.add(Go,e.center,e.halfExtents),Pn.subtract(Ho,t.center,t.halfExtents),Pn.add(Vo,t.center,t.halfExtents),ko.x<=Vo.x&&Go.x>=Ho.x&&ko.y<=Vo.y&&Go.y>=Ho.y&&ko.z<=Vo.z&&Go.z>=Ho.z});function jo(e,t,n,i,r,a){Pn.set(a[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),Pn.set(a[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),Pn.set(a[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),Pn.set(a[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),Pn.set(a[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),Pn.set(a[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),Pn.set(a[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),Pn.set(a[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function Xo(e,t){for(var n=Pn.dot(t,e[0]),i=n,r=1;r<8;++r){var a=Pn.dot(t,e[r]);n=a<n?a:n,i=a>i?a:i}return[n,i]}var qo,Yo,Ko,Qo=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Pn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Pn(0,0,0),i[r]=new Pn(0,0,0);var a=new Pn,o=new Pn;return function(t,r){Pn.set(e[0],1,0,0),Pn.set(e[1],0,1,0),Pn.set(e[2],0,0,1),Pn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Pn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Pn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)Pn.cross(e[6+3*s],e[s],e[3]),Pn.cross(e[7+3*s],e[s],e[4]),Pn.cross(e[7+3*s],e[s],e[5]);Pn.subtract(a,t.center,t.halfExtents),Pn.add(o,t.center,t.halfExtents),function(e,t,n){Pn.set(n[0],e.x,t.y,t.z),Pn.set(n[1],e.x,t.y,e.z),Pn.set(n[2],e.x,e.y,t.z),Pn.set(n[3],e.x,e.y,e.z),Pn.set(n[4],t.x,t.y,t.z),Pn.set(n[5],t.x,t.y,e.z),Pn.set(n[6],t.x,e.y,t.z),Pn.set(n[7],t.x,e.y,e.z)}(a,o,n),jo(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Xo(n,e[c]),u=Xo(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Jo=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=Pn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Zo=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Jo(e,t.planes[n]))return 0;return 1},$o=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new Pn(0,0,0);return function(i,r){for(var a=0,o=!1,s=0;s<r.planes.length;s++){if(-1===(a=Jo(i,r.planes[s])))return 0;1===a&&(o=!0)}if(!o)return 1;for(var c=0;c<r.vertices.length;c++)Pn.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),es=(qo=new Pn(0,0,0),Yo=new Nn,function(e,t){return Pn.subtract(qo,t,e.center),Pn.transformMat3(qo,qo,Nn.transpose(Yo,e.orientation)),n=qo,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),ts=(Ko=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Ko(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ko(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ko(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=Pn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),ns=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===ts(e,t.planes[n]))return 0;return 1},is=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new Pn(0,0,0);var a=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,o){for(var s=0,c=!1,l=0;l<o.planes.length;l++){if(-1===(s=ts(r,o.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<o.vertices.length;u++)Pn.subtract(e[u],o.vertices[u],r.center);n=0,i=0;for(var h=0;h<o.vertices.length;h++)(t=a(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===o.vertices.length||i===o.vertices.length)return 0;n=0,i=0;for(var f=0;f<o.vertices.length;f++)(t=a(e[f],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===o.vertices.length||i===o.vertices.length)return 0;n=0,i=0;for(var _=0;_<o.vertices.length;_++)(t=a(e[_],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===o.vertices.length||i===o.vertices.length?0:1}}(),rs=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Pn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Pn(0,0,0),i[r]=new Pn(0,0,0);return function(t,r){Pn.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),Pn.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),Pn.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),Pn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Pn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Pn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var a=0;a<3;++a)Pn.cross(e[6+3*a],e[a],e[3]),Pn.cross(e[7+3*a],e[a],e[4]),Pn.cross(e[8+3*a],e[a],e[5]);jo(t.center,t.halfExtents,e[0],e[1],e[2],n),jo(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var o=0;o<15;++o){var s=Xo(n,e[o]),c=Xo(i,e[o]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),as=function(){for(var e=new lo,t=new Pn,n=new Pn,i=new Pn,r=new Array(8),a=0;a<8;a++)r[a]=new Pn;for(var o=new Array(8),s=0;s<8;s++)o[s]=new Pn;return function(a,s){if(0===Pn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),ds.sphereOBB(e,a);t.x=a.orientation.m00,t.y=a.orientation.m01,t.z=a.orientation.m02,n.x=a.orientation.m03,n.y=a.orientation.m04,n.z=a.orientation.m05,i.x=a.orientation.m06,i.y=a.orientation.m07,i.z=a.orientation.m08,jo(a.center,a.halfExtents,t,n,i,r);var c=o,l=Pn.copy(c[0],t),u=Pn.copy(c[1],n),h=Pn.copy(c[2],i);Pn.subtract(c[3],s.center,a.center).normalize();var f=Pn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);f.normalize(),Pn.cross(c[5],l,f),Pn.cross(c[6],u,f),Pn.cross(c[7],h,f);for(var _=0;_<8;++_){var d=Xo(r,c[_]),p=Pn.dot(c[_],s.ellipseCenter0),m=Pn.dot(c[_],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),os=function(e,t){var n=Pn.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},ss=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===os(e,t.planes[n]))return 0;return 1},cs=function(){var e=new Pn(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var a=i.planes[r],o=n.radius,s=n.center,c=a.n,l=a.d,u=Pn.dot(c,s);if(u+o<l)return 0;if(!(u-o>l)){Pn.add(e,s,Pn.multiplyScalar(e,c,o));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var f=i.planes[h];if(Pn.dot(f.n,e)<f.d)return 0}}}return 1}}(),ls=function(e,t){var n=e.radius+t.radius;return Pn.squaredDistance(e.center,t.center)<n*n},us=function(){var e=new Pn;return function(t,n){return Ja(e,t.center,n),Pn.squaredDistance(t.center,e)<t.radius*t.radius}}(),hs=function(){var e=new Pn;return function(t,n){return Za(e,t.center,n),Pn.squaredDistance(t.center,e)<t.radius*t.radius}}(),fs=function(){var e=new Pn,t=new Pn;return function(n,i){var r=n.radius+i.radius,a=r*r,o=Pn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===o)return Pn.squaredDistance(n.center,i.center)<a;Pn.subtract(e,n.center,i.ellipseCenter0),Pn.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=Pn.dot(e,t)/o;return s<0?Pn.squaredDistance(n.center,i.ellipseCenter0)<a:s>1?Pn.squaredDistance(n.center,i.ellipseCenter1)<a:(Pn.scaleAndAdd(e,i.ellipseCenter0,t,s),Pn.squaredDistance(n.center,e)<a)}}(),_s=function(){var e=new Pn,t=new Pn,n=new Pn,i=new Pn,r=new Pn,a=new Pn;return function(o,s){var c,l,u=Pn.subtract(e,o.ellipseCenter1,o.ellipseCenter0),h=Pn.subtract(t,s.ellipseCenter1,s.ellipseCenter0),f=Pn.subtract(n,o.ellipseCenter0,s.ellipseCenter0),_=Pn.dot(u,u),d=Pn.dot(u,h),p=Pn.dot(h,h),m=Pn.dot(u,f),v=Pn.dot(h,f),g=_*p-d*d,y=g,S=g;g<an?(c=0,y=1,l=v,S=p):(l=_*v-d*m,(c=d*v-p*m)<0?(c=0,l=v,S=p):c>y&&(c=y,l=v+d,S=p)),l<0?(l=0,-m<0?c=0:-m>_?c=y:(c=-m,y=_)):l>S&&(l=S,-m+d<0?c=0:-m+d>_?c=y:(c=-m+d,y=_));var x=Math.abs(c)<an?0:c/y,E=Math.abs(l)<an?0:l/S,T=i;T.set(f),T.add(Pn.multiplyScalar(r,u,x)),T.subtract(Pn.multiplyScalar(a,h,E));var C=o.radius+s.radius;return T.lengthSqr()<C*C}}(),ds={raySphere:Eo,rayAABB:To,rayOBB:Po,rayPlane:So,rayTriangle:xo,rayCapsule:Ro,raySubMesh:Do,rayMesh:Oo,rayModel:No,lineSphere:Uo,lineAABB:Bo,lineOBB:zo,linePlane:Mo,lineTriangle:Lo,sphereWithSphere:ls,sphereAABB:us,sphereOBB:hs,spherePlane:os,sphereFrustum:ss,sphereFrustumAccurate:cs,sphereCapsule:fs,aabbWithAABB:Wo,aabbWithOBB:Qo,aabbPlane:Jo,aabbFrustum:Zo,aabbFrustumAccurate:$o,obbWithOBB:rs,obbPlane:ts,obbFrustum:ns,obbFrustumAccurate:is,obbPoint:es,obbCapsule:as,capsuleWithCapsule:_s,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,a=this[i|r];return i<r?a(e,t,n):a(t,e,n)}};ds[eo.SHAPE_RAY|eo.SHAPE_SPHERE]=Eo,ds[eo.SHAPE_RAY|eo.SHAPE_AABB]=To,ds[eo.SHAPE_RAY|eo.SHAPE_OBB]=Po,ds[eo.SHAPE_RAY|eo.SHAPE_PLANE]=So,ds[eo.SHAPE_RAY|eo.SHAPE_TRIANGLE]=xo,ds[eo.SHAPE_RAY|eo.SHAPE_CAPSULE]=Ro,ds[eo.SHAPE_LINE|eo.SHAPE_SPHERE]=Uo,ds[eo.SHAPE_LINE|eo.SHAPE_AABB]=Bo,ds[eo.SHAPE_LINE|eo.SHAPE_OBB]=zo,ds[eo.SHAPE_LINE|eo.SHAPE_PLANE]=Mo,ds[eo.SHAPE_LINE|eo.SHAPE_TRIANGLE]=Lo,ds[eo.SHAPE_SPHERE]=ls,ds[eo.SHAPE_SPHERE|eo.SHAPE_AABB]=us,ds[eo.SHAPE_SPHERE|eo.SHAPE_OBB]=hs,ds[eo.SHAPE_SPHERE|eo.SHAPE_PLANE]=os,ds[eo.SHAPE_SPHERE|eo.SHAPE_FRUSTUM]=ss,ds[eo.SHAPE_SPHERE|eo.SHAPE_FRUSTUM_ACCURATE]=cs,ds[eo.SHAPE_SPHERE|eo.SHAPE_CAPSULE]=fs,ds[eo.SHAPE_AABB]=Wo,ds[eo.SHAPE_AABB|eo.SHAPE_OBB]=Qo,ds[eo.SHAPE_AABB|eo.SHAPE_PLANE]=Jo,ds[eo.SHAPE_AABB|eo.SHAPE_FRUSTUM]=Zo,ds[eo.SHAPE_AABB|eo.SHAPE_FRUSTUM_ACCURATE]=$o,ds[eo.SHAPE_OBB]=rs,ds[eo.SHAPE_OBB|eo.SHAPE_PLANE]=ts,ds[eo.SHAPE_OBB|eo.SHAPE_FRUSTUM]=ns,ds[eo.SHAPE_OBB|eo.SHAPE_FRUSTUM_ACCURATE]=is,ds[eo.SHAPE_OBB|eo.SHAPE_CAPSULE]=as,ds[eo.SHAPE_CAPSULE]=_s,U(to.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),k(ds,"intersect",[{name:"line_quad"}]);var ps,ms,vs,gs,ys,Ss,xs,Es=new Pn(0,0,0),Ts=new Pn(0,0,0),Cs=l.mat4(),As=l.v4(),bs=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=eo.SHAPE_PLANE,this.n=new Pn(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return Pn.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return Pn.subtract(Es,n,t),Pn.subtract(Ts,i,t),Pn.normalize(e.n,Pn.cross(e.n,Es,Ts)),e.d=Pn.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return Pn.copy(e.n,t),e.d=Pn.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return Pn.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){Wn.invert(Cs,e),Wn.transpose(Cs,Cs),Zn.set(As,this.n.x,this.n.y,this.n.z,this.d),Zn.transformMat4(As,As,Cs),Pn.set(this.n,As.x,As.y,As.z),this.d=As.w},Q(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),Is=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(xs||(xs={}));var ws,Ps,Rs=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Is(e,r,this._stride);var a=xs.NEVER,o=!1,s=!1;for(var c in t){if(o=this._hasFloat32,(s=this._hasUint32)&&o)break;a=t[c],o||a!==xs.FLOAT32?s||a!==xs.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],a=[],o=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&a.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&o.push(l);return c&&this._uint32BufferViews.push(a),s&&this._float32BufferViews.push(r),this._freeLists.push(o),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,a=(this._dataType[t]===xs.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],o=this._dataMembers[t];return a.subarray(r,r+o)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(ws||(ws={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(Ps||(Ps={}));var Ds,Os=((ps={})[Ps.DIRTY_FLAG]=xs.UINT32,ps[Ps.LAYER]=xs.UINT32,ps[Ps.WORLD_SCALE]=xs.FLOAT32,ps[Ps.WORLD_POSITION]=xs.FLOAT32,ps[Ps.WORLD_ROTATION]=xs.FLOAT32,ps[Ps.WORLD_MATRIX]=xs.FLOAT32,ps[Ps.LOCAL_SCALE]=xs.FLOAT32,ps[Ps.LOCAL_POSITION]=xs.FLOAT32,ps[Ps.LOCAL_ROTATION]=xs.FLOAT32,ps[Ps.COUNT]=xs.NEVER,ps),Ns=((ms={})[Ps.DIRTY_FLAG]=Ps.LAYER-Ps.DIRTY_FLAG,ms[Ps.LAYER]=Ps.WORLD_SCALE-Ps.LAYER,ms[Ps.WORLD_SCALE]=Ps.WORLD_POSITION-Ps.WORLD_SCALE,ms[Ps.WORLD_POSITION]=Ps.WORLD_ROTATION-Ps.WORLD_POSITION,ms[Ps.WORLD_ROTATION]=Ps.WORLD_MATRIX-Ps.WORLD_ROTATION,ms[Ps.WORLD_MATRIX]=Ps.LOCAL_SCALE-Ps.WORLD_MATRIX,ms[Ps.LOCAL_SCALE]=Ps.LOCAL_POSITION-Ps.LOCAL_SCALE,ms[Ps.LOCAL_POSITION]=Ps.LOCAL_ROTATION-Ps.LOCAL_POSITION,ms[Ps.LOCAL_ROTATION]=Ps.COUNT-Ps.LOCAL_ROTATION,ms[Ps.COUNT]=1,ms),Ms=new Rs(ws.NODE,Os,Ns,Ps);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(Ds||(Ds={}));var Ls,Fs=((vs={})[Ds.PRIORITY]=xs.UINT32,vs[Ds.STAGE]=xs.UINT32,vs[Ds.PHASE]=xs.UINT32,vs[Ds.PRIMITIVE]=xs.UINT32,vs[Ds.BATCHING_SCHEME]=xs.UINT32,vs[Ds.DYNAMIC_STATE]=xs.UINT32,vs[Ds.HASH]=xs.UINT32,vs[Ds.COUNT]=xs.NEVER,vs),Bs=((gs={})[Ds.PRIORITY]=Ds.STAGE-Ds.PRIORITY,gs[Ds.STAGE]=Ds.PHASE-Ds.STAGE,gs[Ds.PHASE]=Ds.PRIMITIVE-Ds.PHASE,gs[Ds.PRIMITIVE]=Ds.BATCHING_SCHEME-Ds.PRIMITIVE,gs[Ds.BATCHING_SCHEME]=Ds.DYNAMIC_STATE-Ds.BATCHING_SCHEME,gs[Ds.DYNAMIC_STATE]=Ds.HASH-Ds.DYNAMIC_STATE,gs[Ds.HASH]=Ds.COUNT-Ds.HASH,gs[Ds.COUNT]=1,gs),zs=new Rs(ws.PASS,Fs,Bs,Ds);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(Ls||(Ls={}));var Us=((ys={})[Ls.CENTER]=xs.FLOAT32,ys[Ls.HALFEXTENTS]=xs.FLOAT32,ys[Ls.COUNT]=xs.NEVER,ys),ks=((Ss={})[Ls.CENTER]=Ls.HALFEXTENTS-Ls.CENTER,Ss[Ls.HALFEXTENTS]=Ls.COUNT-Ls.HALFEXTENTS,Ss[Ls.COUNT]=1,Ss),Gs=new Rs(ws.AABB,Us,ks,Ls),Hs=new Pn,Vs=new Pn,Ws=new Pn,js=new Pn,Xs=new Nn,qs=function(e,t,n){Xs.m00=Math.abs(n.m00),Xs.m01=Math.abs(n.m01),Xs.m02=Math.abs(n.m02),Xs.m03=Math.abs(n.m04),Xs.m04=Math.abs(n.m05),Xs.m05=Math.abs(n.m06),Xs.m06=Math.abs(n.m08),Xs.m07=Math.abs(n.m09),Xs.m08=Math.abs(n.m10),Pn.transformMat3(e,t,Xs)},Ys=function(){function e(e,t,n,i,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=eo.SHAPE_AABB,this.center=new Pn(e,t,n),this.halfExtents=new Pn(i,r,a)}e.create=function(t,n,i,r,a,o){return new e(t,n,i,r,a,o)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return Pn.copy(e.center,t.center),Pn.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return Pn.add(Hs,n,t),Pn.subtract(Vs,n,t),Pn.multiplyScalar(e.center,Hs,.5),Pn.multiplyScalar(e.halfExtents,Vs,.5),e},e.set=function(e,t,n,i,r,a,o){return e.center.set(t,n,i),e.halfExtents.set(r,a,o),e},e.merge=function(t,n,i){return Pn.subtract(Hs,n.center,n.halfExtents),Pn.subtract(Vs,i.center,i.halfExtents),Pn.add(Ws,n.center,n.halfExtents),Pn.add(js,i.center,i.halfExtents),Pn.max(js,Ws,js),Pn.min(Ws,Hs,Vs),e.fromPoints(t,Ws,js)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return Pn.transformMat4(e.center,t.center,n),qs(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){Pn.subtract(e,this.center,this.halfExtents),Pn.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){Pn.transformMat4(r.center,this.center,e),qs(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(Hs,Vs),e.x<Hs.x&&(Hs.x=e.x),e.y<Hs.y&&(Hs.y=e.y),e.z<Hs.z&&(Hs.z=e.z),e.x>Vs.x&&(Vs.x=e.x),e.y>Vs.y&&(Vs.y=e.y),e.z>Vs.z&&(Vs.z=e.z),Pn.add(Ws,Hs,Vs),this.center.set(Pn.multiplyScalar(Ws,Ws,.5)),this.halfExtents.set(Vs.x-Ws.x,Vs.y-Ws.y,Vs.z-Ws.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},Q(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Ks=new Pn,Qs=new Pn,Js=new Nn,Zs=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h,f,_,d){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),void 0===o&&(o=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=0),void 0===d&&(d=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=eo.SHAPE_OBB,this.center=new Pn(e,t,n),this.halfExtents=new Pn(i,r,a),this.orientation=new Nn(o,s,c,l,u,h,f,_,d)}e.create=function(t,n,i,r,a,o,s,c,l,u,h,f,_,d,p){return new e(t,n,i,r,a,o,s,c,l,u,h,f,_,d,p)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return Pn.copy(e.center,t.center),Pn.copy(e.halfExtents,t.halfExtents),Nn.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return Pn.multiplyScalar(e.center,Pn.add(Ks,t,n),.5),Pn.multiplyScalar(e.halfExtents,Pn.subtract(Qs,n,t),.5),Nn.identity(e.orientation),e},e.set=function(e,t,n,i,r,a,o,s,c,l,u,h,f,_,d,p){return Pn.set(e.center,t,n,i),Pn.set(e.halfExtents,r,a,o),Nn.set(e.orientation,s,c,l,u,h,f,_,d,p),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){Js.m00=Math.abs(n.m00),Js.m01=Math.abs(n.m01),Js.m02=Math.abs(n.m02),Js.m03=Math.abs(n.m03),Js.m04=Math.abs(n.m04),Js.m05=Math.abs(n.m05),Js.m06=Math.abs(n.m06),Js.m07=Math.abs(n.m07),Js.m08=Math.abs(n.m08),Pn.transformMat3(e,t,Js)}(Ks,this.halfExtents,this.orientation),Pn.subtract(e,this.center,Ks),Pn.add(t,this.center,Ks)},t.transform=function(e,t,n,i,r){Pn.transformMat4(r.center,this.center,e),Nn.fromQuat(r.orientation,n),Pn.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){Pn.transformMat4(n.center,this.center,e),Nn.fromQuat(n.orientation,t)},t.setScale=function(e,t){Pn.multiply(t.halfExtents,this.halfExtents,e)},Q(e,[{key:"type",get:function(){return this._type}}]),e}(),$s=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=eo.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new Pn,this.rotation=new Fn,this.ellipseCenter0=new Pn(0,t,0),this.ellipseCenter1=new Pn(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var a=i,o=Tn(a);r.radius=this.radius*Math.abs(o);var s=(this.halfHeight+this.radius)*Math.abs(a.y)-r.radius;s<0&&(s=0),r.halfHeight=s,Pn.transformMat4(r.center,this.center,e),Fn.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),Pn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Pn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},Q(e,[{key:"type",get:function(){return this._type}}]),e}(),ec=new Array(8);ec[0]=new Pn(1,1,1),ec[1]=new Pn(-1,1,1),ec[2]=new Pn(-1,-1,1),ec[3]=new Pn(1,-1,1),ec[4]=new Pn(1,1,-1),ec[5]=new Pn(-1,1,-1),ec[6]=new Pn(-1,-1,-1),ec[7]=new Pn(1,-1,-1);var tc,nc,ic=new Pn,rc=new Pn,ac=new Pn,oc=function(){function e(){this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=eo.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=bs.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Pn}e.createFromAABB=function(e,t){var n=new Pn,i=new Pn;return Pn.subtract(n,t.center,t.halfExtents),Pn.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==eo.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var a=Math.tan(.5*t.fov),o=a*t.aspect;ic.set(i*o,i*a,i),rc.set(r*o,r*a,r);var s=e.vertices;return ac.set(ic.x,ic.y,ic.z),Pn.transformMat4(s[0],ac,n),ac.set(-ic.x,ic.y,ic.z),Pn.transformMat4(s[1],ac,n),ac.set(-ic.x,-ic.y,ic.z),Pn.transformMat4(s[2],ac,n),ac.set(ic.x,-ic.y,ic.z),Pn.transformMat4(s[3],ac,n),ac.set(rc.x,rc.y,rc.z),Pn.transformMat4(s[4],ac,n),ac.set(-rc.x,rc.y,rc.z),Pn.transformMat4(s[5],ac,n),ac.set(-rc.x,-rc.y,rc.z),Pn.transformMat4(s[6],ac,n),ac.set(rc.x,-rc.y,rc.z),Pn.transformMat4(s[7],ac,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)bs.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)Pn.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(Pn.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Pn.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Pn.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Pn.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Pn.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Pn.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===eo.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();Pn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var a=0;a<8;a++)Pn.transformMat4(this.vertices[a],ec[a],t)}},t.transform=function(e){if(this._type===eo.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Pn.transformMat4(this.vertices[t],this.vertices[t],e);this.updatePlanes()}},t.updatePlanes=function(){bs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),bs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),bs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),bs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),bs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),bs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},Q(e,[{key:"accurate",set:function(e){this._type=e?eo.SHAPE_FRUSTUM_ACCURATE:eo.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();oc.createOrtho=function(e,t,n,i,r,a){var o=t/2,s=n/2;Pn.set(ac,o,s,-i),Pn.transformMat4(e.vertices[0],ac,a),Pn.set(ac,-o,s,-i),Pn.transformMat4(e.vertices[1],ac,a),Pn.set(ac,-o,-s,-i),Pn.transformMat4(e.vertices[2],ac,a),Pn.set(ac,o,-s,-i),Pn.transformMat4(e.vertices[3],ac,a),Pn.set(ac,o,s,-r),Pn.transformMat4(e.vertices[4],ac,a),Pn.set(ac,-o,s,-r),Pn.transformMat4(e.vertices[5],ac,a),Pn.set(ac,-o,-s,-r),Pn.transformMat4(e.vertices[6],ac,a),Pn.set(ac,o,-s,-r),Pn.transformMat4(e.vertices[7],ac,a),bs.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),bs.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),bs.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),bs.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),bs.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),bs.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(tc||(tc={})),function(e){e[e.Default=tc.Default]="Default",e[e.Normal=tc.Normal]="Normal",e[e.Reverse=tc.Reverse]="Reverse",e[e.Loop=tc.Loop]="Loop",e[e.LoopReverse=tc.Loop|tc.Reverse]="LoopReverse",e[e.PingPong=tc.PingPong]="PingPong",e[e.PingPongReverse=tc.PingPong|tc.Reverse]="PingPongReverse"}(nc||(nc={})),st(nc);var sc,cc=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function lc(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,a=r>>>1;i<=r;a=i+r>>>1){var o=e[a];if(o>t+n)r=a-1;else{if(!(o<t-n))return a;i=a+1}}return~i}sc=Symbol.iterator;var uc,hc,fc,_c=function(){function e(){this._times=[],this._values=[]}var t=e.prototype;return t[sc]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return lc(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return lc(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||sn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,a=lc(n,e);if(a>=0)return a;var o=~a;return 0===o?(n.unshift(e),i.unshift(t)):o===r?(n.push(e),i.push(t)):(n.splice(o-1,0,e),i.splice(o-1,0,t)),o},Q(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}();function dc(e){return e>-1e-9&&e<1e-9}Zt.fastDefine("cc.KeyframeCurve",_c,{_times:[],_values:[]}),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(uc||(uc=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(hc||(hc=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(fc||(fc=e("TangentWeightMode",{})));var pc=function(){},mc=function(){return pc},vc=gc((function(){}));function gc(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function yc(e){return function(t){return function(n){!function(e,t,n){var i=xc(e);if(i){var r=Ec(i,"proto");Ec(r,"editor")[t]=n}}(n,e,t)}}}var Sc="__ccclassCache__";function xc(e){return Ec(e,Sc)}function Ec(e,t){return e[t]||(e[t]={})}var Tc=gc((function(e,t){var n=nt.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[Sc];if(r){var a=r.proto;a&&nt.mixin(i,a),e[Sc]=void 0}return Zt(i)})),Cc=yc("requireComponent"),Ac=yc("executionOrder"),bc=vc;function Ic(e,t,n){var i=null;function r(e,t,n){!function(e,t,n,i,r,a){var o,s=a&&(a.get||a.set);r&&(o=Gt(r,s));var c=nt.mixin(t,o||r||{});s?(a.get&&(c.get=a.get),a.set&&(c.set=a.set)):Pc(e,c,n,i,a)}(function(e){return xc(e.constructor)}(e),function(e,t){var n,i,r=Ec(xc(e.constructor),"proto"),a=Ec(r,"properties");return null!==(i=a[n=t])&&void 0!==i?i:a[n]={}}(e,t),e.constructor,t,i,n)}return void 0===e?Ic({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}function wc(e,t,n){var i,r,a=xc(e.constructor),o=Ec(a,"proto"),s=Ec(o,"properties"),c=null!==(r=s[i=t])&&void 0!==r?r:s[i]={};return c.__internalFlags|=Ht.STANDALONE,n&&(n.get||n.set)?(n.get&&(c.get=n.get),n.set&&(c.set=n.set)):Pc(a,c,e.constructor,t,n),c}function Pc(e,t,n,i,r){if(r)r.initializer&&(t.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var a=e.default||(e.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(n));a.hasOwnProperty(i)&&(t.default=a[i])}}var Rc=Symbol("cc:SerializationMetadata"),Dc=function(e,t,n){Mc(wc(e,t,n))};function Oc(e){return function(t,n,i){var r=wc(t,n,i);r.formerlySerializedAs=e,Mc(r)}}var Nc=function(e,t,n){var i=wc(e,t,n);i.editorOnly=!0,Mc(i)};function Mc(e){e.__internalFlags|=Ht.IMPLICIT_SERIALIZABLE}var Lc=pc,Fc=vc,Bc=mc,zc=vc,Uc=mc,kc=mc,Gc=mc,Hc=pc,Vc=mc,Wc=pc,jc=mc,Xc=mc,qc=mc,Yc=mc,Kc=mc,Qc=mc,Jc=pc,Zc=mc,$c=pc,el=pc,tl=al(Dt),nl=al(Ot),il=al(Nt),rl=al(Mt);function al(e){return Ic({type:e})}var ol,sl=function(e,t,n){wc(e,t,n).override=!0},cl=e("editorExtrasTag","__editorExtras__"),ll=function(){},ul=Object.freeze({__proto__:null,uniquelyReferenced:Lc,ccclass:Tc,property:Ic,requireComponent:Cc,executionOrder:Ac,disallowMultiple:bc,allowReplicated:function(e){Zt.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:Fc,menu:Bc,playOnFocus:zc,inspector:Uc,icon:kc,help:Gc,type:al,integer:tl,float:nl,boolean:il,string:rl});e("_decorator",ul);var hl=1<<22,fl=[],_l=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=fl.length,t=0;t<e;++t){var n=fl[t];1&n._objFlags||n._destroyImmediate()}e===fl.length?fl.length=0:fl.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(R(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,fl.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof l._BaseNode||e instanceof l.Component,r=i?"_id":null,a={};for(n in e)if(e.hasOwnProperty(n)){if(n===r)continue;switch(typeof e[n]){case"string":a[n]="";break;case"object":case"function":a[n]=null}}if(Zt._isCCClass(t))for(var o=l.Class.Attr.getClassAttrs(t),s=t.__props__,c=0;c<s.length;c++){var u=(n=s[c])+l.Class.Attr.DELIMETER+"default";if(u in o){if(i&&"_id"===n)continue;switch(typeof o[u]){case"string":a[n]="";break;case"object":case"function":a[n]=null;break;case"undefined":a[n]=void 0}}}var h="";for(n in a){var f;f=Zt.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Zt.escapeForJS(n)+"]=";var _=a[n];""===_&&(_='""'),h+=f+_+";\n"}return Function("o",h)}(this,e),Te(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?O(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},Q(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&hl)},set:function(e){e?this._objFlags|=hl:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),dl=_l.prototype;function pl(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}dl._deserialize=null,dl._onPreDestroy=null,Zt.fastDefine("cc.Object",_l,((ol={_name:"",_objFlags:0})[cl]={},ol)),Zt.Attr.setClassAttr(_l,cl,"editorOnly",!0),Zt.Attr.setClassAttr(_l,"replicated","visible",!1),Te(_l,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),l.isValid=pl,l.Object=_l;var ml=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=nt.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=nt.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},Q(e,[{key:"count",get:function(){return this._count}}]),e}(),vl=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(R(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();vl._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=nt.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},Q(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var gl,yl=new ml,Sl=new ml,xl=new ml,El=new ml,Tl=new vl("normal load",[]),Cl=new vl("fetch",[]),Al=new vl("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(gl||(gl={}));var bl,Il={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(bl||(bl={}));var wl=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var a="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[a]&&this[a](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();wl.MAX_DEAD_NUM=500,wl._taskId=0,wl._deadPool=[];var Pl="0123456789abcdef".split(""),Rl=["","","",""],Dl=Rl.concat(Rl,"-",Rl,"-",Rl,"-",Rl,"-",Rl,Rl,Rl),Ol=Dl.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Nl(e){var t=e.split("@")[0];if(22!==t.length)return e;Dl[0]=e[0],Dl[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=dt[e.charCodeAt(n)],a=dt[e.charCodeAt(n+1)];Dl[Ol[i++]]=Pl[r>>2],Dl[Ol[i++]]=Pl[(3&r)<<2|a>>4],Dl[Ol[i++]]=Pl[15&a]}return e.replace(t,Dl.join(""))}var Ml=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Ll(e){var t=Ml.exec(e);return t?t[1]:""}function Fl(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.nativeExt&&(t.ext=t.nativeExt);var n=El.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),Ul(e,t)}function Bl(e){return!!e&&(e instanceof l.SceneAsset||e instanceof l.Scene)}function zl(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function Ul(e,t){var n=wl.create({input:e,options:t}),i=[];try{for(var r,a=oe(Al.sync(n));!(r=a()).done;){var o=r.value,s=o.url;o.recycle(),i.push(s)}}catch(e){for(var c,l=oe(n.output);!(c=l()).done;)c.value.recycle();x(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var kl=Object.freeze({__proto__:null,getUuidFromURL:Ll,getUrlWithUuid:Fl,isScene:Bl,normalize:zl,transform:Ul,decodeUuid:Nl}),Gl=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,he(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),Hl=function(){function e(){this._poolHandle=-1,Gl.addContainer(this)}return e.prototype.destroy=function(){Gl.removeContainer(this)},e}(),Vl=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var a=0;a<r._elementsPerBatch;++a)r._freepool.push(t());return r}Z(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&R(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(Hl)),Wl=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var a=0;a<n;++a)r._data[a]=t();return r}Z(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},Q(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(Hl)),jl=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=n,i}Z(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(Hl));e("memop",Object.freeze({__proto__:null,Pool:Vl,RecyclePool:Wl,CachedArray:jl}));var Xl=tt.fastRemoveAt;function ql(){}var Yl=function(){function e(){this.callback=ql,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||ql,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=ql,this.once=!1},t.check=function(){return!(this.target instanceof _l&&!pl(this.target,!0))},e}(),Kl=new Vl((function(){return new Yl}),32),Ql=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),Kl.free(n),Xl(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),Kl.free(n),Xl(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Xl(this.callbackInfos,e),Kl.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),Kl.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Xl(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),Jl=new Vl((function(){return new Ql}),16),Zl=function(){function e(){this._callbackTable=Ie(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=Jl.alloc());var a=Kl.alloc();a.set(t,n,i),r.callbackInfos.push(a)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var a=0;a<r.length;++a)if(r[a])return!0;return!1}return r.length>0}for(var o=0;o<r.length;++o){var s=r[o];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),Jl.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var a=r.callbackInfos,o=0;o<a.length;++o){var s=a[o];s&&s.target===e&&r.cancel(o)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var a=r.callbackInfos;if(t)for(var o=0;o<a.length;++o){var s=a[o];if(s&&s.callback===t&&s.target===n){r.cancel(o);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,a){var o=this._callbackTable&&this._callbackTable[e];if(o){var s=!o.isInvoking;o.isInvoking=!0;for(var c=o.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var f=h.callback,_=h.target;h.once&&this.off(e,f,_),h.check()?_?f.call(_,t,n,i,r,a):f(t,n,i,r,a):this.off(e,f,_)}}s&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),Jl.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function $l(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=Ie(!0),t}Z(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=Zl.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var a=i[r];if(!(a in t.prototype)){var o=Object.getOwnPropertyDescriptor(n,a);o&&Object.defineProperty(t.prototype,a,o)}}return t}var eu,tu,nu,iu,ru,au,ou=e("EventTarget",$l((function(){})));l.EventTarget=ou,function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(eu||(eu={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(tu||(tu={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(nu||(nu={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(iu||(iu={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(ru||(ru={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(au||(au={}));var su,cu,lu,uu,hu=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,a=window.navigator,o=a.userAgent.toLowerCase();null===(t=a.getBattery)||void 0===t||t.call(a).then((function(e){i._battery=e})),i.networkType=nu.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(o),i.platform=i.isMobile?ru.MOBILE_BROWSER:ru.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=a.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||a.browserLanguage)?s.split("-")[0]:tu.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,f=/android\s*(\d+(?:\.\d+)*)/i.exec(o)||/android\s*(\d+(?:\.\d+)*)/i.exec(a.platform);f&&(c=!0,u=f[1]||"",h=parseInt(u)||0),(f=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(o))?(l=!0,u=f[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(a.platform)||"MacIntel"===a.platform&&a.maxTouchPoints&&a.maxTouchPoints>1)&&(l=!0,u="",h=0);var _=iu.UNKNOWN;-1!==a.appVersion.indexOf("Win")?_=iu.WINDOWS:l?_=iu.IOS:-1!==a.appVersion.indexOf("Mac")?_=iu.OSX:-1!==a.appVersion.indexOf("X11")&&-1===a.appVersion.indexOf("Linux")?_=iu.LINUX:c?_=iu.ANDROID:-1===a.appVersion.indexOf("Linux")&&-1===o.indexOf("ubuntu")||(_=iu.LINUX),i.os=_,i.osVersion=u,i.osMainVersion=h,i.browserType=eu.UNKNOWN;var d=/wechat|weixin|micromessenger/i.exec(o)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(o)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(o)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(o),p=d?d[0].toLowerCase():iu.UNKNOWN;("safari"===p&&c||"qq"===p&&/android.*applewebkit/i.test(o))&&(p=eu.ANDROID);var m={micromessenger:eu.WECHAT,wechat:eu.WECHAT,weixin:eu.WECHAT,trident:eu.IE,edge:eu.EDGE,"360 aphone":eu.BROWSER_360,mxbrowser:eu.MAXTHON,"opr/":eu.OPERA,ubrowser:eu.UC,huaweibrowser:eu.HUAWEI};i.browserType=m[p]||p,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(o);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(o)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var S=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){S=!0,null==e||e.close()})).catch((function(){})));var x=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,E=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[au.WEBP]=g,n[au.IMAGE_BITMAP]=S,n[au.WEB_VIEW]=!0,n[au.VIDEO_PLAYER]=!0,n[au.SAFE_AREA]=!1,n[au.INPUT_TOUCH]=x,n[au.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[au.EVENT_MOUSE]=E,n[au.EVENT_TOUCH]=x||E,n[au.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}Z(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,a,o){n&&(n=!1,t.emit("show",e,i,r,a,o))};if(e)for(var a=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],o=0;o<a.length;o++)document.addEventListener(a[o],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(ou)),fu=/(\.[^\.\/\?\\]*)(\?.*)?$/,_u=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,du=/[^\.\/]+\/\.\.\//;function pu(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,a=n;r<a.length;r++){var o=a[r];e=(e+(""===e?"":"/")+o).replace(/(\/|\\\\)$/,"")}return e}function mu(e){var t=fu.exec(e);return t?t[1]:""}function vu(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function gu(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function yu(e){var t=_u.exec(e);return t?t[2]:""}function Su(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function xu(e,t,n){if(0===t.indexOf("."))return Su(e,t);var i=e.indexOf("?"),r="",a=n?mu(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+a+r}function Eu(e){var t=e=String(e);do{t=e,e=e.replace(du,"")}while(t.length!==e.length);return e}function Tu(e){return e.replace(/[\/\\]$/,"")}function Cu(){return hu.os===iu.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:pu,extname:mu,mainFileName:vu,basename:gu,dirname:yu,changeExtname:Su,changeBasename:xu,_normalize:Eu,stripSep:Tu,getSeperator:Cu}));var Au,bu,Iu,wu=e("Asset",Tc("cc.Asset")((uu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,se(t,"_native",lu,re(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(re(t),"_uuid",{value:"",writable:!0}),t}Z(t,e),t.deserialize=function(e){return l.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&l.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return T(F(12101,this._uuid)),e.prototype.destroy.call(this)},Q(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=Fl(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=Fl(this._uuid,{__nativeName__:e,nativeExt:mu(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}($l(_l)),lu=ce((cu=uu).prototype,"_native",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ce(cu.prototype,"_nativeAsset",[Ic],Object.getOwnPropertyDescriptor(cu.prototype,"_nativeAsset"),cu.prototype),su=cu))||su);wu.prototype.createNode=null,l.Asset=wu;var Pu=e("Script",Tc("cc.Script")(Au=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(wu))||Au);l._Script=Pu;var Ru=e("JavaScript",Tc("cc.JavaScript")(bu=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(Pu))||bu);l._JavaScript=Ru;var Du,Ou,Nu,Mu,Lu,Fu,Bu,zu,Uu,ku,Gu,Hu=e("TypeScript",Tc("cc.TypeScript")(Iu=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(Pu))||Iu);l._TypeScript=Hu;var Vu,Wu,ju,Xu,qu=new pe("Comp"),Yu=_l.Flags.IsOnLoadCalled,Ku=e("Component",(Du=Tc("cc.Component"),Ou=jc(),Nu=al(Pu),Mu=Xc(),Du((Gu=ku=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"node",Bu,re(t)),se(t,"_enabled",zu,re(t)),se(t,"__prefab",Uu,re(t)),t._sceneGetter=null,t._id=qu.getNewId(),t}Z(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&l.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),l.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=l.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=l.macro.REPEAT_FOREVER),void 0===i&&(i=0),L(e,1619),L((t=t||0)>=0,1620),n=Number.isNaN(n)?l.macro.REPEAT_FOREVER:n,i=i||0;var r=l.director.getScheduler(),a=r.isTargetPaused(this);r.schedule(e,this,t,n,i,a)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&l.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){l.director.getScheduler().unscheduleAllForTarget(this)},Q(t,[{key:"name",get:function(){if(this._name)return this._name;var e=we(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=l.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Yu}}]),t}(_l),ku.system=null,ce((Fu=Gu).prototype,"__scriptAsset",[Ou,Nu,Mu,el],Object.getOwnPropertyDescriptor(Fu.prototype,"__scriptAsset"),Fu.prototype),Bu=ce(Fu.prototype,"node",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zu=ce(Fu.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Uu=ce(Fu.prototype,"__prefab",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lu=Fu))||Lu)),Qu=Ku.prototype;Qu.update=null,Qu.lateUpdate=null,Qu.__preload=null,Qu.onLoad=null,Qu.start=null,Qu.onEnable=null,Qu.onDisable=null,Qu.onDestroy=null,Qu.onFocusInEditor=null,Qu.onLostFocusInEditor=null,Qu.resetInEditor=null,Qu._getLocalBounds=null,Qu.onRestore=null,Ku._requireComponent=null,Ku._executionOrder=0,Te(Ku,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),l.Component=Ku;var Ju,Zu=e("MissingScript",Tc("cc.MissingScript")(Vu=Uc()((Xu=function(e){function t(){var t;return se(t=e.call(this)||this,"_$erialized",ju,re(t)),t}return Z(t,e),t.safeFindClass=function(e){var t=Je(e);if(t)return t;l.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){R(4600,this.node.name)},t}(Ku),ju=ce((Wu=Xu).prototype,"_$erialized",[Dc,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vu=Wu))||Vu)||Vu);l._MissingScript=Zu;try{var $u=Zu.__values__;0!==$u.length&&"_$erialized"===$u[$u.length-1]||(x("The '_$erialized' prop in MissingScript is missing. Please contact jare."),x("    Error props: ['"+$u+"']"))}catch(Ka){x("Error when checking MissingScript 5, "+Ka)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(Ju||(Ju={}));var eh,th={auto:Ju.AUTO,landscape:Ju.LANDSCAPE,portrait:Ju.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(eh||(eh={}));var nh=new(function(e){function t(){var t,n,i,r,a,o;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new ti(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=Ju.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(a=r.parentNode)||void 0===a||a.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(o=s[c],void 0!==document[o[1]]){for(var l=0;l<o.length;l++)t._fn[s[0][l]]=o[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}Z(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=th[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===eh.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===eh.Fullscreen?document[this._fn.fullscreenElement]:e===eh.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=hu.isMobile&&(t&&e===Ju.PORTRAIT||!t&&e===Ju.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void R(9201);var e,t,n=l.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,a=i.clientHeight,o=n.width,s=n.height,c=r/o,u=a/s,h=this._gameContainer.style;c<u?(e=r,t=s*c):(e=o*u,t=a),h.width=e+"px",h.height=t+"px"}else{var f=this._gameContainer.style;f.width="100%",f.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else R(9201)},Q(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===eh.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):R(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new ti(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new ti(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(R(9201),new ti(0,0));var e,t,n;switch(this._windowType){case eh.SubFrame:return this._gameFrame?new ti(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(R(9201),new ti(0,0));case eh.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new ti(t,n);case eh.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new ti(t,n);case eh.Unknown:default:return new ti(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?eh.Fullscreen:this._gameFrame?this._exactFitScreen?eh.BrowserWindow:eh.SubFrame:(R(9201),eh.Unknown)}}]),t}(ou)),ih=function(){function e(){}var t=e.prototype;return t._init=function(e){nh.init(e,(function(){var e,t=l.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=nh.resolutionScale:R(1220)}))},t.fullScreen=function(){return nh.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&R(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),nh.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return nh.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},Q(e,[{key:"devicePixelRatio",get:function(){return nh.devicePixelRatio}},{key:"windowSize",get:function(){return nh.windowSize},set:function(e){nh.windowSize=e}},{key:"resolution",get:function(){return nh.resolution}},{key:"supportsFullScreen",get:function(){return nh.supportFullScreen}}]),e}(),rh=e("screen",new ih);l.screen=rh;var ah=e("sys",{Feature:au,hasFeature:function(e){return hu.hasFeature(e)},NetworkType:nu,Language:tu,OS:iu,Platform:ru,BrowserType:eu,isNative:hu.isNative,isBrowser:hu.isBrowser,isMobile:hu.isMobile,isLittleEndian:hu.isLittleEndian,platform:hu.platform,language:hu.language,languageCode:hu.nativeLanguage,os:hu.os,osVersion:hu.osVersion,osMainVersion:hu.osMainVersion,browserType:hu.browserType,browserVersion:hu.browserVersion,windowPixelResolution:rh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:hu.hasFeature(au.WEBP),imageBitmap:hu.hasFeature(au.IMAGE_BITMAP),touches:hu.hasFeature(au.INPUT_TOUCH),mouse:hu.hasFeature(au.EVENT_MOUSE),keyboard:hu.hasFeature(au.EVENT_KEYBOARD),accelerometer:hu.hasFeature(au.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return hu.networkType},getBatteryLevel:function(){return hu.getBatteryLevel()},garbageCollect:function(){hu.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",y(e+="Using "+(l.game.renderType===l.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){hu.openURL(e)},now:function(){return hu.now()},restartVM:function(){hu.restartJSVM()},getSafeAreaRect:function(){var e=l.view,t=nh.safeAreaEdge,n=nh.windowSize,i=new Yn(t.left,t.bottom),r=new Yn(n.width-t.right,n.height-t.top);e._convertToUISpace(i),e._convertToUISpace(r);var a=i.x,o=i.y,s=r.x-i.x,c=r.y-i.y;return new ii(a,o,s,c)}});!function(){try{var e=ah.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){R(5200)};ah.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}ah.__isWebIOS14OrIPadOS14Env=(ah.os===iu.IOS||ah.os===iu.OSX)&&hu.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),l.sys=ah;var oh=e("serializeTag",Symbol("[[Serialize]]")),sh=e("deserializeTag",Symbol("[[Deserialize]]")),ch=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return Q(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function lh(e){var t=e;return{chunks:t.chunks,document:t.document}}function uh(e){if(e.length<16)throw new hh(F(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new hh(F(13100));var n=t.getUint32(4,!0);if(1!==n)throw new hh(F(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new hh(F(13102));var i=12,r=t.getUint32(i,!0);i+=4;var a=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var o,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(F(13104))}(a);try{o=JSON.parse(s)}catch(e){throw new hh(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new hh(F(13102));return new ch(o,c)}var hh=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(ie(Error));function fh(e,t,n,i,r){if(t instanceof l.ValueType){r||e.push("if(prop){");var a=we(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+a+");"),r||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},Q(e,[{key:"byteLength",get:function(){return this._length}}])}(),l.internal.parseCCONJson=lh,l.internal.decodeCCONBinary=uh,l.internal.CCON=ch;var _h="$_$default",dh="$_$formerlySerializedAs",ph=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return Z(t,e),t.prototype.get=function(e,t,n,i,r){var a=this._get();return a?(a.reset(e,t,n,i,r),a):new mh(e,t,n,i,r)},t}(et),mh=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof ch?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,a=e.__type__,o=this._classFinder(a,e,n,i);if(!o)return this._classFinder===Je&&this._reportMissingClass(a),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(o);return this._deserializeInto(e,s,o),s},t._deserializeInto=function(e,t,n,i){void 0===i&&(i=!1),i||!t[sh]?t._deserialize?t._deserialize(e.content,this):l.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=ke(n);r&&i._deserializeInto(e,t,r)}};t[sh](r,this._context)},t._deserializeFireClass=function(e,t,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(e,t){for(var n=wt(t),i=t.__values__,r=["var prop;"],a=ut.test($e(t)),o=0;o<i.length;o++){var s=i[o],c=void 0,u=void 0;Zt.IDENTIFIER_RE.test(s)?(u='"'+s+'"',c="."+s):c="["+(u=Zt.escapeForJS(s))+"]";var h=c;if(n[s+dh]){var f=n[s+dh];h=Zt.IDENTIFIER_RE.test(f)?"."+f:"["+Zt.escapeForJS(f)+"]"}r.push("prop=d"+h+";"),r.push('if(typeof prop!=="undefined"){');var _=Zt.getDefault(n[s+_h]);if(a){var d=void 0,p=n[s+"$_$type"];if(void 0===_&&p)d=p instanceof Rt;else{var m=typeof _;d="string"===m||"number"===m||"boolean"===m}d?r.push("o"+c+"=prop;"):fh(r,_,c,u,!0)}else r.push('if(typeof prop!=="object"){o'+c+"=prop;}else{"),fh(r,_,c,u,!1),r.push("}");r.push("}")}return(l.js.isChildClassOf(t,l._BaseNode)||l.js.isChildClassOf(t,l.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===Zu){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(x("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),x("    Error props: ['"+r+"']. Please contact jare."));var a=i;i=function(e,t,n,i){a(e,t,n,i),t._$erialized||x("Unable to stash previously serialized data. "+JSON.stringify(n))}}}catch(e){x("Error when checking MissingScript 6, "+e)}Te(n,"__deserialize__",i,!0)}i(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var a,o=this._serializedData[i];e[n]=this._deserializeObject(o,i,void 0,n),null===(a=this._onDereferenced)||void 0===a||a.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===l.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===l.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==l.Color){if(n===l.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=wt(n),r=n.__values__,a=0;a<r.length;a++){var o=r[a],s=t[o];void 0!==s||t.hasOwnProperty(o)||(s=Zt.getDefault(i[o+_h])),"object"!=typeof s?e[o]=s:s?this._deserializeAndAssignField(e,s,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}},e}();mh.pool=new ph;var vh=[Yn,Pn,Zn,Fn,In,ti,ii,Wn];function gh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var yh=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},gh,gh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){Wn.fromArray(e,t,1)}],Sh=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function xh(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),a=i[1],o=i[2],s=n[n.length-1],c=1;c<s;++c)r[a[n[c]]]=t[c];for(;c<t.length;++c){var l=a[n[c]],u=i[n[c]+o];(0,Ih[u])(e,r,l,t[c])}return r}function Eh(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):O(5303,we(t)),i}function Th(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function Ch(e){return function(t,n,i,r){n[i]=r;for(var a=0;a<r.length;++a)e(t,r,a,r[a])}}function Ah(e,t,n,i){t[n]=null,e[8][i]=t}function bh(e,t,n,i){t[n]=xh(e,i)}Sh.pool=new et((function(e){e.reset()}),5),Sh.pool.get=function(){return this._get()||new Sh};var Ih=new Array(13);function wh(e,t,n){return e||n(t),Object}function Ph(e,t,n,i,r,a,o){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||wh(a,i,o);return t[n]=r,new r}}(n,i,t));s=wh(a,t,o)}n[i]=s}function Rh(e,t,n,i){for(var r=n||Je,a=e[3],o=0;o<a.length;++o){var s=a[o];"string"!=typeof s?Ph(r,s[0],s,0,t,n,i):Ph(r,s,a,o,t,n,i)}}function Dh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function Oh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,r=!t;if(t=t||Sh.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Nh}return!1}(e)){t.init(e),n=n||{};var a,o=e[0],s=!1;if("object"==typeof o&&(s=o.preprocessed,o=o.version),o<1)throw new Error(F(5304,o));n._version=o,n.result=t,e[0]=n,s||(Rh(e,!1,n.classFinder,null!==(a=n.reportMissingClass)&&void 0!==a?a:Oh.reportMissingClass),Dh(e)),l.game._isCloning=!0;var c=e[5],u=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],a=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--a);for(var o=0;o<a;++o)t[o]=xh(e,t[o]);for(var s=e[3],c=0;c<i;++c,++o){var l=n[c],u=t[o];if(l>=0){var h=s[l];t[o]=Eh(e,h,u)}else(0,Ih[l=~l])(e,t,o,u)}return r}(e);l.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,a=3*e[i];r<a;r+=3){var o=e[r],s=t[e[r+2]],c=e[r+1];c>=0?o[n[c]]=s:o[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],c,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],a=e[9],o=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=a[s];"number"==typeof l&&(l=l>=0?n[l]:~l,a[s]=l);var u=o[s];"number"==typeof u&&(o[s]=i[u])}}(e),i=c[u]}else i=function(e,t,n){var i,r=(n=n||{}).classFinder||Je,a=n.createAssetRefs||ah.platform===ru.EDITOR_CORE,o=n.customEnv,s=n.ignoreEditorOnly,c=null!==(i=n.reportMissingClass)&&void 0!==i?i:l.deserialize.reportMissingClass;t.init();var u=mh.pool.get(t,r,c,o,s);l.game._isCloning=!0;var h=u.deserialize(e);return l.game._isCloning=!1,mh.pool.put(u),a&&t.assignAssetsBy(EditorExtends.serialize.asAsset),h}(e,t,n);return r&&Sh.pool.put(t),i}Ih[0]=function(e,t,n,i){t[n]=i},Ih[1]=Th,Ih[2]=Ch(Th),Ih[3]=Ch(Ah),Ih[4]=bh,Ih[5]=function(e,t,n,i){yh[i[0]](t[n],i)},Ih[6]=Ah,Ih[7]=function(e,t,n,i){t[n].set(i)},Ih[8]=function(e,t,n,i){var r=new vh[i[0]];yh[i[0]](r,i),t[n]=r},Ih[9]=Ch(bh),Ih[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=Eh(e,r,i[1])},Ih[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var a=1;a<i.length;a+=3){var o=i[a],s=i[a+1],c=i[a+2];(0,Ih[s])(e,r,o,c)}},Ih[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var a=0;a<r.length;++a){var o=r[a],s=i[a+1];0!==s&&(0,Ih[s])(e,r,a,o)}},Oh.Details=Sh,Oh.reportMissingClass=function(e){O(5302,e)};var Nh=function(e){this.preprocessed=!0,this.version=e};function Mh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}l.deserialize=Oh;var Lh,Fh,Bh,zh,Uh,kh,Gh,Hh,Vh,Wh,jh,Xh=_l.Flags.Destroyed,qh=_l.Flags.PersistentMask,Yh=[];function Kh(e){var t;if(e instanceof _l){if(e._instantiate)return l.game._isCloning=!0,t=e._instantiate(null,!0),l.game._isCloning=!1,t;if(e instanceof l.Asset)throw new TypeError(F(6903))}return l.game._isCloning=!0,t=Qh(e),l.game._isCloning=!1,t}function Qh(e,t){var n;Jh(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=Yh.length;i<r;++i)Yh[i]._iN$t=null;return Yh.length=0,n}function Jh(e,t,n){nt.value(e,"_iN$t",t,!0),Yh.push(e);var i=e.constructor;if($t(i))!function(e,t,n,i){for(var r=e.__values__,a=0;a<r.length;a++){var o=r[a],s=t[o];if("object"==typeof s&&s){var c=n[o];c instanceof ct&&c.constructor===s.constructor?c.set(s):n[o]=s._iN$t||Zh(s,i)}else n[o]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var a=e[r];if("object"==typeof a&&a){if(a===t)continue;t[r]=a._iN$t||Zh(a,n)}else t[r]=a}e instanceof _l&&(t._objFlags&=qh)}function Zh(e,t){if(e instanceof ct)return e.clone();if(e instanceof l.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,Yh.push(e);for(var r=0;r<i;++r)n[r]=e[r];return n}if(Array.isArray(e)){var a=e.length;n=new Array(a),e._iN$t=n,Yh.push(e);for(var o=0;o<a;++o){var s=e[o];n[o]="object"==typeof s&&s?s._iN$t||Zh(s,t):s}return n}if(e._objFlags&Xh)return null;var c=e.constructor;if($t(c)){if(t)if(t instanceof l.Component){if(e instanceof l._BaseNode||e instanceof l.Component)return e}else if(t instanceof l._BaseNode)if(e instanceof l._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof l.Component&&e.node&&!e.node.isChildOf(t))return e;n=new c}else if(c===Object)n={};else{if(c)return e;n=Object.create(null)}return Jh(e,n,t),n}function $h(e,t){return(t<<3)+e}function ef(e){return nf[e]}function tf(e){switch(e){case Wh.Uint8:return Uint8Array;case Wh.Uint16:return Uint16Array;case Wh.Uint32:return Uint32Array;case Wh.Int8:return Int8Array;case Wh.Int16:return Int16Array;case Wh.Int32:return Int32Array;case Wh.Float32:return Float32Array;case Wh.Float64:return Float64Array}}Kh._clone=Qh,l.instantiate=Kh,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Wh||(Wh={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(jh||(jh={})),e("CompactValueTypeArray",Tc("cc.CompactValueTypeArray")((Hh=Gh=function(){function e(){se(this,"_byteOffset",Bh,this),se(this,"_unitCount",zh,this),se(this,"_unitElement",Uh,this),se(this,"_length",kh,this)}return e.lengthFor=function(e,t,n){return ef(t).requiredUnits*e.length*tf(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,a,o){for(var s=ef(n),c=tf(i),l=s.requiredUnits*t.length,u=new c(r,a,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var f=new e;return f._unitElement=$h(i,n),f._byteOffset=o,f._unitCount=l,f._length=t.length,f},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=ef(n.elementType),a=new(tf(i))(e,this._byteOffset,this._unitCount),o=new Array(this._length),s=0;s<this._length;++s)o[s]=r.decompress(a,s);return o},e}(),Gh.StorageUnit=Wh,Gh.ElementType=jh,Bh=ce((Fh=Hh).prototype,"_byteOffset",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zh=ce(Fh.prototype,"_unitCount",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uh=ce(Fh.prototype,"_unitElement",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $h(Wh.Uint8,jh.Scalar)}}),kh=ce(Fh.prototype,"_length",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lh=Fh))||Lh);var nf=((Vh={})[jh.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},Vh[jh.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new Pn(e[2*t],e[2*t+1])}},Vh[jh.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new Pn(e[3*t],e[3*t+1],e[3*t+2])}},Vh[jh.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Zn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Vh[jh.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Fn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Vh[jh.Mat4]={requiredUnits:16,compress:function(e,t,n){Wn.toArray(e,n,16*t)},decompress:function(e,t){return Wn.fromArray(new Wn,e,16*t)}},Vh);function rf(){return 0}function af(e){return e}function of(e){return e*e}function sf(e){return e*(2-e)}function cf(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function lf(e){return e*e*e}function uf(e){return--e*e*e+1}function hf(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function ff(e){return e*e*e*e}function _f(e){return 1- --e*e*e*e}function df(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function pf(e){return e*e*e*e*e}function mf(e){return--e*e*e*e*e+1}function vf(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function gf(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function yf(e){return Math.sin(e*Math.PI/2)}function Sf(e){return.5*(1-Math.cos(Math.PI*e))}function xf(e){return 0===e?0:Math.pow(1024,e-1)}function Ef(e){return 1===e?1:1-Math.pow(2,-10*e)}function Tf(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function Cf(e){return 1-Math.sqrt(1-e*e)}function Af(e){return Math.sqrt(1- --e*e)}function bf(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function If(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function wf(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function Pf(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function Rf(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function Df(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function Of(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function Nf(e){return 1-Mf(1-e)}function Mf(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function Lf(e){return e<.5?.5*Nf(2*e):.5*Mf(2*e-1)+.5}function Ff(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function Bf(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}l._decorator=ul;var zf=Yf(of,sf),Uf=Yf(lf,uf),kf=Yf(ff,_f),Gf=Yf(pf,mf),Hf=Yf(gf,yf),Vf=Yf(xf,Ef),Wf=Yf(Cf,Af),jf=Yf(If,wf),Xf=Yf(Rf,Df),qf=Yf(Nf,Mf);function Yf(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var Kf,Qf,Jf=Object.freeze({__proto__:null,constant:rf,linear:af,quadIn:of,quadOut:sf,quadInOut:cf,cubicIn:lf,cubicOut:uf,cubicInOut:hf,quartIn:ff,quartOut:_f,quartInOut:df,quintIn:pf,quintOut:mf,quintInOut:vf,sineIn:gf,sineOut:yf,sineInOut:Sf,expoIn:xf,expoOut:Ef,expoInOut:Tf,circIn:Cf,circOut:Af,circInOut:bf,elasticIn:If,elasticOut:wf,elasticInOut:Pf,backIn:Rf,backOut:Df,backInOut:Of,bounceIn:Nf,bounceOut:Mf,bounceInOut:Lf,smooth:Ff,fade:Bf,quadOutIn:zf,cubicOutIn:Uf,quartOutIn:kf,quintOutIn:Gf,sineOutIn:Hf,expoOutIn:Vf,circOutIn:Wf,elasticOutIn:jf,backOutIn:Xf,bounceOutIn:qf});e("easing",Jf),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(Qf||(Qf={}));var Zf,$f=((Kf={})[Qf.CONSTANT]=rf,Kf[Qf.LINEAR]=af,Kf[Qf.QUAD_IN]=of,Kf[Qf.QUAD_OUT]=sf,Kf[Qf.QUAD_IN_OUT]=cf,Kf[Qf.QUAD_OUT_IN]=zf,Kf[Qf.CUBIC_IN]=lf,Kf[Qf.CUBIC_OUT]=uf,Kf[Qf.CUBIC_IN_OUT]=hf,Kf[Qf.CUBIC_OUT_IN]=Uf,Kf[Qf.QUART_IN]=ff,Kf[Qf.QUART_OUT]=_f,Kf[Qf.QUART_IN_OUT]=df,Kf[Qf.QUART_OUT_IN]=kf,Kf[Qf.QUINT_IN]=pf,Kf[Qf.QUINT_OUT]=mf,Kf[Qf.QUINT_IN_OUT]=vf,Kf[Qf.QUINT_OUT_IN]=Gf,Kf[Qf.SINE_IN]=gf,Kf[Qf.SINE_OUT]=yf,Kf[Qf.SINE_IN_OUT]=Sf,Kf[Qf.SINE_OUT_IN]=Hf,Kf[Qf.EXPO_IN]=xf,Kf[Qf.EXPO_OUT]=Ef,Kf[Qf.EXPO_IN_OUT]=Tf,Kf[Qf.EXPO_OUT_IN]=Vf,Kf[Qf.CIRC_IN]=Cf,Kf[Qf.CIRC_OUT]=Af,Kf[Qf.CIRC_IN_OUT]=bf,Kf[Qf.CIRC_OUT_IN]=Wf,Kf[Qf.ELASTIC_IN]=If,Kf[Qf.ELASTIC_OUT]=wf,Kf[Qf.ELASTIC_IN_OUT]=Pf,Kf[Qf.ELASTIC_OUT_IN]=jf,Kf[Qf.BACK_IN]=Rf,Kf[Qf.BACK_OUT]=Df,Kf[Qf.BACK_IN_OUT]=Of,Kf[Qf.BACK_OUT_IN]=Xf,Kf[Qf.BOUNCE_IN]=Nf,Kf[Qf.BOUNCE_OUT]=Mf,Kf[Qf.BOUNCE_IN_OUT]=Lf,Kf[Qf.BOUNCE_OUT_IN]=qf,Kf[Qf.SMOOTH]=Ff,Kf[Qf.FADE]=Bf,Kf);function e_(e){return $f[e]}i(255),i(65280);var t_,n_,i_,r_=uc.LINEAR<<0|fc.NONE<<8|Qf.LINEAR<<16,a_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t._flags=r_,t}return Z(t,e),Q(t,[{key:"interpolationMode",get:function(){return(255&this._flags)>>0},set:function(e){this._flags&=-256,this._flags|=e<<0}},{key:"tangentWeightMode",get:function(){return(65280&this._flags)>>8},set:function(e){this._flags&=-65281,this._flags|=e<<8}},{key:"easingMethod",get:function(){return(16711680&this._flags)>>16},set:function(e){this._flags&=-16711681,this._flags|=e<<16}}]),t}(ll);function o_(e){var t=new a_;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,a=e.rightTangent,o=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[cl];t.value=null!=r?r:t.value,t.rightTangent=null!=a?a:t.rightTangent,t.rightTangentWeight=null!=o?o:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[cl]=u)}return t}Zt.fastDefine("cc.RealKeyframeValue",a_,((Zf={interpolationMode:uc.LINEAR,tangentWeightMode:fc.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:Qf.LINEAR})[cl]=void 0,Zf)),Zt.Attr.setClassAttr(a_,cl,"editorOnly",!0),(t_=a_,null!==(i_=(n_=t_)[Rc])&&void 0!==i_?i_:n_[Rc]={}).uniquelyReferenced=!0;var s_,c_=e("RealCurve",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).preExtrapolation=hc.CLAMP,t.postExtrapolation=hc.CLAMP,t}Z(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],a=t[i-1];if(e<r){var o=this.preExtrapolation,s=n[0];if(o===hc.CLAMP||i<2)return s.value;switch(o){case hc.LINEAR:return C_(r,n[0].value,t[1],n[1].value,e);case hc.LOOP:e=E_(e,r,a);break;case hc.PING_PONG:e=T_(e,r,a);break;default:return s.value}}else if(e>a){var c=this.postExtrapolation,l=n[i-1];if(c===hc.CLAMP||i<2)return l.value;switch(c){case hc.LINEAR:return C_(a,l.value,t[i-2],n[i-2].value,e);case hc.LOOP:e=E_(e,r,a);break;case hc.PING_PONG:e=T_(e,r,a);break;default:return l.value}}var u=lc(t,e);if(u>=0)return n[u].value;var h=~u,f=h-1,_=t[f],d=n[f],p=t[h];return function(e,t,n,i,r){var a=n-e;switch(t.interpolationMode){default:case uc.CONSTANT:return t.value;case uc.LINEAR:var o=t.easingMethod===Qf.LINEAR?r:e_(t.easingMethod)(r);return un(t.value,i.value,o);case uc.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&fc.RIGHT),h=i.leftTangent,f=i.leftTangentWeight,_=0!=(i.tangentWeightMode&fc.LEFT);if(u||_){var d=0;if(u)d=l;else{var p=a,m=a*c;d=Math.sqrt(p*p+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*d+e,y=Math.sin(v)*d+t.value,S=0;if(_)S=f;else{var x=a,E=a*h;S=Math.sqrt(x*x+E*E)*s}var T=Math.atan(h),C=(g-e)/a,A=(-Math.cos(T)*S+n-e)/a,b=y,I=-Math.sin(T)*S+i.value,w=[0,0,0],P=function(e,t,n,i,r){var a=n/i,o=t/i,s=a*a,c=1/3*(-1/3*s+o),l=.5*(2/27*a*s-1/3*a*o+e/i),u=c*c*c,h=l*l+u,f=0;if(dc(h)){if(dc(l))return r[0]=0,1;var _=Math.cbrt(-l);return r[0]=2*_,r[1]=-_,2}if(h<0){var d=1/3*Math.acos(-l/Math.sqrt(-u)),p=2*Math.sqrt(-c);r[0]=p*Math.cos(d),r[1]=-p*Math.cos(d+Math.PI/3),r[2]=-p*Math.cos(d-Math.PI/3),f=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,f=1}for(var y=1/3*a,S=0;S<f;++S)r[S]-=y;return f}(0-r,3*C,3*A-6*C,3*(C-A)+1,w),R=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var a=e[r];a>=0&&a<=1&&a>i&&(i=a)}i===-1/0&&(i=0)}return i}(w,P,r);return A_(t.value,b,I,i.value,R)}var D=t.value+s*c*a,O=i.value-s*h*a;return A_(t.value,D,O,i.value,r)}}(_,d,p,n[h],(e-_)/(p-_))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,o_(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return o_(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return o_(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return sn(n.value,t,e)}))},n[oh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,a=new DataView(new ArrayBuffer(0+l_+l_+u_+h_*r+y_*r)),o=0;a.setUint8(o,this.preExtrapolation),o+=l_,a.setUint8(o,this.postExtrapolation),o+=l_,a.setUint32(o,r,!0),o+=u_,n.forEach((function(e,t){return a.setFloat32(o+h_*t,e,!0)})),o+=h_*r;for(var s,c=oe(i);!(s=c()).done;){var l=s.value;o=S_(a,l,o)}var u=new Uint8Array(a.buffer,0,o);e.writeProperty("bytes",u);var h=i.map((function(e){return e[cl]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[sh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=l_,this.postExtrapolation=i.getUint8(r),r+=l_;var a=i.getUint32(r,!0);r+=u_;var o=Array.from({length:a},(function(e,t){return i.getFloat32(r+h_*t,!0)}));r+=h_*a;for(var s=new Array(a),c=0;c<a;++c){var l=o_({});r=x_(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][cl]=e}))),this._times=o,this._values=s}else e.readThis()},t}(_c));Zt.fastDefine("cc.RealCurve",c_,{_times:[],_values:[],preExtrapolation:hc.CLAMP,postExtrapolation:hc.CLAMP}),function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(s_||(s_={}));var l_=1,u_=4,h_=4,f_=o_({}),__=f_.interpolationMode,d_=f_.tangentWeightMode,p_=f_.leftTangent,m_=f_.leftTangentWeight,v_=f_.rightTangent,g_=f_.rightTangentWeight,y_=26;function S_(e,t,n){var i=0,r=n,a=r;r+=4;var o=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,f=t.leftTangentWeight,_=t.easingMethod;return e.setFloat32(r,o,!0),r+=4,s!==__&&(i|=s_.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==d_&&(i|=s_.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==p_&&(i|=s_.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),f!==m_&&(i|=s_.LEFT_TANGENT_WEIGHT,e.setFloat32(r,f,!0),r+=4),l!==v_&&(i|=s_.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==g_&&(i|=s_.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=_<<8,e.setUint32(a,i,!0),r}function x_(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&s_.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&s_.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&s_.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&s_.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&s_.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&s_.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var a=(65280&r)>>8;return t.easingMethod=a,i}function E_(e,t,n){return t+Sn(e-t,n-t)}function T_(e,t,n){return t+xn(e-t,n-t)}function C_(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function A_(e,t,n,i,r){var a=1-r;return a*a*a*e+3*a*a*r*t+3*a*r*r*n+r*r*r*i}function b_(e,t,n,i,r){var a=1-r;return a*(a*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}l.bezier=b_;var I_,w_,P_,R_,D_,O_,N_,M_,L_,F_,B_,z_=Math.cos,U_=Math.acos,k_=Math.max,G_=2*Math.PI,H_=Math.sqrt;function V_(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function W_(e,t){var n=function(e,t){var n,i,r,a,o=t-0,s=t-e[0],c=3*o,l=3*s,u=3*(t-e[2]),h=1/(-o+l-u+(t-1)),f=1/3,_=(c-6*s+u)*h,d=_*f,p=(-c+l)*h,m=(3*p-_*_)*f,v=m*f,g=(2*_*_*_-9*_*p+o*h*27)/27,y=g/2,S=y*y+v*v*v;if(S<0){var x=-m*f,E=H_(x*x*x),T=-g/(2*E),C=U_(T<-1?-1:T>1?1:T),A=2*V_(E);return i=A*z_(C*f)-d,r=A*z_((C+G_)*f)-d,a=A*z_((C+2*G_)*f)-d,i>=0&&i<=1?r>=0&&r<=1?a>=0&&a<=1?k_(i,r,a):k_(i,r):a>=0&&a<=1?k_(i,a):i:r>=0&&r<=1?a>=0&&a<=1?k_(r,a):r:a}if(0===S)return r=-(n=y<0?V_(-y):-V_(y))-d,(i=2*n-d)>=0&&i<=1?r>=0&&r<=1?k_(i,r):i:r;var b=H_(S);return(n=V_(-y+b))-V_(y+b)-d}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}l.bezierByTime=W_,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(B_||(B_=e("QuatInterpolationMode",{})));var j_=Tc("cc.QuatKeyframeValue")(I_=Lc((P_=ce((w_=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;se(this,"interpolationMode",P_,this),se(this,"value",R_,this),se(this,"easingMethod",D_,this),this.value=n?Fn.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return B_.SLERP}}),R_=ce(w_.prototype,"value",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fn.clone(Fn.IDENTITY)}}),D_=ce(w_.prototype,"easingMethod",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qf.LINEAR}}),I_=w_))||I_)||I_;function X_(e){return new j_(e)}var q_,Y_=e("QuatCurve",Tc("cc.QuatCurve")((F_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",M_,re(t)),se(t,"postExtrapolation",L_,re(t)),t}Z(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new Fn);var i=this._times,r=this._values,a=this.postExtrapolation,o=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(o){case hc.LOOP:e=c+Sn(e-c,l-c);break;case hc.PING_PONG:e=c+xn(e-c,l-c);break;case hc.CLAMP:default:return Fn.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(a){case hc.LOOP:e=c+Sn(e-c,l-c);break;case hc.PING_PONG:e=c+xn(e-c,l-c);break;case hc.CLAMP:default:return Fn.copy(t,h.value)}}var f=lc(i,e);if(f>=0)return Fn.copy(t,r[f].value);var _=~f,d=_-1,p=i[d],m=r[d],v=i[_],g=r[_],y=(e-p)/(v-p);switch(m.interpolationMode){default:case B_.CONSTANT:return Fn.copy(t,m.value);case B_.SLERP:var S=m.easingMethod,x=S===Qf.LINEAR?y:Array.isArray(S)?W_(S,y):e_(S)(y);return Fn.slerp(t,m.value,g.value,x)}},n.addKeyFrame=function(t,n){var i=new j_(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return X_(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return X_(e[1])})))}},n[oh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var a=n.length,o=ed*(r?1:a),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?td+4*id:td)}),0),c=0,l=new DataView(new ArrayBuffer(c+=Q_+J_+Z_*a+4*$_*a+s+o+0)),u=0,h=0;r&&(h|=q_.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=Q_,l.setUint32(u,a,!0),u+=J_,n.forEach((function(e,t){return l.setFloat32(u+Z_*t,e,!0)})),u+=Z_*a,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,a=n.z,o=n.w,s=u+4*$_*t;l.setFloat32(s+0*$_,i,!0),l.setFloat32(s+1*$_,r,!0),l.setFloat32(s+2*$_,a,!0),l.setFloat32(s+3*$_,o,!0)})),u+=4*$_*a,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,nd),++u,l.setFloat32(u+0*id,t[0],!0),l.setFloat32(u+1*id,t[1],!0),l.setFloat32(u+2*id,t[2],!0),l.setFloat32(u+3*id,t[3],!0),u+=4*id):(l.setUint8(u,t),++u)}));var f=u;u+=o;var _=f;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(_,t),r||(_+=ed)}));var d=new Uint8Array(l.buffer);e.writeProperty("bytes",d)}else e.writeThis()},n[sh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,a=i.getUint32(r,!0);r+=Q_;var o=a&q_.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=J_;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+Z_*t,!0)})),l=r+=Z_*s;r+=4*$_*s;var u=Array.from({length:s},(function(e,t){var n=l+4*$_*t,a=i.getFloat32(n+0*$_,!0),o=i.getFloat32(n+1*$_,!0),s=i.getFloat32(n+2*$_,!0),c=i.getFloat32(n+3*$_,!0),u=i.getUint8(r);++r;var h=X_({value:{x:a,y:o,z:s,w:c}});return u!==nd?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*id,!0),i.getFloat32(r+1*id,!0),i.getFloat32(r+2*id,!0),i.getFloat32(r+3*id,!0)],r+=4*id),h}));if(o){var h=i.getUint8(r);++r;for(var f=0;f<s;++f)u[f].interpolationMode=h}else{for(var _=0;_<s;++_){var d=i.getUint8(r+_);u[_].interpolationMode=d}r+=s}this._times=c,this._values=u}else e.readThis()},t}(_c),M_=ce((N_=F_).prototype,"preExtrapolation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hc.CLAMP}}),L_=ce(N_.prototype,"postExtrapolation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hc.CLAMP}}),O_=N_))||O_);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(q_||(q_={}));var K_,Q_=1,J_=4,Z_=4,$_=4,ed=1,td=1,nd=255,id=4,rd=e("ObjectCurve",Tc("cc.ObjectCurve")(K_=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=cn(~t-1,0,this._values.length-1);return this._values[n]},t}(_c))||K_),ad=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Zt.fastDefine("cc.Keyframe",ad,{time:0,value:0,inTangent:0,outTangent:0});var od=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),sd=function(){function e(e){if(void 0===e&&(e=null),this.cachedKey=void 0,e instanceof c_)this._curve=e;else{var t=new c_;this._curve=t,t.preExtrapolation=hc.LOOP,t.postExtrapolation=hc.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:uc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:uc.CUBIC,value:1}],[1,{interpolationMode:uc.CUBIC,value:1}]])}this.cachedKey=new od}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:uc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,a=e<0?n.preExtrapolation:n.postExtrapolation,o=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(a){case hc.LOOP:r=Sn(e-o,s-o)+o;break;case hc.PING_PONG:r=xn(e-o,s-o)+o;break;case hc.CLAMP:default:r=cn(e,o,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),a=this._curve.getKeyframeValue(t),o=a.value,s=a.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,f=l-o,_=1/(h*h),d=s*h,p=u*h;e.coefficient[0]=(d+p-f-f)*_/h,e.coefficient[1]=(f+f+f-d-d-p)*_,e.coefficient[2]=s,e.coefficient[3]=o},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var a=0;a<3;a++){var o=r+a;if(o+1<i&&n.getKeyframeTime(o+1)>t)return o}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},Q(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new ad;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:uc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return ld(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=cd(e)}},{key:"postWrapMode",get:function(){return ld(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=cd(e)}}]),e}();function cd(e){switch(e){default:case tc.Default:case tc.Normal:case tc.Clamp:return hc.CLAMP;case tc.PingPong:return hc.PING_PONG;case tc.Loop:return hc.LOOP}}function ld(e){switch(e){default:case hc.LINEAR:case hc.CLAMP:return tc.Clamp;case hc.PING_PONG:return tc.PingPong;case hc.LOOP:return tc.Loop}}function ud(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}sd.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Zt.fastDefine("cc.AnimationCurve",sd,{_curve:null}),U(ds,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var hd=function(e){function t(){var t;return t=e.call(this)||this,ud("line","Line"),t}return Z(t,e),t}(to),fd=function(e){function t(){var t;return t=e.call(this)||this,ud("plane","Plane"),t}return Z(t,e),t}(bs),_d=function(e){function t(){var t;return t=e.call(this)||this,ud("ray","Ray"),t}return Z(t,e),t}(no),dd=function(e){function t(){var t;return t=e.call(this)||this,ud("triangle","Triangle"),t}return Z(t,e),t}(uo),pd=function(e){function t(){var t;return t=e.call(this)||this,ud("sphere","Sphere"),t}return Z(t,e),t}(lo),md=function(e){function t(){var t;return t=e.call(this)||this,ud("aabb","AABB"),t}return Z(t,e),t}(Ys),vd=function(e){function t(){var t;return t=e.call(this)||this,ud("obb","OBB"),t}return Z(t,e),t}(Zs),gd=function(e){function t(){var t;return t=e.call(this)||this,ud("capsule","Capsule"),t}return Z(t,e),t}($s),yd=function(e){function t(){var t;return t=e.call(this)||this,ud("frustum","Frustum"),t}return Z(t,e),t}(oc),Sd=Object.freeze({__proto__:null,distance:$a,enums:eo,intersect:ds,Line:to,Plane:bs,Ray:no,Triangle:uo,Sphere:lo,AABB:Ys,OBB:Zs,Capsule:$s,Frustum:oc,Keyframe:ad,AnimationCurve:sd,get ERaycastMode(){return co},line:hd,plane:fd,ray:_d,triangle:dd,sphere:pd,aabb:md,obb:vd,capsule:gd,frustum:yd});e("geometry",Sd);var xd={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Ed=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=oe(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],F(2104,t),e.Enum[t]=i,nt.value(e.Enum,String(i),t),e.BitMask[t]=i,nt.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):n(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());Ed.Enum=rt(xd),Ed.BitMask=it(J({},xd)),l.Layers=Ed;var Td,Cd,Ad="MainFlow",bd="ForwardFlow",Id="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Td||(Td={})),l.RenderPassStage=Td,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Cd||(Cd={}));var wd,Pd={bindings:[],layouts:{}},Rd={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(wd||(wd={}));var Dd,Od=wd.SAMPLER_SHADOWMAP,Nd=wd.COUNT-Od;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(Dd||(Dd={}));var Md,Ld=Dd.SAMPLER_JOINTS,Fd=Dd.STORAGE_REFLECTION-Ld,Bd=Dd.COUNT-Ld-Fd;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Md||(Md={}));var zd=new fr([Od,0,Ld],[Nd,0,Fd],[0,0,0],[0,0,0],[0,0,0],[0,0,Bd],[0,0,0],[0,2,1]),Ud=function(){};Ud.SIZE=4*(Ud.COUNT=4+(Ud.SCREEN_SIZE_OFFSET=4+(Ud.NATIVE_SIZE_OFFSET=4+(Ud.TIME_OFFSET=0)))),Ud.NAME="CCGlobal",Ud.BINDING=wd.UBO_GLOBAL,Ud.DESCRIPTOR=new Vr(Ud.BINDING,ji.UNIFORM_BUFFER,1,Ni.ALL),Ud.LAYOUT=new Cr(Md.GLOBAL,Ud.BINDING,Ud.NAME,[new Tr("cc_time",pi.FLOAT4,1),new Tr("cc_screenSize",pi.FLOAT4,1),new Tr("cc_nativeSize",pi.FLOAT4,1)],1),Pd.layouts[Ud.NAME]=Ud.LAYOUT,Pd.bindings[Ud.BINDING]=Ud.DESCRIPTOR;var kd=function(){};kd.SIZE=4*(kd.COUNT=4+(kd.VIEW_PORT_OFFSET=4+(kd.NEAR_FAR_OFFSET=4+(kd.GLOBAL_FOG_ADD_OFFSET=4+(kd.GLOBAL_FOG_BASE_OFFSET=4+(kd.GLOBAL_FOG_COLOR_OFFSET=4+(kd.AMBIENT_GROUND_OFFSET=4+(kd.AMBIENT_SKY_OFFSET=4+(kd.MAIN_LIT_COLOR_OFFSET=4+(kd.MAIN_LIT_DIR_OFFSET=4+(kd.EXPOSURE_OFFSET=4+(kd.SCREEN_SCALE_OFFSET=4+(kd.CAMERA_POS_OFFSET=16+(kd.MAT_VIEW_PROJ_INV_OFFSET=16+(kd.MAT_VIEW_PROJ_OFFSET=16+(kd.MAT_PROJ_INV_OFFSET=16+(kd.MAT_PROJ_OFFSET=16+(kd.MAT_VIEW_INV_OFFSET=16+(kd.MAT_VIEW_OFFSET=0))))))))))))))))))),kd.NAME="CCCamera",kd.BINDING=wd.UBO_CAMERA,kd.DESCRIPTOR=new Vr(kd.BINDING,ji.UNIFORM_BUFFER,1,Ni.ALL),kd.LAYOUT=new Cr(Md.GLOBAL,kd.BINDING,kd.NAME,[new Tr("cc_matView",pi.MAT4,1),new Tr("cc_matViewInv",pi.MAT4,1),new Tr("cc_matProj",pi.MAT4,1),new Tr("cc_matProjInv",pi.MAT4,1),new Tr("cc_matViewProj",pi.MAT4,1),new Tr("cc_matViewProjInv",pi.MAT4,1),new Tr("cc_cameraPos",pi.FLOAT4,1),new Tr("cc_screenScale",pi.FLOAT4,1),new Tr("cc_exposure",pi.FLOAT4,1),new Tr("cc_mainLitDir",pi.FLOAT4,1),new Tr("cc_mainLitColor",pi.FLOAT4,1),new Tr("cc_ambientSky",pi.FLOAT4,1),new Tr("cc_ambientGround",pi.FLOAT4,1),new Tr("cc_fogColor",pi.FLOAT4,1),new Tr("cc_fogBase",pi.FLOAT4,1),new Tr("cc_fogAdd",pi.FLOAT4,1),new Tr("cc_nearFar",pi.FLOAT4,1),new Tr("cc_viewPort",pi.FLOAT4,1)],1),Pd.layouts[kd.NAME]=kd.LAYOUT,Pd.bindings[kd.BINDING]=kd.DESCRIPTOR;var Gd=function(){};Gd.SIZE=4*(Gd.COUNT=4+(Gd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Gd.SHADOW_COLOR_OFFSET=4+(Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Gd.SHADOW_PROJ_INFO_OFFSET=4+(Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Gd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Gd.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Gd.MAT_LIGHT_VIEW_OFFSET=16+(Gd.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Gd.NAME="CCShadow",Gd.BINDING=wd.UBO_SHADOW,Gd.DESCRIPTOR=new Vr(Gd.BINDING,ji.UNIFORM_BUFFER,1,Ni.ALL),Gd.LAYOUT=new Cr(Md.GLOBAL,Gd.BINDING,Gd.NAME,[new Tr("cc_matLightPlaneProj",pi.MAT4,1),new Tr("cc_matLightView",pi.MAT4,1),new Tr("cc_matLightViewProj",pi.MAT4,1),new Tr("cc_shadowInvProjDepthInfo",pi.FLOAT4,1),new Tr("cc_shadowProjDepthInfo",pi.FLOAT4,1),new Tr("cc_shadowProjInfo",pi.FLOAT4,1),new Tr("cc_shadowNFLSInfo",pi.FLOAT4,1),new Tr("cc_shadowWHPBInfo",pi.FLOAT4,1),new Tr("cc_shadowLPNNInfo",pi.FLOAT4,1),new Tr("cc_shadowColor",pi.FLOAT4,1),new Tr("cc_planarNDInfo",pi.FLOAT4,1)],1),Pd.layouts[Gd.NAME]=Gd.LAYOUT,Pd.bindings[Gd.BINDING]=Gd.DESCRIPTOR;var Hd=wd.SAMPLER_SHADOWMAP,Vd=new Vr(Hd,ji.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Wd=new Ar(Md.GLOBAL,Hd,"cc_shadowMap",pi.SAMPLER2D,1);Pd.layouts.cc_shadowMap=Wd,Pd.bindings[Hd]=Vd;var jd=wd.SAMPLER_ENVIRONMENT,Xd=new Vr(jd,ji.SAMPLER_TEXTURE,1,Ni.FRAGMENT),qd=new Ar(Md.GLOBAL,jd,"cc_environment",pi.SAMPLER_CUBE,1);Pd.layouts.cc_environment=qd,Pd.bindings[jd]=Xd;var Yd=wd.SAMPLER_DIFFUSEMAP,Kd=new Vr(Yd,ji.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Qd=new Ar(Md.GLOBAL,Yd,"cc_diffuseMap",pi.SAMPLER_CUBE,1);Pd.layouts.cc_diffuseMap=Qd,Pd.bindings[Yd]=Kd;var Jd=wd.SAMPLER_SPOT_LIGHTING_MAP,Zd=new Vr(Jd,ji.SAMPLER_TEXTURE,1,Ni.FRAGMENT),$d=new Ar(Md.GLOBAL,Jd,"cc_spotLightingMap",pi.SAMPLER2D,1);Pd.layouts.cc_spotLightingMap=$d,Pd.bindings[Jd]=Zd;var ep=function(){};ep.SIZE=4*(ep.COUNT=4+(ep.LOCAL_SHADOW_BIAS=4+(ep.LIGHTINGMAP_UVPARAM=16+(ep.MAT_WORLD_IT_OFFSET=16+(ep.MAT_WORLD_OFFSET=0))))),ep.NAME="CCLocal",ep.BINDING=Dd.UBO_LOCAL,ep.DESCRIPTOR=new Vr(ep.BINDING,ji.UNIFORM_BUFFER,1,Ni.VERTEX|Ni.COMPUTE),ep.LAYOUT=new Cr(Md.LOCAL,ep.BINDING,ep.NAME,[new Tr("cc_matWorld",pi.MAT4,1),new Tr("cc_matWorldIT",pi.MAT4,1),new Tr("cc_lightingMapUVParam",pi.FLOAT4,1),new Tr("cc_localShadowBias",pi.FLOAT4,1)],1),Rd.layouts[ep.NAME]=ep.LAYOUT,Rd.bindings[ep.BINDING]=ep.DESCRIPTOR;var tp=function(){};tp.SIZE=4*(tp.COUNT=4+(tp.WORLD_BOUND_HALF_EXTENTS=4+(tp.WORLD_BOUND_CENTER=0))),tp.NAME="CCWorldBound",tp.BINDING=Dd.UBO_LOCAL,tp.DESCRIPTOR=new Vr(tp.BINDING,ji.UNIFORM_BUFFER,1,Ni.VERTEX|Ni.COMPUTE),tp.LAYOUT=new Cr(Md.LOCAL,tp.BINDING,tp.NAME,[new Tr("cc_worldBoundCenter",pi.FLOAT4,1),new Tr("cc_worldBoundHalfExtents",pi.FLOAT4,1)],1),Rd.layouts[tp.NAME]=tp.LAYOUT,Rd.bindings[tp.BINDING]=tp.DESCRIPTOR;var np="a_matWorld0",ip=function(){};ip.BATCHING_COUNT=10,ip.MAT_WORLDS_OFFSET=0,ip.SIZE=4*(ip.COUNT=16*ip.BATCHING_COUNT),ip.NAME="CCLocalBatched",ip.BINDING=Dd.UBO_LOCAL,ip.DESCRIPTOR=new Vr(ip.BINDING,ji.UNIFORM_BUFFER,1,Ni.VERTEX|Ni.COMPUTE),ip.LAYOUT=new Cr(Md.LOCAL,ip.BINDING,ip.NAME,[new Tr("cc_matWorlds",pi.MAT4,ip.BATCHING_COUNT)],1),Rd.layouts[ip.NAME]=ip.LAYOUT,Rd.bindings[ip.BINDING]=ip.DESCRIPTOR;var rp=function(){};rp.LIGHTS_PER_PASS=1,rp.SIZE=4*(rp.COUNT=(rp.LIGHT_DIR_OFFSET=(rp.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(rp.LIGHT_COLOR_OFFSET=(rp.LIGHT_POS_OFFSET=0)+4*rp.LIGHTS_PER_PASS)+4*rp.LIGHTS_PER_PASS)+4*rp.LIGHTS_PER_PASS)+4*rp.LIGHTS_PER_PASS),rp.NAME="CCForwardLight",rp.BINDING=Dd.UBO_FORWARD_LIGHTS,rp.DESCRIPTOR=new Vr(rp.BINDING,ji.DYNAMIC_UNIFORM_BUFFER,1,Ni.FRAGMENT),rp.LAYOUT=new Cr(Md.LOCAL,rp.BINDING,rp.NAME,[new Tr("cc_lightPos",pi.FLOAT4,rp.LIGHTS_PER_PASS),new Tr("cc_lightColor",pi.FLOAT4,rp.LIGHTS_PER_PASS),new Tr("cc_lightSizeRangeAngle",pi.FLOAT4,rp.LIGHTS_PER_PASS),new Tr("cc_lightDir",pi.FLOAT4,rp.LIGHTS_PER_PASS)],1),Rd.layouts[rp.NAME]=rp.LAYOUT,Rd.bindings[rp.BINDING]=rp.DESCRIPTOR;var ap=function(){};ap.LIGHTS_PER_PASS=10;var op=function(){};op.SIZE=4*(op.COUNT=4+(op.JOINTS_TEXTURE_INFO_OFFSET=0)),op.NAME="CCSkinningTexture",op.BINDING=Dd.UBO_SKINNING_TEXTURE,op.DESCRIPTOR=new Vr(op.BINDING,ji.UNIFORM_BUFFER,1,Ni.VERTEX),op.LAYOUT=new Cr(Md.LOCAL,op.BINDING,op.NAME,[new Tr("cc_jointTextureInfo",pi.FLOAT4,1)],1),Rd.layouts[op.NAME]=op.LAYOUT,Rd.bindings[op.BINDING]=op.DESCRIPTOR;var sp=function(){};sp.SIZE=4*(sp.COUNT=4+(sp.JOINTS_ANIM_INFO_OFFSET=0)),sp.NAME="CCSkinningAnimation",sp.BINDING=Dd.UBO_SKINNING_ANIMATION,sp.DESCRIPTOR=new Vr(sp.BINDING,ji.UNIFORM_BUFFER,1,Ni.VERTEX),sp.LAYOUT=new Cr(Md.LOCAL,sp.BINDING,sp.NAME,[new Tr("cc_jointAnimInfo",pi.FLOAT4,1)],1),Rd.layouts[sp.NAME]=sp.LAYOUT,Rd.bindings[sp.BINDING]=sp.DESCRIPTOR;var cp="a_jointAnimInfo",lp=function(){};lp.SIZE=4*(lp.COUNT=360+(lp.JOINTS_OFFSET=0)),lp.NAME="CCSkinning",lp.BINDING=Dd.UBO_SKINNING_TEXTURE,lp.DESCRIPTOR=new Vr(lp.BINDING,ji.UNIFORM_BUFFER,1,Ni.VERTEX),lp.LAYOUT=new Cr(Md.LOCAL,lp.BINDING,lp.NAME,[new Tr("cc_joints",pi.FLOAT4,90)],1),Rd.layouts[lp.NAME]=lp.LAYOUT,Rd.bindings[lp.BINDING]=lp.DESCRIPTOR;var up=function(){};up.MAX_MORPH_TARGET_COUNT=60,up.OFFSET_OF_WEIGHTS=0,up.OFFSET_OF_VERTICES_COUNT=4+(up.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(up.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*up.MAX_MORPH_TARGET_COUNT)),up.COUNT_BASE_4_BYTES=4*Math.ceil(up.MAX_MORPH_TARGET_COUNT/4)+4,up.SIZE=4*up.COUNT_BASE_4_BYTES,up.NAME="CCMorph",up.BINDING=Dd.UBO_MORPH,up.DESCRIPTOR=new Vr(up.BINDING,ji.UNIFORM_BUFFER,1,Ni.VERTEX),up.LAYOUT=new Cr(Md.LOCAL,up.BINDING,up.NAME,[new Tr("cc_displacementWeights",pi.FLOAT4,up.MAX_MORPH_TARGET_COUNT/4),new Tr("cc_displacementTextureInfo",pi.FLOAT4,1)],1),Rd.layouts[up.NAME]=up.LAYOUT,Rd.bindings[up.BINDING]=up.DESCRIPTOR;var hp=function(){};hp.NAME="CCUILocal",hp.BINDING=Dd.UBO_UI_LOCAL,hp.DESCRIPTOR=new Vr(hp.BINDING,ji.DYNAMIC_UNIFORM_BUFFER,1,Ni.VERTEX),hp.LAYOUT=new Cr(Md.LOCAL,hp.BINDING,hp.NAME,[new Tr("cc_local_data",pi.FLOAT4,1)],1),Rd.layouts[hp.NAME]=hp.LAYOUT,Rd.bindings[hp.BINDING]=hp.DESCRIPTOR;var fp=Dd.SAMPLER_JOINTS,_p=new Vr(fp,ji.SAMPLER_TEXTURE,1,Ni.VERTEX),dp=new Ar(Md.LOCAL,fp,"cc_jointTexture",pi.SAMPLER2D,1);Rd.layouts.cc_jointTexture=dp,Rd.bindings[fp]=_p;var pp=Dd.SAMPLER_MORPH_POSITION,mp=new Vr(pp,ji.SAMPLER_TEXTURE,1,Ni.VERTEX),vp=new Ar(Md.LOCAL,pp,"cc_PositionDisplacements",pi.SAMPLER2D,1);Rd.layouts.cc_PositionDisplacements=vp,Rd.bindings[pp]=mp;var gp=Dd.SAMPLER_MORPH_NORMAL,yp=new Vr(gp,ji.SAMPLER_TEXTURE,1,Ni.VERTEX),Sp=new Ar(Md.LOCAL,gp,"cc_NormalDisplacements",pi.SAMPLER2D,1);Rd.layouts.cc_NormalDisplacements=Sp,Rd.bindings[gp]=yp;var xp=Dd.SAMPLER_MORPH_TANGENT,Ep=new Vr(xp,ji.SAMPLER_TEXTURE,1,Ni.VERTEX),Tp=new Ar(Md.LOCAL,xp,"cc_TangentDisplacements",pi.SAMPLER2D,1);Rd.layouts.cc_TangentDisplacements=Tp,Rd.bindings[xp]=Ep;var Cp=Dd.SAMPLER_LIGHTMAP,Ap=new Vr(Cp,ji.SAMPLER_TEXTURE,1,Ni.FRAGMENT),bp=new Ar(Md.LOCAL,Cp,"cc_lightingMap",pi.SAMPLER2D,1);Rd.layouts.cc_lightingMap=bp,Rd.bindings[Cp]=Ap;var Ip=Dd.SAMPLER_SPRITE,wp=new Vr(Ip,ji.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Pp=new Ar(Md.LOCAL,Ip,"cc_spriteTexture",pi.SAMPLER2D,1);Rd.layouts.cc_spriteTexture=Pp,Rd.bindings[Ip]=wp;var Rp=Dd.SAMPLER_REFLECTION,Dp=new Vr(Rp,ji.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Op=new Ar(Md.LOCAL,Rp,"cc_reflectionTexture",pi.SAMPLER2D,1);Rd.layouts.cc_reflectionTexture=Op,Rd.bindings[Rp]=Dp;var Np=Dd.STORAGE_REFLECTION,Mp=new Vr(Np,ji.STORAGE_IMAGE,1,Ni.COMPUTE),Lp=new wr(Md.LOCAL,Np,"cc_reflectionStorage",pi.IMAGE2D,1);Rd.layouts.cc_reflectionStorage=Lp,Rd.bindings[Np]=Mp;var Fp,Bp,zp=Ed.makeMaskExclude([Ed.BitMask.UI_2D,Ed.BitMask.GIZMOS,Ed.BitMask.EDITOR,Ed.BitMask.SCENE_GIZMO,Ed.BitMask.PROFILER]),Up=Ed.makeMaskExclude([Ed.BitMask.UI_2D,Ed.BitMask.PROFILER]),kp=Ed.Enum.ALL;function Gp(e){return(e.getFormatFeatures(_i.R32F)&(Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE))==(Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Ad,PIPELINE_FLOW_FORWARD:bd,PIPELINE_FLOW_SHADOW:Id,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Td},get RenderPriority(){return Cd},globalDescriptorSetLayout:Pd,localDescriptorSetLayout:Rd,get PipelineGlobalBindings(){return wd},get ModelLocalBindings(){return Dd},get SetIndex(){return Md},bindingMappingInfo:zd,UBOGlobal:Ud,UBOCamera:kd,UBOShadow:Gd,UNIFORM_SHADOWMAP_BINDING:Hd,UNIFORM_ENVIRONMENT_BINDING:jd,UNIFORM_DIFFUSEMAP_BINDING:Yd,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:Jd,UBOLocal:ep,UBOWorldBound:tp,INST_MAT_WORLD:np,UBOLocalBatched:ip,UBOForwardLight:rp,UBODeferredLight:ap,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:op,UBOSkinningAnimation:sp,INST_JOINT_ANIM_INFO:cp,UBOSkinning:lp,UBOMorph:up,UBOUILocal:hp,UNIFORM_JOINT_TEXTURE_BINDING:fp,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:pp,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:gp,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:xp,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Cp,UNIFORM_SPRITE_TEXTURE_BINDING:Ip,UNIFORM_REFLECTION_TEXTURE_BINDING:Rp,UNIFORM_REFLECTION_STORAGE_BINDING:Np,CAMERA_DEFAULT_MASK:zp,CAMERA_EDITOR_MASK:Up,MODEL_ALWAYS_MASK:kp,supportsR16HalfFloatTexture:function(e){return(e.getFormatFeatures(_i.R16F)&(Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE))==(Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE)},supportsR32FloatTexture:Gp}));var Hp=4227858432,Vp=66060288,Wp=1044480,jp=function(e,t,n,i){return void 0===i&&(i=0),t<<26&Hp|e<<20&Vp|n<<12&Wp|4095&i},Xp=function(e){return(e&Hp)>>>26},qp=function(e){return(e&Vp)>>>20},Yp=function(e){return(e&Wp)>>>12},Kp=function(e){return 4095&e},Qp=function(e,t){return 67108863&e|t<<26&Hp},Jp=((Fp={})[pi.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Fp[pi.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Fp[pi.INT2]=function(e,t,n){return void 0===n&&(n=0),Yn.fromArray(t,e,n)},Fp[pi.INT3]=function(e,t,n){return void 0===n&&(n=0),Pn.fromArray(t,e,n)},Fp[pi.INT4]=function(e,t,n){return void 0===n&&(n=0),Zn.fromArray(t,e,n)},Fp[pi.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Fp[pi.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Yn.fromArray(t,e,n)},Fp[pi.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),Pn.fromArray(t,e,n)},Fp[pi.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Zn.fromArray(t,e,n)},Fp[pi.MAT3]=function(e,t,n){return void 0===n&&(n=0),Nn.fromArray(t,e,n)},Fp[pi.MAT4]=function(e,t,n){return void 0===n&&(n=0),Wn.fromArray(t,e,n)},Fp),Zp=((Bp={})[pi.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Bp[pi.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Bp[pi.INT2]=function(e,t,n){return void 0===n&&(n=0),Yn.toArray(e,t,n)},Bp[pi.INT3]=function(e,t,n){return void 0===n&&(n=0),Pn.toArray(e,t,n)},Bp[pi.INT4]=function(e,t,n){return void 0===n&&(n=0),Zn.toArray(e,t,n)},Bp[pi.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Bp[pi.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Yn.toArray(e,t,n)},Bp[pi.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),Pn.toArray(e,t,n)},Bp[pi.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Zn.toArray(e,t,n)},Bp[pi.MAT3]=function(e,t,n){return void 0===n&&(n=0),Nn.toArray(e,t,n)},Bp[pi.MAT4]=function(e,t,n){return void 0===n&&(n=0),Wn.toArray(e,t,n)},Bp),$p=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function em(e){switch(e){case pi.BOOL:case pi.INT:case pi.UINT:case pi.FLOAT:return $p[0];case pi.BOOL2:case pi.INT2:case pi.UINT2:case pi.FLOAT2:return $p[1];case pi.BOOL4:case pi.INT4:case pi.UINT4:case pi.FLOAT4:return $p[2];case pi.MAT4:return $p[3];case pi.SAMPLER2D:return"default-texture";case pi.SAMPLER_CUBE:return"default-cube-texture"}return $p[0]}function tm(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var nm=new Wr;function im(e){return Math.ceil(Math.log2(Math.max(e,2)))}function rm(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function am(e,t,n,i,r){for(var a=e.builtins[i],o=[],s=function(e){var t=a.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&ia))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";o.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<a.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,o);for(var l=[],u=function(e){var t=a.samplerTextures[e],i=n.layouts[t.name],o=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&o&&o.descriptorType&ra))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(o)&&r.push(o)},h=0;h<a.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function om(e){return e.members.reduce((function(e,t){return e+ua(t.type)*t.count}),0)}function sm(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function cm(e){switch(e.gfxAPI){case ui.GLES2:case ui.WEBGL:return"glsl1";case ui.GLES3:case ui.WEBGL2:return"glsl3";default:return"glsl4"}}var lm,um,hm,fm,_m,dm,pm,mm,vm=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var a=i.passes[r];void 0!==a.propertyIndex&&void 0===a.properties&&(a.properties=i.passes[a.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=J({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var a=t.range;r=im(a[1]-a[0]+1),t._map=function(e){return e-a[0]}}else"string"===t.type?(r=im(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},a=0;a<n.defines.length;a++)r(a);for(var o in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+o+" "+n.builtins.statistics[o]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Nr,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(om(l)),s.bindings.push(new Vr(l.binding,ji.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new Cr(Md.MATERIAL,l.binding,l.name,l.members.map((function(e){return new Tr(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Vr(h.binding,ji.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Ar(Md.MATERIAL,h.binding,h.name,h.type,h.count))}for(var f=0;f<n.samplers.length;f++){var _=n.samplers[f];s.bindings.push(new Vr(_.binding,ji.SAMPLER,_.count,_.stageFlags)),s.shaderInfo.samplers.push(new br(Md.MATERIAL,_.binding,_.name,_.count))}for(var d=0;d<n.textures.length;d++){var p=n.textures[d];s.bindings.push(new Vr(p.binding,ji.TEXTURE,p.count,p.stageFlags)),s.shaderInfo.textures.push(new Ir(Md.MATERIAL,p.binding,p.name,p.type,p.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new Vr(v.binding,ji.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Pr(Md.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new Vr(y.binding,ji.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new wr(Md.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var S=0;S<n.subpassInputs.length;S++){var x=n.subpassInputs[S];s.bindings.push(new Vr(x.binding,ji.INPUT_ATTACHMENT,x.count,x.stageFlags)),s.shaderInfo.subpassInputs.push(new Rr(Md.MATERIAL,x.binding,x.name,x.count))}s.gfxAttributes=[];for(var E=0;E<n.attributes.length;E++){var T=n.attributes[E];s.gfxAttributes.push(new Or(T.name,T.format,T.isNormalized,0,T.isInstanced,T.location))}am(n,s,Rd,"locals"),s.shaderInfo.stages.push(new Dr(Ni.VERTEX,"")),s.shaderInfo.stages.push(new Dr(Ni.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,a=0,o=0;o<r.length;o++){var s=r[o];t[s.name]=jp(i.binding,s.type,s.count,a),a+=(ua(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=jp(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(nm.bindings=r.bindings,r.setLayouts[Md.MATERIAL]=e.createDescriptorSetLayout(nm),nm.bindings=Rd.bindings,r.setLayouts[Md.LOCAL]=e.createDescriptorSetLayout(nm)),r.setLayouts[n?Md.LOCAL:Md.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",a=0;a<i.length;a++){var o=i[a],s=t[o.name];if(s&&o._map){var c=o._map(s);r+=""+o._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],f=t[h.name];f&&h._map&&(l|=h._map(f)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),a=0;a<r.length;a++){var o=r[a],s=this._cache[o];T("destroyed shader "+s.name),s.destroy(),delete this._cache[o]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var a=this._cache[r];if(a)return a;var o=this._templates[t],s=this._templateInfos[o.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),am(o,s,Pd,"globals"),s.setLayouts[Md.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new Xr(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],a=r.name,o=e[a],s=rm(r,o),c=!o||"0"===o;n.push({name:a,value:s,isDefault:c})}return n}(n,o.defines),l=i.constantMacros+o.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=o.glsl3,h=cm(e);return h?u=o[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,a=t.gfxAttributes,o=0;o<r.length;o++)sm(r[o].defines,n)&&i.push(a[o]);return i}(o,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());l.programLib=vm;var gm=e("EffectAsset",Tc("cc.EffectAsset")((mm=pm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"techniques",hm,re(t)),se(t,"shaders",fm,re(t)),se(t,"combinations",_m,re(t)),se(t,"hideInEditor",dm,re(t)),t}Z(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name]===e&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){vm.register(this),t.register(this),l.game.once(l.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=l.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],a=0;a<i.length;++a){var o=J({},n);o[t]=i[a],e.push(o)}return e}),[])}),[{}]).forEach((function(e){return vm.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(wu),pm._effects={},hm=ce((um=mm).prototype,"techniques",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fm=ce(um.prototype,"shaders",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_m=ce(um.prototype,"combinations",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dm=ce(um.prototype,"hideInEditor",[Dc,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lm=um))||lm);l.EffectAsset=gm;var ym,Sm,xm,Em,Tm,Cm,Am,bm,Im,wm,Pm,Rm,Dm,Om,Nm,Mm=1024;!function(e){e[e.RGB565=_i.R5G6B5]="RGB565",e[e.RGB5A1=_i.RGB5A1]="RGB5A1",e[e.RGBA4444=_i.RGBA4]="RGBA4444",e[e.RGB888=_i.RGB8]="RGB888",e[e.RGB32F=_i.RGB32F]="RGB32F",e[e.RGBA8888=_i.RGBA8]="RGBA8888",e[e.RGBA32F=_i.RGBA32F]="RGBA32F",e[e.A8=_i.A8]="A8",e[e.I8=_i.L8]="I8",e[e.AI8=_i.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=_i.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=_i.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Mm++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=_i.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=_i.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Mm++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=_i.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Mm++]="RGBA_ETC1",e[e.RGB_ETC2=_i.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=_i.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=_i.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=_i.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=_i.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=_i.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=_i.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=_i.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=_i.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=_i.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=_i.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=_i.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=_i.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=_i.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=_i.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=_i.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(ym||(ym={})),function(e){e[e.REPEAT=Ii.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Ii.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Ii.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Ii.BORDER]="CLAMP_TO_BORDER"}(Sm||(Sm={})),function(e){e[e.NONE=bi.NONE]="NONE",e[e.LINEAR=bi.LINEAR]="LINEAR",e[e.NEAREST=bi.POINT]="NEAREST"}(xm||(xm={})),st(_i);var Lm,Fm,Bm,zm,Um=new pe("Tex"),km=Tc("cc.TextureBase")((Nm=Om=function(e){function t(){var t;return se(t=e.call(this)||this,"_format",Cm,re(t)),se(t,"_minFilter",Am,re(t)),se(t,"_magFilter",bm,re(t)),se(t,"_mipFilter",Im,re(t)),se(t,"_wrapS",wm,re(t)),se(t,"_wrapT",Pm,re(t)),se(t,"_wrapR",Rm,re(t)),se(t,"_anisotropy",Dm,re(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new Er,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=Um.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=Sa(t._id,666),t}Z(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=l.director.root)||void 0===t?void 0:t.batcher2D)&&l.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):O(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return l.director.root?l.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?ym.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===ym.RGBA_ETC1?e=ym.RGB_ETC1:e===ym.RGB_A_PVRTC_4BPPV1?e=ym.RGB_PVRTC_4BPPV1:e===ym.RGB_A_PVRTC_2BPPV1&&(e=ym.RGB_PVRTC_2BPPV1),e},Q(t,[{key:"isCompressed",get:function(){return this._format>=ym.RGB_ETC1&&this._format<=ym.RGBA_ASTC_12x12||this._format>=ym.RGB_A_PVRTC_2BPPV1&&this._format<=ym.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(wu),Om.PixelFormat=ym,Om.WrapMode=Sm,Om.Filter=xm,Cm=ce((Tm=Nm).prototype,"_format",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ym.RGBA8888}}),Am=ce(Tm.prototype,"_minFilter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xm.LINEAR}}),bm=ce(Tm.prototype,"_magFilter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xm.LINEAR}}),Im=ce(Tm.prototype,"_mipFilter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xm.NONE}}),wm=ce(Tm.prototype,"_wrapS",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sm.REPEAT}}),Pm=ce(Tm.prototype,"_wrapT",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sm.REPEAT}}),Rm=ce(Tm.prototype,"_wrapR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sm.REPEAT}}),Dm=ce(Tm.prototype,"_anisotropy",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Em=Tm))||Em;function Gm(e){return!!(l.sys.hasFeature(l.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}l.TextureBase=km;var Hm=e("ImageAsset",Tc("cc.ImageAsset")((zm=Bm=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=ym.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}Z(t,e);var n=t.prototype;return n.reset=function(e){Gm(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Gm(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var i,r=l.director.root?l.director.root.device:null,a=n.split("_"),o=Number.MAX_VALUE,s=this._format,c="",u=l.macro.SUPPORT_TEXTURE_FORMATS,h=oe(a);!(i=h()).done;){var f=i.value.split("@"),_=parseInt(f[0],void 0),d=t.extnames[_]||f[0],p=u.indexOf(d);if(-1!==p&&p<o){var m=f[1]?parseInt(f[1]):this._format;if(!(".astc"!==d||r&&r.getFormatFeatures(_i.ASTC_RGBA_4X4)&Ti.SAMPLED_TEXTURE))continue;if(!(".pvr"!==d||r&&r.getFormatFeatures(_i.PVRTC_RGBA4)&Ti.SAMPLED_TEXTURE))continue;if(!(m!==ym.RGB_ETC1&&m!==ym.RGBA_ETC1||r&&r.getFormatFeatures(_i.ETC_RGB8)&Ti.SAMPLED_TEXTURE))continue;if(!(m!==ym.RGB_ETC2&&m!==ym.RGBA_ETC2||r&&r.getFormatFeatures(_i.ETC2_RGB8)&Ti.SAMPLED_TEXTURE))continue;if(".webp"===d&&!l.sys.hasFeature(l.sys.Feature.WEBP))continue;o=p,c=d,s=m}}c?(this._setRawAsset(c),this._format=s):R(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),a=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,a,a),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},Q(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||Gm(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Gm(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=ym.RGB_ETC1&&this._format<=ym.RGBA_ASTC_12x12||this._format>=ym.RGB_A_PVRTC_2BPPV1&&this._format<=ym.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(wu),Bm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Bm._sharedPlaceHolderCanvas=null,ce((Fm=zm).prototype,"_nativeAsset",[sl],Object.getOwnPropertyDescriptor(Fm.prototype,"_nativeAsset"),Fm.prototype),Lm=Fm))||Lm);l.ImageAsset=Hm;var Vm=new WeakMap,Wm=new WeakSet,jm=new WeakSet;function Xm(e,t){var n;n=Zu.safeFindClass;var i,r=Sh.pool.get();try{i=Oh(e,r,{classFinder:n,customEnv:t})}catch(e){throw x(e),Sh.pool.put(r),e}i._uuid=t.__uuid__||"";for(var a=r.uuidList,o=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<a.length;u++){var h=a[u];l[u]={uuid:Nl(h),owner:o[u],prop:s[u],type:nt._getClassById(c[u])}}return Vm.set(i,l),i._native&&Wm.add(i),Sh.pool.put(r),i}var qm,Ym=new(function(){function e(){this._depends=new ml}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?J({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof ch){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var a=Xm(t,{__uuid__:e});(r=this._parseDepsFromAsset(a)).nativeDep&&(r.nativeDep.uuid=e),xl.add(e+"@import",a)}catch(t){Sl.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=Vm.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Wm.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=Nl(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var a=i[r];t[a]||(t[a]=!0,n.push(a),this._descend(a,t,n))}},e}()),Km=[new lr];function Qm(e){return e&&0==(e&e-1)}var Jm,Zm,$m,ev,tv,nv,iv=Tc("cc.SimpleTexture")(qm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._gfxTextureView=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t._baseLevel=0,t._maxLevel=1e3,t}Z(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTextureView},n.destroy=function(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=Km[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,Km):i.copyTexImagesToTexture([e],this._gfxTexture,Km)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),lt.CLEANUP_IMAGE_CACHE)){var r=Ym.getDeps(this._uuid),a=r.indexOf(e._uuid);-1!==a&&(he(r,a),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._setMipRange=function(e,t){this._baseLevel=e<1?0:e,this._maxLevel=t<1?0:t},n.setMipRange=function(e,t){L(e<=t,3124),this._setMipRange(e,t);var n=this._getGFXDevice();if(n){var i=this._createTextureView(n);this._tryDestroyTextureView(),this._gfxTextureView=i}},n._getGfxTextureCreateInfo=function(){return null},n._getGfxTextureViewCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&(this._createTexture(e),this._gfxTextureView=this._createTextureView(e))}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=Ei.NONE;this._mipFilter!==xm.NONE&&function(e,t,n){return!(e.gfxAPI===ui.WEBGL)||Qm(t)&&Qm(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=Ei.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:xi.SAMPLED|xi.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._createTextureView=function(e){if(!this._gfxTexture)return null;var t=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,n=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:t-this._baseLevel+1});return n?e.createTexture(n):null},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},n._tryDestroyTextureView=function(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)},Q(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(km))||qm;l.SimpleTexture=iv;var rv,av,ov,sv,cv,lv,uv,hv=e("Texture2D",(Jm=Tc("cc.Texture2D"),Zm=al([Hm]),Jm((nv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",tv,re(t)),t}Z(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var n=void 0===e.baseLevel?0:e.baseLevel,i=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(n,i),this._tryReset()},n.create=function(e,t,n,i,r,a){void 0===n&&(n=ym.RGBA8888),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=1e3),this.reset({width:e,height:t,format:n,mipmapLevel:i,baseLevel:r,maxLevel:a})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Hm,i.mipmaps[r]){var a=i.mipmaps[r];n.result.push(this._mipmaps,""+r,a,nt._getClassId(Hm))}},n._getGfxTextureCreateInfo=function(e){var t=new Sr(Si.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e),t},n._getGfxTextureViewCreateInfo=function(e){var t=new xr;return t.type=Si.TEX2D,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Hm;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},Q(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(iv),tv=ce((ev=nv).prototype,"_mipmaps",[Zm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$m=ev))||$m));l.Texture2D=hv,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(uv||(uv={}));var fv=e("TextureCube",Tc("cc.TextureCube")((lv=cv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",ov,re(t)),se(t,"_mipmaps",sv,re(t)),t}Z(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,a=0;a<r;a++){var o=6*a;i.push({front:e[o+uv.front].image,back:e[o+uv.back].image,left:e[o+uv.left].image,right:e[o+uv.right].image,top:e[o+uv.top].image,bottom:e[o+uv.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var n=void 0===e.baseLevel?0:e.baseLevel,i=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(n,i),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;_v(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},a=0;a<i;++a)r(a)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Hm,back:new Hm,left:new Hm,right:new Hm,top:new Hm,bottom:new Hm};var a=i.mipmaps[r],o=nt._getClassId(Hm);n.result.push(this._mipmaps[r],"front",a.front,o),n.result.push(this._mipmaps[r],"back",a.back,o),n.result.push(this._mipmaps[r],"left",a.left,o),n.result.push(this._mipmaps[r],"right",a.right,o),n.result.push(this._mipmaps[r],"top",a.top,o),n.result.push(this._mipmaps[r],"bottom",a.bottom,o)}},n._getGfxTextureCreateInfo=function(e){var t=new Sr(Si.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n._getGfxTextureViewCreateInfo=function(e){var t=new xr;return t.type=Si.CUBE,t.baseLayer=0,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Hm;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},Q(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,n){_v(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(iv),cv.FaceIndex=uv,ov=ce((av=lv).prototype,"isRGBE",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sv=ce(av.prototype,"_mipmaps",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rv=av))||rv);function _v(e,t){t(e.front,uv.front),t(e.back,uv.back),t(e.left,uv.left),t(e.right,uv.right),t(e.top,uv.top),t(e.bottom,uv.bottom)}l.TextureCube=fv;var dv,pv,mv,vv=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:3642336485,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:54,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"geometry-renderer",techniques:[{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]}],shaders:[{name:"geometry-renderer|line-vs:vert|line-fs:front",hash:3617431e3,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|line-vs:vert|line-fs:back",hash:4168905198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",hash:4034582016,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",hash:1762165009,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:front",hash:4143142643,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:back",hash:826026446,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:4284763886,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:851293782,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2502358098,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:585841727,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:2499219289,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:67215139,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},specularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrength:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4079105024,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:223,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14},{name:"a_texCoord1",defines:[],format:21,location:15}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3928335406,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:184,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3669699677,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:71,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:71},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:2218105608,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:69,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3152709001,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:198,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:837263906,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:682261797,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3663548873,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:670444562,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:2587574837,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:69},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2},{name:"depth_stencil",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3542426468,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:217,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:2960965003,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:2207113861,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),gv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\nuniform highp vec4 cc_localShadowBias;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragData[2];\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout lowp vec4 v_color;\n#endif\nout vec3 v_position;\nout mediump vec3 v_normal;\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nout mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nout mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin vec3 v_position;\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin mediump vec2 v_uv1;\n#endif\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout vec2 v_uv1;\n#endif\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin vec2 v_uv1;\n#endif\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nout vec2 v_shadowBias;\n#endif\nout highp vec3 v_position;\nout mediump vec3 v_normal;\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin vec2 v_shadowBias;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\nfloat depth = texture(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\nfloat depth = texture(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},yv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),a=new Uint8Array(16),o=new Uint8Array(16),s=new Uint8Array(16),c=0,u=0;u<4;u++)i[c]=0,i[c+1]=0,i[c+2]=0,i[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,a[c]=119,a[c+1]=119,a[c+2]=119,a[c+3]=255,o[c]=255,o[c+1]=255,o[c+2]=255,o[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;var h=new Uint8Array(1024);c=0;for(var f=0;f<256;f++)h[c]=221,h[c+1]=221,h[c+2]=221,h[c+3]=255,c+=4;c=0;for(var _=0;_<8;_++){for(var d=0;d<8;d++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}c+=32;for(var p=0;p<8;p++){for(var m=0;m<8;m++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}var v={width:2,height:2,_data:i,_compressed:!1,format:hv.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:hv.PixelFormat.RGBA8888},y={width:2,height:2,_data:a,_compressed:!1,format:hv.PixelFormat.RGBA8888},S={width:2,height:2,_data:o,_compressed:!1,format:hv.PixelFormat.RGBA8888},x={width:2,height:2,_data:s,_compressed:!1,format:hv.PixelFormat.RGBA8888},E={width:16,height:16,_data:h,_compressed:!1,format:hv.PixelFormat.RGBA8888},T=new Hm(v),C=new hv;C._uuid="black-texture",C.image=T,n[C._uuid]=C;var A=new Hm(g),b=new hv;b._uuid="empty-texture",b.image=A,n[b._uuid]=b;var I=new fv;I._uuid="black-cube-texture",I.setMipFilter(fv.Filter.NEAREST),I.image={front:new Hm(v),back:new Hm(v),left:new Hm(v),right:new Hm(v),top:new Hm(v),bottom:new Hm(v)},n[I._uuid]=I;var w=new Hm(y),P=new hv;P._uuid="grey-texture",P.image=w,n[P._uuid]=P;var R=new Hm(S),D=new hv;D._uuid="white-texture",D.image=R,n[D._uuid]=D;var O=new fv;O._uuid="white-cube-texture",O.setMipFilter(fv.Filter.NEAREST),O.image={front:new Hm(S),back:new Hm(S),left:new Hm(S),right:new Hm(S),top:new Hm(S),bottom:new Hm(S)},n[O._uuid]=O;var N=new Hm(x),M=new hv;M._uuid="normal-texture",M.image=N,n[M._uuid]=M;var L=new Hm(E),F=new hv;F._uuid="default-texture",F.image=L,n[F._uuid]=F;var B=new fv;if(B.setMipFilter(fv.Filter.NEAREST),B._uuid="default-cube-texture",B.image={front:new Hm(E),back:new Hm(E),left:new Hm(E),right:new Hm(E),top:new Hm(E),bottom:new Hm(E)},n[B._uuid]=B,l.SpriteFrame){var z=new l.SpriteFrame,U=T,k=new hv;k.image=U,z.texture=k,z._uuid="default-spriteframe",n[z._uuid]=z}var G=cm(e);if(!G)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=gv[G];return H?Promise.resolve().then((function(){vv.forEach((function(e,t){var n=Object.assign(new l.EffectAsset,e);n.shaders.forEach((function(e,n){var i=H[t][n];i&&(e[G]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+G+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new l.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new l.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",l.color("#ffff00")),e[i._uuid]=i,t.push(i);var r=new l.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",l.color("#ff00ff")),e[r._uuid]=r,t.push(r);var a=new l.Material;a._uuid="default-clear-stencil",a.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[a._uuid]=a,t.push(a);var o=new l.Material;o._uuid="ui-base-material",o.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[o._uuid]=o,t.push(o);var s=new l.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new l.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var u=new l.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new l.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var f=new l.Material;f._uuid="ui-sprite-gray-alpha-sep-material",f.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[f._uuid]=f,t.push(f);var _=new l.Material;_._uuid="ui-graphics-material",_.initialize({effectName:"graphics"}),e[_._uuid]=_,t.push(_);var d=new l.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),e[d._uuid]=d,t.push(d);var p=new l.Material;p._uuid="default-particle-gpu-material",p.initialize({effectName:"particle-gpu"}),e[p._uuid]=p,t.push(p);var m=new l.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new l.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new l.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),l.game.on(l.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),Sv=e("builtinResMgr",l.builtinResMgr=new yv),xv=e("getPhaseID",(dv=new Map,pv=0,function(e){return"number"==typeof e?e:(dv.has(e)||(dv.set(e,1<<pv),pv++),dv.get(e))})),Ev=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var a=e.inputAssembler,o=e.descriptorSet.getTexture(Cp),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==a.indexBuffer||u.count>=1024)&&u.lightingMap===o&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,f=u.data;u.data=new Uint8Array(h),u.data.set(f),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var _=this._device.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,32*r,r)),d=new Uint8Array(32*r),p=a.vertexBuffers.slice(),m=a.attributes.slice(),v=a.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],S=new Or(y.name,y.format,y.isNormalized,p.length,!0);m.push(S)}d.set(t.buffer),p.push(_);var x=new Mr(m,p,v),E=this._device.createInputAssembler(x);this.instances.push({count:1,capacity:32,vb:_,data:d,ia:E,stride:r,shader:s,descriptorSet:c,lightingMap:o}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),Tv=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,a=0,o=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var f=this.batches[h];if(f.vbs.length===i.length&&f.mergeCount<ip.BATCHING_COUNT){u=!0;for(var _=0;_<f.vbs.length;++_)if(f.vbs[_].stride!==i[_].stride){u=!1;break}if(u){for(var d=0;d<f.vbs.length;++d){var p=i[d],m=f.vbs[d],v=f.vbDatas[d];(r=(o+f.vbCount)*p.stride)>m.size&&(m.resize(r),f.vbDatas[d]=new Uint8Array(r),f.vbDatas[d].set(v)),f.vbDatas[d].set(p.buffer,f.vbCount*p.stride)}var g=f.vbIdxData;(a=4*(o+f.vbCount))>f.vbIdx.size&&(f.vbIdx.resize(a),f.vbIdxData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT),f.vbIdxData.set(g),g=f.vbIdxData);var y=f.vbCount,S=y+o,x=f.mergeCount;if(g[y]!==x||g[S-1]!==x)for(var E=y;E<S;E++)g[E]=x+.1;return Wn.toArray(f.uboData,n.transform.worldMatrix,ip.MAT_WORLDS_OFFSET+16*f.mergeCount),f.mergeCount||(l.bindBuffer(ip.BINDING,f.ubo),l.update(),f.pass=s,f.shader=c,f.descriptorSet=l),++f.mergeCount,f.vbCount+=o,void(f.ia.vertexCount+=o)}}}for(var T=[],C=[],A=[],b=0;b<i.length;++b){var I=i[b],w=this._device.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,I.count*I.stride,I.stride));w.update(I.buffer.buffer),T.push(w),C.push(new Uint8Array(w.size)),A.push(w)}var P=this._device.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,4*o,4)),R=new Float32Array(o);R.fill(0),P.update(R),A.push(P);for(var D=e.inputAssembler.attributes,O=new Array(D.length+1),N=0;N<D.length;++N)O[N]=D[N];O[D.length]=new Or("a_dyn_batch_id",_i.R32F,!1,i.length);var M=new Mr(O,A),L=this._device.createInputAssembler(M),F=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,ip.SIZE,ip.SIZE));l.bindBuffer(ip.BINDING,F),l.update();var B=new Float32Array(ip.COUNT);Wn.toArray(B,n.transform.worldMatrix,ip.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:T,vbDatas:C,vbIdx:P,vbIdxData:R,vbCount:o,ia:L,ubo:F,uboData:B,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),Cv=new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE),Av=new mr(null),bv=new jr(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(mv||(mv={}));var Iv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new wa,this._dss=new ba,this._rs=new Aa,this._priority=Cd.DEFAULT,this._stage=Td.DEFAULT,this._phase=xv("default"),this._primitive=Ui.TRIANGLE_LIST,this._batchingScheme=mv.NONE,this._dynamicStates=Vi.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(xv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=vm.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=oe(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),Sa(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=pi.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=Qp(i,n):t&&(i=Qp(i,Xp(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._getBlockView(r,i);Zp[r](o,n,a),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._getBlockView(r,i);return Jp[r](o,n,a)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=ua(r)>>2,o=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=a)null!==n[c]&&Zp[r](o,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):O(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new Ev(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new Tv(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),a=e.getOffsetFromHandle(n),o=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||em(i),u=(ua(i)>>2)*o,h=0;h+l.length<=u;h+=l.length)s.set(l,a+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),a=e.getBindingFromHandle(i),o=this._properties[t],s=o&&o.value,c=s?s+"-texture":em(r),l=Sv.get(c),u=l&&l.getGFXTexture(),h=o&&void 0!==o.samplerHash?Na.unpackFromHash(o.samplerHash):l&&l.getSamplerInfo(),f=this._device.getSampler(h);this._descriptorSet.bindSampler(a,f,n),this._descriptorSet.bindTexture(a,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],a=this._getBlockView(r.type,t.binding),o=this._properties[r.name],s=o&&o.value||em(r.type),c=(ua(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)a.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=vm.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(vm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=vm.getGFXShader(this._device,this._programName,this._defines,t),a=0;a<e.length;a++){var o=e[a];delete this._defines[o.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Cd.DEFAULT),this._setStage(Td.DEFAULT),this._setPhase(xv("default")),this._setPrimitive(Ui.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?J({},t.defines):t.defines,this._shaderInfo=vm.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),bv.layout=vm.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(bv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,a=vm.getTemplateInfo(t.program),o=a.blockSizes,s=a.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,f=0;f<r.length;f++){var _=o[f];l.push(h),h+=Math.ceil(_/c)*c,u=_}var d=l[l.length-1]+u;d&&(Cv.size=16*Math.ceil(d/16),this._rootBuffer=i.createBuffer(Cv),this._rootBlock=new ArrayBuffer(d));for(var p=0,m=0;p<r.length;p++){var v=r[p].binding,g=o[p];Av.buffer=this._rootBuffer,Av.offset=l[m++],Av.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Av);this._blocks[v]=new Float32Array(this._rootBlock,Av.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var S=this._propertyHandleMap=s,x={};for(var E in this._properties){var T=this._properties[E];T.handleInfo&&(x[E]=this.getHandle.apply(this,T.handleInfo))}Object.assign(S,x)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(fi.INSTANCED_ARRAYS)?this._setBatchingScheme(mv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(mv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(mv.VB_MERGING):this._setBatchingScheme(mv.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<pi.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(vm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},Q(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return vm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();Iv.getTypeFromHandle=Xp,Iv.getBindingFromHandle=qp,Iv.getCountFromHandle=Yp,Iv.getOffsetFromHandle=Kp;var wv=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var a=t.hash^i.hash^r.attributesHash^n.typedID,o=this._PSOHashMap.get(a);if(!o){var s=t.pipelineLayout,c=new qr(r.attributes),l=new Pa(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);o=e.createPipelineState(l),this._PSOHashMap.set(a,o)}return o},e}());wv._PSOHashMap=new Map;var Pv=new ur,Rv=new ir;function Dv(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var Ov,Nv,Mv,Lv,Fv,Bv,zv,Uv,kv,Gv,Hv=null;function Vv(e,t,n,i,r){if(i&&i.enabled&&r===Hv){var a=i.subModels[0],o=a.inputAssembler,s=a.passes,c=a.shaders,l=a.descriptorSet;Pv.width=Rv.width=r.window.width,Pv.height=Rv.height=r.window.height;var u=wv.getOrCreatePipelineState(e,s[0],c[0],t,o);n.setViewport(Pv),n.setScissor(Rv),n.bindPipelineState(u),n.bindDescriptorSet(Md.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(Md.LOCAL,l),n.bindInputAssembler(o),n.draw(o)}}var Wv,jv,Xv,qv,Yv,Kv=new Zn,Qv=e("Material",(Ov=Tc("cc.Material"),Nv=al(gm),Ov((Gv=function(e){function t(){var t;return se(t=e.call(this)||this,"_effectAsset",Fv,re(t)),se(t,"_techIdx",Bv,re(t)),se(t,"_defines",zv,re(t)),se(t,"_states",Uv,re(t)),se(t,"_props",kv,re(t)),t._passes=[],t._hash=0,t}Z(t,e),t.getHash=function(e){for(var t,n=0,i=oe(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?R(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=oe(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,a=r.length,o=0;o<a;o++){var s=r[o];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var a=n[r];if(e in a)return a[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var o=this._props[this._passes[t].propertyIndex];if(e in o)return o[e]}return null},n.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var n=0;n<e._props.length;n++)this._props[n]=J({},e._props[n]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=J({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=J({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},n._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=gm.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],a=r.passIndex=i,o=r.defines=this._defines[a]||(this._defines[a]={});if(r.stateOverrides=this._states[a]||(this._states[a]={}),void 0!==r.propertyIndex&&Object.assign(o,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(o,r.embeddedMacros),!r.switch||o[r.switch]){var s=new Iv(l.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(Iv.getTypeFromHandle(i)<pi.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var a=n;Dv(Kv,a),Kv.w=a.w,n=Kv}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var o=0;o<n.length;o++)this._bindTexture(e,i,n[o],o);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=Iv.getBindingFromHandle(t);if(n instanceof La)e.bindTexture(r,n,i);else if(n instanceof km){var a=n.getGFXTexture();if(!a||!a.width||!a.height)return;e.bindTexture(r,a,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=oe(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new In("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},Q(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(wu),Fv=ce((Lv=Gv).prototype,"_effectAsset",[Nv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bv=ce(Lv.prototype,"_techIdx",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zv=ce(Lv.prototype,"_defines",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uv=ce(Lv.prototype,"_states",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kv=ce(Lv.prototype,"_props",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mv=Lv))||Mv));l.Material=Qv,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Wv||(Wv={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(jv||(jv={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Xv||(Xv={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(qv||(qv={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Yv||(Yv={}));var Jv=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Zv=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],$v=[100,200,400,800],eg=new Pn,tg=new Pn,ng=new Wn,ig=Ki.STENCIL<<1,rg=[],ag=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Wv.VERTICAL,this._fov=hn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new hr(.2,.2,.2,1),this._viewport=new ii(0,0,1,1),this._orientedViewport=new ii(0,0,1,1),this._curTransform=hi.IDENTITY,this._isProjDirty=!0,this._matView=new Wn,this._matProj=new Wn,this._matProjInv=new Wn,this._matViewProj=new Wn,this._matViewProjInv=new Wn,this._frustum=new oc,this._forward=new Pn,this._position=new Pn,this._priority=0,this._aperture=Xv.F16_0,this._apertureValue=void 0,this._shutter=Yv.D125,this._shutterValue=0,this._iso=qv.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Ki.NONE,this._clearDepth=1,this._visibility=zp,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=Jv[this._aperture],this._shutterValue=Zv[this._shutter],this._isoValue=$v[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!rg.length){var t=e.capabilities.clipSpaceSignY;rg[hi.IDENTITY]=new Wn(1,0,0,0,0,t),rg[hi.ROTATE_90]=new Wn(0,1,0,0,-t,0),rg[hi.ROTATE_180]=new Wn(-1,0,0,0,0,-t),rg[hi.ROTATE_270]=new Wn(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||hi.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t._destroy=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Ki.NONE,this.clearDepth=1,this.visibility=zp,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t.destroy=function(){this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(Wn.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||hi.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var a=this._device.capabilities.clipSpaceSignY;if(this._proj===jv.PERSPECTIVE)Wn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Wv.VERTICAL,this._device.capabilities.clipSpaceMinZ,a,r);else{var o=this._orthoHeight*this._aspect,s=this._orthoHeight;Wn.ortho(this._matProj,-o,o,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,a,r)}Wn.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Wn.multiply(this._matViewProj,this._matProj,this._matView),Wn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,a=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,o=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(o&&o.surfaceTransform||hi.IDENTITY){case hi.ROTATE_90:this._viewport.x=1-a-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case hi.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-a-r,this._viewport.width=i,this._viewport.height=r;break;case hi.ROTATE_270:this._viewport.x=a,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case hi.IDENTITY:this._viewport.x=n,this._viewport.y=a,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=a,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||l.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||hi.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,a=this._orientedViewport.x*i,o=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===jv.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Vn[this._curTransform];Pn.set(eg,(t-a)/s*2-1,(n-o)/c*2-1,l?1:-1);var f=eg.x,_=eg.y;return eg.x=f*h[0]+_*h[2]*u,eg.y=f*h[1]+_*h[3]*u,Pn.transformMat4(l?eg:e.o,eg,this._matViewProjInv),l?(this._node.getWorldPosition(tg),no.fromPoints(e,tg,eg)):Pn.transformQuat(e.d,Pn.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,a=this._orientedViewport.y*i,o=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Vn[this._curTransform];if(this._proj===jv.PERSPECTIVE){Pn.set(e,(t.x-r)/o*2-1,(t.y-a)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,Pn.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(eg),Pn.lerp(e,eg,e,un(this._nearClip/this._farClip,1,t.z))}else{Pn.set(e,(t.x-r)/o*2-1,(t.y-a)/s*2-1,2*t.z-1);var f=e.x,_=e.y;e.x=f*l[0]+_*l[2]*c,e.y=f*l[1]+_*l[3]*c,Pn.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=Vn[this._curTransform];Pn.transformMat4(e,t,this._matViewProj);var r=e.x,a=e.y;e.x=r*i[0]+a*i[2]*n,e.y=r*i[1]+a*i[3]*n;var o=this.width,s=this.height,c=this._orientedViewport.x*o,l=this._orientedViewport.y*s,u=this._orientedViewport.width*o,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){Wn.multiply(e,this._matViewProj,t),Wn.multiply(e,rg[this._curTransform],e);var r=n/2,a=i/2;return Wn.identity(ng),Wn.transform(ng,ng,Pn.set(eg,r,a,0)),Wn.scale(ng,ng,Pn.set(eg,r,a,1)),Wn.multiply(e,ng,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},Q(e,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=Jv[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=Zv[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=$v[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(e){R(8302),this.setViewportInOrientedSpace(e)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),og=rt({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),sg=rt({Planar:0,ShadowMap:1}),cg=rt({HARD:0,SOFT:1,SOFT_2X:2}),lg=sg.ShadowMap+1,ug=function(){function e(){this.fixedSphere=new lo(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Wn,this.matShadowProj=new Wn,this.matShadowViewProj=new Wn,this._enabled=!1,this._type=lg,this._distance=0,this._normal=new Pn(0,1,0),this._shadowColor=new In(0,0,0,76),this._size=new Yn(512,512),this._shadowMapDirty=!1,this._matLight=new Wn,this._material=null,this._instancingMaterial=null}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new Qv,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Qv,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:lg},t.initialize=function(e){this._setEnable(e.enabled),this._setType(e.type),this.normal=e.planeDirection,this.distance=e.planeHeight,this.shadowColor=e.shadowColor,this.maxReceived=e.maxReceived,this.size=e.size},t.activate=function(){this.enabled&&this.type===sg.Planar&&this._updatePlanarInfo()},t._updatePlanarInfo=function(){this._material||(this._material=new Qv,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Qv,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},Q(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){Pn.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();ug.MAX_FAR=2e3,ug.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),l.Shadows=ug;var hg=new Pn,fg=(new Pn,new Pn,new Pn),_g=new Wn,dg=new Ys,pg=new Ys,mg=!1,vg=lo.create(0,0,0,1),gg=new lo,yg=new oc;yg.accurate=!0;var Sg=new oc;Sg.accurate=!0;var xg=new oc,Eg=new Wn,Tg=new Wn,Cg=new Wn,Ag=new Wn,bg=new Wn,Ig=new Wn,wg=new Wn,Pg=new Pn,Rg=new Yn,Dg=new Pn,Og=new Pn,Ng=new Pn(0,0,0),Mg=(new Ys,new Vl((function(){return{model:null,depth:0}}),128)),Lg=new Vl((function(){return{model:null,depth:0}}),128),Fg=new Vl((function(){return{model:null,depth:0}}),128);function Bg(e,t){var n=0;e.node&&(Pn.subtract(hg,e.node.worldPosition,t.position),n=Pn.dot(hg,t.forward));var i=Mg.alloc();return i.model=e,i.depth=n,i}function zg(e,t){var n=0;e.node&&(Pn.subtract(hg,e.node.worldPosition,t.position),n=Pn.dot(hg,t.forward));var i=Lg.alloc();return i.model=e,i.depth=n,i}function Ug(e,t){var n=0;e.node&&(Pn.subtract(hg,e.node.worldPosition,t.position),n=Pn.dot(hg,t.forward));var i=Fg.alloc();return i.model=e,i.depth=n,i}function kg(e,t,n){var i=t.direction,r=e.normal,a=e.distance+.001,o=1/Pn.dot(r,i),s=i.x*o,c=i.y*o,l=i.z*o,u=r.x,h=r.y,f=r.z,_=e.matLight;_.m00=1-u*s,_.m01=-u*c,_.m02=-u*l,_.m03=0,_.m04=-h*s,_.m05=1-h*c,_.m06=-h*l,_.m07=0,_.m08=-f*s,_.m09=-f*c,_.m10=1-f*l,_.m11=0,_.m12=s*a,_.m13=c*a,_.m14=l*a,_.m15=1,Wn.toArray(n,_,Gd.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Gg(e,t){Pn.normalize(hg,e.normal),t[Gd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=hg.x,t[Gd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=hg.y,t[Gd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=hg.z,t[Gd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function Hg(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var a=i[r];a.baked||(lo.set(vg,a.position.x,a.position.y,a.position.z,a.range),ds.sphereFrustum(vg,t.frustum)&&n.push(a))}for(var o=t.scene.sphereLights,s=0;s<o.length;s++){var c=o[s];c.baked||(lo.set(vg,c.position.x,c.position.y,c.position.z,c.range),ds.sphereFrustum(vg,t.frustum)&&n.push(c))}}function Vg(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,a=r.shadows,o=r.skybox,s=r.renderObjects;Mg.freeArray(s),s.length=0;var c=r.castShadowObjects;Fg.freeArray(c),c.length=0,mg=!1;var l=null;if(a.enabled&&(e.pipelineUBO.updateShadowUBORange(Gd.SHADOW_COLOR_OFFSET,a.shadowColor),a.type===sg.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,Lg.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var a=t.device;if(n.shadowFixedArea){var o=n.shadowOrthoSize,s=n.shadowOrthoSize,c=n.shadowNear,l=n.shadowFar;Wn.fromRT(Eg,n.node.getWorldRotation(),n.node.getWorldPosition()),Wn.invert(Tg,Eg),Wn.ortho(Ag,-o,o,-s,s,c,l,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),Wn.multiply(bg,Ag,Tg),Wn.invert(Cg,Tg),r.matShadowView=Tg,r.matShadowProj=Ag,r.matShadowViewProj=bg,oc.createOrtho(e,2*o,2*s,c,l,Cg)}else{var u=n.shadowInvisibleOcclusionRange,h=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();Wn.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(_g,i),oc.split(yg,i,_g,.1,n.shadowDistance),Sg=oc.clone(yg),Wn.fromRT(Eg,n.node.rotation,Ng),Wn.invert(Tg,Eg),Wn.invert(Cg,Tg);var f=Tg.clone();Sg.transform(Tg),Ys.fromPoints(dg,new Pn(1e7,1e7,1e7),new Pn(-1e7,-1e7,-1e7)),dg.mergeFrustum(Sg);var _=2*dg.halfExtents.z;fg.set(dg.center.x,dg.center.y,dg.center.z+dg.halfExtents.z+u),Pn.transformMat4(fg,fg,Cg),Wn.fromRT(Eg,n.node.rotation,fg),Wn.invert(Tg,Eg),Wn.invert(Cg,Tg);var d=Pn.distance(yg.vertices[0],yg.vertices[6]);gg.center.set(0,0,0),gg.radius=-1,gg.mergePoints(yg.vertices);var p=.8*d+.4*gg.radius;r.shadowCameraFar=_+u;var m=.5*p;if(Wn.ortho(Ag,-m,m,-m,m,.1,r.shadowCameraFar,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),h>0){Wn.multiply(Ig,Ag,f),Pn.transformMat4(Pg,fg,Ig);var v=2/h;Rg.set(v,v);var g=Pg.x%Rg.x,y=Pg.y%Rg.y;Dg.set(Pg.x-g,Pg.y-y,Pg.z),Wn.invert(wg,Ig),Pn.transformMat4(Og,Dg,wg),Wn.fromRT(Eg,n.node.rotation,Og),Wn.invert(Tg,Eg),Wn.invert(Cg,Tg),oc.createOrtho(e,p,p,.1,r.shadowCameraFar,Cg)}else{for(var S=0;S<8;S++)e.vertices[S].set(0,0,0);e.updatePlanes()}Wn.multiply(bg,Ag,Tg),r.matShadowView=Tg,r.matShadowProj=Ag,r.matShadowViewProj=bg}}(xg,e,i,t,a);else{for(var u=0;u<8;u++)xg.vertices[u].set(0,0,0);xg.updatePlanes()}i&&a.type===sg.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,a=n.distance+.001,o=1/Pn.dot(r,i),s=i.x*o,c=i.y*o,l=i.z*o,u=r.x,h=r.y,f=r.z,_=n.matLight;_.m00=1-u*s,_.m01=-u*c,_.m02=-u*l,_.m03=0,_.m04=-h*s,_.m05=1-h*c,_.m06=-h*l,_.m07=0,_.m08=-f*s,_.m09=-f*c,_.m10=1-f*l,_.m11=0,_.m12=s*a,_.m13=c*a,_.m14=l*a,_.m15=1,e.pipelineUBO.updateShadowUBORange(Gd.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),o.enabled&&o.model&&t.clearFlag&ig&&s.push(Bg(o.model,t));for(var h=n.models,f=t.visibility,_=0;_<h.length;_++){var d=h[_];if(d.enabled&&(d.castShadow&&c.push(Ug(d,t)),a.firstSetCSM&&d.worldBounds&&(mg||(pg.copy(d.worldBounds),mg=!0),Ys.merge(pg,pg,d.worldBounds)),d.node&&(f&d.node.layer)===d.node.layer||f&d.visFlags)){if(null!=l&&d.castShadow&&d.worldBounds&&ds.aabbFrustum(d.worldBounds,xg)&&l.push(zg(d,t)),d.worldBounds&&!ds.aabbFrustum(d.worldBounds,t.frustum))continue;s.push(Bg(d,t))}}}var Wg,jg=new Er(bi.LINEAR,bi.LINEAR,bi.NONE,Ii.CLAMP,Ii.CLAMP,Ii.CLAMP),Xg=new Er(bi.POINT,bi.POINT,bi.NONE,Ii.CLAMP,Ii.CLAMP,Ii.CLAMP),qg=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(jg),this._pointSampler=this._device.getSampler(Xg);var t=new Wr(Pd.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new jr(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new jr(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=wd.UBO_GLOBAL;r<wd.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var a=t.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,Gd.SIZE,Gd.SIZE));i.bindBuffer(Gd.BINDING,a),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},Q(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),Yg=0,Kg={},Qg=new jr(null),Jg=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Cd.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var i=l.director.root;this._device=i.device,Qg.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(Qg);var r=l.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),a=new jr(null);if(a.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(a),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===mv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Cd.DEFAULT,t[0].phase===xv("reflection")){var o=i.mainWindow.width,s=i.mainWindow.height,c=512;s<o?(o=c*o/s,s=c):s=c*s/(o=c),this._reflectionTex=this._device.createTexture(new Sr(Si.TEX2D,xi.STORAGE|xi.TRANSFER_SRC|xi.SAMPLED,_i.RGBA8,o,s)),this.descriptorSet.bindTexture(Rp,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Er(bi.LINEAR,bi.LINEAR,bi.NONE,Ii.CLAMP,Ii.CLAMP,Ii.CLAMP)),this.descriptorSet.bindSampler(Rp,this._reflectionSampler),this.descriptorSet.bindTexture(Np,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=l.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=l.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Cd.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},Q(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?O(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===mv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),Qg.layout=e[0].localSetLayout,this._createDescriptorSet(Qg)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===mv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Zg=new Wn,$g=[{name:"CC_RECEIVE_SHADOW",value:!0}],ey=[{name:"CC_USE_LIGHTMAP",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Wg||(Wg={}));var ty=new Er(bi.LINEAR,bi.LINEAR,bi.NONE,Ii.CLAMP,Ii.CLAMP,Ii.CLAMP),ny=new Er(bi.LINEAR,bi.LINEAR,bi.LINEAR,Ii.CLAMP,Ii.CLAMP,Ii.CLAMP),iy=function(){function e(){this.type=Wg.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(ep.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Zn,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._shadowBias=0,this._shadowNormalBias=0,this._enabled=!0,this._visFlags=Ed.Enum.NONE,this._device=l.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Ed.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var a=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,a[r],a[r+1],a[r+2])}else if(this._localBuffer){Wn.toArray(this._localData,i,ep.MAT_WORLD_OFFSET),Wn.inverseTranspose(Zg,i);var o=Math.abs(Wn.determinant(Zg)),s=1/Math.sqrt(o);Wn.multiplyScalar(Zg,Zg,s),Wn.toArray(this._localData,Zg,ep.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Ys.fromPoints(Ys.create(),e,t),this._worldBounds=Ys.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new Jg},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){Zn.toArray(this._localData,t,ep.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,this.onMacroPatchesStateChanged(),null===e&&(e=Sv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?ny:ty),r=this._subModels,a=0;a<r.length;a++){var o=r[a].descriptorSet;o.bindTexture(Cp,n),o.bindSampler(Cp,i),o.update()}},t.updateLocalShadowBias=function(){var e=this._localData;e[ep.LOCAL_SHADOW_BIAS+0]=this._shadowBias,e[ep.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,e[ep.LOCAL_SHADOW_BIAS+2]=0,e[ep.LOCAL_SHADOW_BIAS+3]=0,this._localDataUpdated=!0},t.getMacroPatches=function(){var e=this.receiveShadow?$g:null;return null!=this._lightmap&&(e=e?e.concat(ey):ey),e},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(fi.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=na[r.format].size)}var a=this.instancedAttributes;a.buffer=new Uint8Array(n),a.views.length=a.attributes.length=0;for(var o=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new Or;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,a.attributes.push(l);var u=na[c.format],h=new(ha(u))(a.buffer.buffer,o,u.count);a.views.push(h),o+=u.size}}t.batchingScheme===mv.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(np)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,ep.SIZE,ep.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,tp.SIZE,tp.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(ep.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(tp.BINDING,this._worldBoundBuffer)},Q(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),ry=function(){function e(){this._groundAlbedoHDR=new Zn(.2,.2,.2,1),this._skyColorHDR=new Zn(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Zn(.2,.2,.2,1),this._skyColorLDR=new Zn(.2,.5,.8,1),this._skyIllumLDR=0,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},Q(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();ry.SUN_ILLUM=65e3,ry.SKY_ILLUM=2e4,l.Ambient=ry;var ay=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var a=i._shaderInfo.blocks[r],o=i._blocks[a.binding],s=i._parent.blocks[a.binding];o.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var f=c._descriptorSet.getSampler(u.binding,h),_=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,f,h),i._descriptorSet.bindTexture(u.binding,_,h)}return e.prototype.tryCompile.call(re(i)),i}Z(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Iv.fillPipelineInfo(this,e),Iv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!tm(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(mv.NONE)},n._onStateChange=function(){this._setHash(Iv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},Q(t,[{key:"parent",get:function(){return this._parent}}]),t}(Iv),oy=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}Z(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=oe(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],a=this._states[i]||(this._states[i]={});for(var o in e)a[o]=e[o];r.overridePipelineStates(n[r.passIndex],a)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=Qv.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new ay(t[n],this));return e},Q(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Qv),sy=null,cy=null,ly=rt({HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2}),uy=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=l.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=Sv.get("default-cube-texture"),this._model||(this._model=l.director.root.createModel(l.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!cy){var n=new Qv;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),cy=new oy({parent:n})}this.enabled&&(sy||(sy=l.utils.createMesh(l.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,sy.renderingSubMeshes[0],cy)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=l.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===i&&t.macros.CC_USE_HDR===r||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=i,t.macros.CC_USE_HDR=r,e.onGlobalPipelineStateChanged()),this.enabled&&cy&&cy.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,cy)},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=l.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),i=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(jd,i),this._globalDSManager.bindTexture(jd,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var a=r.getGFXTexture(),o=e.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(Yd,o),this._globalDSManager.bindTexture(Yd,a)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},Q(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();l.Skybox=uy;var hy=new Zn,fy=rt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),_y=fy.LAYERED+1,dy=function(){function e(){this._fogColor=new In("#C8C8C8"),this._colorArray=new Zn(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:_y},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=l.director.root,t=this.enabled?this.type:_y,n=this.accurate?1:0,i=e.pipeline;i.macros.CC_USE_FOG===t&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=t,i.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},Q(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=_y,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),hy.set(e.x,e.y,e.z,e.w),Dv(this._colorArray,hy)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();l.Fog=dy;var py,my,vy,gy=function(){function e(){this._enabled=!1,this._minPos=new Pn(0,0,0),this._maxPos=new Pn(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},Q(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();function yy(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),a=2*i-8*r+4,o=3*i/a,s=2*r/a,c=1/s*o,l=1/s*(1-o-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(py||(py=e("NodeSpace",{}))),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(my||(my=e("TransformBit",{}))),l.internal.TransformBit=my,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(vy||(vy={}));var Sy,xy,Ey=function(e){return 4*Math.PI*Math.PI*e*e},Ty=function(){function e(){this._baked=!1,this._color=new Pn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new Pn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=vy.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new Pn(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},Q(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,yy(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=my.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Cy=new Pn(0,0,-1),Ay=new Pn,by=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new Pn(1,-1,-1),t._illuminanceHDR=ry.SUN_ILLUM,t._illuminanceLDR=1,t._shadowEnabled=!1,t._shadowPcf=cg.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._shadowSaturation=1,t._shadowDistance=100,t._shadowInvisibleOcclusionRange=200,t._shadowFixedArea=!1,t._shadowNear=.1,t._shadowFar=10,t._shadowOrthoSize=5,t._type=vy.DIRECTIONAL,t}Z(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=ry.SUN_ILLUM,this.direction=new Pn(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=Pn.transformQuat(Ay,Cy,this._node.worldRotation))},Q(t,[{key:"direction",get:function(){return this._dir},set:function(e){Pn.normalize(this._dir,e)}},{key:"illuminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,ug.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,ug.MAX_FAR)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,ug.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e}}]),t}(Ty),Iy=function(e){Z(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=Ys.create(),t._pos=new Pn,t._type=vy.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/Ey(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;Ys.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},Q(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(Ty),wy=new Pn(0,0,-1),Py=new Fn,Ry=new Wn,Dy=new Wn,Oy=new Wn,Ny=new Wn,My=function(e){Z(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new Pn(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._shadowEnabled=!1,t._shadowPcf=cg.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._aabb=Ys.create(),t._frustum=oc.create(),t._pos=new Pn,t._type=vy.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.luminanceHDR=1700/Ey(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new Pn(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Pn.transformQuat(this._dir,wy,this._node.getWorldRotation(Py)),Pn.normalize(this._dir,this._dir),Ys.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Ry),Wn.invert(Ry,Ry),Wn.perspective(Dy,this._angle,1,.001,this._range),Wn.multiply(Oy,Dy,Ry),this._frustum.update(Oy,Ny),this._needUpdate=!1)},Q(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}}]),n}(Ty),Ly=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,a=0;a<r.length;a++)r[a].update();for(var o=this._models,s=0;s<o.length;s++){var c=o[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=oe(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=my.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=oe(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=oe(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._destroy=function(){},t._createNativeObject=function(){},Q(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Fy=Object.freeze({__proto__:null,get CameraFOVAxis(){return Wv},get CameraProjection(){return jv},get CameraAperture(){return Xv},get CameraISO(){return qv},get CameraShutter(){return Yv},SKYBOX_FLAG:ig,Camera:ag,get ModelType(){return Wg},Model:iy,SubModel:Jg,Ambient:ry,EnvironmentLightingType:ly,Skybox:uy,ShadowSize:og,ShadowType:sg,PCFType:cg,Shadows:ug,FogType:fy,Fog:dy,Octree:gy,ColorTemperatureToRGB:yy,get LightType(){return vy},nt2lm:Ey,Light:Ty,DirectionalLight:by,SphereLight:Iy,SpotLight:My,RenderScene:Ly});function By(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function zy(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(Sy||(Sy={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(xy||(xy={}));var Uy=function(){function e(e){this._device=void 0,this._format=_i.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new lr,this._region1=new lr,this._region2=new lr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=na[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=ha(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=zy(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var a=this._chunks[n];a.start+=e;var o={chunkIdx:n,start:i,end:i+e,texture:a.texture};return this._handles.push(o),o}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,By(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;T("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new Sr(Si.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,o=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-o,a),l=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),o=0,s+=1,a-=c,l+=c),a>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=s,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=a,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),o=0,s+=this._region1.texExtent.height,a-=c,l+=c),a>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=s,this._region2.texExtent.width=a,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,a*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var a=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),o=0;o<a.length;o++){var s=a[o];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=zy(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var a={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(a),a}}var o=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,By(o)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}();k(Ly.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),k(Ly.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var ky={};k(ky,"CameraVisFlags",[{name:"GENERAL"}]),U(ky,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Ed.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Ed.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Ed.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Ed.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Ed.BitMask,targetName:"UI_2D"}]),l.CameraVisFlags=ky;var Gy={};k(Gy,"VisibilityFlags",[{name:"GENERAL"}]),U(Gy,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Ed.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Ed.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Ed.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Ed.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Ed.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Ed.Enum,targetName:"UI_2D"}]),l.VisibilityFlags=Gy,U(Iv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),k(ag.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),k(ug.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),k(My.prototype,"SpotLight.prototype",[{name:"aspect"}]);var Hy=function(e){if(void 0===Kg[e]){var t=1<<Yg;Kg[e]=t,Yg+=1}},Vy=Object.freeze({__proto__:null,addStage:Hy,scene:Fy,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var a=[];a.push(new Or($i.ATTR_POSITION,_i.RGB32F)),t.normals&&a.push(new Or($i.ATTR_NORMAL,_i.RGB32F)),t.uvs&&a.push(new Or($i.ATTR_TEX_COORD,_i.RG32F)),t.colors&&a.push(new Or($i.ATTR_COLOR,_i.RGB32F));var o=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,4*n.length,4*n.length/i));o.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new Mr(a,[o],s))},get RenderQueue(){return Sy},get PassStage(){return xy},genHandle:jp,getTypeFromHandle:Xp,getBindingFromHandle:qp,getCountFromHandle:Yp,getOffsetFromHandle:Kp,customizeType:Qp,type2reader:Jp,type2writer:Zp,getDefaultFromType:em,overrideMacros:tm,get BatchingSchemes(){return mv},Pass:Iv,getDeviceShaderVersion:cm,programLib:vm,nearestPOT:By,TextureBufferPool:Uy,MaterialInstance:oy,PassInstance:ay,get PoolType(){return ws},NULL_HANDLE:0,get NodeView(){return Ps},NodePool:Ms,get PassView(){return Ds},PassPool:zs,get AABBView(){return Ls},AABBPool:Gs,RenderScene:Ly,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null,NativeGeometryRenderer:null,CameraVisFlags:ky,VisibilityFlags:Gy});e("renderer",Vy);var Wy,jy=new Pn,Xy=new Pn,qy=new Pn,Yy=new Pn,Ky=new Pn,Qy=new Pn,Jy=new Pn,Zy=new Pn,$y=new Pn,eS=new Pn;!function(e){e[e.LINE=0]="LINE",e[e.DASHED_LINE=1]="DASHED_LINE",e[e.TRIANGLE=2]="TRIANGLE"}(Wy||(Wy={}));var tS,nS,iS,rS,aS,oS,sS,cS,lS,uS,hS=function(){function e(){this._maxVertices=0,this._vertexCount=0,this._stride=0}var t=e.prototype;return t.init=function(e,t,n,i){this._maxVertices=t,this._vertexCount=0,this._stride=n,this._vertices=new Float32Array(t*n/Float32Array.BYTES_PER_ELEMENT),this._buffer=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,t*n,n)),this._inputAssembler=e.createInputAssembler(new Mr(i,[this._buffer],null))},t.empty=function(){return 0===this._vertexCount},t.reset=function(){this._vertexCount=0},t.update=function(){if(!this.empty()){var e=Math.min(this._vertexCount,this._maxVertices)*this._stride;this._buffer.update(this._vertices,e)}},t.destroy=function(){this._inputAssembler&&this._inputAssembler.destroy(),this._buffer&&this._buffer.destroy()},e}(),fS=function(){this.lines=[],this.dashedLines=[],this.triangles=[];for(var e=0;e<2;e++)this.lines[e]=new hS,this.dashedLines[e]=new hS,this.triangles[e]=new hS},_S=function(){function e(){this._device=null,this._pipeline=null,this._buffers=void 0,this._nativeObj=null,this._buffers=new fS}var t=e.prototype;return t.activate=function(e,t,n){this._device=e,this._pipeline=t;for(var i=[new Or($i.ATTR_POSITION,_i.RGB32F),new Or($i.ATTR_COLOR,_i.RGBA32F)],r=[new Or($i.ATTR_POSITION,_i.RGB32F),new Or($i.ATTR_NORMAL,_i.RGBA32F),new Or($i.ATTR_COLOR,_i.RGBA32F)],a=n?n.maxLines:1e5,o=n?n.maxDashedLines:1e4,s=n?n.maxTriangles:1e4,c=Float32Array.BYTES_PER_ELEMENT*(Pn.length+In.length),l=Float32Array.BYTES_PER_ELEMENT*(Pn.length+Zn.length+In.length),u=0;u<2;u++)this._buffers.lines[u].init(this._device,2*a,c,i),this._buffers.dashedLines[u].init(this._device,2*o,c,i),this._buffers.triangles[u].init(this._device,3*s,l,r)},t.flush=function(){},t.render=function(e,t){this.update();for(var n=this._pipeline.pipelineSceneData.geometryRendererPasses,i=this._pipeline.pipelineSceneData.geometryRendererShaders,r=0,a=[1,2],o=0;o<2;o++){var s=this._buffers.lines[o];if(!s.empty()){var c=new vr;c.vertexCount=s._vertexCount;for(var l=0;l<a[o];l++){var u=n[r+l],h=i[r+l],f=wv.getOrCreatePipelineState(this._device,u,h,e,s._inputAssembler);t.bindPipelineState(f),t.bindDescriptorSet(Md.MATERIAL,u.descriptorSet),t.bindInputAssembler(s._inputAssembler),t.draw(c)}}r+=a[o]}for(var _=0;_<2;_++){var d=this._buffers.dashedLines[_];if(!d.empty()){var p=new vr;p.vertexCount=d._vertexCount;for(var m=0;m<a[_];m++){var v=n[r+m],g=i[r+m],y=wv.getOrCreatePipelineState(this._device,v,g,e,d._inputAssembler);t.bindPipelineState(y),t.bindDescriptorSet(Md.MATERIAL,v.descriptorSet),t.bindInputAssembler(d._inputAssembler),t.draw(p)}}r+=a[_]}for(var S=0;S<2;S++){var x=this._buffers.triangles[S];if(!x.empty()){var E=new vr;E.vertexCount=x._vertexCount;for(var T=0;T<a[S];T++){var C=n[r+T],A=i[r+T],b=wv.getOrCreatePipelineState(this._device,C,A,e,x._inputAssembler);t.bindPipelineState(b),t.bindDescriptorSet(Md.MATERIAL,C.descriptorSet),t.bindInputAssembler(x._inputAssembler),t.draw(E)}}r+=a[S]}this.reset()},t.destroy=function(){for(var e=0;e<2;e++)this._buffers.lines[e].destroy(),this._buffers.dashedLines[e].destroy(),this._buffers.triangles[e].destroy()},t.empty=function(){for(var e=0;e<2;e++)if(!this._buffers.lines[e].empty()||!this._buffers.dashedLines[e].empty()||!this._buffers.triangles[e].empty())return!1;return!0},t.update=function(){for(var e=0;e<2;e++)this._buffers.lines[e].update(),this._buffers.dashedLines[e].update(),this._buffers.triangles[e].update()},t.reset=function(){for(var e=0;e<2;e++)this._buffers.lines[e].reset(),this._buffers.dashedLines[e].reset(),this._buffers.triangles[e].reset()},t.addDashedLine=function(e,t,n,i){void 0===i&&(i=!0);var r=this._buffers.dashedLines[i?1:0];if(r._vertexCount+2>r._maxVertices)R(12008);else{var a=r._vertexCount*(Pn.length+In.length);Pn.toArray(r._vertices,e,a),a+=Pn.length,In.toArray(r._vertices,n,a),a+=In.length,Pn.toArray(r._vertices,t,a),a+=Pn.length,In.toArray(r._vertices,n,a),r._vertexCount+=2}},t.addLine=function(e,t,n,i){void 0===i&&(i=!0);var r=this._buffers.lines[i?1:0];if(r._vertexCount+2>r._maxVertices)R(12008);else{var a=r._vertexCount*(Pn.length+In.length);Pn.toArray(r._vertices,e,a),a+=Pn.length,In.toArray(r._vertices,n,a),a+=In.length,Pn.toArray(r._vertices,t,a),a+=Pn.length,In.toArray(r._vertices,n,a),r._vertexCount+=2}},t.addTriangle=function(e,t,n,i,r,a,o){if(void 0===r&&(r=!0),void 0===a&&(a=!0),void 0===o&&(o=!1),r)return this.addLine(e,t,i,a),this.addLine(t,n,i,a),void this.addLine(n,e,i,a);var s=this._buffers.triangles[a?1:0];if(s._vertexCount+3>s._maxVertices)R(12009);else{var c=new Zn(Zn.ZERO);if(!o){var l=new Pn(t.x-e.x,t.y-e.y,t.z-e.z),u=new Pn(n.x-e.x,n.y-e.y,n.z-e.z),h=new Pn;Pn.normalize(h,Pn.cross(h,l,u)),c.set(h.x,h.y,h.z,1)}var f=s._vertexCount*(Pn.length+Zn.length+In.length);Pn.toArray(s._vertices,e,f),f+=Pn.length,Zn.toArray(s._vertices,c,f),f+=Zn.length,In.toArray(s._vertices,i,f),f+=In.length,Pn.toArray(s._vertices,t,f),f+=Pn.length,Zn.toArray(s._vertices,c,f),f+=Zn.length,In.toArray(s._vertices,i,f),f+=In.length,Pn.toArray(s._vertices,n,f),f+=Pn.length,Zn.toArray(s._vertices,c,f),f+=Zn.length,In.toArray(s._vertices,i,f),s._vertexCount+=3}},t.addQuad=function(e,t,n,i,r,a,o,s){void 0===a&&(a=!0),void 0===o&&(o=!0),void 0===s&&(s=!1),a?(this.addLine(e,t,r,o),this.addLine(t,n,r,o),this.addLine(n,i,r,o),this.addLine(i,e,r,o)):(this.addTriangle(e,t,n,r,a,o,s),this.addTriangle(e,n,i,r,a,o,s))},t.addBoundingBox=function(e,t,n,i,r,a,o){void 0===n&&(n=!0),void 0===i&&(i=!0),void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===o&&(o=new Wn),jy.set(e.center.x-e.halfExtents.x,e.center.y-e.halfExtents.y,e.center.z-e.halfExtents.z),Xy.set(e.center.x+e.halfExtents.x,e.center.y+e.halfExtents.y,e.center.z+e.halfExtents.z),qy.set(jy.x,jy.y,jy.z),Yy.set(Xy.x,jy.y,jy.z),Ky.set(jy.x,Xy.y,jy.z),Qy.set(Xy.x,Xy.y,jy.z),Jy.set(jy.x,jy.y,Xy.z),Zy.set(Xy.x,jy.y,Xy.z),$y.set(jy.x,Xy.y,Xy.z),eS.set(Xy.x,Xy.y,Xy.z),a&&(Pn.transformMat4(qy,qy,o),Pn.transformMat4(Yy,Yy,o),Pn.transformMat4(Ky,Ky,o),Pn.transformMat4(Qy,Qy,o),Pn.transformMat4(Jy,Jy,o),Pn.transformMat4(Zy,Zy,o),Pn.transformMat4($y,$y,o),Pn.transformMat4(eS,eS,o)),n?(this.addLine($y,eS,t,i),this.addLine(eS,Qy,t,i),this.addLine(Qy,Ky,t,i),this.addLine(Ky,$y,t,i),this.addLine(Jy,Zy,t,i),this.addLine(Zy,Yy,t,i),this.addLine(Yy,qy,t,i),this.addLine(qy,Jy,t,i),this.addLine($y,Jy,t,i),this.addLine(eS,Zy,t,i),this.addLine(Qy,Yy,t,i),this.addLine(Ky,qy,t,i)):(this.addQuad(Jy,Zy,eS,$y,t,n,i,r),this.addQuad(Zy,Yy,Qy,eS,t,n,i,r),this.addQuad(Yy,qy,Ky,Qy,t,n,i,r),this.addQuad(qy,Jy,$y,Ky,t,n,i,r),this.addQuad($y,eS,Qy,Ky,t,n,i,r),this.addQuad(qy,Yy,Zy,Jy,t,n,i,r))},t.addCross=function(e,t,n,i){void 0===i&&(i=!0);var r=.5*t,a=new Pn(e.x-r,e.y,e.z),o=new Pn(e.x+r,e.y,e.z);this.addLine(a,o,n,i),a.set(e.x,e.y-r,e.z),o.set(e.x,e.y+r,e.z),this.addLine(a,o,n,i),a.set(e.x,e.y,e.z-r),o.set(e.x,e.y,e.z+r),this.addLine(a,o,n,i)},t.addFrustum=function(e,t,n){void 0===n&&(n=!0);var i=e.vertices;this.addLine(i[0],i[1],t,n),this.addLine(i[1],i[2],t,n),this.addLine(i[2],i[3],t,n),this.addLine(i[3],i[0],t,n),this.addLine(i[4],i[5],t,n),this.addLine(i[5],i[6],t,n),this.addLine(i[6],i[7],t,n),this.addLine(i[7],i[4],t,n),this.addLine(i[0],i[4],t,n),this.addLine(i[1],i[5],t,n),this.addLine(i[2],i[6],t,n),this.addLine(i[3],i[7],t,n)},t.addCapsule=function(e,t,n,i,r,a,o,s,c,l,u){void 0===r&&(r=32),void 0===a&&(a=8),void 0===o&&(o=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new Wn);for(var h=2*Math.PI/r,f=Math.PI/2/a,_=new Pn(e.x,e.y-n/2,e.z),d=new Pn(e.x,e.y+n/2,e.z),p=new Array,m=new Array,v=0;v<a+1;v++){for(var g=new Array,y=new Array,S=v*f,x=Math.sin(S),E=Math.cos(S),T=0;T<r+1;T++){var C=T*h,A=Math.sin(C),b=Math.cos(C),I=new Pn(t*x*b,t*E,t*x*A),w=new Pn(_.x+I.x,_.y-I.y,_.z+I.z),P=new Pn(d.x+I.x,d.y+I.y,d.z+I.z);g.push(w),y.push(P)}p.push(g),m.push(y)}if(l)for(var R=0;R<a+1;R++)for(var D=0;D<r+1;D++)Pn.transformMat4(p[R][D],p[R][D],u),Pn.transformMat4(m[R][D],m[R][D],u);for(var O=0;O<a;O++)for(var N=0;N<r;N++)this.addTriangle(p[O+1][N],p[O][N+1],p[O][N],i,o,s,c),this.addTriangle(p[O+1][N],p[O+1][N+1],p[O][N+1],i,o,s,c),this.addTriangle(m[O][N],m[O+1][N+1],m[O+1][N],i,o,s,c),this.addTriangle(m[O][N],m[O][N+1],m[O+1][N+1],i,o,s,c);for(var M=p[a],L=m[a],F=0;F<r;F++)this.addTriangle(L[F],M[F+1],M[F],i,o,s,c),this.addTriangle(L[F],L[F+1],M[F+1],i,o,s,c)},t.addCylinder=function(e,t,n,i,r,a,o,s,c,l){void 0===r&&(r=32),void 0===a&&(a=!0),void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new Wn);for(var u=2*Math.PI/r,h=new Pn(e.x,e.y-n/2,e.z),f=new Pn(e.x,e.y+n/2,e.z),_=new Array,d=new Array,p=0;p<r+1;p++){var m=p*u,v=new Pn(t*Math.cos(m),0,t*Math.sin(m)),g=new Pn(v.x+h.x,v.y+h.y,v.z+h.z),y=new Pn(v.x+f.x,v.y+f.y,v.z+f.z);_.push(g),d.push(y)}if(c){Pn.transformMat4(h,h,l),Pn.transformMat4(f,f,l);for(var S=0;S<r+1;S++)Pn.transformMat4(_[S],_[S],l),Pn.transformMat4(d[S],d[S],l)}for(var x=0;x<r;x++)this.addTriangle(f,d[x+1],d[x],i,a,o,s),this.addTriangle(h,_[x],_[x+1],i,a,o,s),this.addTriangle(d[x],_[x+1],_[x],i,a,o,s),this.addTriangle(d[x],d[x+1],_[x+1],i,a,o,s)},t.addCone=function(e,t,n,i,r,a,o,s,c,l){void 0===r&&(r=32),void 0===a&&(a=!0),void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new Wn);for(var u=2*Math.PI/r,h=new Pn(e.x,e.y-n/2,e.z),f=new Pn(e.x,e.y+n/2,e.z),_=new Array,d=0;d<r+1;d++){var p=new Pn(t*Math.cos(d*u),0,t*Math.sin(d*u)),m=new Pn(p.x+h.x,p.y+h.y,p.z+h.z);_.push(m)}if(c){Pn.transformMat4(h,h,l),Pn.transformMat4(f,f,l);for(var v=0;v<r+1;v++)Pn.transformMat4(_[v],_[v],l)}for(var g=0;g<r;g++)this.addTriangle(f,_[g+1],_[g],i,a,o,s),this.addTriangle(h,_[g],_[g+1],i,a,o,s)},t.addCircle=function(e,t,n,i,r,a,o){void 0===i&&(i=32),void 0===r&&(r=!0),void 0===a&&(a=!1),void 0===o&&(o=new Wn);for(var s=2*Math.PI/i,c=new Array,l=0;l<i+1;l++){var u=new Pn(t*Math.cos(l*s),0,t*Math.sin(l*s)),h=new Pn(u.x+e.x,u.y+e.y,u.z+e.z);c.push(h)}if(a)for(var f=0;f<i+1;f++)Pn.transformMat4(c[f],c[f],o);for(var _=0;_<i;_++)this.addLine(c[_],c[_+1],n,r)},t.addArc=function(e,t,n,i,r,a,o,s,c){void 0===a&&(a=32),void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===c&&(c=new Wn);for(var l=hn(i),u=(hn(r)-l)/a,h=new Array,f=0;f<a+1;f++){var _=new Pn(t*Math.cos(f*u+l),0,t*Math.sin(f*u+l)),d=new Pn(_.x+e.x,_.y+e.y,_.z+e.z);h.push(d)}if(s)for(var p=0;p<a+1;p++)Pn.transformMat4(h[p],h[p],c);for(var m=0;m<a;m++)this.addLine(h[m],h[m+1],n,o)},t.addPolygon=function(e,t,n,i,r,a,o,s,c){void 0===i&&(i=6),void 0===r&&(r=!0),void 0===a&&(a=!0),void 0===o&&(o=!1),void 0===s&&(s=!1),void 0===c&&(c=new Wn),r?this.addCircle(e,t,n,i,a,s,c):this.addDisc(e,t,n,i,r,a,o,s,c)},t.addDisc=function(e,t,n,i,r,a,o,s,c){void 0===i&&(i=32),void 0===r&&(r=!0),void 0===a&&(a=!0),void 0===o&&(o=!1),void 0===s&&(s=!1),void 0===c&&(c=new Wn);for(var l=2*Math.PI/i,u=new Array,h=new Pn(e),f=0;f<i+1;f++){var _=new Pn(t*Math.cos(f*l),0,t*Math.sin(f*l)),d=new Pn(_.x+h.x,_.y+h.y,_.z+h.z);u.push(d)}if(s){Pn.transformMat4(h,h,c);for(var p=0;p<i+1;p++)Pn.transformMat4(u[p],u[p],c)}for(var m=0;m<i;m++)this.addTriangle(h,u[m],u[m+1],n,r,a,o);if(!r)for(var v=0;v<i;v++)this.addTriangle(h,u[v+1],u[v],n,r,a,o)},t.addSector=function(e,t,n,i,r,a,o,s,c,l,u){void 0===a&&(a=32),void 0===o&&(o=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new Wn);for(var h=hn(i),f=(hn(r)-h)/a,_=new Array,d=new Pn(e),p=0;p<a+1;p++){var m=new Pn(t*Math.cos(p*f),0,t*Math.sin(p*f)),v=new Pn(m.x+d.x,m.y+d.y,m.z+d.z);_.push(v)}if(l){Pn.transformMat4(d,d,u);for(var g=0;g<a+1;g++)Pn.transformMat4(_[g],_[g],u)}for(var y=0;y<a;y++)this.addTriangle(d,_[y],_[y+1],n,o,s,c);if(!o)for(var S=0;S<a;S++)this.addTriangle(d,_[S+1],_[S],n,o,s,c)},t.addSphere=function(e,t,n,i,r,a,o,s,c,l){void 0===i&&(i=32),void 0===r&&(r=16),void 0===a&&(a=!0),void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new Wn);for(var u=2*Math.PI/i,h=Math.PI/r,f=new Array,_=0;_<r+1;_++){for(var d=new Array,p=_*h,m=Math.sin(p),v=Math.cos(p),g=0;g<i+1;g++){var y=g*u,S=Math.sin(y),x=Math.cos(y),E=new Pn(t*m*x,t*v,t*m*S),T=new Pn(e.x+E.x,e.y+E.y,e.z+E.z);d.push(T)}f.push(d)}if(c)for(var C=0;C<r+1;C++)for(var A=0;A<i+1;A++)Pn.transformMat4(f[C][A],f[C][A],l);for(var b=0;b<r;b++)for(var I=0;I<i;I++)this.addTriangle(f[b][I],f[b+1][I+1],f[b+1][I],n,a,o,s),this.addTriangle(f[b][I],f[b][I+1],f[b+1][I+1],n,a,o,s)},t.addTorus=function(e,t,n,i,r,a,o,s,c,l,u){void 0===r&&(r=32),void 0===a&&(a=16),void 0===o&&(o=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new Wn);for(var h=2*Math.PI/r,f=2*Math.PI/a,_=new Array,d=0;d<r+1;d++){for(var p=new Array,m=d*h,v=Math.sin(m),g=Math.cos(m),y=0;y<a+1;y++){var S=y*f,x=Math.sin(S),E=Math.cos(S),T=new Pn((t+n*E)*g,n*x,(t+n*E)*v),C=new Pn(e.x+T.x,e.y+T.y,e.z+T.z);p.push(C)}_.push(p)}if(l)for(var A=0;A<r+1;A++)for(var b=0;b<a+1;b++)Pn.transformMat4(_[A][b],_[A][b],u);for(var I=0;I<r;I++)for(var w=0;w<a;w++)this.addTriangle(_[I][w+1],_[I+1][w],_[I][w],i,o,s,c),this.addTriangle(_[I][w+1],_[I+1][w+1],_[I+1][w],i,o,s,c)},t.addOctahedron=function(e,t,n,i,r,a,o,s){void 0===i&&(i=!0),void 0===r&&(r=!0),void 0===a&&(a=!1),void 0===o&&(o=!1),void 0===s&&(s=new Wn);var c=new Array;if(c.push(new Pn(t+e.x,e.y,e.z)),c.push(new Pn(e.x,e.y,e.z-t)),c.push(new Pn(-t+e.x,e.y,e.z)),c.push(new Pn(e.x,e.y,e.z+t)),c.push(new Pn(e.x,e.y+t,e.z)),c.push(new Pn(e.x,e.y-t,e.z)),o)for(var l=0;l<c.length;l++)Pn.transformMat4(c[l],c[l],s);i?(this.addLine(c[0],c[1],n,r),this.addLine(c[1],c[2],n,r),this.addLine(c[2],c[3],n,r),this.addLine(c[3],c[0],n,r),this.addLine(c[0],c[4],n,r),this.addLine(c[1],c[4],n,r),this.addLine(c[2],c[4],n,r),this.addLine(c[3],c[4],n,r),this.addLine(c[0],c[5],n,r),this.addLine(c[1],c[5],n,r),this.addLine(c[2],c[5],n,r),this.addLine(c[3],c[5],n,r)):(this.addTriangle(c[0],c[1],c[4],n,i,r,a),this.addTriangle(c[1],c[2],c[4],n,i,r,a),this.addTriangle(c[2],c[3],c[4],n,i,r,a),this.addTriangle(c[3],c[0],c[4],n,i,r,a),this.addTriangle(c[0],c[3],c[5],n,i,r,a),this.addTriangle(c[3],c[2],c[5],n,i,r,a),this.addTriangle(c[2],c[1],c[5],n,i,r,a),this.addTriangle(c[1],c[0],c[5],n,i,r,a))},t.addBezier=function(e,t,n,i,r,a,o,s,c){void 0===a&&(a=32),void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===c&&(c=new Wn);var l=1/a,u=new Array,h=new Pn(e),f=new Pn(t),_=new Pn(n),d=new Pn(i);s&&(Pn.transformMat4(h,h,c),Pn.transformMat4(f,f,c),Pn.transformMat4(_,_,c),Pn.transformMat4(d,d,c));for(var p=0;p<a+1;p++){var m=p*l,v=(1-m)*(1-m)*(1-m),g=3*m*(1-m)*(1-m),y=3*m*m*(1-m),S=m*m*m,x=new Pn(v*h.x+g*f.x+y*_.x+S*d.x,v*h.y+g*f.y+y*_.y+S*d.y,v*h.z+g*f.z+y*_.z+S*d.z);u.push(x)}for(var E=0;E<a;E++)this.addLine(u[E],u[E+1],r,o)},t.addMesh=function(e,t,n,i,r,a){void 0===i&&(i=!0),void 0===r&&(r=!1),void 0===a&&(a=new Wn);for(var o=0;o<t.length;o+=3){var s=new Pn(e.x+t[o].x,e.y+t[o].y,e.z+t[o].z),c=new Pn(e.x+t[o+1].x,e.y+t[o+1].y,e.z+t[o+1].z),l=new Pn(e.x+t[o+2].x,e.y+t[o+2].y,e.z+t[o+2].z);r&&(Pn.transformMat4(s,s,a),Pn.transformMat4(c,c,a),Pn.transformMat4(l,l,a)),this.addLine(s,c,n,i),this.addLine(c,l,n,i),this.addLine(l,s,n,i)}},t.addIndexedMesh=function(e,t,n,i,r,a,o){void 0===r&&(r=!0),void 0===a&&(a=!1),void 0===o&&(o=new Wn);for(var s=0;s<n.length;s+=3){var c=new Pn(e.x+t[n[s]].x,e.y+t[n[s]].y,e.z+t[n[s]].z),l=new Pn(e.x+t[n[s+1]].x,e.y+t[n[s+1]].y,e.z+t[n[s+1]].z),u=new Pn(e.x+t[n[s+2]].x,e.y+t[n[s+2]].y,e.z+t[n[s+2]].z);a&&(Pn.transformMat4(c,c,o),Pn.transformMat4(l,l,o),Pn.transformMat4(u,u,o)),this.addLine(c,l,i,r),this.addLine(l,u,i,r),this.addLine(u,c,i,r)}},Q(e,[{key:"native",get:function(){return this._nativeObj}}]),e}(),dS=new Wn,pS=new Wn,mS=new Wn,vS=new Zn,gS=new Zn(0,0,1,0),yS=function(){function e(){this._globalUBO=new Float32Array(Ud.COUNT),this._cameraUBO=new Float32Array(kd.COUNT),this._shadowUBO=new Float32Array(Gd.COUNT)}e.updateGlobalUBOView=function(e,t){var n=l.director.root,i=t,r=Math.floor(e.width),a=Math.floor(e.height);i[Ud.TIME_OFFSET]=n.cumulativeTime,i[Ud.TIME_OFFSET+1]=n.frameTime,i[Ud.TIME_OFFSET+2]=l.director.getTotalFrames(),i[Ud.SCREEN_SIZE_OFFSET]=r,i[Ud.SCREEN_SIZE_OFFSET+1]=a,i[Ud.SCREEN_SIZE_OFFSET+2]=1/r,i[Ud.SCREEN_SIZE_OFFSET+3]=1/a,i[Ud.NATIVE_SIZE_OFFSET]=r,i[Ud.NATIVE_SIZE_OFFSET+1]=a,i[Ud.NATIVE_SIZE_OFFSET+2]=1/i[Ud.NATIVE_SIZE_OFFSET],i[Ud.NATIVE_SIZE_OFFSET+3]=1/i[Ud.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var i,r=(n.scene?n.scene:l.director.getScene().renderScene).mainLight,a=e.pipelineSceneData,o=a.ambient,s=a.skybox,c=a.fog,u=a.shadows,h=t,f=n.exposure,_=a.isHDR;if(h[kd.SCREEN_SCALE_OFFSET]=a.shadingScale,h[kd.SCREEN_SCALE_OFFSET+1]=a.shadingScale,h[kd.SCREEN_SCALE_OFFSET+2]=1/h[kd.SCREEN_SCALE_OFFSET],h[kd.SCREEN_SCALE_OFFSET+3]=1/h[kd.SCREEN_SCALE_OFFSET+1],h[kd.EXPOSURE_OFFSET]=f,h[kd.EXPOSURE_OFFSET+1]=1/f,h[kd.EXPOSURE_OFFSET+2]=_?1:0,h[kd.EXPOSURE_OFFSET+3]=1/ag.standardExposureValue,r){var d=r.shadowEnabled&&u.type===sg.ShadowMap?1:0,p=r.direction;if(gS.set(p.x,p.y,p.z,d),Zn.toArray(h,gS,kd.MAIN_LIT_DIR_OFFSET),Pn.toArray(h,r.color,kd.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var m=r.colorTemperatureRGB;h[kd.MAIN_LIT_COLOR_OFFSET]*=m.x,h[kd.MAIN_LIT_COLOR_OFFSET+1]*=m.y,h[kd.MAIN_LIT_COLOR_OFFSET+2]*=m.z}h[kd.MAIN_LIT_COLOR_OFFSET+3]=_?r.illuminance*f:r.illuminance}else gS.set(0,0,1,0),Zn.toArray(h,gS,kd.MAIN_LIT_DIR_OFFSET),Zn.toArray(h,Zn.ZERO,kd.MAIN_LIT_COLOR_OFFSET);var v=o.skyColor;v.w=_?o.skyIllum*f:o.skyIllum,h[kd.AMBIENT_SKY_OFFSET+0]=v.x,h[kd.AMBIENT_SKY_OFFSET+1]=v.y,h[kd.AMBIENT_SKY_OFFSET+2]=v.z,h[kd.AMBIENT_SKY_OFFSET+3]=v.w,h[kd.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,h[kd.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,h[kd.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,h[kd.AMBIENT_GROUND_OFFSET+3]=s.envmap?null===(i=s.envmap)||void 0===i?void 0:i.mipmapLevel:1,Wn.toArray(h,n.matView,kd.MAT_VIEW_OFFSET),Wn.toArray(h,n.node.worldMatrix,kd.MAT_VIEW_INV_OFFSET),Pn.toArray(h,n.position,kd.CAMERA_POS_OFFSET),Wn.toArray(h,n.matProj,kd.MAT_PROJ_OFFSET),Wn.toArray(h,n.matProjInv,kd.MAT_PROJ_INV_OFFSET),Wn.toArray(h,n.matViewProj,kd.MAT_VIEW_PROJ_OFFSET),Wn.toArray(h,n.matViewProjInv,kd.MAT_VIEW_PROJ_INV_OFFSET),h[kd.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var g=c.colorArray;h[kd.GLOBAL_FOG_COLOR_OFFSET]=g.x,h[kd.GLOBAL_FOG_COLOR_OFFSET+1]=g.y,h[kd.GLOBAL_FOG_COLOR_OFFSET+2]=g.z,h[kd.GLOBAL_FOG_COLOR_OFFSET+3]=g.z,h[kd.GLOBAL_FOG_BASE_OFFSET]=c.fogStart,h[kd.GLOBAL_FOG_BASE_OFFSET+1]=c.fogEnd,h[kd.GLOBAL_FOG_BASE_OFFSET+2]=c.fogDensity,h[kd.GLOBAL_FOG_ADD_OFFSET]=c.fogTop,h[kd.GLOBAL_FOG_ADD_OFFSET+1]=c.fogRange,h[kd.GLOBAL_FOG_ADD_OFFSET+2]=c.fogAtten,h[kd.NEAR_FAR_OFFSET]=n.nearClip,h[kd.NEAR_FAR_OFFSET+1]=n.farClip,h[kd.VIEW_PORT_OFFSET]=a.shadingScale*n.window.width*n.viewport.x,h[kd.VIEW_PORT_OFFSET+1]=a.shadingScale*n.window.height*n.viewport.y,h[kd.VIEW_PORT_OFFSET+2]=a.shadingScale*n.window.width*n.viewport.z,h[kd.VIEW_PORT_OFFSET+3]=a.shadingScale*n.window.height*n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,a=e.pipelineSceneData.shadows,o=t;if(a.enabled){if(r&&r.shadowEnabled&&a.type===sg.ShadowMap){var s=.1,c=0,l=a.matShadowView,u=a.matShadowProj,h=a.matShadowViewProj;r.shadowFixedArea?(s=r.shadowNear,c=r.shadowFar):(s=.1,c=a.shadowCameraFar),Wn.toArray(t,l,Gd.MAT_LIGHT_VIEW_OFFSET),o[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Gd.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Gd.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Gd.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Gd.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Wn.toArray(t,h,Gd.MAT_LIGHT_VIEW_PROJ_OFFSET);var f=Gp(i)?0:1;o[Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,o[Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,o[Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,o[Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.shadowSaturation,o[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,o[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,o[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.shadowPcf,o[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.shadowBias,o[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,o[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=f,o[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.shadowNormalBias,o[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&a.type===sg.Planar&&(kg(a,r,o),Gg(a,o));In.toArray(o,a.shadowColor,Gd.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i=e.device,r=e.pipelineSceneData.shadows,a=t,o=Gp(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case vy.DIRECTIONAL:var f=n;f.shadowFixedArea?(s=f.shadowNear,c=f.shadowFar):(s=.1,c=r.shadowCameraFar),Wn.toArray(t,l,Gd.MAT_LIGHT_VIEW_OFFSET),a[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Gd.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Gd.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Gd.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Gd.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Wn.toArray(t,h,Gd.MAT_LIGHT_VIEW_PROJ_OFFSET),vS.set(s,c,0,1-f.shadowSaturation),Zn.toArray(a,vS,Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),vS.set(0,o,f.shadowNormalBias,0),Zn.toArray(a,vS,Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),vS.set(r.size.x,r.size.y,f.shadowPcf,f.shadowBias),Zn.toArray(a,vS,Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);break;case vy.SPOT:var _=n;Wn.invert(dS,n.node.getWorldMatrix()),Wn.toArray(a,dS,Gd.MAT_LIGHT_VIEW_OFFSET),Wn.perspective(pS,n.angle,1,.001,n.range),Wn.multiply(mS,pS,dS),Wn.toArray(a,mS,Gd.MAT_LIGHT_VIEW_PROJ_OFFSET),vS.set(.01,n.range,0,0),Zn.toArray(a,vS,Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),vS.set(1,o,_.shadowNormalBias,0),Zn.toArray(a,vS,Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),vS.set(r.size.x,r.size.y,_.shadowPcf,_.shadowBias),Zn.toArray(a,vS,Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}In.toArray(a,r.shadowColor,Gd.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,Ud.SIZE,Ud.SIZE));n.bindBuffer(Ud.BINDING,i);var r=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,kd.SIZE,kd.SIZE));n.bindBuffer(kd.BINDING,r);var a=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,Gd.SIZE,Gd.SIZE));n.bindBuffer(Gd.BINDING,a)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(Ud.BINDING),this._globalUBO),n.bindBuffer(Ud.BINDING,i.getBuffer(Ud.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(kd.BINDING),this._cameraUBO),n.bindBuffer(kd.BINDING,i.getBuffer(kd.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,a=n.shadowFrameBufferMap,o=t.scene.mainLight;o&&a.has(o)&&i.bindTexture(Hd,a.get(o).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(Gd.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(Hd,Sv.get("default-texture").getGFXTexture()),t.bindTexture(Jd,Sv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(Gd.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof Wn?Wn.toArray(this._shadowUBO,t,e):t instanceof In&&In.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();yS._combineSignY=0;var SS,xS,ES,TS,CS,AS,bS,IS,wS,PS,RS,DS,OS,NS=e("RenderStage",(tS=Tc("RenderStage"),nS=Zc(),iS=Zc(),rS=Zc(),tS((uS=function(){function e(){se(this,"_name",sS,this),se(this,"_priority",cS,this),this._enabled=!0,se(this,"_tag",lS,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},Q(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),sS=ce((oS=uS).prototype,"_name",[nS,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cS=ce(oS.prototype,"_priority",[iS,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lS=ce(oS.prototype,"_tag",[rS,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aS=oS))||aS));l.RenderStage=NS;var MS,LS=e("RenderFlow",(SS=Tc("RenderFlow"),xS=Zc(),ES=Zc(),TS=Zc(),CS=Zc(),AS=al([NS]),SS((OS=function(){function e(){se(this,"_name",wS,this),se(this,"_priority",PS,this),se(this,"_tag",RS,this),se(this,"_stages",DS,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},Q(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),wS=ce((IS=OS).prototype,"_name",[xS,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),PS=ce(IS.prototype,"_priority",[ES,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RS=ce(IS.prototype,"_tag",[TS,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DS=ce(IS.prototype,"_stages",[CS,AS,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bS=IS))||bS));l.RenderFlow=LS,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(MS||(MS=e("PipelineEventType",{})));var FS,BS,zS,US,kS,GS,HS,VS,WS,jS,XS,qS,YS,KS,QS,JS=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}Z(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(ou)),ZS=new ir,$S=new ur,ex=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},tx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},nx=e("RenderPipeline",(FS=Tc("cc.RenderPipeline"),BS=Zc(),zS=Zc(),US=al([LS]),FS((WS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_tag",HS,re(t)),se(t,"_flows",VS,re(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new JS,t._commandBuffers=[],t._pipelineUBO=new yS,t._macros={},t._constantMacros="",t._profiler=null,t._geometryRenderer=new _S,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new ir,t._clusterEnabled=!1,t._bloomEnabled=!1,t}Z(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new Lr,a=new Fr;r.format=t,a.format=n,a.stencilStoreOp=Li.DISCARD,a.depthStoreOp=Li.DISCARD,e&Ki.COLOR||(e&ig?r.loadOp=Mi.DISCARD:(r.loadOp=Mi.LOAD,r.barrier=i.getGeneralBarrier(new kr(Fi.COLOR_ATTACHMENT_WRITE,Fi.COLOR_ATTACHMENT_WRITE)))),(e&Ki.DEPTH_STENCIL)!==Ki.DEPTH_STENCIL&&(e&Ki.DEPTH||(a.depthLoadOp=Mi.LOAD),e&Ki.STENCIL||(a.stencilLoadOp=Mi.LOAD)),a.barrier=i.getGeneralBarrier(new kr(Fi.DEPTH_STENCIL_ATTACHMENT_WRITE,Fi.DEPTH_STENCIL_ATTACHMENT_WRITE));var o=new Ur([r],a);return i.createRenderPass(o)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,a=0;a<r.length;a++)r[a].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new Hr(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,ZS),t||(t=$S);var n=this.pipelineSceneData.shadingScale;return t.left=ZS.x*n,t.top=ZS.y*n,t.width=ZS.width*n,t.height=ZS.height*n,t},n.generateScissor=function(e,t){t||(t=ZS),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=l.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new qg(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this),this._geometryRenderer.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(MS.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(Hv=n)}Hv=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(MS.RENDER_CAMERA_BEGIN,n),Hg(this,n),Vg(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(MS.RENDER_CAMERA_END,n)}}this.emit(MS.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,a=t.y/this._height,o=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=o;o=a,a=s}var c=0;switch(e){case hi.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case hi.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=a;break;case hi.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case hi.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o}return n},n._createQuadInputAssembler=function(){var e=new tx,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE|yi.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r,o=this._device.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,a,r));if(!o)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,o.update(s);var c=new Array(2);c[0]=new Or("a_position",_i.RG32F),c[1]=new Or("a_texCoord",_i.RG32F);var l=this._device.createInputAssembler(new Mr(c,[i],o));return e.quadIB=o,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(hi.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||hi.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),this._geometryRenderer.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(_i.RGBA32F)&(Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(fi.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(hu.os===iu.ANDROID&&hu.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(lt.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new ex,t=this.device,n=new Lr;n.format=_i.RGBA8,n.loadOp=Mi.CLEAR,n.storeOp=Li.STORE,n.barrier=t.getGeneralBarrier(new kr(Fi.NONE,Fi.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new Ur([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Hr(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var a=0;a<6;++a)e.downsampleTexs.push(t.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[a]=t.createFramebuffer(new Hr(e.renderPass,[e.downsampleTexs[a]])),e.upsampleTexs.push(t.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA8,i,r))),e.upsampleFramebuffers[a]=t.createFramebuffer(new Hr(e.renderPass,[e.upsampleTexs[a]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Hr(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,a){this._eventProcessor.emit(e,t,n,i,r,a)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},Q(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(wu),HS=ce((GS=WS).prototype,"_tag",[BS,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VS=ce(GS.prototype,"_flows",[zS,US,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kS=GS))||kS));l.RenderPipeline=nx,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(jS||(jS={})),function(e){e[e.FORWARD=10]="FORWARD"}(XS||(XS={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(qS||(qS={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(YS||(YS={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(KS||(KS={}));var ix=new Lr;ix.format=_i.RGBA8;var rx=new Fr;rx.format=_i.DEPTH_STENCIL;var ax,ox,sx,cx,lx,ux,hx,fx,_x,dx,px,mx,vx,gx,yx,Sx,xx,Ex,Tx,Cx,Ax,bx,Ix,wx,Px,Rx,Dx,Ox,Nx,Mx,Lx,Fx,Bx,zx,Ux,kx,Gx,Hx,Vx,Wx,jx,Xx,qx,Yx,Kx,Qx,Jx,Zx,$x,eE,tE,nE,iE,rE,aE,oE,sE,cE,lE,uE,hE,fE,_E,dE,pE,mE,vE,gE,yE,SE,xE,EE,TE,CE,AE,bE,IE,wE,PE,RE=new Ur([ix],rx),DE={width:1,height:1,renderPassInfo:RE},OE=e("RenderTexture",Tc("cc.RenderTexture")(QS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=l.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(cn(e,1,2048)),this._height=Math.floor(cn(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=l.director.root;DE.title=this._name,DE.width=this._width,DE.height=this._height,DE.renderPassInfo=e&&e.passInfo?e.passInfo:RE,ix.barrier=t.device.getGeneralBarrier(new kr(Fi.FRAGMENT_SHADER_READ_TEXTURE,Fi.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(t.device,DE)):this._window=t.createWindow(DE)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),n=n||this.width,i=i||this.height;var a=this.getGFXTexture();if(!a)return O(7606),null;var o=4*n*i;if(void 0===r)r=new Uint8Array(o);else if(r.length<o)return O(7607,o),null;var s=this._getGFXDevice(),c=[],l=[],u=new lr;return u.texOffset.x=e,u.texOffset.y=t,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(a,c,l),r},Q(t,[{key:"window",get:function(){return this._window}}]),t}(km))||QS);l.RenderTexture=OE,st(Si),st(xi),st(Li),st(Mi),st(Fi),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(PE||(PE={})),st(PE),ax=Tc("RenderTextureDesc"),ox=al(Si),sx=al(xi),cx=al(_i),ax((ux=ce((lx=function(){se(this,"name",ux,this),se(this,"type",hx,this),se(this,"usage",fx,this),se(this,"format",_x,this),se(this,"width",dx,this),se(this,"height",px,this)}).prototype,"name",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hx=ce(lx.prototype,"type",[ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Si.TEX2D}}),fx=ce(lx.prototype,"usage",[sx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xi.COLOR_ATTACHMENT}}),_x=ce(lx.prototype,"format",[cx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _i.UNKNOWN}}),dx=ce(lx.prototype,"width",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),px=ce(lx.prototype,"height",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),lx));var NE,ME=(mx=Tc("RenderTextureConfig"),vx=al(OE),mx((Sx=ce((yx=function(){se(this,"name",Sx,this),se(this,"texture",xx,this)}).prototype,"name",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xx=ce(yx.prototype,"texture",[vx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gx=yx))||gx),LE=(Ex=Tc("MaterialConfig"),Tx=al(Qv),Ex((Ax=ce((Cx=function(){se(this,"name",Ax,this),se(this,"material",bx,this)}).prototype,"name",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bx=ce(Cx.prototype,"material",[Tx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cx)),Ix=Tc("FrameBufferDesc"),wx=al([Mt]),Px=al(OE),Ix((Dx=ce((Rx=function(){se(this,"name",Dx,this),se(this,"renderPass",Ox,this),se(this,"colorTextures",Nx,this),se(this,"depthStencilTexture",Mx,this),se(this,"texture",Lx,this)}).prototype,"name",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ox=ce(Rx.prototype,"renderPass",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nx=ce(Rx.prototype,"colorTextures",[wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mx=ce(Rx.prototype,"depthStencilTexture",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Lx=ce(Rx.prototype,"texture",[Px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rx)),Fx=Tc("ColorDesc"),Bx=al(_i),zx=al(Mi),Ux=al(Li),kx=al([Fi]),Gx=al([Fi]),Fx((Wx=ce((Vx=function(){se(this,"format",Wx,this),se(this,"loadOp",jx,this),se(this,"storeOp",Xx,this),se(this,"sampleCount",qx,this),se(this,"beginAccesses",Yx,this),se(this,"endAccesses",Kx,this)}).prototype,"format",[Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _i.UNKNOWN}}),jx=ce(Vx.prototype,"loadOp",[zx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.CLEAR}}),Xx=ce(Vx.prototype,"storeOp",[Ux],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.STORE}}),qx=ce(Vx.prototype,"sampleCount",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Yx=ce(Vx.prototype,"beginAccesses",[kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.NONE}}),Kx=ce(Vx.prototype,"endAccesses",[Gx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.COLOR_ATTACHMENT_WRITE}}),Hx=Vx))||Hx),FE=(Qx=Tc("DepthStencilDesc"),Jx=al(_i),Zx=al(Mi),$x=al(Li),eE=al(Mi),tE=al(Li),nE=al(Fi),iE=al(Fi),Qx((oE=ce((aE=function(){se(this,"format",oE,this),se(this,"depthLoadOp",sE,this),se(this,"depthStoreOp",cE,this),se(this,"stencilLoadOp",lE,this),se(this,"stencilStoreOp",uE,this),se(this,"sampleCount",hE,this),se(this,"beginAccesses",fE,this),se(this,"endAccesses",_E,this)}).prototype,"format",[Jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _i.UNKNOWN}}),sE=ce(aE.prototype,"depthLoadOp",[Zx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.CLEAR}}),cE=ce(aE.prototype,"depthStoreOp",[$x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.STORE}}),lE=ce(aE.prototype,"stencilLoadOp",[eE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.CLEAR}}),uE=ce(aE.prototype,"stencilStoreOp",[tE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.STORE}}),hE=ce(aE.prototype,"sampleCount",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fE=ce(aE.prototype,"beginAccesses",[nE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.NONE}}),_E=ce(aE.prototype,"endAccesses",[iE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.DEPTH_STENCIL_ATTACHMENT_WRITE}}),rE=aE))||rE);dE=Tc("RenderPassDesc"),pE=al([LE]),mE=al(FE),dE((gE=ce((vE=function(){se(this,"index",gE,this),se(this,"colorAttachments",yE,this),se(this,"depthStencilAttachment",SE,this)}).prototype,"index",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),yE=ce(vE.prototype,"colorAttachments",[pE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SE=ce(vE.prototype,"depthStencilAttachment",[mE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FE}}),vE)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(NE||(NE={})),st(NE);var BE=(xE=Tc("RenderQueueDesc"),EE=al(NE),TE=al([Mt]),xE((bE=ce((AE=function(){se(this,"isTransparent",bE,this),se(this,"sortMode",IE,this),se(this,"stages",wE,this)}).prototype,"isTransparent",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IE=ce(AE.prototype,"sortMode",[EE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NE.FRONT_TO_BACK}}),wE=ce(AE.prototype,"stages",[TE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CE=AE))||CE);function zE(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function UE(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var kE=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Wl((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new jl(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],a=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var o=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=o,s.depth=e.depth||0,s.shaderId=a.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],a=r.subModel,o=r.passIdx,s=a.inputAssembler,c=a.passes[o],l=a.shaders[o],u=wv.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(Md.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Md.LOCAL,a.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function GE(e){for(var t=0,n=0;n<e.stages.length;n++)t|=xv(e.stages[n]);var i=zE;switch(e.sortMode){case NE.BACK_TO_FRONT:i=UE;break;case NE.FRONT_TO_BACK:i=zE}return new kE({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function HE(e){e.clear()}function VE(e){e.sort()}var WE=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var a=0;a<r.vbs.length;++a)r.vbs[a].update(r.vbDatas[a]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n,i){void 0===i&&(i=null);for(var r=this.queue.values(),a=r.next();!a.done;){for(var o=!1,s=0;s<a.value.batches.length;++s){var c=a.value.batches[s];if(c.mergeCount){if(!o){var l=c.shader,u=wv.getOrCreatePipelineState(e,c.pass,l,t,c.ia);n.bindPipelineState(u),n.bindDescriptorSet(Md.MATERIAL,c.pass.descriptorSet),o=!0}i&&n.bindDescriptorSet(Md.GLOBAL,i),n.bindDescriptorSet(Md.LOCAL,c.descriptorSet,a.value.dynamicOffsets),n.bindInputAssembler(c.ia),n.draw(c.ia)}}a=r.next()}},e}(),jE=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n,i){void 0===i&&(i=null);for(var r=this.queue.values(),a=r.next();!a.done;){var o=a.value,s=o.instances,c=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(Md.MATERIAL,c.descriptorSet);for(var l=null,u=0;u<s.length;++u){var h=s[u];if(h.count){var f=h.shader,_=wv.getOrCreatePipelineState(e,c,f,t,h.ia);l!==_&&(n.bindPipelineState(_),l=_),i&&n.bindDescriptorSet(Md.GLOBAL,i),n.bindDescriptorSet(Md.LOCAL,h.descriptorSet,a.value.dynamicOffsets),n.bindInputAssembler(h.ia),n.draw(h.ia)}}}a=r.next()}},e}(),XE=new Vl((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),qE=new Float32Array(4),YE=[],KE=[],QE=new Wn,JE=new Wn;function ZE(e,t){return!(!t.worldBounds||ds.aabbWithAABB(t.worldBounds,e.aabb))}function $E(e,t){return!(!t.worldBounds||ds.aabbWithAABB(t.worldBounds,e.aabb)&&ds.aabbFrustum(t.worldBounds,e.frustum))}var eT=xv("forward-add"),tT=[];function nT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,a=-1,o=0;o<r.length;o++)if(r[o].phase===eT){a=o,n=!0;break}t.push(a)}return n}var iT,rT,aT,oT,sT,cT,lT,uT,hT,fT,_T,dT=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Gd.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new jE,this._batchedQueue=new WE;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(rp.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new mr(this._lightBuffer,0,rp.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}XE.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(Gd.BINDING).destroy(),r.getTexture(Hd).destroy(),r.getTexture(Jd).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var a=i[r].model,o=a.subModels;if(nT(o,tT)&&(KE.length=0,this._lightCulling(a,n),KE.length))for(var s=0;s<o.length;s++){var c=tT[s];if(!(c<0)){var l=o[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(rp.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,a,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){for(var i=this._pipeline.globalDSManager,r=0;r<KE.length;r++){var a=KE[r],o=i.getOrCreateDescriptorSet(a);this._instancedQueue.recordCommandBuffer(e,t,n,o),this._batchedQueue.recordCommandBuffer(e,t,n,o)}for(var s=0;s<this._lightPasses.length;s++){var c=this._lightPasses[s],l=c.subModel,u=c.passIdx,h=c.dynamicOffsets,f=c.lights,_=l.passes[u],d=l.shaders[u],p=l.inputAssembler,m=wv.getOrCreatePipelineState(e,_,d,t,p),v=_.descriptorSet,g=l.descriptorSet;n.bindPipelineState(m),n.bindDescriptorSet(Md.MATERIAL,v),n.bindInputAssembler(p);for(var y=0;y<h.length;++y){var S=f[y],x=i.getOrCreateDescriptorSet(S);YE[0]=h[y],n.bindDescriptorSet(Md.GLOBAL,x),n.bindDescriptorSet(Md.LOCAL,g,YE),n.draw(p)}}},t._lightCulling=function(e,t){for(var n=!1,i=!function(e){for(var t=e.subModels,n=0;n<t.length;++n)for(var i=t[n].passes,r=0;r<i.length;++r){var a=i[r].batchingScheme;if(a===mv.INSTANCING)return!0;if(a===mv.VB_MERGING)return!0}return!1}(e),r=0;r<t.length;r++){var a=t[r];switch(a.type){case vy.SPHERE:i&&(n=ZE(a,e));break;case vy.SPOT:i&&(n=$E(a,e))}n||KE.push(r)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===mv.INSTANCING)for(var a=0;a<KE.length;a++){var o=KE[a],s=e.getInstancedBuffer(o);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*o,this._instancedQueue.queue.add(s)}else if(r===mv.VB_MERGING)for(var c=0;c<KE.length;c++){var l=KE[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=XE.alloc();h.subModel=t,h.passIdx=i;for(var f=0;f<KE.length;f++){var _=KE[f];h.lights.push(_),h.dynamicOffsets.push(this._lightBufferStride*_)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,a=i.shadowFrameBufferMap,o=e.scene.mainLight,s=Gp(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],f=c.getOrCreateDescriptorSet(u);if(f){var _=void 0,d=void 0;switch(h.type){case vy.SPHERE:o&&(kg(r,o,this._shadowUBO),Gg(r,this._shadowUBO)),this._shadowUBO[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,In.toArray(this._shadowUBO,r.shadowColor,Gd.SHADOW_COLOR_OFFSET);break;case vy.SPOT:var p=h;if(o&&(kg(r,o,this._shadowUBO),Gg(r,this._shadowUBO)),Wn.invert(QE,h.node.getWorldMatrix()),Wn.perspective(JE,h.angle,1,.001,h.range),_=JE.clone(),d=JE.clone().invert(),Wn.multiply(JE,JE,QE),Wn.toArray(this._shadowUBO,QE,Gd.MAT_LIGHT_VIEW_OFFSET),Wn.toArray(this._shadowUBO,JE,Gd.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=p.shadowPcf,this._shadowUBO[Gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=p.shadowBias,this._shadowUBO[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=p.shadowNormalBias,this._shadowUBO[Gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=_.m10,this._shadowUBO[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=_.m14,this._shadowUBO[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=_.m11,this._shadowUBO[Gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=_.m15,this._shadowUBO[Gd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[Gd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[Gd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[Gd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[Gd.SHADOW_PROJ_INFO_OFFSET+0]=_.m00,this._shadowUBO[Gd.SHADOW_PROJ_INFO_OFFSET+1]=_.m05,this._shadowUBO[Gd.SHADOW_PROJ_INFO_OFFSET+2]=1/_.m00,this._shadowUBO[Gd.SHADOW_PROJ_INFO_OFFSET+3]=1/_.m05,In.toArray(this._shadowUBO,r.shadowColor,Gd.SHADOW_COLOR_OFFSET),a.has(h)){var m,v=null===(m=a.get(h))||void 0===m?void 0:m.colorTextures[0];v&&f.bindTexture(Jd,v)}}f.update(),t.updateBuffer(f.getBuffer(Gd.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,a=i.shadows,o=i.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=yn(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new mr(this._lightBuffer,0,rp.SIZE)));for(var s=0,c=0;s<o.length;s++,c+=this._lightBufferElementCount){var l=o[s];switch(l.type){case vy.SPHERE:if(Pn.toArray(qE,l.position),qE[3]=0,this._lightBufferData.set(qE,c+rp.LIGHT_POS_OFFSET),qE[0]=l.size,qE[1]=l.range,qE[2]=0,qE[3]=0,this._lightBufferData.set(qE,c+rp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Pn.toArray(qE,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;qE[0]*=u.x,qE[1]*=u.y,qE[2]*=u.z}qE[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(qE,c+rp.LIGHT_COLOR_OFFSET);break;case vy.SPOT:if(Pn.toArray(qE,l.position),qE[3]=1,this._lightBufferData.set(qE,c+rp.LIGHT_POS_OFFSET),qE[0]=l.size,qE[1]=l.range,qE[2]=l.spotAngle,qE[3]=a.enabled&&l.shadowEnabled&&a.type===sg.ShadowMap?1:0,this._lightBufferData.set(qE,c+rp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Pn.toArray(qE,l.direction),this._lightBufferData.set(qE,c+rp.LIGHT_DIR_OFFSET),Pn.toArray(qE,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;qE[0]*=h.x,qE[1]*=h.y,qE[2]*=h.z}qE[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(qE,c+rp.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),pT=new Ys,mT=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new jE,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===sg.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,a=e.frustum,o=0!=(e.visibility&Ed.BitMask.DEFAULT);if(r.mainLight&&o){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var f=this._castModels[h];if(!f.worldBounds||(Ys.transform(pT,f.worldBounds,i.matLight),ds.aabbFrustum(pT,a)))if(f.isInstancingEnabled)for(var _=f.subModels,d=0;d<_.length;d++){var p=_[d];u.merge(p,f.instancedAttributes,0,p.planarInstanceShader)}else this._pendingModels.push(f)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===sg.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],a=r.descriptorSet;n.bindDescriptorSet(Md.MATERIAL,a);for(var o=this._pendingModels.length,s=0;s<o;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,f=u.inputAssembler,_=wv.getOrCreatePipelineState(e,r,h,t,f);n.bindPipelineState(_),n.bindDescriptorSet(Md.LOCAL,u.descriptorSet),n.bindInputAssembler(f),n.draw(f)}}},e}(),vT=function(){function e(){this._phaseID=xv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],a=e.scene.batches,o=0;o<a.length;o++){var s=a[o],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var f=s.shaders[u],_=s.inputAssembler,d=wv.getOrCreatePipelineState(i,h,f,t,_);r.bindPipelineState(d),r.bindDescriptorSet(Md.MATERIAL,h.descriptorSet);var p=s.descriptorSet;r.bindDescriptorSet(Md.LOCAL,p),r.bindInputAssembler(_),r.draw(_)}}}},e}(),gT=[new hr(0,0,0,1)],yT=e("ForwardStage",(iT=Tc("ForwardStage"),rT=al([BE]),aT=Zc(),iT((uT=lT=function(e){function t(){var t;return se(t=e.call(this)||this,"renderQueues",cT,re(t)),t._renderQueues=[],t._renderArea=new ir,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=xv("default"),t._clearFlag=4294967295,t._batchedQueue=new WE,t._instancedQueue=new jE,t._uiPhase=new vT,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=GE(this.renderQueues[i]);this._additiveLightQueue=new dT(this._pipeline),this._planarQueue=new mT(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(HE);for(var i=t.pipelineSceneData.renderObjects,r=0,a=0,o=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(a=0;a<h.length;++a){var f=h[a];if(f.phase===this._phaseID){var _=f.batchingScheme;if(_===mv.INSTANCING){var d=f.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,a),this._instancedQueue.queue.add(d)}else if(_===mv.VB_MERGING){var p=f.getBatchedBuffer();p.merge(u,a,c.model),this._batchedQueue.queue.add(p)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(c,r,a)}}}}this._renderQueues.forEach(VE);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&Ki.COLOR&&(gT[0].x=e.clearColor.x,gT[0].y=e.clearColor.y,gT[0].z=e.clearColor.z,gT[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,g=t.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,gT,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Md.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(Md.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._pipeline.geometryRenderer.render(g,m),this._uiPhase.render(e,g),Vv(n,g,m,t.profiler,e),m.endRenderPass()},t}(NS),lT.initInfo={name:"ForwardStage",priority:XS.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:NE.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:NE.BACK_TO_FRONT,stages:["default","planarShadow"]}]},cT=ce((sT=uT).prototype,"renderQueues",[rT,Dc,aT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oT=sT))||oT)),ST=e("ForwardFlow",Tc("ForwardFlow")((_T=fT=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new yT;n.initialize(yT.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(LS),fT.initInfo={name:bd,priority:qS.FORWARD,stages:[]},hT=_T))||hT),xT=new Wn,ET=new Wn,TT=new Wn,CT=new Ys,AT=xv("shadow-caster"),bT=[];function IT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,a=-1,o=0;o<r.length;o++)if(r[o].phase===AT){a=o,n=!0;break}t.push(a)}return n}var wT,PT,RT,DT,OT,NT,MT=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new jE,this._batchedQueue=new WE}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,a=r.shadows;if(n&&a.enabled&&a.type===sg.ShadowMap){var o=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case vy.DIRECTIONAL:for(var c=0;c<o.length;c++){var l=o[c].model;IT(l.subModels,bT)&&this.add(l,bT)}break;case vy.SPOT:Wn.invert(xT,n.node.getWorldMatrix()),Wn.perspective(ET,n.angle,1,.001,n.range),Wn.multiply(TT,ET,xT);for(var u=0;u<s.length;u++){var h=s[u].model;IT(h.subModels,bT)&&(h.worldBounds&&(Ys.transform(CT,h.worldBounds,TT),!ds.aabbFrustum(CT,t.frustum))||this.add(h,bT))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t){for(var n=e.subModels,i=0;i<n.length;i++){var r=n[i],a=t[i],o=r.passes[a];if(o.batchingScheme===mv.INSTANCING){var s=o.getInstancedBuffer();s.merge(r,e.instancedAttributes,a),this._instancedQueue.queue.add(s)}else if(o.batchingScheme===mv.VB_MERGING){var c=o.getBatchedBuffer();c.merge(r,a,e),this._batchedQueue.queue.add(c)}else{var l=r.shaders[a];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(o)}}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],a=this._shaderArray[i],o=this._passArray[i],s=r.inputAssembler,c=wv.getOrCreatePipelineState(e,o,a,t,s),l=o.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Md.MATERIAL,l),n.bindDescriptorSet(Md.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),LT=[new hr(1,1,1,1)],FT=e("ShadowStage",Tc("ShadowStage")((RT=PT=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new ir,t._light=null,t._globalDS=null,t}Z(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){LT[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,LT,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,a=this._globalDS,o=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(a,this._light),this._additiveShadowQueue.gatherLightPasses(a,e,this._light,o);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;o.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,LT,e.clearDepth,e.clearStencil),o.bindDescriptorSet(Md.GLOBAL,a),this._additiveShadowQueue.recordCommandBuffer(l,u,o),o.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new MT(t)},t}(NS),PT.initInfo={name:"ShadowStage",priority:XS.FORWARD,tag:0},wT=RT))||wT),BT=[],zT=e("ShadowFlow",Tc("ShadowFlow")((NT=OT=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new FT;n.initialize(FT.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,a=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===sg.ShadowMap){for(var o=0,s=0;o<n.maxReceived&&s<a.length;){var c=a[s];c.type===vy.SPOT&&(BT.push(c),o++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),f=0;f<this._stages.length;f++){var _=this._stages[f];_.setUsage(u,l,h),_.render(e)}}for(var d=0;d<BT.length;d++){var p=BT[d],m=t.globalDSManager.getOrCreateDescriptorSet(d);i.has(p)||this._initShadowFrameBuffer(t,p,e.window.swapchain);for(var v=i.get(p),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,p,v),y.render(e)}}BT.length=0}else this.clearShadowMap(BT,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var a=r.colorTextures,o=0;o<a.length;o++){var s=a[i];s&&s.destroy()}a.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,a=Gp(n)?_i.R32F:_i.RGBA8;if(!this._shadowRenderPass){var o=new Lr;o.format=a,o.loadOp=Mi.CLEAR,o.storeOp=Li.STORE,o.sampleCount=1;var s=new Fr;s.format=_i.DEPTH_STENCIL,s.depthLoadOp=Mi.CLEAR,s.depthStoreOp=Li.DISCARD,s.stencilLoadOp=Mi.CLEAR,s.stencilStoreOp=Li.DISCARD,s.sampleCount=1;var c=new Ur([o],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,a,i.x,i.y)));var u=n.createTexture(new Sr(Si.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT,_i.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new Hr(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var a=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var o=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(a,r,o),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),f=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var _=0;_<this._stages.length;_++){var d=this._stages[_];d.setUsage(f,u,h),d.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,a=Gp(i)?_i.R32F:_i.RGBA8,o=r.values(),s=o.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,a,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new Hr(h,l,u)),s=o.next()}else s=o.next()}e.shadowMapDirty=!1},t}(LS),OT.initInfo={name:Id,priority:qS.SHADOW,tag:PE.SCENE,stages:[]},DT=NT))||DT);function UT(e,t){for(var n,i=oe(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?UT(e,r):e.push(r)}}function kT(e){var t=[];return UT(t,e),t.join("")}var GT=_l.Flags.Destroyed,HT=_l.Flags.PersistentMask,VT=Zt.IDENTIFIER_RE,WT="var ",jT="o",XT={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},qT=Zt.escapeForJS,YT=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return WT+this.varName+"="+this.expression+";"},e}();function KT(e,t){return t instanceof YT?new YT(t.varName,e+t.expression):e+t}function QT(e,t,n){Array.isArray(n)?(n[0]=KT(t,n[0]),e.push(n)):e.push(KT(t,n)+";")}var JT=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];QT(e,t+ZT(i[0])+"=",i[1])}},e}();function ZT(e){return VT.test(e)?"."+e:"["+qT(e)+"]"}JT.pool=void 0,JT.pool=new et((function(e){e._exps.length=0,e._targetExp=null}),1),JT.pool.get=function(e){var t=this._get()||new JT;return t._targetExp=e,t};var $T=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Ie(),ze(this.funcModuleCache,XT),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=WT+this.globalVariables.join(",")+";");var i=kT(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,a=this.objsToClear_iN$t.length;r<a;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=we(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var o="F["+a+"]";return t&&(o="("+o+")"),this.funcModuleCache[n]=o,o},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=JT.pool.get(i),a=t.constructor.__props__;a||(a=Object.keys(t));for(var o=0;o<a.length;o++){var s=a[o],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),JT.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var i=n.__values__,r=wt(n),a=0;a<i.length;a++){var o=i[a],s=t[o],c=r[o+"$_$default"];if(!eC(c,s))if("object"==typeof s&&s instanceof l.ValueType&&(c=Zt.getDefault(c))&&c.constructor===s.constructor){var u=jT+ZT(o);this.setValueType(e,c,s,u)}else this.setObjProp(e,t,o,s)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new YT(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)QT(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new YT(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&QT(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var a=i.source[0];i.source[0]=KT(r+"=",a)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?qT(n):("_objFlags"===t&&e instanceof _l&&(n&=HT),n)},t.setObjProp=function(e,t,n,i){QT(e,jT+ZT(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if($t(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"==typeof r&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}},t.instantiateObj=function(e){if(e instanceof l.ValueType)return Zt.getNewValueTypeCode(e);if(e instanceof l.Asset)return this.getObjRef(e);if(e._objFlags&GT)return null;var t,n=e.constructor;if($t(n)){if(this.parent)if(this.parent instanceof l.Component){if(e instanceof l._BaseNode||e instanceof l.Component)return this.getObjRef(e)}else if(this.parent instanceof l._BaseNode)if(e instanceof l._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof l.Component){var i;if(!(null===(i=e.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(e)}t=new YT(jT,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new YT(jT,"{}");else{if(n)return this.getObjRef(e);t=new YT(jT,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]},e}();function eC(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof l.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return xe(e)&&xe(t)}return!1}var tC,nC,iC,rC,aC,oC,sC,cC,lC,uC,hC=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(){},Q(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?R(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]),e}();_l.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(tC||(tC=e("NodeEventType",{})));var fC=_l.Flags.Destroying,_C=_l.Flags.DontDestroy,dC=_l.Flags.Deactivating,pC=new pe("Node");function mC(e){return e?"string"==typeof e?Ze(e):e:(O(3804),null)}var vC,gC,yC,SC,xC,EC,TC,CC,AC,bC,IC,wC=e("BaseNode",Tc("cc.BaseNode")((uC=lC=function(e){Z(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var a=i[r];if(a.constructor===t)return a}else for(var o=0;o<i.length;++o){var s=i[o];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var a=0;a<r.length;++a){var o=r[a];o.constructor===t&&n.push(o)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],a=n._findComponent(r,t);if(a)return a;if(r._children.length>0&&(a=n._findChildComponent(r._children,t)))return a}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var a=e[r];n._findComponents(a,t,i),a._children.length>0&&n._findChildComponents(a._children,t,i)}};var t=n.prototype;function n(t){var n;return se(n=e.call(this,t)||this,"_parent",rC,re(n)),se(n,"_children",aC,re(n)),se(n,"_active",oC,re(n)),se(n,"_components",sC,re(n)),se(n,"_prefab",cC,re(n)),n._scene=null,n._activeInHierarchy=!1,n._id=pC.getNewId(),n._name=void 0,n._eventProcessor=new l.NodeEventProcessor(re(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?x("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){ze(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(tC.PARENT_CHANGED,n),n&&!(n._objFlags&fC)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(tC.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(tC.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return y("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return y("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var a=i(r);if("continue"!==a&&"object"==typeof a)return a.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&dC)O(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,a=null,o=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(a=s[--i])if(!l&&e?e(a):l&&t&&t(a),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++o])s[i]=r[o],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(o=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),o<0))break}else a._children.length>0?(c=a,r=a._children,o=0,s[i]=r[o],i++):(s[i]=a,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=mC(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=mC(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=mC(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=mC(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=Ze(e)))throw l._RF.peek()&&O(3808,e),TypeError(F(3807,e))}else{if(!e)throw TypeError(F(3804));t=e}if("function"!=typeof t)throw TypeError(F(3809));if(!Ge(t,l.Component))throw TypeError(F(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var a=n;this.getComponent(a)||this.addComponent(a)}var o=new t;return o.node=this,this._components.push(o),this._activeInHierarchy&&l.director._nodeActivator.activateComp(o),o},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof Ku?e:this.getComponent(e))&&t.destroy()}else O(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case tC.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case tC.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,a){this._eventProcessor.emit(e,t,n,i,r,a)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(tC.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&fC)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&O(3815)}}else O(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(tC.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=l.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof l.Scene||l.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&l.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=fC;var e=this._parent,t=!!e&&0!=(e._objFlags&fC);if(this._persistNode&&l.game.removePersistRootNode(this),!t&&e){this.emit(tC.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(tC.CHILD_REMOVED,this)}this.emit(tC.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var a=this._components,o=0;o<a.length;++o)a[o]._destroyImmediate();return t},Q(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&_C)>0},set:function(e){e?this._objFlags|=_C:this._objFlags&=~_C}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(e=!!e,this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&l.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(_l),lC.idGenerator=pC,lC._stacks=[[]],lC._stackId=0,ce((iC=uC).prototype,"_persistNode",[Ic],Object.getOwnPropertyDescriptor(iC.prototype,"_persistNode"),iC.prototype),ce(iC.prototype,"name",[Hc],Object.getOwnPropertyDescriptor(iC.prototype,"name"),iC.prototype),ce(iC.prototype,"children",[Hc],Object.getOwnPropertyDescriptor(iC.prototype,"children"),iC.prototype),ce(iC.prototype,"active",[Hc],Object.getOwnPropertyDescriptor(iC.prototype,"active"),iC.prototype),ce(iC.prototype,"activeInHierarchy",[Hc],Object.getOwnPropertyDescriptor(iC.prototype,"activeInHierarchy"),iC.prototype),ce(iC.prototype,"parent",[Hc],Object.getOwnPropertyDescriptor(iC.prototype,"parent"),iC.prototype),rC=ce(iC.prototype,"_parent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aC=ce(iC.prototype,"_children",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oC=ce(iC.prototype,"_active",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sC=ce(iC.prototype,"_components",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cC=ce(iC.prototype,"_prefab",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nC=iC))||nC);l._BaseNode=wC;var PC=new Pn,RC=new Fn,DC=new Fn,OC=new Fn,NC=new Nn,MC=new Nn,LC=new Wn,FC=[],BC=[],zC=[],UC=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return zC[0]=this._chunks[e],zC[1]=this._freelists[e].pop(),zC},e}();UC.CAPACITY_PER_CHUNK=256;var kC,GC,HC,VC,WC,jC,XC,qC,YC,KC,QC,JC,ZC,$C,eA,tA,nA,iA,rA,aA,oA,sA,cA,lA,uA,hA,fA,_A,dA,pA,mA,vA,gA,yA,SA,xA,EA,TA,CA,AA,bA,IA,wA,PA,RA,DA,OA,NA,MA,LA,FA,BA,zA,UA,kA,GA,HA,VA,WA,jA,XA,qA,YA,KA,QA,JA,ZA,$A,eb,tb=new UC,nb=Symbol("ReserveContentsForAllSyncablePrefab"),ib=e("Node",(vC=Tc("cc.Node"),gC=al(Pn),vC((IC=bC=function(e){Z(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new hC(re(n)),n._static=!1,se(n,"_lpos",xC,re(n)),se(n,"_lrot",EC,re(n)),se(n,"_lscale",TC,re(n)),se(n,"_layer",CC,re(n)),se(n,"_euler",AC,re(n)),n._dirtyFlagsPri=my.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=tb.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new Pn,this._rot=new Fn,this._scale=new Pn(1,1,1),this._mat=new Wn},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof l.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return tb.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[oh]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),sn(Wn.determinant(i._mat),0,an)?(R(14200),this._dirtyFlags|=my.TRS,this.updateWorldTransform()):(Wn.multiply(LC,Wn.invert(LC,i._mat),this._mat),Wn.toRTS(LC,this._lrot,this._lpos,this._lscale))):(Pn.copy(this._lpos,this._pos),Fn.copy(this._lrot,this._rot),Pn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(my.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=my.TRS,this._dirtyFlags|=my.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(my.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||py.LOCAL;if(n===py.LOCAL)Pn.transformQuat(PC,e,this._lrot),this._lpos.x+=PC.x,this._lpos.y+=PC.y,this._lpos.z+=PC.z;else if(n===py.WORLD)if(this._parent){Fn.invert(RC,this._parent.worldRotation),Pn.transformQuat(PC,e,RC);var i=this.worldScale;this._lpos.x+=PC.x/i.x,this._lpos.y+=PC.y/i.y,this._lpos.z+=PC.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(my.POSITION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.POSITION)},t.rotate=function(e,t){var n=t||py.LOCAL;if(Fn.normalize(RC,e),n===py.LOCAL)Fn.multiply(this._lrot,this._lrot,RC);else if(n===py.WORLD){var i=this.worldRotation;Fn.multiply(DC,RC,i),Fn.invert(RC,i),Fn.multiply(DC,RC,DC),Fn.multiply(this._lrot,this._lrot,DC)}this._eulerDirty=!0,this.invalidateChildren(my.ROTATION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(PC),Pn.subtract(PC,PC,e),Pn.normalize(PC,PC),Fn.fromViewUp(RC,PC,t),this.setWorldRotation(RC)},t._setDirtyNode=function(e,t){FC[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,a=0,o=0,s=0,c=0,l=e|my.POSITION;for(FC[0]=this;r>=0;){if(c=(t=FC[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,o=(i=t._children).length,a=0;a<o;a++)n=i[a],FC[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=FC[--n])._dirtyFlags,t?(i&my.POSITION&&(Pn.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&my.RS&&(Wn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Wn.multiply(e._mat,t._mat,e._mat),i&my.ROTATION&&Fn.multiply(e._rot,t._rot,e._lrot),Nn.fromQuat(NC,Fn.conjugate(OC,e._rot)),Nn.multiplyMat4(NC,NC,e._mat),e._scale.x=NC.m00,e._scale.y=NC.m04,e._scale.z=NC.m08)):(i&my.POSITION&&(Pn.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&my.RS&&(i&my.ROTATION&&Fn.copy(e._rot,e._lrot),i&my.SCALE&&(Pn.copy(e._scale,e._lscale),Wn.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=my.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?Pn.copy(this._lpos,e):void 0===n?Pn.set(this._lpos,e,t,this._lpos.z):Pn.set(this._lpos,e,t,n),this.invalidateChildren(my.POSITION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.POSITION)},t.getPosition=function(e){return e?Pn.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Pn.copy(new Pn,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Fn.copy(this._lrot,e):Fn.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(my.ROTATION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(Pn.copy(this._euler,e),Fn.fromEuler(this._lrot,e.x,e.y,e.z)):(Pn.set(this._euler,e,t,i),Fn.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(my.ROTATION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.ROTATION)},t.getRotation=function(e){return e?Fn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Fn.copy(new Fn,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?Pn.copy(this._lscale,e):void 0===n?Pn.set(this._lscale,e,t,this._lscale.z):Pn.set(this._lscale,e,t,n),this.invalidateChildren(my.SCALE),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.SCALE)},t.getScale=function(e){return e?Pn.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Pn.copy(new Pn,this._lscale)},t.inverseTransformPoint=function(e,t){Pn.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)Pn.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=FC[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?Pn.copy(this._pos,e):Pn.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),Pn.transformMat4(r,this._pos,Wn.invert(LC,i._mat))):Pn.copy(r,this._pos),this.invalidateChildren(my.POSITION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?Pn.copy(e,this._pos):Pn.copy(new Pn,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Fn.copy(this._rot,e):Fn.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),Fn.multiply(this._lrot,Fn.conjugate(this._lrot,this._parent._rot),this._rot)):Fn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(my.ROTATION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){Fn.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),Fn.multiply(this._lrot,Fn.conjugate(this._lrot,this._parent._rot),this._rot)):Fn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(my.ROTATION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?Fn.copy(e,this._rot):Fn.copy(new Fn,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?Pn.copy(this._scale,e):Pn.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Nn.fromQuat(NC,Fn.conjugate(OC,i._rot)),Nn.multiplyMat4(NC,NC,i._mat),MC.m00=this._scale.x,MC.m04=this._scale.y,MC.m08=this._scale.z,Nn.multiply(NC,MC,Nn.invert(NC,NC)),this._lscale.x=Pn.set(PC,NC.m00,NC.m01,NC.m02).length(),this._lscale.y=Pn.set(PC,NC.m03,NC.m04,NC.m05).length(),this._lscale.z=Pn.set(PC,NC.m06,NC.m07,NC.m08).length()):Pn.copy(this._lscale,this._scale),this.invalidateChildren(my.SCALE),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?Pn.copy(e,this._scale):Pn.copy(new Pn,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new Wn;return Wn.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new Wn;return Wn.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new Wn;return Wn.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=my.ROTATION,void 0!==e.w?(Fn.copy(this._lrot,e),this._eulerDirty=!0):(Pn.copy(this._euler,e),Fn.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(Pn.copy(this._lpos,t),i|=my.POSITION),n&&(Pn.copy(this._lscale,n),i|=my.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){tb.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,FC.length=0,BC.length=0)},t.getPathInHierarchy=function(){for(var e=this.name,t=this.parent;t&&t instanceof n;)e=t.name+"/"+e,t=t.parent;return e},Q(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Fn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){Pn.set(this._euler,0,0,e),Fn.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(my.ROTATION),1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Wn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(my.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(tC.TRANSFORM_CHANGED,my.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Pn.transformQuat(new Pn,Pn.FORWARD,this.worldRotation)},set:function(e){var t=e.length();Pn.multiplyScalar(PC,e,-1/t),Fn.fromViewUp(RC,PC),this.setWorldRotation(RC)}},{key:"up",get:function(){return Pn.transformQuat(new Pn,Pn.UP,this.worldRotation)}},{key:"right",get:function(){return Pn.transformQuat(new Pn,Pn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(tC.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(wC),bC.EventType=tC,bC.NodeSpace=py,bC.TransformDirtyBit=my,bC.TransformBit=my,bC.reserveContentsForAllSyncablePrefabTag=nb,bC.ClearFrame=0,bC.ClearRound=1e3,xC=ce((SC=IC).prototype,"_lpos",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn}}),EC=ce(SC.prototype,"_lrot",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fn}}),TC=ce(SC.prototype,"_lscale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(1,1,1)}}),CC=ce(SC.prototype,"_layer",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ed.Enum.DEFAULT}}),AC=ce(SC.prototype,"_euler",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn}}),ce(SC.prototype,"eulerAngles",[gC],Object.getOwnPropertyDescriptor(SC.prototype,"eulerAngles"),SC.prototype),ce(SC.prototype,"angle",[Hc],Object.getOwnPropertyDescriptor(SC.prototype,"angle"),SC.prototype),ce(SC.prototype,"layer",[Hc],Object.getOwnPropertyDescriptor(SC.prototype,"layer"),SC.prototype),yC=SC))||yC));l.Node=ib;var rb=Tc("cc.TargetInfo")((HC=ce((GC=function(){se(this,"localID",HC,this)}).prototype,"localID",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kC=GC))||kC,ab=(VC=Tc("cc.TargetOverrideInfo"),WC=al(_l),jC=al(rb),XC=al(ib),qC=al(rb),VC((QC=ce((KC=function(){se(this,"source",QC,this),se(this,"sourceInfo",JC,this),se(this,"propertyPath",ZC,this),se(this,"target",$C,this),se(this,"targetInfo",eA,this)}).prototype,"source",[Dc,WC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JC=ce(KC.prototype,"sourceInfo",[Dc,jC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZC=ce(KC.prototype,"propertyPath",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$C=ce(KC.prototype,"target",[Dc,XC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eA=ce(KC.prototype,"targetInfo",[Dc,qC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YC=KC))||YC),ob=Tc("cc.CompPrefabInfo")((iA=ce((nA=function(){se(this,"fileId",iA,this)}).prototype,"fileId",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tA=nA))||tA,sb=(rA=Tc("CCPropertyOverrideInfo"),aA=al(rb),rA((hA=function(){function e(){se(this,"targetInfo",cA,this),se(this,"propertyPath",lA,this),se(this,"value",uA,this)}return e.prototype.isTarget=function(){},e}(),cA=ce((sA=hA).prototype,"targetInfo",[Dc,aA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lA=ce(sA.prototype,"propertyPath",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uA=ce(sA.prototype,"value",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),oA=sA))||oA),cb=(fA=Tc("cc.MountedChildrenInfo"),_A=al(rb),dA=al([ib]),fA((yA=function(){function e(){se(this,"targetInfo",vA,this),se(this,"nodes",gA,this)}return e.prototype.isTarget=function(){},e}(),vA=ce((mA=yA).prototype,"targetInfo",[Dc,_A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gA=ce(mA.prototype,"nodes",[Dc,dA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pA=mA))||pA),lb=(SA=Tc("cc.MountedComponentsInfo"),xA=al(rb),EA=al([Ku]),SA((IA=function(){function e(){se(this,"targetInfo",AA,this),se(this,"components",bA,this)}return e.prototype.isTarget=function(){},e}(),AA=ce((CA=IA).prototype,"targetInfo",[Dc,xA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bA=ce(CA.prototype,"components",[Dc,EA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TA=CA))||TA),ub=(wA=Tc("cc.PrefabInstance"),PA=al(ib),RA=al([cb]),DA=al([lb]),OA=al([sb]),NA=al([rb]),wA((HA=function(){function e(){se(this,"fileId",FA,this),se(this,"prefabRootNode",BA,this),se(this,"mountedChildren",zA,this),se(this,"mountedComponents",UA,this),se(this,"propertyOverrides",kA,this),se(this,"removedComponents",GA,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),FA=ce((LA=HA).prototype,"fileId",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),BA=ce(LA.prototype,"prefabRootNode",[Dc,PA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zA=ce(LA.prototype,"mountedChildren",[Dc,RA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),UA=ce(LA.prototype,"mountedComponents",[Dc,DA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kA=ce(LA.prototype,"propertyOverrides",[Dc,OA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GA=ce(LA.prototype,"removedComponents",[Dc,NA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MA=LA))||MA),hb=(VA=Tc("cc.PrefabInfo"),WA=al(ib),jA=al(ub),XA=al([ab]),VA((KA=ce((YA=function(){se(this,"root",KA,this),se(this,"asset",QA,this),se(this,"fileId",JA,this),se(this,"instance",ZA,this),se(this,"targetOverrides",$A,this),se(this,"nestedPrefabInstanceRoots",eb,this)}).prototype,"root",[Dc,WA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QA=ce(YA.prototype,"asset",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),JA=ce(YA.prototype,"fileId",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZA=ce(YA.prototype,"instance",[Dc,jA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$A=ce(YA.prototype,"targetOverrides",[Dc,XA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),eb=ce(YA.prototype,"nestedPrefabInstanceRoots",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qA=YA))||qA);function fb(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return O(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,r=e._id,a=e._prefab;e[cl],l.game._isCloning=!0,t.asset._doInstantiate(e),l.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=r,e._prefab&&(e._prefab.instance=null==a?void 0:a.instance)}}function _b(e,t,n){var i;if(t&&e){var r=t,a=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&a&&(t[a.fileId]={},r=t[a.fileId]);var o=e._prefab;o&&(r[o.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)_b(e.children[u],r,!1)}}function db(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function pb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var a=db(r.targetInfo.localID,n);if(!a)continue;var o=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)o=o[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&!a._children.includes(u)&&(a._children.push(u),u._parent=a,_b(u,o,!1),u._siblingIndex=a._children.length-1,Sb(u,!0))}}}}function mb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var a=db(r.targetInfo.localID,n);if(!a)continue;if(r.components)for(var o=0;o<r.components.length;o++){var s=r.components[o];s&&(s.node=a,a._components.push(s))}}}}function vb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var a=db(r.localID,n);if(!a||!a.node)continue;var o=a.node.components.indexOf(a);o>=0&&a.node._components.splice(o,1)}}}function gb(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var a=t[r];if(a&&a.targetInfo){if(!(i=db(a.targetInfo.localID,n)))continue;var o=i,s=a.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(o=o[s[l]]);l++);if(!o)continue;if(Array.isArray(o))if("length"===c)o[c]=a.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<o.length&&(o[c]=a.value)}else o[c]instanceof ct?o[c].set(a.value):o[c]=a.value}}}}function yb(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,a,o=n[i],s=o.source,c=o.sourceInfo;if(c){var l,u,h=null===(l=o.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=db(c.localID,h.targetMap))}if(s){var f,_=o.targetInfo;if(_){var d=null===(r=o.target)||void 0===r||null===(a=r._prefab)||void 0===a?void 0:a.instance;if(d&&d.targetMap&&(f=db(_.localID,d.targetMap))){var p=o.propertyPath.slice(),m=s;if(p.length>0){var v=p.pop();if(!v)return;for(var g=0;g<p.length&&(m=m[p[g]]);g++);if(!m)continue;m[v]=f}}}}}}function Sb(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){fb(e);var r={};i.targetMap=r,_b(e,r,!0),pb(0,i.mountedChildren,r),vb(0,i.removedComponents,r),mb(0,i.mountedComponents,r),gb(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){Sb(e,!0)}))}function xb(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){Sb(e)}))}l._PrefabInfo=hb;var Eb,Tb,Cb,Ab,bb,Ib,wb,Pb,Rb,Db,Ob,Nb,Mb,Lb,Fb=Object.freeze({__proto__:null,TargetInfo:rb,TargetOverrideInfo:ab,CompPrefabInfo:ob,PropertyOverrideInfo:sb,MountedChildrenInfo:cb,MountedComponentsInfo:lb,PrefabInstance:ub,PrefabInfo:hb,createNodeWithPrefab:fb,generateTargetMap:_b,getTarget:db,applyMountedChildren:pb,applyMountedComponents:mb,applyRemovedComponents:vb,applyPropertyOverrides:gb,applyTargetOverrides:yb,expandPrefabInstanceNode:Sb,expandNestedPrefabInstanceNode:xb}),Bb=rt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),zb=e("Prefab",Tc("cc.Prefab")((wb=Ib=function(e){function t(){var t;return se(t=e.call(this)||this,"data",Cb,re(t)),se(t,"optimizationPolicy",Ab,re(t)),se(t,"persistent",bb,re(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}Z(t,e);var n=t.prototype;return n.createNode=function(e){var t=l.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof l._BaseNode&&e,new $T(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||R(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==Bb.SINGLE_INSTANCE&&(this.optimizationPolicy===Bb.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new ib,this.data.name="(Missing Node)";var n=new l._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;xb(e),yb(e)},t}(wu),Ib.OptimizationPolicy=Bb,Ib.OptimizationPolicyThreshold=3,Cb=ce((Tb=wb).prototype,"data",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ab=ce(Tb.prototype,"optimizationPolicy",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bb.AUTO}}),bb=ce(Tb.prototype,"persistent",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Eb=Tb))||Eb);nt.value(zb,"_utils",Fb),l.Prefab=zb,Pe(l,"cc._Prefab","Prefab"),e("PrefabLink",(Pb=Tc("cc.PrefabLink"),Rb=al(zb),Db=Vc(),Pb((Lb=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"prefab",Mb,re(t)),t}return Z(t,e),t}(Ku),Mb=ce((Nb=Lb).prototype,"prefab",[Rb,Dc,Db],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ob=Nb))||Ob));var Ub=new Pn;function kb(e,t,n,i){i||(i=new Pn),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function Gb(e,t,n){return n||(n=new Pn),e.worldToScreen(t,n),n.x/=l.view.getScaleX(),n.y/=l.view.getScaleY(),n}var Hb,Vb,Wb=e("convertUtils",{WorldNode3DToLocalNodeUI:kb,WorldNode3DToWorldNodeUI:Gb});l.pipelineUtils=Wb,U(l.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||Ub;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),k(km.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),U(OE.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var jb,Xb=e("BufferAsset",Tc("cc.BufferAsset")((ce((Vb=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}Z(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},Q(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(wu)).prototype,"_nativeAsset",[sl],Object.getOwnPropertyDescriptor(Vb.prototype,"_nativeAsset"),Vb.prototype),Hb=Vb))||Hb);l.BufferAsset=Xb;var qb=((jb={})[di.UNORM]="Uint",jb[di.SNORM]="Int",jb[di.UINT]="Uint",jb[di.INT]="Int",jb[di.UFLOAT]="Float",jb[di.FLOAT]="Float",jb.default="Uint",jb);function Yb(e){return""+(qb[e.type]||qb.default)+e.size/e.count*8}function Kb(e,t,n,i,r){void 0===n&&(n=_i.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var a=na[n];r||(r=a.size);for(var o="set"+Yb(a),s=a.size/a.count,c=Math.floor(t.length/a.count),l=ah.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,f=0;f<a.count;++f){var _=h+s*f;e[o](_,t[a.count*u+f],l)}}function Qb(e,t,n,i,r,a){void 0===t&&(t=_i.R32F),void 0===n&&(n=0),void 0===i&&(i=e.byteLength-n),void 0===r&&(r=0),void 0===a&&(a=[]);var o=na[t];r||(r=o.size);for(var s="get"+Yb(o),c=o.size/o.count,l=Math.floor(i/r),u=ah.isLittleEndian,h=0;h<l;++h)for(var f=n+r*h,_=0;_<o.count;++_){var d=f+c*_;a[o.count*h+_]=e[s](d,u)}return a}function Jb(e,t,n,i,r,a,o){void 0===n&&(n=_i.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===a&&(a=0),o||(o=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=na[n];a||(a=s.size);for(var c="set"+Yb(s),l="get"+Yb(s),u=s.size/s.count,h=Math.floor(r/a),f=ah.isLittleEndian,_=0;_<h;++_)for(var d=i+a*_,p=0;p<s.count;++p){var m=d+u*p,v=e[l](m,f);o[c](m,t(v,p,e),f)}return o}var Zb,$b,eI=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r,a){void 0===i&&(i=null),void 0===r&&(r=null),void 0===a&&(a=!0),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._isOwnerOfIndexBuffer=!0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new Mr(t,e,i,r),this._isOwnerOfIndexBuffer=a,this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],a=e.struct.vertexBundles[r],o=n.indexView?n.indexView.count:a.view.count,s=a.view.stride,c=s*o,l=new Uint8Array(e.data.buffer,a.view.offset,a.view.length),u=new Uint8Array(n.indexView?c:a.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),f=0;f<t;++f)for(var _=f*s,d=h[f]*s,p=0;p<s;++p)u[_+p]=l[d+p];this._flatBuffers.push({stride:s,count:o,buffer:u})}else u.set(e.data.subarray(a.view.offset,a.view.offset+a.view.length)),this._flatBuffers.push({stride:s,count:o,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new Or("a_vertexId",_i.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},Q(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Pn.ZERO,max:Pn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Pn.ZERO,max:Pn.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,$i.ATTR_POSITION),i=e.readIndices(t),r=new Pn,a=new Pn,o=this.attributes.find((function(e){return e.name===$i.ATTR_POSITION}));if(o){var s=na[o.format].count;2===s?(r.set(n[0],n[1],0),a.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),a.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,a.x=n[c]<a.x?n[c]:a.x,a.y=n[c+1]<a.y?n[c+1]:a.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,a.x=n[c]<a.x?n[c]:a.x,a.y=n[c+1]<a.y?n[c+1]:a.y,a.z=n[c+2]<a.z?n[c+2]:a.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:a}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,a=this.mesh.struct,o=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===o.jointMapIndex||!a.jointMaps[o.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=l.director.root.device,c=0;c<o.vertexBundelIndices.length;c++){var u=a.vertexBundles[o.vertexBundelIndices[c]];r=0,i=_i.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var f=u.attributes[h];if(f.name===$i.ATTR_JOINTS){i=f.format;break}r+=na[f.format].size}i?function(){var l=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(l.slice().buffer),f=a.jointMaps[o.jointMapIndex];Jb(h,(function(e){return f.indexOf(e)}),i,r,u.view.length,u.view.stride,h);var _=s.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,u.view.length,u.view.stride));_.update(h.buffer),t.push(_),n.push(c)}():t.push(this.vertexBuffers[o.vertexBundelIndices[c]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Zb||(Zb=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}($b||($b={})),l.SystemEventType=Zb;var tI,nI=new Array(16),iI=null,rI=new Yn,aI=[tC.TOUCH_START,tC.TOUCH_MOVE,tC.TOUCH_END,tC.TOUCH_CANCEL],oI=[tC.MOUSE_DOWN,tC.MOUSE_ENTER,tC.MOUSE_MOVE,tC.MOUSE_LEAVE,tC.MOUSE_UP,tC.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(tI||(tI={}));var sI,cI,lI,uI,hI,fI,_I,dI,pI,mI,vI,gI,yI,SI,xI,EI,TI,CI,AI,bI,II,wI,PI,RI,DI,OI,NI,MI,LI,FI,BI,zI,UI,kI,GI,HI,VI,WI,jI,XI,qI,YI,KI,QI,JI,ZI,$I,ew,tw,nw,iw,rw,aw,ow,sw,cw,lw,uw,hw,fw,_w,dw,pw,mw,vw,gw,yw,Sw,xw,Ew,Tw,Cw,Aw,bw,Iw,ww,Pw,Rw,Dw,Ow,Nw,Mw,Lw,Fw,Bw,zw,Uw,kw,Gw,Hw,Vw,Ww,jw,Xw,qw,Yw,Kw,Qw,Jw,Zw,$w,eP,tP,nP,iP,rP,aP,oP,sP,cP,lP,uP,hP,fP,_P,dP,pP,mP,vP,gP,yP,SP,xP,EP,TP,CP,AP,bP,IP,wP,PP,RP,DP,OP,NP,MP,LP,FP,BP,zP,UP=function(){function e(e){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._isEnabled=!1,this._node=void 0,this._node=e}var t=e.prototype;return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(tI.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){iI===this._node&&(iI=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(tI.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.on=function(e,t,n,i){var r,a;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(a=this.bubblingTarget)&&void 0!==a?a:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},t.once=function(e,t,n,i){var r,a;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(a=this.bubblingTarget)&&void 0!==a?a:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},t.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(tI.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(e,t,n,i,r,a){var o;null===(o=this.bubblingTarget)||void 0===o||o.emit(e,t,n,i,r,a)},t.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,nI.length=0,this.getCapturingTargets(e.type,nI),e.eventPhase=1,i=nI.length-1;i>=0;--i)if((t=nI[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,nI),e.propagationStopped))return void(nI.length=0);if(nI.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,nI),e.eventPhase=3,i=0;i<nI.length;++i)if((t=nI[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(nI.length=0);nI.length=0},t.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},t.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},t.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},t._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&ib.isNode(r);r=r.parent,++n){var a=r.getComponent(e);if(a){var o={index:n,comp:a};i?i.push(o):i=[o]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t._isTouchEvent=function(e){return-1!==aI.indexOf(e)},t._isMouseEvent=function(e){return-1!==oI.indexOf(e)},t._hasTouchListeners=function(){for(var e=0;e<aI.length;++e){var t=aI[e];if(this.hasEventListener(t))return!0}return!1},t._hasMouseListeners=function(){for(var e=0;e<oI.length;++e){var t=oI[e];if(this.hasEventListener(t))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(tI.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new Zl;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(tI.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t._handleEventMouse=function(e){switch(e.type){case $b.MOUSE_DOWN:return this._handleMouseDown(e);case $b.MOUSE_MOVE:return this._handleMouseMove(e);case $b.MOUSE_UP:return this._handleMouseUp(e);case $b.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},t._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(rI),!t._uiProps.uiTransformComp.hitTest(rI)||(e.type=tC.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(rI),t._uiProps.uiTransformComp.hitTest(rI)?(this.previousMouseIn||(iI&&iI!==t&&(e.type=tC.MOUSE_LEAVE,iI.dispatchEvent(e),iI.eventProcessor.previousMouseIn=!1),iI=t,e.type=tC.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=tC.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=tC.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,iI=null),1)))},t._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(rI),!t._uiProps.uiTransformComp.hitTest(rI)||(e.type=tC.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(rI),!t._uiProps.uiTransformComp.hitTest(rI)||(e.type=tC.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleEventTouch=function(e){switch(e.type){case $b.TOUCH_START:return this._handleTouchStart(e);case $b.TOUCH_MOVE:return this._handleTouchMove(e);case $b.TOUCH_END:return this._handleTouchEnd(e);case $b.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},t._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(rI),!t._uiProps.uiTransformComp.hitTest(rI)||(e.type=tC.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},t._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=tC.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},t._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getLocation(rI),t._uiProps.uiTransformComp.hitTest(rI)?e.type=tC.TOUCH_END:e.type=tC.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},t._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=tC.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},Q(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();UP._maskComp=null,UP.callbacksInvoker=new Zl,l.NodeEventProcessor=UP;var kP=new Pn(0,1,0),GP=new Pn,HP=new Zn,VP=new In,WP=new Fn,jP=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},XP=e("AmbientInfo",(sI=Tc("cc.AmbientInfo"),cI=Vc(),lI=Xc(),uI=al(Ot),hI=Xc(),fI=Vc(),_I=Xc(),dI=Oc("_skyColor"),pI=Oc("_skyIllum"),mI=Oc("_groundAlbedo"),sI((ce((gI=function(){function e(){se(this,"_skyColorHDR",yI,this),se(this,"_skyIllumHDR",SI,this),se(this,"_groundAlbedoHDR",xI,this),se(this,"_skyColorLDR",EI,this),se(this,"_skyIllumLDR",TI,this),se(this,"_groundAlbedoLDR",CI,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},Q(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=l.director.root.pipeline.pipelineSceneData.isHDR;return HP.set(e?this._skyColorHDR:this._skyColorLDR),jP(HP),VP.set(255*HP.x,255*HP.y,255*HP.z,255)},set:function(e){HP.set(e.x,e.y,e.z,e.w),l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(HP):this._skyColorLDR.set(HP),this._resource&&this._resource.skyColor.set(HP)}},{key:"skyColor",set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=l.director.root.pipeline.pipelineSceneData.isHDR;return HP.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),jP(HP),VP.set(255*HP.x,255*HP.y,255*HP.z,255)},set:function(e){HP.set(e.x,e.y,e.z,e.w),l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(HP):this._groundAlbedoLDR.set(HP),this._resource&&this._resource.groundAlbedo.set(HP)}},{key:"groundAlbedo",set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}()).prototype,"skyLightingColor",[cI,Hc,lI],Object.getOwnPropertyDescriptor(gI.prototype,"skyLightingColor"),gI.prototype),ce(gI.prototype,"skyIllum",[Hc,uI,hI],Object.getOwnPropertyDescriptor(gI.prototype,"skyIllum"),gI.prototype),ce(gI.prototype,"groundLightingColor",[fI,Hc,_I],Object.getOwnPropertyDescriptor(gI.prototype,"groundLightingColor"),gI.prototype),yI=ce(gI.prototype,"_skyColorHDR",[Dc,dI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.5,.8,1)}}),SI=ce(gI.prototype,"_skyIllumHDR",[Dc,pI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ry.SKY_ILLUM}}),xI=ce(gI.prototype,"_groundAlbedoHDR",[Dc,mI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.2,.2,1)}}),EI=ce(gI.prototype,"_skyColorLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.5,.8,1)}}),TI=ce(gI.prototype,"_skyIllumLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ry.SKY_ILLUM}}),CI=ce(gI.prototype,"_groundAlbedoLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.2,.2,1)}}),vI=gI))||vI));l.AmbientInfo=XP;var qP=e("SkyboxInfo",(AI=Tc("cc.SkyboxInfo"),bI=Xc(),II=al(ly),wI=Xc(),PI=Xc(),RI=al(fv),DI=Xc(),OI=Vc(),NI=al(fv),MI=Zc(),LI=al(fv),FI=Oc("_envmap"),BI=al(fv),zI=al(fv),UI=al(fv),AI((ce((GI=function(){function e(){se(this,"_envLightingType",HI,this),se(this,"_envmapHDR",VI,this),se(this,"_envmapLDR",WI,this),se(this,"_diffuseMapHDR",jI,this),se(this,"_diffuseMapLDR",XI,this),se(this,"_enabled",qI,this),se(this,"_useHDR",YI,this),this._resource=null}return e.prototype.activate=function(e){this.envLightingType=this._envLightingType,this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},Q(e,[{key:"applyDiffuseMap",get:function(){return ly.DIFFUSEMAP_WITH_REFLECTION===this._envLightingType},set:function(e){this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"envLightingType",get:function(){return this._envLightingType},set:function(e){this.envmap||ly.HEMISPHERE_DIFFUSE===e?(ly.HEMISPHERE_DIFFUSE===e?(this.useIBL=!1,this.applyDiffuseMap=!1):ly.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION===e?(this.useIBL=!0,this.applyDiffuseMap=!1):ly.DIFFUSEMAP_WITH_REFLECTION===e&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=e):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=ly.HEMISPHERE_DIFFUSE,R(15001))}},{key:"useIBL",get:function(){return ly.HEMISPHERE_DIFFUSE!==this._envLightingType},set:function(e){this._resource&&(this._resource.useIBL=e)}},{key:"useHDR",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,this.envLightingType===ly.DIFFUSEMAP_WITH_REFLECTION&&(null===this.diffuseMap?(this.envLightingType=ly.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION,R(15e3)):this.diffuseMap.isDefault&&R(15002))),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){var t=l.director.root.pipeline.pipelineSceneData.isHDR;t?this._envmapHDR=e:this._envmapLDR=e,e||(t?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=ly.HEMISPHERE_DIFFUSE,R(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}()).prototype,"enabled",[Hc,bI],Object.getOwnPropertyDescriptor(GI.prototype,"enabled"),GI.prototype),ce(GI.prototype,"envLightingType",[Hc,II,wI],Object.getOwnPropertyDescriptor(GI.prototype,"envLightingType"),GI.prototype),ce(GI.prototype,"useHDR",[Hc,PI],Object.getOwnPropertyDescriptor(GI.prototype,"useHDR"),GI.prototype),ce(GI.prototype,"envmap",[Hc,RI,DI],Object.getOwnPropertyDescriptor(GI.prototype,"envmap"),GI.prototype),ce(GI.prototype,"diffuseMap",[OI,Hc,Wc,NI,MI],Object.getOwnPropertyDescriptor(GI.prototype,"diffuseMap"),GI.prototype),HI=ce(GI.prototype,"_envLightingType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ly.HEMISPHERE_DIFFUSE}}),VI=ce(GI.prototype,"_envmapHDR",[Dc,LI,FI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WI=ce(GI.prototype,"_envmapLDR",[Dc,BI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jI=ce(GI.prototype,"_diffuseMapHDR",[Dc,zI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XI=ce(GI.prototype,"_diffuseMapLDR",[Dc,UI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qI=ce(GI.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YI=ce(GI.prototype,"_useHDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kI=GI))||kI));l.SkyboxInfo=qP;var YP=e("FogInfo",(KI=Tc("cc.FogInfo"),QI=Xc(),JI=Zc(),ZI=Xc(),$I=Zc(),ew=Xc(),tw=al(fy),nw=Zc(),iw=Xc(),rw=Vc(),aw=al(Ot),ow=qc(),sw=Qc(),cw=Xc(),lw=Vc(),uw=al(Ot),hw=Qc(),fw=Xc(),_w=Vc(),dw=al(Ot),pw=Qc(),mw=Xc(),vw=Vc(),gw=al(Ot),yw=Yc(),Sw=Qc(),xw=Xc(),Ew=Vc(),Tw=al(Ot),Cw=Qc(),Aw=Xc(),bw=Vc(),Iw=al(Ot),ww=Qc(),Pw=Xc(),KI((Vw=Hw=function(){function e(){se(this,"_type",Ow,this),se(this,"_fogColor",Nw,this),se(this,"_enabled",Mw,this),se(this,"_fogDensity",Lw,this),se(this,"_fogStart",Fw,this),se(this,"_fogEnd",Bw,this),se(this,"_fogAtten",zw,this),se(this,"_fogTop",Uw,this),se(this,"_fogRange",kw,this),se(this,"_accurate",Gw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},Q(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),Hw.FogType=fy,ce((Dw=Vw).prototype,"enabled",[Hc,QI,JI],Object.getOwnPropertyDescriptor(Dw.prototype,"enabled"),Dw.prototype),ce(Dw.prototype,"accurate",[Hc,ZI,$I],Object.getOwnPropertyDescriptor(Dw.prototype,"accurate"),Dw.prototype),ce(Dw.prototype,"fogColor",[Hc,ew],Object.getOwnPropertyDescriptor(Dw.prototype,"fogColor"),Dw.prototype),ce(Dw.prototype,"type",[Hc,tw,nw,iw],Object.getOwnPropertyDescriptor(Dw.prototype,"type"),Dw.prototype),ce(Dw.prototype,"fogDensity",[rw,aw,ow,sw,Jc,cw],Object.getOwnPropertyDescriptor(Dw.prototype,"fogDensity"),Dw.prototype),ce(Dw.prototype,"fogStart",[lw,uw,hw,fw],Object.getOwnPropertyDescriptor(Dw.prototype,"fogStart"),Dw.prototype),ce(Dw.prototype,"fogEnd",[_w,dw,pw,mw],Object.getOwnPropertyDescriptor(Dw.prototype,"fogEnd"),Dw.prototype),ce(Dw.prototype,"fogAtten",[vw,gw,yw,Sw,xw],Object.getOwnPropertyDescriptor(Dw.prototype,"fogAtten"),Dw.prototype),ce(Dw.prototype,"fogTop",[Ew,Tw,Cw,Aw],Object.getOwnPropertyDescriptor(Dw.prototype,"fogTop"),Dw.prototype),ce(Dw.prototype,"fogRange",[bw,Iw,ww,Pw],Object.getOwnPropertyDescriptor(Dw.prototype,"fogRange"),Dw.prototype),Ow=ce(Dw.prototype,"_type",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fy.LINEAR}}),Nw=ce(Dw.prototype,"_fogColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In("#C8C8C8")}}),Mw=ce(Dw.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lw=ce(Dw.prototype,"_fogDensity",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Fw=ce(Dw.prototype,"_fogStart",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Bw=ce(Dw.prototype,"_fogEnd",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),zw=ce(Dw.prototype,"_fogAtten",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Uw=ce(Dw.prototype,"_fogTop",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),kw=ce(Dw.prototype,"_fogRange",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Gw=ce(Dw.prototype,"_accurate",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rw=Dw))||Rw)),KP=e("ShadowsInfo",(Ww=Tc("cc.ShadowsInfo"),jw=Xc(),Xw=al(sg),qw=Vc(),Yw=Vc(),Kw=Xc(),Qw=al(Ot),Jw=Vc(),Zw=Xc(),$w=al(Dt),eP=Xc(),tP=Vc(),nP=al(og),iP=Xc(),rP=Vc(),Ww((ce((oP=function(){function e(){se(this,"_enabled",sP,this),se(this,"_type",cP,this),se(this,"_normal",lP,this),se(this,"_distance",uP,this),se(this,"_shadowColor",hP,this),se(this,"_maxReceived",fP,this),se(this,"_size",_P,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(WP),this.planeDirection=Pn.transformQuat(GP,kP,WP),e.getWorldPosition(GP),this.planeHeight=Pn.dot(this._normal,GP)},t.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},Q(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"planeDirection",get:function(){return this._normal},set:function(e){Pn.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"planeHeight",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=-e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"enabled",[Hc,jw],Object.getOwnPropertyDescriptor(oP.prototype,"enabled"),oP.prototype),ce(oP.prototype,"type",[Hc,Xw],Object.getOwnPropertyDescriptor(oP.prototype,"type"),oP.prototype),ce(oP.prototype,"shadowColor",[qw],Object.getOwnPropertyDescriptor(oP.prototype,"shadowColor"),oP.prototype),ce(oP.prototype,"planeDirection",[Yw,Kw],Object.getOwnPropertyDescriptor(oP.prototype,"planeDirection"),oP.prototype),ce(oP.prototype,"planeHeight",[Hc,Qw,Jw,Zw],Object.getOwnPropertyDescriptor(oP.prototype,"planeHeight"),oP.prototype),ce(oP.prototype,"maxReceived",[$w,eP,tP],Object.getOwnPropertyDescriptor(oP.prototype,"maxReceived"),oP.prototype),ce(oP.prototype,"shadowMapSize",[nP,iP,rP],Object.getOwnPropertyDescriptor(oP.prototype,"shadowMapSize"),oP.prototype),sP=ce(oP.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cP=ce(oP.prototype,"_type",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sg.Planar}}),lP=ce(oP.prototype,"_normal",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(0,1,0)}}),uP=ce(oP.prototype,"_distance",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hP=ce(oP.prototype,"_shadowColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(0,0,0,76)}}),fP=ce(oP.prototype,"_maxReceived",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),_P=ce(oP.prototype,"_size",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(512,512)}}),aP=oP))||aP));l.ShadowsInfo=KP;var QP=e("DEFAULT_WORLD_MIN_POS",new Pn(-1024,-1024,-1024)),JP=e("DEFAULT_WORLD_MAX_POS",new Pn(1024,1024,1024)),ZP=e("DEFAULT_OCTREE_DEPTH",8),$P=e("OctreeInfo",(dP=Tc("cc.OctreeInfo"),pP=Xc(),mP=Xc(),vP=jc(),gP=Xc(),yP=jc(),SP=qc(),xP=al(Dt),EP=Xc(),dP((ce((CP=function(){function e(){se(this,"_enabled",AP,this),se(this,"_minPos",bP,this),se(this,"_maxPos",IP,this),se(this,"_depth",wP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},Q(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}()).prototype,"enabled",[Hc,pP],Object.getOwnPropertyDescriptor(CP.prototype,"enabled"),CP.prototype),ce(CP.prototype,"minPos",[Hc,mP,vP],Object.getOwnPropertyDescriptor(CP.prototype,"minPos"),CP.prototype),ce(CP.prototype,"maxPos",[Hc,gP,yP],Object.getOwnPropertyDescriptor(CP.prototype,"maxPos"),CP.prototype),ce(CP.prototype,"depth",[Hc,SP,Jc,xP,EP],Object.getOwnPropertyDescriptor(CP.prototype,"depth"),CP.prototype),AP=ce(CP.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bP=ce(CP.prototype,"_minPos",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(QP)}}),IP=ce(CP.prototype,"_maxPos",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(JP)}}),wP=ce(CP.prototype,"_depth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZP}}),TP=CP))||TP)),eR=e("SceneGlobals",(PP=Tc("cc.SceneGlobals"),RP=al(qP),PP((zP=function(){function e(){se(this,"ambient",NP,this),se(this,"shadows",MP,this),se(this,"_skybox",LP,this),se(this,"fog",FP,this),se(this,"octree",BP,this)}return e.prototype.activate=function(){var e=l.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},Q(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),NP=ce((OP=zP).prototype,"ambient",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XP}}),MP=ce(OP.prototype,"shadows",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KP}}),LP=ce(OP.prototype,"_skybox",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qP}}),FP=ce(OP.prototype,"fog",[Hc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new YP}}),ce(OP.prototype,"skybox",[Hc,RP],Object.getOwnPropertyDescriptor(OP.prototype,"skybox"),OP.prototype),BP=ce(OP.prototype,"octree",[Hc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $P}}),DP=OP))||DP));l.SceneGlobals=eR;var tR=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());tR.NO_TYPE="no_type",tR.TOUCH="touch",tR.MOUSE="mouse",tR.KEYBOARD="keyboard",tR.ACCELERATION="acceleration",tR.NONE=0,tR.CAPTURING_PHASE=1,tR.AT_TARGET=2,tR.BUBBLING_PHASE=3,l.Event=tR;var nR=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,Zb.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return Z(t,e),t}(tR));tR.EventAcceleration=nR;var iR=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?Zb.KEY_DOWN:Zb.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==Zb.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return Z(t,e),Q(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(tR));tR.EventKeyboard=iR;var rR=e("EventMouse",function(e){function t(n,i,r){var a;return(a=e.call(this,n,i)||this).movementX=0,a.movementY=0,a.preventSwallow=!1,a._eventType=void 0,a._button=t.BUTTON_MISSING,a._x=0,a._y=0,a._prevX=0,a._prevY=0,a._scrollX=0,a._scrollY=0,a._eventType=n,r&&(a._prevX=r.x,a._prevY=r.y),a}Z(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new Yn),Yn.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new Yn),Yn.set(e,this._x,l.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new Yn),Yn.set(e,this._x,this._y),l.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new Yn),Yn.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new Yn),Yn.set(e,this._prevX,this._prevY),l.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new Yn),Yn.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new Yn),Yn.set(e,(this._x-this._prevX)/l.view.getScaleX(),(this._y-this._prevY)/l.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/l.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/l.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=l.view.getViewportRect();return(this._x-e.x)/l.view.getScaleX()},n.getUILocationY=function(){var e=l.view.getViewportRect();return(this._y-e.y)/l.view.getScaleY()},Q(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(tR));rR.BUTTON_MISSING=-1,rR.BUTTON_LEFT=0,rR.BUTTON_RIGHT=2,rR.BUTTON_MIDDLE=1,rR.BUTTON_4=3,rR.BUTTON_5=4,rR.BUTTON_6=5,rR.BUTTON_7=6,rR.BUTTON_8=7,tR.EventMouse=rR;var aR=new Yn,oR=e("EventTouch",function(e){function t(t,n,i,r){var a;return void 0===r&&(r=[]),(a=e.call(this,i,n)||this).touch=null,a.simulate=!1,a.preventSwallow=!1,a._eventCode=void 0,a._touches=void 0,a._allTouches=void 0,a._eventCode=i,a._touches=t||[],a._allTouches=r,a}Z(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new Yn},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new Yn},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new Yn},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new Yn},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new Yn},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new Yn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new Yn},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new Yn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(aR).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(aR).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(tR));oR.MAX_TOUCHES=5,tR.EventTouch=oR;var sR,cR=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(sR||(sR=e("KeyCode",{})));var lR=new Yn,uR=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new Yn,this._prevPoint=new Yn,this._lastModified=0,this._id=0,this._startPoint=new Yn,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new Yn),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new Yn),e.set(this._point.x,this._point.y),l.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=l.view.getViewportRect();return(this._point.x-e.x)/l.view.getScaleX()},t.getUILocationY=function(){var e=l.view.getViewportRect();return(this._point.y-e.y)/l.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new Yn),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new Yn),e.set(this._prevPoint.x,this._prevPoint.y),l.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new Yn),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new Yn),e.set(this._startPoint.x,this._startPoint.y),l.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new Yn),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new Yn),lR.set(this._point),lR.subtract(this._prevPoint),e.set(l.view.getScaleX(),l.view.getScaleY()),Yn.divide(e,lR,e),e},t.getLocationInView=function(e){return e||(e=new Yn),e.set(this._point.x,l.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new Yn),e.set(this._prevPoint.x,l.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new Yn),e.set(this._startPoint.x,l.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new Yn(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new Yn(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=l.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new Yn(e.x,e.y):new Yn(e||0,t||0),this._lastModified=l.game.frameStartTime},Q(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());l.Touch=uR;var hR,fR,_R=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new ou,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,hu.browserType===eu.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;n=.1*((null==a?void 0:a.x)||0),i=.1*((null==a?void 0:a.y)||0),r=.1*((null==a?void 0:a.z)||0)}else{var o=e;n=(o.gamma||0)/90*.981,i=-(o.beta||0)/90*.981,r=(o.alpha||0)/90*.981}if(nh.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),hu.os===iu.ANDROID&&hu.browserType!==eu.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new cR(n,i,r,l),h=new nR(u);this._eventTarget.emit($b.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),dR={Backspace:sR.BACKSPACE,Tab:sR.TAB,Enter:sR.ENTER,ShiftLeft:sR.SHIFT_LEFT,ControlLeft:sR.CTRL_LEFT,AltLeft:sR.ALT_LEFT,ShiftRight:sR.SHIFT_RIGHT,ControlRight:sR.CTRL_RIGHT,AltRight:sR.ALT_RIGHT,Pause:sR.PAUSE,CapsLock:sR.CAPS_LOCK,Escape:sR.ESCAPE,Space:sR.SPACE,PageUp:sR.PAGE_UP,PageDown:sR.PAGE_DOWN,End:sR.END,Home:sR.HOME,ArrowLeft:sR.ARROW_LEFT,ArrowUp:sR.ARROW_UP,ArrowRight:sR.ARROW_RIGHT,ArrowDown:sR.ARROW_DOWN,Insert:sR.INSERT,Delete:sR.DELETE,Digit0:sR.DIGIT_0,Digit1:sR.DIGIT_1,Digit2:sR.DIGIT_2,Digit3:sR.DIGIT_3,Digit4:sR.DIGIT_4,Digit5:sR.DIGIT_5,Digit6:sR.DIGIT_6,Digit7:sR.DIGIT_7,Digit8:sR.DIGIT_8,Digit9:sR.DIGIT_9,KeyA:sR.KEY_A,KeyB:sR.KEY_B,KeyC:sR.KEY_C,KeyD:sR.KEY_D,KeyE:sR.KEY_E,KeyF:sR.KEY_F,KeyG:sR.KEY_G,KeyH:sR.KEY_H,KeyI:sR.KEY_I,KeyJ:sR.KEY_J,KeyK:sR.KEY_K,KeyL:sR.KEY_L,KeyM:sR.KEY_M,KeyN:sR.KEY_N,KeyO:sR.KEY_O,KeyP:sR.KEY_P,KeyQ:sR.KEY_Q,KeyR:sR.KEY_R,KeyS:sR.KEY_S,KeyT:sR.KEY_T,KeyU:sR.KEY_U,KeyV:sR.KEY_V,KeyW:sR.KEY_W,KeyX:sR.KEY_X,KeyY:sR.KEY_Y,KeyZ:sR.KEY_Z,Numpad0:sR.NUM_0,Numpad1:sR.NUM_1,Numpad2:sR.NUM_2,Numpad3:sR.NUM_3,Numpad4:sR.NUM_4,Numpad5:sR.NUM_5,Numpad6:sR.NUM_6,Numpad7:sR.NUM_7,Numpad8:sR.NUM_8,Numpad9:sR.NUM_9,NumpadMultiply:sR.NUM_MULTIPLY,NumpadAdd:sR.NUM_PLUS,NumpadSubtract:sR.NUM_SUBTRACT,NumpadDecimal:sR.NUM_DECIMAL,NumpadDivide:sR.NUM_DIVIDE,NumpadEnter:sR.NUM_ENTER,F1:sR.F1,F2:sR.F2,F3:sR.F3,F4:sR.F4,F5:sR.F5,F6:sR.F6,F7:sR.F7,F8:sR.F8,F9:sR.F9,F10:sR.F10,F11:sR.F11,F12:sR.F12,NumLock:sR.NUM_LOCK,ScrollLock:sR.SCROLL_LOCK,Semicolon:sR.SEMICOLON,Equal:sR.EQUAL,Comma:sR.COMMA,Minus:sR.DASH,Period:sR.PERIOD,Slash:sR.SLASH,Backquote:sR.BACK_QUOTE,BracketLeft:sR.BRACKET_LEFT,Backslash:sR.BACKSLASH,BracketRight:sR.BRACKET_RIGHT,Quote:sR.QUOTE},pR=function(){function e(){this._eventTarget=new ou,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,$b.KEY_PRESSING);e._eventTarget.emit($b.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,$b.KEY_DOWN);e._eventTarget.emit($b.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,$b.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit($b.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,dR[n]||sR.NONE);return new iR(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),mR=function(){function e(){this._canvas=void 0,this._eventTarget=new ou,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Yn,hu.hasFeature(au.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new ii(t.x,t.y,t.width,t.height):new ii(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=nh.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new Yn(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback($b.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback($b.MOUSE_MOVE));var a=this._createCallback($b.MOUSE_UP);window.addEventListener("mouseup",a),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",a),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),a=n.button;switch(e){case $b.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case $b.MOUSE_UP:t._isPressed=!1;break;case $b.MOUSE_MOVE:t._isPressed||(a=rR.BUTTON_MISSING)}var o=new rR(e,!1,t._preMousePos);o.setLocation(r.x,r.y),o.setButton(a),o.movementX=n.movementX,o.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,o)}},t._handleMouseWheel=function(e){var t=$b.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new rR(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),vR=new Yn,gR=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(vR);var n=new uR(vR.x,vR.y,t);return e.getLocation(vR),n.setPoint(vR.x,vR.y),e.getPreviousLocation(vR),n.setPrevPoint(vR),n},t._createTouch=function(e,t,n){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var i=new uR(t,n,e);return this._touchMap.set(e,i),this._updateTouch(i,t,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e,t,n){var i=this._touchMap.get(e);return i?this._updateTouch(i,t,n):i=this._createTouch(e,t,n),i?this._cloneTouch(i):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touchMap.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(vR),e.setPrevPoint(vR),e.setPoint(t,n)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var n=lt.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(e){i-e.lastModified>lt.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),n>=this._touchMap.size},e}()),yR=function(){function e(){this._canvas=void 0,this._eventTarget=new ou,hu.hasFeature(au.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback($b.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback($b.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback($b.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback($b.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),a=[],o=n.changedTouches.length,s=0;s<o;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=gR.getTouch(l,u.x,u.y);h&&(e!==$b.TOUCH_END&&e!==$b.TOUCH_CANCEL||gR.releaseTouch(l),a.push(h))}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===$b.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),a.length>0){var f=new oR(a,!1,e,lt.ENABLE_MULTI_TOUCH?gR.getAllTouches():a);t._eventTarget.emit(e,f)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new ii(t.x,t.y,t.width,t.height):new ii(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(nh.isFrameRotated){var r=n;n=t.height-i,i=r}var a=nh.devicePixelRatio;return new Yn(n*=a,i*=a)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(fR||(fR={}));var SR=function(){function e(e){this.priority=fR.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),xR=((hR={})[$b.MOUSE_DOWN]=$b.TOUCH_START,hR[$b.MOUSE_MOVE]=$b.TOUCH_MOVE,hR[$b.MOUSE_UP]=$b.TOUCH_END,hR),ER=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new ou,this._touchInput=new yR,this._mouseInput=new mR,this._keyboardInput=new pR,this._accelerometerInput=new _R,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new SR(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var t=e.prototype;return t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=xR[e.type],n=gR.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new oR(i,!1,t,i);t===$b.TOUCH_END&&gR.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,n=0;n<t&&this._eventDispatcherList[n].dispatchEvent(e);++n);},t._registerEvent=function(){var e=this;if(ah.hasFeature(ah.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on($b.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on($b.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on($b.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on($b.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(ah.hasFeature(ah.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on($b.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on($b.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on($b.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on($b.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(ah.hasFeature(ah.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on($b.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on($b.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on($b.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(ah.hasFeature(ah.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on($b.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._emitEvent(i)}for(var r=this._eventTouchList,a=0,o=r.length;a<o;++a)for(var s=r[a],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,f=0,_=h.length;f<_;++f){var d=h[f];this._emitEvent(d)}for(var p=this._eventAccelerationList,m=0,v=p.length;m<v;++m){var g=p[m];this._emitEvent(g)}this._clearEvents()},e}());ER.EventType=$b;var TR=e("input",new ER),CR=e("SystemEvent",function(e){function t(){var t;return t=e.call(this)||this,TR.on($b.MOUSE_DOWN,(function(e){t.emit(Zb.MOUSE_DOWN,e)})),TR.on($b.MOUSE_MOVE,(function(e){t.emit(Zb.MOUSE_MOVE,e)})),TR.on($b.MOUSE_UP,(function(e){t.emit(Zb.MOUSE_UP,e)})),TR.on($b.MOUSE_WHEEL,(function(e){t.emit(Zb.MOUSE_WHEEL,e)})),TR.on($b.TOUCH_START,(function(e){t.emit(Zb.TOUCH_START,e.touch,e)})),TR.on($b.TOUCH_MOVE,(function(e){t.emit(Zb.TOUCH_MOVE,e.touch,e)})),TR.on($b.TOUCH_END,(function(e){t.emit(Zb.TOUCH_END,e.touch,e)})),TR.on($b.TOUCH_CANCEL,(function(e){t.emit(Zb.TOUCH_CANCEL,e.touch,e)})),TR.on($b.KEY_DOWN,(function(e){t.emit(Zb.KEY_DOWN,e)})),TR.on($b.KEY_PRESSING,(function(e){t.emit(Zb.KEY_DOWN,e)})),TR.on($b.KEY_UP,(function(e){t.emit(Zb.KEY_UP,e)})),TR.on($b.DEVICEMOTION,(function(e){t.emit(Zb.DEVICEMOTION,e)})),t}Z(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){TR.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){TR.setAccelerometerInterval(e)},n.on=function(t,n,i,r){return e.prototype.on.call(this,t,n,i,r),n},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i)},t}(ou));CR.EventType=Zb,l.SystemEvent=CR;var AR,bR=e("systemEvent",new CR);l.systemEvent=bR,U(Zb,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),U(tR,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:CR.EventType,targetName:"SystemEvent.EventType"}]),G(tR,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),U(rR,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:CR.EventType,targetName:"SystemEvent.EventType"}}))),U(rR,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:CR.EventType,targetName:"SystemEvent.EventType"}]),G(rR.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),U(oR,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:CR.EventType,targetName:"SystemEvent.EventType"}]),U(oR,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:CR.EventType,targetName:"SystemEvent.EventType"}]),U(oR,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:CR.EventType,targetName:"SystemEvent.EventType"}]),U(oR,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:CR.EventType,targetName:"SystemEvent.EventType"}]),G(oR.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),U(oR.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:oR,targetName:"EventTouch"}]),G(lt.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),G(lt.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),G(lt.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),G(lt.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),G(lt,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),U(wC.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),U(ib.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Yn),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new ti),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),k(eR.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),U(eR.prototype,"SceneGlobals.prototype",[{name:"distance",newName:"planeHeight"},{name:"normal",newName:"planeDirection"}]),k(ib.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),U(hC.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),k(Ed,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),U(Ed,"Layers",[{name:"Default",newName:"DEFAULT",target:Ed.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Ed.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Ed.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Ed.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Ed.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Ed.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Ed.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Ed.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Ed,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Ed,targetName:"Layers"}]),k(Ed.Enum,"Layers.Enum",[{name:"ALWAYS"}]),k(Ed.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var IR,wR,PR,RR,DR=_l.Flags.HideInHierarchy,OR=_l.Flags.DontSave,NR=e("PrivateNode",Tc("cc.PrivateNode")(AR=function(e){function t(t){var n;return R(12003,(n=e.call(this,t)||this).name),n.hideFlags|=OR|DR,n}return Z(t,e),t}(ib))||AR);U(Zb,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:ib.EventType,targetName:"Node.EventType"}}))),U(ib.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:CR.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:CR.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:CR.EventType,targetName:"SystemEvent.EventType"}]),l.PrivateNode=NR;var MR=e("Scene",Tc("cc.Scene")((ce((wR=function(e){Z(n,e);var t=n.prototype;function n(t){var n;return se(n=e.call(this,t)||this,"autoReleaseAssets",PR,re(n)),se(n,"_globals",RR,re(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=Pn.ZERO,n._rot=Fn.IDENTITY,n._scale=Pn.ONE,n._mat=Wn.IDENTITY,n._dirtyFlags=0,n._lpos=Pn.ZERO,n._lrot=Fn.IDENTITY,n._lscale=Pn.ONE,n._activeInHierarchy=!1,l.director&&l.director.root&&(n._renderScene=l.director.root.createScene({})),n._inited=!l.game||!l.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=_l.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&l.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(F(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return Pn.copy(e||new Pn,Pn.ZERO)},t.getRotation=function(e){return Fn.copy(e||new Fn,Fn.IDENTITY)},t.getScale=function(e){return Pn.copy(e||new Pn,Pn.ONE)},t.getWorldPosition=function(e){return Pn.copy(e||new Pn,Pn.ZERO)},t.getWorldRotation=function(e){return Fn.copy(e||new Fn,Fn.IDENTITY)},t.getWorldScale=function(e){return Pn.copy(e||new Pn,Pn.ONE)},t.getWorldMatrix=function(e){return Wn.copy(e||new Wn,Wn.IDENTITY)},t.getWorldRS=function(e){return Wn.copy(e||new Wn,Wn.IDENTITY)},t.getWorldRT=function(e){return Wn.copy(e||new Wn,Wn.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(xb(this),yb(this),this._onBatchCreated(false),this._inited=!0),this.walk(wC._setScene)},t._activate=function(e){e=!1!==e,l.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},Q(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return Pn.ZERO}},{key:"worldPosition",get:function(){return Pn.ZERO}},{key:"rotation",get:function(){return Fn.IDENTITY}},{key:"worldRotation",get:function(){return Fn.IDENTITY}},{key:"scale",get:function(){return Pn.ONE}},{key:"worldScale",get:function(){return Pn.ONE}},{key:"eulerAngles",get:function(){return Pn.ZERO}},{key:"worldMatrix",get:function(){return Wn.IDENTITY}}]),n}(wC)).prototype,"globals",[Hc],Object.getOwnPropertyDescriptor(wR.prototype,"globals"),wR.prototype),PR=ce(wR.prototype,"autoReleaseAssets",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RR=ce(wR.prototype,"_globals",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new eR}}),IR=wR))||IR);function LR(e,t){if(!t){var n=l.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}l.Scene=MR,l.find=LR;var FR=tt.fastRemoveAt,BR=_l.Flags.IsStartCalled,zR=_l.Flags.IsOnEnableCalled;function UR(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,a=e.length-1,o=a>>>1;r<=a;o=r+a>>>1){var s=e[o],c=s.constructor._executionOrder;if(c>n)a=o-1;else if(c<n)r=o+1;else{var l=s._id;if(l>i)a=o-1;else{if(!(l<i))return o;r=o+1}}}return~r}function kR(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}_l.Flags.IsEditorOnEnableCalled;var GR=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=le;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function HR(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}GR.stableRemoveInactive=kR;var VR=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){kR(this._zero,e),kR(this._neg,e),kR(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(HR),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(HR),this._invoke(t),t.array.length=0)},t}(GR),WR=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=UR(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=UR(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(GR);function jR(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",r=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,r){try{t(i,r)}catch(t){l._throw(t);var a=i.array;for(n&&(a[i.i]._objFlags|=n),++i.i;i.i<a.length;++i.i)try{e(a[i.i],r)}catch(e){l._throw(e),n&&(a[i.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}var XR=jR("c.start();c._objFlags|="+BR,!1,BR),qR=jR("c.update(dt)",!0),YR=jR("c.lateUpdate(dt)",!0),KR=function(e){var t=l.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},QR=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new VR(XR),this.updateInvoker=new WR(qR),this.lateUpdateInvoker=new WR(YR),this._updating=!1},t._onEnabled=function(e){l.director.getScheduler().resumeTarget(e),e._objFlags|=zR,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){l.director.getScheduler().pauseTarget(e),e._objFlags&=~zR;var t=this._deferredComps.indexOf(e);t>=0?FR(this._deferredComps,t):(!e.start||e._objFlags&BR||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&zR)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&zR&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&BR||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),JR=_l.Flags.IsPreloadStarted,ZR=_l.Flags.IsOnLoadStarted,$R=_l.Flags.IsOnLoadCalled,eD=_l.Flags.Deactivating,tD=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){GR.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(GR),nD=jR("c.__preload();"),iD=jR("c.onLoad();c._objFlags|="+$R,!1,$R),rD=new et(4);function aD(e,t,n){O(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):tt.removeAt(e._components,n)}rD.get=function(){var e=this._get()||{preload:new tD(nD),onLoad:new VR(iD),onEnable:new VR(KR)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var oD,sD,cD,lD,uD,hD,fD,_D,dD=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=rD.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),rD.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=oe(this._activatingStack);!(i=r()).done;){var a=i.value;a.preload.cancelInactive(JR),a.onLoad.cancelInactive(ZR),a.onEnable.cancelInactive()}}e.emit(tC.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,i){if(pl(e,!0)&&(e._objFlags&JR||(e._objFlags|=JR,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&ZR||(e._objFlags|=ZR,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=$R):e._objFlags|=$R),e._enabled)){if(!e.node._activeInHierarchy)return;l.director._compScheduler.enableComp(e,i)}},t.destroyComp=function(e){l.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&$R&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,i){if(e._objFlags&eD)O(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,a=0;a<r;++a){var o=e._components[a];o instanceof l.Component?this.activateComp(o,t,n,i):(aD(e,o,a),--a,--r)}for(var s=0,c=e._children.length;s<c;++s){var u=e._children[s];u._active&&this._activateNodeRecursively(u,t,n,i)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=eD,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(l.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~eD)}for(var r=0,a=e._children.length;r<a;++r){var o=e._children[r];if(o._activeInHierarchy&&(this._deactivateNodeRecursively(o),e._activeInHierarchy))return void(e._objFlags&=~eD)}e._onPostActivated(!1),e._objFlags&=~eD},e}()),pD=e("SceneAsset",Tc("cc.SceneAsset")((lD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"scene",cD,re(t)),t}Z(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new MR("New Scene")},n.validate=function(){return!!this.scene},t}(wu),cD=ce((sD=lD).prototype,"scene",[Hc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oD=sD))||oD);l.SceneAsset=pD;var mD,vD,gD,yD,SD=e("TextAsset",Tc("cc.TextAsset")((_D=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"text",fD,re(t)),t}return Z(t,e),t.prototype.toString=function(){return this.text},t}(wu),fD=ce((hD=_D).prototype,"text",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uD=hD))||uD);l.TextAsset=SD;var xD=e("JsonAsset",Tc("cc.JsonAsset")((yD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"json",gD,re(t)),t}return Z(t,e),t}(wu),gD=ce((vD=yD).prototype,"json",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mD=vD))||mD);l.JsonAsset=xD;var ED,TD,CD,AD,bD,ID,wD,PD,RD,DD,OD,ND,MD,LD,FD,BD,zD,UD,kD,GD,HD,VD,WD,jD,XD,qD,YD,KD,QD,JD,ZD,$D,eO,tO,nO,iO,rO,aO,oO=function(){var e=t.prototype;function t(){this.fog=new dy,this.ambient=new ry,this.skybox=new uy,this.shadows=new ug,this.octree=new gy,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0},e.initGeometryRendererMaterials=function(){for(var e=0,t=0;t<6;t++){this._geometryRendererMaterials[t]=new Qv,this._geometryRendererMaterials[t]._uuid="geometry-renderer-material-"+t,this._geometryRendererMaterials[t].initialize({effectName:"geometry-renderer",technique:t});for(var n=0;n<this._geometryRendererMaterials[t].passes.length;++n)this._geometryRendererPasses[e]=this._geometryRendererMaterials[t].passes[n],this._geometryRendererShaders[e]=this._geometryRendererMaterials[t].passes[n].getShaderVariant(),e++}},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Qv;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),a=Uint16Array.BYTES_PER_ELEMENT,o=36*a;this._occlusionQueryIndicesBuffer=e.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,o,a)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Or("a_position",_i.RGB32F)],c=new Mr(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},Q(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(MS.ATTACHMENT_SCALE_CAHNGED,e))}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}}]),t}(),sO=e("ForwardPipeline",(ED=Tc("ForwardPipeline"),TD=al([ME]),CD=Zc(),ED((wD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",ID,re(t)),t._postRenderPass=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new zT;n.initialize(zT.initInfo),this._flows.push(n);var i=new ST;i.initialize(ST.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new oO,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(O(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Hd,t),this._descriptorSet.bindTexture(Hd,Sv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Jd,t),this._descriptorSet.bindTexture(Jd,Sv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Ud.BINDING).destroy(),this._descriptorSet.getBuffer(Gd.BINDING).destroy(),this._descriptorSet.getBuffer(kd.BINDING).destroy(),this._descriptorSet.getTexture(Hd).destroy(),this._descriptorSet.getTexture(Jd).destroy())},Q(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(nx),ID=ce((bD=wD).prototype,"renderTextures",[TD,Dc,CD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AD=bD))||AD)),cO=[new hr(0,0,0,0),new hr(0,0,0,0),new hr(0,0,0,0)],lO=e("GbufferStage",(PD=Tc("GbufferStage"),RD=al([BE]),DD=Zc(),PD((FD=LD=function(e){function t(){var t;return se(t=e.call(this)||this,"renderQueues",MD,re(t)),t._renderQueues=[],t._renderArea=new ir,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=xv("default"),t._batchedQueue=new WE,t._instancedQueue=new jE,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=GE(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(HE),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,a=0,o=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(a=0;a<h.length;++a){var f=h[a];if(f.phase===this._phaseID){var _=f.batchingScheme;if(_===mv.INSTANCING){var d=f.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,a),this._instancedQueue.queue.add(d)}else if(_===mv.VB_MERGING){var p=f.getBatchedBuffer();p.merge(u,a,c.model),this._batchedQueue.queue.add(p)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(c,r,a)}}}}this._renderQueues.forEach(VE);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&Ki.COLOR&&(t.pipelineSceneData.isHDR?Dv(cO[0],e.clearColor):(cO[0].x=e.clearColor.x,cO[0].y=e.clearColor.y,cO[0].z=e.clearColor.z)),cO[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,cO,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(Md.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(NS),LD.initInfo={name:"GbufferStage",priority:YS.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:NE.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:NE.BACK_TO_FRONT,stages:["default"]}]},MD=ce((ND=FD).prototype,"renderQueues",[RD,Dc,DD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OD=ND))||OD)),uO=[new hr(0,0,0,1)],hO=e("LightingStage",(BD=Tc("LightingStage"),zD=al(Qv),UD=Zc(),kD=al([BE]),GD=Zc(),BD((qD=XD=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=ap.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new ir,t._uiPhase=void 0,se(t,"_deferredMaterial",WD,re(t)),se(t,"renderQueues",jD,re(t)),t._phaseID=xv("default"),t._renderQueues=[],t._uiPhase=new vT,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,a=lo.create(0,0,0,1),o=new Float32Array(4),s=e.exposure,c=0,l=Zn.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var f=i[h];if(lo.set(a,f.position.x,f.position.y,f.position.z,f.range),ds.sphereFrustum(a,e.frustum)){if(Pn.toArray(o,f.position),o[3]=0,this._lightBufferData.set(o,c*l),Pn.toArray(o,f.color),f.useColorTemperature){var _=f.colorTemperatureRGB;o[0]*=_.x,o[1]*=_.y,o[2]*=_.z}t.pipelineSceneData.isHDR?o[3]=f.luminance*s*this._lightMeterScale:o[3]=f.luminance,this._lightBufferData.set(o,c*l+1*u),o[0]=f.size,o[1]=f.range,o[2]=0,this._lightBufferData.set(o,c*l+2*u)}}for(var d=0;d<r.length&&c<this._maxDeferredLights;d++,++c){var p=r[d];if(lo.set(a,p.position.x,p.position.y,p.position.z,p.range),ds.sphereFrustum(a,e.frustum)){if(Pn.toArray(o,p.position),o[3]=1,this._lightBufferData.set(o,c*l+0*u),Pn.toArray(o,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;o[0]*=m.x,o[1]*=m.y,o[2]*=m.z}t.pipelineSceneData.isHDR?o[3]=p.luminance*s*this._lightMeterScale:o[3]=p.luminance,this._lightBufferData.set(o,c*l+1*u),o[0]=p.size,o[1]=p.range,o[2]=p.spotAngle,this._lightBufferData.set(o,c*l+2*u),Pn.toArray(o,p.direction),this._lightBufferData.set(o,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n._createStageDescriptor=function(e){var t=this._pipeline.device,n=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;n=Math.ceil(n/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,n,t.capabilities.uboOffsetAlignment));var i=t.createBuffer(new mr(this._deferredLitsBufs,0,n));this._lightBufferData=new Float32Array(n/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new jr(e.localSetLayout)),this._descriptorSet.bindBuffer(rp.BINDING,i);var r=t.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,ep.SIZE,ep.SIZE));this._descriptorSet.bindBuffer(ep.BINDING,r)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=GE(this.renderQueues[i]);this._planarQueue=new mT(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,a=r.renderObjects;this._planarQueue.gatherShadowPasses(e,i),t.generateRenderArea(e,this._renderArea);for(var o=t.getPipelineRenderData(),s=r.deferredLightingMaterial.passes[0],c=s.getShaderVariant(),l=0;l<3;++l)s.descriptorSet.bindTexture(l,o.gbufferRenderTargets[l]),s.descriptorSet.bindSampler(l,o.sampler);s.descriptorSet.bindTexture(3,o.outputDepth),s.descriptorSet.bindSampler(3,o.sampler),s.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(s),this.gatherLights(e),e.clearFlag&Ki.COLOR&&(uO[0].x=e.clearColor.x,uO[0].y=e.clearColor.y,uO[0].z=e.clearColor.z),uO[0].w=0;var u=o.outputFrameBuffer,h=u.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(h,u,this._renderArea,uO,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(Md.GLOBAL,t.descriptorSet);var f=t.quadIAOffscreen,_=null;null!=s&&null!=c&&null!=f&&(_=wv.getOrCreatePipelineState(n,s,c,h,f)),null!=_&&(this._descriptorSet.update(),i.bindPipelineState(_),i.bindDescriptorSet(Md.MATERIAL,s.descriptorSet),i.bindDescriptorSet(Md.LOCAL,this._descriptorSet),i.bindInputAssembler(f),i.draw(f)),this._renderQueues.forEach(HE);for(var d=0,p=0,m=0,v=0;v<a.length;++v){var g=a[v],y=g.model.subModels;for(d=0;d<y.length;++d){var S=y[d].passes;for(p=0;p<S.length;++p)if(S[p].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,d,p)}}if(a.length>0){this._renderQueues.forEach(VE);for(var x=0;x<this._renderQueues.length;x++)this._renderQueues[x].recordCommandBuffer(n,h,i);this._planarQueue.recordCommandBuffer(n,h,i)}this._pipeline.geometryRenderer.render(h,i),this._uiPhase.render(e,h),i.endRenderPass()},t}(NS),XD.initInfo={name:"LightingStage",priority:YS.LIGHTING,tag:0},WD=ce((VD=qD).prototype,"_deferredMaterial",[zD,Dc,UD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jD=ce(VD.prototype,"renderQueues",[kD,Dc,GD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HD=VD))||HD)),fO=[new hr(0,0,0,1)],_O=e("PostProcessStage",(YD=Tc("PostProcessStage"),KD=al(Qv),QD=Zc(),JD=al([BE]),ZD=Zc(),YD((rO=iO=function(e){function t(){var t;return se(t=e.call(this)||this,"_postProcessMaterial",tO,re(t)),se(t,"renderQueues",nO,re(t)),t._renderArea=new ir,t._stageDesc=void 0,t._localUBO=void 0,t._uiPhase=new vT,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var a=e.viewport;this._renderArea.x=a.x*e.window.width,this._renderArea.y=a.y*e.window.height,this._renderArea.width=a.width*e.window.width,this._renderArea.height=a.height*e.window.height;var o=t.getPipelineRenderData(),s=e.window.framebuffer,c=t.getRenderPass(e.clearFlag,s);e.clearFlag&Ki.COLOR&&(fO[0].x=e.clearColor.x,fO[0].y=e.clearColor.y,fO[0].z=e.clearColor.z),fO[0].w=e.clearColor.w,r.beginRenderPass(c,s,this._renderArea,fO,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Md.GLOBAL,t.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();t.bloomEnabled?l.descriptorSet.bindTexture(0,o.bloom.combineTex):l.descriptorSet.bindTexture(0,o.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,o.sampler),l.descriptorSet.update();var h=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=h&&(f=wv.getOrCreatePipelineState(n,l,u,c,h));var _=t.pipelineSceneData.renderObjects;null!=f&&_.length>0&&(this._stageDesc||(this._stageDesc=n.createDescriptorSet(new jr(l.localSetLayout)),this._localUBO=n.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,ep.SIZE,ep.SIZE)),this._stageDesc.bindBuffer(ep.BINDING,this._localUBO)),this._stageDesc.update(),r.bindPipelineState(f),r.bindDescriptorSet(Md.MATERIAL,l.descriptorSet),r.bindDescriptorSet(Md.LOCAL,this._stageDesc),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(e,c),Vv(n,c,r,t.profiler,e),r.endRenderPass()},t}(NS),iO.initInfo={name:"PostProcessStage",priority:jS.POST_PROCESS,tag:0},tO=ce((eO=rO).prototype,"_postProcessMaterial",[KD,Dc,QD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nO=ce(eO.prototype,"renderQueues",[JD,Dc,ZD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$D=eO))||$D));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(aO||(aO={}));var dO,pO,mO,vO,gO,yO,SO,xO,EO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=aO.NONE,t}Z(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var a=this._bloomMaterial.passes[7+i];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently(),t.push(r.native),n.push(a.native)}var o=this._bloomMaterial.passes[13];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new Qv;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new Qv;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new Qv;r._uuid="builtin-post-process-material",lt.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=aO.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var a=0;a<r.passes.length;++a)r.passes[a].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},Q(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new Qv;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(oO),TO=[new hr(0,0,0,1)],CO=function(){};CO.SIZE=4*(CO.COUNT=4+(CO.TEXTURE_SIZE_OFFSET=0));var AO,bO,IO,wO,PO,RO,DO,OO,NO,MO,LO=e("BloomStage",(dO=Tc("BloomStage"),pO=al(Qv),mO=Zc(),dO((xO=SO=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,se(t,"_bloomMaterial",yO,re(t)),t._renderArea=new ir,t._bloomUBO=[],t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,CO.SIZE,CO.SIZE));e.clearFlag&Ki.COLOR&&(TO[0].x=e.clearColor.x,TO[0].y=e.clearColor.y,TO[0].z=e.clearColor.z),TO[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),a=r.bloom,o=new Float32Array(CO.COUNT);o[CO.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],o),n.beginRenderPass(a.renderPass,a.prefilterFramebuffer,this._renderArea,TO,0,0),n.bindDescriptorSet(Md.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,a.sampler),i.descriptorSet.update(),n.bindDescriptorSet(Md.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=wv.getOrCreatePipelineState(t.device,i,l,a.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,a=new Float32Array(CO.COUNT),o=0;o<this.iterations;++o){a[CO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[CO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[o+1],a),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[o],this._renderArea,TO,0,0);var s=i.passes[1+o],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[o+1]),0===o?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[o-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Md.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=wv.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,a=new Float32Array(CO.COUNT),o=0;o<this.iterations;++o){var s=o+6+1;a[CO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[CO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],a),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-o],this._renderArea,TO,0,0);var c=r.passes[7+o],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===o?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-o]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(Md.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=wv.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),a=r.bloom,o=new Float32Array(CO.COUNT);o[CO.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],o),n.beginRenderPass(a.renderPass,a.combineFramebuffer,this._renderArea,TO,0,0),n.bindDescriptorSet(Md.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,a.upsampleTexs[0]),s.descriptorSet.bindSampler(1,a.sampler),s.descriptorSet.bindSampler(2,a.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Md.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=wv.getOrCreatePipelineState(t.device,s,u,a.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(NS),SO.initInfo={name:"BloomStage",priority:jS.BLOOM,tag:0},yO=ce((gO=xO).prototype,"_bloomMaterial",[pO,Dc,mO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vO=gO))||vO)),FO=e("MainFlow",Tc("MainFlow")((IO=bO=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new lO;n.initialize(lO.initInfo),this._stages.push(n);var i=new hO;i.initialize(hO.initInfo),this._stages.push(i);var r=new LO;r.initialize(LO.initInfo),this._stages.push(r);var a=new _O;a.initialize(_O.initInfo),this._stages.push(a)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(LS),bO.initInfo={name:Ad,priority:KS.MAIN,stages:[]},AO=IO))||AO),BO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return Z(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),zO=e("DeferredPipeline",(wO=Tc("DeferredPipeline"),PO=al([ME]),RO=Zc(),wO((MO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,se(t,"renderTextures",NO,re(t)),t}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new zT;n.initialize(zT.initInfo),this._flows.push(n);var i=new FO;i.initialize(FO.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new EO,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(O(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Hd,n),this._descriptorSet.bindTexture(Hd,Sv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Jd,n),this._descriptorSet.bindTexture(Jd,Sv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new tx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var a=new Lr;a.format=_i.RGBA16F,a.loadOp=Mi.CLEAR,a.storeOp=Li.STORE;var o=new Lr;o.format=_i.RGBA16F,o.loadOp=Mi.CLEAR,o.storeOp=Li.STORE;var s=new Lr;s.format=_i.RGBA16F,s.loadOp=Mi.CLEAR,s.storeOp=Li.STORE;var c=new Fr;c.format=_i.DEPTH_STENCIL,c.depthLoadOp=Mi.CLEAR,c.depthStoreOp=Li.STORE,c.stencilLoadOp=Mi.CLEAR,c.stencilStoreOp=Li.STORE;var l=new Ur([a,o,s],c);this._gbufferRenderPass=t.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Lr;u.format=_i.RGBA8,u.loadOp=Mi.CLEAR,u.storeOp=Li.STORE,u.barrier=t.getGeneralBarrier(new kr(Fi.NONE,Fi.COLOR_ATTACHMENT_WRITE));var h=new Fr;h.format=_i.DEPTH_STENCIL,h.depthLoadOp=Mi.LOAD,h.depthStoreOp=Li.DISCARD,h.stencilLoadOp=Mi.LOAD,h.stencilStoreOp=Li.DISCARD,u.barrier=t.getGeneralBarrier(new kr(Fi.DEPTH_STENCIL_ATTACHMENT_WRITE,Fi.DEPTH_STENCIL_ATTACHMENT_WRITE));var f=new Ur([u],h);this._lightingRenderPass=t.createRenderPass(f)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Ud.BINDING).destroy(),this._descriptorSet.getBuffer(Gd.BINDING).destroy(),this._descriptorSet.getBuffer(kd.BINDING).destroy(),this._descriptorSet.getTexture(Hd).destroy(),this._descriptorSet.getTexture(Jd).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new BO,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(t.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new Sr(Si.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT|xi.SAMPLED,_i.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new Hr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED,_i.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new Hr(this._lightingRenderPass,n.outputRenderTargets,null)),n.sampler=this.globalDSManager.pointSampler,this.on(MS.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)}))},t}(nx),NO=ce((OO=MO).prototype,"renderTextures",[PO,Dc,RO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DO=OO))||DO));function UO(){var e=new sO;return e.initialize({flows:[]}),e}var kO=new Yn,GO=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new hr(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new hr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{l.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?l.view.setDesignResolutionSize(n.width,n.height,n.policy):l.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,l.game.once(l.Game.EVENT_GAME_INITED,(function(){l.director._lateUpdate=performance.now()}),l.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else x("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),l.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new hr(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new ir(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,a=4*r;this.vertexBuffers=t.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,a,r)),this.vertexBuffers.update(i);var o=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,c,s)),this.indicesBuffers.update(o);var l=[new Or("a_position",_i.RG32F),new Or("a_texCoord",_i.RG32F)],u=new Mr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new Wn,Wn.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),l.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,a=e.swapchain;Wn.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,a.surfaceTransform);var o=a.width,s=a.height,c=o<s?o:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=uf(ln(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,f=e.logoTexture.height,_=c*i.displayRatio,d=_*h/f,p=_;if(a.surfaceTransform!==hi.ROTATE_90&&a.surfaceTransform!==hi.ROTATE_270||(d=_*o/s,p=_*f/h*s/o),e.logoMat.setProperty("resolution",kO.set(o,s),0),e.logoMat.setProperty("scale",kO.set(d,p),0),e.logoMat.setProperty("translate",kO.set(.5*o,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;a.surfaceTransform!==hi.ROTATE_90&&a.surfaceTransform!==hi.ROTATE_270||(g=.5*m,y=m*o/s*.5),e.watermarkMat.setProperty("resolution",kO.set(o,s),0),e.watermarkMat.setProperty("scale",kO.set(g,y),0),e.watermarkMat.setProperty("translate",kO.set(.5*o,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new Qv,this.logoMat.initialize({effectName:"splash-screen"});var t=new Er;t.addressU=Ii.CLAMP,t.addressV=Ii.CLAMP,t.addressW=Ii.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new Sr(Si.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,_i.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var a=new lr;a.texExtent.width=this.logoImage.width,a.texExtent.height=this.logoImage.height,a.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[a])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new lr;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Sr(Si.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,_i.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new Qv,this.watermarkMat.initialize({effectName:"splash-screen"});var a=this.watermarkMat.passes[0],o=a.getBinding("mainTexture");a.bindTexture(o,this.watermarkTexture),a.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var a=this.logoMat.passes[0],o=wv.getOrCreatePipelineState(e,a,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(o),n.bindDescriptorSet(Md.MATERIAL,a.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=wv.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(Md.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},Q(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();GO._ins=void 0,l.internal.SplashScreen=GO;var HO=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},Q(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());HO.Priority=rt({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var VO=new pe("Scheduler"),WO=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};WO.get=function(e,t,n,i){var r=WO._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new WO(e,t,n,i),r},WO.put=function(e){WO._listEntries.length<20&&(e.target=null,WO._listEntries.push(e))},WO._listEntries=[];var jO=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};jO.get=function(e,t,n,i){var r=jO._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new jO(e,t,n,i),r},jO.put=function(e){jO._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,jO._hashUpdateEntries.push(e))},jO._hashUpdateEntries=[];var XO=function(e,t,n,i,r,a){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=a};XO.get=function(e,t,n,i,r,a){var o=XO._hashTimerEntries.pop();return o?(o.timers=e,o.target=t,o.timerIndex=n,o.currentTimer=i,o.currentTimerSalvaged=r,o.paused=a):o=new XO(e,t,n,i,r,a),o},XO.put=function(e){XO._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,XO._hashTimerEntries.push(e))},XO._hashTimerEntries=[];var qO=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,i,r,a){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=a,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===l.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();qO._timers=[],qO.get=function(){return qO._timers.pop()||new qO},qO.put=function(e){qO._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,qO._timers.push(e))};var YO,KO=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=Ie(!0),t._hashForTimers=Ie(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}Z(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?R(1513):e.id=VO.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var o=this._arrayForTimers;for(t=0;t<o.length;t++){if(a=o[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,i,r,a){if("function"!=typeof e){var o=e;e=t,t=o}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!i,i=l.macro.REPEAT_FOREVER,r=0),L(t,1502);var s=t.uuid||t.id;if(s){var c,u,h=this._hashForTimers[s];if(h?h.paused!==a&&R(1511):(h=XO.get(null,t,0,null,null,a),this._arrayForTimers.push(h),this._hashForTimers[s]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((c=h.timers[u])&&e===c._callback)return w(1507,c.getInterval(),n),void(c._interval=n);(c=qO.get()).initWithCallback(this,e,t,n,i,r),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else O(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return w(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var a,o=WO.get(e,t,n,!1);0===t?(a=this._updates0List,this._appendIn(a,o)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,o,t)),this._hashForUpdates[i]=jO.get(a,o,e,null)}else O(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,a=0,o=r.length;a<o;a++){var s=r[a];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(a,1),qO.put(s),i.timerIndex>=a&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else O(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else O(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,a=i.length;r<a;r++)qO.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else O(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(HO.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),a===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){L(e,1508),L(t,1509);var n=t.uuid||t.id;if(!n)return O(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,a=0;a<r.length;++a)if(e===r[a]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(HO.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,a=[],o=this._arrayForTimers;for(n=0,i=o.length;n<i;n++)(t=o[n])&&(t.paused=!0,a.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,a.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){L(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else O(1510)},n.resumeTarget=function(e){L(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else O(1510)},n.isTargetPaused=function(e){L(e,1505);var t=e.uuid||e.id;if(!t)return O(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}XO.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,a=0,o=i.length;a<o;a++)if(i[a]===r){i.splice(a,1);break}delete this._hashForUpdates[t],WO.put(r),jO.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(HO));KO.ID="scheduler",l.Scheduler=KO;var QO=((YO={})[Ju.PORTRAIT]=hi.IDENTITY,YO[Ju.LANDSCAPE_RIGHT]=hi.ROTATE_90,YO[Ju.PORTRAIT_UPSIDE_DOWN]=hi.ROTATE_180,YO[Ju.LANDSCAPE_LEFT]=hi.ROTATE_270,YO),JO=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new Sr(Si.TEX2D,xi.COLOR_ATTACHMENT|xi.SAMPLED|xi.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==_i.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new Sr(Si.TEX2D,xi.DEPTH_STENCIL_ATTACHMENT|xi.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new Hr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,QO[nh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Hr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=oe(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},Q(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),ZO=e("Root",function(){function e(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=l.internal.DataPoolManager&&new l.internal.DataPoolManager(e),Ly.registerCreateFunc(this),JO.registerCreateFunc(this),this._cameraPool=new Vl((function(){return new ag(t._device)}),4,(function(e){return e.destroy()}))}var t=e.prototype;return t.initialize=function(){this._init();var e=l.game._swapchain,t=new Lr;t.format=e.colorTexture.format;var n=new Fr;n.format=e.depthStencilTexture.format,n.depthStoreOp=Li.DISCARD,n.stencilStoreOp=Li.DISCARD;var i=new Ur([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:i,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(Sv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(e,t){for(var n,i=oe(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},t.setRenderPipeline=function(e){e instanceof zO&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=UO(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(fi.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=l.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&l.internal.Batcher2D&&(this._batcher=new l.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(e){this._curWindow=e},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([l.game._swapchain]);var a=this._scenes,o=l.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<a.length;s++)a[s].update(o);l.director.emit(l.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},t.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},t.destroyWindows=function(){for(var e,t=oe(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},t.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},t.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},t.destroyScenes=function(){for(var e,t=oe(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},t.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new Vl((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):R(1300,e.constructor.name),e.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new Vl((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case vy.SPHERE:e.scene.removeSphereLight(e);break;case vy.SPOT:e.scene.removeSpotLight(e)}e.destroy()},t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(e){this._cumulativeTime+=e},t._setFrameTime=function(e){this._frameTime=e},Q(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}());l.Root=ZO;var $O=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t._onEngineInitedCallback=[],t}Z(t,e);var i=t.prototype;return i.setFrameRate=function(e){this.frameRate=e},i.getFrameRate=function(){return this.frameRate},i.step=function(){l.director.tick(this.frameTime/1e3)},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(TR._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},i.isPaused=function(){return this._paused},i.restart=function(){var e=this;return new Promise((function(e){return l.director.once(l.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return l.director.getScene().destroy(),l.Object._deferredDestroy(),l.director.reset(),l.profiler.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},i.end=function(){hu.close()},i.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},i.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},i.init=function(e){var t=this;if(this._initConfig(e),rh._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&l.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,r=0;r<i.length;r++){var a=i[r],o=n(a.value);Ed.addLayer(a.name,o)}return this._initEngine().then((function(){return t._initEvents(),l.director.root&&l.director.root.dataPoolManager&&l.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},i.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Qi.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},i.addPersistRootNode=function(e){if(l.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=l.director._scene;if(l.isValid(n))if(e.parent){if(!(e.parent instanceof l.Scene))return void R(3801);if(e.parent!==n)return void R(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,l.assetManager._releaseManager._addPersistNodeRef(e)}}else R(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",l.assetManager._releaseManager._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},i.onEngineInitedAsync=function(e){this._onEngineInitedCallback.push(e)},i._initEngine=function(){var e=this;this._initDevice();var n=l.director;return Promise.resolve(n._init()).then((function(){l.view.init(),y("Cocos Creator v"+u),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,l.internal.dynamicAtlasManager&&(l.internal.dynamicAtlasManager.enabled=!lt.CLEANUP_IMAGE_CACHE)})).then((function(){var t=e._onEngineInitedCallback.map((function(e){return e()})).filter(Boolean);return e._onEngineInitedCallback.length=0,Promise.all(t)}))},i._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},i._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},i._ctTime=function(e){window.clearTimeout(e)},i._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},i._updateCallback=function(){var e,t=this,n=l.director;if(30===this._frameRate){var i=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(i=!i)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},i._runMainLoop=function(){if(this._inited){var e=this.config,t=l.director;z(!!e.showFPS),t.startAnimation(),this.resume()}},i._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=N.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,C(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},i._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(F(3820,n))},i._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new dr(zd),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||ah.browserType===eu.UC)&&(i=!1);var a=[];i&&l.WebGL2Device&&a.push(l.WebGL2Device),l.WebGLDevice&&a.push(l.WebGLDevice),l.EmptyDevice&&a.push(l.EmptyDevice),pa.canvas=this.canvas;for(var o=0;o<a.length&&(this._gfxDevice=new a[o],!this._gfxDevice.initialize(n));o++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&l.EmptyDevice&&(this._gfxDevice=new l.EmptyDevice,this._gfxDevice.initialize(new dr(zd)));if(!this._gfxDevice)return x("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var s=new _r(this.canvas),c=rh.windowSize;s.width=c.width,s.height=c.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){hu.on("show",this._onShow,this),hu.on("hide",this._onHide,this)},i._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},i._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){l.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof nx?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){S(n),S("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(l.internal.SplashScreen){var e=l.internal.SplashScreen.instance;return e.main(l.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},i._setRenderPipeline=function(e){l.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},i._safeEmit=function(e){this.emit(e)},Q(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(ou));$O.EVENT_HIDE="game_on_hide",$O.EVENT_SHOW="game_on_show",$O.EVENT_LOW_MEMORY="game_on_low_memory",$O.EVENT_GAME_INITED="game_inited",$O.EVENT_ENGINE_INITED="engine_inited",$O.EVENT_RENDERER_INITED="renderer_inited",$O.EVENT_RESTART="game_on_restart",$O.RENDER_TYPE_CANVAS=0,$O.RENDER_TYPE_WEBGL=1,$O.RENDER_TYPE_OPENGL=2,$O.RENDER_TYPE_HEADLESS=3,$O.DEBUG_DT_THRESHOLD=1,l.Game=$O;var eN=e("game",l.game=new $O),tN=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new KO,t._compScheduler=new QR,t._nodeActivator=new dD,t._systems=[],eN.once($O.EVENT_RENDERER_INITED,t._initOnRendererInitialized,re(t)),t}Z(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),l.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),l.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof pD&&(e=e.scene),L(e instanceof MR,1216),e._load();for(var i=Object.keys(eN._persistRootNodes).map((function(e){return eN._persistRootNodes[e]})),r=0;r<i.length;r++){var a=i[r];a.emit(l.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.uuid===a._originalSceneId&&e.getChildByUuid(a.uuid);if(o){var s=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(a,s)}else a.parent=e}var c=this._scene;l.isValid(c)&&c.destroy(),l.assetManager._releaseManager._autoRelease(c,e,eN._persistRootNodes),this._scene=null,_l._deferredDestroy(),t&&t(),this.emit(l.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(l.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var i=this;e instanceof pD&&(e=e.scene),L(e,1205),L(e instanceof MR,1216),e._load(),this.once(l.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var i=this;if(this._loadingScene)return R(1208,e,this._loadingScene),!1;var r=l.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return r?(this.emit(l.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),r.loadScene(e,(function(r,a){console.timeEnd("LoadScene "+e),i._loadingScene="",r?(x(r),t&&t(r)):i.runSceneImmediate(a,n,t)})),!0):(O(1209,e),!1)},n.preloadScene=function(e,t,n){var i=l.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var r='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(r)),x("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return eN.deltaTime},n.getTotalTime=function(){return eN.totalTime},n.getCurrentTime=function(){return eN.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(KO.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(HO.sortByPriority)},n.unregisterSystem=function(e){tt.fastRemove(this._systems,e),this._systems.sort(HO.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(l.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=eN._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),TR._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),_l._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),ib.resetHasChangedFlags(),ib.clearNodeArray(),Gl.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(KO.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new ZO(eN._gfxDevice),this._root.initialize({}).catch((function(e){return O(1217),Promise.reject(e)}))},Q(t,[{key:"root",get:function(){return this._root}}]),t}(ou));tN.EVENT_INIT="director_init",tN.EVENT_RESET="director_reset",tN.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",tN.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",tN.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",tN.EVENT_BEFORE_UPDATE="director_before_update",tN.EVENT_AFTER_UPDATE="director_after_update",tN.EVENT_BEFORE_DRAW="director_before_draw",tN.EVENT_AFTER_DRAW="director_after_draw",tN.EVENT_BEFORE_COMMIT="director_before_commit",tN.EVENT_BEFORE_PHYSICS="director_before_physics",tN.EVENT_AFTER_PHYSICS="director_after_physics",tN.EVENT_BEGIN_FRAME="director_begin_frame",tN.EVENT_END_FRAME="director_end_frame",tN.instance=void 0,l.Director=tN;var nN=e("director",tN.instance=l.director=new tN),iN={};U(iN,"vmath",[{name:"vec2",newName:"Vec2",target:si,targetName:"math"},{name:"vec3",newName:"Vec3",target:si,targetName:"math"},{name:"vec4",newName:"Vec4",target:si,targetName:"math"},{name:"quat",newName:"Quat",target:si,targetName:"math"},{name:"mat3",newName:"Mat3",target:si,targetName:"math"},{name:"mat4",newName:"Mat4",target:si,targetName:"math"},{name:"color4",newName:"Color",target:si,targetName:"math"},{name:"rect",newName:"Rect",target:si,targetName:"math"},{name:"approx",newName:"approx",target:si,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:si,targetName:"math"},{name:"equals",newName:"equals",target:si,targetName:"math"},{name:"clamp",newName:"clamp",target:si,targetName:"math"},{name:"clamp01",newName:"clamp01",target:si,targetName:"math"},{name:"lerp",newName:"lerp",target:si,targetName:"math"},{name:"toRadian",newName:"toRadian",target:si,targetName:"math"},{name:"toDegree",newName:"toDegree",target:si,targetName:"math"},{name:"random",newName:"random",target:si,targetName:"math"},{name:"randomRange",newName:"randomRange",target:si,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:si,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:si,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:si,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:si,targetName:"math"},{name:"repeat",newName:"repeat",target:si,targetName:"math"},{name:"pingPong",newName:"pingPong",target:si,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:si,targetName:"math"}]),l.vmath=iN,U(KO.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:KO,targetName:"Scheduler"}]),U(KO,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return HO.Priority.SCHEDULER}}]),k(KO,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),U(Jg.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),k(Jg.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),U(ZO.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),G(eN,"game",[{name:"collisionMatrix"},{name:"groupList"}]),G(tN.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),k(tN.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var rN,aN={topLeft:l.v2(0,0),topRight:l.v2(0,0),top:l.v2(0,0),bottomLeft:l.v2(0,0),bottomRight:l.v2(0,0),bottom:l.v2(0,0),center:l.v2(0,0),left:l.v2(0,0),right:l.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,a=r+n,o=i+t;this.topLeft.x=i,this.topLeft.y=a,this.topRight.x=o,this.topRight.y=a,this.top.x=i+t/2,this.top.y=a,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=o,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=o,this.right.y=r+n/2}};l.visibleRect=aN;var oN=new ti,sN=((rN={})[lt.ORIENTATION_AUTO]=Ju.AUTO,rN[lt.ORIENTATION_LANDSCAPE]=Ju.LANDSCAPE,rN[lt.ORIENTATION_PORTRAIT]=Ju.PORTRAIT,rN),cN=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=lN,i=uN;return t._designResolutionSize=new ti(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new ii(0,0,0,0),t._visibleRect=new ii(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new hN(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new hN(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new hN(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new hN(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new hN(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}Z(t,e);var n=t.prototype;return n.init=function(){var e=rh.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,oN.width=this._visibleRect.width,oN.height=this._visibleRect.height,aN&&aN.init(this._visibleRect),nh.on("window-resize",this._updateAdaptResult,this),nh.on("orientation-change",this._updateAdaptResult,this),nh.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){nh.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){nh.orientation=sN[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&rh.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){nh.resolutionScale=1;var n=nh.devicePixelRatio,i=new ti(e*n,t*n);rh.windowSize=i},n.getCanvasSize=function(){return rh.windowSize},n.getFrameSize=function(){var e=nh.devicePixelRatio,t=rh.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=nh.devicePixelRatio;rh.windowSize=new ti(e*n,t*n)},n.getVisibleSize=function(){return new ti(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new ti(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Yn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Yn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof hN)this._resolutionPolicy=e;else{var t=hN;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=fN.getDesignResolutionSize();fN.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,o=this._visibleRect,s=r.viewport;a.x=s.x,a.y=s.y,a.width=s.width,a.height=s.height,o.x=0,o.y=0,o.width=s.width/this._scaleX,o.height=s.height/this._scaleY}i.postApply(this),oN.width=this._visibleRect.width,oN.height=this._visibleRect.height,aN&&aN.init(this._visibleRect),this.emit("design-resolution-changed")}else O(2200)},n.getDesignResolutionSize=function(){return new ti(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return nh.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new Yn);var r=nh.devicePixelRatio*(e-n.left),a=nh.devicePixelRatio*(n.top+n.height-t);return nh.isFrameRotated?(i.x=rh.windowSize.width-a,i.y=r):(i.x=r,i.y=a),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;l.director.root.resize(rh.windowSize.width,rh.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(ou));cN.instance=void 0;var lN=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=eN.canvas;if(e){var t=rh.windowSize;e.width=t.width,e.height=t.height}},e}();lN.EQUAL_TO_FRAME=void 0,lN.PROPORTION_TO_FRAME=void 0;var uN=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,a){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var o=new ii(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,a],this._result.viewport=o,this._result},e}();uN.EXACT_FIT=void 0,uN.SHOW_ALL=void 0,uN.NO_BORDER=void 0,uN.FIXED_HEIGHT=void 0,uN.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return Z(t,e),t.prototype.apply=function(){nh.isProportionalToFrame=!1,this._setupCanvas()},t}(lN),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return Z(t,e),t.prototype.apply=function(){nh.isProportionalToFrame=!0,this._setupCanvas()},t}(lN);lN.EQUAL_TO_FRAME=new e,lN.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return Z(t,e),t.prototype.apply=function(e,t){var n=rh.windowSize,i=n.width,r=n.height,a=i/t.width,o=r/t.height;return this._buildResult(i,r,i,r,a,o)},t}(uN),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return Z(t,e),t.prototype.apply=function(e,t){var n,i,r=rh.windowSize,a=r.width,o=r.height,s=t.width,c=t.height,l=a/s,u=o/c,h=0;return l<u?(n=a,i=c*(h=l)):(n=s*(h=u),i=o),this._buildResult(a,o,n,i,h,h)},t}(uN),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return Z(t,e),t.prototype.apply=function(e,t){var n,i,r,a=rh.windowSize,o=a.width,s=a.height,c=t.width,l=t.height,u=o/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=o,r=l*(n=u)),this._buildResult(o,s,i,r,n,n)},t}(uN),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return Z(t,e),t.prototype.apply=function(e,t){var n=rh.windowSize,i=n.width,r=n.height,a=r/t.height,o=i,s=r;return this._buildResult(i,r,o,s,a,a)},t}(uN),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return Z(t,e),t.prototype.apply=function(e,t){var n=rh.windowSize,i=n.width,r=n.height,a=i/t.width,o=i,s=r;return this._buildResult(i,r,o,s,a,a)},t}(uN);uN.EXACT_FIT=new n,uN.SHOW_ALL=new i,uN.NO_BORDER=new r,uN.FIXED_HEIGHT=new a,uN.FIXED_WIDTH=new o}();var hN=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof lN&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof uN&&(this._contentStrategy=e)},Q(e,[{key:"canvasSize",get:function(){return rh.windowSize}}]),e}());hN.EXACT_FIT=0,hN.NO_BORDER=1,hN.SHOW_ALL=2,hN.FIXED_HEIGHT=3,hN.FIXED_WIDTH=4,hN.UNKNOWN=5,hN.ContainerStrategy=lN,hN.ContentStrategy=uN,l.ResolutionPolicy=hN;var fN=e("view",cN.instance=l.view=new cN);l.winSize=oN,k(cN.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),G(cN.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),G(l,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),G(ah,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),U(ah,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:ah.Language,targetName:"sys.Language"}}))),U(ah,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:ah.OS,targetName:"sys.OS"}}))),U(ah,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:ah.BrowserType,targetName:"sys.BrowserType"}}))),U(ah,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:ah.BrowserType,targetName:"sys.BrowserType"}]),U(ah,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:ah.Platform,targetName:"sys.Platform"}}))),U(ah,"sys",[{name:"IPHONE",newName:"IOS",target:ah.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:ah.Platform,targetName:"sys.Platform"}]),k(ah,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),U(ah,"sys",[{name:"windowPixelResolution",target:rh,targetName:"screen",newName:"windowSize"}]),G(rh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var _N=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new ml,this.scenes=new ml,this.paths=new ml}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,a=e.paths=Object.create(null);if(!1===e.debug){for(var o=0,s=t.length;o<s;o++)t[o]=Nl(t[o]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),f=0,_=t.length;f<_;f++){var d=t[f];t[f]=h[d]=Nl(d)}t=h}for(var p in n){var m=n[p];a[t[p]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var S=e.packs;for(var x in S)for(var E=S[x],T=0;T<E.length;++T)E[T]=t[E[T]];var C=e.versions;if(C)for(var A in C)for(var b=C[A],I=0;I<b.length;I+=2){var w=b[I];b[I]=t[w]||w}var P=e.redirect;if(P)for(var R=0;R<P.length;R+=2)P[R]=t[P[R]],P[R+1]=r[P[R+1]];if(e.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var O in e.extensionMap)D(O)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=zl(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var a=n[i];if(nt.isChildClassOf(a.ctor,t))return a}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=zl(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var a=0,o=n.length;a<o;a++){var s=n[a];t&&!nt.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],a=i[1],o=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=nt._getClassById(a),t.has(r)?o?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],a=n.get(r);a.url=i,t.add(i,a)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var a=0,o=i.length;a<o;a++){var s=i[a],c=t.get(s),l=c.packs;l?1===o?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var a=n[i];t.get(a).ver=n[i+1]}if(n=e.native)for(var o=0,s=n.length;o<s;o+=2){var c=n[o];t.get(c).nativeVer=n[o+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function dN(e,t){e._uuid&&t.push(e._uuid)}function pN(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var a=e[r];if("object"==typeof a&&a)if(Array.isArray(a))for(var o=0;o<a.length;o++){var s=a[o];s instanceof wu&&dN(s,t)}else if(a.constructor&&a.constructor!==Object)a instanceof wu&&dN(a,t);else for(var c=Object.getOwnPropertyNames(a),l=0;l<c.length;l++){var u=a[c[l]];u instanceof wu&&dN(u,t)}}}}function mN(e,t){for(var n=0;n<e._components.length;n++)pN(e._components[n],t);for(var i=0;i<e._children.length;i++)mN(e._children[i],t)}function vN(e,t,n,i){n.push(e._uuid);for(var r=Ym.getDeps(e._uuid),a=0,o=r.length;a<o;a++){var s=yl.get(r[a]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||vN(s,t,n,i)}}}var gN=[],yN=new(function(){function e(){this._persistNodeDeps=new ml,this._toDelete=new ml,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];mN(e,t);for(var n=0,i=t.length;n<i;n++){var r=yl.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=yl.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=Ym.getDeps(e.uuid),r=0,a=i.length;r<a;r++){var o=yl.get(i[r]);o&&o.decRef(e.autoReleaseAssets)}var s=Ym._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=yl.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Ym.remove(e.uuid)}var f=Ym._depends.get(t.uuid);for(var _ in f&&(f.persistDeps=[]),n){for(var d,p,m=n[_],v=this._persistNodeDeps.get(m.uuid),g=oe(v);!(p=g()).done;){var y=p.value,S=yl.get(y);S&&S.addRef()}f&&(d=f.persistDeps).push.apply(d,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof wu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,yt(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),pl(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,vN(e,t,gN,-1),gN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&vN(yl.get(n),t,gN,1);return gN.length=0,t[e._uuid]}(e)>0)){yl.remove(n);for(var i=Ym.getDeps(n),r=0,a=i.length;r<a;r++){var o=yl.get(i[r]);o&&(o.decRef(!1),this._free(o,!1))}e.destroy(),Ym.remove(n)}},e}()),SN=null;function xN(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof wu&&r.content.decRef(!1),r.recycle()}e.input=null}function EN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function TN(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(a,o){r++,!a||r>t?i&&i(a,o):setTimeout((function(){TN(e,t,n,i,r)}),n)}))}function CN(e,t,n,i,r){try{for(var a=Ym.parse(e,t),o=0,s=a.deps.length;o<s;o++){var c=a.deps[o];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}a.nativeDep&&(r&&(a.nativeDep.bundle=r.name),i.push(J({},a.nativeDep)))}catch(e){x(e.message,e.stack)}}function AN(e,t,n){t&&(n=void 0!==n?n:l.assetManager.cacheAsset,Bl(t)||!n||t.isDefault||yl.add(e,t))}function bN(e,t,n){var i=0,r=[],a=e.length;0===a&&n&&n(r);for(var o=function(e){e&&r.push(e),++i===a&&n&&n(r)},s=0;s<a;s++)t(e[s],o)}function IN(e,t,n){var i=e,r=t,a=n;if(void 0===n){var o="function"==typeof e;t?(a=t,o||(r=null)):void 0===t&&o&&(a=e,i=null,r=null),void 0!==t&&o&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:a}}function wN(e,t,n){var i=e,r=t,a=n;if(void 0===n){var o=nt.isChildClassOf(e,wu);t?(a=t,o&&(r=null)):void 0!==t||o||(a=e,r=null,i=null),void 0===t||o||(r=e,i=null)}return{type:i,onProgress:r||SN,onComplete:a}}function PN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,a=Ym.getDeps(t);if(a)for(var o=0,s=a.length;o<s;o++){var c=a[o];if(c===e||PN(e,c,n,i)){r=!0;break}}return r}function RN(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof wu&&i.push(e.addRef())})):n instanceof wu&&i.push(n.addRef()),yt((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var DN=function(){function e(){this._config=new _N}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),El.add(e.name,this)},t.load=function(e,t,n,i){var r=wN(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete,c={__requestType__:gl.PATH,type:a,bundle:this.name,__outputAsArray__:Array.isArray(e)};l.assetManager.loadAny(e,c,o,s)},t.preload=function(e,t,n,i){var r=wN(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;l.assetManager.preloadAny(e,{__requestType__:gl.PATH,type:a,bundle:this.name},o,s)},t.loadDir=function(e,t,n,i){var r=wN(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;l.assetManager.loadAny(e,{__requestType__:gl.DIR,type:a,bundle:this.name,__outputAsArray__:!0},o,s)},t.preloadDir=function(e,t,n,i){var r=wN(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;l.assetManager.preloadAny(e,{__requestType__:gl.DIR,type:a,bundle:this.name},o,s)},t.loadScene=function(e,t,n,i){var r=IN(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.preset=a.preset||"scene",a.bundle=this.name,l.assetManager.loadAny({scene:e},a,o,(function(e,t){if(e)x(e.message,e.stack);else if(t instanceof pD&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");s&&s(e,t)}))},t.preloadScene=function(e,t,n,i){var r=IN(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.bundle=this.name,l.assetManager.preloadAny({scene:e},a,o,(function(t){t&&O(1210,e,t.message),s&&s(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&yl.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&yN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;yl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&yN.tryRelease(t)}))},t.releaseAll=function(){var e=this;yl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&yN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},Q(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),ON=e("resources",new DN);function NN(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",a),n&&n(null,i)}function a(){i.removeEventListener("load",r),i.removeEventListener("error",a),n&&n(new Error(F(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",a),i.src=e,i}function MN(e,t,n,i){var r=new XMLHttpRequest,a="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var o in t.xhrHeader)r.setRequestHeader(o,t.xhrHeader[o]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+a+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+a+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+a+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+a+r.status+"(abort)"))},r.send(null),r}l.resources=ON;var LN={};function FN(e,t,n){if(LN[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",a,!1),LN[e]=!0,n&&n(null)}function a(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",a,!1),n&&n(new Error(F(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",a,!1),document.body.appendChild(i),i}var BN=/^(?:\w+:\/\/|\.+\/).+/,zN=function(e,t,n){(ah.hasFeature(ah.Feature.IMAGE_BITMAP)&&l.assetManager.allowImageBitmap?UN:NN)(e,t,n)},UN=function(e,t,n){t.xhrResponseType="blob",MN(e,t,t.onFileProgress,n)},kN=function(e,t,n){t.xhrResponseType="json",MN(e,t,t.onFileProgress,n)},GN=function(e,t,n){t.xhrResponseType="arraybuffer",MN(e,t,t.onFileProgress,n)},HN=function(e,t,n){kN(e,t,(function(t,i){if(t)n(t);else{var r=lh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){GN(""+vu(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new ch(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},VN=function(e,t,n){GN(e,t,(function(e,t){if(e)n(e);else try{var i=uh(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},WN=function(e,t,n){t.xhrResponseType="text",MN(e,t,t.onFileProgress,n)},jN=function(e,t,n){var i=gu(e),r=e;BN.test(r)||(r=-1!==XN.remoteBundles.indexOf(i)?XN.remoteServerAddress+"remote/"+i:"assets/"+i);var a=t.version||XN.bundleVers[i],o=0,s=null,c=null;kN(r+"/config."+(a?a+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++o&&n(c,s)})),FN(r+"/index."+(a?a+".":"")+"js",t,(function(e){c=e,2==++o&&n(e,s)}))},XN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=NN,this.downloadDomAudio=null,this.downloadFile=MN,this.downloadScript=FN,this._downloaders={".png":zN,".jpg":zN,".bmp":zN,".jpeg":zN,".gif":zN,".ico":zN,".tiff":zN,".webp":zN,".image":zN,".pvr":GN,".pkm":GN,".astc":GN,".txt":WN,".xml":WN,".vsh":WN,".fsh":WN,".atlas":WN,".tmx":WN,".tsx":WN,".json":kN,".ExportJson":kN,".plist":WN,".ccon":HN,".cconb":VN,".fnt":WN,".binary":GN,".bin":GN,".dbbin":GN,".skel":GN,".js":FN,bundle:jN,default:WN},this._downloading=new ml,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?ze(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var a=this,o=Sl.get(e);if(o)r(null,o);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,f=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,_=this._downloaders[n]||this._downloaders.default;TN((function(n,o){if(0===n&&a._downloading.add(e,[r]),a.limited){a._updateTime();var s=function(e,t){a._totalNum--,a._handleQueueInNextFrame(h,f),o(e,t)};a._totalNum<h&&a._totalNumThisPeriod<f?(_(EN(t,a.appendTimeStamp),i,s),a._totalNum++,a._totalNumThisPeriod++):(a._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:_}),a._queueDirty=!0,a._totalNum<h&&a._handleQueueInNextFrame(h,f))}else _(EN(t,a.appendTimeStamp),i,o)}),u,this.retryInterval,(function(t,n){t||Sl.add(e,n);for(var i=a._downloading.remove(e),r=0,o=i.length;r<o;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){l.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=l.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(EN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(yt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},Q(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function qN(e,t,n,i){var r=null,a=null;try{(r=new Hm)._nativeUrl=e,r._nativeAsset=t}catch(e){a=e}i(a,r)}function YN(e,t,n,i){var r=new xD;r.json=t,i(null,r)}function KN(e,t,n,i){var r=new SD;r.text=t,i(null,r)}function QN(e,t,n,i){var r=new Xb;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function JN(e,t,n,i){var r=new wu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function ZN(e,n,i,r){var a=El.get(n.name);a||(a=n.name===bl.RESOURCES?ON:new DN,n.base=n.base||e+"/",a.init(n)),t.import("virtual:///prerequisite-imports/"+a.name).then((function(){r(null,a)})).catch(r)}var $N=new(function(){function e(){this._creating=new ml,this._producers={".png":qN,".jpg":qN,".bmp":qN,".jpeg":qN,".gif":qN,".ico":qN,".tiff":qN,".webp":qN,".image":qN,".pvr":qN,".pkm":qN,".txt":KN,".xml":KN,".vsh":KN,".fsh":KN,".atlas":KN,".tmx":KN,".tsx":KN,".fnt":KN,".json":YN,".ExportJson":YN,".binary":QN,".bin":QN,".dbbin":QN,".skel":QN,bundle:ZN,default:JN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?nt.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var a=this,o=this._producers[n]||this._producers.default,s=yl.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),o(e,t,i,(function(t,n){!t&&n instanceof wu&&(n._uuid=e,AN(e,n,i.cacheAsset));for(var r=a._creating.remove(e),o=0,s=r.length;o<s;o++)r[o](t,n)})))}else r(null,s)},e}()),eM=new(function(){function e(){this._loading=new ml,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=nt.createMap(!0),a=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(F(5304,e[0]));Rh(e,!0,void 0,Oh.reportMissingClass),Dh(e);for(var t=new Nh(e[0]),n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=0;s<o.length;++s)o[s].unshift(t,n,i,r,a);return o}(t)).length!==e.length&&O(4915);for(var o=0;o<e.length;o++)r[e[o]+"@import"]=t[o]}else{var s=nt._getClassId(hv),c=nt._getClassId(Hm);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&O(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=Mh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&O(4915);for(var f=0;f<e.length;f++)r[e[f]+"@import"]=h[f]}else a=new Error("unmatched type pack!"),r=null}i(a,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?nt.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(Sl.has(e.id))n(null,Sl.get(e.id));else{var r=e.info.packs,a=r.find((function(e){return i._loading.has(e.uuid)}));if(a)this._loading.get(a.uuid).push({onComplete:n,id:e.id});else{a=r[0],this._loading.add(a.uuid,[{onComplete:n,id:e.id}]);var o=Ul(a.uuid,{ext:a.ext,bundle:e.config.name});XN.download(a.uuid,o,a.ext,e.options,(function(t,n){Sl.remove(a.uuid),t&&x(t.message,t.stack),i.unpack(a.packedUuids,n,a.ext,e.options,(function(e,n){if(!e)for(var r in n)Sl.add(r,n[r]);for(var o=i._loading.remove(a.uuid),s=0,c=o.length;s<c;s++){var l=o[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else XN.download(e.id,e.url,e.ext,e.options,n)},e}());function tM(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress,a=[],o=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],bN(e.input,(function(i,c){if(!i.isNative&&yl.has(i.uuid)){var u=yl.get(i.uuid);return i.content=u.addRef(),e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i),void c()}eM.load(i,e.options,(function(u,h){u?e.isFinish||(!l.assetManager.force||n?(x(u.message,u.stack),r.canInvoke=!1,t(u)):(e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i))):e.isFinish||(i.file=h,e.output.push(i),i.isNative||(s[i.uuid]=!0,CN(i.uuid,h,s,a,i.config),r.total=o+a.length),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i)),c()}))}),(function(){if(e.isFinish)return xN(e,!0),void e.dispatch("error");if(a.length>0){var o=wl.create({input:a,progress:r,options:i,onProgress:e.onProgress,onError:wl.prototype.recycle,onComplete:function(i){var r;i||((r=e.output).push.apply(r,o.output),o.recycle()),n&&nM(e),t(i)}});Cl.async(o)}else n&&nM(e),t()}))}function nM(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var iM=new(function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return R(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var a=e.childNodes[i];1===a.nodeType&&("key"===a.tagName?n=a.firstChild.nodeValue:t[n]=this._parseNode(a))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function rM(e,t){return e[t]<<8|e[t+1]}var aM=new(function(){function e(){this._parsing=new ml,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Int32Array(a,0,13);if(55727696===o[0]){var s=o[7],c=o[6],l=o[12]+52;r={_data:new Uint8Array(a,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==o[11])throw new Error("Invalid magic number in PVR header");var u=o[0],h=o[1],f=o[2];r={_data:new Uint8Array(a,u),_compressed:!0,width:f,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Uint8Array(a),s=rM(o,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=rM(o,12),l=rM(o,14);rM(o,8),rM(o,10),r={_data:new Uint8Array(a,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var a=e instanceof ArrayBuffer?e:e.buffer,o=new Uint8Array(a);if(1554098963!==o[0]+(o[1]<<8)+(o[2]<<16)+(o[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=o[4],c=o[5],l=o[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?ym.RGBA_ASTC_4x4:5===e?4===t?ym.RGBA_ASTC_5x4:ym.RGBA_ASTC_5x5:6===e?5===t?ym.RGBA_ASTC_6x5:ym.RGBA_ASTC_6x6:8===e?5===t?ym.RGBA_ASTC_8x5:6===t?ym.RGBA_ASTC_8x6:ym.RGBA_ASTC_8x8:10===e?5===t?ym.RGBA_ASTC_10x5:6===t?ym.RGBA_ASTC_10x6:8===t?ym.RGBA_ASTC_10x8:ym.RGBA_ASTC_10x10:10===t?ym.RGBA_ASTC_12x10:ym.RGBA_ASTC_12x12}(s,c),h=o[7]+(o[8]<<8)+(o[9]<<16),f=o[10]+(o[11]<<8)+(o[12]<<16);o[13],o[14],o[15],r={_data:new Uint8Array(a,16),_compressed:!0,width:h,height:f,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=iM.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=Xm(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?ze(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var a=this,o=xl.get(e);if(o)r(null,o);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?Sl.remove(e):Bl(n)||xl.add(e,n);for(var i=a._parsing.remove(e),r=0,o=i.length;r<o;r++)i[r](t,n)}))):r(null,t)}}},e}());function oM(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],bN(e.input,(function(a,o){var s=wl.create({input:a,onProgress:e.onProgress,options:i,progress:r,onComplete:function(i,c){i&&!e.isFinish&&(!l.assetManager.force||n?(x(i.message,i.stack),r.canInvoke=!1,t(i)):r.canInvoke&&e.dispatch("progress",++r.finish,r.total,a)),e.output.push(c),s.recycle(),o(null)}});sM.async(s)}),(function(){if(i.__exclude__=null,e.isFinish)return xN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),xN(e,!0),t()}))}var sM=new vl("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,a=n.uuid,o=n.file,s=i.reloadAsset;o||!s&&!r&&yl.has(a)?t():eM.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,a=n.id,o=n.file,s=n.options;if(n.isNative)aM.parse(a,o,n.ext,s,(function(r,o){r?t(r):(n.content=o,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),Sl.remove(a),xl.remove(a),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,f=l.err,_=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||PN(c,c,r)?(h&&h.addRef(),n.content=h,t(f)):_.push({done:t,item:n})}else if(!s.reloadAsset&&yl.has(c)){var d=yl.get(c);n.content=d.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,aM.parse(a,o,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,a=i,o=a.uuid,s=a.id,c=a.options,l=a.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),CN(o,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var f=e.options.__exclude__[o]={content:t,finish:!1,callbacks:[{done:n,item:i}]},_=wl.create({input:h,options:e.options,onProgress:e.onProgress,onError:wl.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),f.finish=!0,f.err=e,!e){for(var n,i=Array.isArray(_.output)?_.output:[_.output],r=Object.create(null),a=oe(i);!(n=a()).done;){var c=n.value;c&&(r[c instanceof wu?c._uuid+"@import":o+"@native"]=c)}!function(e,t,n){var i=Vm.get(t);if(i){for(var r=0,a=i.length;r<a;r++){var o=i[r],s=n[o.uuid+"@import"];if(s)o.owner[o.prop]=s.addRef();else{if(x("The asset "+o.uuid+" is missing!"),o.type&&o.type!==wu){var c=new o.type;c.initDefault(o.uuid),o.owner[o.prop]=c}!0}}Vm.delete(t)}Wm.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Wm.delete(t))}(o,t,r);try{"function"!=typeof t.onLoaded||jm.has(t)||Wm.has(t)||(t.onLoaded(),jm.add(t))}catch(e){x("The asset "+o+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}Sl.remove(s),xl.remove(s),AN(o,t,u),_.recycle()}for(var l=f.callbacks,h=0,d=l.length;h<d;h++){var p=l[h];t.addRef&&t.addRef(),p.item.content=t,p.done(e)}l.length=0}});Tl.async(_)}(e,i,t)}))}}]);function cM(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var a in n)switch(a){case gl.PATH:case gl.UUID:case gl.DIR:case gl.SCENE:case gl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[a]=n[a];break;case"__exclude__":case"__outputAsArray__":r[a]=n[a];break;default:i[a]=n[a],r[a]=n[a]}e.options=r;var o=wl.create({input:e.input,options:i}),s=null;try{e.output=e.source=Al.sync(o)}catch(e){s=e;for(var c=0,l=o.output.length;c<l;c++)o.output[c].recycle()}o.recycle(),t(s)}var lM=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},Q(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();lM.MAX_DEAD_NUM=500,lM._deadPool=[];var uM=[];function hM(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,a=n[i],o=lM.create(),s=null,c=null;if("string"==typeof a&&((a=Object.create(null))[t.__requestType__||gl.UUID]=n[i]),"object"==typeof a)for(var l in Be(a,t),a.preset&&Be(a,Il[a.preset]),a){switch(l){case gl.UUID:if("break"===function(){var e,t=o.uuid=Nl(a.uuid);if(!a.bundle){var n=El.find((function(e){return!!e.getAssetInfo(t)}));a.bundle=n&&n.name}if(El.has(a.bundle)){if(s=El.get(a.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!El.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=El.get(c.redirect).config,c=s.getAssetInfo(t)}o.config=s,o.info=c}return o.ext=a.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case gl.DIR:if(El.has(a.bundle)){El.get(a.bundle).config.getDirWithPath(a.dir,a.type,uM);for(var u,h=oe(uM);!(u=h()).done;){var f=u.value;n.push({uuid:f.uuid,__isNative__:!1,ext:f.extension||".json",bundle:a.bundle})}uM.length=0}o.recycle(),o=null;break;case gl.PATH:if(El.has(a.bundle)){if(s=El.get(a.bundle).config,(c=s.getInfoWithPath(a.path,a.type))&&c.redirect){if(!El.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=El.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw o.recycle(),new Error("Bundle "+a.bundle+" doesn't contain "+a.path);o.config=s,o.uuid=c.uuid,o.info=c}o.ext=a.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case gl.SCENE:if(!a.bundle){var _=El.find((function(e){return!!e.getSceneInfo(a.scene)}));a.bundle=_&&_.name}if(El.has(a.bundle)){if(s=El.get(a.bundle).config,(c=s.getSceneInfo(a.scene))&&c.redirect){if(!El.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=El.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw o.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+a.scene);o.config=s,o.uuid=c.uuid,o.info=c}break;case"__isNative__":o.isNative=a.__isNative__;break;case gl.URL:o.url=a.url,o.uuid=a.uuid||a.url,o.ext=a.ext||mu(a.url),o.isNative=void 0===a.__isNative__||a.__isNative__;break;default:o.options[l]=a[l]}if(!o)break}if(!o)return"continue";if(e.output.push(o),!o.uuid&&!o.url)throw new Error("Can not parse this input:"+JSON.stringify(a))},r=0;r<n.length;r++)i(r);return null}function fM(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var r,a,o=i.config;a=i.isNative?o&&o.nativeBase?o.base+o.nativeBase:l.assetManager.generalNativeBase:o&&o.importBase?o.base+o.importBase:l.assetManager.generalImportBase;var s=i.uuid,c="";i.info&&(c=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?a+"/"+s.slice(0,2)+"/"+s+c+"/"+i.options.__nativeName__:a+"/"+s.slice(0,2)+"/"+s+c+i.ext,i.url=r}}return null}var _M=e("AssetManager",function(){function e(){this.pipeline=Tl.append(cM).append(oM),this.fetchPipeline=Cl.append(cM).append(tM),this.transformPipeline=Al.append(hM).append(fM),this.bundles=El,this.assets=yl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Ym,this.force=!1,this.allowImageBitmap=!ah.isMobile,this.utils=kl,this.downloader=XN,this.parser=aM,this.packManager=eM,this.cacheAsset=!0,this.cacheManager=null,this.presets=Il,this.factory=$N,this.preprocessPipe=cM,this.fetchPipe=tM,this.loadPipe=oM,this.references=null,this._releaseManager=yN,this._files=Sl,this._parsed=xl,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return El.get(e)||null},t.removeBundle=function(e){e._destroy(),El.remove(e.name)},t.loadAny=function(e,t,n,i){var r=IN(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.preset=a.preset||"default",e=Array.isArray(e)?e.slice():e;var c=wl.create({input:e,onProgress:o,onComplete:RN(s),options:a});Tl.async(c)},t.preloadAny=function(e,t,n,i){var r=IN(t,n,i),a=r.options,o=r.onProgress,s=r.onComplete;a.preset=a.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=wl.create({input:e,onProgress:o,onComplete:RN(s),options:a});Cl.async(c)},t.loadRemote=function(e,t,n){var i=IN(t,void 0,n),r=i.options,a=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(x(t.message,t.stack),a&&a(t,n)):$N.create(e,n,r.ext||mu(e),r,(function(e,t){a&&a(e,t)}))}))):RN(a)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=IN(t,void 0,n),r=i.options,a=i.onComplete,o=gu(e);this.bundles.has(o)?RN(a)(null,this.getBundle(o)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(x(t.message,t.stack),a&&a(t,n)):$N.create(e,n,"bundle",r,(function(e,t){a&&a(e,t)}))})))},t.releaseAsset=function(e){yN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){yl.forEach((function(e){yN.tryRelease(e)}))},t.releaseAll=function(){yl.forEach((function(e){yN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},Q(e,[{key:"main",get:function(){return El.get(bl.MAIN)||null}},{key:"resources",get:function(){return El.get(bl.RESOURCES)||null}}]),e}());_M.Pipeline=vl,_M.Task=wl,_M.Cache=ml,_M.RequestItem=lM,_M.Bundle=DN,_M.BuiltinBundleName=bl;var dM=e("assetManager",l.assetManager=new _M);l.AssetManager=_M;var pM=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],mM=[".mp3",".ogg",".wav",".m4a"];function vM(){return!0}var gM={transformURL:function(e){var t=Ll(e);if(!t)return e;var n=El.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var a=!1;if(".ttf"===mu(e)&&(a=!0),a){var o=yu(e),s=gu(e);e=o+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+i}));return e}},yM=e("CCLoader",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=wN}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var a=i[r];"string"==typeof a?i[r]={url:a,__isNative__:!0}:(a.type&&(a.ext="."+a.type,a.type=void 0),a.url&&(a.__isNative__=!0))}var o=[],s=[];dM.loadAny(i,null,(function(e,n,i){i.content&&(pM.includes(i.ext)?o.push(i.content):mM.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var a=function(e){var n=t[e];if(!(n instanceof wu)){var r=n,a=i[e].url;o.includes(r)?$N.create(a,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&$N.create(a,n,".mp3",{},(function(n,i){r=t[e]=i})),yl.add(a,r)}},c=0;c<t.length;c++)a(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:vM,_map:l}}else r=t[0]}n&&n(e,r)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return dM.assets.has(e)?{content:dM.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete,c=mu(e);c&&!ON.getInfoWithPath(e,a)&&(e=e.slice(0,-c.length)),ON.load(e,a,o,s)},t.loadResArray=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=mu(t);i&&!ON.getInfoWithPath(t,a)&&(e[n]=t.slice(0,-i.length))})),ON.load(e,a,o,s)},t.loadResDir=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),a=r.type,o=r.onProgress,s=r.onComplete;ON.loadDir(e,a,o,(function(t,n){var i=[];t||(i=ON.getDirWithPath(e,a).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return yl.has(e)?yl.get(e):ON.get(e,t)},t.getResCount=function(){return yl.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return Ym.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);XN.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);aM.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=yl.get(n)),dM.releaseAsset(n)}else e&&("string"==typeof e&&(e=yl.get(e)),dM.releaseAsset(e))},t.releaseAsset=function(e){dM.releaseAsset(e)},t.releaseRes=function(e,t){ON.release(e,t)},t.releaseAll=function(){dM.releaseAll(),yl.clear()},t.removeItem=function(e){return!!yl.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=Ym.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},Q(e,[{key:"onProgress",set:function(e){SN=e}},{key:"_cache",get:function(){if(yl instanceof ml)return yl._map;var e={};return yl.forEach((function(t,n){e[n]=t})),e}},{key:"md5Pipe",get:function(){return gM}},{key:"downloader",get:function(){return XN}},{key:"loader",get:function(){return dM.parser}}]),e}()),SM=e("loader",new yM),xM=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,dM.init(e),e.rawAssets&&ON.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:bl.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){dM.loadAny(e,t)}}),EM=e("url",{});U(EM,"url",[{name:"normalize",target:dM.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?Ul({path:Su(e.substr(10)),bundle:bl.RESOURCES,__isNative__:!0,ext:mu(e)}):""}}]),k(xM,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),k(SM,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline"}]),U(l,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return SM}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return xM}},{name:"Pipeline",target:_M,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return EM}}]),k(l,"cc",[{name:"LoadingItems",suggest:F(1400,"LoadingItems","AssetManager.Task")}]),U(lt,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:XN,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),U(nN,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return dM.main?null===(t=dM.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),U(eN,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return dM.main&&dM.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var TM,CM,AM,bM,IM,wM,PM,RM,DM,OM,NM,MM,LM,FM,BM=yN._autoRelease;yN._autoRelease=function(e,t,n){BM.call(yN,e,t,n);for(var i=SM._autoReleaseSetting,r=Object.keys(i),a=0;a<r.length;a++){var o=r[a];if(!0===i[o]){var s=yl.get(o);s&&yN.tryRelease(s)}}};var zM,UM,kM,GM,HM,VM,WM,jM,XM,qM,YM,KM,QM,JM,ZM,$M,eL,tL,nL,iL,rL,aL,oL,sL,cL,lL,uL,hL,fL,_L,dL,pL,mL,vL,gL,yL,SL,xL,EL,TL,CL,AL,bL,IL,wL,PL,RL,DL,OL,NL,ML,LL,FL,BL,zL,UL,kL,GL,HL,VL,WL,jL,XL,qL,YL,KL,QL,JL,ZL,$L,eF=e("EventHandler",(TM=Tc("cc.ClickEvent"),CM=al(l.Node),AM=Xc(),bM=Xc(),IM=Xc(),wM=Xc(),TM((FM=function(){function e(){se(this,"target",DM,this),se(this,"component",OM,this),se(this,"_componentId",NM,this),se(this,"handler",MM,this),se(this,"customEventData",LM,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var a=0,o=t.length;a<o;a++){var s=t[a];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(l.isValid(t)){this._genCompIdIfNeeded();var n=l.js._getClassById(this._componentId),i=t.getComponent(n);if(l.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(i,e))}}},t._compName2Id=function(e){var t=l.js.getClassByName(e);return l.js._getClassId(t)},t._compId2Name=function(e){var t=l.js._getClassById(e);return l.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},Q(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),DM=ce((RM=FM).prototype,"target",[Dc,CM,Dc,AM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OM=ce(RM.prototype,"component",[Dc,Hc,bM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),NM=ce(RM.prototype,"_componentId",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),MM=ce(RM.prototype,"handler",[Dc,Hc,IM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),LM=ce(RM.prototype,"customEventData",[Dc,Hc,wM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),PM=RM))||PM));l.Component.EventHandler=eF;var tF,nF,iF,rF,aF,oF,sF,cF,lF,uF,hF=new Pn,fF=rt(jv),_F=rt(Wv),dF=rt(Xv),pF=rt(Yv),mF=rt(qv),vF=rt({SKYBOX:ig|Ki.DEPTH_STENCIL,SOLID_COLOR:Ki.ALL,DEPTH_ONLY:Ki.DEPTH_STENCIL,DONT_CLEAR:Ki.NONE}),gF=(zM=Tc("cc.Camera"),UM=Gc(),kM=Bc(),GM=Zc(),HM=Xc(),VM=al(Ed.BitMask),WM=Zc(),jM=Xc(),XM=al(vF),qM=Zc(),YM=Xc(),KM=Zc(),QM=Xc(),JM=Zc(),ZM=Xc(),$M=Zc(),eL=Xc(),tL=al(fF),nL=Zc(),iL=Xc(),rL=al(_F),aL=Zc(),oL=Vc(),sL=Xc(),cL=Zc(),lL=Vc(),uL=Xc(),hL=Zc(),fL=Vc(),_L=Xc(),dL=Zc(),pL=Xc(),mL=Zc(),vL=Xc(),gL=al(dF),yL=Zc(),SL=Xc(),xL=al(pF),EL=Zc(),TL=Xc(),CL=al(mF),AL=Zc(),bL=Xc(),IL=Zc(),wL=Xc(),PL=al(OE),RL=Zc(),DL=Xc(),tF=zM(OL=UM(OL=kM(OL=Fc(($L=ZL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_projection",ML,re(t)),se(t,"_priority",LL,re(t)),se(t,"_fov",FL,re(t)),se(t,"_fovAxis",BL,re(t)),se(t,"_orthoHeight",zL,re(t)),se(t,"_near",UL,re(t)),se(t,"_far",kL,re(t)),se(t,"_color",GL,re(t)),se(t,"_depth",HL,re(t)),se(t,"_stencil",VL,re(t)),se(t,"_clearFlags",WL,re(t)),se(t,"_rect",jL,re(t)),se(t,"_aperture",XL,re(t)),se(t,"_shutter",qL,re(t)),se(t,"_iso",YL,re(t)),se(t,"_screenScale",KL,re(t)),se(t,"_visibility",QL,re(t)),se(t,"_targetTexture",JL,re(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=my.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=no.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new Pn),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new Pn),!this._camera)return n;this.worldToScreen(e,hF);var i=t.getComponent("cc.UITransform"),r=fN.getVisibleSize(),a=hF.x-.5*this._camera.width,o=hF.y-.5*this._camera.height;return hF.x=a/l.view.getScaleX()+.5*r.width,hF.y=o/l.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(hF,n),n},n._createCamera=function(){this._camera||(this._camera=l.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?l.director.root&&l.director.root.mainWindow:l.director.root&&l.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=hn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},Q(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Wv.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=hn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?l.director.root&&l.director.root.mainWindow:l.director.root&&l.director.root.tempWindow)}}]),t}(Ku),ZL.ProjectionType=fF,ZL.FOVAxis=_F,ZL.ClearFlag=vF,ZL.Aperture=dF,ZL.Shutter=pF,ZL.ISO=mF,ZL.TARGET_TEXTURE_CHANGE="tex-change",ML=ce((NL=$L).prototype,"_projection",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fF.PERSPECTIVE}}),LL=ce(NL.prototype,"_priority",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FL=ce(NL.prototype,"_fov",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),BL=ce(NL.prototype,"_fovAxis",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _F.VERTICAL}}),zL=ce(NL.prototype,"_orthoHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),UL=ce(NL.prototype,"_near",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kL=ce(NL.prototype,"_far",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),GL=ce(NL.prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In("#333333")}}),HL=ce(NL.prototype,"_depth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),VL=ce(NL.prototype,"_stencil",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WL=ce(NL.prototype,"_clearFlags",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vF.SOLID_COLOR}}),jL=ce(NL.prototype,"_rect",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ii(0,0,1,1)}}),XL=ce(NL.prototype,"_aperture",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dF.F16_0}}),qL=ce(NL.prototype,"_shutter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pF.D125}}),YL=ce(NL.prototype,"_iso",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mF.ISO100}}),KL=ce(NL.prototype,"_screenScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),QL=ce(NL.prototype,"_visibility",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zp}}),JL=ce(NL.prototype,"_targetTexture",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ce(NL.prototype,"priority",[GM,HM],Object.getOwnPropertyDescriptor(NL.prototype,"priority"),NL.prototype),ce(NL.prototype,"visibility",[VM,WM,jM],Object.getOwnPropertyDescriptor(NL.prototype,"visibility"),NL.prototype),ce(NL.prototype,"clearFlags",[XM,qM,YM],Object.getOwnPropertyDescriptor(NL.prototype,"clearFlags"),NL.prototype),ce(NL.prototype,"clearColor",[KM,QM],Object.getOwnPropertyDescriptor(NL.prototype,"clearColor"),NL.prototype),ce(NL.prototype,"clearDepth",[JM,ZM],Object.getOwnPropertyDescriptor(NL.prototype,"clearDepth"),NL.prototype),ce(NL.prototype,"clearStencil",[$M,eL],Object.getOwnPropertyDescriptor(NL.prototype,"clearStencil"),NL.prototype),ce(NL.prototype,"projection",[tL,nL,iL],Object.getOwnPropertyDescriptor(NL.prototype,"projection"),NL.prototype),ce(NL.prototype,"fovAxis",[rL,aL,oL,sL],Object.getOwnPropertyDescriptor(NL.prototype,"fovAxis"),NL.prototype),ce(NL.prototype,"fov",[cL,lL,uL],Object.getOwnPropertyDescriptor(NL.prototype,"fov"),NL.prototype),ce(NL.prototype,"orthoHeight",[hL,fL,_L],Object.getOwnPropertyDescriptor(NL.prototype,"orthoHeight"),NL.prototype),ce(NL.prototype,"near",[dL,pL],Object.getOwnPropertyDescriptor(NL.prototype,"near"),NL.prototype),ce(NL.prototype,"far",[mL,vL],Object.getOwnPropertyDescriptor(NL.prototype,"far"),NL.prototype),ce(NL.prototype,"aperture",[gL,yL,SL],Object.getOwnPropertyDescriptor(NL.prototype,"aperture"),NL.prototype),ce(NL.prototype,"shutter",[xL,EL,TL],Object.getOwnPropertyDescriptor(NL.prototype,"shutter"),NL.prototype),ce(NL.prototype,"iso",[CL,AL,bL],Object.getOwnPropertyDescriptor(NL.prototype,"iso"),NL.prototype),ce(NL.prototype,"rect",[IL,wL],Object.getOwnPropertyDescriptor(NL.prototype,"rect"),NL.prototype),ce(NL.prototype,"targetTexture",[PL,RL,DL],Object.getOwnPropertyDescriptor(NL.prototype,"targetTexture"),NL.prototype),OL=NL))||OL)||OL)||OL)||OL,e({Camera:tF,CameraComponent:tF}),tF);l.Camera=gF;var yF={parent:null,owner:null,subModelIdx:0},SF=e("RenderableComponent",(nF=Tc("cc.RenderableComponent"),iF=al(Qv),rF=Zc(),aF=jc(),oF=al([Qv]),nF((ce((cF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_visFlags",lF,re(t)),se(t,"_materials",uF,re(t)),t._materialInstances=[],t._models=[],t}Z(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof oy&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){yF.parent=this._materials[e],yF.owner=this,yF.subModelIdx=e;var t=new oy(yF);yF.parent=null,yF.owner=null,yF.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){R(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},Q(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){for(var t=e.length,n=this._materials.length,i=t;i<n;i++)this.setMaterialInstance(null,i);this._materials.length=t,this._materialInstances.length=t;for(var r=0;r<t;r++)this._materialInstances[r]!=e[r]&&this.setMaterialInstance(e[r],r)}}]),t}(Ku)).prototype,"sharedMaterials",[iF,rF,aF],Object.getOwnPropertyDescriptor(cF.prototype,"sharedMaterials"),cF.prototype),lF=ce(cF.prototype,"_visFlags",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ed.Enum.NONE}}),uF=ce(cF.prototype,"_materials",[oF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sF=cF))||sF));l.RenderableComponent=SF,U(gF,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),U(gF.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),l.CameraComponent=gF,nt.setClassAlias(gF,"cc.CameraComponent"),l.math=si,l.geometry=Sd;var xF=new Pn,EF=new Wn;function TF(e,t,n,i){var r=n.chunk,a=n.data,o=r.vb,s=n.vertexCount;e.getWorldMatrix(EF);for(var c=0,l=0;l<s;l++){var u=a[l];Pn.set(xF,u.x,u.y,0),Pn.transformMat4(xF,xF,EF),o[c++]=xF.x,o[c++]=xF.y,o[c++]=xF.z,In.toArray(o,i,c+2),c+=6}for(var h=r.bufferId,f=r.vertexOffset,_=r.vertexAccessor.getMeshBuffer(r.bufferId),d=r.vertexAccessor.getIndexBuffer(h),p=_.indexOffset,m=0,v=s/4;m<v;m++){var g=f+4*m;d[p++]=g,d[p++]=g+1,d[p++]=g+2,d[p++]=g+1,d[p++]=g+3,d[p++]=g+2}_.indexOffset+=n.indexCount,_.setDirty()}var CF={},AF=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new bF;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,i=this._innerTextureInfos[n.getId()],r=t.x,a=t.y;if(i)r+=i.x,a+=i.y;else{var o=n.width,s=n.height;if(this._x+o+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;l.internal.dynamicAtlasManager.textureBleeding&&((o<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,a+=this._y,this._x+=o+2}var c={x:r,y:a,texture:this._texture};return this._innerSpriteFrames.push(e),c},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),bF=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=ym.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var a=new lr;a.texOffset.x=t,a.texOffset.y=n,a.texExtent.width=e.width,a.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[a])}else console.warn("Unable to get device")}},t}(hv),IF=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new AF(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==xm.LINEAR||t.magFilter!==xm.LINEAR||t.mipFilter!==xm.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],nt.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},Q(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),l.director.on(l.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),l.director.off(l.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();IF.instance=void 0;var wF,PF,RF,DF=e("dynamicAtlasManager",IF.instance=new IF);l.internal.dynamicAtlasManager=DF;var OF,NF,MF,LF,FF=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],BF=e("SpriteFrame",Tc("cc.SpriteFrame")((RF=PF=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.unbiasUV=[],t.uvSliced=[],t._rect=new ii,t._offset=new Yn,t._originalSize=new ti,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}Z(t,e),t.createWithImage=function(e){var n=e instanceof Hm?e:new Hm(e),i=new hv;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(O(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(O(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&DF&&DF.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,n=this.texture,i=n.width,r=n.height,a=this._capInsets[0],o=this._capInsets[2],s=e.width-a-o,c=this._capInsets[1],l=this._capInsets[3],u=e.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){FF[0].u=e.x/i,FF[1].u=(e.x+l)/i,FF[2].u=(e.x+l+u)/i,FF[3].u=(e.x+e.height)/i,FF[3].v=e.y/r,FF[2].v=(e.y+a)/r,FF[1].v=(e.y+a+s)/r,FF[0].v=(e.y+e.width)/r;for(var f=0;f<4;++f)for(var _=FF[f],d=0;d<4;++d){var p=FF[3-d];h.push({u:_.u,v:p.v})}}else{FF[0].u=e.x/i,FF[1].u=(e.x+a)/i,FF[2].u=(e.x+a+s)/i,FF[3].u=(e.x+e.width)/i,FF[3].v=e.y/r,FF[2].v=(e.y+c)/r,FF[1].v=(e.y+c+u)/r,FF[0].v=(e.y+e.height)/r;for(var m=0;m<4;++m)for(var v=FF[m],g=0;g<4;++g){var y=FF[g];h.push({u:y.u,v:v.v})}}this.emit(t.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,a=i.height;if(this._rotated){var o=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===a?0:e.y/a,l=0===a?1:(e.y+e.width)/a;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=o,t[5]=l,t[6]=o,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=o,t[5]=c,t[6]=o,t[7]=l):this._isFlipUVY?(t[0]=o,t[1]=l,t[2]=o,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=o,t[1]=c,t[2]=o,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,f=0===a?0:e.y/a,_=0===a?1:(e.y+e.width)/a;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVX?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVY?(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f):(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_)}else{var d=0===r?0:e.x/r,p=0===r?1:(e.x+e.width)/r,m=0===a?1:(e.y+e.height)/a,v=0===a?0:e.y/a;this._isFlipUVX&&this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):this._isFlipUVX?(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v):this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,S=0===a?1:(e.y+e.height)/a,x=0===a?0:e.y/a;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVX?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVY?(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S):(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x)}var E=this.vertices;if(E){E.nu.length=0,E.nv.length=0;for(var T=0;T<E.u.length;T++)E.nu[T]=E.u[T]/r,E.nv[T]=E.v[T]/a}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=DF;if(e){var t=this._texture;if(t instanceof hv&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new ii(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new Yn(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new ti(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var a=t.capInsets;a&&(this._capInsets[0]=a[0],this._capInsets[1]=a[1],this._capInsets[2]=a[2],this._capInsets[3]=a[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,a,o,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(a=l.uv).splice.apply(a,[0,l.uv.length].concat(this.uv)),(o=l.unbiasUV).splice.apply(o,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new ii(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new ti(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new hv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},Q(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?e!==this._texture&&this.reset({texture:e},!0):R(3122,this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(wu),PF.EVENT_UV_UPDATED="uv_updated",wF=RF))||wF);l.SpriteFrame=BF;var zF,UF=e("SpriteAtlas",Tc("cc.SpriteAtlas")((LF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",MF,re(t)),t}Z(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=Ie();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],$e(BF))},t}(wu),MF=ce((NF=LF).prototype,"spriteFrames",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ie()}}),OF=NF))||OF);l.SpriteAtlas=UF;var kF,GF,HF,VF,WF=e("Font",Tc("cc.Font")(zF=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(wu))||zF);l.Font=WF;var jF,XF,qF,YF,KF,QF,JF,ZF,$F,eB=e("TTFFont",Tc("cc.TTFFont")((VF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",HF,re(t)),t}return Z(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},Q(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:mu(this._native),__isNative__:!0}}}]),t}(WF),HF=ce((GF=VF).prototype,"_fontFamily",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ce(GF.prototype,"_nativeAsset",[sl,rl],Object.getOwnPropertyDescriptor(GF.prototype,"_nativeAsset"),GF.prototype),ce(GF.prototype,"_nativeDep",[sl],Object.getOwnPropertyDescriptor(GF.prototype,"_nativeDep"),GF.prototype),kF=GF))||kF);l.TTFFont=eB;var tB,nB=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},iB=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new nB;ze(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),rB=e("BitmapFont",(jF=Tc("cc.BitmapFont"),XF=al(BF),jF(($F=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",KF,re(t)),se(t,"spriteFrame",QF,re(t)),se(t,"fontSize",JF,re(t)),se(t,"fntConfig",ZF,re(t)),t}return Z(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new iB(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new nB,a=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=a.width,r.h=a.height,r.u=a.x,r.v=a.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else S("The fnt config is not exists!")},t}(WF),KF=ce((YF=$F).prototype,"fntDataStr",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),QF=ce(YF.prototype,"spriteFrame",[XF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JF=ce(YF.prototype,"fontSize",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ZF=ce(YF.prototype,"fntConfig",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qF=YF))||qF));l.BitmapFont=rB;var aB=e("LabelAtlas",Tc("cc.LabelAtlas")(tB=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(rB))||tB);l.LabelAtlas=aB;var oB=e("BASELINE_RATIO",.26),sB=e("MIDDLE_RATIO",(oB+1)/2-oB);var cB=new et(2);cB.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var lB,uB=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=cB.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,cB.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),hB=/([a-zA-Z0-9--]+|\S)/,fB=/^[!,.:;'}\]%\?>]/,_B=/([a-zA-Z0-9--iI]+|\S)$/,dB=/[a-zA-Z0-9--iI]+$/,pB=/^[a-zA-Z0-9--iI]/;function mB(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function vB(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function gB(e,t,n){var i=(n||e.font)+""+t,r=uB.get(i);if(null!==r)return r;var a=e.measureText(t),o=a&&a.width||0;return uB.put(i,o),o}function yB(e,t,n){var i=t,r=n,a=e[t];if(a>="\udc00"&&a<="\udfff"&&i--,void 0!==n)if(n-1!==t){var o=e[n-1];o>="\ud800"&&o<="\udbff"&&r--}else a>="\ud800"&&a<="\udbff"&&r++;return e.substring(i,r)}function SB(e){return pB.exec(e)}function xB(e){return dB.exec(e)}function EB(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var a=e;t>n&&a.length>1;){for(var o=a.length*(n/t)|0,s=yB(a,o),c=t-i(s),l=s,u=0,h=0;c>n&&h++<100;)o*=n/c,c=t-i(s=yB(a,o|=0));for(h=0;s&&c<=n&&h++<100;){var f=hB.exec(s);l=s,c=t-i(s=yB(a,o+=u=f?f[0].length:1))}0==(o-=u)?(o=1,l=yB(a,1)):1===o&&a[0]>="\ud800"&&a[0]<="\udbff"&&(o=2,l=yB(a,2));var _=yB(a,0,o),d=void 0;fB.test(l||s)&&(0==(o-=(d=_B.exec(_))?d[0].length:0)&&(o=1),l=yB(a,o),_=yB(a,0,o)),pB.test(l)&&(d=dB.exec(_))&&_!==d[0]&&(l=yB(a,o-=d[0].length),_=yB(a,0,o)),(0===r.length||(_=_.trim()).length>0)&&r.push(_),t=i(a=l||s)}return(0===r.length||(a=a.trim()).length>0)&&r.push(a),r}var TB=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return lB||(lB=new e),lB};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=lt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),CB=In.WHITE.clone(),AB=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},bB="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",IB=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=TB.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=gB(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+oB)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*oB/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Hm),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=bB,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,a=n/2,o=i/2+r*sB+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||CB;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,a,o)}e.fillText(this.char,a,o)}},e}(),wB=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=ym.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var a=new lr;a.texOffset.x=t,a.texOffset.y=n,a.texExtent.width=e.width,a.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[a])}else console.warn("Unable to get device")}},t}(hv),PB=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new wB;n.initWithSize(e,t),this.fontDefDictionary=new iB(n),this._halfBleed=1,this._width=e,this._height=t,nN.on(tN.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=nN.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return R(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new AB;return a.u=this._x+this._halfBleed,a.v=this._y+this._halfBleed,a.texture=this.fontDefDictionary.texture,a.valid=!0,a.w=e.width-2,a.h=e.height-2,a.xAdvance=a.w,a.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,a),a},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new wB;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new IB(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},Q(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),RB={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:In.WHITE.clone(),isOutlined:!1,out:In.WHITE.clone(),margin:0},DB=[new Or($i.ATTR_POSITION,_i.RGB32F)],OB=[new Or($i.ATTR_POSITION,_i.RGB32F),new Or($i.ATTR_COLOR,_i.RGBA32F)],NB=[new Or($i.ATTR_POSITION,_i.RGB32F),new Or($i.ATTR_TEX_COORD,_i.RG32F),new Or($i.ATTR_COLOR,_i.RGBA32F)],MB=[new Or($i.ATTR_POSITION,_i.RGB32F),new Or($i.ATTR_TEX_COORD,_i.RG32F),new Or($i.ATTR_COLOR,_i.RGBA32F),new Or($i.ATTR_COLOR2,_i.RGBA32F)];function LB(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=na[i.format].count}return t}function FB(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=na[i.format].size}return t}l.internal.vfmtPosUvColor=NB,l.internal.vfmtPosUvTwoColor=MB,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:DB,vfmtPosColor:OB,vfmtPosUvColor:NB,vfmtPosUvTwoColor:MB,getComponentPerVertex:LB,getAttributeStride:FB}));var BB,zB,UB,kB,GB,HB,VB,WB,jB,XB,qB,YB,KB,QB,JB,ZB=FB(NB)>>2,$B=new Vl((function(){return{x:0,y:0,z:0,u:0,v:0,color:In.WHITE.clone()}}),128),ez=null,tz=e("BaseRenderData",function(){function e(e){void 0===e&&(e=NB),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=NB,this._floatStride=e===NB?ZB:FB(e)>>2,this._vertexFormat=e}return e.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},Q(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),e}()),nz=e("RenderData",function(e){function t(t,n){var i;return void 0===t&&(t=NB),(i=e.call(this,t)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=nN.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}Z(t,e),t.add=function(e,n){void 0===e&&(e=NB),ez||(ez=new Wl((function(){return new t}),32));var i=ez.add();return i._floatStride=e===NB?ZB:FB(e)>>2,i._vertexFormat=e,n||(n=nN.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},t.remove=function(e){var t=ez.data.indexOf(e);-1!==t&&(e.clear(),e._accessor=null,ez.removeAt(t))};var n=t.prototype;return n.resize=function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())},n.resizeAndCopy=function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var n=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=Sa(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},Q(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)$B.free(t[i]);for(i=n;i<e;i++)t[i]=$B.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(tz)),iz=e("MeshRenderData",function(e){function t(t){var n;return void 0===t&&(t=NB),(n=e.call(this,t)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}Z(t,e),t.add=function(e){void 0===e&&(e=NB);var t=rz.add();return t._floatStride=e===NB?ZB:FB(e)>>2,t._vertexFormat=e,t},t.remove=function(e){var t=rz.data.indexOf(e);-1!==t&&(rz.data[t].clear(),rz.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(e,t){var n=this._byteLength+e*this.stride,i=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,a=this.iData.length,o=this.vData.length,s=this.iData.length;if(n>r||i>a){for(;r<n||a<i;)r=4*(o*=2),a=s*=2;this._reallocBuffer(o,s)}return!0},n.resize=function(e,t){var n=e*this.stride;e>=0&&t>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=n,this.updateRange(0,e,0,t)},n.updateRange=function(e,t,n,i){t>=0&&i>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=n,this.vertexRange=t,this.indexRange=i},n.requestIA=function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,e),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(e){var t=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,r,r))),this._iaInfo=new Mr(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Wl((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),i&&this.iData.set(i,0)},Q(t,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),t}(tz)),rz=new Wl((function(){return new iz}),32),az=new Yn,oz=new Yn,sz=new Pn,cz=new Wn,lz=new Wn,uz=new Wn,hz=new Wn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),fz=new ii,_z=function(t){return e({UITransform:t,UITransformComponent:t}),t}((BB=Tc("cc.UITransform"),zB=Gc(),UB=Ac(110),kB=Bc(),GB=Zc(),HB=Xc(),VB=Zc(),WB=Xc(),BB(jB=zB(jB=UB(jB=kB(jB=bc(jB=Fc((QB=KB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._priority=0,se(t,"_contentSize",qB,re(t)),se(t,"_anchorPoint",YB,re(t)),t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(tC.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(tC.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if(sn((e=e).width,n.width,an)&&sn(e.height,n.height,an))return;n.width=e.width,n.height=e.height}else{if(sn(e=e,n.width,an)&&sn(t,n.height,an))return;n.width=e,n.height=t}this.node.emit(tC.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(tC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t=this._contentSize.width,n=this._contentSize.height,i=az,r=oz,a=this._getRenderScene().cameras,o=0;o<a.length;o++){var s=a[o];if(s.visibility&this.node.layer){s.node.getWorldRT(cz);var c=cz.m12,l=cz.m13,u=aN.center;if(cz.m12=u.x-(cz.m00*c+cz.m04*l),cz.m13=u.y-(cz.m01*c+cz.m05*l),Wn.invert(cz,cz),Yn.transformMat4(i,e,cz),this.node.getWorldMatrix(uz),Wn.invert(cz,uz),!Wn.strictEquals(cz,hz)){Yn.transformMat4(r,i,cz),r.x+=this._anchorPoint.x*t,r.y+=this._anchorPoint.y*n;var h=!1;if(r.x>=0&&r.y>=0&&r.x<=t&&r.y<=n&&(h=this._maskTest(i)),h)return!0}}}return!1},n.hitTest=function(e){for(var t=this._contentSize.width,n=this._contentSize.height,i=sz,r=az,a=oz,o=this._getRenderScene().cameras,s=0;s<o.length;s++){var c=o[s];if(c.visibility&this.node.layer&&(Pn.set(i,e.x,e.y,0),c.screenToWorld(i,i),Yn.set(r,i.x,i.y),this.node.getWorldMatrix(uz),Wn.invert(cz,uz),!Wn.strictEquals(cz,hz))){Yn.transformMat4(a,r,cz),a.x+=this._anchorPoint.x*t,a.y+=this._anchorPoint.y*n;var l=!1;if(a.x>=0&&a.y>=0&&a.x<=t&&a.y<=n&&(l=this._maskTest(r)),l)return!0}}return!1},n._maskTest=function(e){var t,n,i=null===(t=this.node)||void 0===t||null===(n=t.eventProcessor)||void 0===n?void 0:n.maskList;if(i)for(var r=this.node,a=i.length,o=0,s=0;r&&s<a;++o,r=r.parent){var c=i[s];if(o===c.index){if(r!==c.comp.node){i.length=s;break}var l=c.comp;if(l&&l._enabled&&!l.isHit(e))return!1;s++}else if(o>c.index){i.length=s;break}}return!0},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(uz),Wn.invert(cz,uz),t||(t=new Pn),Pn.transformMat4(t,e,cz)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(uz),t||(t=new Pn),Pn.transformMat4(t,e,uz)},n.getBoundingBox=function(){Wn.fromRTS(lz,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new ii(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(lz),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(uz),this.getBoundingBoxTo(uz)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){Wn.fromRTS(lz,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new ii(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Wn.multiply(uz,e,lz),r.transformMat4(uz),!this.node.children)return r;for(var a,o=oe(this.node.children);!(a=o()).done;){var s=a.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&ii.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;fz.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),fz.transformMat4(this.node.worldMatrix);var i=fz.x+.5*fz.width,r=fz.y+.5*fz.height,a=this.node.worldPosition.z,o=fz.width/2,s=fz.height/2;return null!=e?(Ys.set(e,i,r,a,o,s,.001),e):new Ys(i,r,a,o,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},Q(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(tC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(tC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(tC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(tC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(tC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(tC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?R(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=nN.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=nN.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(Ku),KB.EventType=tC,KB.priorityChangeNodeMap=new Map,ce((XB=QB).prototype,"contentSize",[GB,HB],Object.getOwnPropertyDescriptor(XB.prototype,"contentSize"),XB.prototype),ce(XB.prototype,"anchorPoint",[VB,WB],Object.getOwnPropertyDescriptor(XB.prototype,"anchorPoint"),XB.prototype),qB=ce(XB.prototype,"_contentSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(100,100)}}),YB=ce(XB.prototype,"_anchorPoint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(.5,.5)}}),jB=XB))||jB)||jB)||jB)||jB)||jB)||jB));nN.on(tN.EVENT_AFTER_UPDATE,_z._sortSiblings),nN.on(tN.EVENT_BEFORE_SCENE_LAUNCH,_z._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(JB||(JB={}));var dz,pz,mz,vz,gz,yz,Sz,xz,Ez,Tz,Cz,Az,bz,Iz,wz,Pz,Rz,Dz,Oz,Nz,Mz=e("StencilManager",function(){function e(){this.stage=JB.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:wi.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Pi.KEEP,zFailOp:Pi.KEEP,passOp:Pi.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?JB.CLEAR_INVERTED:JB.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?JB.ENTER_LEVEL_INVERTED:JB.ENTER_LEVEL},t.enableMask=function(){this.stage=JB.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=JB.DISABLED:this.stage=JB.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=JB.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,a=wi.LESS,o=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,a=s.depthFunc,o=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(o&&o.has(n))return o.get(n);this.setStateFromStage(e);var u=new ba(i,r,a,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return o.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===JB.DISABLED?(t.stencilTest=!1,t.func=wi.ALWAYS,t.failOp=Pi.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===JB.ENABLED?(t.func=wi.EQUAL,t.failOp=Pi.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===JB.CLEAR?(t.func=wi.NEVER,t.failOp=Pi.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===JB.CLEAR_INVERTED||e===JB.ENTER_LEVEL?(t.func=wi.NEVER,t.failOp=Pi.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===JB.ENTER_LEVEL_INVERTED&&(t.func=wi.NEVER,t.failOp=Pi.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},Q(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());Mz.sharedManager=null,Mz.sharedManager=new Mz,st(Ri),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(Nz||(Nz=e("InstanceMaterialType",{})));var Lz,Fz,Bz,zz,Uz,kz,Gz,Hz,Vz,Wz,jz,Xz,qz,Yz,Kz,Qz,Jz,Zz,$z,eU,tU,nU,iU,rU,aU,oU,sU,cU,lU,uU,hU,fU,_U,dU,pU,mU,vU,gU,yU,SU,xU,EU,TU,CU,AU,bU,IU,wU,PU,RU,DU,OU,NU,MU,LU,FU,BU,zU,UU,kU,GU,HU,VU,WU,jU,XU,qU,YU,KU,QU,JU=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((dz=Tc("cc.Renderable2D"),pz=Cc(_z),mz=Vc(),vz=al(Qv),gz=al(Qv),yz=Zc(),Sz=Xc(),xz=jc(),Ez=Zc(),Tz=Xc(),dz(Cz=pz(Cz=bc(Cz=Fc((Oz=Dz=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_materials",bz,re(t)),se(t,"_customMaterial",Iz,re(t)),t.stencilStage=JB.DISABLED,se(t,"_srcBlendFactor",wz,re(t)),se(t,"_dstBlendFactor",Pz,re(t)),se(t,"_color",Rz,re(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new wa,t._blendHash=0,t._useVertexOpacity=!1,t._lastParent=null,t}Z(t,e);var n=t.prototype;return n.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(tC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(tC.SIZE_CHANGED,this._nodeStateChange,this),this.node.on(tC.PARENT_CHANGED,this._colorDirty,this),this.updateMaterial(),this._renderFlag=this._canRender(),this._colorDirty()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(tC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(tC.SIZE_CHANGED,this._nodeStateChange,this),this.node.off(tC.PARENT_CHANGED,this._colorDirty,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else this._renderDataFlag=e},n.requestRenderData=function(){var e=nz.add();return this._renderData=e,e},n.destroyRenderData=function(){this._renderData&&(nz.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this,e),this._renderDataFlag=!1),this._renderFlag&&this._render(e)},n.postUpdateAssembler=function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new Ia,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=Ri.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}},n._colorDirty=function(){this.node._uiProps.colorDirty=!0},n._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},n._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case Nz.ADD_COLOR:e=Sv.get("ui-base-material");break;case Nz.GRAYSCALE:e=Sv.get("ui-sprite-gray-material");break;case Nz.USE_ALPHA_SEPARATED:e=Sv.get("ui-sprite-alpha-sep-material");break;case Nz.USE_ALPHA_SEPARATED_AND_GRAY:e=Sv.get("ui-sprite-gray-alpha-sep-material");break;default:e=Sv.get("ui-sprite-material")}return e},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},Q(t,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}},{key:"useVertexOpacity",get:function(){return this._useVertexOpacity}}]),t}(SF),Dz.BlendState=Ri,Dz.Assembler=null,Dz.PostAssembler=null,bz=ce((Az=Oz).prototype,"_materials",[sl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ce(Az.prototype,"sharedMaterials",[sl,mz],Object.getOwnPropertyDescriptor(Az.prototype,"sharedMaterials"),Az.prototype),Iz=ce(Az.prototype,"_customMaterial",[vz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ce(Az.prototype,"customMaterial",[gz,yz,Sz,xz,el],Object.getOwnPropertyDescriptor(Az.prototype,"customMaterial"),Az.prototype),ce(Az.prototype,"color",[Ez,Tz],Object.getOwnPropertyDescriptor(Az.prototype,"color"),Az.prototype),wz=ce(Az.prototype,"_srcBlendFactor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.SRC_ALPHA}}),Pz=ce(Az.prototype,"_dstBlendFactor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.ONE_MINUS_SRC_ALPHA}}),Rz=ce(Az.prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.WHITE.clone()}}),Cz=Az))||Cz)||Cz)||Cz)||Cz));l.internal.Renderable2D=JU,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(qU||(qU=e("HorizontalTextAlignment",{}))),st(qU),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(YU||(YU=e("VerticalTextAlignment",{}))),st(YU),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(KU||(KU=e("Overflow",{}))),st(KU),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(QU||(QU=e("CacheMode",{}))),st(QU);var ZU,$U,ek,tk=function(t){return e({Label:t,LabelComponent:t}),t}((Lz=Tc("cc.Label"),Fz=Gc(),Bz=Ac(110),zz=Bc(),Uz=Zc(),kz=Xc(),Gz=al(qU),Hz=Zc(),Vz=Xc(),Wz=al(YU),jz=Zc(),Xz=Xc(),qz=Zc(),Yz=Xc(),Kz=Zc(),Qz=Vc(),Jz=Xc(),Zz=Zc(),$z=Xc(),eU=Vc(),tU=Zc(),nU=Xc(),iU=al(KU),rU=Zc(),aU=Xc(),oU=Zc(),sU=Xc(),cU=al(WF),lU=Zc(),uU=Vc(),hU=Xc(),fU=Zc(),_U=Xc(),dU=al(QU),pU=Zc(),mU=Xc(),vU=Zc(),gU=Xc(),yU=Zc(),SU=Xc(),xU=Zc(),EU=Xc(),TU=Vc(),CU=Zc(),AU=Xc(),Lz(bU=Fz(bU=Bz(bU=zz((XU=jU=function(e){function t(){var t;return se(t=e.call(this)||this,"_string",wU,re(t)),se(t,"_horizontalAlign",PU,re(t)),se(t,"_verticalAlign",RU,re(t)),se(t,"_actualFontSize",DU,re(t)),se(t,"_fontSize",OU,re(t)),se(t,"_fontFamily",NU,re(t)),se(t,"_lineHeight",MU,re(t)),se(t,"_overflow",LU,re(t)),se(t,"_enableWrapText",FU,re(t)),se(t,"_font",BU,re(t)),se(t,"_isSystemFontUsed",zU,re(t)),se(t,"_spacingX",UU,re(t)),se(t,"_isItalic",kU,re(t)),se(t,"_isBold",GU,re(t)),se(t,"_isUnderline",HU,re(t)),se(t,"_underlineHeight",VU,re(t)),se(t,"_cacheMode",WU,re(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}Z(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){e.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof rB){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof rB){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===QU.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new BF,this._assemblerData=this._assembler.getAssemblerData();var n=new Hm(this._assemblerData.canvas),i=new hv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==QU.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==QU.CHAR){var t=this._texture.texture;if(t instanceof km){var n=t.getPixelFormat();e=n===ym.RGBA_ETC1||n===ym.RGB_A_PVRTC_4BPPV1||n===ym.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?Nz.USE_ALPHA_SEPARATED:Nz.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},n._updateBlendFunc=function(){e.prototype._updateBlendFunc.call(this)},Q(t,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==QU.BITMAP||this._font instanceof rB||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===QU.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof rB?this._font.fontSize:-1}}]),t}(JU),jU.HorizontalAlign=qU,jU.VerticalAlign=YU,jU.Overflow=KU,jU.CacheMode=QU,jU._canvasPool=TB.getInstance(),ce((IU=XU).prototype,"string",[Uz,kz,$c],Object.getOwnPropertyDescriptor(IU.prototype,"string"),IU.prototype),ce(IU.prototype,"horizontalAlign",[Gz,Hz,Vz],Object.getOwnPropertyDescriptor(IU.prototype,"horizontalAlign"),IU.prototype),ce(IU.prototype,"verticalAlign",[Wz,jz,Xz],Object.getOwnPropertyDescriptor(IU.prototype,"verticalAlign"),IU.prototype),ce(IU.prototype,"fontSize",[qz,Yz],Object.getOwnPropertyDescriptor(IU.prototype,"fontSize"),IU.prototype),ce(IU.prototype,"fontFamily",[Kz,Qz,Jz],Object.getOwnPropertyDescriptor(IU.prototype,"fontFamily"),IU.prototype),ce(IU.prototype,"lineHeight",[Zz,$z],Object.getOwnPropertyDescriptor(IU.prototype,"lineHeight"),IU.prototype),ce(IU.prototype,"spacingX",[eU,tU,nU],Object.getOwnPropertyDescriptor(IU.prototype,"spacingX"),IU.prototype),ce(IU.prototype,"overflow",[iU,rU,aU],Object.getOwnPropertyDescriptor(IU.prototype,"overflow"),IU.prototype),ce(IU.prototype,"enableWrapText",[oU,sU],Object.getOwnPropertyDescriptor(IU.prototype,"enableWrapText"),IU.prototype),ce(IU.prototype,"font",[cU,lU,uU,hU],Object.getOwnPropertyDescriptor(IU.prototype,"font"),IU.prototype),ce(IU.prototype,"useSystemFont",[fU,_U],Object.getOwnPropertyDescriptor(IU.prototype,"useSystemFont"),IU.prototype),ce(IU.prototype,"cacheMode",[dU,pU,mU],Object.getOwnPropertyDescriptor(IU.prototype,"cacheMode"),IU.prototype),ce(IU.prototype,"isBold",[vU,gU],Object.getOwnPropertyDescriptor(IU.prototype,"isBold"),IU.prototype),ce(IU.prototype,"isItalic",[yU,SU],Object.getOwnPropertyDescriptor(IU.prototype,"isItalic"),IU.prototype),ce(IU.prototype,"isUnderline",[xU,EU],Object.getOwnPropertyDescriptor(IU.prototype,"isUnderline"),IU.prototype),ce(IU.prototype,"underlineHeight",[TU,Hc,CU,AU],Object.getOwnPropertyDescriptor(IU.prototype,"underlineHeight"),IU.prototype),wU=ce(IU.prototype,"_string",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),PU=ce(IU.prototype,"_horizontalAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qU.CENTER}}),RU=ce(IU.prototype,"_verticalAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YU.CENTER}}),DU=ce(IU.prototype,"_actualFontSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OU=ce(IU.prototype,"_fontSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),NU=ce(IU.prototype,"_fontFamily",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),MU=ce(IU.prototype,"_lineHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),LU=ce(IU.prototype,"_overflow",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KU.NONE}}),FU=ce(IU.prototype,"_enableWrapText",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),BU=ce(IU.prototype,"_font",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zU=ce(IU.prototype,"_isSystemFontUsed",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UU=ce(IU.prototype,"_spacingX",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kU=ce(IU.prototype,"_isItalic",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GU=ce(IU.prototype,"_isBold",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HU=ce(IU.prototype,"_isUnderline",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VU=ce(IU.prototype,"_underlineHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),WU=ce(IU.prototype,"_cacheMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QU.NONE}}),bU=IU))||bU)||bU)||bU)||bU));l.Label=tk,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(ZU||(ZU={})),st(ZU),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}($U||($U={})),st($U),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(ek||(ek={})),st(ek);var nk=Math.PI,ik=Math.min,rk=Math.max,ak=Math.cos,ok=Math.sin,sk=Math.abs,ck=Math.sign,lk=.5522847493;function uk(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*lk,t-i*lk,n+r,t,n+r),e.bezierCurveTo(t+i*lk,n+r,t+i,n+r*lk,t+i,n),e.bezierCurveTo(t+i,n-r*lk,t+i*lk,n-r,t,n-r),e.bezierCurveTo(t-i*lk,n-r,t-i,n-r*lk,t-i,n),e.close()}function hk(e,t,n,i,r,a,o,s,c,l,u){var h,f,_,d,p,m,v,g,y,S,x,E,T,C,A,b;l>10||(p=.5*(a+s),m=.5*(o+c),v=.5*((h=.5*(t+i))+(_=.5*(i+a))),g=.5*((f=.5*(n+r))+(d=.5*(r+o))),((A=sk((i-s)*(C=c-n)-(r-c)*(T=s-t)))+(b=sk((a-s)*C-(o-c)*T)))*(A+b)<e.tessTol*(T*T+C*C)?e.addPoint(s,c,0===u?u|ek.PT_BEVEL:u):(hk(e,t,n,h,f,v,g,x=.5*(v+(y=.5*(_+p))),E=.5*(g+(S=.5*(d+m))),l+1,0),hk(e,x,E,y,S,p,m,s,c,l+1,u)))}var fk,_k,dk,pk,mk,vk,gk,yk,Sk,xk,Ek,Tk,Ck,Ak,bk,Ik,wk,Pk,Rk,Dk,Ok,Nk,Mk,Lk,Fk,Bk,zk,Uk,kk,Gk,Hk,Vk,Wk,jk,Xk,qk,Yk,Kk,Qk,Jk,Zk,$k,eG,tG,nG,iG,rG,aG=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return Z(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(Yn),oG=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),sG=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=In.WHITE.clone(),this.lineCap=ZU.BUTT,this.strokeColor=In.BLACK.clone(),this.lineJoin=$U.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,ek.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,ek.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,a){var o=this._curPath,s=o.points[o.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==a?(hk(this,s.x,s.y,e,t,n,i,r,a,0,ek.PT_CORNER),this._commandX=r,this._commandY=a):this.lineTo(r,a))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,a=this._commandY;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,a){!function(e,t,n,i,r,a,o){var s,c,l=0,u=0,h=0,f=0,_=0,d=0,p=0,m=0,v=0,g=0,y=0,S=0,x=0,E=0;if(u=a-r,o=o||!1)if(sk(u)>=2*nk)u=2*nk;else for(;u<0;)u+=2*nk;else if(sk(u)>=2*nk)u=2*-nk;else for(;u>0;)u-=2*nk;for(c=0|rk(1,ik(sk(u)/(.5*nk)+.5,5)),h=sk(4/3*(1-ak(s=u/c/2))/ok(s)),o||(h=-h),E=0;E<=c;E++)d=t+(f=ak(l=r+u*(E/c)))*i,p=n+(_=ok(l))*i,m=-_*i*h,v=f*i*h,0===E?e.moveTo(d,p):e.bezierCurveTo(g+S,y+x,d-m,p-v,d,p),g=d,y=p,S=m,x=v}(this,e,t,n,i,r,a)},t.ellipse=function(e,t,n,i){uk(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){uk(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,a){if(a<.1)e.rect(t,n,i,r);else{var o=ik(a,.5*sk(i))*ck(i),s=ik(a,.5*sk(r))*ck(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-lk),t+o*(1-lk),n+r,t+o,n+r),e.lineTo(t+i-o,n+r),e.bezierCurveTo(t+i-o*(1-lk),n+r,t+i,n+r-s*(1-lk),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-lk),t+i-o*(1-lk),n,t+i-o,n),e.lineTo(t+o,n),e.bezierCurveTo(t+o*(1-lk),n,t,n+s*(1-lk),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&iz.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=iz.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,a=i.points,o=r[this.pointsOffset++];o?(o.x=e,o.y=t):(o=new aG(e,t),r.push(o)),o.flags=n,a.push(o)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new oG,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),cG=OB.concat([new Or("a_dist",_i.R32F)]),lG=LB(cG),uG=FB(cG),hG=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((fk=Tc("cc.Graphics"),_k=Gc(),dk=Ac(110),pk=Bc(),mk=Xc(),vk=al($U),gk=Xc(),yk=al(ZU),Sk=Xc(),xk=Xc(),Ek=Xc(),Tk=Xc(),Ck=Vc(),fk(Ak=_k(Ak=dk(Ak=pk((Mk=Nk=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,se(t,"_lineWidth",Ik,re(t)),se(t,"_strokeColor",wk,re(t)),se(t,"_lineJoin",Pk,re(t)),se(t,"_lineCap",Rk,re(t)),se(t,"_fillColor",Dk,re(t)),se(t,"_miterLimit",Ok,re(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=Nz.ADD_COLOR,t.impl=new sG,t}Z(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=nN.root.createModel(iy),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(nN.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),e.prototype.onDestroy.call(this)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,a){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,a)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,a){this.impl&&this.impl.arc(e,t,n,i,r,a)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=Sv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=l.director.root.device,n=t.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,65535*uG,uG)),i=t.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new eI([n],cG,Ui.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(e,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else R(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],a=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var o=new Float32Array(r.vData.buffer,0,r.vertexStart*lG);a.vertexBuffers[0].update(o),a.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);a.indexBuffer.update(s),a.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},Q(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(JU),Nk.LineJoin=$U,Nk.LineCap=ZU,ce((bk=Mk).prototype,"lineWidth",[Hc,mk],Object.getOwnPropertyDescriptor(bk.prototype,"lineWidth"),bk.prototype),ce(bk.prototype,"lineJoin",[vk,gk],Object.getOwnPropertyDescriptor(bk.prototype,"lineJoin"),bk.prototype),ce(bk.prototype,"lineCap",[yk,Sk],Object.getOwnPropertyDescriptor(bk.prototype,"lineCap"),bk.prototype),ce(bk.prototype,"strokeColor",[xk],Object.getOwnPropertyDescriptor(bk.prototype,"strokeColor"),bk.prototype),ce(bk.prototype,"fillColor",[Ek],Object.getOwnPropertyDescriptor(bk.prototype,"fillColor"),bk.prototype),ce(bk.prototype,"miterLimit",[Tk],Object.getOwnPropertyDescriptor(bk.prototype,"miterLimit"),bk.prototype),ce(bk.prototype,"color",[sl,Ck],Object.getOwnPropertyDescriptor(bk.prototype,"color"),bk.prototype),Ik=ce(bk.prototype,"_lineWidth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wk=ce(bk.prototype,"_strokeColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.BLACK.clone()}}),Pk=ce(bk.prototype,"_lineJoin",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $U.MITER}}),Rk=ce(bk.prototype,"_lineCap",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZU.BUTT}}),Dk=ce(bk.prototype,"_fillColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.WHITE.clone()}}),Ok=ce(bk.prototype,"_miterLimit",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Ak=bk))||Ak)||Ak)||Ak)||Ak));l.Graphics=hG;var fG,_G=new Wn,dG=new Yn,pG=new Wn,mG=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(fG||(fG={})),st(fG);var vG=function(t){return e({Mask:t,MaskComponent:t}),t}((Lk=Tc("cc.Mask"),Fk=Gc(),Bk=Ac(110),zk=Bc(),Uk=al(fG),kk=Xc(),Gk=Zc(),Hk=Xc(),Vk=Vc(),Wk=al(BF),jk=Vc(),Xk=Vc(),qk=qc(),Yk=Vc(),Kk=Vc(),Lk(Qk=Fk(Qk=Bk(Qk=zk((rG=iG=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,se(t,"_type",Zk,re(t)),se(t,"_inverted",$k,re(t)),se(t,"_segments",eG,re(t)),se(t,"_spriteFrame",tG,re(t)),se(t,"_alphaThreshold",nG,re(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=Nz.ADD_COLOR,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(nN.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),e.prototype.onDestroy.call(this)},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,a=dG;this.node.getWorldMatrix(_G),Wn.invert(pG,_G),Yn.transformMat4(a,e,pG);var o=t.anchorPoint;a.x+=o.x*i,a.y+=o.y*r;var s=!1;if(this.type===fG.RECT||this.type===fG.GRAPHICS_STENCIL||this.type===fG.IMAGE_STENCIL)s=a.x>=0&&a.y>=0&&a.x<=i&&a.y<=r;else if(this.type===fG.ELLIPSE){var c=i/2,l=r/2,u=a.x-.5*i,h=a.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==fG.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new hG;e._objFlags|=_l.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=In.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===fG.RECT||this._type===fG.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,a=e.anchorPoint,o=-i*a.x,s=-r*a.y;if(this._type===fG.RECT)t.rect(o,s,i,r);else if(this._type===fG.ELLIPSE){for(var c=function(e,t,n){mG.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)mG.push(new Pn(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return mG}(new Pn(o+i/2,s+r/2,0),new Pn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=Sv.get("default-clear-stencil");this._clearStencilMtl=new oy({parent:e,owner:this,subModelIdx:0}),this._clearModel=nN.root.createModel(iy),this._clearModel.node=this._clearModel.transform=this.node;var t=FB(DB),n=l.director.root.device,i=n.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,4*t,t)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var a=n.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new Uint16Array([0,1,2,2,1,3]);a.update(o),this._clearModelMesh=new eI([i],DB,Ui.TRIANGLE_LIST,a),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=JB.DISABLED,this._type===fG.IMAGE_STENCIL?(e=Sv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=Sv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==fG.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},Q(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==fG.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=JB.DISABLED,this._graphics&&(this._graphics.stencilStage=JB.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=cn(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===fG.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===fG.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(JU),iG.Type=fG,ce((Jk=rG).prototype,"type",[Uk,kk],Object.getOwnPropertyDescriptor(Jk.prototype,"type"),Jk.prototype),ce(Jk.prototype,"inverted",[Gk,Hk],Object.getOwnPropertyDescriptor(Jk.prototype,"inverted"),Jk.prototype),ce(Jk.prototype,"segments",[Vk],Object.getOwnPropertyDescriptor(Jk.prototype,"segments"),Jk.prototype),ce(Jk.prototype,"spriteFrame",[Wk,jk],Object.getOwnPropertyDescriptor(Jk.prototype,"spriteFrame"),Jk.prototype),ce(Jk.prototype,"alphaThreshold",[Xk,qk,Jc],Object.getOwnPropertyDescriptor(Jk.prototype,"alphaThreshold"),Jk.prototype),ce(Jk.prototype,"color",[sl,Yk],Object.getOwnPropertyDescriptor(Jk.prototype,"color"),Jk.prototype),ce(Jk.prototype,"customMaterial",[sl,Kk],Object.getOwnPropertyDescriptor(Jk.prototype,"customMaterial"),Jk.prototype),Zk=ce(Jk.prototype,"_type",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fG.RECT}}),$k=ce(Jk.prototype,"_inverted",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eG=ce(Jk.prototype,"_segments",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),tG=ce(Jk.prototype,"_spriteFrame",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nG=ce(Jk.prototype,"_alphaThreshold",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Qk=Jk))||Qk)||Qk)||Qk)||Qk));UP._maskComp=vG,l.Mask=vG;var gG,yG,SG,xG,EG,TG,CG,AG,bG,IG,wG,PG,RG,DG,OG,NG,MG,LG,FG,BG,zG,UG,kG,GG,HG,VG,WG,jG,XG,qG,YG,KG,QG,JG,ZG,$G,eH,tH,nH,iH,rH,aH,oH,sH,cH,lH,uH,hH,fH,_H,dH,pH,mH,vH,gH,yH,SH,xH,EH,TH,CH,AH,bH=/^(click)(\s)*=|(param)(\s)*=/,IH=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,wH=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var a=e.substring(t,r),o=e.substring(r+1,i);""===o&&(a=e.substring(t,i+1)),this._processResult(a),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(o),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,a="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var o="",s=-1;if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var c;n=IH.exec(e);for(var l=!1;n;){var u=(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length)).length;if(i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),o=e.substring(u).trim(),s="src"===i?this.getRightQuotationIndex(o):-1,c=(r=o.indexOf(" ",s+1>=o.length?-1:s+1))>-1?o.substr(0,r):o,e=o.substring(r).trim(),c.endsWith("/")&&(c=c.slice(0,-1)),"src"===i){switch(c.charCodeAt(0)){case 34:case 39:l=!0,c=c.slice(1,-1)}t.isImage=!0,t.src=c}else if("height"===i)t.imageHeight=parseInt(c);else if("width"===i)t.imageWidth=parseInt(c);else if("align"===i){switch(c.charCodeAt(0)){case 34:case 39:c=c.slice(1,-1)}t.imageAlign=c.toLowerCase()}else"offset"===i?t.imageOffset=c:"click"===i&&(t.event=this._processEventHandler(i+"="+c));t.event&&"param"===i&&(t.event[i]=c.replace(/^"|"$/g,"")),n=IH.exec(e)}return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var h={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var f,_=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=_.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),f=(r=(o=e.substring(i.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=o.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+f):"color"===i?h.color=f:"width"===i&&(h.width=parseInt(f)),t.event&&"param"===i&&(t.event[i]=f.replace(/^"|"$/g,"")),n=_.exec(e)}t.outline=h}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t.getRightQuotationIndex=function(e){var t=-1,n=-1,i=e.indexOf("'"),r=e.indexOf('"'),a=r>-1&&(r<i||-1===i);return i>-1&&(i<r||-1===r)?(t=i,n=e.indexOf("'",t+1>=e.length?-1:t+1)):a&&(t=r,n=e.indexOf('"',t+1>=e.length?-1:t+1)),n},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=bH.exec(e);r;){var a=r[0],o="";if(i=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(o=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(o=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(o=s?s[0]:"").length}i&&(t[a=a.substring(0,a.length-1).trim()]=o),e=e.substring(n).trim(),r=bH.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=oe(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],a=i[1];e=e.replace(r,a)}return e},e}()),PH=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((gG=Tc("cc.LabelOutline"),yG=Gc(),SG=Ac(110),xG=Bc(),EG=Cc(tk),TG=Xc(),CG=Xc(),gG(AG=yG(AG=SG(AG=xG(AG=EG(AG=Fc((PG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_color",IG,re(t)),se(t,"_width",wG,re(t)),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(tk);e&&e.updateRenderData(!0)},Q(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(Ku),IG=ce((bG=PG).prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(0,0,0,255)}}),wG=ce(bG.prototype,"_width",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),ce(bG.prototype,"color",[TG],Object.getOwnPropertyDescriptor(bG.prototype,"color"),bG.prototype),ce(bG.prototype,"width",[CG],Object.getOwnPropertyDescriptor(bG.prototype,"width"),bG.prototype),AG=bG))||AG)||AG)||AG)||AG)||AG)||AG));l.LabelOutline=PH,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(EH||(EH={})),st(EH),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(TH||(TH={})),st(TH),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(CH||(CH={})),st(CH),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(AH||(AH={}));var RH,DH=function(t){return e({Sprite:t,SpriteComponent:t}),t}((RG=Tc("cc.Sprite"),DG=Gc(),OG=Ac(110),NG=Bc(),MG=al(UF),LG=Zc(),FG=Xc(),BG=al(BF),zG=Zc(),UG=Xc(),kG=al(EH),GG=Zc(),HG=Xc(),VG=al(TH),WG=Zc(),jG=Xc(),XG=Zc(),qG=Xc(),YG=qc(),KG=Zc(),QG=Xc(),JG=qc(),ZG=Zc(),$G=Xc(),eH=Vc(),tH=Zc(),nH=Xc(),iH=Zc(),rH=Xc(),aH=al(CH),oH=Zc(),sH=Xc(),RG(cH=DG(cH=OG(cH=NG((xH=SH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_spriteFrame",uH,re(t)),se(t,"_type",hH,re(t)),se(t,"_fillType",fH,re(t)),se(t,"_sizeMode",_H,re(t)),se(t,"_fillCenter",dH,re(t)),se(t,"_fillStart",pH,re(t)),se(t,"_fillRange",mH,re(t)),se(t,"_isTrimmedMode",vH,re(t)),se(t,"_useGrayscale",gH,re(t)),se(t,"_atlas",yH,re(t)),t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial();var t=this._spriteFrame;t&&(this._updateUVs(),this._type===EH.SLICED&&t.on(BF.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===EH.SLICED&&this._spriteFrame.off(BF.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof km){var i=e.getPixelFormat();n=i===ym.RGBA_ETC1||i===ym.RGB_A_PVRTC_4BPPV1||i===ym.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=Nz.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=Nz.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=Nz.GRAYSCALE:this._instanceMaterialType=Nz.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof OE){var n=J({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new Qv;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===EH.SLICED?this._spriteFrame.on(BF.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(BF.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(CH.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(CH.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(e){var t=this._spriteFrame;e&&this._type===EH.SLICED&&e.off(BF.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===EH.SLICED&&t.on(BF.EVENT_UV_UPDATED,this._updateUVs,this))},Q(t,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===TH.RADIAL||this._fillType===TH.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===EH.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=cn(e,0,1),this._type===EH.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=cn(e,-1,1),this._type===EH.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===EH.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==CH.CUSTOM&&this._applySpriteSize())}}]),t}(JU),SH.FillType=TH,SH.Type=EH,SH.SizeMode=CH,SH.EventType=AH,ce((lH=xH).prototype,"spriteAtlas",[MG,LG,FG],Object.getOwnPropertyDescriptor(lH.prototype,"spriteAtlas"),lH.prototype),ce(lH.prototype,"spriteFrame",[BG,zG,UG],Object.getOwnPropertyDescriptor(lH.prototype,"spriteFrame"),lH.prototype),ce(lH.prototype,"type",[kG,GG,HG],Object.getOwnPropertyDescriptor(lH.prototype,"type"),lH.prototype),ce(lH.prototype,"fillType",[VG,WG,jG],Object.getOwnPropertyDescriptor(lH.prototype,"fillType"),lH.prototype),ce(lH.prototype,"fillCenter",[XG,qG],Object.getOwnPropertyDescriptor(lH.prototype,"fillCenter"),lH.prototype),ce(lH.prototype,"fillStart",[YG,KG,QG],Object.getOwnPropertyDescriptor(lH.prototype,"fillStart"),lH.prototype),ce(lH.prototype,"fillRange",[JG,ZG,$G],Object.getOwnPropertyDescriptor(lH.prototype,"fillRange"),lH.prototype),ce(lH.prototype,"trim",[eH,tH,nH],Object.getOwnPropertyDescriptor(lH.prototype,"trim"),lH.prototype),ce(lH.prototype,"grayscale",[Hc,iH,rH],Object.getOwnPropertyDescriptor(lH.prototype,"grayscale"),lH.prototype),ce(lH.prototype,"sizeMode",[aH,oH,sH],Object.getOwnPropertyDescriptor(lH.prototype,"sizeMode"),lH.prototype),uH=ce(lH.prototype,"_spriteFrame",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hH=ce(lH.prototype,"_type",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EH.SIMPLE}}),fH=ce(lH.prototype,"_fillType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TH.HORIZONTAL}}),_H=ce(lH.prototype,"_sizeMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CH.TRIMMED}}),dH=ce(lH.prototype,"_fillCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(0,0)}}),pH=ce(lH.prototype,"_fillStart",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mH=ce(lH.prototype,"_fillRange",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vH=ce(lH.prototype,"_isTrimmedMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gH=ce(lH.prototype,"_useGrayscale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yH=ce(lH.prototype,"_atlas",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cH=lH))||cH)||cH)||cH)||cH));l.Sprite=DH;var OH,NH,MH,LH,FH,BH,zH,UH,kH,GH,HH,VH,WH,jH,XH,qH,YH,KH,QH,JH,ZH,$H,eV,tV,nV,iV,rV,aV,oV,sV,cV,lV,uV,hV,fV,_V,dV,pV,mV,vV,gV,yV,SV,xV,EV,TV,CV,AV,bV,IV,wV,PV,RV=e("RenderRoot2D",Tc("cc.RenderRoot2D")(RH=Ac(100)(RH=Bc()(RH=Cc(_z)(RH=bc(RH=Fc(RH=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.onEnable=function(){l.director.root.batcher2D.addScreen(this)},n.onDisable=function(){l.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){l.director.root.batcher2D.removeScreen(this)},t}(Ku))||RH)||RH)||RH)||RH)||RH)||RH),DV=new Pn,OV=rt({OVERLAY:0,INTERSPERSE:1}),NV=function(t){return e({Canvas:t,CanvasComponent:t}),t}((OH=Tc("cc.Canvas"),NH=Gc(),MH=Ac(100),LH=Bc(),FH=al(gF),BH=Xc(),zH=Xc(),UH=al(gF),OH(kH=NH(kH=MH(kH=LH(kH=Fc(kH=bc((ce((GH=function(e){function t(){var t;return se(t=e.call(this)||this,"_cameraComponent",HH,re(t)),se(t,"_alignCanvasWithScreen",VH,re(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new Pn,t._renderMode=OV.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(re(t)),t}Z(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(gF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(tC.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(gF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(gF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(tC.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=aN.height/2;else{var e=rh.windowSize;this._cameraComponent.orthoHeight=e.height/fN.getScaleY()/2}this.node.getWorldPosition(DV),this._cameraComponent.node.setWorldPosition(DV.x,DV.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===OV.OVERLAY?t|1<<30:t&~(1<<30)}return 0},Q(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(RV)).prototype,"cameraComponent",[FH,BH],Object.getOwnPropertyDescriptor(GH.prototype,"cameraComponent"),GH.prototype),ce(GH.prototype,"alignCanvasWithScreen",[zH],Object.getOwnPropertyDescriptor(GH.prototype,"alignCanvasWithScreen"),GH.prototype),HH=ce(GH.prototype,"_cameraComponent",[UH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VH=ce(GH.prototype,"_alignCanvasWithScreen",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kH=GH))||kH)||kH)||kH)||kH)||kH)||kH));l.Canvas=NV,k(e("UIComponent",Tc("cc.UIComponent")(WH=Cc(_z)(WH=Ac(110)(WH=bc(WH=Fc(WH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=JB.DISABLED,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(Ku))||WH)||WH)||WH)||WH)||WH).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),k(JU.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor"},{name:"dstBlendFactor"}]),U(NV.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:In.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),G(_z.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),l.UITransformComponent=_z,nt.setClassAlias(_z,"cc.UITransformComponent"),nt.setClassAlias(JU,"cc.RenderComponent"),l.CanvasComponent=NV,nt.setClassAlias(NV,"cc.CanvasComponent");var MV=new wH,LV="RICHTEXT_CHILD",FV="RICHTEXT_Image_CHILD",BV=new et((function(e){if(!l.isValid(e.node))return!1;var t=e.node.getComponent(PH);return t&&(t.width=0),!0}),20),zV=new et((function(e){return l.isValid(e.node)}),10);function UV(e){return{node:new ib(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function kV(e,t){var n;e===LV?n=BV._get():e===FV&&(n=zV._get());var i=(n=n||UV(e)).node;return i||(i=new ib(e)),i.hideFlags|=_l.Flags.DontSave|_l.Flags.HideInHierarchy,e===FV?(n.comp=i.getComponent(DH)||i.addComponent(DH),n.comp.spriteFrame=t,n.comp.type=DH.Type.SLICED,n.comp.sizeMode=DH.SizeMode.CUSTOM):(n.comp=i.getComponent(tk)||i.addComponent(tk),n.comp.string=t,n.comp.horizontalAlign=qU.LEFT,n.comp.verticalAlign=YU.TOP,n.comp.underlineHeight=2),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var GV,HV=function(t){return e({RichText:t,RichTextComponent:t}),t}((jH=Tc("cc.RichText"),XH=Gc(),qH=Ac(110),YH=Bc(),KH=Xc(),QH=al(qU),JH=Xc(),ZH=al(YU),$H=Xc(),eV=Xc(),tV=Xc(),nV=al(WF),iV=Xc(),rV=Xc(),aV=Zc(),oV=al(QU),sV=Xc(),cV=Xc(),lV=Xc(),uV=al(UF),hV=Xc(),fV=Xc(),jH(_V=XH(_V=qH(_V=YH(_V=Fc((PV=wV=function(e){function t(){var t;return se(t=e.call(this)||this,"_lineHeight",pV,re(t)),se(t,"_string",mV,re(t)),se(t,"_horizontalAlign",vV,re(t)),se(t,"_verticalAlign",gV,re(t)),se(t,"_fontSize",yV,re(t)),se(t,"_maxWidth",SV,re(t)),se(t,"_fontFamily",xV,re(t)),se(t,"_font",EV,re(t)),se(t,"_isSystemFontUsed",TV,re(t)),se(t,"_userDefinedFont",CV,re(t)),se(t,"_cacheMode",AV,re(t)),se(t,"_imageAtlas",bV,re(t)),se(t,"_handleTouchEvent",IV,re(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._labelChildrenNum=0,t._updateRichTextStatus=t._updateRichText,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(tC.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(tC.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=oe(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===LV?BV.put(n):n.type===FV&&zV.put(n)}this.node.off(tC.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(tC.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(tC.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(tC.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return kV(LV,e)},n._createImage=function(e){return kV(FV,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n.SplitLongStringApproximatelyIn2048=function(e,t){var n=[];if(this._calculateSize(t,e).x<2048)n.push(e);else for(var i=e.split("\n"),r=0;r<i.length;r++)if(this._calculateSize(t,i[r]).x<2048)n.push(i[r]);else{var a=this.splitLongStringOver2048(i[r],t);n.push.apply(n,a)}return n},n.splitLongStringOver2048=function(e,t){for(var n=[],i=e,r=0,a=i.length/2,o=i.substring(r,a),s=i.substring(a),c=this._calculateSize(t,o),l=(this._calculateSize(t,s),1*this.maxWidth);c.x>l;){if((a/=2)<1){a*=2;break}o=o.substring(r,a),s=i.substring(a),c=this._calculateSize(t,o)}for(var u=1e3,h=1;u&&r<e.length;){for(;u&&c.x<l;){var f=SB(s);f&&f.length>0&&(h=f[0].length),a+=h,o=i.substring(r,a),s=i.substring(a),c=this._calculateSize(t,o),u--}for(;u&&o.length>=2&&c.x>l;)a-=h,o=i.substring(r,a),c=this._calculateSize(t,o),h=1,u--;if(o.length>=2){var _=xB(o);_&&_.length>0&&o!==_[0]&&(a-=_[0].length,o=i.substring(r,a))}if(n.push(o),r=a,a+=o.length,o=i.substring(r,a),s=i.substring(a),u--,this._calculateSize(t,s).x<2048){r=e.length,a=e.length,o=s,n.push(o);break}c=this._calculateSize(t,o)}return n},n._measureText=function(e,t){var n=this,i=function(t){return n._calculateSize(e,t).width};return t?i(t):i},n._calculateSize=function(e,t){var n;return 0===this._labelSegmentsCache.length?(n=this._createFontLabel(t),this._labelSegmentsCache.push(n)):(n=this._labelSegmentsCache[0]).node.getComponent(tk).string=t,n.styleIndex=e,this._applyTextAttribute(n),n.node._uiProps.uiTransformComp.contentSize},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(Ku),r=function(){var r=t.value,a=r.clickHandler,o=r.clickParam;a&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[a];t.enabledInHierarchy&&n&&n.call(t,e,o)})),e.propagationStopped=!0)},a=oe(this._segments);!(t=a()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(_z);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===LV||n.name===FV){n.parent===this.node?n.parent=null:e.splice(t,1);var i=UV(n.name);i.node=n,n.name===LV?(i.comp=n.getComponent(tk),BV.put(i)):(i.comp=n.getComponent(DH),zV.put(i)),this._labelChildrenNum--}}this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==LV&&n.name!==FV||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(tk);i&&(i.string=e)}var r=n.comp;return r.verticalAlign!==this._verticalAlign&&(r.verticalAlign=this._verticalAlign),n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.insertChild(n.node,this._labelChildrenNum++),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var a=this._getFirstWordLen(e,r,e.length),o=e.substr(r,a),s=this._measureText(n,o);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=a}if(i>this._maxWidth)for(var l=EB(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],f=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=f.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,a=i.style;if(r){if(a){if(!!a.outline!=!!r.outline)return!0;if(r.size!==a.size||r.italic!==a.italic||r.isImage!==a.isImage)return!0;if(r.src!==a.src||r.imageAlign!==a.imageAlign||r.imageHeight!==a.imageHeight||r.imageWidth!==a.imageWidth||r.imageOffset!==a.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(a&&(a.size||a.italic||a.isImage||a.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.insertChild(r.node,this._labelChildrenNum++),this._segments.push(r);var a=i.rect.clone(),o=1,s=a.width,c=a.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=o=u/c,c*=o):(s*=o=this._lineHeight/c,c*=o),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else R(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=MV.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var o=(a=this.SplitLongStringApproximatelyIn2048(a,i).join("\n")).split("\n"),s=0;s<o.length;++s){var c=o[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),o.length>1&&s<o.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),o.length>1&&s<o.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&s===o.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+oB)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(mB(i)||vB(i))return 1;for(var r=1,a=t+1;a<n&&!vB(i=e.charAt(a))&&!mB(i);++a)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,a=i.anchorY,o=0;o<this._segments.length;++o){var s=this._segments[o],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case qU.LEFT:break;case qU.CENTER:l-=this._linesWidth[c-1]/2;break;case qU.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*a,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(DH)){var h=s.node.position.clone(),f=this._lineHeight,_=this._lineHeight*(1+oB);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=f+(_-f)/2;break;case.5:h.y+=_/2;break;default:h.y+=(_-f)/2}if(s.imageOffset){var d=s.imageOffset.split(",");if(1===d.length&&d[0]){var p=parseFloat(d[0]);Number.isInteger(p)&&(h.y+=p)}else if(2===d.length){var m=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(PH);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return In[t]?In[t]:(new In).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(tk);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(PH);r||(r=e.node.addComponent(PH)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var a=n.event;a&&(e.clickHandler=a.click||"",e.clickParam=a.param||"")}t.cacheMode=this._cacheMode,this._font instanceof WF&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var o=t._assembler;o&&o.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=oe(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=In.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},Q(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(Ku),wV.HorizontalAlign=qU,wV.VerticalAlign=YU,ce((dV=PV).prototype,"string",[$c,KH],Object.getOwnPropertyDescriptor(dV.prototype,"string"),dV.prototype),ce(dV.prototype,"horizontalAlign",[QH,JH],Object.getOwnPropertyDescriptor(dV.prototype,"horizontalAlign"),dV.prototype),ce(dV.prototype,"verticalAlign",[ZH,$H],Object.getOwnPropertyDescriptor(dV.prototype,"verticalAlign"),dV.prototype),ce(dV.prototype,"fontSize",[eV],Object.getOwnPropertyDescriptor(dV.prototype,"fontSize"),dV.prototype),ce(dV.prototype,"fontFamily",[tV],Object.getOwnPropertyDescriptor(dV.prototype,"fontFamily"),dV.prototype),ce(dV.prototype,"font",[nV,iV],Object.getOwnPropertyDescriptor(dV.prototype,"font"),dV.prototype),ce(dV.prototype,"useSystemFont",[rV,aV],Object.getOwnPropertyDescriptor(dV.prototype,"useSystemFont"),dV.prototype),ce(dV.prototype,"cacheMode",[oV,sV],Object.getOwnPropertyDescriptor(dV.prototype,"cacheMode"),dV.prototype),ce(dV.prototype,"maxWidth",[cV],Object.getOwnPropertyDescriptor(dV.prototype,"maxWidth"),dV.prototype),ce(dV.prototype,"lineHeight",[lV],Object.getOwnPropertyDescriptor(dV.prototype,"lineHeight"),dV.prototype),ce(dV.prototype,"imageAtlas",[uV,hV],Object.getOwnPropertyDescriptor(dV.prototype,"imageAtlas"),dV.prototype),ce(dV.prototype,"handleTouchEvent",[fV],Object.getOwnPropertyDescriptor(dV.prototype,"handleTouchEvent"),dV.prototype),pV=ce(dV.prototype,"_lineHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),mV=ce(dV.prototype,"_string",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),vV=ce(dV.prototype,"_horizontalAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qU.LEFT}}),gV=ce(dV.prototype,"_verticalAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YU.TOP}}),yV=ce(dV.prototype,"_fontSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),SV=ce(dV.prototype,"_maxWidth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xV=ce(dV.prototype,"_fontFamily",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),EV=ce(dV.prototype,"_font",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TV=ce(dV.prototype,"_isSystemFontUsed",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),CV=ce(dV.prototype,"_userDefinedFont",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AV=ce(dV.prototype,"_cacheMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QU.NONE}}),bV=ce(dV.prototype,"_imageAtlas",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IV=ce(dV.prototype,"_handleTouchEvent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_V=dV))||_V)||_V)||_V)||_V)||_V));l.RichText=HV;var VV=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(Tc("cc.UIMeshRenderer")(GV=Gc()(GV=Ac(110)(GV=Bc()(GV=Fc(GV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._modelComponent=null,t.stencilStage=JB.DISABLED,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent||console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null)},n.updateAssembler=function(e){if(this._modelComponent){var t=this._modelComponent._collectModels();this._modelComponent._detachFromScene();for(var n=0;n<t.length;n++)t[n].enabled&&e.commitModel(this,t[n],this._modelComponent.material);return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,a=0;a<r;a++)i[a]._priority=Cd.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},a)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},Q(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(Ku))||GV)||GV)||GV)||GV)||GV);l.UIMeshRenderer=VV;var WV,jV,XV,qV,YV,KV,QV,JV,ZV,$V,eW,tW,nW,iW,rW,aW,oW,sW,cW,lW,uW,hW,fW,_W,dW,pW,mW,vW,gW,yW=Ed.Enum.NONE|Ed.Enum.UI_3D,SW=e("UIDrawBatch",function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=yW,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=yW,this.renderScene=null},t.fillPasses=function(e,t,n,i,r,a){if(e){var o=e.passes;if(!o)return;var s=0;this._shaders.length=o.length;for(var c=0;c<o.length;c++){this._passes[c]||(this._passes[c]=new Iv(l.director.root));var u=o[c],h=this._passes[c];u.update(),t||(t=u.depthStencilState,n=0),i||(i=u.blendState,r=0),-1===r&&(r=0),s=n<<16|r,h._initPassFromTarget(u,t,i,s),this._shaders[c]=h.getShaderVariant(a)}}},Q(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}()),xW=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((WV=Tc("cc.UIStaticBatch"),jV=Gc(),XV=Bc(),qV=Ac(110),YV=Vc(),WV(KV=jV(KV=XV(KV=qV((ce((QV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._bufferAccessor=null,t._dirty=!0,t._uiDrawBatchList=[],t}Z(t,e);var n=t.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var e=new SW;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return nN.root&&nN.root.batcher2D?nN.root.batcher2D:(R(9301),null)},Q(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(JU)).prototype,"color",[sl,YV],Object.getOwnPropertyDescriptor(QV.prototype,"color"),QV.prototype),KV=QV))||KV)||KV)||KV)||KV)),EW=e("LabelShadow",(JV=Tc("cc.LabelShadow"),ZV=Gc(),$V=Ac(110),eW=Bc(),tW=Cc(tk),nW=Xc(),iW=Xc(),rW=Xc(),JV(aW=ZV(aW=$V(aW=eW(aW=tW(aW=Fc((uW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_color",sW,re(t)),se(t,"_offset",cW,re(t)),se(t,"_blur",lW,re(t)),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(tk);e&&e.updateRenderData(!0)},Q(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(Ku),sW=ce((oW=uW).prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(0,0,0,255)}}),cW=ce(oW.prototype,"_offset",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(2,2)}}),lW=ce(oW.prototype,"_blur",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),ce(oW.prototype,"color",[nW],Object.getOwnPropertyDescriptor(oW.prototype,"color"),oW.prototype),ce(oW.prototype,"offset",[iW],Object.getOwnPropertyDescriptor(oW.prototype,"offset"),oW.prototype),ce(oW.prototype,"blur",[rW],Object.getOwnPropertyDescriptor(oW.prototype,"blur"),oW.prototype),aW=oW))||aW)||aW)||aW)||aW)||aW)||aW)),TW=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}((hW=Tc("cc.UIOpacity"),fW=Gc(),_W=Ac(110),dW=Bc(),pW=Xc(),hW(mW=fW(mW=_W(mW=dW(mW=Fc(mW=bc((ce((vW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_opacity",gW,re(t)),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},Q(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=xt(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(Ku)).prototype,"opacity",[Hc,pW],Object.getOwnPropertyDescriptor(vW.prototype,"opacity"),vW.prototype),gW=ce(vW.prototype,"_opacity",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),mW=vW))||mW)||mW)||mW)||mW)||mW)||mW));l.MaskComponent=vG,nt.setClassAlias(vG,"cc.MaskComponent"),l.LabelComponent=tk,nt.setClassAlias(tk,"cc.LabelComponent"),l.LabelOutlineComponent=PH,nt.setClassAlias(PH,"cc.LabelOutlineComponent"),l.RichTextComponent=HV,nt.setClassAlias(HV,"cc.RichTextComponent"),l.SpriteComponent=DH,nt.setClassAlias(DH,"cc.SpriteComponent"),l.UIModelComponent=VV,nt.setClassAlias(VV,"cc.UIModelComponent"),l.GraphicsComponent=hG,nt.setClassAlias(hG,"cc.GraphicsComponent"),nt.setClassAlias(xW,"cc.UIStaticBatchComponent"),nt.setClassAlias(TW,"cc.UIOpacityComponent");var CW=function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n};function AW(e,t,n,i,r){var a=0,o=null;if(r===function(e,t,n,i){for(var r=0,a=t,o=n-i;a<n;a+=i)r+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return r}(e,t,n,i)>0)for(a=t;a<n;a+=i)o=VW(a,e[a],e[a+1],o);else for(a=n-i;a>=t;a-=i)o=VW(a,e[a],e[a+1],o);return o&&UW(o,o.next)&&(WW(o),o=o.next),o}function bW(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!UW(n,n.next)&&0!==zW(n.prev,n,n.next))n=n.next;else{if(WW(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function IW(e,t,n,i,r,a,o){if(void 0===o&&(o=0),e){!o&&a&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=MW(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,a=null,o=0,s=0,c=0,l=1;do{for(n=e,e=null,a=null,o=0;n;){for(o++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;n=i}a.nextZ=null,l*=2}while(o>1)}(r)}(e,i,r,a);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,a?PW(e,i,r,a):wW(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),WW(e),e=l.next,s=l.next;else if((e=l)===s){o?1===o?IW(e=RW(e,t,n),t,n,i,r,a,2):2===o&&DW(e,t,n,i,r,a):IW(bW(e),t,n,i,r,a,1);break}}}function wW(e){var t=e.prev,n=e,i=e.next;if(zW(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(FW(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&zW(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function PW(e,t,n,i){var r=e.prev,a=e,o=e.next;if(zW(r,a,o)>=0)return!1;for(var s=r.x<a.x?r.x<o.x?r.x:o.x:a.x<o.x?a.x:o.x,c=r.y<a.y?r.y<o.y?r.y:o.y:a.y<o.y?a.y:o.y,l=r.x>a.x?r.x>o.x?r.x:o.x:a.x>o.x?a.x:o.x,u=r.y>a.y?r.y>o.y?r.y:o.y:a.y>o.y?a.y:o.y,h=MW(s,c,t,n,i),f=MW(l,u,t,n,i),_=e.nextZ;_&&_.z<=f;){if(_!==e.prev&&_!==e.next&&FW(r.x,r.y,a.x,a.y,o.x,o.y,_.x,_.y)&&zW(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=h;){if(_!==e.prev&&_!==e.next&&FW(r.x,r.y,a.x,a.y,o.x,o.y,_.x,_.y)&&zW(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}function RW(e,t,n){var i=e;do{var r=i.prev,a=i.next.next;!UW(r,a)&&kW(r,i,i.next,a)&&GW(r,a)&&GW(a,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(a.i/n),WW(i),WW(i.next),i=e=a),i=i.next}while(i!==e);return i}function DW(e,t,n,i,r,a){var o=e;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&BW(o,s)){var c=HW(o,s);return o=bW(o,o.next),c=bW(c,c.next),IW(o,t,n,i,r,a),void IW(c,t,n,i,r,a)}s=s.next}o=o.next}while(o!==e)}function OW(e,t){return e.x-t.x}function NW(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,a=-1/0,o=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>a){if(a=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}o=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!o)return null;if(i===a)return o.prev;var c,l=o,u=o.x,h=o.y,f=1/0;for(n=o.next;n!==l;)i>=n.x&&n.x>=u&&FW(r<h?i:a,r,u,h,r<h?a:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<f||c===f&&n.x>o.x)&&GW(n,e)&&(o=n,f=c),n=n.next;return o}(e,t)){var n=HW(t,e);bW(n,n.next)}}function MW(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function LW(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function FW(e,t,n,i,r,a,o,s){return(r-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(i-s)-(n-o)*(t-s)>=0&&(n-o)*(a-s)-(r-o)*(i-s)>=0}function BW(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&kW(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&GW(e,t)&&GW(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&r<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function zW(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function UW(e,t){return e.x===t.x&&e.y===t.y}function kW(e,t,n,i){return!!(UW(e,t)&&UW(n,i)||UW(e,i)&&UW(n,t))||zW(e,t,n)>0!=zW(e,t,i)>0&&zW(n,i,e)>0!=zW(n,i,t)>0}function GW(e,t){return zW(e.prev,e,e.next)<0?zW(e,t,e.next)>=0&&zW(e,e.prev,t)>=0:zW(e,t,e.prev)<0||zW(e,e.next,t)<0}function HW(e,t){var n=new CW(e.i,e.x,e.y),i=new CW(t.i,t.x,t.y),r=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,a.next=i,i.prev=a,i}function VW(e,t,n,i){var r=new CW(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function WW(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function jW(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,a=AW(e,0,r,n,!0),o=[];if(!a)return o;var s=0,c=0,l=0,u=0,h=0,f=0,_=0;if(i&&(a=function(e,t,n,i){var r,a=[],o=0,s=null;for(o=0,r=t.length;o<r;o++)(s=AW(e,t[o]*i,o<r-1?t[o+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),a.push(LW(s)));if(a.sort(OW),!n)return n;for(o=0;o<a.length;o++)NW(a[o],n),n=bW(n,n.next);return n}(e,t,a,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var d=n;d<r;d+=n)(h=e[d])<s&&(s=h),(f=e[d+1])<c&&(c=f),h>l&&(l=h),f>u&&(u=f);_=Math.max(l-s,u-c)}return IW(a,o,n,s,c,_),o}for(var XW=Math.PI,qW=Math.min,YW=Math.max,KW=Math.ceil,QW=Math.acos,JW=Math.cos,ZW=Math.sin,$W=Math.atan2,ej=null,tj=null,nj=new In,ij=[],rj=0;rj<4;rj++)ij.push(new Pn);function aj(e,t,n){return e<t?t:e>n?n:e}var oj={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!tj)return null;var n=tj.getRenderDataList(),i=n[tj.dataOffset];if(!i)return null;var r=i,a=r?r.vertexStart+t:0;return(a>65535||3*a>131070)&&(++tj.dataOffset,tj.dataOffset<n.length?i=n[tj.dataOffset]:(i=tj.requestRenderData(),n[tj.dataOffset]=i),r=i),r&&r.vertexCount<a&&r.request(t,3*t),i},stroke:function(e){In.copy(nj,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){In.copy(nj,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t,n,i,r,a=.5*e.lineWidth,o=e.lineCap,s=e.lineJoin,c=e.miterLimit;if(tj=e.impl){var l=(t=a,n=XW,i=tj.tessTol,r=2*QW(t/(t+i)),YW(2,KW(n/r)));this._calculateJoins(tj,a,s,c);for(var u=tj.paths,h=0,f=tj.pathOffset,_=tj.pathLength;f<_;f++){var d=u[f],p=d.points.length;s===$U.ROUND?h+=2*(p+d.bevel*(l+2)+1):h+=2*(p+5*d.bevel+1),d.closed||(o===ZU.ROUND?h+=2*(2*l+2):h+=12)}var m=ej=this.getRenderData(e,h);if(m){for(var v=m.vData,g=m.iData,y=tj.pathOffset,S=tj.pathLength;y<S;y++){var x=u[y],E=x.points,T=E.length,C=m.vertexStart,A=void 0,b=void 0,I=0,w=0,P=x.closed;if(P?(A=E[T-1],b=E[0],I=0,w=T):(A=E[0],b=E[1],I=1,w=T-1),b=b||A,!P){var R=new aG(b.x,b.y);R.subtract(A),R.normalize();var D=R.x,O=R.y;o===ZU.BUTT?this._buttCapStart(A,D,O,a,0):o===ZU.SQUARE?this._buttCapStart(A,D,O,a,a):o===ZU.ROUND&&this._roundCapStart(A,D,O,a,l)}for(var N=I;N<w;++N)s===$U.ROUND?this._roundJoin(A,b,a,a,l):0!=(b.flags&(ek.PT_BEVEL|ek.PT_INNERBEVEL))?this._bevelJoin(A,b,a,a):(this._vSet(b.x+b.dmx*a,b.y+b.dmy*a,1),this._vSet(b.x-b.dmx*a,b.y-b.dmy*a,-1)),A=b,b=E[N+1];if(P){var M=8*C;this._vSet(v[M],v[M+1],1),this._vSet(v[M+8],v[M+8+1],-1)}else{var L=new aG(b.x,b.y);L.subtract(A),L.normalize();var F=L.x,B=L.y;o===ZU.BUTT?this._buttCapEnd(b,F,B,a,0):o===ZU.SQUARE?this._buttCapEnd(b,F,B,a,a):o===ZU.ROUND&&this._roundCapEnd(b,F,B,a,l)}for(var z=m.indexStart,U=C+2,k=m.vertexStart;U<k;U++)g[z++]=U-2,g[z++]=U-1,g[z++]=U;m.indexStart=z}ej=null,tj=null}}},_expandFill:function(e){if(tj=e.impl){for(var t=tj.paths,n=0,i=tj.pathOffset,r=tj.pathLength;i<r;i++)n+=t[i].points.length;var a=ej=this.getRenderData(e,n);if(a){for(var o=a,s=o.vData,c=o.iData,l=tj.pathOffset,u=tj.pathLength;l<u;l++){var h=t[l],f=h.points,_=f.length;if(0!==_){for(var d=a.vertexStart,p=0;p<_;++p)this._vSet(f[p].x,f[p].y);var m=a.indexStart;if(h.complex){for(var v=[],g=d,y=a.vertexStart;g<y;g++){var S=8*g;v.push(s[S++]),v.push(s[S++]),v.push(s[S++])}var x=jW(v,null,3);if(!x||0===x.length)continue;for(var E=0,T=x.length;E<T;E++)c[m++]=x[E]+d}else for(var C=d,A=d+2,b=o.vertexStart;A<b;A++)c[m++]=C,c[m++]=A-1,c[m++]=A;o.indexStart=m}}ej=null,tj=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var a=e.paths,o=e.pathOffset,s=e.pathLength;o<s;o++){var c=a[o],l=c.points,u=l.length,h=l[u-1],f=l[0];c.bevel=0;for(var _=0;_<u;_++){var d,p,m=h.dy,v=-h.dx,g=f.dy,y=-f.dx;if(f.dmx=.5*(m+g),f.dmy=.5*(v+y),(d=f.dmx*f.dmx+f.dmy*f.dmy)>1e-6){var S=1/d;S>600&&(S=600),f.dmx*=S,f.dmy*=S}f.dx*h.dy-h.dx*f.dy>0&&(f.flags|=ek.PT_LEFT),d*(p=YW(11,qW(h.len,f.len)*r))*p<1&&(f.flags|=ek.PT_INNERBEVEL),f.flags&ek.PT_CORNER&&(d*i*i<1||n===$U.BEVEL||n===$U.ROUND)&&(f.flags|=ek.PT_BEVEL),0!=(f.flags&(ek.PT_BEVEL|ek.PT_INNERBEVEL))&&c.bevel++,h=f,f=l[_+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],a=r.points,o=a[a.length-1],s=a[0];a.length>2&&o.equals(s)&&(r.closed=!0,a.pop(),o=a[a.length-1]);for(var c=0,l=a.length;c<l;c++){var u=new aG(s.x,s.y);u.subtract(o),o.len=u.length(),(u.x||u.y)&&u.normalize(),o.dx=u.x,o.dy=u.y,o=s,s=a[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,a=n.y,o=0,s=0,c=0,l=0;return 0!==e?(o=r+t.dy*i,s=a-t.dx*i,c=r+n.dy*i,l=a-n.dx*i):(o=c=r+n.dmx*i,s=l=a+n.dmy*i),[o,s,c,l]},_buttCapStart:function(e,t,n,i,r){var a=e.x-t*r,o=e.y-n*r,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var a=e.x+t*r,o=e.y+n*r,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var a=e.x,o=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*XW,h=JW(u)*i,f=ZW(u)*i;this._vSet(a-s*h-t*f,o-c*h-n*f,1),this._vSet(a,o,0)}this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var a=e.x,o=e.y,s=n,c=-t;this._vSet(a+s*i,o+c*i,1),this._vSet(a-s*i,o-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*XW,h=JW(u)*i,f=ZW(u)*i;this._vSet(a,o,0),this._vSet(a-s*h+t*f,o-c*h+n*f,1)}},_roundJoin:function(e,t,n,i,r){var a=e.dy,o=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&ek.PT_LEFT)){var h=this._chooseBevel(t.flags&ek.PT_INNERBEVEL,e,t,n),f=h[0],_=h[1],d=h[2],p=h[3],m=$W(-o,-a),v=$W(-c,-s);v>m&&(v-=2*XW),this._vSet(f,_,1),this._vSet(l-a*i,t.y-o*i,-1);for(var g=aj(KW((m-v)/XW)*r,2,r),y=0;y<g;y++){var S=m+y/(g-1)*(v-m),x=l+JW(S)*i,E=u+ZW(S)*i;this._vSet(l,u,0),this._vSet(x,E,-1)}this._vSet(d,p,1),this._vSet(l-s*i,u-c*i,-1)}else{var T=this._chooseBevel(t.flags&ek.PT_INNERBEVEL,e,t,-i),C=T[0],A=T[1],b=T[2],I=T[3],w=$W(o,a),P=$W(c,s);P<w&&(P+=2*XW),this._vSet(l+a*i,u+o*i,1),this._vSet(C,A,-1);for(var R=aj(KW((P-w)/XW)*r,2,r),D=0;D<R;D++){var O=w+D/(R-1)*(P-w),N=l+JW(O)*n,M=u+ZW(O)*n;this._vSet(N,M,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(b,I,-1)}},_bevelJoin:function(e,t,n,i){var r=0,a=0,o=0,s=0,c=0,l=0,u=0,h=0,f=e.dy,_=-e.dx,d=t.dy,p=-t.dx;if(t.flags&ek.PT_LEFT){var m=this._chooseBevel(t.flags&ek.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-f*i,t.y-_*i,-1),this._vSet(u,h,1),this._vSet(t.x-d*i,t.y-p*i,-1)}else{var v=this._chooseBevel(t.flags&ek.PT_INNERBEVEL,e,t,-i);r=v[0],a=v[1],o=v[2],s=v[3],this._vSet(t.x+f*n,t.y+_*n,1),this._vSet(r,a,-1),this._vSet(t.x+d*n,t.y+p*n,1),this._vSet(o,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),ej){var i=ej,r=8*i.vertexStart,a=i.vData;a[r++]=e,a[r++]=t,a[r++]=0,In.toArray(a,nj,r),r+=4,a[r++]=n,i.vertexStart++}}},sj=e("graphicsAssembler",{getAssembler:function(){return oj}});hG.Assembler=sj;var cj=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},lj=new ii,uj=null,hj=null,fj=[],_j=[],dj=[],pj=[],mj=new ti,vj=new ti,gj=new Yn,yj=null,Sj=0,xj=0,Ej=0,Tj=0,Cj=0,Aj=1,bj=null,Ij="",wj=0,Pj=0,Rj=0,Dj=0,Oj=0,Nj=0,Mj=0,Lj=!1,Fj=0,Bj=0,zj=0,Uj={updateRenderData:function(e){e.renderData&&uj!==e&&(e.renderData.vertDirty&&(hj=(uj=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),uj.actualFontSize=wj,hj.setContentSize(vj),this.updateUVs(e),uj.renderData.vertDirty=!1,uj.markForUpdateRenderData(!1),uj=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.vertexCount,r=t.data,a=3,o=0;o<i;o++){var s=r[o];n[a]=s.u,n[a+1]=s.v,a+=9}},_updateFontScale:function(){Aj=wj/Pj},_updateFontFamily:function(e){var t=e.font;bj=t.spriteFrame,yj=t.fntConfig,RB.fontAtlas=t.fontDefDictionary,DF.packToDynamicAtlas(e,bj)},_updateLabelInfo:function(){RB.hash="",RB.margin=0},_updateProperties:function(e){Ij=e.string.toString(),wj=e.fontSize,Pj=yj?yj.fontSize:e.fontSize,Rj=e.horizontalAlign,Dj=e.verticalAlign,Oj=e.spacingX,Mj=e.overflow,Nj=e._lineHeight;var t=hj.contentSize;vj.width=t.width,vj.height=t.height,Mj===KU.NONE?(Lj=!1,vj.width+=2*RB.margin,vj.height+=2*RB.margin):Mj===KU.RESIZE_HEIGHT?(Lj=!0,vj.height+=2*RB.margin):Lj=e.enableWrapText,RB.lineHeight=Nj,RB.fontSize=wj,this._setupBMFontOverflowMetrics()},_resetProperties:function(){yj=null,bj=null,RB.hash="",RB.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=Ij,t=e.length,n=yj.kerningDict,i=fj,r=-1,a=0;a<t;++a){var o=e.charCodeAt(a),s=n[r<<16|65535&o]||0;i[a]=a<t-1?s:0,r=o}},_multilineTextWrap:function(e){for(var t=Ij.length,n=0,i=0,r=0,a=0,o=0,s=0,c=0,l=null,u=0;u<t;){var h=Ij.charAt(u);if("\n"!==h){for(var f=e(Ij,u,t),_=s,d=c,p=o,m=i,v=!1,g=0;g<f;++g){var y=u+g;if("\r"!==(h=Ij.charAt(y)))if(l=RB.fontAtlas.getLetterDefinitionForChar(h,RB)){var S=m+l.offsetX*Aj-RB.margin;if(Lj&&zj>0&&i>0&&S+l.w*Aj>zj&&!vB(h)){dj.push(o),o=0,n++,i=0,r-=Nj*this._getFontScale()+0,v=!0;break}gj.x=S,gj.y=r-l.offsetY*Aj,this._recordLetterInfo(gj,h,y,n),y+1<fj.length&&y<t-1&&(m+=fj[y+1]),m+=l.xAdvance*Aj+Oj,p=gj.x+l.w*Aj,_<gj.y&&(_=gj.y),d>gj.y-l.h*Aj&&(d=gj.y-l.h*Aj)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+yj.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<_&&(s=_),c>d&&(c=d),a<(o=p)&&(a=o),u+=f)}else dj.push(o),o=0,n++,i=0,r-=Nj*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return dj.push(o),xj=(Sj=n+1)*Nj*this._getFontScale(),Sj>1&&(xj+=0*(Sj-1)),vj.width=Fj,vj.height=Bj,Fj<=0&&(vj.width=parseFloat(a.toFixed(2))+2*RB.margin),Bj<=0&&(vj.height=parseFloat(xj.toFixed(2))+2*RB.margin),Tj=vj.height,Cj=0,s>0&&(Tj=vj.height+s),c<-xj&&(Cj=xj+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return Mj===KU.SHRINK?Aj:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(mB(i)||"\n"===i||vB(i))return 1;var r=1,a=RB.fontAtlas.getLetterDefinitionForChar(i,RB);if(!a)return r;for(var o=a.xAdvance*Aj+Oj,s=t+1;s<n&&(i=e.charAt(s),a=RB.fontAtlas.getLetterDefinitionForChar(i,RB));++s){if(o+a.offsetX*Aj+a.w*Aj>zj&&!vB(i)&&zj>0)return r;if(o+=a.xAdvance*Aj+Oj,"\n"===i||vB(i)||mB(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=_j.length){var n=new cj;_j.push(n)}_j[e].char=t,_j[e].hash=""+t.charCodeAt(0)+RB.hash,_j[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=_j.length){var r=new cj;_j.push(r)}var a=""+t.charCodeAt(0)+RB.hash;_j[n].line=i,_j[n].char=t,_j[n].hash=a,_j[n].valid=RB.fontAtlas.getLetter(a).valid,_j[n].x=e.x,_j[n].y=e.y},_alignText:function(){xj=0,dj.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),Mj===KU.SHRINK&&wj>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||Mj===KU.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),wj=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|wj,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;Aj=r/Pj,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return xj>vj.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=Ij.length;t<n;++t){var i=_j[t];if(i.valid){var r=RB.fontAtlas.getLetterDefinitionForChar(i.char,RB);if(!r)continue;var a=i.x+r.w*Aj,o=i.line;if(Fj>0)if(Lj){if(dj[o]>vj.width&&(a>vj.width||a<0)){e=!0;break}}else if(a>vj.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=dj[t],i=e>vj.width||e<0;return Lj?n>vj.width&&i:i},_updateQuads:function(){if(!uj)return!1;var e=bj?bj.texture:RB.fontAtlas.getTexture(),t=uj.renderData;t.dataLength=0,t.resize(0,0);for(var n=hj.anchorPoint,i=vj,r=n.x*i.width,a=n.y*i.height,o=!0,s=0,c=Ij.length;s<c;++s){var l=_j[s];if(l.valid){var u=RB.fontAtlas.getLetter(l.hash);if(u){lj.height=u.h,lj.width=u.w,lj.x=u.u,lj.y=u.v;var h=l.y+Ej;if(Bj>0){if(h>Tj){var f=h-Tj;lj.y+=f,lj.height-=f,h-=f}h-u.h*Aj<Cj&&Mj===KU.CLAMP&&(lj.height=h<Cj?0:(h-Cj)/Aj)}var _=l.line,d=l.x+u.w/2*Aj+pj[_];if(Fj>0&&this._isHorizontalClamped(d,_))if(Mj===KU.CLAMP)lj.width=0;else if(Mj===KU.SHRINK){if(vj.width>u.w){o=!1;break}lj.width=0}if(lj.height>0&&lj.width>0){var p=this._determineRect(),m=l.x+pj[l.line];this.appendQuad(uj,e,lj,p,m-r,h-a,Aj)}}else console.warn("Can't find letter in this bitmap-font")}}return o},appendQuad:function(){},_determineRect:function(){var e=bj.isRotated(),t=bj.getOriginalSize(),n=bj.getRect(),i=bj.getOffset(),r=i.x+(t.width-n.width)/2,a=i.y-(t.height-n.height)/2;if(e){var o=lj.x;lj.x=n.x+n.height-lj.y-lj.height-a,lj.y=o+n.y-r,lj.y<0&&(lj.height+=a)}else lj.x+=n.x-r,lj.y+=n.y+a;return e},_computeAlignmentOffset:function(){switch(pj.length=0,Rj){case qU.LEFT:for(var e=0;e<Sj;++e)pj.push(0);break;case qU.CENTER:for(var t=0,n=dj.length;t<n;t++)pj.push((vj.width-dj[t])/2);break;case qU.RIGHT:for(var i=0,r=dj.length;i<r;i++)pj.push(vj.width-dj[i])}if(Ej=vj.height,Dj!==YU.TOP){var a=vj.height-xj+Nj*this._getFontScale()-Pj*Aj;Dj===YU.BOTTOM?Ej-=a:Ej-=a/2}},_setupBMFontOverflowMetrics:function(){var e=vj.width,t=vj.height;Mj===KU.RESIZE_HEIGHT&&(t=0),Mj===KU.NONE&&(e=0,t=0),Fj=e,Bj=t,mj.width=e,mj.height=t,zj=e}},kj=new In(255,255,255,255),Gj={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;kj.set(e.color),kj.a=255*t._uiProps.opacity,TF(t,0,e.renderData,kj)},appendQuad:function(e,t,n,i,r,a,o){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=t.width,h=t.height,f=n.width,_=n.height,d=0,p=0,m=0,v=0;i?(d=n.x/u,v=(n.x+_)/u,p=(n.y+f)/h,m=n.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=p,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=p):(d=n.x/u,v=(n.x+f)/u,p=(n.y+_)/h,m=n.y/h,l[c].u=d,l[c].v=p,l[c+1].u=v,l[c+1].v=p,l[c+2].u=d,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=a-_*o,l[c+1].x=r+f*o,l[c+1].y=a-_*o,l[c+2].x=r,l[c+2].y=a,l[c+3].x=r+f*o,l[c+3].y=a}},updateColor:function(){}};Be(Gj,Uj);var Hj=null,Vj=ze(Uj,{getAssemblerData:function(){return Hj||(Hj=new PB(1024,1024)),Hj.getTexture()},_updateFontFamily:function(e){RB.fontAtlas=Hj,RB.fontFamily=this._getFontFamily(e);var t=e.getComponent(PH);t&&t.enabled?(RB.isOutlined=!0,RB.margin=t.width,RB.out=t.color.clone(),RB.out.a=t.color.a*e.color.a/255):(RB.isOutlined=!1,RB.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){RB.fontDesc=this._getFontDesc(),RB.color=e.color,RB.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(RB)},_getFontDesc:function(){return RB.fontSize.toString()+"px "+RB.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),Wj=new In(255,255,255,255),jj={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){if(e.renderData){var t=e.node;Wj.a=255*t._uiProps.opacity,TF(t,0,e.renderData,Wj)}},updateColor:function(){},appendQuad:Gj.appendQuad};Be(jj,Vj);var Xj=tk.Overflow,qj=(1/255).toFixed(3),Yj=null,Kj=null,Qj=null,Jj="",Zj="",$j=0,eX=0,tX=[],nX=new ti,iX=0,rX=0,aX=0,oX=new In,sX="",cX=Xj.NONE,lX=!1,uX=null,hX=In.BLACK.clone(),fX=null,_X=In.BLACK.clone(),dX=new ii,pX=ti.ZERO.clone(),mX=ti.ZERO.clone(),vX=Yn.ZERO.clone(),gX=Yn.ZERO.clone(),yX=0,SX=0,xX=!1,EX=!1,TX=!1,CX=["left","center","right"],AX={getAssemblerData:function(){return tk._canvasPool.get()},resetAssemblerData:function(e){e&&tk._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=$j,t.setContentSize(nX),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),Yj=null,Kj=null,Qj=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){sX=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(Yj=n.context,Kj=n.canvas,Qj=e.spriteFrame,Zj=e.string.toString(),$j=e.fontSize,eX=$j,cX=e.overflow,mX.width=nX.width=t.width,mX.height=nX.height=t.height,SX=e.underlineHeight,iX=e.lineHeight,rX=e.horizontalAlign,aX=e.verticalAlign,oX=e.color,e.node._uiProps.opacity,xX=e.isBold,EX=e.isItalic,TX=e.isUnderline,lX=cX!==Xj.NONE&&(cX===Xj.RESIZE_HEIGHT||e.enableWrapText),(uX=(uX=PH&&e.getComponent(PH))&&uX.enabled&&uX.width>0?uX:null)&&hX.set(uX.color),(fX=(fX=EW&&e.getComponent(EW))&&fX.enabled?fX:null)&&_X.set(fX.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(pX.width=pX.height=0,uX&&(e=t=n=i=r=uX.width,pX.width=pX.height=2*r),fX){var a=fX.blur+r,o=fX.offset.x,s=fX.offset.y;n=Math.max(n,-o+a),i=Math.max(i,o+a),e=Math.max(e,s+a),t=Math.max(t,-s+a)}if(EX){var c=eX*Math.tan(.20943951);i+=c,pX.width+=c}dX.x=n,dX.y=e,dX.width=n+i,dX.height=e+t},_calculateFillTextStartPosition:function(){var e=0;rX===qU.RIGHT?e=nX.width-dX.width:rX===qU.CENTER&&(e=(nX.width-dX.width)/2);var t=this._getLineHeight()*(tX.length-1),n=$j*(1-oB/2);if(aX!==YU.TOP){var i=t+dX.height+$j-nX.height;aX===YU.BOTTOM?n-=i+=oB/2*$j:n-=i/2}n+=0*$j,vX.set(e+dX.x,n+dX.y)},_updateTexture:function(e){if(Yj&&Kj){Yj.clearRect(0,0,Kj.width,Kj.height),Yj.font=Jj,this._calculateFillTextStartPosition();var t=this._getLineHeight();Yj.lineJoin="round",uX?(Yj.fillStyle="rgba("+hX.r+", "+hX.g+", "+hX.b+", "+qj+")",Yj.fillRect(0,0,Kj.width,Kj.height)):e._srcBlendFactor===Ri.SRC_ALPHA&&(Yj.fillStyle="rgba("+oX.r+", "+oX.g+", "+oX.b+", "+qj+")",Yj.fillRect(0,0,Kj.width,Kj.height)),Yj.fillStyle="rgb("+oX.r+", "+oX.g+", "+oX.b+")";var n=vX.x,i=0;this._drawTextEffect(vX,t);for(var r=0;r<tX.length;++r)i=vX.y+r*t,uX&&Yj.strokeText(tX[r],n,i),Yj.fillText(tX[r],n,i);fX&&(Yj.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===tk.CacheMode.BITMAP){var t=e.ttfSpriteFrame;DF.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;Qj&&Kj&&(n=Qj instanceof BF?Qj.texture:Qj,0!==Kj.width&&0!==Kj.height&&(n.reset({width:Kj.width,height:Kj.height,mipmapLevel:1}),n.uploadData(Kj),n.setWrapMode(Sm.CLAMP_TO_EDGE,Sm.CLAMP_TO_EDGE),Qj instanceof BF&&(Qj.rect=new ii(0,0,Kj.width,Kj.height),Qj._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),l.director.root&&l.director.root.batcher2D&&l.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==tk.CacheMode.BITMAP||!Kj||Kj.width<=0||Kj.height<=0)){var t=e.ttfSpriteFrame;DF.packToDynamicAtlas(e,t)}},_setupOutline:function(){Yj.strokeStyle="rgba("+hX.r+", "+hX.g+", "+hX.b+", "+hX.a/255+")",Yj.lineWidth=2*uX.width},_setupShadow:function(){Yj.shadowColor="rgba("+_X.r+", "+_X.g+", "+_X.b+", "+_X.a/255+")",Yj.shadowBlur=fX.blur,Yj.shadowOffsetX=fX.offset.x,Yj.shadowOffsetY=-fX.offset.y},_drawTextEffect:function(e,t){if(fX||uX||TX){var n=tX.length>1&&fX,i=this._measureText(Yj,Jj),r=0,a=0;fX&&this._setupShadow(),uX&&this._setupOutline();for(var o=0;o<tX.length;++o)r=e.x,a=e.y+o*t,n&&(uX&&Yj.strokeText(tX[o],r,a),Yj.fillText(tX[o],r,a)),TX&&(yX=i(tX[o]),rX===qU.RIGHT?gX.x=e.x-yX:rX===qU.CENTER?gX.x=e.x-yX/2:gX.x=e.x,gX.y=a+eX/8,Yj.fillRect(gX.x,gX.y,yX,SX));n&&(Yj.shadowColor="transparent")}},_updateLabelDimensions:function(){nX.width=Math.min(nX.width,2048),nX.height=Math.min(nX.height,2048);var e=!1;Kj.width!==nX.width&&(Kj.width=nX.width,e=!0),Kj.height!==nX.height&&(Kj.height=nX.height,e=!0),e&&(Yj.font=Jj),Yj.textAlign=CX[rX],Yj.textBaseline="alphabetic"},_getFontDesc:function(){var e=$j.toString()+"px ";return e+=sX,xX&&(e="bold "+e),EX&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===iX?$j:iX*$j/eX)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=oe(e);!(n=r()).done;){var a=gB(t,n.value,Jj);i.push(a)}return i},_measureText:function(e,t){return function(n){return gB(e,n,t)}},_calculateShrinkFont:function(e){if(Yj){var t=this._calculateParagraphLength(e,Yj),n=0,i=0,r=0;if(lX){var a=mX.width,o=mX.height;if(a<0||o<0)return;i=o+1;for(var s=0,c=0|$j+1,l=0;s<c;){if((l=s+c+1>>1)<=0){w(4003);break}$j=l,Jj=this._getFontDesc(),Yj.font=Jj;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=gB(Yj,e[n],Jj);i+=EB(e[n],h,a,this._measureText(Yj,Jj)).length*u}i>o?c=l-1:s=l}0===s?w(4003):($j=s,Jj=this._getFontDesc(),Yj.font=Jj)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var f=(nX.width-dX.width)/r,_=nX.height/i;$j=eX*Math.min(1,f,_)|0,Jj=this._getFontDesc(),Yj.font=Jj}}},_calculateWrapText:function(e){if(lX&&Yj){tX=[];for(var t=mX.width,n=0;n<e.length;++n){var i=gB(Yj,e[n],Jj),r=EB(e[n],i,t,this._measureText(Yj,Jj));tX=tX.concat(r)}}},_calculateLabelFont:function(){if(Yj){var e=Zj.split("\n");switch(tX=e,Jj=this._getFontDesc(),Yj.font=Jj,cX){case Xj.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=gB(Yj,e[i],Jj);t=t>r?t:r}n=(tX.length+oB)*this._getLineHeight();var a=parseFloat(t.toFixed(2)),o=parseFloat(n.toFixed(2));nX.width=a+dX.width,nX.height=o+dX.height,mX.width=a+pX.width,mX.height=o+pX.height;break;case Xj.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case Xj.CLAMP:this._calculateWrapText(e);break;case Xj.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(tX.length+oB)*this._getLineHeight();nX.height=s+dX.height,mX.height=s+pX.height}}}},bX=In.WHITE.clone(),IX={createData:function(e){var t=e.requestRenderData();t.dataLength=2,t.resize(4,6);var n=t.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)In.toArray(n,bX,i),i+=9;return t},fillBuffers:function(e){var t=e.renderData.chunk,n=e.renderData.data,i=e.node,r=t.vb,a=n[0],o=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=a.x*l.x,h=o.x*l.x,f=a.y*l.y,_=o.y*l.y,d=c.x,p=c.y,m=c.z,v=c.w,g=d*p,y=m*v,S=d*d-p*p,x=v*v-m*m,E=x+S,T=2*(g-y),C=x-S,A=2*(g+y),b=s.x,I=s.y;r[0]=E*u+T*f+b,r[1]=C*f+A*u+I,r[9]=E*h+T*f+b,r[10]=C*f+A*h+I,r[18]=E*u+T*_+b,r[19]=C*_+A*u+I,r[27]=E*h+T*_+b,r[28]=C*_+A*h+I;var w=t.bufferId,P=t.vertexOffset,R=t.vertexAccessor.getMeshBuffer(t.bufferId),D=t.vertexAccessor.getIndexBuffer(w),O=R.indexOffset;D[O++]=P,D[O++]=P+1,D[O++]=P+2,D[O++]=P+2,D[O++]=P+1,D[O++]=P+3,R.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,a=n.anchorX*i,o=n.anchorY*r,s=t.data;s[0].x=-a,s[0].y=-o,s[1].x=i-a,s[1].y=r-o}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var n=t.chunk.vb,i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Be(IX,AX);var wX=e("labelAssembler",{getAssembler:function(e){var t=IX;return e.font instanceof rB?t=Gj:e.cacheMode===tk.CacheMode.CHAR&&(t=jj),t}});tk.Assembler=wX;var PX=DH.FillType,RX=new Wn,DX=new Pn,OX={updateRenderData:function(e){var t=e.spriteFrame;DF.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.updateRenderData(e,t),!n.vertDirty)return;var i=e.fillStart,r=e.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var a=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);a=a>1?1:a,this.updateUVs(e,i,a),this.updateVertexData(e,i,a)}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData.chunk.vb,a=i.width,o=i.height,s=i.rect,c=0,l=0,u=0,h=0,f=0,_=0,d=0,p=0,m=0,v=0;switch(i.isRotated()?(c=s.x/a,l=(s.y+s.width)/o,u=f=c,d=m=(s.x+s.height)/a,_=v=l,h=p=s.y/o):(c=s.x/a,l=(s.y+s.height)/o,u=d=c,f=m=(s.x+s.width)/a,h=_=l,p=v=s.y/o),e.fillType){case PX.HORIZONTAL:r[3]=u+(f-u)*t,r[4]=h+(_-h)*t,r[12]=u+(f-u)*n,r[13]=h+(_-h)*n,r[21]=d+(m-d)*t,r[22]=p+(v-p)*t,r[30]=d+(m-d)*n,r[31]=p+(v-p)*n;break;case PX.VERTICAL:r[3]=u+(d-u)*t,r[4]=h+(p-h)*t,r[12]=f+(m-f)*t,r[13]=_+(v-_)*t,r[21]=u+(d-u)*n,r[22]=h+(p-h)*n,r[30]=f+(m-f)*n,r[31]=_+(v-_)*n;break;default:O(2626)}},updateVertexData:function(e,t,n){var i=e.renderData.data,r=e.node._uiProps.uiTransformComp,a=r.width,o=r.height,s=r.anchorX*a,c=r.anchorY*o,l=-s,u=-c,h=a-s,f=o-c,_=0;switch(e.fillType){case PX.HORIZONTAL:_=l+(h-l)*n,l+=(h-l)*t,h=_;break;case PX.VERTICAL:_=u+(f-u)*n,u+=(f-u)*t,f=_;break;default:O(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=f,i[3].x=h,i[3].y=f},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);for(var n,i=oe(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(RX);for(var n=e.renderData.floatStride,i=e.renderData.data,r=t.vb,a=0,o=0;o<4;o++){var s=i[o];Pn.transformMat4(DX,s,RX),r[a=o*n]=DX.x,r[a+1]=DX.y,r[a+2]=DX.z}},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(n.bufferId),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset;o[s++]=r,o[s++]=r+1,o[s++]=r+2,o[s++]=r+2,o[s++]=r+1,o[s++]=r+3,a.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,a=e.color,o=a.r/255,s=a.g/255,c=a.b/255,l=e.node._uiProps.opacity,u=0;u<4;u++)n[r]=o,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},NX=2*Math.PI,MX=1e-6,LX=new Wn,FX=new Pn,BX=[new Yn,new Yn,new Yn,new Yn],zX=new Array(4),UX=new Array(8),kX=[new Yn,new Yn,new Yn,new Yn],GX=[new Yn,new Yn,new Yn,new Yn],HX=new Yn,VX=[new Yn,new Yn,new Yn,new Yn];function WX(e,t,n,i,r,a,o){var s=Math.sin(a);s=Math.abs(s)>MX?s:0;var c=Math.cos(a),l=0,u=0;if(0!==(c=Math.abs(c)>MX?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);o[0].x=e,o[0].y=h}if((t-r.x)*c>0){var f=r.y+l*(t-r.x);o[2].x=t,o[2].y=f}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var _=r.x+u*(i-r.y);o[3].x=_,o[3].y=i}if((n-r.y)*s>0){var d=r.x+u*(n-r.y);o[1].x=d,o[1].y=n}}}function jX(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function XX(e,t,n,i,r){var a=zX,o=a[0],s=a[1],c=a[2],l=a[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,qX((n.x-o)/(c-o),(n.y-s)/(l-s),e,t),qX((i.x-o)/(c-o),(i.y-s)/(l-s),e,t+1),qX((r.x-o)/(c-o),(r.y-s)/(l-s),e,t+2)}function qX(e,t,n,i){var r=UX,a=r[0]+(r[2]-r[0])*e,o=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=a+(o-a)*t,l.v=s+(c-s)*t}for(var YX={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;DF.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;if(n&&t){if(!n.vertDirty)return;var i=n.data,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);r>=1;)r-=1;for(;r<0;)r+=1;var o=(r*=NX)+(a*=NX);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,a=t.anchorY*i,o=-r,s=-a,c=n-r,l=i-a,u=zX;u[0]=o,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,f=HX.x=Math.min(Math.max(0,h.x),1)*(c-o)+o,_=HX.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;BX[0].x=BX[3].x=o,BX[1].x=BX[2].x=c,BX[0].y=BX[1].y=s,BX[2].y=BX[3].y=l;for(var d,p=oe(VX);!(d=p()).done;){var m=d.value;Yn.set(m,0,0)}f!==u[0]&&Yn.set(VX[0],3,0),f!==u[2]&&Yn.set(VX[2],1,2),_!==u[1]&&Yn.set(VX[1],0,1),_!==u[3]&&Yn.set(VX[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,a=0,o=0,s=0,c=UX;e.isRotated()?(r=i.x/t,a=(i.x+i.height)/t,o=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=a,c[3]=c[7]=s,c[1]=c[5]=o):(r=i.x/t,a=(i.x+i.width)/t,o=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=a,c[1]=c[3]=s,c[5]=c[7]=o)}(t),WX(zX[0],zX[2],zX[1],zX[3],HX,r,kX),WX(zX[0],zX[2],zX[1],zX[3],HX,r+a,GX);for(var s=0,c=0;c<4;++c){var l=VX[c];if(l)if(a>=NX)n.dataLength=s+3,XX(i,s,HX,BX[l.x],BX[l.y]),s+=3;else{var u=jX(HX,BX[l.x]),h=jX(HX,BX[l.y]);h<u&&(h+=NX),u-=NX,h-=NX;for(var f=0;f<3;++f)u>=o||(u>=r?(n.dataLength=s+3,XX(i,s,HX,BX[l.x],h>=o?GX[c]:BX[l.y]),s+=3):h>r&&(h<=o?(n.dataLength=s+3,XX(i,s,HX,kX[c],BX[l.y]),s+=3):(n.dataLength=s+3,XX(i,s,HX,kX[c],GX[c]),s+=3))),u+=NX,h+=NX}}n.resize(s,s),n.updateRenderData(e,t)}},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,a=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=o.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=a+l;o.indexOffset+=n.indexCount,o.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(LX);for(var n=e.renderData,i=n.floatStride,r=e.renderData.data,a=t.vb,o=n.vertexCount,s=0,c=0;c<o;c++){var l=r[c];Pn.set(FX,l.x,l.y,0),Pn.transformMat4(FX,FX,LX),a[s+0]=FX.x,a[s+1]=FX.y,a[s+2]=FX.z,a[s+3]=l.u,a[s+4]=l.v,s+=i}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,a=5,o=e.color,s=o.r/255,c=o.g/255,l=o.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[a]=s,n[a+1]=c,n[a+2]=l,n[a+3]=u,a+=i},updateColor:function(){}},KX=[],QX=0;QX<4;QX++)KX.push(new Pn);for(var JX={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){var t=e.spriteFrame;DF.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData,i=t.vb,r=n.data,a=e.node,o=r[0],s=r[1],c=a.worldMatrix,l=c.m00,u=c.m01,h=c.m04,f=c.m05,_=1===l&&0===u&&0===h&&1===f,d=c.m12,p=c.m13,m=o.x,v=s.x,g=o.y,y=s.y;if(_){var S=m+d,x=v+d,E=g+p,T=y+p;i[0]=S,i[1]=E,i[9]=x,i[10]=E,i[18]=S,i[19]=T,i[27]=x,i[28]=T}else{var C=l*m,A=l*v,b=u*m,I=u*v,w=h*g+d,P=h*y+d,R=f*g+p,D=f*y+p;i[0]=C+w,i[1]=b+R,i[9]=A+w,i[10]=I+R,i[18]=C+P,i[19]=b+D,i[27]=A+P,i[28]=I+D}},fillBuffers:function(e){if(null!==e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(i),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset;o[s++]=r,o[s++]=r+1,o[s++]=r+2,o[s++]=r+2,o[s++]=r+1,o[s++]=r+3,a.indexOffset+=6}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,a=n.height,o=n.anchorX*r,s=n.anchorY*a,c=0,l=0,u=0,h=0;if(e.trim)c=-o,l=-s,u=r-o,h=a-s;else{var f=e.spriteFrame,_=f.getOriginalSize(),d=f.getRect(),p=_.width,m=_.height,v=d.width,g=d.height,y=f.getOffset(),S=r/p,x=a/m,E=y.x+(p-v)/2,T=y.x-(p-v)/2;c=E*S-o,l=(y.y+(m-g)/2)*x-s,u=r+T*S-o,h=a+(y.y-(m-g)/2)*x-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,n=e.spriteFrame.uv;t[3]=n[0],t[4]=n[1],t[12]=n[2],t[13]=n[3],t[21]=n[4],t[22]=n[5],t[30]=n[6],t[31]=n[7]}},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=5,r=e.color,a=r.r/255,o=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=t.floatStride)n[i]=a,n[i+1]=o,n[i+2]=s,n[i+3]=c}},ZX=new Pn,$X=new Wn,eq={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,54),t},updateRenderData:function(e){var t=e.spriteFrame;DF.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,a=n.anchorX*i,o=n.anchorY*r,s=e.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,f=i-c-l,_=r-u-h,d=i/(c+l),p=r/(u+h);d=Number.isNaN(d)||d>1?1:d,p=Number.isNaN(p)||p>1?1:p,f=f<0?0:f,_=_<0?0:_,t[0].x=-a,t[0].y=-o,t[1].x=c*d-a,t[1].y=h*p-o,t[2].x=t[1].x+f,t[2].y=t[1].y+_,t[3].x=i-a,t[3].y=r-o},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(n.bufferId),o=n.vertexAccessor.getIndexBuffer(i),s=a.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;o[s++]=u,o[s++]=u+1,o[s++]=u+4,o[s++]=u+1,o[s++]=u+5,o[s++]=u+4}a.indexOffset=s},updateWorldVertexData:function(e,t){e.node.getWorldMatrix($X);for(var n=e.renderData,i=n.floatStride,r=n.data,a=t.vb,o=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];Pn.set(ZX,u.x,c.y,0),Pn.transformMat4(ZX,ZX,$X),o=(4*s+l)*i,a[o++]=ZX.x,a[o++]=ZX.y,a[o++]=ZX.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=e.spriteFrame.uvSliced,a=3,o=0;o<16;o++)n[a]=r[o].u,n[a+1]=r[o].v,a+=i},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,a=e.color,o=a.r/255,s=a.g/255,c=a.b/255,l=e.node._uiProps.opacity,u=0;u<16;u++)n[r]=o,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},tq=[],nq=0;nq<4;nq++)tq.push(new Pn);var iq=new Wn,rq={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),a=Math.abs(i.height),o=n.getRect(),s=n.insetLeft,c=n.insetRight,l=o.width-s-c,u=n.insetTop,h=n.insetBottom,f=o.height-u-h,_=r-s-c,d=a-u-h;_=_>0?_:0,d=d>0?d:0;var p=0===l?_:_/l,m=0===f?d:d/f,v=Math.ceil(m+2),g=Math.ceil(p+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,_,d,v,g),t.resize(v*g*4,v*g*6)}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,a=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=o.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=a,s[c++]=a+1,s[c++]=a+2,s[c++]=a+1,s[c++]=a+3,s[c++]=a+2,a+=4,o.indexOffset+=6;o.setDirty()},updateWorldVertexAndUVData:function(e,t){var n=e.node;n.getWorldMatrix(iq);var i=e.renderData,r=i.floatStride,a=i.data,o=t.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=e.spriteFrame,h=u.rotated,f=u.uv,_=u.uvSliced,d=u.rect,p=u.insetLeft,m=u.insetRight,v=d.width-p-m,g=u.insetTop,y=u.insetBottom,S=d.height-g-y,x=c-p-m,E=l-g-y;x=x>0?x:0,E=E>0?E:0;for(var T=0===v?x:x/v,C=0===S?E:E/S,A=Math.ceil(C+2),b=Math.ceil(T+2),I=0,w=0,P=0,R=0,D=0,O=0,N=A;O<N;++O){R=a[O].y,D=a[O+1].y;for(var M=0,L=b;M<L;++M){w=a[M].x,P=a[M+1].x,Pn.set(tq[0],w,R,0),Pn.set(tq[1],P,R,0),Pn.set(tq[2],w,D,0),Pn.set(tq[3],P,D,0);for(var F=0;F<4;F++){var B=tq[F];Pn.transformMat4(B,B,iq);var z=F*r;o[I+z]=B.x,o[I+z+1]=B.y,o[I+z+2]=B.z}I+=4*r}}I=0;for(var U=r,k=2*r,G=3*r,H=4*r,V=0,W=0,j=[],X=[],q=0,Y=A;q<Y;++q){W=E>S?E>=q*S?1:C%1:C;for(var K=0,Q=b;K<Q;++K){V=x>v?x>=K*v?1:T%1:T;var J=I+3,Z=J+1;h?(0===q?(j[0]=_[0].u,j[1]=_[0].u,j[2]=_[4].u+(_[8].u-_[4].u)*W):q<A-1?(j[0]=_[4].u,j[1]=_[4].u,j[2]=_[4].u+(_[8].u-_[4].u)*W):q===A-1&&(j[0]=_[8].u,j[1]=_[8].u,j[2]=_[12].u),0===K?(X[0]=_[0].v,X[1]=_[1].v+(_[2].v-_[1].v)*V,X[2]=_[0].v):K<b-1?(X[0]=_[1].v,X[1]=_[1].v+(_[2].v-_[1].v)*V,X[2]=_[1].v):K===b-1&&(X[0]=_[2].v,X[1]=_[3].v,X[2]=_[2].v),j[3]=j[2],X[3]=X[1]):(0===K?(j[0]=_[0].u,j[1]=_[1].u+(_[2].u-_[1].u)*V,j[2]=f[0]):K<b-1?(j[0]=_[1].u,j[1]=_[1].u+(_[2].u-_[1].u)*V,j[2]=_[1].u):K===b-1&&(j[0]=_[2].u,j[1]=_[3].u,j[2]=_[2].u),0===q?(X[0]=_[0].v,X[1]=_[0].v,X[2]=_[4].v+(_[8].v-_[4].v)*W):q<A-1?(X[0]=_[4].v,X[1]=_[4].v,X[2]=_[4].v+(_[8].v-_[4].v)*W):q===A-1&&(X[0]=_[8].v,X[1]=_[8].v,X[2]=_[12].v),j[3]=j[1],X[3]=X[2]),o[J]=j[0],o[Z]=X[0],o[J+U]=j[1],o[Z+U]=X[1],o[J+k]=j[2],o[Z+k]=X[2],o[J+G]=j[3],o[Z+G]=X[3],I+=H}}},updateVerts:function(e,t,n,i,r){var a,o,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.rect,h=Math.abs(s.width),f=Math.abs(s.height),_=s.anchorX*h,d=s.anchorY*f,p=l.insetLeft,m=l.insetRight,v=u.width-p-m,g=l.insetTop,y=l.insetBottom,S=u.height-g-y,x=s.width/(p+m)>1?1:s.width/(p+m),E=s.height/(g+y)>1?1:s.height/(g+y);a=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,o=S>0?Math.floor(1e3*n)/1e3%S==0?S:n%S:n;for(var T=0;T<=r;T++)0===T?c[T].x=-_:T>0&&T<r?c[T].x=1===T?p*x+Math.min(v,t)-_:v>0?T===r-1?p+a+v*(T-2)-_:p+Math.min(v,t)+v*(T-2)-_:p+t-_:T===r&&(c[T].x=Math.min(p+t+m,h)-_);for(var C=0;C<=i;C++)0===C?c[C].y=-d:C>0&&C<i?c[C].y=1===C?y*E+Math.min(S,n)-d:S>0?C===i-1?y+o+(C-2)*S-d:y+Math.min(S,n)+(C-2)*S-d:y+n-d:C===i&&(c[C].y=Math.min(y+n+g,f)-d)},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,a=5,o=e.color,s=o.r/255,c=o.g/255,l=o.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[a]=s,n[a+1]=c,n[a+2]=l,n[a+3]=u,a+=i},updateColor:function(){}},aq=DH.Type,oq=DH.FillType,sq=e("spriteAssembler",{getAssembler:function(e){var t=JX,n=e;switch(n.type){case aq.SLICED:t=eq;break;case aq.TILED:t=rq;break;case aq.FILLED:t=n.fillType===oq.RADIAL?YX:OX}return t}});DH.Assembler=sq;var cq=Mz.sharedManager,lq={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){e.type===fG.IMAGE_STENCIL&&(JX.updateRenderData(e),JX.updateColor(e))},fillBuffers:function(e,t){(e.type!==fG.IMAGE_STENCIL||e.spriteFrame)&&(cq.pushMask(e),t.finishMergeBatches(),function(e,t){cq.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(cq.enterLevel(e),e.type===fG.IMAGE_STENCIL){JX.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),cq.enableMask())}},uq={fillBuffers:function(){cq.exitMask()}},hq={getAssembler:function(){return lq}},fq={getAssembler:function(){return uq}};vG.Assembler=hq,vG.PostAssembler=fq;var _q=e("MeshBuffer",function(){function e(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var t=e.prototype;return t.initialize=function(e,t,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=t,this._floatsPerVertex=LB(t),this._initVDataCount,this._floatsPerVertex,F(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},t.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},t.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0},t.setDirty=function(){this._dirty=!0},t.request=function(){return R(9002),!1},t.requireFreeIA=function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia},t.recycleIA=function(e){for(var t=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===t[n].ia){var i=t[n];return t[n]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=i)}},t.checkCapacity=function(e,t){var n=(this.vertexOffset+e)*this._floatsPerVertex,i=this.indexOffset+t;return!(n>this._initVDataCount||i>this._initIDataCount)},t.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var e=ah.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,n=this.indexOffset,i=0;i<e;++i){var r=this._iaPool[i],a=new Float32Array(this.vData.buffer,0,t>>2),o=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(a),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(o)}this._dirty=!1}},t.createNewIA=function(e){var t,n,i;if(ah.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,a=Uint16Array.BYTES_PER_ELEMENT,o=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,r,r));i=e.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,a,a)),n=[o],this._iaInfo=new Mr(this._attributes,n,i),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:n,indexBuffer:i}},Q(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),e}()),dq=[ER.EventType.MOUSE_DOWN,ER.EventType.MOUSE_MOVE,ER.EventType.MOUSE_UP,ER.EventType.MOUSE_WHEEL],pq=[ER.EventType.TOUCH_START,ER.EventType.TOUCH_MOVE,ER.EventType.TOUCH_END,ER.EventType.TOUCH_CANCEL],mq=(new(function(){function e(){this.priority=fR.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],TR._registerEventDispatcher(this),UP.callbacksInvoker.on(tI.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),UP.callbacksInvoker.on(tI.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),UP.callbacksInvoker.on(tI.MARK_LIST_DIRTY,this._markListDirty,this)}var t=e.prototype;return t.dispatchEvent=function(e){var t=e.type;return pq.includes(t)?this.dispatchEventTouch(e):!dq.includes(t)||this.dispatchEventMouse(e)},t.addPointerEventProcessor=function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),nt.array.remove(this._processorListToRemove,e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(nt.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),nt.array.remove(this._processorListToAdd,e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var a=t[r];if(a.isEnabled&&a.shouldHandleEventMouse&&a._handleEventMouse(e)){if(i=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,a=0;a<n;++a){var o=t[a];if(o.isEnabled&&o.shouldHandleEventTouch)if(e.type===$b.TOUCH_START){if(o._handleEventTouch(e)){if(o.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(o.claimedTouchIdList.length>0){var s=o.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(o._handleEventTouch(e),e.type!==$b.TOUCH_END&&e.type!==$b.TOUCH_CANCEL||nt.array.removeAt(o.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,a=0;a<r;++a)this.removePointerEventProcessor(i[a]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node;if(r._uiProps){var a=r._uiProps.uiTransformComp;i.cachedCameraPriority=a.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,a=i,o=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=a.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,f;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(o=!0)&&i:r&&r.parent,a=null===(null===(h=a)||void 0===h||null===(f=h.parent)||void 0===f?void 0:f.parent)?(o=!0)&&n:a&&a.parent}if(r._id===a._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var _=r?r.getSiblingIndex():0,d=a?a.getSiblingIndex():0;return o?_-d:d-_},t._markListDirty=function(){this._isListDirty=!0},e}()),function(){function e(e,t){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=e,this._attributes=t,this._floatsPerVertex=LB(t),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var t=e.prototype;return t.initialize=function(){},t.reset=function(){},t.request=function(){},t.appendBuffers=function(){},t.uploadBuffers=function(){},t.destroy=function(){this._attributes.length=0},Q(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),e}()),vq=new Vl((function(){return{offset:0,length:0}}),32),gq=function(e,t,n,i){this.vertexAccessor=e,this.bufferId=t,this.vertexOffset=n,this.vb=i},yq=function(e){function t(n,i,r,a){var o;return(o=e.call(this,n,i)||this)._freeLists=[],o._vCount=0,o._iCount=0,o._vCount=r||Math.floor(1024*lt.BATCHER2D_MEM_INCREMENT/o._vertexFormatBytes),o._iCount=a||o._vCount*t.IB_SCALE,o._allocateBuffer(),o}Z(t,e);var n=t.prototype;return n.destroy=function(){for(var t=0;t<this._buffers.length;++t){this._buffers[t].destroy();for(var n=this._freeLists[t],i=0;i<n.length;++i)vq.free(n[i])}this._buffers.length=0,this._freeLists.length=0,e.prototype.destroy.call(this)},n.reset=function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}},n.getVertexBuffer=function(e){return this._buffers[e].vData},n.getIndexBuffer=function(e){return this._buffers[e].iData},n.getMeshBuffer=function(e){return this._buffers[e]},n.uploadBuffers=function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],n=this._buffers[e];(!t||t.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(e,t){var n=this._buffers[e];t.length&&(n.iData.set(t,n.indexOffset),n.indexOffset+=t.length)},n.allocateChunk=function(e,t){for(var n,i=e*this.vertexFormatBytes,r=null,a=0,o=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],a=c,o=l;break}if(s)break}if(s||(a=this._allocateBuffer(),(r=this._buffers[a])&&r.checkCapacity(e,t)&&(o=0,s=this._freeLists[a][o])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(a,o,s,i),new gq(this,a,u,h,t)}return O(9004,i),null},n.recycleChunk=function(e){var t=this._freeLists[e.bufferId],n=this._buffers[e.bufferId],i=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var a=!1,o=0,s=null,c=t[o];c&&c.offset<i;)s=c,c=t[++o];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,t.splice(o,1),vq.free(c),c=null),a=!0),!a&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=vq.alloc();l.offset=i,l.length=r,t.splice(o,0,l)}a=!0}if(a)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=vq.alloc();u.offset=i,u.length=r,t.push(u)}}},n._allocateChunkFromEntry=function(e,t,n,i){var r=n.length-i,a=n.offset+i,o=this._buffers[e];o.byteOffset<a&&(o.byteOffset=a),L(r>=0,9004,e,n.offset,n.length),0===r?(this._freeLists[e].splice(t,1),vq.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){L(this._buffers.length===this._freeLists.length,9003);var e=new _q,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var n=vq.alloc();n.offset=0,n.length=e.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},t}(mq);yq.IB_SCALE=4;var Sq=new jr(null),xq=new Wn,Eq=e("UI",function(){function e(e){var t=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new Qv,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new Cq,this._meshDataArray=[],this._root=e,this.device=e.device,this._batches=new jl(64),this._drawBatchPool=new Vl((function(){return new SW}),128,(function(e){return e.destroy(t)}))}var t=e.prototype;return t.initialize=function(){return!0},t.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(e){e.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),Mz.sharedManager.destroy()},t.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},t.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},t.sortScreens=function(){this._screens.sort(this._screenSort)},t.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},t.update=function(){for(var e=this._screens,t=0,n=0;n<e.length;++n){var i=e[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var a=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var o=this._batches.array[t];if(o.model)for(var s=o.model.subModels,c=0;c<s.length;c++)s[c].priority=a++;else o.descriptorSet=this._descriptorSetCache.getDescriptorSet(o);r.addBatch(o)}}}},t.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(e){e.uploadBuffers()})),this._bufferAccessors.forEach((function(e){e.uploadBuffers(),e.reset()})),this._descriptorSetCache.update())},t.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach((function(e){e.reset()})),this._meshDataArray.forEach((function(e){e.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),Mz.sharedManager.reset()},t.switchBufferAccessor=function(e){void 0===e&&(e=NB);var t=e===NB?36:FB(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var n=this._bufferAccessors.get(t);n||(n=new yq(this.device,e),this._bufferAccessors.set(t,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},t.registerBufferAccessor=function(e,t){this._bufferAccessors.set(e,t)},t.updateBuffer=function(e,t){var n=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=n.getMeshBuffer(t).indexOffset)},t.commitComp=function(e,t,n,i,r){var a,o=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;o=t.dataHash,a=t.material,s=t.chunk.bufferId}e.stencilStage=Mz.sharedManager.stage;var c=e.stencilStage;this._currHash===o&&0!==o&&this._currMaterial===a&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(e,this)},t.commitIA=function(e,t,n,i,r){var a,o;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;e&&(a=-1===e.blendHash?null:e.getBlendState(),c=e.blendHash,e.stencilStage=Mz.sharedManager.stage,o=null!==e.customMaterial?Mz.sharedManager.getStencilStage(e.stencilStage,i):Mz.sharedManager.getStencilStage(e.stencilStage),s=Mz.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=e.node.layer,l.inputAssembler=t,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,o,s,a,c,null,this),this._batches.push(l)},t.commitModel=function(e,t,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(e.stencilStage!==JB.ENABLED&&e.stencilStage!==JB.DISABLED||(e.stencilStage=Mz.sharedManager.stage),i=Mz.sharedManager.getStencilStage(e.stencilStage,n),r=Mz.sharedManager.getStencilHash(e.stencilStage));var a=l.director.getTotalFrames();t&&(t.updateTransform(a),t.updateUBOs(a));for(var o=0;o<t.subModels.length;o++){var s=this._drawBatchPool.alloc(),c=t.subModels[o];s.visFlags=e.node.layer,s.model=t,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}},t.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},t.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},t.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},t.autoMergeBatches=function(e){var t=this._currMaterial;if(t){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var a=this._currBID,o=r.getMeshBuffer(a);if(!o)return;var s=o.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,o.indexOffset,o.setDirty(),(n=o.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=o.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;e&&(c=-1===e.blendHash?null:e.getBlendState(),h=e.blendHash,l=null!==e.customMaterial?Mz.sharedManager.getStencilStage(e.stencilStage,t):Mz.sharedManager.getStencilStage(e.stencilStage),u=Mz.sharedManager.getStencilHash(e.stencilStage));var f=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();f.visFlags=this._currLayer,f.texture=this._currTexture,f.sampler=this._currSampler,f.inputAssembler=n,f.useLocalData=this._currTransform,f.textureHash=this._currTextureHash,f.samplerHash=this._currSamplerHash,f.fillPasses(t,l,u,c,h,null,this),this._batches.push(f)}}},t.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},t.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},t.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},t.flushMaterial=function(e){this._currMaterial=e},t.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var n=e.children,i=e._uiProps,r=i.uiComp,a=this._pOpacity,o=a,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=o*=s*i.localOpacity,i._opacity=o,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&!r.useVertexOpacity&&r.renderData&&r.renderData.vertexCount>0){!function(e,t){for(var n,i,r,a=e.vertexFormat,o=e.chunk.vb,s=0,c=0;c<a.length;++c){if(n=a[c],(i=na[n.format]).hasAlpha)if(r=e.floatStride,i.size/i.count==1)for(var l=~~cn(Math.round(255*t),0,255),u=s;u<o.length;u+=r)o[u]=(4294967040&o[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<o.length;h+=r)o[h]=t;s+=i.size>>2}}(r.renderData,o);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!e._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,t)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=a,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),t+=1}},t._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},t._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},Q(e,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),e}()),Tq=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=l.director.root.device;this._localData=new Float32Array(ep.COUNT),this._localBuffer=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,ep.SIZE,ep.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=l.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,Sq.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(Sq),this._descriptorSet.bindBuffer(ep.BINDING,this._localBuffer);var n=Dd.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.isValid=function(){return this._transform&&this._transform.isValid},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;Wn.toArray(this._localData,t,ep.MAT_WORLD_OFFSET),Wn.inverseTranspose(xq,t);var n=Wn.determinant(xq),i=1/Math.sqrt(n);Wn.multiplyScalar(xq,xq,i),Wn.toArray(this._localData,xq,ep.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},Q(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),Cq=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Vl((function(){return new Tq}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=l.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,r=0,a=i.length;r<a;r++){var o=i[r];if(o.equals(e.useLocalData,e.textureHash,e.samplerHash))return o.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(e),this._localDescriptorSetCache.push(s),s.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);Sq.layout=e.passes[0].localSetLayout;var c=n.device.createDescriptorSet(Sq),u=Dd.SAMPLER_SPRITE;return c.bindTexture(u,e.texture),c.bindSampler(u,e.sampler),c.update(),this._descriptorSetCache.set(t,c),this._dsCacheHashByTexture.set(e.textureHash,t),c},t.update=function(){var e=this._localDescriptorSetCache,t=[];e.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=e.indexOf(n);t.push(i)}}));for(var n=t.length-1;n>=0;n--)e.splice(t[n],1)},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();l.internal.Batcher2D=Eq,G(_q.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(e){return{name:e,suggest:"please use meshBuffer.accessor."+e+" instead"}}))),U(_q.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),k(_q.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),U(Eq.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),k(iz.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),U(iz.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),e("QuadRenderData",function(e){function t(t){var n;return n=e.call(this,t)||this,R(9006),n}return Z(t,e),t}(iz));var Aq,bq,Iq=null,wq=-1,Pq="BES bswy:->@123",Rq=Object.create(null),Dq=[],Oq=3e3;function Nq(){for(var e=!0,t=Date.now(),n=Dq.length-1;n>=0;n--){var i=Dq[n],r=i.fontFamilyName;if(t-i.startTime>Oq)R(4933,r),i.onComplete(null,r),Dq.splice(n,1);else{var a=i.refWidth,o="40px "+r;Iq.font=o,a!==gB(Iq,Pq,o)?(Dq.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(wq),wq=-1)}function Mq(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(Rq[i])n(null,i);else{if(!Iq){var r=document.createElement("canvas");r.width=100,r.height=100,Iq=r.getContext("2d")}var a=gB(Iq,Pq,"40px "+i),o=document.createElement("style");o.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',o.textContent=s+"}",document.body.appendChild(o);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===Aq)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);Aq=e?parseInt(e[1],10)>42:!t}else Aq=!1;return Aq}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=Oq?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,a=new Promise((function(e,t){r=setTimeout(t,Oq)}));Promise.race([a,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){R(4933,t),n(null,t)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:a,onComplete:n,startTime:Date.now()};Dq.push(u),-1===wq&&(wq=setInterval(Nq,100))}Rq[i]=o}}function Lq(e,t,n,i){var r=new eB;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}XN.register({".font":Mq,".eot":Mq,".ttf":Mq,".woff":Mq,".svg":Mq,".ttc":Mq}),$N.register({".font":Lq,".eot":Lq,".ttf":Lq,".woff":Lq,".svg":Lq,".ttc":Lq}),l.UI={MeshBuffer:_q,spriteAssembler:sq,graphicsAssembler:sj,labelAssembler:wX,RenderData:nz,MeshRenderData:iz},function(e){e[e.positions=$i.ATTR_POSITION]="positions",e[e.normals=$i.ATTR_NORMAL]="normals",e[e.uvs=$i.ATTR_TEX_COORD]="uvs",e[e.colors=$i.ATTR_COLOR]="colors"}(bq||(bq={}));var Fq,Bq,zq,Uq,kq,Gq=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer},e}(),Hq=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>up.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new Wq(this._mesh,i,this._mesh.struct.morph,t):this._subMeshRenderings[i]=new Vq(this._mesh,i,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,a;n[i]=null!==(r=null===(a=this._subMeshRenderings[i])||void 0===a?void 0:a.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var a=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes($i.ATTR_POSITION)&&a.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes($i.ATTR_NORMAL)&&a.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes($i.ATTR_TANGENT)&&a.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),a.push.apply(a,r.requiredPatches()),a},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=oe(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}},e}(),Vq=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[t];this._subMeshMorph=r,Yq(e,t,i);var a=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=a;var o=r.targets.length,s=qq(i,a*o);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(t,n){var i=s.create(),o=i.valueView;return r.targets.forEach((function(t,i){for(var r=t.displacements[n],s=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),c=a*i*4,l=0;l<a;++l)o[c+4*l+0]=s[3*l+0],o[c+4*l+1]=s[3*l+1],o[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:t,morphTexture:i}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=oe(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new Xq(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=oe(e._attributes);!(i=r()).done;){var a=i.value,o=void 0;switch(a.name){case $i.ATTR_POSITION:o=pp;break;case $i.ATTR_NORMAL:o=gp;break;case $i.ATTR_TANGENT:o=xp;break;default:S("Unexpected attribute!")}void 0!==o&&(n.bindSampler(o,a.morphTexture.sampler),n.bindTexture(o,a.morphTexture.texture))}n.bindBuffer(up.BINDING,t.buffer),n.update()},destroy:function(){}}},e}(),Wq=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[t];Yq(e,t,i),this._attributes=r.attributes.map((function(t,n){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[n].offset,t.displacements[n].count)}}))}}))}return e.prototype.createInstance=function(){return new jq(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},Q(e,[{key:"data",get:function(){return this._attributes}}]),e}(),jq=function(){function e(e,t,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new Xq(n,0);var i=qq(n,t);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=i.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var a=0;a<r.targets.length;++a){var o=r.targets[a].displacements,s=e[a],c=o.length/3;if(0===a)for(var l=0;l<c;++l)i[4*l+0]=o[3*l+0]*s,i[4*l+1]=o[3*l+1]*s,i[4*l+2]=o[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=o[3*u+0]*s,i[4*u+1]+=o[3*u+1]*s,i[4*u+2]+=o[3*u+2]*s}n.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,n=oe(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case $i.ATTR_POSITION:r=pp;break;case $i.ATTR_NORMAL:r=gp;break;case $i.ATTR_TANGENT:r=xp;break;default:S("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(up.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}(),Xq=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(up.SIZE)),this._remoteBuffer=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,up.SIZE,up.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(up.OFFSET_OF_WEIGHTS+4*t,e[t],l.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(up.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,l.sys.isLittleEndian),this._localBuffer.setFloat32(up.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,l.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(up.OFFSET_OF_VERTICES_COUNT,e,l.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},Q(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function qq(e,t){var i,r,o,s;e.getFormatFeatures(_i.RGBA32F)&Ti.SAMPLED_TEXTURE?(i=t,o=16,r=hv.PixelFormat.RGBA32F,s=Float32Array):(i=4*t,o=4,r=hv.PixelFormat.RGBA8888,s=Uint8Array);var c=function(e){e<5&&(e=5);var t=n(a(e)),i=t>>1;return{width:1<<(1&t?i+1:i),height:1<<i}}(i),l=c.width,u=c.height;return{width:l,height:u,create:function(){var t=new ArrayBuffer(l*u*o),n=new Float32Array(t),i=s===Float32Array?n:new s(t),a=new Hm({width:l,height:u,_data:i,_compressed:!1,format:r}),c=new hv;c.setFilters(hv.Filter.NEAREST,hv.Filter.NEAREST),c.setMipFilter(hv.Filter.NONE),c.setWrapMode(hv.WrapMode.CLAMP_TO_EDGE,hv.WrapMode.CLAMP_TO_EDGE,hv.WrapMode.CLAMP_TO_EDGE),c.image=a,c.getGFXTexture()||S("Unexpected: failed to create morph texture?");var h=e.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(i)}}}}}function Yq(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function Kq(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var Qq=new Pn,Jq=new Pn,Zq=new Uint8Array,$q=e("Mesh",Tc("cc.Mesh")((kq=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,se(t,"_struct",zq,re(t)),se(t,"_hash",Uq,re(t)),t._data=Zq,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t}Z(t,e);var n=t.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=l.director.root.device,n=this._createVertexBuffers(t,e),i=[],r=0;r<this._struct.primitives.length;r++){var a=this._struct.primitives[r];if(0!==a.vertexBundelIndices.length){var o=null,s=null;if(a.indexView){var c=a.indexView,u=c.stride,h=c.length;if(4===u&&!t.hasFeature(fi.ELEMENT_INDEX_UINT)){var f=this._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(f>=65536){R(10001,f,65536);continue}u>>=1,h>>=1}o=t.createBuffer(new pr(mi.INDEX,yi.DEVICE,h,u)),s=new(Kq(c.stride))(e,c.offset,c.count),c.stride!==u&&(s=Kq(u).from(s)),o.update(s)}var _=a.vertexBundelIndices.map((function(e){return n[e]})),d=[];if(a.vertexBundelIndices.length>0)for(var p=a.vertexBundelIndices[0],m=this._struct.vertexBundles[p].attributes,v=0;v<m.length;++v){var g=m[v];d[v]=new Or(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new eI(_,d,a.primitiveMode,o);y.mesh=this,y.subMeshIdx=r,i.push(y)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(e,t){return new Hq(e,t)}(this,t))}},n.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(e,t){this.reset({struct:e,data:t})},n.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},n.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new Ys(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var a=this._struct.primitives,o=0;o<a.length;o++){var s=this.readAttribute(o,$i.ATTR_JOINTS),c=this.readAttribute(o,$i.ATTR_WEIGHTS),l=this.readAttribute(o,$i.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){Pn.set(Qq,l[3*h+0],l[3*h+1],l[3*h+2]);for(var f=0;f<4;++f){var _=4*h+f,d=s[_];if(!(0===c[_]||d>=i.length)){Pn.transformMat4(Jq,Qq,i[d]),n[d]=!0;var p=t[d];Pn.min(p.center,p.center,Jq),Pn.max(p.halfExtents,p.halfExtents,Jq)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?Ys.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t},n.merge=function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new Pn,r=t&&new Fn,a=t&&new Ys;if(r&&t.getRotation(r),!this._initialized){var o=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){o.maxPosition&&o.minPosition&&(Pn.add(a.center,o.maxPosition,o.minPosition),Pn.multiplyScalar(a.center,a.center,.5),Pn.subtract(a.halfExtents,o.maxPosition,o.minPosition),Pn.multiplyScalar(a.halfExtents,a.halfExtents,.5),Ys.transform(a,a,t),Pn.add(o.maxPosition,a.center,a.halfExtents),Pn.subtract(o.minPosition,a.center,a.halfExtents));for(var c=0;c<o.vertexBundles.length;c++)for(var l=o.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===$i.ATTR_POSITION||l.attributes[u].name===$i.ATTR_NORMAL){var h=l.attributes[u].format,f=new DataView(s.buffer,l.view.offset+eY(l.attributes,u)),_=iY(f,h),d=rY(f,h);if(!_||!d)continue;for(var p=l.view.count,m=l.view.stride,v=nY(h),g=0;g<p;g++){var y=g*m,S=y+v,x=S+v;switch(i.set(_(y),_(S),_(x)),l.attributes[u].name){case $i.ATTR_POSITION:i.transformMat4(t);break;case $i.ATTR_NORMAL:Pn.transformQuat(i,i,r)}d(y,i.x),d(S,i.y),d(x,i.z)}}}return this.reset({struct:o,data:s}),this.initialize(),!0}for(var E,T,C,A,b,I=new Gq,w=0,P=0,R=0,D=0,O=0,N=0,M=0,L=0,F=!1,B=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var U=this._struct.vertexBundles[z],k=e._struct.vertexBundles[z];R=U.view.offset,D=k.view.offset,P=U.view.stride,w=U.view.count+k.view.count,E=new ArrayBuffer(w*P),T=new Uint8Array(E),R+=(C=this._data.subarray(R,R+U.view.length)).length,D+=(A=e._data.subarray(D,D+k.view.length)).length,T.set(C),O=0;for(var G,H=oe(U.attributes);!(G=H()).done;){var V=G.value;M=0,F=!1;for(var W,j=oe(k.attributes);!(W=j()).done;){var X=W.value;if(V.name===X.name&&V.format===X.format){F=!0;break}M+=na[X.format].size}if(F){L=na[V.format].size,N=U.view.length+O;for(var q=0;q<k.view.count;++q){if(b=A.subarray(M,M+L),T.set(b,N),(V.name===$i.ATTR_POSITION||V.name===$i.ATTR_NORMAL)&&t){var Y=new Float32Array(T.buffer,N,3);switch(i.set(Y[0],Y[1],Y[2]),V.name){case $i.ATTR_POSITION:i.transformMat4(t);break;case $i.ATTR_NORMAL:Pn.transformQuat(i,i,r)}Y[0]=i.x,Y[1]=i.y,Y[2]=i.z}N+=U.view.stride,M+=k.view.stride}}O+=na[V.format].size}B[z]={attributes:U.attributes,view:{offset:I.getLength(),length:E.byteLength,count:w,stride:P}},I.addBuffer(E)}for(var K,Q,J,Z=0,$=2,ee=0,te=new Array(this._struct.primitives.length),ne=0;ne<this._struct.primitives.length;++ne){var ie=this._struct.primitives[ne],re=e._struct.primitives[ne];te[ne]={primitiveMode:ie.primitiveMode,vertexBundelIndices:ie.vertexBundelIndices};for(var ae,se=oe(ie.vertexBundelIndices);!(ae=se()).done;){var ce=ae.value;ee=Math.max(ee,this._struct.vertexBundles[ce].view.count)}if(ie.indexView&&re.indexView){Z=ie.indexView.count,Z+=re.indexView.count,R=ie.indexView.offset,D=re.indexView.offset,$=Z<256?1:Z<65536?2:4;var le=new ArrayBuffer(Z*$);if(K=2===$?new Uint16Array(le):1===$?new Uint8Array(le):new Uint32Array(le),Q=2===ie.indexView.stride?new Uint16Array(this._data.buffer,R,ie.indexView.count):1===ie.indexView.stride?new Uint8Array(this._data.buffer,R,ie.indexView.count):new Uint32Array(this._data.buffer,R,ie.indexView.count),$===ie.indexView.stride)K.set(Q);else for(var ue=0;ue<ie.indexView.count;++ue)K[ue]=Q[ue];R+=ie.indexView.length,J=2===re.indexView.stride?new Uint16Array(e._data.buffer,D,re.indexView.count):1===re.indexView.stride?new Uint8Array(e._data.buffer,D,re.indexView.count):new Uint32Array(e._data.buffer,D,re.indexView.count);for(var he=0;he<re.indexView.count;++he)K[ie.indexView.count+he]=ee+J[he];D+=re.indexView.length,te[ne].indexView={offset:I.getLength(),length:le.byteLength,count:Z,stride:$},I.setNextAlignment($),I.addBuffer(le)}}var fe={vertexBundles:B,primitives:te,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return fe.minPosition&&e._struct.minPosition&&fe.maxPosition&&e._struct.maxPosition&&(t?(Pn.add(a.center,e._struct.maxPosition,e._struct.minPosition),Pn.multiplyScalar(a.center,a.center,.5),Pn.subtract(a.halfExtents,e._struct.maxPosition,e._struct.minPosition),Pn.multiplyScalar(a.halfExtents,a.halfExtents,.5),Ys.transform(a,a,t),Pn.add(i,a.center,a.halfExtents),Pn.max(fe.maxPosition,fe.maxPosition,i),Pn.subtract(i,a.center,a.halfExtents),Pn.min(fe.minPosition,fe.minPosition,i)):(Pn.min(fe.minPosition,fe.minPosition,e._struct.minPosition),Pn.max(fe.maxPosition,fe.maxPosition,e._struct.maxPosition))),this.reset({struct:fe,data:new Uint8Array(I.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var o=this._struct.primitives[a],s=e._struct.primitives[a];if(o.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<o.vertexBundelIndices.length;++c)if(o.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(o.primitiveMode!==s.primitiveMode)return!1;if(o.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,a=e.attributes[t].format,o=ha(na[a]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+eY(e.attributes,t)),c=na[a],l=iY(s,a);if(o&&l){for(var u=c.count,h=new o(r*u),f=e.view.stride,_=0;_<r;++_)for(var d=0;d<u;++d)h[u*_+d]=l(f*_+h.BYTES_PER_ELEMENT*d);i=h}}})),i},n.copyAttribute=function(e,t,n,i,r){var a=this,o=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(a._data.buffer,e.view.offset+eY(e.attributes,t)),u=new DataView(n,r),h=na[c],f=iY(l,c),_=rY(u,c);if(f&&_){for(var d=h.count,p=e.view.stride,m=nY(c),v=i,g=m,y=0;y<s;++y)for(var S=0;S<d;++S)_(v*y+g*S,f(p*y+m*S));o=!0}}else o=!0})),o},n.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},n.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?_i.R8UI:2===n.indexView.stride?_i.R16UI:_i.R32UI,a=iY(new DataView(this._data.buffer),r),o=0;o<i;++o)t[o]=a(n.indexView.offset+na[r].size*o);return!0},n._accessAttribute=function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=oe(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var a=i.value,o=this._struct.vertexBundles[a],s=o.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(o,s);break}}},n._createVertexBuffers=function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new pr(mi.VERTEX,yi.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.reset({struct:{vertexBundles:[],primitives:[]},data:Zq})},Q(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=Sa(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(wu),zq=ce((Bq=kq).prototype,"_struct",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),Uq=ce(Bq.prototype,"_hash",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fq=Bq))||Fq);function eY(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=na[r.format].size}return n}l.Mesh=$q;var tY=ah.isLittleEndian;function nY(e){var t=na[e];return t.size/t.count}function iY(e,t){var n=na[t],i=n.size/n.count;switch(n.type){case di.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,tY)};case 4:return function(t){return e.getUint32(t,tY)}}break;case di.SNORM:case di.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,tY)};case 4:return function(t){return e.getInt32(t,tY)}}break;case di.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,tY)};case 4:return function(t){return e.getUint32(t,tY)}}break;case di.FLOAT:return function(t){return e.getFloat32(t,tY)}}return null}function rY(e,t){var n=na[t],i=n.size/n.count;switch(n.type){case di.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,tY)};case 4:return function(t,n){return e.setUint32(t,n,tY)}}break;case di.SNORM:case di.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,tY)};case 4:return function(t,n){return e.setInt32(t,n,tY)}}break;case di.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,tY)};case 4:return function(t,n){return e.setUint32(t,n,tY)}}break;case di.FLOAT:return function(t,n){return e.setFloat32(t,n,tY)}}return null}var aY=[new Or($i.ATTR_POSITION,_i.RGB32F),new Or($i.ATTR_NORMAL,_i.RGB32F),new Or($i.ATTR_TEX_COORD,_i.RG32F),new Or($i.ATTR_TANGENT,_i.RGBA32F),new Or($i.ATTR_COLOR,_i.RGBA32F)],oY=new Pn;function sY(e,t,n){n=n||{};var i,r=[],a=0,o=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=oe(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===$i.ATTR_POSITION){i=h;break}}i||(i=aY[0]),r.push(i);var f=na[i.format];s=Math.max(s,Math.floor(c.length/f.count)),o.push({offset:a,data:c,attribute:i}),a+=f.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var _,d=oe(e.attributes);!(_=d()).done;){var p=_.value;if(p.name===$i.ATTR_NORMAL){i=p;break}}i||(i=aY[1]);var m=na[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),o.push({offset:a,data:e.normals,attribute:i}),a+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,g=oe(e.attributes);!(v=g()).done;){var y=v.value;if(y.name===$i.ATTR_TEX_COORD){i=y;break}}i||(i=aY[2]);var S=na[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/S.count)),o.push({offset:a,data:e.uvs,attribute:i}),a+=S.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var x,E=oe(e.attributes);!(x=E()).done;){var T=x.value;if(T.name===$i.ATTR_TANGENT){i=T;break}}i||(i=aY[3]);var C=na[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/C.count)),o.push({offset:a,data:e.tangents,attribute:i}),a+=C.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var A,b=oe(e.attributes);!(A=b()).done;){var I=A.value;if(I.name===$i.ATTR_COLOR){i=I;break}}i||(i=aY[4]);var w=na[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/w.count)),o.push({offset:a,data:e.colors,attribute:i}),a+=w.size}if(e.customAttributes)for(var P,R=oe(e.customAttributes);!(P=R()).done;){var D=P.value,O=na[D.attr.format];r.push(D.attr),s=Math.max(s,Math.floor(D.values.length/O.count)),o.push({offset:a,data:D.values,attribute:D.attr}),a+=O.size}for(var N=new Gq,M=new ArrayBuffer(s*a),L=new DataView(M),F=0,B=o;F<B.length;F++){var z=B[F];Kb(L,z.data,z.attribute.format,z.offset,a)}N.setNextAlignment(0);var U={attributes:r,view:{offset:N.getLength(),length:M.byteLength,count:s,stride:a}};N.addBuffer(M);var k=null,G=0;if(e.indices){var H=e.indices;G=H.length,k=new ArrayBuffer(2*G),Kb(new DataView(k),H,_i.R16UI)}var V={primitiveMode:e.primitiveMode||Ui.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(N.setNextAlignment(2),V.indexView={offset:N.getLength(),length:k.byteLength,count:G,stride:2},N.addBuffer(k));var W=e.minPos;if(!W&&n.calculateBounds){W=Pn.set(new Pn,1/0,1/0,1/0);for(var j=0;j<s;++j)Pn.set(oY,c[3*j+0],c[3*j+1],c[3*j+2]),Pn.min(W,W,oY)}var X=e.maxPos;if(!X&&n.calculateBounds){X=Pn.set(new Pn,-1/0,-1/0,-1/0);for(var q=0;q<s;++q)Pn.set(oY,c[3*q+0],c[3*q+1],c[3*q+2]),Pn.max(X,X,oY)}var Y={vertexBundles:[U],primitives:[V]};return W&&(Y.minPosition=new Pn(W.x,W.y,W.z)),X&&(Y.maxPosition=new Pn(X.x,X.y,X.z)),t||(t=new $q),t.reset({struct:Y,data:new Uint8Array(N.getCombined())}),t}var cY=Object.freeze({__proto__:null,find:LR,toPPM:function(e,t,n){return"P3 "+t+" "+n+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:function(e,t){void 0===t&&(t=0);for(var n,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),a=e.struct,o=a.primitives[t],s=oe(o.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=a.vertexBundles[l],h=u.view.offset,f=u.view,_=f.length,d=f.stride,p=oe(u.attributes);!(c=p()).done;){var m=c.value,v=bq[m.name];v&&(i[v]=(i[v]||[]).concat(Qb(r,m.format,h,_,d))),h+=na[m.format].size}var g=o.indexView;return i.indices=Qb(r,_i["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:sY,readBuffer:Qb,writeBuffer:Kb,mapBuffer:Jb});e("utils",cY);var lY,uY,hY,fY,_Y,dY,pY,mY,vY,gY,yY,SY,xY,EY,TY,CY,AY,bY,IY,wY,PY,RY,DY,OY,NY,MY,LY,FY,BY,zY,UY,kY,GY,HY,VY,WY,jY,XY,qY,YY,KY,QY,JY,ZY,$Y,eK,tK,nK,iK,rK,aK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}Z(t,e);var n=t.prototype;return n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);if(this._morphRenderingInstance){var i=this._morphRenderingInstance.requiredPatches(t);if(i)return i.concat(null!=n?n:[])}return n},n.initSubModel=function(t,n,i){return e.prototype.initSubModel.call(this,t,n,this._launderMaterial(i))},n.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(t,n){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(n))},n.setMorphRendering=function(e){this._morphRenderingInstance=e},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,n)},n._launderMaterial=function(e){return e},t}(iy),oK=rt({OFF:0,ON:1}),sK=rt({OFF:0,ON:1}),cK=(lY=Tc("cc.ModelLightmapSettings"),uY=Oc("_recieveShadow"),lY((yY=function(){function e(){se(this,"texture",_Y,this),se(this,"uvParam",dY,this),se(this,"_bakeable",pY,this),se(this,"_castShadow",mY,this),se(this,"_receiveShadow",vY,this),se(this,"_lightmapSize",gY,this)}return Q(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),_Y=ce((fY=yY).prototype,"texture",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dY=ce(fY.prototype,"uvParam",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn}}),pY=ce(fY.prototype,"_bakeable",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mY=ce(fY.prototype,"_castShadow",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vY=ce(fY.prototype,"_receiveShadow",[uY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gY=ce(fY.prototype,"_lightmapSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),ce(fY.prototype,"bakeable",[Hc],Object.getOwnPropertyDescriptor(fY.prototype,"bakeable"),fY.prototype),ce(fY.prototype,"castShadow",[Hc],Object.getOwnPropertyDescriptor(fY.prototype,"castShadow"),fY.prototype),ce(fY.prototype,"receiveShadow",[Hc],Object.getOwnPropertyDescriptor(fY.prototype,"receiveShadow"),fY.prototype),ce(fY.prototype,"lightmapSize",[Hc],Object.getOwnPropertyDescriptor(fY.prototype,"lightmapSize"),fY.prototype),hY=fY))||hY),lK=function(t){return e({MeshRenderer:t,ModelComponent:t}),t}((SY=Tc("cc.MeshRenderer"),xY=Gc(),EY=Ac(100),TY=Bc(),CY=al(Ot),AY=Xc(),bY=Ic({group:{name:"DynamicShadowSettings",displayOrder:0}}),IY=al(Ot),wY=Xc(),PY=Ic({group:{name:"DynamicShadowSettings",displayOrder:1}}),RY=al(oK),DY=Xc(),OY=Ic({group:{name:"DynamicShadowSettings",displayOrder:2}}),NY=al(sK),MY=Xc(),LY=Ic({group:{name:"DynamicShadowSettings",displayOrder:3}}),FY=al($q),BY=Xc(),zY=Vc(),SY(UY=xY(UY=EY(UY=TY(UY=Fc((KY=YY=function(e){function t(){var t;return se(t=e.call(this)||this,"lightmapSettings",GY,re(t)),se(t,"_mesh",HY,re(t)),se(t,"_shadowCastingMode",VY,re(t)),se(t,"_shadowReceivingMode",WY,re(t)),se(t,"_shadowBias",jY,re(t)),se(t,"_shadowNormalBias",XY,re(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,se(t,"_enableMorph",qY,re(t)),t._modelType=iy,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},n.onRestore=function(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._onUpdateLocalShadowBias(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(l.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]},n.setWeights=function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},n.setWeight=function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}},n.setInstancedAttribute=function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,a=0;a<i.length;a++)if(i[a].name===e){r[a].set(t);break}},n._updateLightmap=function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._mesh&&this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===iy?aK:this._modelType,t=this._model=l.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof aK&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=my.POSITION,this._model.transform.hasChangedFlags|=my.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onUpdateLocalShadowBias=function(){null!==this.model&&this.model.updateLocalShadowBias(),this.setInstancedAttribute("a_localShadowBias",[this._shadowBias,this._shadowNormalBias])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return Sv.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateShadowBias=function(){this._model&&(this._model.shadowBias=this._shadowBias)},n._updateShadowNormalBias=function(){this._model&&(this._model.shadowNormalBias=this._shadowNormalBias)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===oK.OFF?this._model.castShadow=!1:(this._shadowCastingMode,oK.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===sK.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof aK&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,a=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===a}))},n._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},Q(t,[{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._updateShadowBias(),this._onUpdateLocalShadowBias()}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._updateShadowNormalBias(),this._onUpdateLocalShadowBias()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),t}(SF),YY.ShadowCastingMode=oK,YY.ShadowReceivingMode=sK,GY=ce((kY=KY).prototype,"lightmapSettings",[Dc,Hc,el],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new cK}}),HY=ce(kY.prototype,"_mesh",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VY=ce(kY.prototype,"_shadowCastingMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oK.OFF}}),WY=ce(kY.prototype,"_shadowReceivingMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sK.ON}}),jY=ce(kY.prototype,"_shadowBias",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XY=ce(kY.prototype,"_shadowNormalBias",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ce(kY.prototype,"shadowBias",[CY,AY,bY,el],Object.getOwnPropertyDescriptor(kY.prototype,"shadowBias"),kY.prototype),ce(kY.prototype,"shadowNormalBias",[IY,wY,PY,el],Object.getOwnPropertyDescriptor(kY.prototype,"shadowNormalBias"),kY.prototype),ce(kY.prototype,"shadowCastingMode",[RY,DY,OY,el],Object.getOwnPropertyDescriptor(kY.prototype,"shadowCastingMode"),kY.prototype),ce(kY.prototype,"receiveShadow",[NY,MY,LY,el],Object.getOwnPropertyDescriptor(kY.prototype,"receiveShadow"),kY.prototype),ce(kY.prototype,"mesh",[FY,BY],Object.getOwnPropertyDescriptor(kY.prototype,"mesh"),kY.prototype),ce(kY.prototype,"enableMorph",[zY,el],Object.getOwnPropertyDescriptor(kY.prototype,"enableMorph"),kY.prototype),qY=ce(kY.prototype,"_enableMorph",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UY=kY))||UY)||UY)||UY)||UY)||UY));function uK(e,t){var n=e.sharedMaterials.length;if(n!==t.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(e.getRenderMaterial(i)!==t.getRenderMaterial(i))return!1;return!0}e("BatchingUtility",function(){function e(){}return e.batchStaticModel=function(e,t){var n=e.getComponentsInChildren(lK);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!uK(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new $q,a=new Wn,o=new Wn;e.getWorldMatrix(o),Wn.invert(o,o);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(a),Wn.multiply(a,o,a),r.merge(n[s].mesh,a),c.enabled=!1}var l=t.addComponent(lK);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var n=e.getComponentsInChildren(lK),i=0;i<n.length;i++)n[i].enabled=!0;var r=t.getComponent(lK);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}()),U($q.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),k($q.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var hK,fK,_K,dK,pK,mK,vK,gK,yK,SK,xK,EK,TK,CK,AK,bK,IK,wK,PK,RK,DK,OK,NK=e("Skeleton",(QY=Tc("cc.Skeleton"),JY=al([Mt]),ZY=al([Wn]),QY((rK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_joints",tK,re(t)),se(t,"_bindposes",nK,re(t)),se(t,"_hash",iK,re(t)),t._invBindposes=null,t}Z(t,e);var n=t.prototype;return n.destroy=function(){var t,n;return null===(t=null===(n=l.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===t||t.releaseSkeleton(this),e.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},Q(t,[{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new Wn;Wn.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=Sa(e,666)}return this._hash}}]),t}(wu),tK=ce((eK=rK).prototype,"_joints",[JY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nK=ce(eK.prototype,"_bindposes",[ZY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iK=ce(eK.prototype,"_hash",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$Y=eK))||$Y));l.Skeleton=NK,k(lK.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),l.ModelComponent=lK,nt.setClassAlias(lK,"cc.ModelComponent");var MK,LK,FK,BK,zK,UK,kK,GK,HK,VK,WK,jK,XK,qK,YK,KK,QK,JK,ZK,$K,eQ,tQ,nQ,iQ,rQ,aQ,oQ,sQ,cQ,lQ,uQ,hQ,fQ,_Q,dQ,pQ,mQ,vQ,gQ,yQ,SQ,xQ,EQ,TQ,CQ,AQ,bQ,IQ,wQ,PQ,RQ,DQ,OQ,NQ,MQ,LQ,FQ,BQ,zQ,UQ,kQ,GQ,HQ,VQ,WQ,jQ,XQ,qQ,YQ,KQ,QQ,JQ,ZQ,$Q,eJ,tJ,nJ,iJ,rJ,aJ,oJ,sJ,cJ,lJ,uJ,hJ,fJ,_J,dJ,pJ,mJ,vJ,gJ,yJ,SJ,xJ,EJ,TJ,CJ,AJ,bJ,IJ,wJ,PJ,RJ,DJ,OJ,NJ,MJ,LJ,FJ,BJ,zJ,UJ,kJ,GJ,HJ,VJ,WJ,jJ,XJ=new Pn,qJ=rt({LUMINOUS_FLUX:0,LUMINANCE:1}),YJ=Tc("cc.StaticLightSettings")((vK=function(){function e(){se(this,"_baked",_K,this),se(this,"_editorOnly",dK,this),se(this,"_bakeable",pK,this),se(this,"_castShadow",mK,this)}return Q(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),_K=ce((fK=vK).prototype,"_baked",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dK=ce(fK.prototype,"_editorOnly",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pK=ce(fK.prototype,"_bakeable",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mK=ce(fK.prototype,"_castShadow",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ce(fK.prototype,"editorOnly",[Hc],Object.getOwnPropertyDescriptor(fK.prototype,"editorOnly"),fK.prototype),ce(fK.prototype,"bakeable",[Hc],Object.getOwnPropertyDescriptor(fK.prototype,"bakeable"),fK.prototype),ce(fK.prototype,"castShadow",[Hc],Object.getOwnPropertyDescriptor(fK.prototype,"castShadow"),fK.prototype),hK=fK))||hK,KJ=function(t){return e({Light:t,LightComponent:t}),t}((gK=Tc("cc.Light"),yK=Xc(),SK=Xc(),xK=qc(),EK=Xc(),TK=al(YJ),CK=Zc(),gK((OK=DK=function(e){function t(){var t;return se(t=e.call(this)||this,"_color",IK,re(t)),se(t,"_useColorTemperature",wK,re(t)),se(t,"_colorTemperature",PK,re(t)),se(t,"_staticSettings",RK,re(t)),t._type=vy.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=Ty,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=l.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(l.director.root.destroyLight(this._light),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case vy.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case vy.SPHERE:e.addSphereLight(this._light);break;case vy.SPOT:e.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case vy.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case vy.SPHERE:e.removeSphereLight(this._light);break;case vy.SPOT:e.removeSpotLight(this._light)}}},Q(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(XJ.x=e.r/255,XJ.y=e.g/255,XJ.z=e.b/255,this._light.color=XJ)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}}]),t}(Ku),DK.Type=vy,DK.PhotometricTerm=qJ,IK=ce((bK=OK).prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.WHITE.clone()}}),wK=ce(bK.prototype,"_useColorTemperature",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PK=ce(bK.prototype,"_colorTemperature",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),RK=ce(bK.prototype,"_staticSettings",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new YJ}}),ce(bK.prototype,"color",[yK],Object.getOwnPropertyDescriptor(bK.prototype,"color"),bK.prototype),ce(bK.prototype,"useColorTemperature",[SK],Object.getOwnPropertyDescriptor(bK.prototype,"useColorTemperature"),bK.prototype),ce(bK.prototype,"colorTemperature",[Jc,xK,EK],Object.getOwnPropertyDescriptor(bK.prototype,"colorTemperature"),bK.prototype),ce(bK.prototype,"staticSettings",[TK,CK],Object.getOwnPropertyDescriptor(bK.prototype,"staticSettings"),bK.prototype),AK=bK))||AK)),QJ=function(t){return e({DirectionalLight:t,DirectionalLightComponent:t}),t}((MK=Tc("cc.DirectionalLight"),LK=Gc(),FK=Bc(),BK=Oc("_illuminance"),zK=Xc(),UK=Vc(),kK=Ic({group:{name:"DynamicShadowSettings",displayOrder:1}}),GK=al(Nt),HK=Vc(),VK=Ic({group:{name:"DynamicShadowSettings",displayOrder:5}}),WK=al(cg),jK=Vc(),XK=Ic({group:{name:"DynamicShadowSettings",displayOrder:6}}),qK=al(Ot),YK=Vc(),KK=Ic({group:{name:"DynamicShadowSettings",displayOrder:7}}),QK=al(Ot),JK=Vc(),ZK=Ic({group:{name:"DynamicShadowSettings",displayOrder:8}}),$K=qc(),eQ=al(Ot),tQ=Vc(),nQ=Ic({group:{name:"DynamicShadowSettings",displayOrder:9}}),iQ=Xc(),rQ=qc(),aQ=al(Ot),oQ=Vc(),sQ=Ic({group:{name:"DynamicShadowSettings",displayOrder:10}}),cQ=Xc(),lQ=qc(),uQ=al(Ot),hQ=Vc(),fQ=Ic({group:{name:"DynamicShadowSettings",displayOrder:11}}),_Q=al(Nt),dQ=Vc(),pQ=Ic({group:{name:"DynamicShadowSettings",displayOrder:12}}),mQ=al(Ot),vQ=Vc(),gQ=Ic({group:{name:"DynamicShadowSettings",displayOrder:13}}),yQ=al(Ot),SQ=Vc(),xQ=Ic({group:{name:"DynamicShadowSettings",displayOrder:14}}),EQ=al(Ot),MK(TQ=LK(TQ=FK(TQ=Fc((zQ=function(e){function t(){var t;return se(t=e.call(this)||this,"_illuminanceHDR",AQ,re(t)),se(t,"_illuminanceLDR",bQ,re(t)),se(t,"_shadowEnabled",IQ,re(t)),se(t,"_shadowPcf",wQ,re(t)),se(t,"_shadowBias",PQ,re(t)),se(t,"_shadowNormalBias",RQ,re(t)),se(t,"_shadowSaturation",DQ,re(t)),se(t,"_shadowDistance",OQ,re(t)),se(t,"_shadowInvisibleOcclusionRange",NQ,re(t)),se(t,"_shadowFixedArea",MQ,re(t)),se(t,"_shadowNear",LQ,re(t)),se(t,"_shadowFar",FQ,re(t)),se(t,"_shadowOrthoSize",BQ,re(t)),t._type=vy.DIRECTIONAL,t._light=null,t._lightType=by,t}return Z(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR,this._light.shadowEnabled=this._shadowEnabled,this._light.shadowPcf=this._shadowPcf,this._light.shadowBias=this._shadowBias,this._light.shadowNormalBias=this._shadowNormalBias,this._light.shadowSaturation=this._shadowSaturation,this._light.shadowDistance=this._shadowDistance,this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange,this._light.shadowFixedArea=this._shadowFixedArea,this._light.shadowNear=this._shadowNear,this._light.shadowFar=this._shadowFar,this._light.shadowOrthoSize=this._shadowOrthoSize)},Q(t,[{key:"illuminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=this._shadowEnabled)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=this._shadowPcf)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=this._shadowBias)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=this._shadowNormalBias)}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=cn(e,0,1),this._light&&(this._light.shadowSaturation=this._shadowSaturation)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,ug.MAX_FAR),this._light&&(this._light.shadowDistance=this._shadowDistance)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,ug.MAX_FAR),this._light&&(this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this._light&&(this._light.shadowFixedArea=this._shadowFixedArea)}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e,this._light&&(this._light.shadowNear=this._shadowNear)}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,ug.MAX_FAR),this._light&&(this._light.shadowFar=this._shadowFar)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e,this._light&&(this._light.shadowOrthoSize=this._shadowOrthoSize)}}]),t}(KJ),AQ=ce((CQ=zQ).prototype,"_illuminanceHDR",[Ic,BK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),bQ=ce(CQ.prototype,"_illuminanceLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3*ag.standardExposureValue}}),IQ=ce(CQ.prototype,"_shadowEnabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wQ=ce(CQ.prototype,"_shadowPcf",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cg.HARD}}),PQ=ce(CQ.prototype,"_shadowBias",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),RQ=ce(CQ.prototype,"_shadowNormalBias",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DQ=ce(CQ.prototype,"_shadowSaturation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),OQ=ce(CQ.prototype,"_shadowDistance",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),NQ=ce(CQ.prototype,"_shadowInvisibleOcclusionRange",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),MQ=ce(CQ.prototype,"_shadowFixedArea",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LQ=ce(CQ.prototype,"_shadowNear",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),FQ=ce(CQ.prototype,"_shadowFar",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),BQ=ce(CQ.prototype,"_shadowOrthoSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),ce(CQ.prototype,"illuminance",[zK],Object.getOwnPropertyDescriptor(CQ.prototype,"illuminance"),CQ.prototype),ce(CQ.prototype,"shadowEnabled",[UK,kK,Hc,GK],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowEnabled"),CQ.prototype),ce(CQ.prototype,"shadowPcf",[HK,VK,Hc,WK],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowPcf"),CQ.prototype),ce(CQ.prototype,"shadowBias",[jK,XK,Hc,qK],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowBias"),CQ.prototype),ce(CQ.prototype,"shadowNormalBias",[YK,KK,Hc,QK],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowNormalBias"),CQ.prototype),ce(CQ.prototype,"shadowSaturation",[JK,ZK,Hc,$K,Jc,eQ],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowSaturation"),CQ.prototype),ce(CQ.prototype,"shadowDistance",[tQ,nQ,Hc,iQ,rQ,Jc,aQ],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowDistance"),CQ.prototype),ce(CQ.prototype,"shadowInvisibleOcclusionRange",[oQ,sQ,Hc,cQ,lQ,Jc,uQ],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowInvisibleOcclusionRange"),CQ.prototype),ce(CQ.prototype,"shadowFixedArea",[hQ,fQ,Hc,_Q],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowFixedArea"),CQ.prototype),ce(CQ.prototype,"shadowNear",[dQ,pQ,Hc,mQ],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowNear"),CQ.prototype),ce(CQ.prototype,"shadowFar",[vQ,gQ,Hc,yQ],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowFar"),CQ.prototype),ce(CQ.prototype,"shadowOrthoSize",[SQ,xQ,EQ],Object.getOwnPropertyDescriptor(CQ.prototype,"shadowOrthoSize"),CQ.prototype),TQ=CQ))||TQ)||TQ)||TQ)||TQ)),JJ=function(t){return e({SphereLight:t,SphereLightComponent:t}),t}((UQ=Tc("cc.SphereLight"),kQ=Gc(),GQ=Bc(),HQ=Oc("_luminance"),VQ=Zc(),WQ=Xc(),jQ=Zc(),XQ=Xc(),qQ=al(qJ),YQ=Zc(),KQ=Xc(),QQ=Xc(),JQ=Xc(),UQ(ZQ=kQ(ZQ=GQ(ZQ=Fc((aJ=function(e){function t(){var t;return se(t=e.call(this)||this,"_size",eJ,re(t)),se(t,"_luminanceHDR",tJ,re(t)),se(t,"_luminanceLDR",nJ,re(t)),se(t,"_term",iJ,re(t)),se(t,"_range",rJ,re(t)),t._type=vy.SPHERE,t._light=null,t._lightType=Iy,t}return Z(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},Q(t,[{key:"luminousFlux",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Ey(this._size):this._luminanceLDR},set:function(e){var t=0;l.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Ey(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(KJ),eJ=ce(($Q=aJ).prototype,"_size",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),tJ=ce($Q.prototype,"_luminanceHDR",[Dc,HQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Ey(.15)}}),nJ=ce($Q.prototype,"_luminanceLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Ey(.15)*ag.standardExposureValue*ag.standardLightMeterScale}}),iJ=ce($Q.prototype,"_term",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qJ.LUMINOUS_FLUX}}),rJ=ce($Q.prototype,"_range",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ce($Q.prototype,"luminousFlux",[VQ,WQ],Object.getOwnPropertyDescriptor($Q.prototype,"luminousFlux"),$Q.prototype),ce($Q.prototype,"luminance",[jQ,XQ],Object.getOwnPropertyDescriptor($Q.prototype,"luminance"),$Q.prototype),ce($Q.prototype,"term",[qQ,YQ,KQ],Object.getOwnPropertyDescriptor($Q.prototype,"term"),$Q.prototype),ce($Q.prototype,"size",[QQ],Object.getOwnPropertyDescriptor($Q.prototype,"size"),$Q.prototype),ce($Q.prototype,"range",[JQ],Object.getOwnPropertyDescriptor($Q.prototype,"range"),$Q.prototype),ZQ=$Q))||ZQ)||ZQ)||ZQ)||ZQ)),ZJ=function(t){return e({SpotLight:t,SpotLightComponent:t}),t}((oJ=Tc("cc.SpotLight"),sJ=Gc(),cJ=Bc(),lJ=Oc("_luminance"),uJ=Xc(),hJ=Zc(),fJ=Xc(),_J=Zc(),dJ=al(qJ),pJ=Zc(),mJ=Xc(),vJ=Xc(),gJ=Xc(),yJ=qc(),SJ=Xc(),xJ=Vc(),EJ=Ic({group:{name:"DynamicShadowSettings",displayOrder:1}}),TJ=al(Nt),CJ=Vc(),AJ=Ic({group:{name:"DynamicShadowSettings",displayOrder:2}}),bJ=al(cg),IJ=Vc(),wJ=Ic({group:{name:"DynamicShadowSettings",displayOrder:3}}),PJ=al(Ot),RJ=Vc(),DJ=Ic({group:{name:"DynamicShadowSettings",displayOrder:4}}),OJ=al(Ot),oJ(NJ=sJ(NJ=cJ(NJ=Fc((jJ=function(e){function t(){var t;return se(t=e.call(this)||this,"_size",LJ,re(t)),se(t,"_luminanceHDR",FJ,re(t)),se(t,"_luminanceLDR",BJ,re(t)),se(t,"_term",zJ,re(t)),se(t,"_range",UJ,re(t)),se(t,"_spotAngle",kJ,re(t)),se(t,"_shadowEnabled",GJ,re(t)),se(t,"_shadowPcf",HJ,re(t)),se(t,"_shadowBias",VJ,re(t)),se(t,"_shadowNormalBias",WJ,re(t)),t._type=vy.SPOT,t._light=null,t._lightType=My,t}return Z(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR,this._light.shadowEnabled=this._shadowEnabled,this._light.shadowPcf=this._shadowPcf,this._light.shadowBias=this._shadowBias,this._light.shadowNormalBias=this._shadowNormalBias)},Q(t,[{key:"luminousFlux",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Ey(this._size):this._luminanceLDR},set:function(e){var t=0;l.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Ey(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=hn(e))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=e)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=e)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=e)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=e)}}]),t}(KJ),LJ=ce((MJ=jJ).prototype,"_size",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),FJ=ce(MJ.prototype,"_luminanceHDR",[Dc,lJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Ey(.15)}}),BJ=ce(MJ.prototype,"_luminanceLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Ey(.15)*ag.standardExposureValue*ag.standardLightMeterScale}}),zJ=ce(MJ.prototype,"_term",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qJ.LUMINOUS_FLUX}}),UJ=ce(MJ.prototype,"_range",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kJ=ce(MJ.prototype,"_spotAngle",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),GJ=ce(MJ.prototype,"_shadowEnabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HJ=ce(MJ.prototype,"_shadowPcf",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cg.HARD}}),VJ=ce(MJ.prototype,"_shadowBias",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),WJ=ce(MJ.prototype,"_shadowNormalBias",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ce(MJ.prototype,"luminousFlux",[uJ,hJ],Object.getOwnPropertyDescriptor(MJ.prototype,"luminousFlux"),MJ.prototype),ce(MJ.prototype,"luminance",[fJ,_J],Object.getOwnPropertyDescriptor(MJ.prototype,"luminance"),MJ.prototype),ce(MJ.prototype,"term",[dJ,pJ,mJ],Object.getOwnPropertyDescriptor(MJ.prototype,"term"),MJ.prototype),ce(MJ.prototype,"size",[vJ],Object.getOwnPropertyDescriptor(MJ.prototype,"size"),MJ.prototype),ce(MJ.prototype,"range",[gJ],Object.getOwnPropertyDescriptor(MJ.prototype,"range"),MJ.prototype),ce(MJ.prototype,"spotAngle",[Jc,yJ,SJ],Object.getOwnPropertyDescriptor(MJ.prototype,"spotAngle"),MJ.prototype),ce(MJ.prototype,"shadowEnabled",[xJ,EJ,Hc,TJ],Object.getOwnPropertyDescriptor(MJ.prototype,"shadowEnabled"),MJ.prototype),ce(MJ.prototype,"shadowPcf",[CJ,AJ,Hc,bJ],Object.getOwnPropertyDescriptor(MJ.prototype,"shadowPcf"),MJ.prototype),ce(MJ.prototype,"shadowBias",[IJ,wJ,Hc,PJ],Object.getOwnPropertyDescriptor(MJ.prototype,"shadowBias"),MJ.prototype),ce(MJ.prototype,"shadowNormalBias",[RJ,DJ,Hc,OJ],Object.getOwnPropertyDescriptor(MJ.prototype,"shadowNormalBias"),MJ.prototype),NJ=MJ))||NJ)||NJ)||NJ)||NJ));l.LightComponent=KJ,nt.setClassAlias(KJ,"cc.LightComponent"),l.DirectionalLightComponent=QJ,nt.setClassAlias(QJ,"cc.DirectionalLightComponent"),l.SphereLightComponent=JJ,nt.setClassAlias(JJ,"cc.SphereLightComponent"),l.SpotLightComponent=ZJ,nt.setClassAlias(ZJ,"cc.SpotLightComponent"),U(ZJ.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),U(JJ.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),U(KJ.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var $J=Symbol("BakeNodeCurves"),eZ=function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&l.director.root.dataPoolManager.releaseAnimationClip(t);var i=Math.ceil(t.sample*t.duration)+1,r=t.sample;n=t[$J](0,r,i),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}();eZ.pool=new Map;var tZ=new Wn;function nZ(e,t,n){for(Wn.identity(n);e!==t;)Wn.fromRTS(tZ,e.rotation,e.position,e.scale),Wn.multiply(n,tZ,n),e=e.parent;return n}var iZ=new Er(bi.POINT,bi.POINT,bi.NONE,Ii.CLAMP,Ii.CLAMP,Ii.CLAMP),rZ=function(e,t,n){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14};function aZ(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*n,e)/12)}new Fn,new Fn,new Pn,new Fn,new Pn;var oZ=new Pn,sZ=new Pn,cZ=new Pn,lZ=new Pn,uZ=new Wn,hZ=new Wn,fZ=new Ys,_Z=Number.MAX_SAFE_INTEGER,dZ=(function(){function e(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=function(e){return e.getFormatFeatures(_i.RGBA32F)&Ti.SAMPLED_TEXTURE?_i.RGBA32F:_i.RGBA8}(this._device);this._formatSize=na[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Uy(e),this._pool.initialize({format:t,roundUpFn:aZ}),this._customPool=new Uy(e),this._customPool.initialize({format:t,roundUpFn:aZ})}var t=e.prototype;t.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},t.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var a=n.contents[r],o=a.skeleton;this._chunkIdxMap.set(o,i);for(var s=0;s<a.clips.length;s++){var c=a.clips[s];this._chunkIdxMap.set(o^c,i)}}},t.getDefaultPoseTexture=function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var a=e.joints,o=e.bindposes,s=null,c=!1,l=a.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),f=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!f)return r;r={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:f},s=new Float32Array(u),c=!0}Pn.set(cZ,_Z,_Z,_Z),Pn.set(lZ,-_Z,-_Z,-_Z);for(var _=t.getBoneSpaceBounds(e),d=0,p=0;d<l;d++,p+=12){var m=n.getChildByPath(a[d]),v=m?nZ(m,n,uZ):e.inverseBindposes[d],g=_[d];g&&(Ys.transform(fZ,g,v),fZ.getBoundary(oZ,sZ),Pn.min(cZ,cZ,oZ),Pn.max(lZ,lZ,sZ)),c&&(m&&Wn.multiply(v,v,o[d]),rZ(s,p,m?v:Wn.IDENTITY))}var y=[new Ys];return r.bounds.set(t.hash,y),Ys.fromPoints(y[0],cZ,lZ),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},t.getSequencePoseTexture=function(e,t,n,i){var r=e.hash^t.hash,a=this._textureBuffers.get(r)||null;if(a&&a.bounds.has(n.hash))return a.refCount++,a;var o=e.joints,s=e.bindposes,c=eZ.getOrExtract(t).frames,l=null,u=!1,h=o.length;if(a)a.refCount++;else{var f=12*h*c,_=this._chunkIdxMap.get(r),d=void 0!==_?this._customPool.alloc(f*Float32Array.BYTES_PER_ELEMENT,_):this._pool.alloc(f*Float32Array.BYTES_PER_ELEMENT);if(!d)return null;var p=this._createAnimInfos(e,t,i);a={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:d,animInfos:p},l=new Float32Array(f),u=!0}var m=n.getBoneSpaceBounds(e),v=[];a.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new Ys(_Z,_Z,_Z,-_Z,-_Z,-_Z));for(var y=0,S=0;y<c;y++){for(var x=v[y],E=0;E<h;E++,S+=12){var T=a.animInfos[E],C=T.curveData,A=T.downstream,b=T.bindposeIdx,I=T.bindposeCorrection,w=void 0,P=!0;C&&A?w=Wn.multiply(uZ,C[y],A):C?w=C[y]:A?w=A:(w=e.inverseBindposes[b],P=!1);var R=m[E];if(R){var D=I?Wn.multiply(hZ,w,I):w;Ys.transform(fZ,R,D),fZ.getBoundary(oZ,sZ),Pn.min(x.center,x.center,oZ),Pn.max(x.halfExtents,x.halfExtents,sZ)}u&&(P&&Wn.multiply(uZ,w,s[b]),rZ(l,S,P?uZ:Wn.IDENTITY))}Ys.fromPoints(x,x.center,x.halfExtents)}return u&&(this._pool.update(a.handle,l.buffer),this._textureBuffers.set(r,a)),a},t.releaseHandle=function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}},t.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t._createAnimInfos=function(e,t,n){for(var i=[],r=e.joints,a=e.bindposes,o=r.length,s=eZ.getOrExtract(t),c=0;c<o;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),f=void 0,_=void 0;!u;){var d=l.lastIndexOf("/");if(l=l.substring(0,d),u=s.joints[l],h?(f||(f=new Wn),Wn.fromRTS(uZ,h.rotation,h.position,h.scale),Wn.multiply(f,uZ,f),h=h.parent):_=l,d<0)break}var p=c,m=void 0;if(void 0!==_&&u){p=c-1;for(var v=0;v<o;v++)if(r[v]===_){p=v,m=new Wn,Wn.multiply(m,a[v],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:f,bindposeIdx:p,bindposeCorrection:m})}return i},Q(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}])}(),[]),pZ=new Map;function mZ(e,t){for(var n=0,i=Wn.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,dZ[n++]=e,e=e.parent}for(;n>0;){e=dZ[--n],dZ[n]=null;var r=e.node;Wn.fromRTS(e.local,r.rotation,r.position,r.scale),i=Wn.multiply(e.world,i,e.local)}return i}function vZ(e,t){for(var n,i=null,r=0;e!==t;){var a=e.uuid;if(pZ.has(a)){i=pZ.get(a);break}i={node:e,local:new Wn,world:new Wn,stamp:-1,parent:null},pZ.set(a,i),dZ[r++]=i,e=e.parent,i=null}for(;r>0;)n=dZ[--r],dZ[r]=null,n.parent=i,i=n;return i}function gZ(e){for(var t=pZ.get(e.uuid)||null;t;)pZ.delete(t.node.uuid),t=t.parent}var yZ=[{name:"CC_USE_SKINNING",value:!0}];function SZ(e,t,n,i){for(var r=0;r<n.length;r++){for(var a=n[r],o=-1,s=0;s<a.length;s++)if(a[s]===i){o=s;break}o>=0&&(t.push(r),e.push(o))}}var xZ,EZ,TZ,CZ,AZ,bZ,IZ,wZ,PZ,RZ,DZ,OZ,NZ,MZ,LZ,FZ,BZ,zZ,UZ,kZ,GZ,HZ,VZ,WZ,jZ,XZ,qZ,YZ,KZ,QZ,JZ,ZZ,$Z,e$,t$,n$,i$,r$,a$,o$,s$,c$,l$,u$,h$,f$,_$,d$,p$,m$,v$,g$,y$,S$=new Pn,x$=new Pn,E$=new Pn,T$=new Pn,C$=new Wn,A$=new Ys,b$=function(e){function t(){var t;return(t=e.call(this)||this)._buffers=[],t._dataArray=[],t._joints=[],t._bufferIndices=null,t.type=Wg.SKINNING,t}Z(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}e.prototype.destroy.call(this)},n.uploadAnimation=function(){},n.bindSkeleton=function(e,t,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)gZ(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),a=n.struct.jointMaps;this._ensureEnoughBuffers(a&&a.length||1),this._bufferIndices=n.jointBufferIndices;for(var o=0;o<e.joints.length;o++){var s=r[o],c=t.getChildByPath(e.joints[o]);if(s&&c){var l=vZ(c,t),u=e.bindposes[o],h=[],f=[];a?SZ(h,f,a,o):(h.push(o),f.push(0)),this._joints.push({indices:h,buffers:f,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0),Pn.set(S$,1/0,1/0,1/0),Pn.set(x$,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,a=mZ(i.transform,e);Ys.transform(A$,r,a),A$.getBoundary(E$,T$),Pn.min(S$,S$,E$),Pn.max(x$,x$,T$)}var o=this._worldBounds;this._modelBounds&&o&&(Ys.fromPoints(this._modelBounds,S$,x$),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,a=i.buffers,o=i.transform,s=i.bindpose;Wn.multiply(C$,o.world,s);for(var c=0;c<a.length;c++)rZ(this._dataArray[a[c]],12*r[c],C$)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(t,n,i){var r=n.vertexBuffers,a=n.iaInfo;a.vertexBuffers=n.jointMappedBuffers,e.prototype.initSubModel.call(this,t,n,i),a.vertexBuffers=r},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?yZ.concat(n):yZ},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._buffers[this._bufferIndices[t]];i&&n.bindBuffer(lp.BINDING,i)},n._updateInstancedAttributes=function(t,n){n.batchingScheme!==mv.NONE&&R(3936,this.node.getPathInHierarchy()),e.prototype._updateInstancedAttributes.call(this,t,n)},n._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,lp.SIZE,lp.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(lp.COUNT))},t}(aK),I$=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],w$=function(e){function t(){var t;(t=e.call(this)||this).uploadedAnim=void 0,t._jointsMedium=void 0,t._skeleton=null,t._mesh=null,t._dataPoolManager=void 0,t._instAnimInfoIdx=-1,t.type=Wg.BAKED_SKINNING,t._dataPoolManager=l.director.root.dataPoolManager;var n=new Float32Array(4),i=t._dataPoolManager.jointAnimationInfo.getData();return t._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:i,texture:null,boundsInfo:null},t}Z(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),this._skeleton=e,this._mesh=n,e&&t&&n){this.transform=t;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,op.SIZE,op.SIZE)))}},n.updateTransform=function(t){if(e.prototype.updateTransform.call(this,t),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],a=this._worldBounds;if(a&&r){var o=this.transform;r.transform(o._mat,o._pos,o._rot,o._scale,a)}}},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?n.concat(I$):I$},n.uploadAnimation=function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,n=null;e?(n=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(e){this._modelBounds=e},n._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var a=e.handle.texture,o=0;o<this._subModels.length;++o)this._subModels[o].descriptorSet.bindTexture(fp,a)}},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._jointsMedium,r=i.buffer,a=i.texture,o=i.animInfo;if(n.bindBuffer(op.BINDING,r),n.bindBuffer(sp.BINDING,o.buffer),a){var s=this._device.getSampler(iZ);n.bindTexture(fp,a.handle.texture),n.bindSampler(fp,s)}},n._updateInstancedAttributes=function(t,n){e.prototype._updateInstancedAttributes.call(this,t,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(cp)),this.updateInstancedJointTextureInfo()},n._setInstAnimInfoIdx=function(e){this._instAnimInfoIdx=e},n.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,n=e.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=t[1],r[2]=t[2]}},t}(aK),P$=function(t){return e({SkinnedMeshRenderer:t,SkinningModelComponent:t}),t}((xZ=Tc("cc.SkinnedMeshRenderer"),EZ=Gc(),TZ=Ac(100),CZ=Bc(),AZ=al(NK),bZ=al(ib),IZ=al(NK),wZ=al(ib),PZ=Xc(),xZ(RZ=EZ(RZ=TZ(RZ=Fc(RZ=CZ((MZ=function(e){function t(){var t;return se(t=e.call(this)||this,"_skeleton",OZ,re(t)),se(t,"_skinningRoot",NZ,re(t)),t._clip=null,t.associatedAnimation=null,t._modelType=w$,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this._tryBindAnimation()},n.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),e.prototype.onDestroy.call(this)},n.uploadAnimation=function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)},n.setUseBakedAnimation=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1);var n=e?w$:b$;(t||this._modelType!==n)&&(this._modelType=n,this._model&&(l.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(t,n){e.prototype.setMaterial.call(this,t,n),this._modelType===b$&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),e.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var e=this._skinningRoot;if(e){for(var t=!1,n=this.node;n;n=n.parent)if(n===e){t=!0;break}if(t){var i=e.getComponent("cc.SkeletalAnimation");i?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},Q(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._tryBindAnimation(),e!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),t}(lK),OZ=ce((DZ=MZ).prototype,"_skeleton",[AZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NZ=ce(DZ.prototype,"_skinningRoot",[bZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ce(DZ.prototype,"skeleton",[IZ],Object.getOwnPropertyDescriptor(DZ.prototype,"skeleton"),DZ.prototype),ce(DZ.prototype,"skinningRoot",[wZ,PZ],Object.getOwnPropertyDescriptor(DZ.prototype,"skinningRoot"),DZ.prototype),RZ=DZ))||RZ)||RZ)||RZ)||RZ)||RZ)),R$=new Or($i.ATTR_BATCH_ID,_i.R32F),D$=new Or($i.ATTR_BATCH_UV,_i.RG32F),O$=na[R$.format].size+na[D$.format].size,N$=function(t){return e({SkinnedMeshUnit:t,SkinningModelUnit:t}),t}((LZ=Tc("cc.SkinnedMeshUnit"),FZ=al($q),BZ=al(NK),zZ=al(Qv),UZ=al(P$),LZ((YZ=function(){function e(){se(this,"mesh",HZ,this),se(this,"skeleton",VZ,this),se(this,"material",WZ,this),se(this,"_localTransform",jZ,this),se(this,"_offset",XZ,this),se(this,"_size",qZ,this)}return Q(e,[{key:"offset",get:function(){return this._offset},set:function(e){Yn.copy(this._offset,e)}},{key:"size",get:function(){return this._size},set:function(e){Yn.copy(this._size,e)}},{key:"copyFrom",get:function(){return null},set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&nZ(e.node,e.skinningRoot,this._localTransform))}}]),e}(),HZ=ce((GZ=YZ).prototype,"mesh",[FZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VZ=ce(GZ.prototype,"skeleton",[BZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WZ=ce(GZ.prototype,"material",[zZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jZ=ce(GZ.prototype,"_localTransform",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn}}),XZ=ce(GZ.prototype,"_offset",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(0,0)}}),qZ=ce(GZ.prototype,"_size",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(1,1)}}),ce(GZ.prototype,"offset",[Hc],Object.getOwnPropertyDescriptor(GZ.prototype,"offset"),GZ.prototype),ce(GZ.prototype,"size",[Hc],Object.getOwnPropertyDescriptor(GZ.prototype,"size"),GZ.prototype),ce(GZ.prototype,"copyFrom",[UZ],Object.getOwnPropertyDescriptor(GZ.prototype,"copyFrom"),GZ.prototype),kZ=GZ))||kZ)),M$=new Wn,L$=(new Wn,new Pn),F$=function(t){return e({SkinnedMeshBatchRenderer:t,BatchedSkinningModelComponent:t}),t}((KZ=Tc("cc.SkinnedMeshBatchRenderer"),QZ=Gc(),JZ=Ac(100),ZZ=Bc(),$Z=Xc(),e$=al([Mt]),t$=Xc(),n$=al([N$]),i$=Xc(),r$=Vc(),a$=Vc(),KZ(o$=QZ(o$=JZ(o$=Fc(o$=ZZ((h$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"atlasSize",c$,re(t)),se(t,"batchableTextureNames",l$,re(t)),se(t,"units",u$,re(t)),t._textures={},t._batchMaterial=null,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),e.prototype.onDestroy.call(this)},n._onMaterialModified=function(t){this.cookMaterials(),e.prototype._onMaterialModified.call(this,t,this.getMaterialInstance(t))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var n=t.effectAsset.techniques[t.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var a=function(n){if(r.properties[n].type>=pi.SAMPLER1D){var a=null;e.batchableTextureNames.find((function(e){return e===n}))?((a=e._textures[n])||(a=e.createTexture(n)),e.cookTextures(a,n,i)):e.units.some((function(e){return a=e.material&&e.material.getProperty(n,i)})),a&&t.setProperty(n,a,i)}else{for(var o=[],s=0;s<e.units.length;s++){var c=e.units[s];c.material&&o.push(c.material.getProperty(n.slice(0,-3),i))}t.setProperty(n,o,i)}};for(var o in r.properties)a(o)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var e=[],t=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;Wn.invert(M$,i._localTransform);for(var a=function(n){var i=r.joints[n];if(e.findIndex((function(e){return e===i}))>=0)return"continue";e.push(i),t.push(Wn.multiply(new Wn,r.bindposes[n]||Wn.IDENTITY,M$))},o=0;o<r.joints.length;o++)a(o)}}var s=Array.from(Array(e.length).keys()).sort((function(t,n){return e[t]>e[n]?1:e[t]<e[n]?-1:0})),c=new NK;c.joints=e.map((function(e,t,n){return n[s[t]]})),c.bindposes=t.map((function(e,t,n){return n[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var e=this,t=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){t=!0;break}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new $q;for(var i=0,r=_i.UNKNOWN,a=0,o=_i.UNKNOWN,s=0,c=_i.UNKNOWN,l=0,u=_i.UNKNOWN,h=0,f=_i.UNKNOWN,_=new Array(this.units.length),d=this.units.length,p=0;p<d;p++){var m=this.units[p];m&&m.skeleton&&(_[p]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var n=e.units[t];if(!n||!n.mesh||!n.mesh.data)return"continue";var d=e._createUnitMesh(t,n.mesh),p=new DataView(d.data.buffer);Wn.inverseTranspose(M$,n._localTransform);for(var m=n.offset,v=n.size,g=function(e){var g=d.struct.vertexBundles[e];i=g.view.offset,r=_i.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var S=g.attributes[y];if(S.name===$i.ATTR_POSITION){r=S.format;break}i+=na[S.format].size}if(r){for(var x=Qb(p,r,i,g.view.length,g.view.stride),E=0;E<x.length;E+=3)Pn.fromArray(L$,x,E),Pn.transformMat4(L$,L$,n._localTransform),Pn.toArray(x,L$,E);Kb(p,x,r,i,g.view.stride)}a=g.view.offset,o=_i.UNKNOWN;for(var T=0;T<g.attributes.length;T++){var C=g.attributes[T];if(C.name===$i.ATTR_NORMAL){o=C.format;break}a+=na[C.format].size}if(o){for(var A=Qb(p,o,a,g.view.length,g.view.stride),b=0;b<A.length;b+=3)Pn.fromArray(L$,A,b),Pn.transformMat4Normal(L$,L$,M$),Pn.toArray(A,L$,b);Kb(p,A,o,a,g.view.stride)}s=g.view.offset,c=_i.UNKNOWN;for(var I=0;I<g.attributes.length;I++){var w=g.attributes[I];if(w.name===$i.ATTR_TANGENT){c=w.format;break}s+=na[w.format].size}if(c){for(var P=Qb(p,c,s,g.view.length,g.view.stride),R=0;R<P.length;R+=3)Pn.fromArray(L$,P,R),Pn.transformMat4Normal(L$,L$,M$),Pn.toArray(P,L$,R);Kb(p,P,c,s,g.view.stride)}l=g.view.offset,u=_i.UNKNOWN;for(var D=0;D<g.attributes.length;D++){var O=g.attributes[D];if(O.name===$i.ATTR_BATCH_UV){u=O.format;break}l+=na[O.format].size}u&&Jb(p,(function(e,t){var n,i=0===t?"x":"y";return(e=(n=e)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,p);var N=_[t];if(!N)return"continue";h=g.view.offset,f=_i.UNKNOWN;for(var M=0;M<g.attributes.length;M++){var L=g.attributes[M];if(L.name===$i.ATTR_JOINTS){f=L.format;break}h+=na[L.format].size}f&&Jb(p,(function(e){return N[e]}),f,h,g.view.length,g.view.stride,p)},y=0;y<d.struct.vertexBundles.length;y++)g(y);e._mesh.merge(d)},g=0;g<d;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(e,t,n){for(var i=[],r=[],a=[],o=[],s=0;s<this.units.length;s++){var c=this.units[s];if(c.material){var u=c.material.getProperty(t,n);if(u&&u.image&&u.image.data){var h=new lr;h.texOffset.x=c.offset.x*this.atlasSize,h.texOffset.y=c.offset.y*this.atlasSize,h.texExtent.width=c.size.x*this.atlasSize,h.texExtent.height=c.size.y*this.atlasSize;var f=u.image.data;ArrayBuffer.isView(f)?(a.push(f),o.push(h)):(i.push(f),r.push(h))}}}var _=e.getGFXTexture(),d=l.director.root.device;a.length>0&&d.copyBuffersToTexture(a,_,o),i.length>0&&d.copyTexImagesToTexture(i,_,r)},n.createTexture=function(e){var t=new hv;return t.setFilters(xm.LINEAR,xm.LINEAR),t.setMipFilter(xm.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:ym.RGBA8888}),this._textures[e]=t,t},n.resizeAtlases=function(){for(var e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:ym.RGBA8888})},n._createUnitMesh=function(e,t){for(var n=JSON.parse(JSON.stringify(t.struct)),i={},r=0;r<t.struct.primitives.length;r++){for(var a=t.struct.primitives[r],o=0,s=_i.UNKNOWN,c=0;c<a.vertexBundelIndices.length;c++){var u=t.struct.vertexBundles[a.vertexBundelIndices[c]];o=u.view.offset,s=_i.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var f=u.attributes[h];if(f.name===$i.ATTR_TEX_COORD){s=f.format;break}o+=na[f.format].size}if(s)break}if(void 0===i[c]){i[c]=[s,o];var _=n.vertexBundles[c];_.attributes.push(R$),_.attributes.push(D$),_.view.offset=0,_.view.length+=_.view.count*O$,_.view.stride+=O$}}for(var d=0,p=0;p<n.vertexBundles.length;p++)d+=n.vertexBundles[p].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=d,d+=v.indexView.length)}var g=new Uint8Array(d),y=t.data,S=new DataView(g.buffer),x=new DataView(y.buffer),E=l.sys.isLittleEndian;for(var T in i)for(var C=n.vertexBundles[T],A=t.struct.vertexBundles[T],b=i[T],I=Qb(x,b[0],b[1],A.view.length,A.view.stride),w=A.view,P=C.view,R=w.stride,D=P.stride,O=w.offset,N=P.offset,M=0;M<P.count;M++){var L=y.subarray(O,O+R);g.set(L,N),S.setFloat32(N+R,e),S.setFloat32(N+R+4,I[2*M],E),S.setFloat32(N+R+8,I[2*M+1],E),N+=D,O+=R}for(var F=0;F<n.primitives.length;F++){var B=t.struct.primitives[F],z=n.primitives[F];if(B.indexView&&z.indexView)for(var U=B.indexView.stride,k=z.indexView.stride,G=B.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var W=y.subarray(G,G+U);g.set(W,H),H+=k,G+=U}}var j=new $q;return j.reset({struct:n,data:g}),j},Q(t,[{key:"mesh",get:function(){return e.prototype.mesh},set:function(e){this.mesh=e}},{key:"skeleton",get:function(){return e.prototype.skeleton},set:function(e){this.skeleton=e}}]),t}(P$),c$=ce((s$=h$).prototype,"atlasSize",[Dc,$Z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),l$=ce(s$.prototype,"batchableTextureNames",[e$,Dc,t$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u$=ce(s$.prototype,"units",[n$,Dc,i$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ce(s$.prototype,"mesh",[sl,r$],Object.getOwnPropertyDescriptor(s$.prototype,"mesh"),s$.prototype),ce(s$.prototype,"skeleton",[sl,a$],Object.getOwnPropertyDescriptor(s$.prototype,"skeleton"),s$.prototype),o$=s$))||o$)||o$)||o$)||o$)||o$));function B$(e){return"string"==typeof e||"number"==typeof e}l.SkinningModelComponent=P$,nt.setClassAlias(P$,"cc.SkinningModelComponent"),l.SkinningModelUnit=N$,nt.setClassAlias(N$,"cc.SkinningModelUnit"),l.BatchedSkinningModelComponent=F$,nt.setClassAlias(F$,"cc.BatchedSkinningModelComponent"),l.utils=cY;var z$,U$,k$,G$,H$,V$,W$,j$,X$,q$,Y$,K$,Q$,J$,Z$,$$,e0,t0,n0,i0,r0,a0,o0=Tc("cc.animation.HierarchyPath")((p$=function(){function e(e){se(this,"path",d$,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof ib?e.getChildByPath(this.path)||(R(3926,e.name,this.path),null):(R(3925),null)},e}(),d$=ce((_$=p$).prototype,"path",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),f$=_$))||f$,s0=Tc("cc.animation.ComponentPath")((y$=function(){function e(e){se(this,"component",g$,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof ib?e.getComponent(this.component)||(R(3928,e.name,this.component),null):(R(3927),null)},e}(),g$=ce((v$=y$).prototype,"component",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),m$=v$))||m$,c0=Tc("cc.animation.UniformProxyFactory")((V$=function(){function e(e,t){se(this,"passIndex",k$,this),se(this,"uniformName",G$,this),se(this,"channelIndex",H$,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(Iv.getTypeFromHandle(n)<pi.SAMPLER1D){var i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,pi.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=oe(e.shaderInfo.blocks);!(n=i()).done;)for(var r,a=oe(n.value.members);!(r=a()).done;){var o=r.value;if(o.name===t)return o.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(i,e)}}:{set:function(e){t.setUniform(i,e)}}}var r=Iv.getBindingFromHandle(n),a=t.properties[this.uniformName],o=a&&a.value?a.value+"-texture":em(a.type),s=Sv.get(o);return s||(S("Illegal texture default value: "+o+"."),s=Sv.get("default-texture")),{set:function(e){e||(e=s);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(r,n),e instanceof km&&t.bindSampler(r,l.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),k$=ce((U$=V$).prototype,"passIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G$=ce(U$.prototype,"uniformName",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),H$=ce(U$.prototype,"channelIndex",[nl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),z$=U$))||z$,l0=Tc("cc.animation.MorphWeightValueProxy")((Y$=function(){function e(){se(this,"subMeshIndex",X$,this),se(this,"shapeIndex",q$,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),X$=ce((j$=Y$).prototype,"subMeshIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),q$=ce(j$.prototype,"shapeIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),W$=j$))||W$,u0=Tc("cc.animation.MorphWeightsValueProxy")((Z$=function(){function e(){se(this,"subMeshIndex",J$,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),J$=ce((Q$=Z$).prototype,"subMeshIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),K$=Q$))||K$,h0=Tc("cc.animation.MorphWeightsAllValueProxy")($$=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,a=0;a<r;++a)e.setWeights(t,a)}}},e}())||$$;function f0(e,t,n,i){var r,a,o,s,c,l,u=new t,h=new t,f=new t,_=Tc(e)((l=function(){function e(e,n,i){se(this,"dataPoint",o,this),se(this,"inTangent",s,this),se(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var a=this.dataPoint,o=e.dataPoint;h=n(h,this.inTangent,r),f=n(f,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,_=-2*s+3*c,d=s-c;return u=n(u,a,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,o,_),u=i(u,u,f,d)},r.getNoLerp=function(){return this.dataPoint},e}(),o=ce((a=l).prototype,"dataPoint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=ce(a.prototype,"inTangent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=ce(a.prototype,"outTangent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=a))||r;if(t===Fn){var d=_.prototype.lerp;_.prototype.lerp=function(e,t,n){var i=d.call(this,e,t,n);return Fn.normalize(i,i),i}}return _}var _0,d0,p0,m0,v0,g0,y0,S0,x0,E0,T0,C0,A0,b0,I0,w0,P0,R0,D0,O0,N0,M0,L0,F0,B0,z0,U0,k0=f0("cc.CubicSplineVec2Value",Yn,Yn.multiplyScalar,Yn.scaleAndAdd),G0=f0("cc.CubicSplineVec3Value",Pn,Pn.multiplyScalar,Pn.scaleAndAdd),H0=f0("cc.CubicSplineVec4Value",Zn,Zn.multiplyScalar,Zn.scaleAndAdd),V0=f0("cc.CubicSplineQuatValue",Fn,Fn.multiplyScalar,Fn.scaleAndAdd),W0=Tc("cc.CubicSplineNumberValue")((a0=function(){function e(e,t,n){se(this,"dataPoint",n0,this),se(this,"inTangent",i0,this),se(this,"outTangent",r0,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,a=t*t*t,o=t*t;return i*(2*a-3*o+1)+this.outTangent*n*(a-2*o+t)+r*(-2*a+3*o)+e.inTangent*n*(a-o)},t.getNoLerp=function(){return this.dataPoint},e}(),n0=ce((t0=a0).prototype,"dataPoint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i0=ce(t0.prototype,"inTangent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r0=ce(t0.prototype,"outTangent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),e0=t0))||e0,j0=Symbol("CreateEval"),X0=Symbol("NormalizedFollow"),q0=Symbol("ConvertAsTrsPath"),Y0=Symbol("TrackBinding"),K0=Tc("cc.animation.TrackPath")((m0=function(){function e(){se(this,"_paths",p0,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new o0(e)),this},t.toComponent=function(e){var t=new s0("string"==typeof e?e:nt.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof o0},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof s0},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[X0](e,t,n)},t[q0]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var a=t[i];if(!(a instanceof o0))break;a.path&&(r?r+="/"+a.path:r=a.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[X0]=function(e,t,n){for(var i=this._paths,r=e,a=t;a<n;++a){var o=i[a];if(B$(o)){if(!(o in r))return R(3929,o),null;r=r[o]}else r=o.get(r);if(null===r)break}return r},Q(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),p0=ce((d0=m0).prototype,"_paths",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_0=d0))||_0,Q0=Tc("cc.animation.TrackBinding")(v0=Lc((x0=function(){function e(){se(this,"path",y0,this),se(this,"proxy",S0,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[q0]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,a=i.length,o=a-1;if(0===a||!i.isPropertyAt(o)&&!i.isElementAt(o)||r){if(r){var s=i[X0](e,0,a);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return O(3921),null}var h=i.isPropertyAt(o)?i.parsePropertyAt(o):i.parseElementAt(o),f=i[X0](e,0,a-1);return null===f?null:t&&f instanceof ib&&function(e){return"position"===e||"rotation"===e||"scale"===e||"eulerAngles"===e}(h)?t.createPoseWriter(f,h,n):{setValue:function(e){f[h]=e},getValue:function(){return f[h]}}},t.isMaskedOff=function(e){var t=this.parseTrsPath();if(!t)return!1;for(var n=e.joints[Symbol.iterator](),i=n.next();!i.done;i=n.next()){var r=i.value;if(r.path===t.node)return!r.enabled}return!1},e}(),y0=ce((g0=x0).prototype,"path",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K0}}),S0=ce(g0.prototype,"proxy",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),v0=g0))||v0)||v0,J0=Tc("cc.animation.Track")((A0=function(){function e(){se(this,"_binding",C0,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=oe(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},Q(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:Y0,get:function(){return this._binding}}]),e}(),C0=ce((T0=A0).prototype,"_binding",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Q0}}),E0=T0))||E0,Z0=Tc("cc.animation.Channel")((P0=function(){function e(e){this.name="",se(this,"_curve",w0,this),this._curve=e}return Q(e,[{key:"curve",get:function(){return this._curve}}]),e}(),w0=ce((I0=P0).prototype,"_curve",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),b0=I0))||b0,$0=Tc("cc.animation.SingleChannelTrack")((N0=function(e){function t(){var t;return se(t=e.call(this)||this,"_channel",O0,re(t)),t._channel=new Z0(t.createCurve()),t}Z(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[j0]=function(){var e=this._channel.curve;return new e1(e)},Q(t,[{key:"channel",get:function(){return this._channel}}]),t}(J0),O0=ce((D0=N0).prototype,"_channel",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),R0=D0))||R0,e1=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),t1=Tc("cc.animation.RealTrack")(M0=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.createCurve=function(){return new c_},t}($0))||M0;function n1(e){return 0===e.keyFramesCount?void 0:e}var i1,r1,a1,o1,s1,c1,l1,u1,h1,f1,_1=["X","Y","Z","W"],d1=Tc("cc.animation.VectorTrack")((U0=function(e){function t(){var t;se(t=e.call(this)||this,"_channels",B0,re(t)),se(t,"_nComponents",z0,re(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new Z0(new c_);i.name=_1[n],t._channels[n]=i}return t}Z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[j0]=function(){switch(this._nComponents){default:case 2:return new p1(n1(this._channels[0].curve),n1(this._channels[1].curve));case 3:return new m1(n1(this._channels[0].curve),n1(this._channels[1].curve),n1(this._channels[2].curve));case 4:return new v1(n1(this._channels[0].curve),n1(this._channels[1].curve),n1(this._channels[2].curve),n1(this._channels[3].curve))}},Q(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(J0),B0=ce((F0=U0).prototype,"_channels",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),z0=ce(F0.prototype,"_nComponents",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),L0=F0))||L0,p1=function(){function e(e,t){this._result=new Yn,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||Yn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),m1=function(){function e(e,t,n){this._result=new Pn,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||Pn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),v1=function(){function e(e,t,n,i){this._result=new Zn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Zn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),g1=Tc("cc.animation.QuatTrack")(i1=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.createCurve=function(){return new Y_},n[j0]=function(){return new y1(this.channels()[0].curve)},t}($0))||i1,y1=function(){function e(e){this._result=new Fn,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),S1=["Red","Green","Blue","Alpha"],x1=Tc("cc.animation.ColorTrack")((s1=function(e){function t(){var t;se(t=e.call(this)||this,"_channels",o1,re(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new Z0(new c_);i.name=S1[n],t._channels[n]=i}return t}Z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[j0]=function(){return new E1(n1(this._channels[0].curve),n1(this._channels[1].curve),n1(this._channels[2].curve),n1(this._channels[3].curve))},t}(J0),o1=ce((a1=s1).prototype,"_channels",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r1=a1))||r1,E1=function(){function e(e,t,n,i){this._result=new In,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||In.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),T1=["Width","Height"],C1=Tc("cc.animation.SizeTrack")((h1=function(e){function t(){var t;se(t=e.call(this)||this,"_channels",u1,re(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new Z0(new c_);i.name=T1[n],t._channels[n]=i}return t}Z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[j0]=function(){return new A1(n1(this._channels[0].curve),n1(this._channels[1].curve))},t}(J0),u1=ce((l1=h1).prototype,"_channels",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),c1=l1))||c1,A1=function(){function e(e,t){this._result=new ti,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),b1=Tc("cc.animation.ObjectTrack")(f1=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.createCurve=function(){return new rd},t}($0))||f1;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:c0,MorphWeightValueProxy:l0,MorphWeightsValueProxy:u0,MorphWeightsAllValueProxy:h0,Track:J0,TrackPath:K0,RealTrack:t1,VectorTrack:d1,QuatTrack:g1,ColorTrack:x1,SizeTrack:C1,ObjectTrack:b1,isPropertyPath:B$,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:o0,ComponentPath:s0,CubicSplineVec2Value:k0,CubicSplineVec3Value:G0,CubicSplineVec4Value:H0,CubicSplineQuatValue:V0,CubicSplineNumberValue:W0}));var I1=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,a=e.length;r<a;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?D1:lc}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());l.RatioSampler=I1;var w1=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,a=Object.keys(t.easingMethods);r<a.length;r++){var o=a[r];this.types[o]=i(t.easingMethods[o])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=k1(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var a=this.types?this.types[t]:this.type,o=r-n,s=(e-n)/o;if(a&&(s=R1(s,a)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,o*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],f=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,f,s,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var _=0;_<this._array.length;++_)this._array[_]=this._values[this._array.length*t+_];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function P1(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function R1(e,t){if("string"==typeof t){var n=Jf[t];n?e=n(e):O(3906,t)}else Array.isArray(t)&&(e=W_(t,e));return e}function D1(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var a=(t=(t-i)/(r-i))/(1/n),o=0|a,s=1e-6;return a-o<s?o:o+1-a<s?o+1:~(o+1)}w1.Linear=null,l.AnimCurve=w1,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),l.sampleAnimationCurve=P1;var O1,N1,M1,L1,F1,B1,z1,U1,k1=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return un;if("object"==typeof t&&t.constructor){if(t instanceof Fn)return n=new Fn,function(e,t,i){return Fn.slerp(n,e,t,i)};if(t instanceof ct)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return un;if("function"==typeof t.lerp)return e}var n}}}(),G1=Tc("cc.animation.UntypedTrackChannel")((L1=function(e){function t(){var t;return se(t=e.call(this,new c_)||this,"property",M1,re(t)),t}return Z(t,e),t}(Z0),M1=ce((N1=L1).prototype,"property",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),O1=N1))||O1,H1=Tc("cc.animation.UntypedTrack")((U1=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_channels",z1,re(t)),t}Z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[j0]=function(e){var t=this;if(!e.getValue)throw new Error(F(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(F(3931));case i instanceof Yn:return new p1(n("x"),n("y"));case i instanceof Pn:return new m1(n("x"),n("y"),n("z"));case i instanceof Zn:return new v1(n("x"),n("y"),n("z"),n("w"));case i instanceof In:return new E1(n("r"),n("g"),n("b"),n("a"));case i instanceof ti:return new A1(n("width"),n("height"))}},n.addChannel=function(e){var t=new G1;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new d1;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var a=r.channels(),o=a[0],s=a[1],c=a[2],l=a[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",o),n("y",s)}return r;case"color":var u=new x1,h=u.channels(),f=h[0],_=h[1],d=h[2],p=h[3];return n("r",f),n("g",_),n("b",d),n("a",p),n("x",f),n("y",_),n("z",d),n("w",p),u;case"size":}return null},t}(J0),z1=ce((B1=U1).prototype,"_channels",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),F1=B1))||F1,V1=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,a=function(e,t,n){for(var i,r=new K0,a=oe(t);!(i=a()).done;){var o=i.value;"string"==typeof o?r.toProperty(o):"number"==typeof o?r.toElement(o):o instanceof o0?r.toHierarchy(o.path):o instanceof s0?r.toComponent(o.component):r.toCustomized(o)}e.path=r,e.proxy=n},o=r.map((function(e){var n=new H1;return a(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var f=new j1(s,l.length),_=function(e){a(e,r.modifiers,r.valueAdapter)},d=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return R(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return R(3933),"continue";var p=r.modifiers[0],m=o[r.commonTarget].addChannel(p).curve;d=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void R(3934);var e;if(d)e=d;else{var n=new t1;_(n),t.push(n),e=n.channel.curve}var i=h?uc.LINEAR:uc.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void f.convert(e)}if("object"==typeof u)switch(!0){default:break;case W1(c,Yn):case W1(c,Pn):case W1(c,Zn):var r=u instanceof Yn?2:u instanceof Pn?3:4,a=new d1;_(a),a.componentsCount=r;var o=a.channels(),s=o[0].curve,p=o[1].curve,m=o[2].curve,v=o[3].curve,g=h?uc.LINEAR:uc.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),f.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),f.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),f.convert(s),p.assignSorted(l,c.map((function(e){return y(e.y)}))),f.convert(p)}return void t.push(a);case W1(c,Fn):var S=new g1;_(S);var x=h?B_.SLERP:B_.CONSTANT;return S.channel.curve.assignSorted(l,c.map((function(e){return{value:Fn.clone(e),interpolationMode:x}}))),f.convertQuatCurve(S.channel.curve),void t.push(S);case W1(c,In):var E=new x1;_(E);var T=E.channels(),C=T[0].curve,A=T[1].curve,b=T[2].curve,I=T[3].curve,w=h?uc.LINEAR:uc.CONSTANT,P=function(e){return{value:e,interpolationMode:w}};return C.assignSorted(l,c.map((function(e){return P(e.r)}))),f.convert(C),A.assignSorted(l,c.map((function(e){return P(e.g)}))),f.convert(A),b.assignSorted(l,c.map((function(e){return P(e.b)}))),f.convert(b),I.assignSorted(l,c.map((function(e){return P(e.a)}))),f.convert(I),void t.push(E);case W1(c,ti):var D=new C1;_(D);var O=D.channels(),N=O[0].curve,M=O[1].curve,L=h?uc.LINEAR:uc.CONSTANT,F=function(e){return{value:e,interpolationMode:L}};return N.assignSorted(l,c.map((function(e){return F(e.width)}))),f.convert(N),M.assignSorted(l,c.map((function(e){return F(e.height)}))),f.convert(M),void t.push(D);case W1(c,W0):var B=new t1;_(B);var z=h?uc.CUBIC:uc.CONSTANT;return B.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:z}}))),void t.push(B);case W1(c,k0):case W1(c,G0):case W1(c,H0):var U=u instanceof k0?2:u instanceof G0?3:4,k=new d1;_(k),k.componentsCount=U;var G=k.channels(),H=G[0],V=G[1],W=G[2],j=G[3],X=h?uc.LINEAR:uc.CONSTANT,q=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:X}};switch(U){case 4:j.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:W.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(k);case c.every((function(e){return e instanceof V0})):R(3935)}var Y=new b1;_(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=oe(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new I1(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new w1(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},Q(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function W1(e,t){return e.every((function(e){return e instanceof t}))}var j1=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,a,o,s,c,l,u,h,f,_,d,p,m,v,g,y,S,x,E,T=this._easingMethods;if(T){var C=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(T)&&T.length;for(var A=C-1,b=0;b<A;++b){var I=T[b];I&&(Array.isArray(I)?(t=I,n=e.getKeyframeTime(b),i=e.getKeyframeValue(b),r=e.getKeyframeTime(b+1),a=e.getKeyframeValue(b+1),o=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,f=void 0,_=void 0,d=void 0,p=void 0,m=void 0,v=void 0,g=void 0,y=void 0,S=void 0,x=void 0,E=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,f=3*(r-n),_=3*(a.value-h),m=(1-l)*f,v=(1-u)*_,g=1/3,y=(p=c*_)/(d=s*f),S=Math.sqrt(d*d+p*p)*g,x=v/m,E=Math.sqrt(m*m+v*v)*g,i.interpolationMode=uc.CUBIC,i.tangentWeightMode=(o=i.tangentWeightMode)===fc.NONE?fc.RIGHT:o===fc.LEFT?fc.BOTH:o,i.rightTangent=y,i.rightTangentWeight=S,a.tangentWeightMode=function(e){return e===fc.NONE?fc.LEFT:e===fc.RIGHT?fc.BOTH:e}(a.tangentWeightMode),a.leftTangent=x,a.leftTangentWeight=E):X1(I,e,b))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var a=t[r];a&&(Array.isArray(a)?e.getKeyframeValue(r).easingMethod=a.slice():q1(a,e,r))}}}},Q(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function X1(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=T2[e];r===Qf.CONSTANT?i.interpolationMode=uc.CONSTANT:(i.interpolationMode=uc.LINEAR,i.easingMethod=r)}function q1(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=T2[e];i.easingMethod=r}var Y1,K1,Q1,J1,Z1,$1,e2,t2,n2,i2,r2,a2,o2,s2,c2,l2,u2,h2,f2,_2,d2,p2,m2,v2,g2,y2,S2,x2,E2,T2={constant:Qf.CONSTANT,linear:Qf.LINEAR,quadIn:Qf.QUAD_IN,quadOut:Qf.QUAD_OUT,quadInOut:Qf.QUAD_IN_OUT,quadOutIn:Qf.QUAD_OUT_IN,cubicIn:Qf.CUBIC_IN,cubicOut:Qf.CUBIC_OUT,cubicInOut:Qf.CUBIC_IN_OUT,cubicOutIn:Qf.CUBIC_OUT_IN,quartIn:Qf.QUART_IN,quartOut:Qf.QUART_OUT,quartInOut:Qf.QUART_IN_OUT,quartOutIn:Qf.QUART_OUT_IN,quintIn:Qf.QUINT_IN,quintOut:Qf.QUINT_OUT,quintInOut:Qf.QUINT_IN_OUT,quintOutIn:Qf.QUINT_OUT_IN,sineIn:Qf.SINE_IN,sineOut:Qf.SINE_OUT,sineInOut:Qf.SINE_IN_OUT,sineOutIn:Qf.SINE_OUT_IN,expoIn:Qf.EXPO_IN,expoOut:Qf.EXPO_OUT,expoInOut:Qf.EXPO_IN_OUT,expoOutIn:Qf.EXPO_OUT_IN,circIn:Qf.CIRC_IN,circOut:Qf.CIRC_OUT,circInOut:Qf.CIRC_IN_OUT,circOutIn:Qf.CIRC_OUT_IN,elasticIn:Qf.ELASTIC_IN,elasticOut:Qf.ELASTIC_OUT,elasticInOut:Qf.ELASTIC_IN_OUT,elasticOutIn:Qf.ELASTIC_OUT_IN,backIn:Qf.BACK_IN,backOut:Qf.BACK_OUT,backInOut:Qf.BACK_IN_OUT,backOutIn:Qf.BACK_OUT_IN,bounceIn:Qf.BOUNCE_IN,bounceOut:Qf.BOUNCE_OUT,bounceInOut:Qf.BOUNCE_IN_OUT,bounceOutIn:Qf.BOUNCE_OUT_IN,smooth:Qf.SMOOTH,fade:Qf.FADE};function C2(){throw new Error("split() only valid in Editor.")}Tc("cc.animation.ExoticAnimation")((Q1=function(){function e(){se(this,"_nodeAnimations",K1,this)}var t=e.prototype;return t.createEvaluator=function(e){return new M2(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new A2(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return C2()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),K1=ce((Y1=Q1).prototype,"_nodeAnimations",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Y1));var A2=Tc("cc.animation.ExoticNodeAnimation")((i2=function(){function e(e){se(this,"_path",$1,this),se(this,"_position",e2,this),se(this,"_rotation",t2,this),se(this,"_scale",n2,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new D2(e,new P2(t))},t.createRotation=function(e,t){this._rotation=new D2(e,new R2(t))},t.createScale=function(e,t){this._scale=new D2(e,new P2(t))},t.createEvaluator=function(e){return new L2(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return C2()},t.toHashString=function(){var e,t,n,i,r,a;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(a=this._rotation)||void 0===a?void 0:a.toHashString())&&void 0!==r?r:"")},Q(e,[{key:"path",get:function(){return this._path}}]),e}(),$1=ce((Z1=i2).prototype,"_path",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),e2=ce(Z1.prototype,"_position",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),t2=ce(Z1.prototype,"_rotation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n2=ce(Z1.prototype,"_scale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J1=Z1))||J1;function b2(e){return e.toPrecision(2)}function I2(e){return e.map(b2).join(" ")}var w2=Tc("cc.animation.ExoticVectorLikeTrackValues")((c2=function(){function e(e){se(this,"_values",o2,this),se(this,"_isQuantized",s2,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=B2[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),a=Math.max(e,a)}));var o=a-r,s=n.from(e,(function(e){return(e-r)/o*i}));return new Z2(z2(e),s,o,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():I2(t))},Q(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:z2(this._values)}}]),e}(),o2=ce((a2=c2).prototype,"_values",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),s2=ce(a2.prototype,"_isQuantized",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r2=a2))||r2,P2=Tc("cc.animation.ExoticVec3TrackValues")(l2=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?t4(n,e,t):Pn.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,a){var o=this._values;this._isQuantized?(t4(o,e,i),t4(o,t,r)):(Pn.fromArray(i,o,3*e),Pn.fromArray(r,o,3*t)),Pn.lerp(a,i,r,n)},t}(w2))||l2,R2=Tc("cc.animation.ExoticQuatTrackValues")(u2=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?n4(n,e,t):Fn.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,a){var o=this._values;this._isQuantized?(n4(o,e,i),n4(o,t,r)):(Fn.fromArray(i,o,4*e),Fn.fromArray(r,o,4*t)),Fn.slerp(a,i,r,n)},t}(w2))||u2,D2=Tc("cc.animation.ExoticTrack")((p2=function(){function e(e,t){se(this,"times",_2,this),se(this,"values",d2,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+I2(e)+"; values: "+t.toHashString()},e}(),_2=ce((f2=p2).prototype,"times",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),d2=ce(f2.prototype,"values",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),h2=f2))||h2;function O2(e,t){e.length,e.length;var n=0,i=0,r=lc(e,t);if(r>=0)n=r;else{var a=~r,o=a-1;n=o;var s=e[a],c=e[o];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],a=e[i-1],o=cn(t,r,a),s=cn(n,r,a);this._timeOffset=o;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=O2(e,t),a=r.index,o=r.ratio,s=O2(e,n);return{fromIndex:a,fromRatio:o,toIndex:s.index,toRatio:s.ratio}}(e,o,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,f=c.toRatio,_=!u,d=!f;l!==h||u!==f?(_||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=_?l:l+1,this.directKeyframesEnd=h+1,d||(this.postLerpIndex=h,this.postLerpRatio=f)):_?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},Q(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var N2,M2=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),L2=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=e4(t.times,t.values,Pn,e,"position",r)),n&&(this._rotation=e4(n.times,n.values,Fn,e,"rotation",r)),i&&(this._scale=e4(i.times,i.values,Pn,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),F2=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],a=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>a)n.just=!0,n.index=i-1;else{var o=lc(e,t);if(o>=0)n.just=!0,n.index=o;else{var s=~o,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),B2={uint8:Uint8Array,uint16:Uint16Array};function z2(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return N2.FLOAT_32;case 8:return N2.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(N2||(N2={}));var U2,k2,G2,H2,V2,W2,j2,X2,q2,Y2,K2,Q2,J2,Z2=Tc("cc.animation.QuantizedFloatArray")((E2=function(){function e(e,t,n,i){void 0===i&&(i=0),se(this,"originalPrecision",g2,this),se(this,"min",y2,this),se(this,"extent",S2,this),se(this,"values",x2,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+b2(t)+" "+b2(n)+" "+i.join(" ")},Q(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),g2=ce((v2=E2).prototype,"originalPrecision",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),y2=ce(v2.prototype,"min",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),S2=ce(v2.prototype,"extent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),x2=ce(v2.prototype,"values",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),m2=v2))||m2;function $2(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function e4(e,t,n,i,r,a){var o=new Q0;o.path=(new K0).toHierarchy(i).toProperty(r);var s=a(o);return s?{runtimeBinding:s,evaluator:new F2(e,t,n)}:null}function t4(e,t,n){Pn.set(n,$2(e,3*t+0),$2(e,3*t+1),$2(e,3*t+2))}function n4(e,t,n){Fn.set(n,$2(e,4*t+0),$2(e,4*t+1),$2(e,4*t+2),$2(e,4*t+3))}function i4(){return l.director.getAnimationManager()}var r4=Symbol("SearchForRootBonePath"),a4=Symbol("ExoticAnimation"),o4=e("AnimationClip",Tc("cc.AnimationClip")((J2=Q2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"sample",G2,re(t)),se(t,"speed",H2,re(t)),se(t,"wrapMode",V2,re(t)),se(t,"enableTrsBlending",W2,re(t)),se(t,"_duration",j2,re(t)),se(t,"_hash",X2,re(t)),t.frameRate=0,se(t,"_tracks",q2,re(t)),se(t,"_exoticAnimation",Y2,re(t)),t._legacyData=void 0,t._legacyDataDirty=!1,se(t,"_events",K2,re(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}Z(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,a=new b1;return a.path=(new K0).toComponent("cc.Sprite").toProperty("spriteFrame"),a.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(a),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new d4(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){if(!e.mask||!i.isMaskedOff(e.mask)){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=l.director.root)||void 0===t?void 0:t.dataPoolManager)&&l.director.root.dataPoolManager.releaseAnimationClip(this),eZ.destroy(this),e.prototype.destroy.call(this)},n[$J]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),a=r.length,o={},s=0;s<a;++s)o[r[s]]={transforms:Array.from({length:n},(function(){return new Wn}))};var c=r.reduce((function(e,t){return e[t]=new l4,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var f=l.substring(0,h),_=c[f];_&&(u.parent=_)}}for(var d=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return _4(n,t.property)}}),void 0),p=0;p<n;++p){var m=e+i*p;d.evaluate(m);for(var v=0;v<a;++v){var g=r[v];Wn.copy(o[g].transforms[p],c[g].globalTransform)}for(var y=0;y<a;++y){var S=r[y];c[S].invalidate()}}return{samples:t,frames:n,joints:o}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,a=0;a<r;++a){var o=i[a];if(o instanceof H1){var s=o.upgrade(e);s&&(t.push(s),n.push(o))}}for(var c=n.length,l=0;l<c;++l)tt.remove(i,n[l]);i.push.apply(i,t)},n[r4]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var a,o=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[Y0]);if(h){var f=u[j0](h);o.push({binding:h,trackEval:f})}}}return this._exoticAnimation&&(a=this._exoticAnimation.createEvaluator(t)),new s4(o,a,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof ib){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var a=new c4,o=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[Y0].parseTrsPath();if(h&&h.node===i){n.push(u);var f=_4(a,h.property);if(f){var _=u[j0](f);o.push({binding:f,trackEval:_})}}}return new h4(r,this._duration,a,o)}R(3924)}else R(3923)}else O(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[Y0].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,a=t+1;a<n;++a){var o=e[a];if(o.rank!==i.rank)break;if(o.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new V1(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][Y0].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var a=this._exoticAnimation.collectAnimatedJoints(),o=a.length,s=0;s<o;++s)e.add(a[s]);return Array.from(e)},Q(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=Sa(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),a=r.length,o=function(e){var a=r[e],o=a.frame/t._duration,s=n.findIndex((function(e){return e===o}));s<0&&(s=n.length,n.push(o),i.push({events:[]})),i[s].events.push({functionName:a.func,parameters:a.params})},s=0;s<a;++s)o(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:a4,get:function(){return this._exoticAnimation}},{key:a4,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(wu),Q2.WrapMode=nc,G2=ce((k2=J2).prototype,"sample",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),H2=ce(k2.prototype,"speed",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),V2=ce(k2.prototype,"wrapMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nc.Normal}}),W2=ce(k2.prototype,"enableTrsBlending",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),j2=ce(k2.prototype,"_duration",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X2=ce(k2.prototype,"_hash",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),q2=ce(k2.prototype,"_tracks",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Y2=ce(k2.prototype,"_exoticAnimation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),K2=ce(k2.prototype,"_events",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),U2=k2))||U2);l.AnimationClip=o4;var s4=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var a=t[r],o=a.trackEval,s=a.binding,c=o.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),c4=function(){function e(){this.position=new Pn,this.scale=new Pn(1,1,1),this.rotation=new Fn,this.eulerAngles=new Pn}return e.prototype.getTransform=function(e){Wn.fromRTS(e,this.rotation,this.position,this.scale)},e}(),l4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new Wn,t}return Z(t,e),t.prototype.invalidate=function(){this._dirty=!0},Q(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,Wn.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&Wn.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(c4),u4=new Wn,h4=function(){function e(e,t,n,i){this._initialTransformCache=new Wn,this._clipEndTransformCache=new Wn,this._startTransformCache=new Wn,this._endTransformCache=new Wn,this._motionTransformCache=new Wn,this._translationMotionCache=new Pn,this._rotationMotionCache=new Fn,this._scaleMotionCache=new Pn,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,a=this._scaleMotionCache,o=this._rootBone;Wn.toRTS(n,r,i,a),Pn.add(i,i,o.position),o.setPosition(i),Fn.multiply(r,r,o.rotation),o.setRotation(r),Pn.multiply(a,a,o.scale),o.setScale(a)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,a=this._evaluateAt(e,this._startTransformCache);if(t<r){var o=this._evaluateAt(e+t,this._endTransformCache);f4(n,a,o)}else{Wn.identity(n);var s=function(e,t){f4(u4,e,t),Wn.multiply(n,n,u4)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),f=this._evaluateAt(i,this._clipEndTransformCache),_=this._evaluateAt(u,this._endTransformCache);s(a,f),f4(u4,h,f);for(var d=0;d<l;++d)Wn.multiply(n,n,u4);s(h,_)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var a=n[r],o=a.trackEval,s=a.binding,c=o.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function f4(e,t,n){Wn.invert(e,t),Wn.multiply(e,n,e)}function _4(e,t){switch(t){default:return;case"position":return{setValue:function(t){Pn.copy(e.position,t)}};case"rotation":return{setValue:function(t){Fn.copy(e.rotation,t)}};case"scale":return{setValue:function(t){Pn.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){Pn.copy(e.eulerAngles,t)}}}}var d4=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=m4(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=m4(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var a=this._wrapMode,o=p4(n),s=p4(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&o!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((a&tc.PingPong)===tc.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((a&tc.PingPong)===tc.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>o)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?i4().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,a=0;a<r;++a)for(var o=n.events[a],s=o.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,o.parameters)}}},e}();function p4(e){return e-(0|e)==0&&(e-=1),0|e}function m4(e,t){return lc(t,e)}var v4,g4=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new y4(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=this.createNodeBlendState(),this._nodeBlendStates.set(e,n)),n.refProperty(e,t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),y4=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},Q(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}();!function(e){e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.EULER_ANGLES=8]="EULER_ANGLES"}(v4||(v4={}));var S4,x4,E4,T4=v4.POSITION|v4.ROTATION|v4.SCALE|v4.EULER_ANGLES,C4=function(){function e(){this.refCount=0,this.accumulatedWeight=0,this.result=new Pn}var t=e.prototype;return t.blend=function(e,t){this.accumulatedWeight=O4(this.result,this.result,this.accumulatedWeight,e,t)},t.reset=function(){this.accumulatedWeight=0,Pn.zero(this.result)},e}(),A4=function(){function e(){this.refCount=0,this.accumulatedWeight=0,this.result=new Fn}var t=e.prototype;return t.blend=function(e,t){this.accumulatedWeight=N4(this.result,this.result,this.accumulatedWeight,e,t)},t.reset=function(){this.accumulatedWeight=0,Fn.identity(this.result)},e}(),b4=function(){function e(){this._transformApplyFlags=0,this._properties={}}var t=e.prototype;return t.refProperty=function(e,t){var n,i,r,a=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":r=null!==(n=a[t])&&void 0!==n?n:a[t]=this._createVec3BlendState(e[t]);break;case"rotation":r=null!==(i=a[t])&&void 0!==i?i:a[t]=this._createQuatBlendState(e.rotation)}return++r.refCount,r},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._transformApplyFlags,a=this._properties,o=a.position,s=a.scale,c=a.rotation,l=a.eulerAngles;r&&(o&&r&v4.POSITION&&(t=o.result),s&&r&v4.SCALE&&(n=s.result),l&&r&v4.EULER_ANGLES&&(i=l.result),c&&r&v4.ROTATION&&(i=c.result),(i||t||n)&&e.setRTS(i,t,n),this._transformApplyFlags=0)},Q(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),I4=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.apply=function(t){var n=this._properties,i=n.position,r=n.scale,a=n.rotation,o=n.eulerAngles;i&&i.accumulatedWeight&&(this._transformApplyFlags|=v4.POSITION,i.accumulatedWeight<1&&i.blend(t.position,1-i.accumulatedWeight)),r&&r.accumulatedWeight&&(this._transformApplyFlags|=v4.SCALE,r.accumulatedWeight<1&&r.blend(t.scale,1-r.accumulatedWeight)),o&&o.accumulatedWeight&&(this._transformApplyFlags|=v4.EULER_ANGLES,o.accumulatedWeight<1&&o.blend(t.eulerAngles,1-o.accumulatedWeight)),a&&a.accumulatedWeight&&(this._transformApplyFlags|=v4.ROTATION,a.accumulatedWeight<1&&a.blend(t.rotation,1-a.accumulatedWeight)),e.prototype.apply.call(this,t),null==i||i.reset(),null==r||r.reset(),null==a||a.reset(),null==o||o.reset()},n._createVec3BlendState=function(){return new C4},n._createQuatBlendState=function(){return new A4},t}(b4),w4=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.createNodeBlendState=function(){return new I4},t}(g4),P4=function(){function e(e){this.refCount=0,this.result=new Pn,this._defaultValue=new Pn,this._clipBlendResult=new Pn,this._accumulatedWeight=0,Pn.copy(this._defaultValue,e),Pn.copy(this.result,e)}var t=e.prototype;return t.blend=function(e,t){this._accumulatedWeight=O4(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)},t.commitLayerChange=function(e){var t=this.result,n=this._clipBlendResult,i=this._accumulatedWeight;i<1&&this.blend(this._defaultValue,1-i),Pn.lerp(t,t,n,e),Pn.zero(this._clipBlendResult),this._accumulatedWeight=0},t.reset=function(){Pn.copy(this.result,this._defaultValue)},e}(),R4=function(){function e(e){this.refCount=0,this.result=new Fn,this._defaultValue=new Fn,this._clipBlendResult=new Fn,this._accumulatedWeight=0,Fn.copy(this._defaultValue,e),Fn.copy(this.result,e)}var t=e.prototype;return t.blend=function(e,t){this._accumulatedWeight=N4(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)},t.commitLayerChange=function(e){var t=this.result,n=this._clipBlendResult,i=this._accumulatedWeight;i<1&&this.blend(this._defaultValue,1-i),Fn.slerp(t,t,n,e),Fn.identity(this._clipBlendResult),this._accumulatedWeight=0},t.reset=function(){Fn.copy(this.result,this._defaultValue)},e}(),D4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._layerMask=-1>>>0,t}Z(t,e);var n=t.prototype;return n.setLayerMask=function(e){this._layerMask&=~(1<<e)},n.commitLayerChanges=function(e,t){if(this._layerMask&1<<e){var n=this._properties,i=n.position,r=n.scale,a=n.rotation,o=n.eulerAngles;i&&i.commitLayerChange(t),r&&r.commitLayerChange(t),a&&a.commitLayerChange(t),o&&o.commitLayerChange(t)}},n.apply=function(t){this._transformApplyFlags=T4,e.prototype.apply.call(this,t);var n=this._properties,i=n.position,r=n.scale,a=n.rotation,o=n.eulerAngles;null==i||i.reset(),null==r||r.reset(),null==a||a.reset(),null==o||o.reset()},n._createVec3BlendState=function(e){return new P4(e)},n._createQuatBlendState=function(e){return new R4(e)},t}(b4);function O4(e,t,n,i,r){var a=n+r;if(1!==r||n){if(a){var o=r/a;Pn.lerp(e,e,i,o)}}else Pn.copy(e,i);return a}function N4(e,t,n,i,r){var a=n+r;if(1!==r||n){if(a){var o=r/a;Fn.slerp(e,t,i,o)}}else Fn.copy(e,i);return a}!function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;n.setMask=function(e,t){this._nodeBlendStates.forEach((function(n,i){t.has(i)&&n.setLayerMask(e)}))},n.commitLayerChanges=function(e,t){this._nodeBlendStates.forEach((function(n){n.commitLayerChanges(e,t)}))},n.createNodeBlendState=function(){return new D4}}(g4);var M4=e("AnimationManager",Tc((E4=x4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new le([]),t._crossFades=new le([]),t._delayEvents=[],t._blendStateBuffer=new w4,t._sockets=[],t}Z(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):O(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(e);var a=this._anims,o=a.array;for(a.i=0;a.i<o.length;++a.i){var s=o[a.i];s.isMotionless||s.update(e)}this._blendStateBuffer.apply();for(var c=l.director.getTotalFrames(),u=0,h=i.length;u<h;u++){var f=i[u],_=f.target,d=f.transform;_.matrix=mZ(d,c)}for(var p=0,m=t.length;p<m;p++){var v=t[p];v.fn.apply(v.thisArg,v.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):O(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var a=e.getChildByPath(r.path),o=r.target&&a&&vZ(a,e);o&&n._sockets.push({target:r.target,transform:o})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var a=this._sockets[r];if(a.target===i.target){gZ(a.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},Q(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(HO),x4.ID="animation",S4=E4))||S4);nN.on(tN.EVENT_INIT,(function(){var e=new M4;nN.registerSystem(M4.ID,e,HO.Priority.HIGH)})),l.AnimationManager=M4;var L4,F4=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(F(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},Q(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),B4=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(L4||(L4={})),st(L4);var z4=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=nc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new cc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||T("Clip "+t.name+" has zero duration."),i}Z(t,e);var n=t.prototype;return n.initialize=function(e,t,n){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var i=this._clip;if(this.duration=i.duration,this._invDuration=1/this.duration,this.speed=i.speed,this.wrapMode=i.wrapMode,this.frameRate=i.sample,this._playbackRange.min=0,this._playbackRange.max=i.duration,this._playbackDuration=i.duration,(this.wrapMode&tc.Loop)===tc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,a,o,s=null!==(r=null!=t?t:null===(a=i4())||void 0===a?void 0:a.blendState)&&void 0!==r?r:null;s&&(this._poseOutput=new B4(s)),this._clipEval=i.createEvaluator({target:e,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0,mask:n})}this._clipEventEval=i.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||i4().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i4().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(L4.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(L4.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(L4.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(L4.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new cc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(L4.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(L4.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(L4.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&tc.PingPong)===tc.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&tc.Reverse)===tc.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new cc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,a=this.repeatCount,o=(e-=n)>0?e/i:-e/i;if(o>=a){o=a,r=!0;var s=a-(0|a);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&tc.ShouldWrap;u&&(l=this._needReverse(o));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=o,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){i4().addAnimation(this)},n._onPauseOrStop=function(){i4().removeAnimation(this)},Q(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&tc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&tc.ShouldWrap,n=(this.wrapMode&tc.Reverse)===tc.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(F4));l.AnimationState=z4;var U4,k4,G4,H4,V4,W4,j4,X4,q4,Y4,K4,Q4,J4,Z4,$4,e3,t3,n3,i3,r3,a3=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:i4(),n}Z(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var a=1,o=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:ln(c.easeTime/c.easeDuration),u=l*a;if(a*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){o=s+1,c.easeTime=c.easeDuration;break}}if(o!==n.length){for(var h=o;h<n.length;++h){var f=n[h];--f.target.reference,f.target.reference<=0&&(f.target.state&&f.target.state.stop(),fe(this._managedStates,f.target))}n.splice(o)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(F4),o3=function(t){return e({Animation:t,AnimationComponent:t}),t}((U4=Tc("cc.Animation"),k4=Gc(),G4=Ac(99),H4=Bc(),V4=al([o4]),W4=Xc(),j4=al(o4),X4=Xc(),q4=Xc(),Y4=al([o4]),U4(K4=k4(K4=G4(K4=Fc(K4=H4((t3=e3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",J4,re(t)),t._crossFade=new a3,t._nameToState=Ie(!0),se(t,"_clips",Z4,re(t)),se(t,"_defaultClip",$4,re(t)),t._hasBeenPlayed=!1,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=Ie(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&this.doPlayOrCrossFade(n,t)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return _e(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void R(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void R(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var a=e.prototype.on.call(this,t,n,i,r);return t===L4.LASTFRAME&&this._syncAllowLastFrameEvent(),a},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===L4.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===L4.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new z4(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(L4.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];s3(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(L4.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(L4.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},Q(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=oe(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var a,o=oe(e);!(a=o()).done;){var s=a.value;s&&this.createState(s)}var c=e.find((function(e){return s3(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return s3(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}($l(Ku)),e3.EventType=L4,ce((Q4=t3).prototype,"clips",[V4,W4],Object.getOwnPropertyDescriptor(Q4.prototype,"clips"),Q4.prototype),ce(Q4.prototype,"defaultClip",[j4,X4],Object.getOwnPropertyDescriptor(Q4.prototype,"defaultClip"),Q4.prototype),J4=ce(Q4.prototype,"playOnLoad",[Dc,q4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Z4=ce(Q4.prototype,"_clips",[Y4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$4=ce(Q4.prototype,"_defaultClip",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),K4=Q4))||K4)||K4)||K4)||K4)||K4));function s3(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}l.Animation=o3,l.AnimationComponent=o3,nt.setClassAlias(o3,"cc.AnimationComponent"),l.easing=Jf,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(n3||(n3={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(i3||(i3={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(r3||(r3={}));var c3,l3=0;function u3(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(t.args)).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&u3(e,n)})).catch((function(){})))}function h3(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=l3++,a=e;a._operationQueue.push({id:r,func:i,args:n,invoking:!1}),a._eventTarget.once(r.toString(),t),u3(a,a._operationQueue[0])}))}}function f3(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var _3,d3,p3=function(){function e(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=e,e.volume=t}var t=e.prototype;return t.play=function(){var e=this;f3(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))},t.stop=function(){this._domAudio.pause()},Q(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}}]),e}(),m3=(ce((c3=function(){function e(e){var t=this;this._domAudio=void 0,this._state=r3.INIT,this._onEnded=void 0,this._eventTarget=new ou,this._operationQueue=[],this._domAudio=e,hu.on("hide",this._onHide,this),hu.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch((function(){})),t._state=r3.INIT,t._eventTarget.emit(n3.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var t=e.prototype;return t.destroy=function(){hu.off("hide",this._onHide,this),hu.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";hu.os===iu.IOS?r="loadedmetadata":hu.browserType===eu.FIREFOX&&(r="canplay");var a=setTimeout((function(){0===i.readyState?c():s()}),8e3),o=function(){clearTimeout(a),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){o(),t(i)},c=function(){o(),n("load audio failure - "+e)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new p3(e,n);i(t)})).catch(r)}))},t._onHide=function(){var e=this;this._state===r3.PLAYING&&this.pause().then((function(){e._state=r3.INTERRUPTED,e._eventTarget.emit(n3.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===r3.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(n3.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){return e=cn(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},t.play=function(){var e=this;return new Promise((function(t){f3(e._domAudio).then((function(){e._state=r3.PLAYING,t()})).catch((function(){}))}))},t.pause=function(){return this._domAudio.pause(),this._state=r3.PAUSED,Promise.resolve()},t.stop=function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=r3.STOPPED,t()}))},t.onInterruptionBegin=function(e){this._eventTarget.on(n3.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(n3.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(n3.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(n3.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(n3.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(n3.ENDED,e)},Q(e,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return i3.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=ln(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),e}()).prototype,"seek",[h3],Object.getOwnPropertyDescriptor(c3.prototype,"seek"),c3.prototype),ce(c3.prototype,"play",[h3],Object.getOwnPropertyDescriptor(c3.prototype,"play"),c3.prototype),ce(c3.prototype,"pause",[h3],Object.getOwnPropertyDescriptor(c3.prototype,"pause"),c3.prototype),ce(c3.prototype,"stop",[h3],Object.getOwnPropertyDescriptor(c3.prototype,"stop"),c3.prototype),c3),v3=function(){function e(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e}var t=e.prototype;return t.destroy=function(){this._nativeAudio=void 0},t._now=function(){return performance.now()/1e3},t._calculateCurrentTime=function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration},t.start=function(){this._isPaused=!1,this._startTime=this._now()},t.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},t.stop=function(){this._isPaused=!0,this._startOffset=0},t.seek=function(e){this._startTime=this._now(),this._startOffset=cn(e,0,this.duration)},Q(e,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),e}(),g3=new(function(){function e(){this._audioBufferDataMap={}}var t=e.prototype;return t.addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},t.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},t.getCache=function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer},t.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},e}()),y3=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,S3=function(){function e(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var t=e.prototype;return t.decodeAudioData=function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))},t.runContext=function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))},t.createBufferSource=function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n},t.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},t.setGainValue=function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t},t.connectContext=function(e){this._context&&e.connect(this._context.destination)},Q(e,[{key:"currentTime",get:function(){return this._context.currentTime}}]),e}();S3.support=!!y3,S3.support&&(d3=new S3);var x3,E3,T3,C3,A3,b3=function(){function e(e,t,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=n,this._bufferSourceNode=d3.createBufferSource(e,!1);var i=d3.createGain(t);this._bufferSourceNode.connect(i),d3.connectContext(i)}var t=e.prototype;return t.play=function(){var e=this;this._bufferSourceNode.start(),d3.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;g3.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))},t.stop=function(){clearTimeout(this._currentTimer),g3.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},Q(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]),e}(),I3=(ce((_3=function(){function e(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=r3.INIT,this._audioTimer=void 0,this._eventTarget=new ou,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new v3(e),this._gainNode=d3.createGain(),d3.connectContext(this._gainNode),this._src=t,hu.on("hide",this._onHide,this),hu.on("show",this._onShow,this)}var t=e.prototype;return t.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),g3.tryReleasingCache(this._src),hu.off("hide",this._onHide,this),hu.off("show",this._onShow,this)},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=g3.getCache(e);if(i)return g3.retainCache(e),void t(i);var r=new XMLHttpRequest,a="load audio failed: "+e+", status: ";r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?d3.decodeAudioData(r.response).then((function(n){g3.addCache(e,n),t(n)})).catch((function(){})):n(new Error(""+a+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+a+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+a+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+a+r.status+"(abort)"))},r.send(null)}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new b3(e,n,t);i(r)})).catch(r)}))},t._onHide=function(){var e=this;this._state===r3.PLAYING&&this.pause().then((function(){e._state=r3.INTERRUPTED,e._eventTarget.emit(n3.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===r3.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(n3.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===r3.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))},t.play=function(){return this._doPlay()},t._doPlay=function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=d3.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),d3.runContext().then((function(){e._state=r3.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(n3.ENDED),e._state=r3.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))},t._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}},t.pause=function(){return this._state===r3.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=r3.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=r3.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.onInterruptionBegin=function(e){this._eventTarget.on(n3.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(n3.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(n3.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(n3.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(n3.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(n3.ENDED,e)},Q(e,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return i3.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=ln(e),this._volume=e,d3.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),e}()).prototype,"seek",[h3],Object.getOwnPropertyDescriptor(_3.prototype,"seek"),_3.prototype),ce(_3.prototype,"play",[h3],Object.getOwnPropertyDescriptor(_3.prototype,"play"),_3.prototype),ce(_3.prototype,"pause",[h3],Object.getOwnPropertyDescriptor(_3.prototype,"pause"),_3.prototype),ce(_3.prototype,"stop",[h3],Object.getOwnPropertyDescriptor(_3.prototype,"stop"),_3.prototype),_3),w3=function(){function e(e){this._audio=void 0,this._audio=e}var t=e.prototype;return t.play=function(){this._audio.play()},t.stop=function(){this._audio.stop()},Q(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),e}(),P3=function(){function e(e){this._player=void 0,this._player=e}e.load=function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==i3.DOM_AUDIO&&S3.support?I3.load(t).then((function(t){i(new e(t))})).catch((function(){})):(S3.support||R(5201),m3.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))};var t=e.prototype;return t.destroy=function(){this._player.destroy()},e.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==i3.DOM_AUDIO&&S3.support?I3.loadNative(e):(S3.support||R(5201),m3.loadNative(e))},e.loadOneShotAudio=function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==i3.DOM_AUDIO&&S3.support?I3.loadOneShotAudio(e,t).then((function(e){i(new w3(e))})).catch(r):(S3.support||R(5201),m3.loadOneShotAudio(e,t).then((function(e){i(new w3(e))})).catch(r))}))},t.seek=function(e){return this._player.seek(e)},t.play=function(){return this._player.play()},t.pause=function(){return this._player.pause()},t.stop=function(){return this._player.stop()},t.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},t.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},t.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},t.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},t.onEnded=function(e){this._player.onEnded(e)},t.offEnded=function(e){this._player.offEnded(e)},Q(e,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),e}();P3.maxAudioChannel=24;var R3=e("AudioClip",Tc("cc.AudioClip")((A3=C3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_duration",T3,re(t)),t._loadMode=i3.UNKNOWN_AUDIO,t._meta=null,t._player=null,t}Z(t,e);var n=t.prototype;return n.destroy=function(){var t,n=e.prototype.destroy.call(this);return null===(t=this._player)||void 0===t||t.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))},n.setVolume=function(e){this._player&&(this._player.volume=e)},n.setLoop=function(e){this._player&&(this._player.loop=e)},n.play=function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))},n.pause=function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))},n.stop=function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))},n.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&P3.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))},Q(t,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=i3.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:r3.INIT}}]),t}(wu),C3.AudioType=i3,T3=ce((E3=A3).prototype,"_duration",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ce(E3.prototype,"_nativeDep",[sl],Object.getOwnPropertyDescriptor(E3.prototype,"_nativeDep"),E3.prototype),x3=E3))||x3);function D3(e,t,n){P3.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function O3(e,t,n,i){var r=new R3;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}l.AudioClip=R3,XN.register({".mp3":D3,".ogg":D3,".wav":D3,".m4a":D3}),$N.register({".mp3":O3,".ogg":O3,".wav":O3,".m4a":O3});var N3,M3,L3,F3,B3,z3,U3,k3,G3,H3,V3,W3,j3,X3,q3,Y3,K3,Q3,J3,Z3=new(function(){function e(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var t=e.prototype;return t._findIndex=function(e,t){return e.findIndex((function(e){return e.audio===t}))},t._tryAddPlaying=function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},t.addPlaying=function(e){if(e instanceof P3){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)},t._tryRemovePlaying=function(e,t){var n=this._findIndex(e,t);return-1!==n&&(he(e,n),!0)},t.removePlaying=function(e){if(e instanceof P3){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)},t.discardOnePlayingIfNeeded=function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<P3.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))},e}());!function(e){e.STARTED="started",e.ENDED="ended"}(J3||(J3={}));var $3=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((N3=Tc("cc.AudioSource"),M3=Gc(),L3=Bc(),F3=al(R3),B3=al(R3),z3=Xc(),U3=Xc(),k3=Xc(),G3=qc(),H3=Xc(),N3(V3=M3(V3=L3((Q3=K3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_clip",j3,re(t)),t._player=null,se(t,"_loop",X3,re(t)),se(t,"_playOnAwake",q3,re(t)),se(t,"_volume",Y3,re(t)),t._cachedCurrentTime=0,t._operationsBeforeLoading=[],t._isLoaded=!1,t._lastSetClip=null,t}Z(t,e);var n=t.prototype;return n._syncPlayer=function(){var e=this,t=this._clip;this._isLoaded=!1,this._lastSetClip!==t&&(t?t._nativeAsset?(this._lastSetClip=t,P3.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t?(e._isLoaded=!0,e._player&&(Z3.removePlaying(e._player),e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){Z3.removePlaying(n),e.node.emit(J3.ENDED,e)})),n.onInterruptionBegin((function(){Z3.removePlaying(n)})),n.onInterruptionEnd((function(){Z3.addPlaying(n)})),e._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()},n.onDestroy=function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy(),this._player=null},n._getRootNode=function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,a,o;i=null===(a=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===a||null===(o=a.parent)||void 0===o?void 0:o.parent}return n},n.play=function(){var e,t,n=this;this._isLoaded?(Z3.discardOnePlayingIfNeeded(),this.state===r3.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){Z3.addPlaying(n._player),n.node.emit(J3.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){Z3.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){Z3.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?P3.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){Z3.discardOnePlayingIfNeeded(),e.onPlay=function(){Z3.addPlaying(e)},e.onEnd=function(){Z3.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))},Q(t,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=cn(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=cn(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.duration:0}},{key:"state",get:function(){return this._player?this._player.state:r3.INIT}},{key:"playing",get:function(){return this.state===t.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return P3.maxAudioChannel}}]),t}(Ku),K3.AudioState=r3,K3.EventType=J3,j3=ce((W3=Q3).prototype,"_clip",[F3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X3=ce(W3.prototype,"_loop",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q3=ce(W3.prototype,"_playOnAwake",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y3=ce(W3.prototype,"_volume",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ce(W3.prototype,"clip",[B3,z3],Object.getOwnPropertyDescriptor(W3.prototype,"clip"),W3.prototype),ce(W3.prototype,"loop",[U3],Object.getOwnPropertyDescriptor(W3.prototype,"loop"),W3.prototype),ce(W3.prototype,"playOnAwake",[k3],Object.getOwnPropertyDescriptor(W3.prototype,"playOnAwake"),W3.prototype),ce(W3.prototype,"volume",[G3,H3],Object.getOwnPropertyDescriptor(W3.prototype,"volume"),W3.prototype),V3=W3))||V3)||V3)||V3));U(R3,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:$3,targetName:"AudioSource"}]),G(R3.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(e){return{name:e,suggest:"please use AudioSource.prototype."+e+" instead"}}))),l.AudioSourceComponent=$3,nt.setClassAlias($3,"cc.AudioSourceComponent"),l.log=y,l.warn=S,l.error=x,l.assert=E,l._throw=A,l.logID=w,l.warnID=R,l.errorID=O,l.assertID=L,l.debug=j,l.path={join:pu,extname:mu,mainFileName:vu,basename:gu,dirname:yu,changeExtname:Su,changeBasename:xu,_normalize:Eu,stripSep:Tu,get sep(){return Cu()}};var e5=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var a=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return a&&a.reuse&&a.reuse(arguments),r},e}());l.NodePool=e5,l.renderer=Vy;var t5,n5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:i};for(var o=0;o<n.length;++o)for(var s=n[o],c=0;c<s.count;c++)a.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&ia){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&ra&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},Q(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Ea);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(t5||(t5={}));var i5=function(){function e(){}return e.setInstance=function(t){e._instance=t},Q(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function r5(e,t){switch(e){case _i.R8:return t.UNSIGNED_BYTE;case _i.R8SN:return t.BYTE;case _i.R8UI:return t.UNSIGNED_BYTE;case _i.R8I:return t.BYTE;case _i.R16F:return t5.HALF_FLOAT_OES;case _i.R16UI:return t.UNSIGNED_SHORT;case _i.R16I:return t.SHORT;case _i.R32F:return t.FLOAT;case _i.R32UI:return t.UNSIGNED_INT;case _i.R32I:return t.INT;case _i.RG8:return t.UNSIGNED_BYTE;case _i.RG8SN:return t.BYTE;case _i.RG8UI:return t.UNSIGNED_BYTE;case _i.RG8I:return t.BYTE;case _i.RG16F:return t5.HALF_FLOAT_OES;case _i.RG16UI:return t.UNSIGNED_SHORT;case _i.RG16I:return t.SHORT;case _i.RG32F:return t.FLOAT;case _i.RG32UI:return t.UNSIGNED_INT;case _i.RG32I:return t.INT;case _i.RGB8:case _i.SRGB8:return t.UNSIGNED_BYTE;case _i.RGB8SN:return t.BYTE;case _i.RGB8UI:return t.UNSIGNED_BYTE;case _i.RGB8I:return t.BYTE;case _i.RGB16F:return t5.HALF_FLOAT_OES;case _i.RGB16UI:return t.UNSIGNED_SHORT;case _i.RGB16I:return t.SHORT;case _i.RGB32F:return t.FLOAT;case _i.RGB32UI:return t.UNSIGNED_INT;case _i.RGB32I:return t.INT;case _i.BGRA8:case _i.RGBA8:case _i.SRGB8_A8:return t.UNSIGNED_BYTE;case _i.RGBA8SN:return t.BYTE;case _i.RGBA8UI:return t.UNSIGNED_BYTE;case _i.RGBA8I:return t.BYTE;case _i.RGBA16F:return t5.HALF_FLOAT_OES;case _i.RGBA16UI:return t.UNSIGNED_SHORT;case _i.RGBA16I:return t.SHORT;case _i.RGBA32F:return t.FLOAT;case _i.RGBA32UI:return t.UNSIGNED_INT;case _i.RGBA32I:return t.INT;case _i.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case _i.R11G11B10F:return t.FLOAT;case _i.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case _i.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case _i.RGB10A2:return t.UNSIGNED_BYTE;case _i.RGB10A2UI:return t.UNSIGNED_INT;case _i.RGB9E5:return t.UNSIGNED_BYTE;case _i.DEPTH:return t.UNSIGNED_INT;case _i.DEPTH_STENCIL:return t5.UNSIGNED_INT_24_8_WEBGL;case _i.BC1:case _i.BC1_SRGB:case _i.BC2:case _i.BC2_SRGB:case _i.BC3:case _i.BC3_SRGB:case _i.BC4:return t.UNSIGNED_BYTE;case _i.BC4_SNORM:return t.BYTE;case _i.BC5:return t.UNSIGNED_BYTE;case _i.BC5_SNORM:return t.BYTE;case _i.BC6H_SF16:case _i.BC6H_UF16:return t.FLOAT;case _i.BC7:case _i.BC7_SRGB:case _i.ETC_RGB8:case _i.ETC2_RGB8:case _i.ETC2_SRGB8:case _i.ETC2_RGB8_A1:case _i.ETC2_SRGB8_A1:case _i.EAC_R11:return t.UNSIGNED_BYTE;case _i.EAC_R11SN:return t.BYTE;case _i.EAC_RG11:return t.UNSIGNED_BYTE;case _i.EAC_RG11SN:return t.BYTE;case _i.PVRTC_RGB2:case _i.PVRTC_RGBA2:case _i.PVRTC_RGB4:case _i.PVRTC_RGBA4:case _i.PVRTC2_2BPP:case _i.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case _i.ASTC_RGBA_4X4:case _i.ASTC_RGBA_5X4:case _i.ASTC_RGBA_5X5:case _i.ASTC_RGBA_6X5:case _i.ASTC_RGBA_6X6:case _i.ASTC_RGBA_8X5:case _i.ASTC_RGBA_8X6:case _i.ASTC_RGBA_8X8:case _i.ASTC_RGBA_10X5:case _i.ASTC_RGBA_10X6:case _i.ASTC_RGBA_10X8:case _i.ASTC_RGBA_10X10:case _i.ASTC_RGBA_12X10:case _i.ASTC_RGBA_12X12:case _i.ASTC_SRGBA_4X4:case _i.ASTC_SRGBA_5X4:case _i.ASTC_SRGBA_5X5:case _i.ASTC_SRGBA_6X5:case _i.ASTC_SRGBA_6X6:case _i.ASTC_SRGBA_8X5:case _i.ASTC_SRGBA_8X6:case _i.ASTC_SRGBA_8X8:case _i.ASTC_SRGBA_10X5:case _i.ASTC_SRGBA_10X6:case _i.ASTC_SRGBA_10X8:case _i.ASTC_SRGBA_10X10:case _i.ASTC_SRGBA_12X10:case _i.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function a5(e,t){switch(e){case pi.BOOL:return t.BOOL;case pi.BOOL2:return t.BOOL_VEC2;case pi.BOOL3:return t.BOOL_VEC3;case pi.BOOL4:return t.BOOL_VEC4;case pi.INT:return t.INT;case pi.INT2:return t.INT_VEC2;case pi.INT3:return t.INT_VEC3;case pi.INT4:return t.INT_VEC4;case pi.UINT:return t.UNSIGNED_INT;case pi.FLOAT:return t.FLOAT;case pi.FLOAT2:return t.FLOAT_VEC2;case pi.FLOAT3:return t.FLOAT_VEC3;case pi.FLOAT4:return t.FLOAT_VEC4;case pi.MAT2:return t.FLOAT_MAT2;case pi.MAT3:return t.FLOAT_MAT3;case pi.MAT4:return t.FLOAT_MAT4;case pi.SAMPLER2D:return t.SAMPLER_2D;case pi.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),pi.UNKNOWN}}function o5(e){switch(e){case pi.BOOL:case pi.BOOL2:case pi.BOOL3:case pi.BOOL4:case pi.INT:case pi.INT2:case pi.INT3:case pi.INT4:case pi.UINT:return Int32Array;case pi.FLOAT:case pi.FLOAT2:case pi.FLOAT3:case pi.FLOAT4:case pi.MAT2:case pi.MAT3:case pi.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function s5(e,t){switch(e){case t.BOOL:return pi.BOOL;case t.BOOL_VEC2:return pi.BOOL2;case t.BOOL_VEC3:return pi.BOOL3;case t.BOOL_VEC4:return pi.BOOL4;case t.INT:return pi.INT;case t.INT_VEC2:return pi.INT2;case t.INT_VEC3:return pi.INT3;case t.INT_VEC4:return pi.INT4;case t.UNSIGNED_INT:return pi.UINT;case t.FLOAT:return pi.FLOAT;case t.FLOAT_VEC2:return pi.FLOAT2;case t.FLOAT_VEC3:return pi.FLOAT3;case t.FLOAT_VEC4:return pi.FLOAT4;case t.FLOAT_MAT2:return pi.MAT2;case t.FLOAT_MAT3:return pi.MAT3;case t.FLOAT_MAT4:return pi.MAT4;case t.SAMPLER_2D:return pi.SAMPLER2D;case t.SAMPLER_CUBE:return pi.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),pi.UNKNOWN}}function c5(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function l5(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}i5._instance=null;var u5,h5=[512,513,514,515,516,517,518,519],f5=[0,7680,7681,7682,7683,5386,34055,34056],_5=[32774,32778,32779,32775,32776],d5=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(u5||(u5={}));var p5=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},m5=function(e){function t(){var t;return(t=e.call(this,u5.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new ir,t.clearFlag=Ki.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return Z(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(p5),v5=function(e){function t(){var t;return(t=e.call(this,u5.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new ea,t}return Z(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(p5),g5=function(e){function t(){var t;return(t=e.call(this,u5.DRAW)||this).drawInfo=new vr,t}return Z(t,e),t.prototype.clear=function(){},t}(p5),y5=function(e){function t(){var t;return(t=e.call(this,u5.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return Z(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(p5),S5=function(e){function t(){var t;return(t=e.call(this,u5.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return Z(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(p5),x5=function(){function e(){this.cmds=new jl(1),this.beginRenderPassCmds=new jl(1),this.bindStatesCmds=new jl(1),this.drawCmds=new jl(1),this.updateBufferCmds=new jl(1),this.copyBufferToTextureCmds=new jl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function E5(e,t,n,i,r){if(t.usage&mi.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&mi.INDIRECT){t.indirects.clearDraws();for(var a=n.drawInfos,o=0;o<a.length;++o)t.indirects.setDrawInfo(i+o,a[o])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),T5.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),T5.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var T5={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},C5=new ir;function A5(e,t,n,i,r,a,o){var s=e.gl,c=e.stateCache,l=0;if(n&&(C5.x=i.x<<n.lodLevel,C5.y=i.y<<n.lodLevel,C5.width=i.width<<n.lodLevel,C5.height=i.height<<n.lodLevel),n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===C5.x&&c.viewport.top===C5.y&&c.viewport.width===C5.width&&c.viewport.height===C5.height||(s.viewport(C5.x,C5.y,C5.width,C5.height),c.viewport.left=C5.x,c.viewport.top=C5.y,c.viewport.width=C5.width,c.viewport.height=C5.height),c.scissorRect.x===C5.x&&c.scissorRect.y===C5.y&&c.scissorRect.width===C5.width&&c.scissorRect.height===C5.height||(s.scissor(C5.x,C5.y,C5.width,C5.height),c.scissorRect.x=C5.x,c.scissorRect.y=C5.y,c.scissorRect.width=C5.width,c.scissorRect.height=C5.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var f=t.colorAttachments[h];if(f.format!==_i.UNKNOWN)switch(f.loadOp){case Mi.LOAD:break;case Mi.CLEAR:c.bs.targets[0].blendColorMask!==Oi.ALL&&s.colorMask(!0,!0,!0,!0);var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT;break;case Mi.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==_i.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Mi.LOAD:break;case Mi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),l|=s.DEPTH_BUFFER_BIT;break;case Mi.DISCARD:}if(na[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Mi.LOAD:break;case Mi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),l|=s.STENCIL_BUFFER_BIT;break;case Mi.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var d=c.bs.targets[0].blendColorMask;if(d!==Oi.ALL){var p=(d&Oi.R)!==Oi.NONE,m=(d&Oi.G)!==Oi.NONE,v=(d&Oi.B)!==Oi.NONE,g=(d&Oi.A)!==Oi.NONE;s.colorMask(p,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function b5(e,t,n,i,r,a){var o,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,f=!1;if(t&&T5.gpuPipelineState!==t){if(T5.gpuPipelineState=t,T5.glPrimitive=t.glPrimitive,t.gpuShader){var _=t.gpuShader.glProgram;u.glProgram!==_&&(l.useProgram(_),u.glProgram=_,f=!0)}var d=t.rs;if(d){if(u.rs.cullMode!==d.cullMode){switch(d.cullMode){case Hi.NONE:l.disable(l.CULL_FACE);break;case Hi.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Hi.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=d.cullMode}var p=d.isFrontFaceCCW;u.rs.isFrontFaceCCW!==p&&(l.frontFace(p?l.CCW:l.CW),u.rs.isFrontFaceCCW=p),u.rs.depthBias===d.depthBias&&u.rs.depthBiasSlop===d.depthBiasSlop||(l.polygonOffset(d.depthBias,d.depthBiasSlop),u.rs.depthBias=d.depthBias,u.rs.depthBiasSlop=d.depthBiasSlop),u.rs.lineWidth!==d.lineWidth&&(l.lineWidth(d.lineWidth),u.rs.lineWidth=d.lineWidth)}var m=t.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(h5[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,h5[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,f5[m.stencilFailOpFront],f5[m.stencilZFailOpFront],f5[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,h5[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,f5[m.stencilFailOpBack],f5[m.stencilZFailOpBack],f5[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=t.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(_5[g.blendEq],_5[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(d5[g.blendSrc],d5[g.blendDst],d5[g.blendSrcAlpha],d5[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Oi.R)!==Oi.NONE,(g.blendColorMask&Oi.G)!==Oi.NONE,(g.blendColorMask&Oi.B)!==Oi.NONE,(g.blendColorMask&Oi.A)!==Oi.NONE),y.blendColorMask=g.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var S=h.glBlocks.length,E=t.gpuPipelineLayout.dynamicOffsetIndices,T=0;T<S;T++){var C=h.glBlocks[T],A=i[C.set],b=A&&A.descriptorIndices[C.binding],I=b>=0&&A.gpuDescriptors[b],w=null,P=0;if(I&&I.gpuBuffer){var R=I.gpuBuffer,D=E[C.set],O=D&&D[C.binding];O>=0&&(P=r[O]),"vf32"in R?w=R.vf32:(P+=R.offset,w=R.gpuBuffer.vf32),P>>=2}if(w)for(var N=C.glActiveUniforms.length,M=0;M<N;M++){var L=C.glActiveUniforms[M];switch(L.glType){case l.BOOL:case l.INT:for(var F=0;F<L.array.length;++F){var B=L.offset+P+F;if(w[B]!==L.array[F]){for(var z=F,U=B;z<L.array.length;++z,++U)L.array[z]=w[U];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<L.array.length;++k){var G=L.offset+P+k;if(w[G]!==L.array[k]){for(var H=k,V=G;H<L.array.length;++H,++V)L.array[H]=w[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var W=0;W<L.array.length;++W){var j=L.offset+P+W;if(w[j]!==L.array[W]){for(var X=W,q=j;X<L.array.length;++X,++q)L.array[X]=w[q];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+P+Y;if(w[K]!==L.array[Y]){for(var Q=Y,J=K;Q<L.array.length;++Q,++J)L.array[Q]=w[J];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var Z=0;Z<L.array.length;++Z){var $=L.offset+P+Z;if(w[$]!==L.array[Z]){for(var ee=Z,te=$;ee<L.array.length;++ee,++te)L.array[ee]=w[te];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<L.array.length;++ne){var ie=L.offset+P+ne;if(w[ie]!==L.array[ne]){for(var re=ne,ae=ie;re<L.array.length;++re,++ae)L.array[re]=w[ae];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var oe=0;oe<L.array.length;++oe){var se=L.offset+P+oe;if(w[se]!==L.array[oe]){for(var ce=oe,le=se;ce<L.array.length;++ce,++le)L.array[ce]=w[le];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<L.array.length;++ue){var he=L.offset+P+ue;if(w[he]!==L.array[ue]){for(var fe=ue,_e=he;fe<L.array.length;++fe,++_e)L.array[fe]=w[_e];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var de=0;de<L.array.length;++de){var pe=L.offset+P+de;if(w[pe]!==L.array[de]){for(var me=de,ve=pe;me<L.array.length;++me,++ve)L.array[me]=w[ve];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<L.array.length;++ge){var ye=L.offset+P+ge;if(w[ye]!==L.array[ge]){for(var Se=ge,xe=ye;Se<L.array.length;++Se,++xe)L.array[Se]=w[xe];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var Ee=0;Ee<L.array.length;++Ee){var Te=L.offset+P+Ee;if(w[Te]!==L.array[Ee]){for(var Ce=Ee,Ae=Te;Ce<L.array.length;++Ce,++Ae)L.array[Ce]=w[Ae];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else x("Buffer binding '"+C.name+"' at set "+C.set+" binding "+C.binding+" is not bounded")}for(var be=h.glSamplerTextures.length,Ie=0;Ie<be;Ie++)for(var we=h.glSamplerTextures[Ie],Pe=i[we.set],Re=Pe&&Pe.descriptorIndices[we.binding],De=Re>=0&&Pe.gpuDescriptors[Re],Oe=we.units.length,Ne=0;Ne<Oe;Ne++){var Me=we.units[Ne];if(De&&De.gpuSampler){if(De.gpuTexture&&De.gpuTexture.size>0){var Le=De.gpuTexture,Fe=u.glTexUnits[Me];Fe.glTexture!==Le.glTexture&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),Le.glTexture?l.bindTexture(Le.glTarget,Le.glTexture):l.bindTexture(Le.glTarget,e.nullTex2D.gpuTexture.glTexture),Fe.glTexture=Le.glTexture);var Be=De.gpuSampler;Le.isPowerOf2?(o=Be.glWrapS,s=Be.glWrapT):(o=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Le.isPowerOf2?Le.mipLevel<=1&&(Be.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Be.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Be.glMinFilter:Be.glMinFilter===l.LINEAR||Be.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Be.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Le.glWrapS!==o&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_S,o),Le.glWrapS=o),Le.glWrapT!==s&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_T,s),Le.glWrapT=s),Le.glMinFilter!==c&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_MIN_FILTER,c),Le.glMinFilter=c),Le.glMagFilter!==Be.glMagFilter&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_MAG_FILTER,Be.glMagFilter),Le.glMagFilter=Be.glMagFilter)}De=Pe.gpuDescriptors[++Re]}else x("Sampler binding '"+we.name+"' at set "+we.set+" binding "+we.binding+" index "+Ne+" is not bounded")}}if(n&&h&&(f||T5.gpuInputAssembler!==n)){T5.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ue=e.extensions.OES_vertex_array_object,ke=n.glVAOs.get(h.glProgram);if(!ke){var Ge;ke=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,ke),Ue.bindVertexArrayOES(ke),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var We=h.glInputs[Ve];Ge=null;for(var je=n.glAttribs.length,Xe=0;Xe<je;Xe++){var qe=n.glAttribs[Xe];if(qe.name===We.name){Ge=qe;break}}if(Ge){u.glArrayBuffer!==Ge.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ge.glBuffer),u.glArrayBuffer=Ge.glBuffer);for(var Ye=0;Ye<Ge.componentCount;++Ye){var Ke=We.glLoc+Ye,Qe=Ge.offset+Ge.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,Ge.isInstanced?1:0)}}}var Je=n.gpuIndexBuffer;Je&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Je.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==ke&&(Ue.bindVertexArrayOES(ke),u.glVAO=ke)}else{for(var Ze=0;Ze<e.capabilities.maxVertexAttributes;++Ze)u.glCurrentAttribLocs[Ze]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var at=n.glAttribs[rt];if(at.name===tt.name){nt=at;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var ot=0;ot<nt.componentCount;++ot){var st=tt.glLoc+ot,ct=nt.offset+nt.size*ot;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,ft=0;ft<ht;ft++)switch(t.dynamicStates[ft]){case Vi.LINE_WIDTH:u.rs.lineWidth!==a.lineWidth&&(l.lineWidth(a.lineWidth),u.rs.lineWidth=a.lineWidth);break;case Vi.DEPTH_BIAS:u.rs.depthBias===a.depthBiasConstant&&u.rs.depthBiasSlop===a.depthBiasSlope||(l.polygonOffset(a.depthBiasConstant,a.depthBiasSlope),u.rs.depthBias=a.depthBiasConstant,u.rs.depthBiasSlop=a.depthBiasSlope);break;case Vi.BLEND_CONSTANTS:var _t=a.blendConstant;u.bs.blendColor.x===_t.x&&u.bs.blendColor.y===_t.y&&u.bs.blendColor.z===_t.z&&u.bs.blendColor.w===_t.w||(l.blendColor(_t.x,_t.y,_t.z,_t.w),u.bs.blendColor.copy(_t));break;case Vi.STENCIL_WRITE_MASK:var dt=a.stencilStatesFront,pt=a.stencilStatesBack;u.dss.stencilWriteMaskFront!==dt.writeMask&&(l.stencilMaskSeparate(l.FRONT,dt.writeMask),u.dss.stencilWriteMaskFront=dt.writeMask),u.dss.stencilWriteMaskBack!==pt.writeMask&&(l.stencilMaskSeparate(l.BACK,pt.writeMask),u.dss.stencilWriteMaskBack=pt.writeMask);break;case Vi.STENCIL_COMPARE_MASK:var mt=a.stencilStatesFront,vt=a.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,h5[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,h5[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function I5(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,a=i.WEBGL_multi_draw,o=T5.gpuInputAssembler,s=T5.glPrimitive;if(o){var c=o.gpuIndexBuffer;if(o.gpuIndirectBuffer){var l=o.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(a)l.instancedDraw?a.multiDrawElementsInstancedWEBGL(s,l.counts,0,o.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):a.multiDrawElementsWEBGL(s,l.counts,0,o.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],o.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],o.glIndexType,l.byteOffsets[h])}else if(a)l.instancedDraw?a.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):a.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var f=0;f<l.drawCount;f++)l.instances[f]&&r?r.drawArraysInstancedANGLE(s,l.offsets[f],l.counts[f],l.instances[f]):n.drawArrays(s,l.offsets[f],l.counts[f])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var _=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,o.glIndexType,_,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var d=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,o.glIndexType,d)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var w5=new Array(u5.COUNT);function P5(e,t){w5.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=w5[i]++;switch(i){case u5.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];A5(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case u5.BIND_STATES:var o=t.bindStatesCmds.array[r];b5(e,o.gpuPipelineState,o.gpuInputAssembler,o.gpuDescriptorSets,o.dynamicOffsets,o.dynamicStates);break;case u5.DRAW:I5(e,t.drawCmds.array[r].drawInfo);break;case u5.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];E5(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case u5.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];R5(e,c.buffers,c.gpuTexture,c.regions)}}}function R5(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=1,c=1,l=0,u=na[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var _=t[o++];u?n.glInternalFmt===t5.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,_):r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,_):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,_)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[o++];u?n.glInternalFmt===t5.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ei.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var D5=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=a(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),O5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&mi.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new D5,glTarget:0,glBuffer:null},this._usage&mi.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&yi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&mi.VERTEX){t.glTarget=n.ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),T5.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&mi.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),T5.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&mi.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&mi.INDIRECT||t.usage&mi.TRANSFER_DST||t.usage&mi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(i5.instance,this._gpuBuffer),i5.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),T5.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),T5.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(i5.instance,this._gpuBuffer),i5.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&yi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&mi.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),T5.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&mi.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),T5.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&mi.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&mi.INDIRECT||t.usage&mi.TRANSFER_DST||t.usage&mi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(i5.instance,this._gpuBuffer),i5.instance.memoryStatus.bufferSize-=t,i5.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&mi.INDIRECT?0:e.byteLength,E5(i5.instance,this._gpuBuffer,e,0,n))},Q(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(_a),N5=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new jl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var a=i,o=0;a<t;++a,++o)this._frees[a]=n[o];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),M5=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new N5(m5,1),this.bindStatesCmdPool=new N5(v5,1),this.drawCmdPool=new N5(g5,1),this.updateBufferCmdPool=new N5(y5,1),this.copyBufferToTextureCmdPool=new N5(S5,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),L5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new x5,t._cmdAllocator=new M5,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new ea,t._isStateInvalied=!1,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=i5.instance.bindingMappings.blockOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,a){var o=this._cmdAllocator.beginRenderPassCmdPool.alloc(m5);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea.copy(n),o.clearColors.length=i.length;for(var s=0;s<i.length;++s)o.clearColors[s]=i[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(u5.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,a=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(a){for(var o=this._curDynamicOffsets,s=a.dynamicOffsetOffsets[e],c=0;c<n.length;c++)o[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Wi.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Wi.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Wi.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Wi.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Yi.PRIMARY&&this._isInRenderPass||this._type===Yi.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(g5);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(u5.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=e.gpuBuffer;if(i){var r,a=this._cmdAllocator.updateBufferCmdPool.alloc(y5),o=0;e.usage&mi.INDIRECT||(o=void 0!==n?n:t.byteLength),r=t,a.gpuBuffer=i,a.buffer=r,a.offset=0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(u5.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(S5);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(u5.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var a=i.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<i.cmdPackage.bindStatesCmds.length;++o){var s=i.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var _=i.cmdPackage.copyBufferToTextureCmds.array[f];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(v5);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(u5.BIND_STATES),this._isStateInvalied=!1)},t}(da),F5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=0,n=[],i=0;i<e.colorTextures.length;++i){var r=e.colorTextures[i];r&&(n.push(r.gpuTexture),t=r.lodLevel)}var a=null;e.depthStencilTexture&&(a=e.depthStencilTexture.gpuTexture,t=e.depthStencilTexture.lodLevel);var o=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:n,gpuDepthStencilTexture:a,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?s:this.gpuColorTextures[0].height},set height(e){s=e},lodLevel:t},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],a=i.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var o=0;o<t.gpuColorTextures.length;++o){var s=t.gpuColorTextures[o];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+o),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=na[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(i5.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=i5.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},Q(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(va),B5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],c=r5(a.format,n),l=na[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:c,size:l,count:na[a.format].count,stride:s.stride,componentCount:l5(c,n),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:i[o]},i[o]+=l}}(i5.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=i5.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.extensions.OES_vertex_array_object,a=e.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),a===i.value&&(r.bindVertexArrayOES(null),a=null),i=n.next();e.stateCache.glVAO=a,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},Q(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(xa),z5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var a=this._bindings[r];i.push(t),t+=a.count,a.binding>n&&(n=a.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var o=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,o[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&aa)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:o,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},Q(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Ta),U5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],a=0;a<this._setLayouts.length;a++){for(var o=this._setLayouts[a],s=o.gpuDescriptorSetLayout.dynamicBindings,c=Array(o.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(o.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},Q(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Ca),k5=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],G5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],a=0;a<31;a++)this._dynamicStates&1<<a&&r.push(1<<a);this._gpuPipelineState={glPrimitive:k5[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},Q(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Ra),H5=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,a){A5(i5.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,a),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;I5(i5.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=i5.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=i5.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&mi.INDIRECT?0:t.byteLength,E5(i5.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&R5(i5.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];P5(i5.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){b5(i5.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(L5),V5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Da),W5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},Q(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(Oa),j5=[10497,33648,33071,33071],X5=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,a,o=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=o===bi.LINEAR||o===bi.ANISOTROPIC?c===bi.LINEAR||c===bi.ANISOTROPIC?9987:c===bi.POINT?9985:9729:c===bi.LINEAR||c===bi.ANISOTROPIC?9986:c===bi.POINT?9984:9728,a=s===bi.LINEAR||s===bi.ANISOTROPIC?9729:9728;var l=j5[i._info.addressU],u=j5[i._info.addressV],h=j5[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:a,glWrapS:l,glWrapT:u,glWrapR:h},i}return Z(t,e),Q(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Na),q5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,a="",o=1;switch(i.type){case Ni.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case Ni.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(a+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+o+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var a=i(r);if("object"==typeof a)return a.v}var o=n.createProgram();if(o){t.glProgram=o;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));T("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var f=0;f<h;++f){var _=n.getActiveAttrib(t.glProgram,f);if(_){var d,p=_.name.indexOf("[");d=-1!==p?_.name.substr(0,p):_.name;var m=n.getAttribLocation(t.glProgram,d),v=s5(_.type,n),g=c5(_.type,n);t.glInputs[f]={binding:m,name:d,type:v,stride:g,count:_.size,size:g*_.size,glType:_.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var y=0;y<t.blocks.length;++y){var S=t.blocks[y],x={set:S.set,binding:S.binding,name:S.name,size:0,glUniforms:new Array(S.members.length),glActiveUniforms:[]};t.glBlocks[y]=x;for(var E=0;E<S.members.length;++E){var C=S.members[E],A=a5(C.type,n),b=c5(A,n),I=b*C.count;x.glUniforms[E]={binding:-1,name:C.name,type:C.type,stride:b,count:C.count,size:I,offset:0,glType:A,glLoc:null,array:null}}}}for(var w=0;w<t.subpassInputs.length;++w){var P=t.subpassInputs[w];t.samplerTextures.push(new Ar(P.set,P.binding,P.name,pi.SAMPLER2D,P.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var R=0;R<t.samplerTextures.length;++R){var D=t.samplerTextures[R];t.glSamplerTextures[R]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:a5(D.type,n),glLoc:null}}}for(var O=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),N=0;N<O;++N){var M=n.getActiveUniform(t.glProgram,N);if(M&&M.type!==n.SAMPLER_2D&&M.type!==n.SAMPLER_CUBE){var L=n.getUniformLocation(t.glProgram,M.name);if(e.extensions.isLocationActive(L)){var F,B=M.name.indexOf("[");F=-1!==B?M.name.substr(0,B):M.name;for(var z=0;z<t.glBlocks.length;z++)for(var U=t.glBlocks[z],k=0;k<U.glUniforms.length;k++){var G=U.glUniforms[k];if(G.name===F){G.glLoc=L,G.count=M.size,G.size=G.stride*G.count,G.array=new(o5(G.type))(G.size/4),U.glActiveUniforms.push(G);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],W=0;W<V.glUniforms.length;W++){var j=V.glUniforms[W];j.offset=V.size/4,V.size+=j.size}for(var X=[],q=[],Y=e.bindingMappings,K=e.stateCache.texUnitCacheMap,Q=0,J=0;J<t.blocks.length;++J)t.blocks[J].set===Y.flexibleSet&&Q++;for(var Z=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(X.push(t.glSamplerTextures[$]),q.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerTextureOffsets[ee.set]+Z;ee.set===Y.flexibleSet&&(ne-=Q),K[ee.name]=ne%e.capabilities.maxTextureUnits,Z+=ee.count-1}}if(X.length){for(var ie=[],re=0;re<X.length;++re){var ae=X[re],oe=K[ae.name];if(void 0!==oe){ae.glLoc=q[re];for(var se=0;se<ae.count;++se){for(;ie[oe];)oe=(oe+1)%e.capabilities.maxTextureUnits;ae.units.push(oe),ie[oe]=!0}}}for(var ce=0,le=0;le<X.length;++le){var ue=X[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=q[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var fe=0;fe<X.length;fe++){var _e=X[fe];_e.glUnits=new Int32Array(_e.units),n.uniform1iv(_e.glLoc,_e.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var de=0;de<t.glBlocks.length;)t.glBlocks[de].glActiveUniforms.length?de++:(t.glBlocks[de]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=X}}(i5.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(i5.instance,this._gpuShader),this._gpuShader=null)},Q(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Ma),Y5=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new ur,this.scissorRect=new ir(0,0,0,0),this.rs=new Aa,this.dss=new ba,this.bs=new wa,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),K5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t._lodLevel=0,t}Z(t,e);var n=t.prototype;return n.initialize=function(e,t){var n=e,i=e;"texture"in e&&(n=i.texture.info,this._isTextureView=!0),this._info.copy(n),this._isPowerOf2=oa(this._info.width)&&oa(this._info.height),this._size=ca(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(i),this._lodLevel=i.baseLevel,this._gpuTexture=i.texture._gpuTexture):(this._gpuTexture={type:n.type,format:n.format,usage:n.usage,width:n.width,height:n.height,depth:n.depth,size:this._size,arrayLayer:n.layerCount,mipLevel:n.levelCount,samples:n.samples,flags:n.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case _i.A8:return t.ALPHA;case _i.L8:return t.LUMINANCE;case _i.LA8:return t.LUMINANCE_ALPHA;case _i.RGB8:case _i.RGB16F:case _i.RGB32F:return t.RGB;case _i.BGRA8:case _i.RGBA8:case _i.SRGB8_A8:case _i.RGBA16F:case _i.RGBA32F:return t.RGBA;case _i.R5G6B5:return t.RGB;case _i.RGB5A1:case _i.RGBA4:return t.RGBA;case _i.DEPTH:return t.DEPTH_COMPONENT;case _i.DEPTH_STENCIL:return t.DEPTH_STENCIL;case _i.BC1:return t5.COMPRESSED_RGB_S3TC_DXT1_EXT;case _i.BC1_ALPHA:return t5.COMPRESSED_RGBA_S3TC_DXT1_EXT;case _i.BC1_SRGB:return t5.COMPRESSED_SRGB_S3TC_DXT1_EXT;case _i.BC1_SRGB_ALPHA:return t5.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case _i.BC2:return t5.COMPRESSED_RGBA_S3TC_DXT3_EXT;case _i.BC2_SRGB:return t5.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case _i.BC3:return t5.COMPRESSED_RGBA_S3TC_DXT5_EXT;case _i.BC3_SRGB:return t5.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case _i.ETC_RGB8:return t5.COMPRESSED_RGB_ETC1_WEBGL;case _i.ETC2_RGB8:return t5.COMPRESSED_RGB8_ETC2;case _i.ETC2_SRGB8:return t5.COMPRESSED_SRGB8_ETC2;case _i.ETC2_RGB8_A1:return t5.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_SRGB8_A1:return t5.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_RGBA8:return t5.COMPRESSED_RGBA8_ETC2_EAC;case _i.ETC2_SRGB8_A8:return t5.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case _i.EAC_R11:return t5.COMPRESSED_R11_EAC;case _i.EAC_R11SN:return t5.COMPRESSED_SIGNED_R11_EAC;case _i.EAC_RG11:return t5.COMPRESSED_RG11_EAC;case _i.EAC_RG11SN:return t5.COMPRESSED_SIGNED_RG11_EAC;case _i.PVRTC_RGB2:return t5.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGBA2:return t5.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGB4:return t5.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case _i.PVRTC_RGBA4:return t5.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case _i.ASTC_RGBA_4X4:return t5.COMPRESSED_RGBA_ASTC_4x4_KHR;case _i.ASTC_RGBA_5X4:return t5.COMPRESSED_RGBA_ASTC_5x4_KHR;case _i.ASTC_RGBA_5X5:return t5.COMPRESSED_RGBA_ASTC_5x5_KHR;case _i.ASTC_RGBA_6X5:return t5.COMPRESSED_RGBA_ASTC_6x5_KHR;case _i.ASTC_RGBA_6X6:return t5.COMPRESSED_RGBA_ASTC_6x6_KHR;case _i.ASTC_RGBA_8X5:return t5.COMPRESSED_RGBA_ASTC_8x5_KHR;case _i.ASTC_RGBA_8X6:return t5.COMPRESSED_RGBA_ASTC_8x6_KHR;case _i.ASTC_RGBA_8X8:return t5.COMPRESSED_RGBA_ASTC_8x8_KHR;case _i.ASTC_RGBA_10X5:return t5.COMPRESSED_RGBA_ASTC_10x5_KHR;case _i.ASTC_RGBA_10X6:return t5.COMPRESSED_RGBA_ASTC_10x6_KHR;case _i.ASTC_RGBA_10X8:return t5.COMPRESSED_RGBA_ASTC_10x8_KHR;case _i.ASTC_RGBA_10X10:return t5.COMPRESSED_RGBA_ASTC_10x10_KHR;case _i.ASTC_RGBA_12X10:return t5.COMPRESSED_RGBA_ASTC_12x10_KHR;case _i.ASTC_RGBA_12X12:return t5.COMPRESSED_RGBA_ASTC_12x12_KHR;case _i.ASTC_SRGBA_4X4:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case _i.ASTC_SRGBA_5X4:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case _i.ASTC_SRGBA_5X5:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case _i.ASTC_SRGBA_6X5:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case _i.ASTC_SRGBA_6X6:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case _i.ASTC_SRGBA_8X5:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case _i.ASTC_SRGBA_8X6:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case _i.ASTC_SRGBA_8X8:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case _i.ASTC_SRGBA_10X5:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case _i.ASTC_SRGBA_10X6:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case _i.ASTC_SRGBA_10X8:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case _i.ASTC_SRGBA_10X10:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case _i.ASTC_SRGBA_12X10:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case _i.ASTC_SRGBA_12X12:return t5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=r5(t.format,n);var i=t.width,r=t.height;switch(t.type){case Si.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&O(9100,a,e.capabilities.maxTextureSize),e.textureExclusive[t.format]||e.extensions.WEBGL_depth_texture||!na[t.format].hasDepth){if(t.glTexture=n.createTexture(),t.size>0){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),na[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=sa(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}}else t.glInternalFmt=function(e,t){switch(e){case _i.R5G6B5:return t.RGB565;case _i.RGB5A1:return t.RGB5_A1;case _i.RGBA4:return t.RGBA4;case _i.RGBA16F:return t5.RGBA16F_EXT;case _i.RGBA32F:return t5.RGBA32F_EXT;case _i.SRGB8_A8:return t5.SRGB8_ALPHA8_EXT;case _i.DEPTH:return t.DEPTH_COMPONENT16;case _i.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));break;case Si.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&O(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),f.glTexture=t.glTexture),na[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=sa(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Si.TEX2D,t.glTarget=n.TEXTURE_2D}}(i5.instance,this._gpuTexture),i5.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount)},n.destroy=function(){!this._isTextureView&&this._gpuTexture&&(function(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var a=0;a<i.length;a++)i[a].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+a),r=a,n.bindTexture(t.glTarget,null),i[a].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var o=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),o===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),o=null),t.glRenderbuffer=null}}(i5.instance,this._gpuTexture),i5.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,n){if(this._info.width!==e||this._info.height!==n){this._info.levelCount===t.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=t.getLevelCount(e,n):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,t.getLevelCount(e,n)));var i=this._size;this._info.width=e,this._info.height=n,this._size=ca(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=n,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Si.TEX2D:t.glTarget=n.TEXTURE_2D;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&O(9100,a,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),na[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=sa(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Si.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&O(9100,h,e.capabilities.maxTextureSize);var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),f.glTexture=t.glTexture),na[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=sa(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Si.TEX2D,t.glTarget=n.TEXTURE_2D}}}(i5.instance,this._gpuTexture),i5.instance.memoryStatus.textureSize-=i,i5.instance.memoryStatus.textureSize+=this._size)}},n.initAsSwapchainTexture=function(e){var t=new Sr;t.format=e.format,t.usage=na[e.format].hasDepth?xi.DEPTH_STENCIL_ATTACHMENT:xi.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},Q(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}}]),t}(La),Q5="webglcontextlost";function J5(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function Z5(e){var t={EXT_texture_filter_anisotropic:J5(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:J5(e,"EXT_blend_minmax"),EXT_frag_depth:J5(e,"EXT_frag_depth"),EXT_shader_texture_lod:J5(e,"EXT_shader_texture_lod"),EXT_sRGB:J5(e,"EXT_sRGB"),OES_vertex_array_object:J5(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:J5(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:J5(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:J5(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:J5(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:J5(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:J5(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:J5(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:J5(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:J5(e,"WEBGL_draw_buffers"),WEBGL_lose_context:J5(e,"WEBGL_lose_context"),WEBGL_depth_texture:J5(e,"WEBGL_depth_texture"),OES_texture_half_float:J5(e,"OES_texture_half_float"),OES_texture_half_float_linear:J5(e,"OES_texture_half_float_linear"),OES_texture_float:J5(e,"OES_texture_float"),OES_texture_float_linear:J5(e,"OES_texture_float_linear"),OES_standard_derivatives:J5(e,"OES_standard_derivatives"),OES_element_index_uint:J5(e,"OES_element_index_uint"),ANGLE_instanced_arrays:J5(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:J5(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return hu.os===iu.IOS&&14===hu.osMainVersion&&hu.isBrowser||(t.WEBGL_compressed_texture_astc=J5(e,"WEBGL_compressed_texture_astc")),hu.os!==iu.ANDROID&&hu.os!==iu.IOS&&(t.WEBGL_multi_draw=J5(e,"WEBGL_multi_draw")),hu.browserType===eu.UC&&(t.ANGLE_instanced_arrays=null),hu.os===iu.IOS&&hu.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var $5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new Y5,t.cmdAllocator=new M5,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Q5,this._onWebGLContextLost);var t=i5.instance.gl;this.stateCache.initialize(i5.instance.capabilities.maxTextureUnits,i5.instance.capabilities.maxVertexAttributes),this._extensions=Z5(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=_i.RGBA8,i=_i.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),a=t.getParameter(t.STENCIL_BITS);r&&a?i=_i.DEPTH_STENCIL:r&&(i=_i.DEPTH),this._colorTexture=new K5,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new K5,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=i5.instance.createTexture(new Sr(Si.TEX2D,xi.SAMPLED,_i.RGBA8,2,2,Ei.GEN_MIPMAP)),this.nullTexCube=i5.instance.createTexture(new Sr(Si.CUBE,xi.SAMPLED,_i.RGBA8,2,2,Ei.GEN_MIPMAP,6));var o=new lr;o.texExtent.width=2,o.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),i5.instance.copyBuffersToTexture([s],this.nullTex2D,[o]),o.texSubres.layerCount=6,i5.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[o])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(Q5,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(T("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){R(11e3),S(e)},Q(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(ma),e8=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(_i.COUNT),t}Z(t,e);var n=t.prototype;return n.initialize=function(e){i5.setInstance(this),this._gfxAPI=ui.WEBGL;var t=this._bindingMappingInfo=e.bindingMappingInfo,n=[],i=[],r=t.setIndices[0];n[r]=0,i[r]=0;for(var a=1;a<t.setIndices.length;++a){var o=t.setIndices[a],s=t.setIndices[a-1];n[o]=t.maxBlockCounts[s]+n[s],i[o]=t.maxSamplerTextureCounts[s]+i[s]}for(var c=0;c<t.setIndices.length;++c){var l=t.setIndices[c];i[l]-=t.maxBlockCounts[l]}this._bindingMappings={blockOffsets:n,samplerTextureOffsets:i,flexibleSet:t.setIndices[t.setIndices.length-1]};var u=this._context=function(e){var t=null;try{var n={alpha:lt.ENABLE_TRANSPARENT_CANVAS,antialias:lt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(pa.canvas);if(!u)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Kr(Xi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Yr(this._queue)),this._caps.maxVertexAttributes=u.getParameter(u.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=u.getParameter(u.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=u.getParameter(u.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=u.getParameter(u.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=u.getParameter(u.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=u.getParameter(u.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var h=u.getSupportedExtensions(),f="";if(h)for(var _,d=oe(h);!(_=d()).done;)f+=_.value+" ";var p=Z5(u);p.WEBGL_debug_renderer_info?(this._renderer=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=u.getParameter(u.RENDERER),this._vendor=u.getParameter(u.VENDOR));var m=u.getParameter(u.VERSION);this._features.fill(!1),this.initFormatFeatures(p),p.EXT_blend_minmax&&(this._features[fi.BLEND_MINMAX]=!0),p.OES_element_index_uint&&(this._features[fi.ELEMENT_INDEX_UINT]=!0),p.ANGLE_instanced_arrays&&(this._features[fi.INSTANCED_ARRAYS]=!0),p.WEBGL_draw_buffers&&(this._features[fi.MULTIPLE_RENDER_TARGETS]=!0);var v="";return this.getFormatFeatures(_i.ETC_RGB8)&&(v+="etc1 "),this.getFormatFeatures(_i.ETC2_RGB8)&&(v+="etc2 "),this.getFormatFeatures(_i.BC1)&&(v+="dxt "),this.getFormatFeatures(_i.PVRTC_RGB2)&&(v+="pvrtc "),this.getFormatFeatures(_i.ASTC_RGBA_4X4)&&(v+="astc "),T("WebGL device initialized."),T("RENDERER: "+this._renderer),T("VENDOR: "+this._vendor),T("VERSION: "+m),T("COMPRESSED_FORMAT: "+v),T("EXTENSIONS: "+f),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.initFormatFeatures=function(e){this._formatFeatures.fill(Ti.NONE),this._textureExclusive.fill(!0);var t=Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE|Ti.LINEAR_FILTER;this._formatFeatures[_i.RGB8]=t,this._formatFeatures[_i.R5G6B5]=t,this._textureExclusive[_i.R5G6B5]=!1,this._formatFeatures[_i.RGBA8]=t,this._formatFeatures[_i.RGBA4]=t,this._textureExclusive[_i.RGBA4]=!1,this._formatFeatures[_i.RGB5A1]=t,this._textureExclusive[_i.RGB5A1]=!1,this._formatFeatures[_i.DEPTH]=Ti.RENDER_TARGET,this._textureExclusive[_i.DEPTH]=!1,this._formatFeatures[_i.DEPTH_STENCIL]=Ti.RENDER_TARGET,this._textureExclusive[_i.DEPTH_STENCIL]=!1,this._formatFeatures[_i.R8I]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RG8I]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGB8I]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGBA8I]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.R8UI]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RG8UI]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGB8UI]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGBA8UI]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.R8I]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RG8I]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGB8I]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGBA8I]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.R8UI]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RG8UI]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGB8UI]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGBA8UI]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.R32F]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RG32F]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGB32F]|=Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.RGBA32F]|=Ti.VERTEX_ATTRIBUTE,e.EXT_sRGB&&(this._formatFeatures[_i.SRGB8]=t,this._formatFeatures[_i.SRGB8_A8]=t,this._textureExclusive[_i.SRGB8_A8]=!1),e.WEBGL_depth_texture&&(this._formatFeatures[_i.DEPTH]|=t,this._formatFeatures[_i.DEPTH_STENCIL]|=t),e.WEBGL_color_buffer_float&&(this._formatFeatures[_i.RGB32F]|=Ti.RENDER_TARGET,this._formatFeatures[_i.RGBA32F]|=Ti.RENDER_TARGET,this._textureExclusive[_i.RGB32F]=!1,this._textureExclusive[_i.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._formatFeatures[_i.RGB16F]|=Ti.RENDER_TARGET,this._formatFeatures[_i.RGBA16F]|=Ti.RENDER_TARGET,this._textureExclusive[_i.RGB16F]=!1,this._textureExclusive[_i.RGBA16F]=!1),e.OES_texture_float&&(this._formatFeatures[_i.RGB32F]|=Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE,this._formatFeatures[_i.RGBA32F]|=Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE),e.OES_texture_half_float&&(this._formatFeatures[_i.RGB16F]|=Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE,this._formatFeatures[_i.RGBA16F]|=Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE),e.OES_texture_float_linear&&(this._formatFeatures[_i.RGB32F]|=Ti.LINEAR_FILTER,this._formatFeatures[_i.RGBA32F]|=Ti.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[_i.RGB16F]|=Ti.LINEAR_FILTER,this._formatFeatures[_i.RGBA16F]|=Ti.LINEAR_FILTER);var n=Ti.SAMPLED_TEXTURE|Ti.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[_i.ETC_RGB8]=n),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[_i.ETC2_RGB8]=n,this._formatFeatures[_i.ETC2_RGBA8]=n,this._formatFeatures[_i.ETC2_SRGB8]=n,this._formatFeatures[_i.ETC2_SRGB8_A8]=n,this._formatFeatures[_i.ETC2_RGB8_A1]=n,this._formatFeatures[_i.ETC2_SRGB8_A1]=n),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[_i.BC1]=n,this._formatFeatures[_i.BC1_ALPHA]=n,this._formatFeatures[_i.BC1_SRGB]=n,this._formatFeatures[_i.BC1_SRGB_ALPHA]=n,this._formatFeatures[_i.BC2]=n,this._formatFeatures[_i.BC2_SRGB]=n,this._formatFeatures[_i.BC3]=n,this._formatFeatures[_i.BC3_SRGB]=n),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[_i.PVRTC_RGB2]|=n,this._formatFeatures[_i.PVRTC_RGBA2]|=n,this._formatFeatures[_i.PVRTC_RGB4]|=n,this._formatFeatures[_i.PVRTC_RGBA4]|=n),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[_i.ASTC_RGBA_4X4]|=n,this._formatFeatures[_i.ASTC_RGBA_5X4]|=n,this._formatFeatures[_i.ASTC_RGBA_5X5]|=n,this._formatFeatures[_i.ASTC_RGBA_6X5]|=n,this._formatFeatures[_i.ASTC_RGBA_6X6]|=n,this._formatFeatures[_i.ASTC_RGBA_8X5]|=n,this._formatFeatures[_i.ASTC_RGBA_8X6]|=n,this._formatFeatures[_i.ASTC_RGBA_8X8]|=n,this._formatFeatures[_i.ASTC_RGBA_10X5]|=n,this._formatFeatures[_i.ASTC_RGBA_10X6]|=n,this._formatFeatures[_i.ASTC_RGBA_10X8]|=n,this._formatFeatures[_i.ASTC_RGBA_10X10]|=n,this._formatFeatures[_i.ASTC_RGBA_12X10]|=n,this._formatFeatures[_i.ASTC_RGBA_12X12]|=n,this._formatFeatures[_i.ASTC_SRGBA_4X4]|=n,this._formatFeatures[_i.ASTC_SRGBA_5X4]|=n,this._formatFeatures[_i.ASTC_SRGBA_5X5]|=n,this._formatFeatures[_i.ASTC_SRGBA_6X5]|=n,this._formatFeatures[_i.ASTC_SRGBA_6X6]|=n,this._formatFeatures[_i.ASTC_SRGBA_8X5]|=n,this._formatFeatures[_i.ASTC_SRGBA_8X6]|=n,this._formatFeatures[_i.ASTC_SRGBA_8X8]|=n,this._formatFeatures[_i.ASTC_SRGBA_10X5]|=n,this._formatFeatures[_i.ASTC_SRGBA_10X6]|=n,this._formatFeatures[_i.ASTC_SRGBA_10X8]|=n,this._formatFeatures[_i.ASTC_SRGBA_10X10]|=n,this._formatFeatures[_i.ASTC_SRGBA_12X10]|=n,this._formatFeatures[_i.ASTC_SRGBA_12X12]|=n)},n.createCommandBuffer=function(e){var t=new(e.type===Yi.PRIMARY?H5:L5);return t.initialize(e),t},n.createSwapchain=function(e){var t=new $5;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new O5;return t.initialize(e),t},n.createTexture=function(e){var t=new K5;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new n5;return t.initialize(e),t},n.createShader=function(e){var t=new q5;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new B5;return t.initialize(e),t},n.createRenderPass=function(e){var t=new W5;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new F5;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new z5;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new U5;return t.initialize(e),t},n.createPipelineState=function(e){var t=new G5;return t.initialize(e),t},n.createQueue=function(e){var t=new V5;return t.initialize(e),t},n.getSampler=function(e){var t=Na.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new X5(e,t)),this._samplers.get(t)},n.getGeneralBarrier=function(e){var t=Fa.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new Fa(e,t)),this._generalBarrierss.get(t)},n.getTextureBarrier=function(e){var t=Ba.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Ba(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){R5(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache,o=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,o);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),a.glFramebuffer=null,r.deleteFramebuffer(o)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ei.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},Q(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),t}(pa));l.WebGLDevice=e8;var t8,n8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:i};for(var o=0;o<n.length;++o)for(var s=n[o],c=0;c<s.count;c++)a.push({type:s.descriptorType,gpuBuffer:null,gpuTextureView:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&ia?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&ra&&(this._textures[t]&&(e[t].gpuTextureView=this._textures[t].gpuTextureView),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},Q(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Ea);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(t8||(t8={}));var i8=function(){function e(){}return e.setInstance=function(t){e._instance=t},Q(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();i8._instance=null;var r8=[10497,33648,33071,33071],a8=new Float32Array(4);function o8(e,t){switch(e){case _i.R8:return t.UNSIGNED_BYTE;case _i.R8SN:return t.BYTE;case _i.R8UI:return t.UNSIGNED_BYTE;case _i.R8I:return t.BYTE;case _i.R16F:return t.HALF_FLOAT;case _i.R16UI:return t.UNSIGNED_SHORT;case _i.R16I:return t.SHORT;case _i.R32F:return t.FLOAT;case _i.R32UI:return t.UNSIGNED_INT;case _i.R32I:return t.INT;case _i.RG8:return t.UNSIGNED_BYTE;case _i.RG8SN:return t.BYTE;case _i.RG8UI:return t.UNSIGNED_BYTE;case _i.RG8I:return t.BYTE;case _i.RG16F:return t.HALF_FLOAT;case _i.RG16UI:return t.UNSIGNED_SHORT;case _i.RG16I:return t.SHORT;case _i.RG32F:return t.FLOAT;case _i.RG32UI:return t.UNSIGNED_INT;case _i.RG32I:return t.INT;case _i.RGB8:case _i.SRGB8:return t.UNSIGNED_BYTE;case _i.RGB8SN:return t.BYTE;case _i.RGB8UI:return t.UNSIGNED_BYTE;case _i.RGB8I:return t.BYTE;case _i.RGB16F:return t.HALF_FLOAT;case _i.RGB16UI:return t.UNSIGNED_SHORT;case _i.RGB16I:return t.SHORT;case _i.RGB32F:return t.FLOAT;case _i.RGB32UI:return t.UNSIGNED_INT;case _i.RGB32I:return t.INT;case _i.BGRA8:case _i.RGBA8:case _i.SRGB8_A8:return t.UNSIGNED_BYTE;case _i.RGBA8SN:return t.BYTE;case _i.RGBA8UI:return t.UNSIGNED_BYTE;case _i.RGBA8I:return t.BYTE;case _i.RGBA16F:return t.HALF_FLOAT;case _i.RGBA16UI:return t.UNSIGNED_SHORT;case _i.RGBA16I:return t.SHORT;case _i.RGBA32F:return t.FLOAT;case _i.RGBA32UI:return t.UNSIGNED_INT;case _i.RGBA32I:return t.INT;case _i.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case _i.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case _i.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case _i.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case _i.RGB10A2:case _i.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case _i.RGB9E5:case _i.DEPTH:return t.FLOAT;case _i.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case _i.BC1:case _i.BC1_SRGB:case _i.BC2:case _i.BC2_SRGB:case _i.BC3:case _i.BC3_SRGB:case _i.BC4:return t.UNSIGNED_BYTE;case _i.BC4_SNORM:return t.BYTE;case _i.BC5:return t.UNSIGNED_BYTE;case _i.BC5_SNORM:return t.BYTE;case _i.BC6H_SF16:case _i.BC6H_UF16:return t.FLOAT;case _i.BC7:case _i.BC7_SRGB:case _i.ETC_RGB8:case _i.ETC2_RGB8:case _i.ETC2_SRGB8:case _i.ETC2_RGB8_A1:case _i.ETC2_SRGB8_A1:case _i.EAC_R11:return t.UNSIGNED_BYTE;case _i.EAC_R11SN:return t.BYTE;case _i.EAC_RG11:return t.UNSIGNED_BYTE;case _i.EAC_RG11SN:return t.BYTE;case _i.PVRTC_RGB2:case _i.PVRTC_RGBA2:case _i.PVRTC_RGB4:case _i.PVRTC_RGBA4:case _i.PVRTC2_2BPP:case _i.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case _i.ASTC_RGBA_4X4:case _i.ASTC_RGBA_5X4:case _i.ASTC_RGBA_5X5:case _i.ASTC_RGBA_6X5:case _i.ASTC_RGBA_6X6:case _i.ASTC_RGBA_8X5:case _i.ASTC_RGBA_8X6:case _i.ASTC_RGBA_8X8:case _i.ASTC_RGBA_10X5:case _i.ASTC_RGBA_10X6:case _i.ASTC_RGBA_10X8:case _i.ASTC_RGBA_10X10:case _i.ASTC_RGBA_12X10:case _i.ASTC_RGBA_12X12:case _i.ASTC_SRGBA_4X4:case _i.ASTC_SRGBA_5X4:case _i.ASTC_SRGBA_5X5:case _i.ASTC_SRGBA_6X5:case _i.ASTC_SRGBA_6X6:case _i.ASTC_SRGBA_8X5:case _i.ASTC_SRGBA_8X6:case _i.ASTC_SRGBA_8X8:case _i.ASTC_SRGBA_10X5:case _i.ASTC_SRGBA_10X6:case _i.ASTC_SRGBA_10X8:case _i.ASTC_SRGBA_10X10:case _i.ASTC_SRGBA_12X10:case _i.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function s8(e,t){switch(e){case pi.BOOL:return t.BOOL;case pi.BOOL2:return t.BOOL_VEC2;case pi.BOOL3:return t.BOOL_VEC3;case pi.BOOL4:return t.BOOL_VEC4;case pi.INT:return t.INT;case pi.INT2:return t.INT_VEC2;case pi.INT3:return t.INT_VEC3;case pi.INT4:return t.INT_VEC4;case pi.UINT:return t.UNSIGNED_INT;case pi.FLOAT:return t.FLOAT;case pi.FLOAT2:return t.FLOAT_VEC2;case pi.FLOAT3:return t.FLOAT_VEC3;case pi.FLOAT4:return t.FLOAT_VEC4;case pi.MAT2:return t.FLOAT_MAT2;case pi.MAT2X3:return t.FLOAT_MAT2x3;case pi.MAT2X4:return t.FLOAT_MAT2x4;case pi.MAT3X2:return t.FLOAT_MAT3x2;case pi.MAT3:return t.FLOAT_MAT3;case pi.MAT3X4:return t.FLOAT_MAT3x4;case pi.MAT4X2:return t.FLOAT_MAT4x2;case pi.MAT4X3:return t.FLOAT_MAT4x3;case pi.MAT4:return t.FLOAT_MAT4;case pi.SAMPLER2D:return t.SAMPLER_2D;case pi.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case pi.SAMPLER3D:return t.SAMPLER_3D;case pi.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),pi.UNKNOWN}}function c8(e,t){switch(e){case t.BOOL:return pi.BOOL;case t.BOOL_VEC2:return pi.BOOL2;case t.BOOL_VEC3:return pi.BOOL3;case t.BOOL_VEC4:return pi.BOOL4;case t.INT:return pi.INT;case t.INT_VEC2:return pi.INT2;case t.INT_VEC3:return pi.INT3;case t.INT_VEC4:return pi.INT4;case t.UNSIGNED_INT:return pi.UINT;case t.UNSIGNED_INT_VEC2:return pi.UINT2;case t.UNSIGNED_INT_VEC3:return pi.UINT3;case t.UNSIGNED_INT_VEC4:return pi.UINT4;case t.FLOAT:return pi.FLOAT;case t.FLOAT_VEC2:return pi.FLOAT2;case t.FLOAT_VEC3:return pi.FLOAT3;case t.FLOAT_VEC4:return pi.FLOAT4;case t.FLOAT_MAT2:return pi.MAT2;case t.FLOAT_MAT2x3:return pi.MAT2X3;case t.FLOAT_MAT2x4:return pi.MAT2X4;case t.FLOAT_MAT3x2:return pi.MAT3X2;case t.FLOAT_MAT3:return pi.MAT3;case t.FLOAT_MAT3x4:return pi.MAT3X4;case t.FLOAT_MAT4x2:return pi.MAT4X2;case t.FLOAT_MAT4x3:return pi.MAT4X3;case t.FLOAT_MAT4:return pi.MAT4;case t.SAMPLER_2D:return pi.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return pi.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return pi.SAMPLER3D;case t.SAMPLER_CUBE:return pi.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),pi.UNKNOWN}}function l8(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function u8(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var h8,f8=[512,513,514,515,516,517,518,519],_8=[0,7680,7681,7682,7683,5386,34055,34056],d8=[32774,32778,32779,32775,32776],p8=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(h8||(h8={}));var m8=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},v8=function(e){function t(){var t;return(t=e.call(this,h8.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new ir,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return Z(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(m8),g8=function(e){function t(){var t;return(t=e.call(this,h8.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new ea,t}return Z(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},t}(m8),y8=function(e){function t(){var t;return(t=e.call(this,h8.DRAW)||this).drawInfo=new vr,t}return Z(t,e),t.prototype.clear=function(){},t}(m8),S8=function(e){function t(){var t;return(t=e.call(this,h8.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return Z(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(m8),x8=function(e){function t(){var t;return(t=e.call(this,h8.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return Z(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(m8),E8=function(){function e(){this.cmds=new jl(1),this.beginRenderPassCmds=new jl(1),this.bindStatesCmds=new jl(1),this.drawCmds=new jl(1),this.updateBufferCmds=new jl(1),this.copyBufferToTextureCmds=new jl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function T8(e,t,n,i,r){if(t.usage&mi.INDIRECT){t.indirects.clearDraws();for(var a=n.drawInfos,o=0;o<a.length;++o)t.indirects.setDrawInfo(i+o,a[o])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),b8.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),b8.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function C8(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case _i.A8:return t.ALPHA;case _i.L8:return t.LUMINANCE;case _i.LA8:return t.LUMINANCE_ALPHA;case _i.R8:return t.R8;case _i.R8SN:return t.R8_SNORM;case _i.R8UI:return t.R8UI;case _i.R8I:return t.R8I;case _i.RG8:return t.RG8;case _i.RG8SN:return t.RG8_SNORM;case _i.RG8UI:return t.RG8UI;case _i.RG8I:return t.RG8I;case _i.RGB8:return t.RGB8;case _i.RGB8SN:return t.RGB8_SNORM;case _i.RGB8UI:return t.RGB8UI;case _i.RGB8I:return t.RGB8I;case _i.BGRA8:case _i.RGBA8:return t.RGBA8;case _i.RGBA8SN:return t.RGBA8_SNORM;case _i.RGBA8UI:return t.RGBA8UI;case _i.RGBA8I:return t.RGBA8I;case _i.R16I:return t.R16I;case _i.R16UI:return t.R16UI;case _i.R16F:return t.R16F;case _i.RG16I:return t.RG16I;case _i.RG16UI:return t.RG16UI;case _i.RG16F:return t.RG16F;case _i.RGB16I:return t.RGB16I;case _i.RGB16UI:return t.RGB16UI;case _i.RGB16F:return t.RGB16F;case _i.RGBA16I:return t.RGBA16I;case _i.RGBA16UI:return t.RGBA16UI;case _i.RGBA16F:return t.RGBA16F;case _i.R32I:return t.R32I;case _i.R32UI:return t.R32UI;case _i.R32F:return t.R32F;case _i.RG32I:return t.RG32I;case _i.RG32UI:return t.RG32UI;case _i.RG32F:return t.RG32F;case _i.RGB32I:return t.RGB32I;case _i.RGB32UI:return t.RGB32UI;case _i.RGB32F:return t.RGB32F;case _i.RGBA32I:return t.RGBA32I;case _i.RGBA32UI:return t.RGBA32UI;case _i.RGBA32F:return t.RGBA32F;case _i.R5G6B5:return t.RGB565;case _i.RGB5A1:return t.RGB5_A1;case _i.RGBA4:return t.RGBA4;case _i.SRGB8:return t.SRGB8;case _i.SRGB8_A8:return t.SRGB8_ALPHA8;case _i.RGB10A2:return t.RGB10_A2;case _i.RGB10A2UI:return t.RGB10_A2UI;case _i.R11G11B10F:return t.R11F_G11F_B10F;case _i.DEPTH:return t.DEPTH_COMPONENT32F;case _i.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case _i.BC1:return t8.COMPRESSED_RGB_S3TC_DXT1_EXT;case _i.BC1_ALPHA:return t8.COMPRESSED_RGBA_S3TC_DXT1_EXT;case _i.BC1_SRGB:return t8.COMPRESSED_SRGB_S3TC_DXT1_EXT;case _i.BC1_SRGB_ALPHA:return t8.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case _i.BC2:return t8.COMPRESSED_RGBA_S3TC_DXT3_EXT;case _i.BC2_SRGB:return t8.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case _i.BC3:return t8.COMPRESSED_RGBA_S3TC_DXT5_EXT;case _i.BC3_SRGB:return t8.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case _i.ETC_RGB8:return t8.COMPRESSED_RGB_ETC1_WEBGL;case _i.ETC2_RGB8:return t8.COMPRESSED_RGB8_ETC2;case _i.ETC2_SRGB8:return t8.COMPRESSED_SRGB8_ETC2;case _i.ETC2_RGB8_A1:return t8.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_SRGB8_A1:return t8.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_RGBA8:return t8.COMPRESSED_RGBA8_ETC2_EAC;case _i.ETC2_SRGB8_A8:return t8.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case _i.EAC_R11:return t8.COMPRESSED_R11_EAC;case _i.EAC_R11SN:return t8.COMPRESSED_SIGNED_R11_EAC;case _i.EAC_RG11:return t8.COMPRESSED_RG11_EAC;case _i.EAC_RG11SN:return t8.COMPRESSED_SIGNED_RG11_EAC;case _i.PVRTC_RGB2:return t8.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGBA2:return t8.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGB4:return t8.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case _i.PVRTC_RGBA4:return t8.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case _i.ASTC_RGBA_4X4:return t8.COMPRESSED_RGBA_ASTC_4x4_KHR;case _i.ASTC_RGBA_5X4:return t8.COMPRESSED_RGBA_ASTC_5x4_KHR;case _i.ASTC_RGBA_5X5:return t8.COMPRESSED_RGBA_ASTC_5x5_KHR;case _i.ASTC_RGBA_6X5:return t8.COMPRESSED_RGBA_ASTC_6x5_KHR;case _i.ASTC_RGBA_6X6:return t8.COMPRESSED_RGBA_ASTC_6x6_KHR;case _i.ASTC_RGBA_8X5:return t8.COMPRESSED_RGBA_ASTC_8x5_KHR;case _i.ASTC_RGBA_8X6:return t8.COMPRESSED_RGBA_ASTC_8x6_KHR;case _i.ASTC_RGBA_8X8:return t8.COMPRESSED_RGBA_ASTC_8x8_KHR;case _i.ASTC_RGBA_10X5:return t8.COMPRESSED_RGBA_ASTC_10x5_KHR;case _i.ASTC_RGBA_10X6:return t8.COMPRESSED_RGBA_ASTC_10x6_KHR;case _i.ASTC_RGBA_10X8:return t8.COMPRESSED_RGBA_ASTC_10x8_KHR;case _i.ASTC_RGBA_10X10:return t8.COMPRESSED_RGBA_ASTC_10x10_KHR;case _i.ASTC_RGBA_12X10:return t8.COMPRESSED_RGBA_ASTC_12x10_KHR;case _i.ASTC_RGBA_12X12:return t8.COMPRESSED_RGBA_ASTC_12x12_KHR;case _i.ASTC_SRGBA_4X4:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case _i.ASTC_SRGBA_5X4:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case _i.ASTC_SRGBA_5X5:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case _i.ASTC_SRGBA_6X5:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case _i.ASTC_SRGBA_6X6:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case _i.ASTC_SRGBA_8X5:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case _i.ASTC_SRGBA_8X6:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case _i.ASTC_SRGBA_8X8:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case _i.ASTC_SRGBA_10X5:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case _i.ASTC_SRGBA_10X6:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case _i.ASTC_SRGBA_10X8:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case _i.ASTC_SRGBA_10X10:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case _i.ASTC_SRGBA_12X10:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case _i.ASTC_SRGBA_12X12:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=function(e,t){switch(e){case _i.A8:return t.ALPHA;case _i.L8:return t.LUMINANCE;case _i.LA8:return t.LUMINANCE_ALPHA;case _i.R8:case _i.R8SN:return t.RED;case _i.R8UI:case _i.R8I:return t.RED;case _i.RG8:case _i.RG8SN:case _i.RG8UI:case _i.RG8I:return t.RG;case _i.RGB8:case _i.RGB8SN:case _i.RGB8UI:case _i.RGB8I:return t.RGB;case _i.BGRA8:case _i.RGBA8:case _i.RGBA8SN:case _i.RGBA8UI:case _i.RGBA8I:return t.RGBA;case _i.R16UI:case _i.R16I:case _i.R16F:return t.RED;case _i.RG16UI:case _i.RG16I:case _i.RG16F:return t.RG;case _i.RGB16UI:case _i.RGB16I:case _i.RGB16F:return t.RGB;case _i.RGBA16UI:case _i.RGBA16I:case _i.RGBA16F:return t.RGBA;case _i.R32UI:case _i.R32I:case _i.R32F:return t.RED;case _i.RG32UI:case _i.RG32I:case _i.RG32F:return t.RG;case _i.RGB32UI:case _i.RGB32I:case _i.RGB32F:return t.RGB;case _i.RGBA32UI:case _i.RGBA32I:case _i.RGBA32F:case _i.RGB10A2:return t.RGBA;case _i.R11G11B10F:case _i.R5G6B5:return t.RGB;case _i.RGB5A1:case _i.RGBA4:return t.RGBA;case _i.SRGB8:return t.RGB;case _i.SRGB8_A8:return t.RGBA;case _i.DEPTH:return t.DEPTH_COMPONENT;case _i.DEPTH_STENCIL:return t.DEPTH_STENCIL;case _i.BC1:return t8.COMPRESSED_RGB_S3TC_DXT1_EXT;case _i.BC1_ALPHA:return t8.COMPRESSED_RGBA_S3TC_DXT1_EXT;case _i.BC1_SRGB:return t8.COMPRESSED_SRGB_S3TC_DXT1_EXT;case _i.BC1_SRGB_ALPHA:return t8.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case _i.BC2:return t8.COMPRESSED_RGBA_S3TC_DXT3_EXT;case _i.BC2_SRGB:return t8.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case _i.BC3:return t8.COMPRESSED_RGBA_S3TC_DXT5_EXT;case _i.BC3_SRGB:return t8.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case _i.ETC_RGB8:return t8.COMPRESSED_RGB_ETC1_WEBGL;case _i.ETC2_RGB8:return t8.COMPRESSED_RGB8_ETC2;case _i.ETC2_SRGB8:return t8.COMPRESSED_SRGB8_ETC2;case _i.ETC2_RGB8_A1:return t8.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_SRGB8_A1:return t8.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _i.ETC2_RGBA8:return t8.COMPRESSED_RGBA8_ETC2_EAC;case _i.ETC2_SRGB8_A8:return t8.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case _i.EAC_R11:return t8.COMPRESSED_R11_EAC;case _i.EAC_R11SN:return t8.COMPRESSED_SIGNED_R11_EAC;case _i.EAC_RG11:return t8.COMPRESSED_RG11_EAC;case _i.EAC_RG11SN:return t8.COMPRESSED_SIGNED_RG11_EAC;case _i.PVRTC_RGB2:return t8.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGBA2:return t8.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case _i.PVRTC_RGB4:return t8.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case _i.PVRTC_RGBA4:return t8.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case _i.ASTC_RGBA_4X4:return t8.COMPRESSED_RGBA_ASTC_4x4_KHR;case _i.ASTC_RGBA_5X4:return t8.COMPRESSED_RGBA_ASTC_5x4_KHR;case _i.ASTC_RGBA_5X5:return t8.COMPRESSED_RGBA_ASTC_5x5_KHR;case _i.ASTC_RGBA_6X5:return t8.COMPRESSED_RGBA_ASTC_6x5_KHR;case _i.ASTC_RGBA_6X6:return t8.COMPRESSED_RGBA_ASTC_6x6_KHR;case _i.ASTC_RGBA_8X5:return t8.COMPRESSED_RGBA_ASTC_8x5_KHR;case _i.ASTC_RGBA_8X6:return t8.COMPRESSED_RGBA_ASTC_8x6_KHR;case _i.ASTC_RGBA_8X8:return t8.COMPRESSED_RGBA_ASTC_8x8_KHR;case _i.ASTC_RGBA_10X5:return t8.COMPRESSED_RGBA_ASTC_10x5_KHR;case _i.ASTC_RGBA_10X6:return t8.COMPRESSED_RGBA_ASTC_10x6_KHR;case _i.ASTC_RGBA_10X8:return t8.COMPRESSED_RGBA_ASTC_10x8_KHR;case _i.ASTC_RGBA_10X10:return t8.COMPRESSED_RGBA_ASTC_10x10_KHR;case _i.ASTC_RGBA_12X10:return t8.COMPRESSED_RGBA_ASTC_12x10_KHR;case _i.ASTC_RGBA_12X12:return t8.COMPRESSED_RGBA_ASTC_12x12_KHR;case _i.ASTC_SRGBA_4X4:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case _i.ASTC_SRGBA_5X4:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case _i.ASTC_SRGBA_5X5:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case _i.ASTC_SRGBA_6X5:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case _i.ASTC_SRGBA_6X6:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case _i.ASTC_SRGBA_8X5:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case _i.ASTC_SRGBA_8X6:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case _i.ASTC_SRGBA_8X8:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case _i.ASTC_SRGBA_10X5:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case _i.ASTC_SRGBA_10X6:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case _i.ASTC_SRGBA_10X8:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case _i.ASTC_SRGBA_10X10:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case _i.ASTC_SRGBA_12X10:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case _i.ASTC_SRGBA_12X12:return t8.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=o8(t.format,n);var i=t.width,r=t.height;switch(t.type){case Si.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&O(9100,a,e.capabilities.maxTextureSize),t.samples===Ci.ONE){if(t.glTexture=n.createTexture(),t.size>0){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),na[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=sa(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r)}}else t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Si.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>e.capabilities.maxCubeMapTextureSize&&O(9100,u,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),na[t.format].isCompressed)for(var f=0;f<t.mipLevel;++f){for(var _=sa(t.format,i,r,1),d=new Uint8Array(_),p=0;p<6;++p)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,f,t.glInternalFmt,i,r,0,d);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Si.TEX2D,t.glTarget=n.TEXTURE_2D}}function A8(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var a=0;a<i.length;++a)i[a].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+a),r=a,n.bindTexture(t.glTarget,null),i[a].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var o=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),o===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),o=null),t.glRenderbuffer=null}}var b8={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function I8(e,t,n,i,r,a,o){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),b8.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==_i.UNKNOWN)switch(h.loadOp){case Mi.LOAD:break;case Mi.CLEAR:if(c.bs.targets[0].blendColorMask!==Oi.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)a8[0]=r[u].x,a8[1]=r[u].y,a8[2]=r[u].z,a8[3]=r[u].w,s.clearBufferfv(s.COLOR,u,a8);else{var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT}break;case Mi.DISCARD:b8.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==_i.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Mi.LOAD:break;case Mi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),l|=s.DEPTH_BUFFER_BIT;break;case Mi.DISCARD:b8.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(na[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Mi.LOAD:break;case Mi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),l|=s.STENCIL_BUFFER_BIT;break;case Mi.DISCARD:b8.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&b8.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,b8.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var _=c.bs.targets[0].blendColorMask;if(_!==Oi.ALL){var d=(_&Oi.R)!==Oi.NONE,p=(_&Oi.G)!==Oi.NONE,m=(_&Oi.B)!==Oi.NONE,v=(_&Oi.A)!==Oi.NONE;s.colorMask(d,p,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function w8(e,t,n,i,r,a){var o=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&b8.gpuPipelineState!==t){if(b8.gpuPipelineState=t,b8.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(o.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Hi.NONE:o.disable(o.CULL_FACE);break;case Hi.FRONT:o.enable(o.CULL_FACE),o.cullFace(o.FRONT);break;case Hi.BACK:o.enable(o.CULL_FACE),o.cullFace(o.BACK)}e.stateCache.rs.cullMode=h.cullMode}var f=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==f&&(o.frontFace(f?o.CCW:o.CW),e.stateCache.rs.isFrontFaceCCW=f),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(o.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(o.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var _=t.dss;_&&(s.dss.depthTest!==_.depthTest&&(_.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),s.dss.depthTest=_.depthTest),s.dss.depthWrite!==_.depthWrite&&(o.depthMask(_.depthWrite),s.dss.depthWrite=_.depthWrite),s.dss.depthFunc!==_.depthFunc&&(o.depthFunc(f8[_.depthFunc]),s.dss.depthFunc=_.depthFunc),s.dss.stencilTestFront===_.stencilTestFront&&s.dss.stencilTestBack===_.stencilTestBack||(_.stencilTestFront||_.stencilTestBack?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),s.dss.stencilTestFront=_.stencilTestFront,s.dss.stencilTestBack=_.stencilTestBack),s.dss.stencilFuncFront===_.stencilFuncFront&&s.dss.stencilRefFront===_.stencilRefFront&&s.dss.stencilReadMaskFront===_.stencilReadMaskFront||(o.stencilFuncSeparate(o.FRONT,f8[_.stencilFuncFront],_.stencilRefFront,_.stencilReadMaskFront),s.dss.stencilFuncFront=_.stencilFuncFront,s.dss.stencilRefFront=_.stencilRefFront,s.dss.stencilReadMaskFront=_.stencilReadMaskFront),s.dss.stencilFailOpFront===_.stencilFailOpFront&&s.dss.stencilZFailOpFront===_.stencilZFailOpFront&&s.dss.stencilPassOpFront===_.stencilPassOpFront||(o.stencilOpSeparate(o.FRONT,_8[_.stencilFailOpFront],_8[_.stencilZFailOpFront],_8[_.stencilPassOpFront]),s.dss.stencilFailOpFront=_.stencilFailOpFront,s.dss.stencilZFailOpFront=_.stencilZFailOpFront,s.dss.stencilPassOpFront=_.stencilPassOpFront),s.dss.stencilWriteMaskFront!==_.stencilWriteMaskFront&&(o.stencilMaskSeparate(o.FRONT,_.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=_.stencilWriteMaskFront),s.dss.stencilFuncBack===_.stencilFuncBack&&s.dss.stencilRefBack===_.stencilRefBack&&s.dss.stencilReadMaskBack===_.stencilReadMaskBack||(o.stencilFuncSeparate(o.BACK,f8[_.stencilFuncBack],_.stencilRefBack,_.stencilReadMaskBack),s.dss.stencilFuncBack=_.stencilFuncBack,s.dss.stencilRefBack=_.stencilRefBack,s.dss.stencilReadMaskBack=_.stencilReadMaskBack),s.dss.stencilFailOpBack===_.stencilFailOpBack&&s.dss.stencilZFailOpBack===_.stencilZFailOpBack&&s.dss.stencilPassOpBack===_.stencilPassOpBack||(o.stencilOpSeparate(o.BACK,_8[_.stencilFailOpBack],_8[_.stencilZFailOpBack],_8[_.stencilPassOpBack]),s.dss.stencilFailOpBack=_.stencilFailOpBack,s.dss.stencilZFailOpBack=_.stencilZFailOpBack,s.dss.stencilPassOpBack=_.stencilPassOpBack),s.dss.stencilWriteMaskBack!==_.stencilWriteMaskBack&&(o.stencilMaskSeparate(o.BACK,_.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=_.stencilWriteMaskBack));var d=t.bs;if(d){s.bs.isA2C!==d.isA2C&&(d.isA2C?o.enable(o.SAMPLE_ALPHA_TO_COVERAGE):o.disable(o.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=d.isA2C),s.bs.blendColor.x===d.blendColor.x&&s.bs.blendColor.y===d.blendColor.y&&s.bs.blendColor.z===d.blendColor.z&&s.bs.blendColor.w===d.blendColor.w||(o.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),s.bs.blendColor.x=d.blendColor.x,s.bs.blendColor.y=d.blendColor.y,s.bs.blendColor.z=d.blendColor.z,s.bs.blendColor.w=d.blendColor.w);var p=d.targets[0],m=s.bs.targets[0];m.blend!==p.blend&&(p.blend?o.enable(o.BLEND):o.disable(o.BLEND),m.blend=p.blend),m.blendEq===p.blendEq&&m.blendAlphaEq===p.blendAlphaEq||(o.blendEquationSeparate(d8[p.blendEq],d8[p.blendAlphaEq]),m.blendEq=p.blendEq,m.blendAlphaEq=p.blendAlphaEq),m.blendSrc===p.blendSrc&&m.blendDst===p.blendDst&&m.blendSrcAlpha===p.blendSrcAlpha&&m.blendDstAlpha===p.blendDstAlpha||(o.blendFuncSeparate(p8[p.blendSrc],p8[p.blendDst],p8[p.blendSrcAlpha],p8[p.blendDstAlpha]),m.blendSrc=p.blendSrc,m.blendDst=p.blendDst,m.blendSrcAlpha=p.blendSrcAlpha,m.blendDstAlpha=p.blendDstAlpha),m.blendColorMask!==p.blendColorMask&&(o.colorMask((p.blendColorMask&Oi.R)!==Oi.NONE,(p.blendColorMask&Oi.G)!==Oi.NONE,(p.blendColorMask&Oi.B)!==Oi.NONE,(p.blendColorMask&Oi.A)!==Oi.NONE),m.blendColorMask=p.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var v=c.glBlocks.length,g=t.gpuPipelineLayout.dynamicOffsetIndices,y=0;y<v;y++){var S=c.glBlocks[y],E=i[S.set],T=E&&E.descriptorIndices[S.binding],C=T>=0&&E.gpuDescriptors[T];if(C&&C.gpuBuffer){var A=g[S.set],b=A&&A[S.binding],I=C.gpuBuffer.glOffset;b>=0&&(I+=r[b]),s.glBindUBOs[S.glBinding]===C.gpuBuffer.glBuffer&&s.glBindUBOOffsets[S.glBinding]===I||(I?o.bindBufferRange(o.UNIFORM_BUFFER,S.glBinding,C.gpuBuffer.glBuffer,I,C.gpuBuffer.size):o.bindBufferBase(o.UNIFORM_BUFFER,S.glBinding,C.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[S.glBinding]=C.gpuBuffer.glBuffer,s.glBindUBOOffsets[S.glBinding]=I)}else x("Buffer binding '"+S.name+"' at set "+S.set+" binding "+S.binding+" is not bounded")}for(var w=c.glSamplerTextures.length,P=0;P<w;P++)for(var R=c.glSamplerTextures[P],D=i[R.set],O=D&&D.descriptorIndices[R.binding],N=O>=0&&D.gpuDescriptors[O],M=0;M<R.units.length;M++){var L=R.units[M],F=s.glTexUnits[L];if(N&&N.gpuTextureView&&N.gpuTextureView.gpuTexture&&N.gpuSampler){var B=N.gpuTextureView,z=B.gpuTexture,U=B.baseLevel,k=U+B.levelCount;if(z.size>0){F.glTexture!==z.glTexture&&(s.texUnit!==L&&(o.activeTexture(o.TEXTURE0+L),s.texUnit=L),z.glTexture?o.bindTexture(z.glTarget,z.glTexture):o.bindTexture(z.glTarget,e.nullTex2D.gpuTexture.glTexture),F.glTexture=z.glTexture);var G=N.gpuSampler.getGLSampler(e,U,k);s.glSamplerUnits[L]!==G&&(o.bindSampler(L,G),s.glSamplerUnits[L]=G)}N=D.gpuDescriptors[++O]}else x("Sampler binding '"+R.name+"' at set "+R.set+" binding "+R.binding+" index "+M+" is not bounded")}}if(n&&c&&(l||b8.gpuInputAssembler!==n))if(b8.gpuInputAssembler=n,e.extensions.useVAO){var H=n.glVAOs.get(c.glProgram);if(!H){var V;H=o.createVertexArray(),n.glVAOs.set(c.glProgram,H),o.bindVertexArray(H),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var W=0;W<c.glInputs.length;W++){var j=c.glInputs[W];V=null;for(var X=0;X<n.glAttribs.length;X++){var q=n.glAttribs[X];if(q.name===j.name){V=q;break}}if(V){s.glArrayBuffer!==V.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,V.glBuffer),s.glArrayBuffer=V.glBuffer);for(var Y=0;Y<V.componentCount;++Y){var K=j.glLoc+Y,Q=V.offset+V.size*Y;o.enableVertexAttribArray(K),s.glCurrentAttribLocs[K]=!0,o.vertexAttribPointer(K,V.count,V.glType,V.isNormalized,V.stride,Q),o.vertexAttribDivisor(K,V.isInstanced?1:0)}}}var J=n.gpuIndexBuffer;J&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,J.glBuffer),o.bindVertexArray(null),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==H&&(o.bindVertexArray(H),s.glVAO=H)}else{for(var Z=0;Z<e.capabilities.maxVertexAttributes;++Z)s.glCurrentAttribLocs[Z]=!1;for(var $=0;$<c.glInputs.length;$++){for(var ee=c.glInputs[$],te=null,ne=0;ne<n.glAttribs.length;ne++){var ie=n.glAttribs[ne];if(ie.name===ee.name){te=ie;break}}if(te){s.glArrayBuffer!==te.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,te.glBuffer),s.glArrayBuffer=te.glBuffer);for(var re=0;re<te.componentCount;++re){var ae=ee.glLoc+re,oe=te.offset+te.size*re;!s.glEnabledAttribLocs[ae]&&ae>=0&&(o.enableVertexAttribArray(ae),s.glEnabledAttribLocs[ae]=!0),s.glCurrentAttribLocs[ae]=!0,o.vertexAttribPointer(ae,te.count,te.glType,te.isNormalized,te.stride,oe),o.vertexAttribDivisor(ae,te.isInstanced?1:0)}}}var se=n.gpuIndexBuffer;se&&s.glElementArrayBuffer!==se.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,se.glBuffer),s.glElementArrayBuffer=se.glBuffer);for(var ce=0;ce<e.capabilities.maxVertexAttributes;++ce)s.glEnabledAttribLocs[ce]!==s.glCurrentAttribLocs[ce]&&(o.disableVertexAttribArray(ce),s.glEnabledAttribLocs[ce]=!1)}if(t&&t.dynamicStates.length)for(var le=t.dynamicStates.length,ue=0;ue<le;ue++)switch(t.dynamicStates[ue]){case Vi.LINE_WIDTH:s.rs.lineWidth!==a.lineWidth&&(o.lineWidth(a.lineWidth),s.rs.lineWidth=a.lineWidth);break;case Vi.DEPTH_BIAS:s.rs.depthBias===a.depthBiasConstant&&s.rs.depthBiasSlop===a.depthBiasSlope||(o.polygonOffset(a.depthBiasConstant,a.depthBiasSlope),s.rs.depthBias=a.depthBiasConstant,s.rs.depthBiasSlop=a.depthBiasSlope);break;case Vi.BLEND_CONSTANTS:var he=a.blendConstant;s.bs.blendColor.x===he.x&&s.bs.blendColor.y===he.y&&s.bs.blendColor.z===he.z&&s.bs.blendColor.w===he.w||(o.blendColor(he.x,he.y,he.z,he.w),s.bs.blendColor.copy(he));break;case Vi.STENCIL_WRITE_MASK:var fe=a.stencilStatesFront,_e=a.stencilStatesBack;s.dss.stencilWriteMaskFront!==fe.writeMask&&(o.stencilMaskSeparate(o.FRONT,fe.writeMask),s.dss.stencilWriteMaskFront=fe.writeMask),s.dss.stencilWriteMaskBack!==_e.writeMask&&(o.stencilMaskSeparate(o.BACK,_e.writeMask),s.dss.stencilWriteMaskBack=_e.writeMask);break;case Vi.STENCIL_COMPARE_MASK:var de=a.stencilStatesFront,pe=a.stencilStatesBack;s.dss.stencilRefFront===de.reference&&s.dss.stencilReadMaskFront===de.compareMask||(o.stencilFuncSeparate(o.FRONT,f8[s.dss.stencilFuncFront],de.reference,de.compareMask),s.dss.stencilRefFront=de.reference,s.dss.stencilReadMaskFront=de.compareMask),s.dss.stencilRefBack===pe.reference&&s.dss.stencilReadMaskBack===pe.compareMask||(o.stencilFuncSeparate(o.BACK,f8[s.dss.stencilFuncBack],pe.reference,pe.compareMask),s.dss.stencilRefBack=pe.reference,s.dss.stencilReadMaskBack=pe.compareMask)}}function P8(e,t){var n=e.gl,i=b8.gpuInputAssembler,r=b8.glPrimitive,a=e.extensions.WEBGL_multi_draw;if(i){var o=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*o.stride;if(a)s.instancedDraw?a.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):a.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(a)s.instancedDraw?a.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):a.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(t.instanceCount)if(o){if(t.indexCount>0){var h=t.firstIndex*o.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(o){if(t.indexCount>0){var f=t.firstIndex*o.stride;n.drawElements(r,t.indexCount,i.glIndexType,f)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}var R8=new Array(h8.COUNT);function D8(e,t){R8.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=R8[i]++;switch(i){case h8.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];I8(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case h8.BIND_STATES:var o=t.bindStatesCmds.array[r];w8(e,o.gpuPipelineState,o.gpuInputAssembler,o.gpuDescriptorSets,o.dynamicOffsets,o.dynamicStates);break;case h8.DRAW:P8(e,t.drawCmds.array[r].drawInfo);break;case h8.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];T8(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case h8.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];O8(e,c.buffers,c.gpuTexture,c.regions)}}}function O8(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=1,c=1,l=0,u=na[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var _=t[o++];u?n.glInternalFmt!==t8.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,_):r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,_):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,_)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[o++];u?n.glInternalFmt!==t8.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ei.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var N8=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=a(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),M8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new N8,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&yi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&mi.VERTEX){t.glTarget=n.ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),b8.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&mi.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),b8.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&mi.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&mi.INDIRECT||t.usage&mi.TRANSFER_DST||t.usage&mi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(i8.instance,this._gpuBuffer),i8.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),b8.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),b8.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(i8.instance,this._gpuBuffer),i8.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&yi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&mi.VERTEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),b8.gpuInputAssembler=null,i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&mi.INDEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),b8.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&mi.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&mi.INDIRECT||t.usage&mi.TRANSFER_DST||t.usage&mi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(i8.instance,this._gpuBuffer),i8.instance.memoryStatus.bufferSize-=t,i8.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&mi.INDIRECT?0:e.byteLength,T8(i8.instance,this._gpuBuffer,e,0,n))},Q(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(_a),L8=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new jl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var a=i,o=0;a<t;++a,++o)this._frees[a]=n[o];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),F8=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new L8(v8,1),this.bindStatesCmdPool=new L8(g8,1),this.drawCmdPool=new L8(y8,1),this.updateBufferCmdPool=new L8(S8,1),this.copyBufferToTextureCmdPool=new L8(x8,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),B8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new E8,t._cmdAllocator=new F8,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new ea,t._isStateInvalied=!1,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=i8.instance.bindingMappings.blockOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,a){var o=this._cmdAllocator.beginRenderPassCmdPool.alloc(v8);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea.copy(n);for(var s=0;s<i.length;++s)o.clearColors[s]=i[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(h8.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,a=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(a){for(var o=this._curDynamicOffsets,s=a.dynamicOffsetOffsets[e],c=0;c<n.length;c++)o[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Wi.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Wi.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Wi.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Wi.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Yi.PRIMARY&&this._isInRenderPass||this._type===Yi.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(y8);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(h8.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=e.gpuBuffer;if(i){var r,a=this._cmdAllocator.updateBufferCmdPool.alloc(S8),o=0;e.usage&mi.INDIRECT||(o=void 0!==n?n:t.byteLength),r=t,a.gpuBuffer=i,a.buffer=r,a.offset=0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(h8.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(x8);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(h8.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var a=i.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<i.cmdPackage.bindStatesCmds.length;++o){var s=i.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var _=i.cmdPackage.copyBufferToTextureCmds.array[f];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(g8);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(h8.BIND_STATES),this._isStateInvalied=!1},t}(da),z8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTextureView)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTextureView);var a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.width:this.gpuDepthStencilView.gpuTexture.width},set width(e){a=e},get height(){return this.isOffscreen?a:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.height:this.gpuDepthStencilView.gpuTexture.height},set height(e){}},function(e,t){for(var n=0;n<t.gpuColorViews.length;++n)if(t.gpuColorViews[n].gpuTexture.isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],a=i.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var o=0;o<t.gpuColorViews.length;++o){var s=t.gpuColorViews[o],c=s.gpuTexture;c&&(c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,c.glTarget,c.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+o,i.RENDERBUFFER,c.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+o),t.width=Math.min(t.width,c.width>>s.baseLevel),t.height=Math.min(t.height,c.height>>s.baseLevel))}var l=t.gpuDepthStencilView;if(l){var u=l.gpuTexture,h=na[u.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;u.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,h,u.glTarget,u.glTexture,t.gpuDepthStencilView.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,h,i.RENDERBUFFER,u.glRenderbuffer),t.width=Math.min(t.width,u.width>>l.baseLevel),t.height=Math.min(t.height,u.height>>l.baseLevel)}i.drawBuffers(r);var f=i.checkFramebufferStatus(i.FRAMEBUFFER);if(f!==i.FRAMEBUFFER_COMPLETE)switch(f){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(i8.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=i8.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},Q(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(va),U8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],c=o8(a.format,n),l=na[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:c,size:l,count:na[a.format].count,stride:s.stride,componentCount:u8(c,n),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:i[o]},i[o]+=l}}(i8.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=i8.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.gl,a=e.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),a===i.value&&(r.bindVertexArray(null),a=null),i=n.next();e.stateCache.glVAO=a,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},Q(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(xa),k8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var a=this._bindings[r];i.push(t),t+=a.count,a.binding>n&&(n=a.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var o=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,o[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&aa)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:o,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},Q(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Ta),G8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],a=0;a<this._setLayouts.length;a++){for(var o=this._setLayouts[a],s=o.gpuDescriptorSetLayout.dynamicBindings,c=Array(o.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(o.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},Q(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Ca),H8=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],V8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],a=0;a<31;a++)this._dynamicStates&1<<a&&r.push(1<<a);this._gpuPipelineState={glPrimitive:H8[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},Q(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Ra),W8=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,a){I8(i8.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,a),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;P8(i8.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=i8.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=i8.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&mi.INDIRECT?0:t.byteLength,T8(i8.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&O8(i8.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];D8(i8.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){w8(i8.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(B8),j8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Da),X8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},Q(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(Oa),q8=function(e){function t(t,n){var i,r,a,o;return(i=e.call(this,t,n)||this)._gpuSampler=null,i._gpuSampler={glSamplers:new Map,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0,getGLSampler:function(e,t,n){var i=e.gl,r=t<<16|n;if(!this.glSamplers.has(r)){var a=i.createSampler();a&&(this.glSamplers.set(r,a),i.samplerParameteri(a,i.TEXTURE_MIN_FILTER,this.glMinFilter),i.samplerParameteri(a,i.TEXTURE_MAG_FILTER,this.glMagFilter),i.samplerParameteri(a,i.TEXTURE_WRAP_S,this.glWrapS),i.samplerParameteri(a,i.TEXTURE_WRAP_T,this.glWrapT),i.samplerParameteri(a,i.TEXTURE_WRAP_R,this.glWrapR),i.samplerParameterf(a,i.TEXTURE_MIN_LOD,t),i.samplerParameterf(a,i.TEXTURE_MAX_LOD,n))}return this.glSamplers.get(r)}},r=i8.instance,a=i._gpuSampler,o=r.gl,a.minFilter===bi.LINEAR||a.minFilter===bi.ANISOTROPIC?a.mipFilter===bi.LINEAR||a.mipFilter===bi.ANISOTROPIC?a.glMinFilter=o.LINEAR_MIPMAP_LINEAR:a.mipFilter===bi.POINT?a.glMinFilter=o.LINEAR_MIPMAP_NEAREST:a.glMinFilter=o.LINEAR:a.mipFilter===bi.LINEAR||a.mipFilter===bi.ANISOTROPIC?a.glMinFilter=o.NEAREST_MIPMAP_LINEAR:a.mipFilter===bi.POINT?a.glMinFilter=o.NEAREST_MIPMAP_NEAREST:a.glMinFilter=o.NEAREST,a.magFilter===bi.LINEAR||a.magFilter===bi.ANISOTROPIC?a.glMagFilter=o.LINEAR:a.glMagFilter=o.NEAREST,a.glWrapS=r8[a.addressU],a.glWrapT=r8[a.addressV],a.glWrapR=r8[a.addressW],i}return Z(t,e),t.prototype.destroy=function(){this._gpuSampler&&(function(e,t){for(var n=e.gl,i=t.glSamplers.values().next();!i.done;){n.deleteSampler(i.value);for(var r=e.stateCache.glSamplerUnits,a=0;a<r.length;++a)r[a]===i.value&&(n.bindSampler(a,null),r[a]=null)}t.glSamplers.clear()}(i8.instance,this._gpuSampler),this._gpuSampler=null)},Q(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Na),Y8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,a="",o=1;switch(i.type){case Ni.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case Ni.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(a+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+o+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var a=i(r);if("object"==typeof a)return a.v}var o=n.createProgram();if(o){t.glProgram=o;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));T("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var f=0;f<h;++f){var _=n.getActiveAttrib(t.glProgram,f);if(_){var d,p=_.name.indexOf("[");d=-1!==p?_.name.substr(0,p):_.name;var m=n.getAttribLocation(t.glProgram,d),v=c8(_.type,n),g=l8(_.type,n);t.glInputs[f]={name:d,type:v,stride:g,count:_.size,size:g*_.size,glType:_.type,glLoc:m}}}var y,S,E,C,A=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(A){t.glBlocks=new Array(A);for(var b=0;b<A;++b){var I=(y=n.getActiveUniformBlockName(t.glProgram,b)).indexOf("[");-1!==I&&(y=y.substr(0,I)),C=null;for(var w=0;w<t.blocks.length;w++)if(t.blocks[w].name===y){C=t.blocks[w];break}if(C){S=b,E=n.getActiveUniformBlockParameter(t.glProgram,S,n.UNIFORM_BLOCK_DATA_SIZE);var P=C.binding+(e.bindingMappings.blockOffsets[C.set]||0);n.uniformBlockBinding(t.glProgram,S,P),t.glBlocks[b]={set:C.set,binding:C.binding,idx:S,name:y,size:E,glBinding:P}}else x("Block '"+y+"' does not bound")}}for(var R=0;R<t.subpassInputs.length;++R){var D=t.subpassInputs[R];t.samplerTextures.push(new Ar(D.set,D.binding,D.name,pi.SAMPLER2D,D.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var O=0;O<t.samplerTextures.length;++O){var N=t.samplerTextures[O];t.glSamplerTextures[O]={set:N.set,binding:N.binding,name:N.name,type:N.type,count:N.count,units:[],glUnits:null,glType:s8(N.type,n),glLoc:null}}}for(var M=[],L=[],F=e.stateCache.texUnitCacheMap,B=0,z=0;z<t.blocks.length;++z)t.blocks[z].set===e.bindingMappings.flexibleSet&&B++;for(var U=0,k=0;k<t.samplerTextures.length;++k){var G=t.samplerTextures[k],H=n.getUniformLocation(t.glProgram,G.name);if(H&&-1!==H.id&&(M.push(t.glSamplerTextures[k]),L.push(H)),void 0===F[G.name]){var V=G.binding+e.bindingMappings.samplerTextureOffsets[G.set]+U;G.set===e.bindingMappings.flexibleSet&&(V-=B),F[G.name]=V%e.capabilities.maxTextureUnits,U+=G.count-1}}if(M.length){for(var W=[],j=0;j<M.length;++j){var X=M[j],q=F[X.name];if(void 0!==q){X.glLoc=L[j];for(var Y=0;Y<X.count;++Y){for(;W[q];)q=(q+1)%e.capabilities.maxTextureUnits;X.units.push(q),W[q]=!0}}}for(var K=0,Q=0;Q<M.length;++Q){var J=M[Q];if(!J.glLoc){for(J.glLoc=L[Q];W[K];)K++;for(var Z=0;Z<J.count;++Z){for(;W[K];)K=(K+1)%e.capabilities.maxTextureUnits;void 0===F[J.name]&&(F[J.name]=K),J.units.push(K),W[K]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var $=0;$<M.length;$++){var ee=M[$];ee.glUnits=new Int32Array(ee.units),n.uniform1iv(ee.glLoc,ee.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=M}}(i8.instance,this._gpuShader)},n.destroy=function(){var e,t;this._gpuShader&&(e=i8.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)},Q(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Ma),K8=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new ur,this.scissorRect=new ir(0,0,0,0),this.rs=new Aa,this.dss=new ba,this.bs=new wa,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},e}(),Q8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t._gpuTextureView=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e,t){var n=e,i=e;if("texture"in e&&(n=i.texture.info,this._isTextureView=!0),this._info.copy(n),this._isPowerOf2=oa(this._info.width)&&oa(this._info.height),this._size=ca(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView){var r;if(this._viewInfo.copy(i),this._gpuTexture=i.texture._gpuTexture,(null===(r=this._gpuTexture)||void 0===r?void 0:r.format)!==n.format)return void console.log("GPU memory alias is not supported");this._gpuTextureView={gpuTexture:this._gpuTexture,type:i.type,format:i.format,baseLevel:i.baseLevel,levelCount:i.levelCount}}else this._gpuTexture={type:n.type,format:n.format,usage:n.usage,width:n.width,height:n.height,depth:n.depth,size:this._size,arrayLayer:n.layerCount,mipLevel:n.levelCount,samples:n.samples,flags:n.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},C8(i8.instance,this._gpuTexture),i8.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount,this._gpuTextureView={gpuTexture:this._gpuTexture,type:this._viewInfo.type,format:this._viewInfo.format,baseLevel:this._viewInfo.baseLevel,levelCount:this._viewInfo.levelCount}},n.destroy=function(){!this._isTextureView&&this._gpuTexture&&(A8(i8.instance,this._gpuTexture),i8.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,n){if(this._info.width!==e||this._info.height!==n){this._info.levelCount===t.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=t.getLevelCount(e,n):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,t.getLevelCount(e,n)));var i=this._size;this._info.width=e,this._info.height=n,this._size=ca(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=n,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Si.TEX2D:t.glTarget=n.TEXTURE_2D;var a=Math.max(i,r);if(a>e.capabilities.maxTextureSize&&O(9100,a,e.capabilities.maxTextureSize),t.samples===Ci.ONE){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),na[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=sa(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else A8(e,t),C8(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Si.CUBE:t.type=Si.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>e.capabilities.maxCubeMapTextureSize&&O(9100,u,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),na[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var _=0;_<t.mipLevel;++_){var d=sa(t.format,i,r,1),p=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,_,t.glInternalFmt,i,r,0,p),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else A8(e,t),C8(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Si.TEX2D,t.glTarget=n.TEXTURE_2D}}}(i8.instance,this._gpuTexture),i8.instance.memoryStatus.textureSize-=i,i8.instance.memoryStatus.textureSize+=this._size)}},n.initAsSwapchainTexture=function(e){var t=new Sr;t.format=e.format,t.usage=na[e.format].hasDepth?xi.DEPTH_STENCIL_ATTACHMENT:xi.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},Q(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),t}(La),J8="webglcontextlost";function Z8(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function $8(e){var t={EXT_texture_filter_anisotropic:Z8(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:Z8(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:Z8(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:Z8(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:Z8(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:Z8(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:Z8(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:Z8(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:Z8(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:Z8(e,"WEBGL_debug_shaders"),WEBGL_lose_context:Z8(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:Z8(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:Z8(e,"OES_texture_half_float_linear"),OES_texture_float_linear:Z8(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return hu.os!==iu.ANDROID&&hu.os!==iu.IOS&&(t.WEBGL_multi_draw=Z8(e,"WEBGL_multi_draw")),t}var e6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new K8,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(J8,this._onWebGLContextLost);var t=i8.instance.gl;this.stateCache.initialize(i8.instance.capabilities.maxTextureUnits,i8.instance.capabilities.maxUniformBufferBindings,i8.instance.capabilities.maxVertexAttributes),this._extensions=$8(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=_i.RGBA8,i=_i.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),a=t.getParameter(t.STENCIL_BITS);r&&a?i=_i.DEPTH_STENCIL:r&&(i=_i.DEPTH),this._colorTexture=new Q8,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new Q8,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=i8.instance.createTexture(new Sr(Si.TEX2D,xi.SAMPLED,_i.RGBA8,2,2,Ei.NONE)),this.nullTexCube=i8.instance.createTexture(new Sr(Si.CUBE,xi.SAMPLED,_i.RGBA8,2,2,Ei.NONE,6));var o=new lr;o.texExtent.width=2,o.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),i8.instance.copyBuffersToTexture([s],this.nullTex2D,[o]),o.texSubres.layerCount=6,i8.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[o])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(J8,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(T("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){R(11e3),S(e)},Q(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(ma),t6=e("WebGL2Device",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(_i.COUNT),t}Z(t,e);var n=t.prototype;return n.initialize=function(e){i8.setInstance(this),this._gfxAPI=ui.WEBGL2;var t=this._bindingMappingInfo=e.bindingMappingInfo,n=[],i=[],r=t.setIndices[0];n[r]=0,i[r]=0;for(var a=1;a<t.setIndices.length;++a){var o=t.setIndices[a],s=t.setIndices[a-1];n[o]=t.maxBlockCounts[s]+n[s],i[o]=t.maxSamplerTextureCounts[s]+i[s]}for(var c=0;c<t.setIndices.length;++c){var l=t.setIndices[c];i[l]-=t.maxBlockCounts[l]}this._bindingMappings={blockOffsets:n,samplerTextureOffsets:i,flexibleSet:t.setIndices[t.setIndices.length-1]};var u=this._context=function(e){var t=null;try{var n={alpha:lt.ENABLE_TRANSPARENT_CANVAS,antialias:lt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(pa.canvas);if(!u)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Kr(Xi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Yr(this._queue)),this._caps.maxVertexAttributes=u.getParameter(u.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=u.getParameter(u.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=u.getParameter(u.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=u.getParameter(u.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=u.getParameter(u.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=u.getParameter(u.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=u.getParameter(u.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=u.getParameter(u.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=u.getParameter(u.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var h=u.getSupportedExtensions(),f="";if(h)for(var _,d=oe(h);!(_=d()).done;)f+=_.value+" ";var p=$8(u);p.WEBGL_debug_renderer_info?(this._renderer=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=u.getParameter(u.RENDERER),this._vendor=u.getParameter(u.VENDOR));var m=u.getParameter(u.VERSION);this._features.fill(!1),this.initFormatFeatures(p),this._features[fi.ELEMENT_INDEX_UINT]=!0,this._features[fi.INSTANCED_ARRAYS]=!0,this._features[fi.MULTIPLE_RENDER_TARGETS]=!0,this._features[fi.BLEND_MINMAX]=!0;var v="";return this.getFormatFeatures(_i.ETC_RGB8)&&(v+="etc1 "),this.getFormatFeatures(_i.ETC2_RGB8)&&(v+="etc2 "),this.getFormatFeatures(_i.BC1)&&(v+="dxt "),this.getFormatFeatures(_i.PVRTC_RGB2)&&(v+="pvrtc "),this.getFormatFeatures(_i.ASTC_RGBA_4X4)&&(v+="astc "),T("WebGL2 device initialized."),T("RENDERER: "+this._renderer),T("VENDOR: "+this._vendor),T("VERSION: "+m),T("COMPRESSED_FORMAT: "+v),T("EXTENSIONS: "+f),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.initFormatFeatures=function(e){this._formatFeatures.fill(Ti.NONE),this._textureExclusive.fill(!0);var t=Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE|Ti.STORAGE_TEXTURE|Ti.LINEAR_FILTER|Ti.VERTEX_ATTRIBUTE;this._formatFeatures[_i.R8]=t,this._formatFeatures[_i.RG8]=t,this._formatFeatures[_i.RGB8]=t,this._formatFeatures[_i.RGBA8]=t,t=Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE|Ti.STORAGE_TEXTURE|Ti.LINEAR_FILTER,this._formatFeatures[_i.R8SN]=t,this._formatFeatures[_i.RG8SN]=t,this._formatFeatures[_i.RGB8SN]=t,this._formatFeatures[_i.RGBA8SN]=t,this._formatFeatures[_i.R5G6B5]=t,this._formatFeatures[_i.RGBA4]=t,this._formatFeatures[_i.RGB5A1]=t,this._formatFeatures[_i.RGB10A2]=t,this._formatFeatures[_i.SRGB8]=t,this._formatFeatures[_i.SRGB8_A8]=t,this._formatFeatures[_i.R11G11B10F]=t,this._formatFeatures[_i.RGB9E5]=t,this._formatFeatures[_i.DEPTH]=t,this._formatFeatures[_i.DEPTH_STENCIL]=t,this._formatFeatures[_i.RGB10A2UI]=Ti.RENDER_TARGET|Ti.STORAGE_TEXTURE|Ti.SAMPLED_TEXTURE|Ti.LINEAR_FILTER,t=Ti.RENDER_TARGET|Ti.SAMPLED_TEXTURE|Ti.STORAGE_TEXTURE|Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.R16F]=t,this._formatFeatures[_i.RG16F]=t,this._formatFeatures[_i.RGB16F]=t,this._formatFeatures[_i.RGBA16F]=t,t=Ti.STORAGE_TEXTURE|Ti.SAMPLED_TEXTURE|Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.R32F]=t,this._formatFeatures[_i.RG32F]=t,this._formatFeatures[_i.RGB32F]=t,this._formatFeatures[_i.RGBA32F]=t,this._formatFeatures[_i.RGB10A2UI]=Ti.RENDER_TARGET|Ti.STORAGE_TEXTURE|Ti.SAMPLED_TEXTURE|Ti.LINEAR_FILTER,t=Ti.RENDER_TARGET|Ti.STORAGE_TEXTURE|Ti.SAMPLED_TEXTURE|Ti.LINEAR_FILTER|Ti.VERTEX_ATTRIBUTE,this._formatFeatures[_i.R8I]=t,this._formatFeatures[_i.R8UI]=t,this._formatFeatures[_i.R16I]=t,this._formatFeatures[_i.R16UI]=t,this._formatFeatures[_i.R32I]=t,this._formatFeatures[_i.R32UI]=t,this._formatFeatures[_i.RG8I]=t,this._formatFeatures[_i.RG8UI]=t,this._formatFeatures[_i.RG16I]=t,this._formatFeatures[_i.RG16UI]=t,this._formatFeatures[_i.RG32I]=t,this._formatFeatures[_i.RG32UI]=t,this._formatFeatures[_i.RGB8I]=t,this._formatFeatures[_i.RGB8UI]=t,this._formatFeatures[_i.RGB16I]=t,this._formatFeatures[_i.RGB16UI]=t,this._formatFeatures[_i.RGB32I]=t,this._formatFeatures[_i.RGB32UI]=t,this._formatFeatures[_i.RGBA8I]=t,this._formatFeatures[_i.RGBA8UI]=t,this._formatFeatures[_i.RGBA16I]=t,this._formatFeatures[_i.RGBA16UI]=t,this._formatFeatures[_i.RGBA32I]=t,this._formatFeatures[_i.RGBA32UI]=t,this._textureExclusive[_i.R8]=!1,this._textureExclusive[_i.RG8]=!1,this._textureExclusive[_i.RGB8]=!1,this._textureExclusive[_i.R5G6B5]=!1,this._textureExclusive[_i.RGBA4]=!1,this._textureExclusive[_i.RGB5A1]=!1,this._textureExclusive[_i.RGBA8]=!1,this._textureExclusive[_i.RGB10A2]=!1,this._textureExclusive[_i.RGB10A2UI]=!1,this._textureExclusive[_i.SRGB8_A8]=!1,this._textureExclusive[_i.R8I]=!1,this._textureExclusive[_i.R8UI]=!1,this._textureExclusive[_i.R16I]=!1,this._textureExclusive[_i.R16UI]=!1,this._textureExclusive[_i.R32I]=!1,this._textureExclusive[_i.R32UI]=!1,this._textureExclusive[_i.RG8I]=!1,this._textureExclusive[_i.RG8UI]=!1,this._textureExclusive[_i.RG16I]=!1,this._textureExclusive[_i.RG16UI]=!1,this._textureExclusive[_i.RG32I]=!1,this._textureExclusive[_i.RG32UI]=!1,this._textureExclusive[_i.RGBA8I]=!1,this._textureExclusive[_i.RGBA8UI]=!1,this._textureExclusive[_i.RGBA16I]=!1,this._textureExclusive[_i.RGBA16UI]=!1,this._textureExclusive[_i.RGBA32I]=!1,this._textureExclusive[_i.RGBA32UI]=!1,this._textureExclusive[_i.DEPTH]=!1,this._textureExclusive[_i.DEPTH_STENCIL]=!1,e.EXT_color_buffer_float&&(this._formatFeatures[_i.R32F]|=Ti.RENDER_TARGET,this._formatFeatures[_i.RG32F]|=Ti.RENDER_TARGET,this._formatFeatures[_i.RGBA32F]|=Ti.RENDER_TARGET,this._textureExclusive[_i.R32F]=!1,this._textureExclusive[_i.RG32F]=!1,this._textureExclusive[_i.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._textureExclusive[_i.R16F]=!1,this._textureExclusive[_i.RG16F]=!1,this._textureExclusive[_i.RGBA16F]=!1),e.OES_texture_float_linear&&(this._formatFeatures[_i.RGB32F]|=Ti.LINEAR_FILTER,this._formatFeatures[_i.RGBA32F]|=Ti.LINEAR_FILTER,this._formatFeatures[_i.R32F]|=Ti.LINEAR_FILTER,this._formatFeatures[_i.RG32F]|=Ti.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[_i.RGB16F]|=Ti.LINEAR_FILTER,this._formatFeatures[_i.RGBA16F]|=Ti.LINEAR_FILTER,this._formatFeatures[_i.R16F]|=Ti.LINEAR_FILTER,this._formatFeatures[_i.RG16F]|=Ti.LINEAR_FILTER);var n=Ti.SAMPLED_TEXTURE|Ti.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[_i.ETC_RGB8]=n),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[_i.ETC2_RGB8]=n,this._formatFeatures[_i.ETC2_RGBA8]=n,this._formatFeatures[_i.ETC2_SRGB8]=n,this._formatFeatures[_i.ETC2_SRGB8_A8]=n,this._formatFeatures[_i.ETC2_RGB8_A1]=n,this._formatFeatures[_i.ETC2_SRGB8_A1]=n),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[_i.BC1]=n,this._formatFeatures[_i.BC1_ALPHA]=n,this._formatFeatures[_i.BC1_SRGB]=n,this._formatFeatures[_i.BC1_SRGB_ALPHA]=n,this._formatFeatures[_i.BC2]=n,this._formatFeatures[_i.BC2_SRGB]=n,this._formatFeatures[_i.BC3]=n,this._formatFeatures[_i.BC3_SRGB]=n),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[_i.PVRTC_RGB2]=n,this._formatFeatures[_i.PVRTC_RGBA2]=n,this._formatFeatures[_i.PVRTC_RGB4]=n,this._formatFeatures[_i.PVRTC_RGBA4]=n),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[_i.ASTC_RGBA_4X4]=n,this._formatFeatures[_i.ASTC_RGBA_5X4]=n,this._formatFeatures[_i.ASTC_RGBA_5X5]=n,this._formatFeatures[_i.ASTC_RGBA_6X5]=n,this._formatFeatures[_i.ASTC_RGBA_6X6]=n,this._formatFeatures[_i.ASTC_RGBA_8X5]=n,this._formatFeatures[_i.ASTC_RGBA_8X6]=n,this._formatFeatures[_i.ASTC_RGBA_8X8]=n,this._formatFeatures[_i.ASTC_RGBA_10X5]=n,this._formatFeatures[_i.ASTC_RGBA_10X6]=n,this._formatFeatures[_i.ASTC_RGBA_10X8]=n,this._formatFeatures[_i.ASTC_RGBA_10X10]=n,this._formatFeatures[_i.ASTC_RGBA_12X10]=n,this._formatFeatures[_i.ASTC_RGBA_12X12]=n,this._formatFeatures[_i.ASTC_SRGBA_4X4]=n,this._formatFeatures[_i.ASTC_SRGBA_5X4]=n,this._formatFeatures[_i.ASTC_SRGBA_5X5]=n,this._formatFeatures[_i.ASTC_SRGBA_6X5]=n,this._formatFeatures[_i.ASTC_SRGBA_6X6]=n,this._formatFeatures[_i.ASTC_SRGBA_8X5]=n,this._formatFeatures[_i.ASTC_SRGBA_8X6]=n,this._formatFeatures[_i.ASTC_SRGBA_8X8]=n,this._formatFeatures[_i.ASTC_SRGBA_10X5]=n,this._formatFeatures[_i.ASTC_SRGBA_10X6]=n,this._formatFeatures[_i.ASTC_SRGBA_10X8]=n,this._formatFeatures[_i.ASTC_SRGBA_10X10]=n,this._formatFeatures[_i.ASTC_SRGBA_12X10]=n,this._formatFeatures[_i.ASTC_SRGBA_12X12]=n)},n.createCommandBuffer=function(e){var t=new(e.type===Yi.PRIMARY?W8:B8);return t.initialize(e),t},n.createSwapchain=function(e){var t=new e6;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new M8;return t.initialize(e),t},n.createTexture=function(e){var t=new Q8;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new n8;return t.initialize(e),t},n.createShader=function(e){var t=new Y8;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new U8;return t.initialize(e),t},n.createRenderPass=function(e){var t=new X8;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new z8;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new k8;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new G8;return t.initialize(e),t},n.createPipelineState=function(e){var t=new V8;return t.initialize(e),t},n.createQueue=function(e){var t=new j8;return t.initialize(e),t},n.getSampler=function(e){var t=Na.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new q8(e,t)),this._samplers.get(t)},n.getGeneralBarrier=function(e){var t=Fa.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new Fa(e,t)),this._generalBarrierss.get(t)},n.getTextureBarrier=function(e){var t=Ba.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Ba(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){O8(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache,o=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,o);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),a.glFramebuffer=null,r.deleteFramebuffer(o)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),a.glTexture=n.glTexture);var o=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ei.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},Q(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),t}(pa));function n6(e,t,n,i){var r=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),a=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),o=(i.y-n.y)*(t.x-e.x)-(i.x-n.x)*(t.y-e.y);if(0!==o){var s=r/o,c=a/o;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}l.WebGL2Device=t6;var i6=new Yn,r6=new Yn,a6=new Yn,o6=new Yn;function s6(e,t,n){for(var i=n.length,r=0;r<i;++r)if(n6(e,t,n[r],n[(r+1)%i]))return!0;return!1}function c6(e,t){for(var n=!1,i=e.x,r=e.y,a=t.length,o=0,s=a-1;o<a;s=o++){var c=t[o].x,l=t[o].y,u=t[s].x,h=t[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function l6(e,t,n,i){var r,a=n.x-t.x,o=n.y-t.y,s=a*a+o*o,c=((e.x-t.x)*a+(e.y-t.y)*o)/s;return r=i?s?c<0?t:c>1?n:i6.set(t.x+c*a,t.y+c*o):t:i6.set(t.x+c*a,t.y+c*o),a=e.x-r.x,o=e.y-r.y,Math.sqrt(a*a+o*o)}var u6=e("Intersection2D",(function(){}));u6.lineLine=n6,u6.lineRect=function(e,t,n){var i=i6.set(n.x,n.y),r=r6.set(n.x,n.yMax),a=a6.set(n.xMax,n.yMax),o=o6.set(n.xMax,n.y);return!!(n6(e,t,i,r)||n6(e,t,r,a)||n6(e,t,a,o)||n6(e,t,o,i))},u6.linePolygon=s6,u6.rectRect=function(e,t){var n=e.x,i=e.y,r=e.x+e.width,a=e.y+e.height,o=t.x,s=t.y,c=t.x+t.width,l=t.y+t.height;return n<=c&&r>=o&&i<=l&&a>=s},u6.rectPolygon=function(e,t){var n=i6.set(e.x,e.y),i=r6.set(e.x,e.yMax),r=a6.set(e.xMax,e.yMax),a=o6.set(e.xMax,e.y);if(s6(n,i,t))return!0;if(s6(i,r,t))return!0;if(s6(r,a,t))return!0;if(s6(a,n,t))return!0;for(var o=0,s=t.length;o<s;++o)if(e.contains(t[o]))return!0;return!!(c6(n,t)||c6(i,t)||c6(r,t)||c6(a,t))},u6.rectCircle=function(e,t,n){var i=t.x,r=t.y,a=e.x,o=e.y,s=e.width,c=e.height,l=i,u=r;i<a?l=a:i>a+s&&(l=a+s),r<o?u=o:r>o+c&&(u=o+c);var h=i-l,f=r-u;return Math.sqrt(h*h+f*f)<=n},u6.polygonPolygon=function(e,t){var n,i;for(n=0,i=e.length;n<i;++n)if(s6(e[n],e[(n+1)%i],t))return!0;for(n=0,i=t.length;n<i;++n)if(c6(t[n],e))return!0;for(n=0,i=e.length;n<i;++n)if(c6(e[n],t))return!0;return!1},u6.circleCircle=function(e,t,n,i){return Yn.distance(e,n)<t+i},u6.polygonCircle=function(e,t,n){var i=t;if(c6(i,e))return!0;for(var r=0,a=e.length;r<a;r++)if(l6(i,0===r?e[e.length-1]:e[r-1],e[r],!0)<n)return!0;return!1},u6.pointInPolygon=c6,u6.pointLineDistance=l6;var h6,f6=function(){function e(e,t,n){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=n}var t=e.prototype;return t.sample=function(e){this._average(this._value,e)},t.human=function(){var e=this._opts,t=e.average,n=e.isInteger,i=t?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100},t.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},t._average=function(e,t){if(void 0===t&&(t=0),this._opts.average){this._accumValue+=e,++this._accumSamples;var n=t;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}},Q(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),e}(),_6=Tc("cc.PerfCounter")(h6=function(e){function t(t,n,i){var r;return(r=e.call(this,t,n,i)||this)._time=void 0,r._time=i,r}Z(t,e);var n=t.prototype;return n.start=function(e){void 0===e&&(e=0),this._time=e},n.end=function(e){void 0===e&&(e=0),this._value=e-this._time,this._average(this._value)},n.tick=function(){this.end(),this.start()},n.frame=function(e){var t=e,n=t-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=t,this._average(this._value))},t}(f6))||h6,d6="0123456789. ",p6=500,m6={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},v6={fps:{desc:"Framerate (FPS)",below:30,average:p6,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:p6},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:p6,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:p6},render:{desc:"Renderer (ms)",min:0,max:50,average:p6,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},g6=e("Profiler",function(){function e(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new lr,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(v6).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var t=e.prototype;return t.reset=function(){this._stats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer&&this._meshRenderer.destroy(),this._meshRenderer=null,this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(v6).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0},t.isShowingStats=function(){return this._showFPS},t.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),l.director.off(l.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),l.director.off(l.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),l.director.off(l.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),l.director.off(l.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),l.director.off(l.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),l.director.off(l.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,l.game.config.showFPS=!1)},t.showStats=function(){if(!this._showFPS){if(!this._device){var e=l.director.root;this._device=e.device,this._swapchain=e.mainWindow.swapchain,this._pipeline=e.pipeline}this.generateCanvas(),this.generateStats(),l.game.once(l.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),l.director.on(l.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),l.director.on(l.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),l.director.on(l.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),l.director.on(l.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),l.director.on(l.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),l.director.on(l.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,l.game.config.showFPS=!0}},t.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Sr(Si.TEX2D,xi.SAMPLED|xi.TRANSFER_DST,_i.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},t.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var n in v6){var i=v6[n];this._ctx.fillText(i.desc,0,t*this._lineHeight),i.counter=new _6(n,i,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<d6.length;++r){var a=this._ctx.measureText(d6[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,a)}for(var o=0;o<d6.length;++o)this._ctx.fillText(d6[o],o*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=v6,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},t.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new ib("PROFILER_NODE"),l.game.addPersistRootNode(this._rootNode);var e=new ib("Profiler_Root");e.parent=this._rootNode;for(var t=.4,n=t/this._totalLines,i=t/this._wordHeight,r=n/23,a=this._eachNumWidth*this._canvas.width*r,o=[0,t,0,i,t,0,i,0,0,0,0,0],s=[0,2,1,0,3,2],c=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],u=0,h=0;h<this._totalLines;h++)for(var f=0;f<8;f++){o.push(i+f*a,t-h*n,0),o.push(i+(f+1)*a,t-h*n,0),o.push(i+(f+1)*a,t-(h+1)*n,0),o.push(i+f*a,t-(h+1)*n,0),u=4*(8*h+f+1),s.push(0+u,2+u,1+u,0+u,3+u,2+u);var _=8*h+f,d=Math.floor(_/4),p=_-4*d;c.push(0,this._wordHeight,d,p),c.push(this._eachNumWidth,this._wordHeight,d,p),c.push(this._eachNumWidth,1,d,p),c.push(0,1,d,p)}this._meshRenderer=e.addComponent(lK),this._meshRenderer.mesh=sY({positions:o,indices:s,colors:c});var m=new Qv;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),S=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[S],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=Ed.Enum.PROFILER,this._inited=!0}},t.beforeUpdate=function(){if(this._stats){var e=performance.now();this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}},t.afterUpdate=function(){if(this._stats){var e=performance.now();l.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}},t.beforePhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}},t.afterPhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}},t.beforeDraw=function(){if(this._stats&&this._inited){var e=this._swapchain.surfaceTransform,t=this._device.capabilities.clipSpaceSignY;if(e!==this.offsetData[3]){var n=Vn[e],i=-.9*t;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=e}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}},t.afterDraw=function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.frame.counter.end(e),this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),!(e-this.lastTime<p6)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var a=this._stats[r];a.counter.sample(e);for(var o=a.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=o[o.length-(8-s)],u=m6[l];void 0===u&&(u=11),i[c]=u}n++}}}},e}()),y6=e("profiler",new g6);l.profiler=y6;var S6,x6,E6=(S6=function(e,t){return(S6=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}S6(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});!function(e){var t,n,i,r=function(){function e(e,t,n){if(null==e)throw new Error("name cannot be null.");if(null==t)throw new Error("timelines cannot be null.");this.name=e,this.timelines=t,this.timelineIds=[];for(var i=0;i<t.length;i++)this.timelineIds[t[i].getPropertyId()]=!0;this.duration=n}return e.prototype.hasTimeline=function(e){return 1==this.timelineIds[e]},e.prototype.apply=function(e,t,n,i,r,a,o,s){if(null==e)throw new Error("skeleton cannot be null.");i&&0!=this.duration&&(n%=this.duration,t>0&&(t%=this.duration));for(var c=this.timelines,l=0,u=c.length;l<u;l++)c[l].apply(e,t,n,r,a,o,s)},e.binarySearch=function(e,t,n){void 0===n&&(n=1);var i=0,r=e.length/n-2;if(0==r)return n;for(var a=r>>>1;;){if(e[(a+1)*n]<=t?i=a+1:r=a,i==r)return(i+1)*n;a=i+r>>>1}},e.linearSearch=function(e,t,n){for(var i=0,r=e.length-n;i<=r;i+=n)if(e[i]>t)return i;return-1},e}();e.Animation=r,function(e){e[e.setup=0]="setup",e[e.first=1]="first",e[e.replace=2]="replace",e[e.add=3]="add"}(t=e.MixBlend||(e.MixBlend={})),function(e){e[e.mixIn=0]="mixIn",e[e.mixOut=1]="mixOut"}(n=e.MixDirection||(e.MixDirection={})),function(e){e[e.rotate=0]="rotate",e[e.translate=1]="translate",e[e.scale=2]="scale",e[e.shear=3]="shear",e[e.attachment=4]="attachment",e[e.color=5]="color",e[e.deform=6]="deform",e[e.event=7]="event",e[e.drawOrder=8]="drawOrder",e[e.ikConstraint=9]="ikConstraint",e[e.transformConstraint=10]="transformConstraint",e[e.pathConstraintPosition=11]="pathConstraintPosition",e[e.pathConstraintSpacing=12]="pathConstraintSpacing",e[e.pathConstraintMix=13]="pathConstraintMix",e[e.twoColor=14]="twoColor"}(i=e.TimelineType||(e.TimelineType={}));var a=function(){function t(n){if(n<=0)throw new Error("frameCount must be > 0: "+n);this.curves=e.Utils.newFloatArray((n-1)*t.BEZIER_SIZE)}return t.prototype.getFrameCount=function(){return this.curves.length/t.BEZIER_SIZE+1},t.prototype.setLinear=function(e){this.curves[e*t.BEZIER_SIZE]=t.LINEAR},t.prototype.setStepped=function(e){this.curves[e*t.BEZIER_SIZE]=t.STEPPED},t.prototype.getCurveType=function(e){var n=e*t.BEZIER_SIZE;if(n==this.curves.length)return t.LINEAR;var i=this.curves[n];return i==t.LINEAR?t.LINEAR:i==t.STEPPED?t.STEPPED:t.BEZIER},t.prototype.setCurve=function(e,n,i,r,a){var o=.03*(2*-n+r),s=.03*(2*-i+a),c=.006*(3*(n-r)+1),l=.006*(3*(i-a)+1),u=2*o+c,h=2*s+l,f=.3*n+o+.16666667*c,_=.3*i+s+.16666667*l,d=e*t.BEZIER_SIZE,p=this.curves;p[d++]=t.BEZIER;for(var m=f,v=_,g=d+t.BEZIER_SIZE-1;d<g;d+=2)p[d]=m,p[d+1]=v,f+=u,_+=h,u+=c,h+=l,m+=f,v+=_},t.prototype.getCurvePercent=function(n,i){i=e.MathUtils.clamp(i,0,1);var r=this.curves,a=n*t.BEZIER_SIZE,o=r[a];if(o==t.LINEAR)return i;if(o==t.STEPPED)return 0;for(var s=0,c=++a,l=a+t.BEZIER_SIZE-1;a<l;a+=2)if((s=r[a])>=i){var u=void 0,h=void 0;return a==c?(u=0,h=0):(u=r[a-2],h=r[a-1]),h+(r[a+1]-h)*(i-u)/(s-u)}var f=r[a-1];return f+(1-f)*(i-s)/(1-s)},t.LINEAR=0,t.STEPPED=1,t.BEZIER=2,t.BEZIER_SIZE=19,t}();e.CurveTimeline=a;var o=function(n){function a(t){var i=n.call(this,t)||this;return i.frames=e.Utils.newFloatArray(t<<1),i}return E6(a,n),a.prototype.getPropertyId=function(){return(i.rotate<<24)+this.boneIndex},a.prototype.setFrame=function(e,t,n){e<<=1,this.frames[e]=t,this.frames[e+a.ROTATION]=n},a.prototype.apply=function(e,n,i,o,s,c){var l=this.frames,u=e.bones[this.boneIndex];if(u.active)if(i<l[0])switch(c){case t.setup:return void(u.rotation=u.data.rotation);case t.first:var h=u.data.rotation-u.rotation;u.rotation+=(h-360*(16384-(16384.499999999996-h/360|0)))*s}else if(i>=l[l.length-a.ENTRIES]){var f=l[l.length+a.PREV_ROTATION];switch(c){case t.setup:u.rotation=u.data.rotation+f*s;break;case t.first:case t.replace:f+=u.data.rotation-u.rotation,f-=360*(16384-(16384.499999999996-f/360|0));case t.add:u.rotation+=f*s}}else{var _=r.binarySearch(l,i,a.ENTRIES),d=l[_+a.PREV_ROTATION],p=l[_],m=this.getCurvePercent((_>>1)-1,1-(i-p)/(l[_+a.PREV_TIME]-p)),v=l[_+a.ROTATION]-d;switch(v=d+(v-360*(16384-(16384.499999999996-v/360|0)))*m,c){case t.setup:u.rotation=u.data.rotation+(v-360*(16384-(16384.499999999996-v/360|0)))*s;break;case t.first:case t.replace:v+=u.data.rotation-u.rotation;case t.add:u.rotation+=(v-360*(16384-(16384.499999999996-v/360|0)))*s}}},a.ENTRIES=2,a.PREV_TIME=-2,a.PREV_ROTATION=-1,a.ROTATION=1,a}(a);e.RotateTimeline=o;var s=function(n){function a(t){var i=n.call(this,t)||this;return i.frames=e.Utils.newFloatArray(t*a.ENTRIES),i}return E6(a,n),a.prototype.getPropertyId=function(){return(i.translate<<24)+this.boneIndex},a.prototype.setFrame=function(e,t,n,i){e*=a.ENTRIES,this.frames[e]=t,this.frames[e+a.X]=n,this.frames[e+a.Y]=i},a.prototype.apply=function(e,n,i,o,s,c){var l=this.frames,u=e.bones[this.boneIndex];if(u.active)if(i<l[0])switch(c){case t.setup:return u.x=u.data.x,void(u.y=u.data.y);case t.first:u.x+=(u.data.x-u.x)*s,u.y+=(u.data.y-u.y)*s}else{var h=0,f=0;if(i>=l[l.length-a.ENTRIES])h=l[l.length+a.PREV_X],f=l[l.length+a.PREV_Y];else{var _=r.binarySearch(l,i,a.ENTRIES);h=l[_+a.PREV_X],f=l[_+a.PREV_Y];var d=l[_],p=this.getCurvePercent(_/a.ENTRIES-1,1-(i-d)/(l[_+a.PREV_TIME]-d));h+=(l[_+a.X]-h)*p,f+=(l[_+a.Y]-f)*p}switch(c){case t.setup:u.x=u.data.x+h*s,u.y=u.data.y+f*s;break;case t.first:case t.replace:u.x+=(u.data.x+h-u.x)*s,u.y+=(u.data.y+f-u.y)*s;break;case t.add:u.x+=h*s,u.y+=f*s}}},a.ENTRIES=3,a.PREV_TIME=-3,a.PREV_X=-2,a.PREV_Y=-1,a.X=1,a.Y=2,a}(a);e.TranslateTimeline=s;var c=function(a){function o(e){return a.call(this,e)||this}return E6(o,a),o.prototype.getPropertyId=function(){return(i.scale<<24)+this.boneIndex},o.prototype.apply=function(i,a,s,c,l,u,h){var f=this.frames,_=i.bones[this.boneIndex];if(_.active)if(s<f[0])switch(u){case t.setup:return _.scaleX=_.data.scaleX,void(_.scaleY=_.data.scaleY);case t.first:_.scaleX+=(_.data.scaleX-_.scaleX)*l,_.scaleY+=(_.data.scaleY-_.scaleY)*l}else{var d=0,p=0;if(s>=f[f.length-o.ENTRIES])d=f[f.length+o.PREV_X]*_.data.scaleX,p=f[f.length+o.PREV_Y]*_.data.scaleY;else{var m=r.binarySearch(f,s,o.ENTRIES);d=f[m+o.PREV_X],p=f[m+o.PREV_Y];var v=f[m],g=this.getCurvePercent(m/o.ENTRIES-1,1-(s-v)/(f[m+o.PREV_TIME]-v));d=(d+(f[m+o.X]-d)*g)*_.data.scaleX,p=(p+(f[m+o.Y]-p)*g)*_.data.scaleY}if(1==l)u==t.add?(_.scaleX+=d-_.data.scaleX,_.scaleY+=p-_.data.scaleY):(_.scaleX=d,_.scaleY=p);else{var y=0,S=0;if(h==n.mixOut)switch(u){case t.setup:y=_.data.scaleX,S=_.data.scaleY,_.scaleX=y+(Math.abs(d)*e.MathUtils.signum(y)-y)*l,_.scaleY=S+(Math.abs(p)*e.MathUtils.signum(S)-S)*l;break;case t.first:case t.replace:y=_.scaleX,S=_.scaleY,_.scaleX=y+(Math.abs(d)*e.MathUtils.signum(y)-y)*l,_.scaleY=S+(Math.abs(p)*e.MathUtils.signum(S)-S)*l;break;case t.add:y=_.scaleX,S=_.scaleY,_.scaleX=y+(Math.abs(d)*e.MathUtils.signum(y)-_.data.scaleX)*l,_.scaleY=S+(Math.abs(p)*e.MathUtils.signum(S)-_.data.scaleY)*l}else switch(u){case t.setup:y=Math.abs(_.data.scaleX)*e.MathUtils.signum(d),S=Math.abs(_.data.scaleY)*e.MathUtils.signum(p),_.scaleX=y+(d-y)*l,_.scaleY=S+(p-S)*l;break;case t.first:case t.replace:y=Math.abs(_.scaleX)*e.MathUtils.signum(d),S=Math.abs(_.scaleY)*e.MathUtils.signum(p),_.scaleX=y+(d-y)*l,_.scaleY=S+(p-S)*l;break;case t.add:y=e.MathUtils.signum(d),S=e.MathUtils.signum(p),_.scaleX=Math.abs(_.scaleX)*y+(d-Math.abs(_.data.scaleX)*y)*l,_.scaleY=Math.abs(_.scaleY)*S+(p-Math.abs(_.data.scaleY)*S)*l}}}},o}(s);e.ScaleTimeline=c;var l=function(e){function n(t){return e.call(this,t)||this}return E6(n,e),n.prototype.getPropertyId=function(){return(i.shear<<24)+this.boneIndex},n.prototype.apply=function(e,i,a,o,s,c){var l=this.frames,u=e.bones[this.boneIndex];if(u.active)if(a<l[0])switch(c){case t.setup:return u.shearX=u.data.shearX,void(u.shearY=u.data.shearY);case t.first:u.shearX+=(u.data.shearX-u.shearX)*s,u.shearY+=(u.data.shearY-u.shearY)*s}else{var h=0,f=0;if(a>=l[l.length-n.ENTRIES])h=l[l.length+n.PREV_X],f=l[l.length+n.PREV_Y];else{var _=r.binarySearch(l,a,n.ENTRIES);h=l[_+n.PREV_X],f=l[_+n.PREV_Y];var d=l[_],p=this.getCurvePercent(_/n.ENTRIES-1,1-(a-d)/(l[_+n.PREV_TIME]-d));h+=(l[_+n.X]-h)*p,f+=(l[_+n.Y]-f)*p}switch(c){case t.setup:u.shearX=u.data.shearX+h*s,u.shearY=u.data.shearY+f*s;break;case t.first:case t.replace:u.shearX+=(u.data.shearX+h-u.shearX)*s,u.shearY+=(u.data.shearY+f-u.shearY)*s;break;case t.add:u.shearX+=h*s,u.shearY+=f*s}}},n}(s);e.ShearTimeline=l;var u=function(n){function a(t){var i=n.call(this,t)||this;return i.frames=e.Utils.newFloatArray(t*a.ENTRIES),i}return E6(a,n),a.prototype.getPropertyId=function(){return(i.color<<24)+this.slotIndex},a.prototype.setFrame=function(e,t,n,i,r,o){e*=a.ENTRIES,this.frames[e]=t,this.frames[e+a.R]=n,this.frames[e+a.G]=i,this.frames[e+a.B]=r,this.frames[e+a.A]=o},a.prototype.apply=function(e,n,i,o,s,c){var l=e.slots[this.slotIndex];if(l.bone.active){var u=this.frames;if(i<u[0])switch(c){case t.setup:return void l.color.setFromColor(l.data.color);case t.first:var h=l.color,f=l.data.color;h.add((f.r-h.r)*s,(f.g-h.g)*s,(f.b-h.b)*s,(f.a-h.a)*s)}else{var _=0,d=0,p=0,m=0;if(i>=u[u.length-a.ENTRIES]){var v=u.length;_=u[v+a.PREV_R],d=u[v+a.PREV_G],p=u[v+a.PREV_B],m=u[v+a.PREV_A]}else{var g=r.binarySearch(u,i,a.ENTRIES);_=u[g+a.PREV_R],d=u[g+a.PREV_G],p=u[g+a.PREV_B],m=u[g+a.PREV_A];var y=u[g],S=this.getCurvePercent(g/a.ENTRIES-1,1-(i-y)/(u[g+a.PREV_TIME]-y));_+=(u[g+a.R]-_)*S,d+=(u[g+a.G]-d)*S,p+=(u[g+a.B]-p)*S,m+=(u[g+a.A]-m)*S}1==s?l.color.set(_,d,p,m):(h=l.color,c==t.setup&&h.setFromColor(l.data.color),h.add((_-h.r)*s,(d-h.g)*s,(p-h.b)*s,(m-h.a)*s))}}},a.ENTRIES=5,a.PREV_TIME=-5,a.PREV_R=-4,a.PREV_G=-3,a.PREV_B=-2,a.PREV_A=-1,a.R=1,a.G=2,a.B=3,a.A=4,a}(a);e.ColorTimeline=u;var h=function(n){function a(t){var i=n.call(this,t)||this;return i.frames=e.Utils.newFloatArray(t*a.ENTRIES),i}return E6(a,n),a.prototype.getPropertyId=function(){return(i.twoColor<<24)+this.slotIndex},a.prototype.setFrame=function(e,t,n,i,r,o,s,c,l){e*=a.ENTRIES,this.frames[e]=t,this.frames[e+a.R]=n,this.frames[e+a.G]=i,this.frames[e+a.B]=r,this.frames[e+a.A]=o,this.frames[e+a.R2]=s,this.frames[e+a.G2]=c,this.frames[e+a.B2]=l},a.prototype.apply=function(e,n,i,o,s,c){var l=e.slots[this.slotIndex];if(l.bone.active){var u=this.frames;if(i<u[0])switch(c){case t.setup:return l.color.setFromColor(l.data.color),void l.darkColor.setFromColor(l.data.darkColor);case t.first:var h=l.color,f=l.darkColor,_=l.data.color,d=l.data.darkColor;h.add((_.r-h.r)*s,(_.g-h.g)*s,(_.b-h.b)*s,(_.a-h.a)*s),f.add((d.r-f.r)*s,(d.g-f.g)*s,(d.b-f.b)*s,0)}else{var p=0,m=0,v=0,g=0,y=0,S=0,x=0;if(i>=u[u.length-a.ENTRIES]){var E=u.length;p=u[E+a.PREV_R],m=u[E+a.PREV_G],v=u[E+a.PREV_B],g=u[E+a.PREV_A],y=u[E+a.PREV_R2],S=u[E+a.PREV_G2],x=u[E+a.PREV_B2]}else{var T=r.binarySearch(u,i,a.ENTRIES);p=u[T+a.PREV_R],m=u[T+a.PREV_G],v=u[T+a.PREV_B],g=u[T+a.PREV_A],y=u[T+a.PREV_R2],S=u[T+a.PREV_G2],x=u[T+a.PREV_B2];var C=u[T],A=this.getCurvePercent(T/a.ENTRIES-1,1-(i-C)/(u[T+a.PREV_TIME]-C));p+=(u[T+a.R]-p)*A,m+=(u[T+a.G]-m)*A,v+=(u[T+a.B]-v)*A,g+=(u[T+a.A]-g)*A,y+=(u[T+a.R2]-y)*A,S+=(u[T+a.G2]-S)*A,x+=(u[T+a.B2]-x)*A}1==s?(l.color.set(p,m,v,g),l.darkColor.set(y,S,x,1)):(h=l.color,f=l.darkColor,c==t.setup&&(h.setFromColor(l.data.color),f.setFromColor(l.data.darkColor)),h.add((p-h.r)*s,(m-h.g)*s,(v-h.b)*s,(g-h.a)*s),f.add((y-f.r)*s,(S-f.g)*s,(x-f.b)*s,0))}}},a.ENTRIES=8,a.PREV_TIME=-8,a.PREV_R=-7,a.PREV_G=-6,a.PREV_B=-5,a.PREV_A=-4,a.PREV_R2=-3,a.PREV_G2=-2,a.PREV_B2=-1,a.R=1,a.G=2,a.B=3,a.A=4,a.R2=5,a.G2=6,a.B2=7,a}(a);e.TwoColorTimeline=h;var f=function(){function a(t){this.frames=e.Utils.newFloatArray(t),this.attachmentNames=new Array(t)}return a.prototype.getPropertyId=function(){return(i.attachment<<24)+this.slotIndex},a.prototype.getFrameCount=function(){return this.frames.length},a.prototype.setFrame=function(e,t,n){this.frames[e]=t,this.attachmentNames[e]=n},a.prototype.apply=function(e,i,a,o,s,c,l){var u=e.slots[this.slotIndex];if(u.bone.active)if(l!=n.mixOut||c!=t.setup){var h=this.frames;if(a<h[0]){if(c==t.setup||c==t.first){var f=u.data.attachmentName;u.setAttachment(null==f?null:e.getAttachment(this.slotIndex,f))}}else{var _;_=a>=h[h.length-1]?h.length-1:r.binarySearch(h,a,1)-1;var d=this.attachmentNames[_];e.slots[this.slotIndex].setAttachment(null==d?null:e.getAttachment(this.slotIndex,d))}}else{var p=u.data.attachmentName;u.setAttachment(null==p?null:e.getAttachment(this.slotIndex,p))}},a}();e.AttachmentTimeline=f;var _=null,d=function(n){function a(t){var i=n.call(this,t)||this;return i.frames=e.Utils.newFloatArray(t),i.frameVertices=new Array(t),null==_&&(_=e.Utils.newFloatArray(64)),i}return E6(a,n),a.prototype.getPropertyId=function(){return(i.deform<<27)+ +this.attachment.id+this.slotIndex},a.prototype.setFrame=function(e,t,n){this.frames[e]=t,this.frameVertices[e]=n},a.prototype.apply=function(n,i,a,o,s,c){var l=n.slots[this.slotIndex];if(l.bone.active){var u=l.getAttachment();if(u instanceof e.VertexAttachment&&u.deformAttachment==this.attachment){var h=l.deform;0==h.length&&(c=t.setup);var f=this.frameVertices,_=f[0].length,d=this.frames;if(a<d[0]){var p=u;switch(c){case t.setup:return void(h.length=0);case t.first:if(1==s){h.length=0;break}var m=e.Utils.setArraySize(h,_);if(null==p.bones)for(var v=p.vertices,g=0;g<_;g++)m[g]+=(v[g]-m[g])*s;else for(s=1-s,g=0;g<_;g++)m[g]*=s}}else{var y=e.Utils.setArraySize(h,_);if(a>=d[d.length-1]){var S=f[d.length-1];if(1==s)if(c==t.add)if(null==(p=u).bones){v=p.vertices;for(var x=0;x<_;x++)y[x]+=S[x]-v[x]}else for(var E=0;E<_;E++)y[E]+=S[E];else e.Utils.arrayCopy(S,0,y,0,_);else switch(c){case t.setup:var T=u;if(null==T.bones){v=T.vertices;for(var C=0;C<_;C++){var A=v[C];y[C]=A+(S[C]-A)*s}}else for(var b=0;b<_;b++)y[b]=S[b]*s;break;case t.first:case t.replace:for(var I=0;I<_;I++)y[I]+=(S[I]-y[I])*s;case t.add:if(null==(p=u).bones){v=p.vertices;for(var w=0;w<_;w++)y[w]+=(S[w]-v[w])*s}else for(var P=0;P<_;P++)y[P]+=S[P]*s}}else{var R=r.binarySearch(d,a),D=f[R-1],O=f[R],N=d[R],M=this.getCurvePercent(R-1,1-(a-N)/(d[R-1]-N));if(1==s)if(c==t.add)if(null==(p=u).bones){v=p.vertices;for(var L=0;L<_;L++){var F=D[L];y[L]+=F+(O[L]-F)*M-v[L]}}else for(var B=0;B<_;B++)F=D[B],y[B]+=F+(O[B]-F)*M;else for(var z=0;z<_;z++)F=D[z],y[z]=F+(O[z]-F)*M;else switch(c){case t.setup:var U=u;if(null==U.bones){v=U.vertices;for(var k=0;k<_;k++)F=D[k],A=v[k],y[k]=A+(F+(O[k]-F)*M-A)*s}else for(var G=0;G<_;G++)F=D[G],y[G]=(F+(O[G]-F)*M)*s;break;case t.first:case t.replace:for(var H=0;H<_;H++)F=D[H],y[H]+=(F+(O[H]-F)*M-y[H])*s;break;case t.add:if(null==(p=u).bones){v=p.vertices;for(var V=0;V<_;V++)F=D[V],y[V]+=(F+(O[V]-F)*M-v[V])*s}else for(var W=0;W<_;W++)F=D[W],y[W]+=(F+(O[W]-F)*M)*s}}}}}},a}(a);e.DeformTimeline=d;var p=function(){function t(t){this.frames=e.Utils.newFloatArray(t),this.events=new Array(t)}return t.prototype.getPropertyId=function(){return i.event<<24},t.prototype.getFrameCount=function(){return this.frames.length},t.prototype.setFrame=function(e,t){this.frames[e]=t.time,this.events[e]=t},t.prototype.apply=function(e,t,n,i,a,o,s){if(null!=i){var c=this.frames,l=this.frames.length;if(t>n)this.apply(e,t,Number.MAX_VALUE,i,a,o,s),t=-1;else if(t>=c[l-1])return;if(!(n<c[0])){var u=0;if(t<c[0])u=0;else for(var h=c[u=r.binarySearch(c,t)];u>0&&c[u-1]==h;)u--;for(;u<l&&n>=c[u];u++)i.push(this.events[u])}}},t}();e.EventTimeline=p;var m=function(){function a(t){this.frames=e.Utils.newFloatArray(t),this.drawOrders=new Array(t)}return a.prototype.getPropertyId=function(){return i.drawOrder<<24},a.prototype.getFrameCount=function(){return this.frames.length},a.prototype.setFrame=function(e,t,n){this.frames[e]=t,this.drawOrders[e]=n},a.prototype.apply=function(i,a,o,s,c,l,u){var h=i.drawOrder,f=i.slots;if(u!=n.mixOut||l!=t.setup){var _=this.frames;if(o<_[0])l!=t.setup&&l!=t.first||e.Utils.arrayCopy(i.slots,0,i.drawOrder,0,i.slots.length);else{var d;d=o>=_[_.length-1]?_.length-1:r.binarySearch(_,o)-1;var p=this.drawOrders[d];if(null==p)e.Utils.arrayCopy(f,0,h,0,f.length);else for(var m=0,v=p.length;m<v;m++)h[m]=f[p[m]]}}else e.Utils.arrayCopy(i.slots,0,i.drawOrder,0,i.slots.length)},a}();e.DrawOrderTimeline=m;var v=function(a){function o(t){var n=a.call(this,t)||this;return n.frames=e.Utils.newFloatArray(t*o.ENTRIES),n}return E6(o,a),o.prototype.getPropertyId=function(){return(i.ikConstraint<<24)+this.ikConstraintIndex},o.prototype.setFrame=function(e,t,n,i,r,a,s){e*=o.ENTRIES,this.frames[e]=t,this.frames[e+o.MIX]=n,this.frames[e+o.SOFTNESS]=i,this.frames[e+o.BEND_DIRECTION]=r,this.frames[e+o.COMPRESS]=a?1:0,this.frames[e+o.STRETCH]=s?1:0},o.prototype.apply=function(e,i,a,s,c,l,u){var h=this.frames,f=e.ikConstraints[this.ikConstraintIndex];if(f.active)if(a<h[0])switch(l){case t.setup:return f.mix=f.data.mix,f.softness=f.data.softness,f.bendDirection=f.data.bendDirection,f.compress=f.data.compress,void(f.stretch=f.data.stretch);case t.first:f.mix+=(f.data.mix-f.mix)*c,f.softness+=(f.data.softness-f.softness)*c,f.bendDirection=f.data.bendDirection,f.compress=f.data.compress,f.stretch=f.data.stretch}else if(a>=h[h.length-o.ENTRIES])l==t.setup?(f.mix=f.data.mix+(h[h.length+o.PREV_MIX]-f.data.mix)*c,f.softness=f.data.softness+(h[h.length+o.PREV_SOFTNESS]-f.data.softness)*c,u==n.mixOut?(f.bendDirection=f.data.bendDirection,f.compress=f.data.compress,f.stretch=f.data.stretch):(f.bendDirection=h[h.length+o.PREV_BEND_DIRECTION],f.compress=0!=h[h.length+o.PREV_COMPRESS],f.stretch=0!=h[h.length+o.PREV_STRETCH])):(f.mix+=(h[h.length+o.PREV_MIX]-f.mix)*c,f.softness+=(h[h.length+o.PREV_SOFTNESS]-f.softness)*c,u==n.mixIn&&(f.bendDirection=h[h.length+o.PREV_BEND_DIRECTION],f.compress=0!=h[h.length+o.PREV_COMPRESS],f.stretch=0!=h[h.length+o.PREV_STRETCH]));else{var _=r.binarySearch(h,a,o.ENTRIES),d=h[_+o.PREV_MIX],p=h[_+o.PREV_SOFTNESS],m=h[_],v=this.getCurvePercent(_/o.ENTRIES-1,1-(a-m)/(h[_+o.PREV_TIME]-m));l==t.setup?(f.mix=f.data.mix+(d+(h[_+o.MIX]-d)*v-f.data.mix)*c,f.softness=f.data.softness+(p+(h[_+o.SOFTNESS]-p)*v-f.data.softness)*c,u==n.mixOut?(f.bendDirection=f.data.bendDirection,f.compress=f.data.compress,f.stretch=f.data.stretch):(f.bendDirection=h[_+o.PREV_BEND_DIRECTION],f.compress=0!=h[_+o.PREV_COMPRESS],f.stretch=0!=h[_+o.PREV_STRETCH])):(f.mix+=(d+(h[_+o.MIX]-d)*v-f.mix)*c,f.softness+=(p+(h[_+o.SOFTNESS]-p)*v-f.softness)*c,u==n.mixIn&&(f.bendDirection=h[_+o.PREV_BEND_DIRECTION],f.compress=0!=h[_+o.PREV_COMPRESS],f.stretch=0!=h[_+o.PREV_STRETCH]))}},o.ENTRIES=6,o.PREV_TIME=-6,o.PREV_MIX=-5,o.PREV_SOFTNESS=-4,o.PREV_BEND_DIRECTION=-3,o.PREV_COMPRESS=-2,o.PREV_STRETCH=-1,o.MIX=1,o.SOFTNESS=2,o.BEND_DIRECTION=3,o.COMPRESS=4,o.STRETCH=5,o}(a);e.IkConstraintTimeline=v;var g=function(n){function a(t){var i=n.call(this,t)||this;return i.frames=e.Utils.newFloatArray(t*a.ENTRIES),i}return E6(a,n),a.prototype.getPropertyId=function(){return(i.transformConstraint<<24)+this.transformConstraintIndex},a.prototype.setFrame=function(e,t,n,i,r,o){e*=a.ENTRIES,this.frames[e]=t,this.frames[e+a.ROTATE]=n,this.frames[e+a.TRANSLATE]=i,this.frames[e+a.SCALE]=r,this.frames[e+a.SHEAR]=o},a.prototype.apply=function(e,n,i,o,s,c){var l=this.frames,u=e.transformConstraints[this.transformConstraintIndex];if(u.active)if(i<l[0]){var h=u.data;switch(c){case t.setup:return u.rotateMix=h.rotateMix,u.translateMix=h.translateMix,u.scaleMix=h.scaleMix,void(u.shearMix=h.shearMix);case t.first:u.rotateMix+=(h.rotateMix-u.rotateMix)*s,u.translateMix+=(h.translateMix-u.translateMix)*s,u.scaleMix+=(h.scaleMix-u.scaleMix)*s,u.shearMix+=(h.shearMix-u.shearMix)*s}}else{var f=0,_=0,d=0,p=0;if(i>=l[l.length-a.ENTRIES]){var m=l.length;f=l[m+a.PREV_ROTATE],_=l[m+a.PREV_TRANSLATE],d=l[m+a.PREV_SCALE],p=l[m+a.PREV_SHEAR]}else{var v=r.binarySearch(l,i,a.ENTRIES);f=l[v+a.PREV_ROTATE],_=l[v+a.PREV_TRANSLATE],d=l[v+a.PREV_SCALE],p=l[v+a.PREV_SHEAR];var g=l[v],y=this.getCurvePercent(v/a.ENTRIES-1,1-(i-g)/(l[v+a.PREV_TIME]-g));f+=(l[v+a.ROTATE]-f)*y,_+=(l[v+a.TRANSLATE]-_)*y,d+=(l[v+a.SCALE]-d)*y,p+=(l[v+a.SHEAR]-p)*y}c==t.setup?(h=u.data,u.rotateMix=h.rotateMix+(f-h.rotateMix)*s,u.translateMix=h.translateMix+(_-h.translateMix)*s,u.scaleMix=h.scaleMix+(d-h.scaleMix)*s,u.shearMix=h.shearMix+(p-h.shearMix)*s):(u.rotateMix+=(f-u.rotateMix)*s,u.translateMix+=(_-u.translateMix)*s,u.scaleMix+=(d-u.scaleMix)*s,u.shearMix+=(p-u.shearMix)*s)}},a.ENTRIES=5,a.PREV_TIME=-5,a.PREV_ROTATE=-4,a.PREV_TRANSLATE=-3,a.PREV_SCALE=-2,a.PREV_SHEAR=-1,a.ROTATE=1,a.TRANSLATE=2,a.SCALE=3,a.SHEAR=4,a}(a);e.TransformConstraintTimeline=g;var y=function(n){function a(t){var i=n.call(this,t)||this;return i.frames=e.Utils.newFloatArray(t*a.ENTRIES),i}return E6(a,n),a.prototype.getPropertyId=function(){return(i.pathConstraintPosition<<24)+this.pathConstraintIndex},a.prototype.setFrame=function(e,t,n){e*=a.ENTRIES,this.frames[e]=t,this.frames[e+a.VALUE]=n},a.prototype.apply=function(e,n,i,o,s,c){var l=this.frames,u=e.pathConstraints[this.pathConstraintIndex];if(u.active)if(i<l[0])switch(c){case t.setup:return void(u.position=u.data.position);case t.first:u.position+=(u.data.position-u.position)*s}else{var h=0;if(i>=l[l.length-a.ENTRIES])h=l[l.length+a.PREV_VALUE];else{var f=r.binarySearch(l,i,a.ENTRIES);h=l[f+a.PREV_VALUE];var _=l[f],d=this.getCurvePercent(f/a.ENTRIES-1,1-(i-_)/(l[f+a.PREV_TIME]-_));h+=(l[f+a.VALUE]-h)*d}c==t.setup?u.position=u.data.position+(h-u.data.position)*s:u.position+=(h-u.position)*s}},a.ENTRIES=2,a.PREV_TIME=-2,a.PREV_VALUE=-1,a.VALUE=1,a}(a);e.PathConstraintPositionTimeline=y;var S=function(e){function n(t){return e.call(this,t)||this}return E6(n,e),n.prototype.getPropertyId=function(){return(i.pathConstraintSpacing<<24)+this.pathConstraintIndex},n.prototype.apply=function(e,i,a,o,s,c){var l=this.frames,u=e.pathConstraints[this.pathConstraintIndex];if(u.active)if(a<l[0])switch(c){case t.setup:return void(u.spacing=u.data.spacing);case t.first:u.spacing+=(u.data.spacing-u.spacing)*s}else{var h=0;if(a>=l[l.length-n.ENTRIES])h=l[l.length+n.PREV_VALUE];else{var f=r.binarySearch(l,a,n.ENTRIES);h=l[f+n.PREV_VALUE];var _=l[f],d=this.getCurvePercent(f/n.ENTRIES-1,1-(a-_)/(l[f+n.PREV_TIME]-_));h+=(l[f+n.VALUE]-h)*d}c==t.setup?u.spacing=u.data.spacing+(h-u.data.spacing)*s:u.spacing+=(h-u.spacing)*s}},n}(y);e.PathConstraintSpacingTimeline=S;var x=function(n){function a(t){var i=n.call(this,t)||this;return i.frames=e.Utils.newFloatArray(t*a.ENTRIES),i}return E6(a,n),a.prototype.getPropertyId=function(){return(i.pathConstraintMix<<24)+this.pathConstraintIndex},a.prototype.setFrame=function(e,t,n,i){e*=a.ENTRIES,this.frames[e]=t,this.frames[e+a.ROTATE]=n,this.frames[e+a.TRANSLATE]=i},a.prototype.apply=function(e,n,i,o,s,c){var l=this.frames,u=e.pathConstraints[this.pathConstraintIndex];if(u.active)if(i<l[0])switch(c){case t.setup:return u.rotateMix=u.data.rotateMix,void(u.translateMix=u.data.translateMix);case t.first:u.rotateMix+=(u.data.rotateMix-u.rotateMix)*s,u.translateMix+=(u.data.translateMix-u.translateMix)*s}else{var h=0,f=0;if(i>=l[l.length-a.ENTRIES])h=l[l.length+a.PREV_ROTATE],f=l[l.length+a.PREV_TRANSLATE];else{var _=r.binarySearch(l,i,a.ENTRIES);h=l[_+a.PREV_ROTATE],f=l[_+a.PREV_TRANSLATE];var d=l[_],p=this.getCurvePercent(_/a.ENTRIES-1,1-(i-d)/(l[_+a.PREV_TIME]-d));h+=(l[_+a.ROTATE]-h)*p,f+=(l[_+a.TRANSLATE]-f)*p}c==t.setup?(u.rotateMix=u.data.rotateMix+(h-u.data.rotateMix)*s,u.translateMix=u.data.translateMix+(f-u.data.translateMix)*s):(u.rotateMix+=(h-u.rotateMix)*s,u.translateMix+=(f-u.translateMix)*s)}},a.ENTRIES=3,a.PREV_TIME=-3,a.PREV_ROTATE=-2,a.PREV_TRANSLATE=-1,a.ROTATE=1,a.TRANSLATE=2,a}(a);e.PathConstraintMixTimeline=x}(x6||(x6={})),function(e){var t=function(){function t(t){this.tracks=new Array,this.timeScale=1,this.events=new Array,this.listeners=new Array,this.queue=new r(this),this.propertyIDs=new e.IntSet,this.animationsChanged=!1,this.trackEntryPool=new e.Pool((function(){return new n})),this.data=t}return t.prototype.update=function(e){e*=this.timeScale;for(var t=this.tracks,n=0,i=t.length;n<i;n++){var r=t[n];if(null!=r){r.animationLast=r.nextAnimationLast,r.trackLast=r.nextTrackLast;var a=e*r.timeScale;if(r.delay>0){if(r.delay-=a,r.delay>0)continue;a=-r.delay,r.delay=0}var o=r.next;if(null!=o){var s=r.trackLast-o.delay;if(s>=0){for(o.delay=0,o.trackTime+=0==r.timeScale?0:(s/r.timeScale+e)*o.timeScale,r.trackTime+=a,this.setCurrent(n,o,!0);null!=o.mixingFrom;)o.mixTime+=e,o=o.mixingFrom;continue}}else if(r.trackLast>=r.trackEnd&&null==r.mixingFrom){t[n]=null,this.queue.end(r),this.disposeNext(r);continue}if(null!=r.mixingFrom&&this.updateMixingFrom(r,e)){var c=r.mixingFrom;for(r.mixingFrom=null,null!=c&&(c.mixingTo=null);null!=c;)this.queue.end(c),c=c.mixingFrom}r.trackTime+=a}}this.queue.drain()},t.prototype.updateMixingFrom=function(e,t){var n=e.mixingFrom;if(null==n)return!0;var i=this.updateMixingFrom(n,t);return n.animationLast=n.nextAnimationLast,n.trackLast=n.nextTrackLast,e.mixTime>0&&e.mixTime>=e.mixDuration?(0!=n.totalAlpha&&0!=e.mixDuration||(e.mixingFrom=n.mixingFrom,null!=n.mixingFrom&&(n.mixingFrom.mixingTo=e),e.interruptAlpha=n.interruptAlpha,this.queue.end(n)),i):(n.trackTime+=t*n.timeScale,e.mixTime+=t,!1)},t.prototype.apply=function(n){if(null==n)throw new Error("skeleton cannot be null.");this.animationsChanged&&this._animationsChanged();for(var i=this.events,r=this.tracks,a=!1,o=0,s=r.length;o<s;o++){var c=r[o];if(!(null==c||c.delay>0)){a=!0;var l=0==o?e.MixBlend.first:c.mixBlend,u=c.alpha;null!=c.mixingFrom?u*=this.applyMixingFrom(c,n,l):c.trackTime>=c.trackEnd&&null==c.next&&(u=0);var h=c.animationLast,f=c.getAnimationTime(),_=c.animation.timelines.length,d=c.animation.timelines;if(0==o&&1==u||l==e.MixBlend.add)for(var p=0;p<_;p++)e.Utils.webkit602BugfixHelper(u,l),d[p].apply(n,h,f,i,u,l,e.MixDirection.mixIn);else{var m=c.timelineMode,v=0==c.timelinesRotation.length;v&&e.Utils.setArraySize(c.timelinesRotation,_<<1,null);var g=c.timelinesRotation;for(p=0;p<_;p++){var y=d[p],S=(m[p]&t.NOT_LAST-1)==t.SUBSEQUENT?l:e.MixBlend.setup;y instanceof e.RotateTimeline?this.applyRotateTimeline(y,n,f,u,S,g,p<<1,v):(e.Utils.webkit602BugfixHelper(u,l),y.apply(n,h,f,i,u,S,e.MixDirection.mixIn))}}this.queueEvents(c,f),i.length=0,c.nextAnimationLast=f,c.nextTrackLast=c.trackTime}}return this.queue.drain(),a},t.prototype.applyMixingFrom=function(n,i,r){var a=n.mixingFrom;null!=a.mixingFrom&&this.applyMixingFrom(a,i,r);var o=0;0==n.mixDuration?(o=1,r==e.MixBlend.first&&(r=e.MixBlend.setup)):((o=n.mixTime/n.mixDuration)>1&&(o=1),r!=e.MixBlend.first&&(r=a.mixBlend));var s=o<a.eventThreshold?this.events:null,c=o<a.attachmentThreshold,l=o<a.drawOrderThreshold,u=a.animationLast,h=a.getAnimationTime(),f=a.animation.timelines.length,_=a.animation.timelines,d=a.alpha*n.interruptAlpha,p=d*(1-o);if(r==e.MixBlend.add)for(var m=0;m<f;m++)_[m].apply(i,u,h,s,p,r,e.MixDirection.mixOut);else{var v=a.timelineMode,g=a.timelineHoldMix,y=0==a.timelinesRotation.length;y&&e.Utils.setArraySize(a.timelinesRotation,f<<1,null);var S=a.timelinesRotation;for(a.totalAlpha=0,m=0;m<f;m++){var x=_[m],E=e.MixDirection.mixOut,T=void 0,C=0;switch(v[m]&t.NOT_LAST-1){case t.SUBSEQUENT:if(T=r,!c&&x instanceof e.AttachmentTimeline){if((v[m]&t.NOT_LAST)==t.NOT_LAST)continue;T=e.MixBlend.setup}if(!l&&x instanceof e.DrawOrderTimeline)continue;C=p;break;case t.FIRST:T=e.MixBlend.setup,C=p;break;case t.HOLD:T=e.MixBlend.setup,C=d;break;default:T=e.MixBlend.setup;var A=g[m];C=d*Math.max(0,1-A.mixTime/A.mixDuration)}a.totalAlpha+=C,x instanceof e.RotateTimeline?this.applyRotateTimeline(x,i,h,C,T,S,m<<1,y):(e.Utils.webkit602BugfixHelper(C,r),T==e.MixBlend.setup&&(x instanceof e.AttachmentTimeline?(c||(v[m]&t.NOT_LAST)==t.NOT_LAST)&&(E=e.MixDirection.mixIn):x instanceof e.DrawOrderTimeline&&l&&(E=e.MixDirection.mixIn)),x.apply(i,u,h,s,C,T,E))}}return n.mixDuration>0&&this.queueEvents(a,h),this.events.length=0,a.nextAnimationLast=h,a.nextTrackLast=a.trackTime,o},t.prototype.applyRotateTimeline=function(t,n,i,r,a,o,s,c){if(c&&(o[s]=0),1!=r){var l=t,u=l.frames,h=n.bones[l.boneIndex];if(h.active){var f=0,_=0;if(i<u[0])switch(a){case e.MixBlend.setup:h.rotation=h.data.rotation;default:return;case e.MixBlend.first:f=h.rotation,_=h.data.rotation}else if(f=a==e.MixBlend.setup?h.data.rotation:h.rotation,i>=u[u.length-e.RotateTimeline.ENTRIES])_=h.data.rotation+u[u.length+e.RotateTimeline.PREV_ROTATION];else{var d=e.Animation.binarySearch(u,i,e.RotateTimeline.ENTRIES),p=u[d+e.RotateTimeline.PREV_ROTATION],m=u[d],v=l.getCurvePercent((d>>1)-1,1-(i-m)/(u[d+e.RotateTimeline.PREV_TIME]-m));_=u[d+e.RotateTimeline.ROTATION]-p,_=p+(_-=360*(16384-(16384.499999999996-_/360|0)))*v+h.data.rotation,_-=360*(16384-(16384.499999999996-_/360|0))}var g=0,y=_-f;if(0==(y-=360*(16384-(16384.499999999996-y/360|0))))g=o[s];else{var S=0,x=0;c?(S=0,x=y):(S=o[s],x=o[s+1]);var E=y>0,T=S>=0;e.MathUtils.signum(x)!=e.MathUtils.signum(y)&&Math.abs(x)<=90&&(Math.abs(S)>180&&(S+=360*e.MathUtils.signum(S)),T=E),g=y+S-S%360,T!=E&&(g+=360*e.MathUtils.signum(S)),o[s]=g}o[s+1]=y,f+=g*r,h.rotation=f-360*(16384-(16384.499999999996-f/360|0))}}else t.apply(n,0,i,null,1,a,e.MixDirection.mixIn)},t.prototype.queueEvents=function(e,t){for(var n=e.animationStart,i=e.animationEnd,r=i-n,a=e.trackLast%r,o=this.events,s=0,c=o.length;s<c;s++){var l=o[s];if(l.time<a)break;l.time>i||this.queue.event(e,l)}for((e.loop?0==r||a>e.trackTime%r:t>=i&&e.animationLast<i)&&this.queue.complete(e);s<c;s++)o[s].time<n||this.queue.event(e,o[s])},t.prototype.clearTracks=function(){var e=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var t=0,n=this.tracks.length;t<n;t++)this.clearTrack(t);this.tracks.length=0,this.queue.drainDisabled=e,this.queue.drain()},t.prototype.clearTrack=function(e){if(!(e>=this.tracks.length)){var t=this.tracks[e];if(null!=t){this.queue.end(t),this.disposeNext(t);for(var n=t;;){var i=n.mixingFrom;if(null==i)break;this.queue.end(i),n.mixingFrom=null,n.mixingTo=null,n=i}this.tracks[t.trackIndex]=null,this.queue.drain()}}},t.prototype.setCurrent=function(e,t,n){var i=this.expandToIndex(e);this.tracks[e]=t,null!=i&&(n&&this.queue.interrupt(i),t.mixingFrom=i,i.mixingTo=t,t.mixTime=0,null!=i.mixingFrom&&i.mixDuration>0&&(t.interruptAlpha*=Math.min(1,i.mixTime/i.mixDuration)),i.timelinesRotation.length=0),this.queue.start(t)},t.prototype.setAnimation=function(e,t,n){var i=this.data.skeletonData.findAnimation(t);if(null==i)throw new Error("Animation not found: "+t);return this.setAnimationWith(e,i,n)},t.prototype.setAnimationWith=function(e,t,n){if(null==t)throw new Error("animation cannot be null.");var i=!0,r=this.expandToIndex(e);null!=r&&(-1==r.nextTrackLast?(this.tracks[e]=r.mixingFrom,this.queue.interrupt(r),this.queue.end(r),this.disposeNext(r),r=r.mixingFrom,i=!1):this.disposeNext(r));var a=this.trackEntry(e,t,n,r);return this.setCurrent(e,a,i),this.queue.drain(),a},t.prototype.addAnimation=function(e,t,n,i){var r=this.data.skeletonData.findAnimation(t);if(null==r)throw new Error("Animation not found: "+t);return this.addAnimationWith(e,r,n,i)},t.prototype.addAnimationWith=function(e,t,n,i){if(null==t)throw new Error("animation cannot be null.");var r=this.expandToIndex(e);if(null!=r)for(;null!=r.next;)r=r.next;var a=this.trackEntry(e,t,n,r);if(null==r)this.setCurrent(e,a,!0),this.queue.drain();else if(r.next=a,i<=0){var o=r.animationEnd-r.animationStart;0!=o?(r.loop?i+=o*(1+(r.trackTime/o|0)):i+=Math.max(o,r.trackTime),i-=this.data.getMix(r.animation,t)):i=r.trackTime}return a.delay=i,a},t.prototype.setEmptyAnimation=function(e,n){var i=this.setAnimationWith(e,t.emptyAnimation,!1);return i.mixDuration=n,i.trackEnd=n,i},t.prototype.addEmptyAnimation=function(e,n,i){i<=0&&(i-=n);var r=this.addAnimationWith(e,t.emptyAnimation,!1,i);return r.mixDuration=n,r.trackEnd=n,r},t.prototype.setEmptyAnimations=function(e){var t=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var n=0,i=this.tracks.length;n<i;n++){var r=this.tracks[n];null!=r&&this.setEmptyAnimation(r.trackIndex,e)}this.queue.drainDisabled=t,this.queue.drain()},t.prototype.expandToIndex=function(t){return t<this.tracks.length?this.tracks[t]:(e.Utils.ensureArrayCapacity(this.tracks,t+1,null),this.tracks.length=t+1,null)},t.prototype.trackEntry=function(e,t,n,i){var r=this.trackEntryPool.obtain();return r.trackIndex=e,r.animation=t,r.loop=n,r.holdPrevious=!1,r.eventThreshold=0,r.attachmentThreshold=0,r.drawOrderThreshold=0,r.animationStart=0,r.animationEnd=t.duration,r.animationLast=-1,r.nextAnimationLast=-1,r.delay=0,r.trackTime=0,r.trackLast=-1,r.nextTrackLast=-1,r.trackEnd=Number.MAX_VALUE,r.timeScale=1,r.alpha=1,r.interruptAlpha=1,r.mixTime=0,r.mixDuration=null==i?0:this.data.getMix(i.animation,t),r},t.prototype.disposeNext=function(e){for(var t=e.next;null!=t;)this.queue.dispose(t),t=t.next;e.next=null},t.prototype._animationsChanged=function(){this.animationsChanged=!1,this.propertyIDs.clear();for(var t=0,n=this.tracks.length;t<n;t++)if(null!=(i=this.tracks[t])){for(;null!=i.mixingFrom;)i=i.mixingFrom;do{null!=i.mixingFrom&&i.mixBlend==e.MixBlend.add||this.computeHold(i),i=i.mixingTo}while(null!=i)}for(this.propertyIDs.clear(),t=this.tracks.length-1;t>=0;t--)for(var i=this.tracks[t];null!=i;)this.computeNotLast(i),i=i.mixingFrom},t.prototype.computeHold=function(n){var i=n.mixingTo,r=n.animation.timelines,a=n.animation.timelines.length,o=e.Utils.setArraySize(n.timelineMode,a);n.timelineHoldMix.length=0;var s=e.Utils.setArraySize(n.timelineHoldMix,a),c=this.propertyIDs;if(null!=i&&i.holdPrevious)for(var l=0;l<a;l++)c.add(r[l].getPropertyId()),o[l]=t.HOLD;else e:for(l=0;l<a;l++){var u=r[l],h=u.getPropertyId();if(c.add(h))if(null==i||u instanceof e.AttachmentTimeline||u instanceof e.DrawOrderTimeline||u instanceof e.EventTimeline||!i.animation.hasTimeline(h))o[l]=t.FIRST;else{for(var f=i.mixingTo;null!=f;f=f.mixingTo)if(!f.animation.hasTimeline(h)){if(n.mixDuration>0){o[l]=t.HOLD_MIX,s[l]=f;continue e}break}o[l]=t.HOLD}else o[l]=t.SUBSEQUENT}},t.prototype.computeNotLast=function(n){for(var i=n.animation.timelines,r=n.animation.timelines.length,a=n.timelineMode,o=this.propertyIDs,s=0;s<r;s++)if(i[s]instanceof e.AttachmentTimeline){var c=i[s];o.add(c.slotIndex)||(a[s]|=t.NOT_LAST)}},t.prototype.getCurrent=function(e){return e>=this.tracks.length?null:this.tracks[e]},t.prototype.addListener=function(e){if(null==e)throw new Error("listener cannot be null.");this.listeners.push(e)},t.prototype.removeListener=function(e){var t=this.listeners.indexOf(e);t>=0&&this.listeners.splice(t,1)},t.prototype.clearListeners=function(){this.listeners.length=0},t.prototype.clearListenerNotifications=function(){this.queue.clear()},t.emptyAnimation=new e.Animation("<empty>",[],0),t.SUBSEQUENT=0,t.FIRST=1,t.HOLD=2,t.HOLD_MIX=3,t.NOT_LAST=4,t}();e.AnimationState=t;var n=function(){function t(){this.mixBlend=e.MixBlend.replace,this.timelineMode=new Array,this.timelineHoldMix=new Array,this.timelinesRotation=new Array}return t.prototype.reset=function(){this.next=null,this.mixingFrom=null,this.mixingTo=null,this.animation=null,this.listener=null,this.timelineMode.length=0,this.timelineHoldMix.length=0,this.timelinesRotation.length=0},t.prototype.getAnimationTime=function(){if(this.loop){var e=this.animationEnd-this.animationStart;return 0==e?this.animationStart:this.trackTime%e+this.animationStart}return Math.min(this.trackTime+this.animationStart,this.animationEnd)},t.prototype.setAnimationLast=function(e){this.animationLast=e,this.nextAnimationLast=e},t.prototype.isComplete=function(){return this.trackTime>=this.animationEnd-this.animationStart},t.prototype.resetRotationDirections=function(){this.timelinesRotation.length=0},t}();e.TrackEntry=n;var i,r=function(){function e(e){this.objects=[],this.drainDisabled=!1,this.animState=e}return e.prototype.start=function(e){this.objects.push(i.start),this.objects.push(e),this.animState.animationsChanged=!0},e.prototype.interrupt=function(e){this.objects.push(i.interrupt),this.objects.push(e)},e.prototype.end=function(e){this.objects.push(i.end),this.objects.push(e),this.animState.animationsChanged=!0},e.prototype.dispose=function(e){this.objects.push(i.dispose),this.objects.push(e)},e.prototype.complete=function(e){this.objects.push(i.complete),this.objects.push(e)},e.prototype.event=function(e,t){this.objects.push(i.event),this.objects.push(e),this.objects.push(t)},e.prototype.drain=function(){if(!this.drainDisabled){this.drainDisabled=!0;for(var e=this.objects,t=this.animState.listeners,n=0;n<e.length;n+=2){var r=e[n],a=e[n+1];switch(r){case i.start:null!=a.listener&&a.listener.start&&a.listener.start(a);for(var o=0;o<t.length;o++)t[o].start&&t[o].start(a);break;case i.interrupt:for(null!=a.listener&&a.listener.interrupt&&a.listener.interrupt(a),o=0;o<t.length;o++)t[o].interrupt&&t[o].interrupt(a);break;case i.end:for(null!=a.listener&&a.listener.end&&a.listener.end(a),o=0;o<t.length;o++)t[o].end&&t[o].end(a);case i.dispose:for(null!=a.listener&&a.listener.dispose&&a.listener.dispose(a),o=0;o<t.length;o++)t[o].dispose&&t[o].dispose(a);this.animState.trackEntryPool.free(a);break;case i.complete:for(null!=a.listener&&a.listener.complete&&a.listener.complete(a),o=0;o<t.length;o++)t[o].complete&&t[o].complete(a);break;case i.event:var s=e[2+n++];for(null!=a.listener&&a.listener.event&&a.listener.event(a,s),o=0;o<t.length;o++)t[o].event&&t[o].event(a,s)}}this.clear(),this.drainDisabled=!1}},e.prototype.clear=function(){this.objects.length=0},e}();e.EventQueue=r,function(e){e[e.start=0]="start",e[e.interrupt=1]="interrupt",e[e.end=2]="end",e[e.dispose=3]="dispose",e[e.complete=4]="complete",e[e.event=5]="event"}(i=e.EventType||(e.EventType={}));var a=function(){function e(){}return e.prototype.start=function(){},e.prototype.interrupt=function(){},e.prototype.end=function(){},e.prototype.dispose=function(){},e.prototype.complete=function(){},e.prototype.event=function(){},e}();e.AnimationStateAdapter=a}(x6||(x6={})),function(e){var t=function(){function e(e){if(this.animationToMixTime={},this.defaultMix=0,null==e)throw new Error("skeletonData cannot be null.");this.skeletonData=e}return e.prototype.setMix=function(e,t,n){var i=this.skeletonData.findAnimation(e);if(null==i)throw new Error("Animation not found: "+e);var r=this.skeletonData.findAnimation(t);if(null==r)throw new Error("Animation not found: "+t);this.setMixWith(i,r,n)},e.prototype.setMixWith=function(e,t,n){if(null==e)throw new Error("from cannot be null.");if(null==t)throw new Error("to cannot be null.");var i=e.name+"."+t.name;this.animationToMixTime[i]=n},e.prototype.getMix=function(e,t){var n=e.name+"."+t.name,i=this.animationToMixTime[n];return void 0===i?this.defaultMix:i},e}();e.AnimationStateData=t}(x6||(x6={})),function(e){var t=function(){function t(e,t){void 0===t&&(t=""),this.assets={},this.errors={},this.toLoad=0,this.loaded=0,this.textureLoader=e,this.pathPrefix=t}return t.downloadText=function(e,t,n){var i=new XMLHttpRequest;i.open("GET",e,!0),i.onload=function(){200==i.status?t(i.responseText):n(i.status,i.responseText)},i.onerror=function(){n(i.status,i.responseText)},i.send()},t.downloadBinary=function(e,t,n){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){200==i.status?t(new Uint8Array(i.response)):n(i.status,i.responseText)},i.onerror=function(){n(i.status,i.responseText)},i.send()},t.prototype.loadBinary=function(e,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),e=this.pathPrefix+e,this.toLoad++,t.downloadBinary(e,(function(t){r.assets[e]=t,n&&n(e,t),r.toLoad--,r.loaded++}),(function(t,n){r.errors[e]="Couldn't load binary "+e+": status "+status+", "+n,i&&i(e,"Couldn't load binary "+e+": status "+status+", "+n),r.toLoad--,r.loaded++}))},t.prototype.loadText=function(e,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),e=this.pathPrefix+e,this.toLoad++,t.downloadText(e,(function(t){r.assets[e]=t,n&&n(e,t),r.toLoad--,r.loaded++}),(function(t,n){r.errors[e]="Couldn't load text "+e+": status "+status+", "+n,i&&i(e,"Couldn't load text "+e+": status "+status+", "+n),r.toLoad--,r.loaded++}))},t.prototype.loadTexture=function(e,t,n){var i=this;void 0===t&&(t=null),void 0===n&&(n=null),e=this.pathPrefix+e,this.toLoad++;var r=new Image;r.crossOrigin="anonymous",r.onload=function(){var n=i.textureLoader(r);i.assets[e]=n,i.toLoad--,i.loaded++,t&&t(e,r)},r.onerror=function(){i.errors[e]="Couldn't load image "+e,i.toLoad--,i.loaded++,n&&n(e,"Couldn't load image "+e)},r.src=e},t.prototype.loadTextureData=function(e,t,n,i){var r=this;void 0===n&&(n=null),void 0===i&&(i=null),e=this.pathPrefix+e,this.toLoad++;var a=new Image;a.onload=function(){var t=r.textureLoader(a);r.assets[e]=t,r.toLoad--,r.loaded++,n&&n(e,a)},a.onerror=function(){r.errors[e]="Couldn't load image "+e,r.toLoad--,r.loaded++,i&&i(e,"Couldn't load image "+e)},a.src=t},t.prototype.loadTextureAtlas=function(n,i,r){var a=this;void 0===i&&(i=null),void 0===r&&(r=null);var o=n.lastIndexOf("/")>=0?n.substring(0,n.lastIndexOf("/")):"";n=this.pathPrefix+n,this.toLoad++,t.downloadText(n,(function(t){var s={count:0},c=new Array;try{new e.TextureAtlas(t,(function(t){c.push(o+"/"+t);var n=document.createElement("img");return n.width=16,n.height=16,new e.FakeTexture(n)}))}catch(e){var l=e;return a.errors[n]="Couldn't load texture atlas "+n+": "+l.message,r&&r(n,"Couldn't load texture atlas "+n+": "+l.message),a.toLoad--,void a.loaded++}for(var u=function(l){var u=!1;a.loadTexture(l,(function(l){if(s.count++,s.count==c.length)if(u)a.errors[n]="Couldn't load texture atlas page "+l+"} of atlas "+n,r&&r(n,"Couldn't load texture atlas page "+l+" of atlas "+n),a.toLoad--,a.loaded++;else try{var h=new e.TextureAtlas(t,(function(e){return a.get(o+"/"+e)}));a.assets[n]=h,i&&i(n,h),a.toLoad--,a.loaded++}catch(e){var f=e;a.errors[n]="Couldn't load texture atlas "+n+": "+f.message,r&&r(n,"Couldn't load texture atlas "+n+": "+f.message),a.toLoad--,a.loaded++}}),(function(e){u=!0,s.count++,s.count==c.length&&(a.errors[n]="Couldn't load texture atlas page "+e+"} of atlas "+n,r&&r(n,"Couldn't load texture atlas page "+e+" of atlas "+n),a.toLoad--,a.loaded++)}))},h=0,f=c;h<f.length;h++)u(f[h])}),(function(e,t){a.errors[n]="Couldn't load texture atlas "+n+": status "+status+", "+t,r&&r(n,"Couldn't load texture atlas "+n+": status "+status+", "+t),a.toLoad--,a.loaded++}))},t.prototype.get=function(e){return e=this.pathPrefix+e,this.assets[e]},t.prototype.remove=function(e){e=this.pathPrefix+e;var t=this.assets[e];t.dispose&&t.dispose(),this.assets[e]=null},t.prototype.removeAll=function(){for(var e in this.assets){var t=this.assets[e];t.dispose&&t.dispose()}this.assets={}},t.prototype.isLoadingComplete=function(){return 0==this.toLoad},t.prototype.getToLoad=function(){return this.toLoad},t.prototype.getLoaded=function(){return this.loaded},t.prototype.dispose=function(){this.removeAll()},t.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},t.prototype.getErrors=function(){return this.errors},t}();e.AssetManager=t}(x6||(x6={})),function(e){var t=function(){function t(e){this.atlas=e}return t.prototype.newRegionAttachment=function(t,n,i){var r=this.atlas.findRegion(i);if(null==r)return null;r.renderObject=r;var a=new e.RegionAttachment(n);return a.setRegion(r),a},t.prototype.newMeshAttachment=function(t,n,i){var r=this.atlas.findRegion(i);if(null==r)return null;r.renderObject=r;var a=new e.MeshAttachment(n);return a.region=r,a},t.prototype.newBoundingBoxAttachment=function(t,n){return new e.BoundingBoxAttachment(n)},t.prototype.newPathAttachment=function(t,n){return new e.PathAttachment(n)},t.prototype.newPointAttachment=function(t,n){return new e.PointAttachment(n)},t.prototype.newClippingAttachment=function(t,n){return new e.ClippingAttachment(n)},t}();e.AtlasAttachmentLoader=t}(x6||(x6={})),function(e){var t;(t=e.BlendMode||(e.BlendMode={}))[t.Normal=0]="Normal",t[t.Additive=1]="Additive",t[t.Multiply=2]="Multiply",t[t.Screen=3]="Screen"}(x6||(x6={})),function(e){var t=function(){function t(e,t,n){if(this.children=new Array,this.x=0,this.y=0,this.rotation=0,this.scaleX=0,this.scaleY=0,this.shearX=0,this.shearY=0,this.ax=0,this.ay=0,this.arotation=0,this.ascaleX=0,this.ascaleY=0,this.ashearX=0,this.ashearY=0,this.appliedValid=!1,this.a=0,this.b=0,this.c=0,this.d=0,this.worldY=0,this.worldX=0,this.sorted=!1,this.active=!1,null==e)throw new Error("data cannot be null.");if(null==t)throw new Error("skeleton cannot be null.");this.data=e,this.skeleton=t,this.parent=n,this.setToSetupPose()}return t.prototype.isActive=function(){return this.active},t.prototype.update=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},t.prototype.updateWorldTransform=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},t.prototype.updateWorldTransformWith=function(t,n,i,r,a,o,s){this.ax=t,this.ay=n,this.arotation=i,this.ascaleX=r,this.ascaleY=a,this.ashearX=o,this.ashearY=s,this.appliedValid=!0;var c=this.parent;if(null==c){var l=this.skeleton,u=i+90+s,h=l.scaleX,f=l.scaleY;return this.a=e.MathUtils.cosDeg(i+o)*r*h,this.b=e.MathUtils.cosDeg(u)*a*h,this.c=e.MathUtils.sinDeg(i+o)*r*f,this.d=e.MathUtils.sinDeg(u)*a*f,this.worldX=t*h+l.x,void(this.worldY=n*f+l.y)}var _=c.a,d=c.b,p=c.c,m=c.d;switch(this.worldX=_*t+d*n+c.worldX,this.worldY=p*t+m*n+c.worldY,this.data.transformMode){case e.TransformMode.Normal:u=i+90+s;var v=e.MathUtils.cosDeg(i+o)*r,g=e.MathUtils.cosDeg(u)*a,y=e.MathUtils.sinDeg(i+o)*r,S=e.MathUtils.sinDeg(u)*a;return this.a=_*v+d*y,this.b=_*g+d*S,this.c=p*v+m*y,void(this.d=p*g+m*S);case e.TransformMode.OnlyTranslation:u=i+90+s,this.a=e.MathUtils.cosDeg(i+o)*r,this.b=e.MathUtils.cosDeg(u)*a,this.c=e.MathUtils.sinDeg(i+o)*r,this.d=e.MathUtils.sinDeg(u)*a;break;case e.TransformMode.NoRotationOrReflection:var x=0;(C=_*_+p*p)>1e-4?(d=p*(C=Math.abs(_*m-d*p)/C),m=_*C,x=Math.atan2(p,_)*e.MathUtils.radDeg):(_=0,p=0,x=90-Math.atan2(m,d)*e.MathUtils.radDeg);var E=i+o-x,T=i+s-x+90;v=e.MathUtils.cosDeg(E)*r,g=e.MathUtils.cosDeg(T)*a,y=e.MathUtils.sinDeg(E)*r,S=e.MathUtils.sinDeg(T)*a,this.a=_*v-d*y,this.b=_*g-d*S,this.c=p*v+m*y,this.d=p*g+m*S;break;case e.TransformMode.NoScale:case e.TransformMode.NoScaleOrReflection:var C,A=e.MathUtils.cosDeg(i),b=e.MathUtils.sinDeg(i),I=(_*A+d*b)/this.skeleton.scaleX,w=(p*A+m*b)/this.skeleton.scaleY;(C=Math.sqrt(I*I+w*w))>1e-5&&(C=1/C),I*=C,w*=C,C=Math.sqrt(I*I+w*w),this.data.transformMode==e.TransformMode.NoScale&&_*m-d*p<0!=(this.skeleton.scaleX<0!=this.skeleton.scaleY<0)&&(C=-C);var P=Math.PI/2+Math.atan2(w,I),R=Math.cos(P)*C,D=Math.sin(P)*C;v=e.MathUtils.cosDeg(o)*r,g=e.MathUtils.cosDeg(90+s)*a,y=e.MathUtils.sinDeg(o)*r,S=e.MathUtils.sinDeg(90+s)*a,this.a=I*v+R*y,this.b=I*g+R*S,this.c=w*v+D*y,this.d=w*g+D*S}this.a*=this.skeleton.scaleX,this.b*=this.skeleton.scaleX,this.c*=this.skeleton.scaleY,this.d*=this.skeleton.scaleY},t.prototype.setToSetupPose=function(){var e=this.data;this.x=e.x,this.y=e.y,this.rotation=e.rotation,this.scaleX=e.scaleX,this.scaleY=e.scaleY,this.shearX=e.shearX,this.shearY=e.shearY},t.prototype.getWorldRotationX=function(){return Math.atan2(this.c,this.a)*e.MathUtils.radDeg},t.prototype.getWorldRotationY=function(){return Math.atan2(this.d,this.b)*e.MathUtils.radDeg},t.prototype.getWorldScaleX=function(){return Math.sqrt(this.a*this.a+this.c*this.c)},t.prototype.getWorldScaleY=function(){return Math.sqrt(this.b*this.b+this.d*this.d)},t.prototype.updateAppliedTransform=function(){this.appliedValid=!0;var t=this.parent;if(null==t)return this.ax=this.worldX,this.ay=this.worldY,this.arotation=Math.atan2(this.c,this.a)*e.MathUtils.radDeg,this.ascaleX=Math.sqrt(this.a*this.a+this.c*this.c),this.ascaleY=Math.sqrt(this.b*this.b+this.d*this.d),this.ashearX=0,void(this.ashearY=Math.atan2(this.a*this.b+this.c*this.d,this.a*this.d-this.b*this.c)*e.MathUtils.radDeg);var n=t.a,i=t.b,r=t.c,a=t.d,o=1/(n*a-i*r),s=this.worldX-t.worldX,c=this.worldY-t.worldY;this.ax=s*a*o-c*i*o,this.ay=c*n*o-s*r*o;var l=o*a,u=o*n,h=o*i,f=o*r,_=l*this.a-h*this.c,d=l*this.b-h*this.d,p=u*this.c-f*this.a,m=u*this.d-f*this.b;if(this.ashearX=0,this.ascaleX=Math.sqrt(_*_+p*p),this.ascaleX>1e-4){var v=_*m-d*p;this.ascaleY=v/this.ascaleX,this.ashearY=Math.atan2(_*d+p*m,v)*e.MathUtils.radDeg,this.arotation=Math.atan2(p,_)*e.MathUtils.radDeg}else this.ascaleX=0,this.ascaleY=Math.sqrt(d*d+m*m),this.ashearY=0,this.arotation=90-Math.atan2(m,d)*e.MathUtils.radDeg},t.prototype.worldToLocal=function(e){var t=this.a,n=this.b,i=this.c,r=this.d,a=1/(t*r-n*i),o=e.x-this.worldX,s=e.y-this.worldY;return e.x=o*r*a-s*n*a,e.y=s*t*a-o*i*a,e},t.prototype.localToWorld=function(e){var t=e.x,n=e.y;return e.x=t*this.a+n*this.b+this.worldX,e.y=t*this.c+n*this.d+this.worldY,e},t.prototype.worldToLocalRotation=function(t){var n=e.MathUtils.sinDeg(t),i=e.MathUtils.cosDeg(t);return Math.atan2(this.a*n-this.c*i,this.d*i-this.b*n)*e.MathUtils.radDeg+this.rotation-this.shearX},t.prototype.localToWorldRotation=function(t){t-=this.rotation-this.shearX;var n=e.MathUtils.sinDeg(t),i=e.MathUtils.cosDeg(t);return Math.atan2(i*this.c+n*this.d,i*this.a+n*this.b)*e.MathUtils.radDeg},t.prototype.rotateWorld=function(t){var n=this.a,i=this.b,r=this.c,a=this.d,o=e.MathUtils.cosDeg(t),s=e.MathUtils.sinDeg(t);this.a=o*n-s*r,this.b=o*i-s*a,this.c=s*n+o*r,this.d=s*i+o*a,this.appliedValid=!1},t}();e.Bone=t}(x6||(x6={})),function(e){var t;e.BoneData=function(n,i,r){if(this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.shearX=0,this.shearY=0,this.transformMode=t.Normal,this.skinRequired=!1,this.color=new e.Color,n<0)throw new Error("index must be >= 0.");if(null==i)throw new Error("name cannot be null.");this.index=n,this.name=i,this.parent=r},function(e){e[e.Normal=0]="Normal",e[e.OnlyTranslation=1]="OnlyTranslation",e[e.NoRotationOrReflection=2]="NoRotationOrReflection",e[e.NoScale=3]="NoScale",e[e.NoScaleOrReflection=4]="NoScaleOrReflection"}(t=e.TransformMode||(e.TransformMode={}))}(x6||(x6={})),function(e){e.ConstraintData=function(e,t,n){this.name=e,this.order=t,this.skinRequired=n}}(x6||(x6={})),function(e){e.Event=function(e,t){if(null==t)throw new Error("data cannot be null.");this.time=e,this.data=t}}(x6||(x6={})),function(e){e.EventData=function(e){this.name=e}}(x6||(x6={})),function(e){var t=function(){function t(e,t){if(this.bendDirection=0,this.compress=!1,this.stretch=!1,this.mix=1,this.softness=0,this.active=!1,null==e)throw new Error("data cannot be null.");if(null==t)throw new Error("skeleton cannot be null.");this.data=e,this.mix=e.mix,this.softness=e.softness,this.bendDirection=e.bendDirection,this.compress=e.compress,this.stretch=e.stretch,this.bones=new Array;for(var n=0;n<e.bones.length;n++)this.bones.push(t.findBone(e.bones[n].name));this.target=t.findBone(e.target.name)}return t.prototype.isActive=function(){return this.active},t.prototype.apply=function(){this.update()},t.prototype.update=function(){var e=this.target,t=this.bones;switch(t.length){case 1:this.apply1(t[0],e.worldX,e.worldY,this.compress,this.stretch,this.data.uniform,this.mix);break;case 2:this.apply2(t[0],t[1],e.worldX,e.worldY,this.bendDirection,this.stretch,this.softness,this.mix)}},t.prototype.apply1=function(t,n,i,r,a,o,s){t.appliedValid||t.updateAppliedTransform();var c=t.parent,l=1/(c.a*c.d-c.b*c.c),u=n-c.worldX,h=i-c.worldY,f=(u*c.d-h*c.b)*l-t.ax,_=(h*c.a-u*c.c)*l-t.ay,d=Math.atan2(_,f)*e.MathUtils.radDeg-t.ashearX-t.arotation;t.ascaleX<0&&(d+=180),d>180?d-=360:d<-180&&(d+=360);var p=t.ascaleX,m=t.ascaleY;if(r||a){var v=t.data.length*p,g=Math.sqrt(f*f+_*_);if(r&&g<v||a&&g>v&&v>1e-4){var y=(g/v-1)*s+1;p*=y,o&&(m*=y)}}t.updateWorldTransformWith(t.ax,t.ay,t.arotation+d*s,p,m,t.ashearX,t.ashearY)},t.prototype.apply2=function(t,n,i,r,a,o,s,c){if(0!=c){t.appliedValid||t.updateAppliedTransform(),n.appliedValid||n.updateAppliedTransform();var l=t.ax,u=t.ay,h=t.ascaleX,f=h,_=t.ascaleY,d=n.ascaleX,p=0,m=0,v=0;h<0?(h=-h,p=180,v=-1):(p=0,v=1),_<0&&(_=-_,v=-v),d<0?(d=-d,m=180):m=0;var g=n.ax,y=0,S=0,x=0,E=t.a,T=t.b,C=t.c,A=t.d,b=Math.abs(h-_)<=1e-4;b?(S=E*g+T*(y=n.ay)+t.worldX,x=C*g+A*y+t.worldY):(y=0,S=E*g+t.worldX,x=C*g+t.worldY);var I=t.parent;E=I.a,T=I.b,C=I.c;var w,P,R=1/(E*(A=I.d)-T*C),D=S-I.worldX,O=x-I.worldY,N=(D*A-O*T)*R-l,M=(O*E-D*C)*R-u,L=Math.sqrt(N*N+M*M),F=n.data.length*d;if(L<1e-4)return this.apply1(t,i,r,!1,o,!1,c),void n.updateWorldTransformWith(g,y,0,n.ascaleX,n.ascaleY,n.ashearX,n.ashearY);var B=((D=i-I.worldX)*A-(O=r-I.worldY)*T)*R-l,z=(O*E-D*C)*R-u,U=B*B+z*z;if(0!=s){s*=h*(d+1)/2;var k=Math.sqrt(U),G=k-L-F*h+s;if(G>0){var H=Math.min(1,G/(2*s))-1;U=(B-=(H=(G-s*(1-H*H))/k)*B)*B+(z-=H*z)*z}}e:if(b){var V=(U-L*L-(F*=h)*F)/(2*L*F);V<-1?V=-1:V>1&&(V=1,o&&(f*=(Math.sqrt(U)/(L+F)-1)*c+1)),P=Math.acos(V)*a,E=L+F*V,T=F*Math.sin(P),w=Math.atan2(z*E-B*T,B*E+z*T)}else{var W=(E=h*F)*E,j=(T=_*F)*T,X=Math.atan2(z,B),q=-2*j*L,Y=j-W;if((A=q*q-4*Y*(C=j*L*L+W*U-W*j))>=0){var K=Math.sqrt(A);q<0&&(K=-K);var Q=(K=-(q+K)/2)/Y,J=C/K,Z=Math.abs(Q)<Math.abs(J)?Q:J;if(Z*Z<=U){O=Math.sqrt(U-Z*Z)*a,w=X-Math.atan2(O,Z),P=Math.atan2(O/_,(Z-L)/h);break e}}var $=e.MathUtils.PI,ee=L-E,te=ee*ee,ne=0,ie=0,re=L+E,ae=re*re,oe=0;(C=-E*L/(W-j))>=-1&&C<=1&&(C=Math.acos(C),(A=(D=E*Math.cos(C)+L)*D+(O=T*Math.sin(C))*O)<te&&($=C,te=A,ee=D,ne=O),A>ae&&(ie=C,ae=A,re=D,oe=O)),U<=(te+ae)/2?(w=X-Math.atan2(ne*a,ee),P=$*a):(w=X-Math.atan2(oe*a,re),P=ie*a)}var se=Math.atan2(y,g)*v,ce=t.arotation;(w=(w-se)*e.MathUtils.radDeg+p-ce)>180?w-=360:w<-180&&(w+=360),t.updateWorldTransformWith(l,u,ce+w*c,f,t.ascaleY,0,0),ce=n.arotation,(P=((P+se)*e.MathUtils.radDeg-n.ashearX)*v+m-ce)>180?P-=360:P<-180&&(P+=360),n.updateWorldTransformWith(g,y,ce+P*c,n.ascaleX,n.ascaleY,n.ashearX,n.ashearY)}else n.updateWorldTransform()},t}();e.IkConstraint=t}(x6||(x6={})),function(e){var t=function(e){function t(t){var n=e.call(this,t,0,!1)||this;return n.bones=new Array,n.bendDirection=1,n.compress=!1,n.stretch=!1,n.uniform=!1,n.mix=1,n.softness=0,n}return E6(t,e),t}(e.ConstraintData);e.IkConstraintData=t}(x6||(x6={})),function(e){var t=function(){function t(e,t){if(this.position=0,this.spacing=0,this.rotateMix=0,this.translateMix=0,this.spaces=new Array,this.positions=new Array,this.world=new Array,this.curves=new Array,this.lengths=new Array,this.segments=new Array,this.active=!1,null==e)throw new Error("data cannot be null.");if(null==t)throw new Error("skeleton cannot be null.");this.data=e,this.bones=new Array;for(var n=0,i=e.bones.length;n<i;n++)this.bones.push(t.findBone(e.bones[n].name));this.target=t.findSlot(e.target.name),this.position=e.position,this.spacing=e.spacing,this.rotateMix=e.rotateMix,this.translateMix=e.translateMix}return t.prototype.isActive=function(){return this.active},t.prototype.apply=function(){this.update()},t.prototype.update=function(){var n=this.target.getAttachment();if(n instanceof e.PathAttachment){var i=this.rotateMix,r=this.translateMix,a=i>0;if(r>0||a){var o=this.data,s=o.spacingMode==e.SpacingMode.Percent,c=o.rotateMode,l=c==e.RotateMode.Tangent,u=c==e.RotateMode.ChainScale,h=this.bones.length,f=l?h:h+1,_=this.bones,d=e.Utils.setArraySize(this.spaces,f),p=null,m=this.spacing;if(u||!s){u&&(p=e.Utils.setArraySize(this.lengths,h));for(var v=o.spacingMode==e.SpacingMode.Length,g=0,y=f-1;g<y;){var S=(D=_[g]).data.length;if(S<t.epsilon)u&&(p[g]=0),d[++g]=0;else if(s){if(u){var x=S*D.a,E=S*D.c,T=Math.sqrt(x*x+E*E);p[g]=T}d[++g]=m}else{x=S*D.a,E=S*D.c;var C=Math.sqrt(x*x+E*E);u&&(p[g]=C),d[++g]=(v?S+m:m)*C/S}}}else for(g=1;g<f;g++)d[g]=m;var A=this.computeWorldPositions(n,f,l,o.positionMode==e.PositionMode.Percent,s),b=A[0],I=A[1],w=o.offsetRotation,P=!1;0==w?P=c==e.RotateMode.Chain:(P=!1,w*=(R=this.target.bone).a*R.d-R.b*R.c>0?e.MathUtils.degRad:-e.MathUtils.degRad),g=0;for(var R=3;g<h;g++,R+=3){var D;(D=_[g]).worldX+=(b-D.worldX)*r,D.worldY+=(I-D.worldY)*r;var O=(x=A[R])-b,N=(E=A[R+1])-I;if(u){var M=p[g];if(0!=M){var L=(Math.sqrt(O*O+N*N)/M-1)*i+1;D.a*=L,D.c*=L}}if(b=x,I=E,a){var F=D.a,B=D.b,z=D.c,U=D.d,k=0,G=0,H=0;if(k=l?A[R-1]:0==d[g+1]?A[R+2]:Math.atan2(N,O),k-=Math.atan2(z,F),P){G=Math.cos(k),H=Math.sin(k);var V=D.data.length;b+=(V*(G*F-H*z)-O)*i,I+=(V*(H*F+G*z)-N)*i}else k+=w;k>e.MathUtils.PI?k-=e.MathUtils.PI2:k<-e.MathUtils.PI&&(k+=e.MathUtils.PI2),k*=i,G=Math.cos(k),H=Math.sin(k),D.a=G*F-H*z,D.b=G*B-H*U,D.c=H*F+G*z,D.d=H*B+G*U}D.appliedValid=!1}}}},t.prototype.computeWorldPositions=function(n,i,r,a,o){var s=this.target,c=this.position,l=this.spaces,u=e.Utils.setArraySize(this.positions,3*i+2),h=null,f=n.closed,_=n.worldVerticesLength,d=_/6,p=t.NONE;if(!n.constantSpeed){var m=n.lengths,v=m[d-=f?1:2];if(a&&(c*=v),o)for(var g=1;g<i;g++)l[g]*=v;h=e.Utils.setArraySize(this.world,8),g=0;for(var y=0,S=0;g<i;g++,y+=3){var x=c+=j=l[g];if(f)(x%=v)<0&&(x+=v),S=0;else{if(x<0){p!=t.BEFORE&&(p=t.BEFORE,n.computeWorldVertices(s,2,4,h,0,2)),this.addBeforePosition(x,h,0,u,y);continue}if(x>v){p!=t.AFTER&&(p=t.AFTER,n.computeWorldVertices(s,_-6,4,h,0,2)),this.addAfterPosition(x-v,h,0,u,y);continue}}for(;;S++){var E=m[S];if(!(x>E)){0==S?x/=E:x=(x-(K=m[S-1]))/(E-K);break}}S!=p&&(p=S,f&&S==d?(n.computeWorldVertices(s,_-4,4,h,0,2),n.computeWorldVertices(s,0,4,h,4,2)):n.computeWorldVertices(s,6*S+2,8,h,0,2)),this.addCurvePosition(x,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],u,y,r||g>0&&0==j)}return u}f?(_+=2,h=e.Utils.setArraySize(this.world,_),n.computeWorldVertices(s,2,_-4,h,0,2),n.computeWorldVertices(s,0,2,h,_-4,2),h[_-2]=h[0],h[_-1]=h[1]):(d--,_-=4,h=e.Utils.setArraySize(this.world,_),n.computeWorldVertices(s,2,_,h,0,2));for(var T=e.Utils.setArraySize(this.curves,d),C=0,A=h[0],b=h[1],I=0,w=0,P=0,R=0,D=0,O=0,N=0,M=0,L=0,F=0,B=0,z=0,U=0,k=0,G=(g=0,2);g<d;g++,G+=6)I=h[G],w=h[G+1],P=h[G+2],R=h[G+3],B=2*(N=.1875*(A-2*I+P))+(L=.09375*(3*(I-P)-A+(D=h[G+4]))),z=2*(M=.1875*(b-2*w+R))+(F=.09375*(3*(w-R)-b+(O=h[G+5]))),U=.75*(I-A)+N+.16666667*L,k=.75*(w-b)+M+.16666667*F,C+=Math.sqrt(U*U+k*k),U+=B,k+=z,B+=L,z+=F,C+=Math.sqrt(U*U+k*k),U+=B,k+=z,C+=Math.sqrt(U*U+k*k),U+=B+L,k+=z+F,C+=Math.sqrt(U*U+k*k),T[g]=C,A=D,b=O;if(c*=a?C:C/n.lengths[d-1],o)for(g=1;g<i;g++)l[g]*=C;for(var H=this.segments,V=0,W=(g=0,y=0,S=0,0);g<i;g++,y+=3){var j;if(x=c+=j=l[g],f)(x%=C)<0&&(x+=C),S=0;else{if(x<0){this.addBeforePosition(x,h,0,u,y);continue}if(x>C){this.addAfterPosition(x-C,h,_-4,u,y);continue}}for(;;S++){var X=T[S];if(!(x>X)){0==S?x/=X:x=(x-(K=T[S-1]))/(X-K);break}}if(S!=p){p=S;var q=6*S;for(A=h[q],b=h[q+1],I=h[q+2],w=h[q+3],P=h[q+4],R=h[q+5],B=2*(N=.03*(A-2*I+P))+(L=.006*(3*(I-P)-A+(D=h[q+6]))),z=2*(M=.03*(b-2*w+R))+(F=.006*(3*(w-R)-b+(O=h[q+7]))),U=.3*(I-A)+N+.16666667*L,k=.3*(w-b)+M+.16666667*F,V=Math.sqrt(U*U+k*k),H[0]=V,q=1;q<8;q++)U+=B,k+=z,B+=L,z+=F,V+=Math.sqrt(U*U+k*k),H[q]=V;U+=B,k+=z,V+=Math.sqrt(U*U+k*k),H[8]=V,U+=B+L,k+=z+F,V+=Math.sqrt(U*U+k*k),H[9]=V,W=0}for(x*=V;;W++){var Y=H[W];if(!(x>Y)){var K;0==W?x/=Y:x=W+(x-(K=H[W-1]))/(Y-K);break}}this.addCurvePosition(.1*x,A,b,I,w,P,R,D,O,u,y,r||g>0&&0==j)}return u},t.prototype.addBeforePosition=function(e,t,n,i,r){var a=t[n],o=t[n+1],s=t[n+2]-a,c=t[n+3]-o,l=Math.atan2(c,s);i[r]=a+e*Math.cos(l),i[r+1]=o+e*Math.sin(l),i[r+2]=l},t.prototype.addAfterPosition=function(e,t,n,i,r){var a=t[n+2],o=t[n+3],s=a-t[n],c=o-t[n+1],l=Math.atan2(c,s);i[r]=a+e*Math.cos(l),i[r+1]=o+e*Math.sin(l),i[r+2]=l},t.prototype.addCurvePosition=function(e,t,n,i,r,a,o,s,c,l,u,h){if(0==e||isNaN(e))return l[u]=t,l[u+1]=n,void(l[u+2]=Math.atan2(r-n,i-t));var f=e*e,_=f*e,d=1-e,p=d*d,m=p*d,v=d*e,g=3*v,y=d*g,S=g*e,x=t*m+i*y+a*S+s*_,E=n*m+r*y+o*S+c*_;l[u]=x,l[u+1]=E,h&&(l[u+2]=e<.001?Math.atan2(r-n,i-t):Math.atan2(E-(n*p+r*v*2+o*f),x-(t*p+i*v*2+a*f)))},t.NONE=-1,t.BEFORE=-2,t.AFTER=-3,t.epsilon=1e-5,t}();e.PathConstraint=t}(x6||(x6={})),function(e){var t,n,i,r=function(e){function t(t){var n=e.call(this,t,0,!1)||this;return n.bones=new Array,n}return E6(t,e),t}(e.ConstraintData);e.PathConstraintData=r,(i=e.PositionMode||(e.PositionMode={}))[i.Fixed=0]="Fixed",i[i.Percent=1]="Percent",(n=e.SpacingMode||(e.SpacingMode={}))[n.Length=0]="Length",n[n.Fixed=1]="Fixed",n[n.Percent=2]="Percent",(t=e.RotateMode||(e.RotateMode={}))[t.Tangent=0]="Tangent",t[t.Chain=1]="Chain",t[t.ChainScale=2]="ChainScale"}(x6||(x6={})),function(e){var t=function(){function e(e){this.toLoad=new Array,this.assets={},this.clientId=e}return e.prototype.loaded=function(){var e=0;for(var t in this.assets)e++;return e},e}(),n=function(){function e(e){void 0===e&&(e=""),this.clientAssets={},this.queuedAssets={},this.rawAssets={},this.errors={},this.pathPrefix=e}return e.prototype.queueAsset=function(e,n,i){var r=this.clientAssets[e];return null==r&&(r=new t(e),this.clientAssets[e]=r),null!==n&&(r.textureLoader=n),r.toLoad.push(i),this.queuedAssets[i]!==i&&(this.queuedAssets[i]=i,!0)},e.prototype.loadText=function(e,t){var n=this;if(t=this.pathPrefix+t,this.queueAsset(e,null,t)){var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState==XMLHttpRequest.DONE&&(i.status>=200&&i.status<300?n.rawAssets[t]=i.responseText:n.errors[t]="Couldn't load text "+t+": status "+i.status+", "+i.responseText)},i.open("GET",t,!0),i.send()}},e.prototype.loadJson=function(e,t){var n=this;if(t=this.pathPrefix+t,this.queueAsset(e,null,t)){var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState==XMLHttpRequest.DONE&&(i.status>=200&&i.status<300?n.rawAssets[t]=JSON.parse(i.responseText):n.errors[t]="Couldn't load text "+t+": status "+i.status+", "+i.responseText)},i.open("GET",t,!0),i.send()}},e.prototype.loadTexture=function(e,t,n){var i=this;if(n=this.pathPrefix+n,this.queueAsset(e,t,n)){var r=new Image;r.src=n,r.crossOrigin="anonymous",r.onload=function(){i.rawAssets[n]=r},r.onerror=function(){i.errors[n]="Couldn't load image "+n}}},e.prototype.get=function(e,t){t=this.pathPrefix+t;var n=this.clientAssets[e];return null==n||n.assets[t]},e.prototype.updateClientAssets=function(e){for(var t=0;t<e.toLoad.length;t++){var n=e.toLoad[t];if(null==e.assets[n]){var i=this.rawAssets[n];if(null==i)continue;i instanceof HTMLImageElement?e.assets[n]=e.textureLoader(i):e.assets[n]=i}}},e.prototype.isLoadingComplete=function(e){var t=this.clientAssets[e];return null==t||(this.updateClientAssets(t),t.toLoad.length==t.loaded())},e.prototype.dispose=function(){},e.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},e.prototype.getErrors=function(){return this.errors},e}();e.SharedAssetManager=n}(x6||(x6={})),function(e){var t=function(){function t(t){if(this._updateCache=new Array,this.updateCacheReset=new Array,this.time=0,this.scaleX=1,this.scaleY=1,this.x=0,this.y=0,null==t)throw new Error("data cannot be null.");this.data=t,this.bones=new Array;for(var n=0;n<t.bones.length;n++){var i=t.bones[n],r=void 0;if(null==i.parent)r=new e.Bone(i,this,null);else{var a=this.bones[i.parent.index];r=new e.Bone(i,this,a),a.children.push(r)}this.bones.push(r)}for(this.slots=new Array,this.drawOrder=new Array,n=0;n<t.slots.length;n++){var o=t.slots[n],s=(r=this.bones[o.boneData.index],new e.Slot(o,r));this.slots.push(s),this.drawOrder.push(s)}for(this.ikConstraints=new Array,n=0;n<t.ikConstraints.length;n++){var c=t.ikConstraints[n];this.ikConstraints.push(new e.IkConstraint(c,this))}for(this.transformConstraints=new Array,n=0;n<t.transformConstraints.length;n++){var l=t.transformConstraints[n];this.transformConstraints.push(new e.TransformConstraint(l,this))}for(this.pathConstraints=new Array,n=0;n<t.pathConstraints.length;n++){var u=t.pathConstraints[n];this.pathConstraints.push(new e.PathConstraint(u,this))}this.color=new e.Color(1,1,1,1),this.updateCache()}return t.prototype.updateCache=function(){this._updateCache.length=0,this.updateCacheReset.length=0;for(var e=this.bones,t=0,n=e.length;t<n;t++)(r=e[t]).sorted=r.data.skinRequired,r.active=!r.sorted;if(null!=this.skin){var i=this.skin.bones;for(t=0,n=this.skin.bones.length;t<n;t++){var r=this.bones[i[t].index];do{r.sorted=!1,r.active=!0,r=r.parent}while(null!=r)}}var a=this.ikConstraints,o=this.transformConstraints,s=this.pathConstraints,c=a.length,l=o.length,u=s.length,h=c+l+u;e:for(t=0;t<h;t++){for(var f=0;f<c;f++)if((_=a[f]).data.order==t){this.sortIkConstraint(_);continue e}for(f=0;f<l;f++)if((_=o[f]).data.order==t){this.sortTransformConstraint(_);continue e}for(f=0;f<u;f++){var _;if((_=s[f]).data.order==t){this.sortPathConstraint(_);continue e}}}for(t=0,n=e.length;t<n;t++)this.sortBone(e[t])},t.prototype.sortIkConstraint=function(t){if(t.active=t.target.isActive()&&(!t.data.skinRequired||null!=this.skin&&e.Utils.contains(this.skin.constraints,t.data,!0)),t.active){var n=t.target;this.sortBone(n);var i=t.bones,r=i[0];if(this.sortBone(r),i.length>1){var a=i[i.length-1];this._updateCache.indexOf(a)>-1||this.updateCacheReset.push(a)}this._updateCache.push(t),this.sortReset(r.children),i[i.length-1].sorted=!0}},t.prototype.sortPathConstraint=function(t){if(t.active=t.target.bone.isActive()&&(!t.data.skinRequired||null!=this.skin&&e.Utils.contains(this.skin.constraints,t.data,!0)),t.active){var n=t.target,i=n.data.index,r=n.bone;null!=this.skin&&this.sortPathConstraintAttachment(this.skin,i,r),null!=this.data.defaultSkin&&this.data.defaultSkin!=this.skin&&this.sortPathConstraintAttachment(this.data.defaultSkin,i,r);for(var a=0,o=this.data.skins.length;a<o;a++)this.sortPathConstraintAttachment(this.data.skins[a],i,r);var s=n.getAttachment();s instanceof e.PathAttachment&&this.sortPathConstraintAttachmentWith(s,r);var c=t.bones,l=c.length;for(a=0;a<l;a++)this.sortBone(c[a]);for(this._updateCache.push(t),a=0;a<l;a++)this.sortReset(c[a].children);for(a=0;a<l;a++)c[a].sorted=!0}},t.prototype.sortTransformConstraint=function(t){if(t.active=t.target.isActive()&&(!t.data.skinRequired||null!=this.skin&&e.Utils.contains(this.skin.constraints,t.data,!0)),t.active){this.sortBone(t.target);var n=t.bones,i=n.length;if(t.data.local)for(var r=0;r<i;r++){var a=n[r];this.sortBone(a.parent),this._updateCache.indexOf(a)>-1||this.updateCacheReset.push(a)}else for(r=0;r<i;r++)this.sortBone(n[r]);this._updateCache.push(t);for(var o=0;o<i;o++)this.sortReset(n[o].children);for(o=0;o<i;o++)n[o].sorted=!0}},t.prototype.sortPathConstraintAttachment=function(e,t,n){var i=e.attachments[t];if(i)for(var r in i)this.sortPathConstraintAttachmentWith(i[r],n)},t.prototype.sortPathConstraintAttachmentWith=function(t,n){if(t instanceof e.PathAttachment){var i=t.bones;if(null==i)this.sortBone(n);else for(var r=this.bones,a=0;a<i.length;)for(var o=i[a++],s=a+o;a<s;a++){var c=i[a];this.sortBone(r[c])}}},t.prototype.sortBone=function(e){if(!e.sorted){var t=e.parent;null!=t&&this.sortBone(t),e.sorted=!0,this._updateCache.push(e)}},t.prototype.sortReset=function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t];i.active&&(i.sorted&&this.sortReset(i.children),i.sorted=!1)}},t.prototype.updateWorldTransform=function(){for(var e=this.updateCacheReset,t=0,n=e.length;t<n;t++){var i=e[t];i.ax=i.x,i.ay=i.y,i.arotation=i.rotation,i.ascaleX=i.scaleX,i.ascaleY=i.scaleY,i.ashearX=i.shearX,i.ashearY=i.shearY,i.appliedValid=!0}var r=this._updateCache;for(t=0,n=r.length;t<n;t++)r[t].update()},t.prototype.setToSetupPose=function(){this.setBonesToSetupPose(),this.setSlotsToSetupPose()},t.prototype.setBonesToSetupPose=function(){for(var e=this.bones,t=0,n=e.length;t<n;t++)e[t].setToSetupPose();var i=this.ikConstraints;for(t=0,n=i.length;t<n;t++)(s=i[t]).mix=s.data.mix,s.softness=s.data.softness,s.bendDirection=s.data.bendDirection,s.compress=s.data.compress,s.stretch=s.data.stretch;var r=this.transformConstraints;for(t=0,n=r.length;t<n;t++){var a=(s=r[t]).data;s.rotateMix=a.rotateMix,s.translateMix=a.translateMix,s.scaleMix=a.scaleMix,s.shearMix=a.shearMix}var o=this.pathConstraints;for(t=0,n=o.length;t<n;t++){var s;a=(s=o[t]).data,s.position=a.position,s.spacing=a.spacing,s.rotateMix=a.rotateMix,s.translateMix=a.translateMix}},t.prototype.setSlotsToSetupPose=function(){var t=this.slots;e.Utils.arrayCopy(t,0,this.drawOrder,0,t.length);for(var n=0,i=t.length;n<i;n++)t[n].setToSetupPose()},t.prototype.getRootBone=function(){return 0==this.bones.length?null:this.bones[0]},t.prototype.findBone=function(e){if(null==e)throw new Error("boneName cannot be null.");for(var t=this.bones,n=0,i=t.length;n<i;n++){var r=t[n];if(r.data.name==e)return r}return null},t.prototype.findBoneIndex=function(e){if(null==e)throw new Error("boneName cannot be null.");for(var t=this.bones,n=0,i=t.length;n<i;n++)if(t[n].data.name==e)return n;return-1},t.prototype.findSlot=function(e){if(null==e)throw new Error("slotName cannot be null.");for(var t=this.slots,n=0,i=t.length;n<i;n++){var r=t[n];if(r.data.name==e)return r}return null},t.prototype.findSlotIndex=function(e){if(null==e)throw new Error("slotName cannot be null.");for(var t=this.slots,n=0,i=t.length;n<i;n++)if(t[n].data.name==e)return n;return-1},t.prototype.setSkinByName=function(e){var t=this.data.findSkin(e);if(null==t)throw new Error("Skin not found: "+e);this.setSkin(t)},t.prototype.setSkin=function(e){if(e!=this.skin){if(null!=e)if(null!=this.skin)e.attachAll(this,this.skin);else for(var t=this.slots,n=0,i=t.length;n<i;n++){var r=t[n],a=r.data.attachmentName;if(null!=a){var o=e.getAttachment(n,a);null!=o&&r.setAttachment(o)}}this.skin=e,this.updateCache()}},t.prototype.getAttachmentByName=function(e,t){return this.getAttachment(this.data.findSlotIndex(e),t)},t.prototype.getAttachment=function(e,t){if(null==t)throw new Error("attachmentName cannot be null.");if(null!=this.skin){var n=this.skin.getAttachment(e,t);if(null!=n)return n}return null!=this.data.defaultSkin?this.data.defaultSkin.getAttachment(e,t):null},t.prototype.setAttachment=function(e,t){if(null==e)throw new Error("slotName cannot be null.");for(var n=this.slots,i=0,r=n.length;i<r;i++){var a=n[i];if(a.data.name==e){var o=null;if(null!=t&&null==(o=this.getAttachment(i,t)))throw new Error("Attachment not found: "+t+", for slot: "+e);return void a.setAttachment(o)}}throw new Error("Slot not found: "+e)},t.prototype.findIkConstraint=function(e){if(null==e)throw new Error("constraintName cannot be null.");for(var t=this.ikConstraints,n=0,i=t.length;n<i;n++){var r=t[n];if(r.data.name==e)return r}return null},t.prototype.findTransformConstraint=function(e){if(null==e)throw new Error("constraintName cannot be null.");for(var t=this.transformConstraints,n=0,i=t.length;n<i;n++){var r=t[n];if(r.data.name==e)return r}return null},t.prototype.findPathConstraint=function(e){if(null==e)throw new Error("constraintName cannot be null.");for(var t=this.pathConstraints,n=0,i=t.length;n<i;n++){var r=t[n];if(r.data.name==e)return r}return null},t.prototype.getBounds=function(t,n,i){if(void 0===i&&(i=new Array(2)),null==t)throw new Error("offset cannot be null.");if(null==n)throw new Error("size cannot be null.");for(var r=this.drawOrder,a=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=0,u=r.length;l<u;l++){var h=r[l];if(h.bone.active){var f=0,_=null,d=h.getAttachment();if(d instanceof e.RegionAttachment)f=8,_=e.Utils.setArraySize(i,f,0),d.computeWorldVertices(h.bone,_,0,2);else if(d instanceof e.MeshAttachment){var p=d;f=p.worldVerticesLength,_=e.Utils.setArraySize(i,f,0),p.computeWorldVertices(h,0,f,_,0,2)}if(null!=_)for(var m=0,v=_.length;m<v;m+=2){var g=_[m],y=_[m+1];a=Math.min(a,g),o=Math.min(o,y),s=Math.max(s,g),c=Math.max(c,y)}}}t.set(a,o),n.set(s-a,c-o)},t.prototype.update=function(e){this.time+=e},t}();e.Skeleton=t}(x6||(x6={})),function(e){var t=function(){function t(e){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=e}return t.prototype.readSkeletonData=function(i){var r=this.scale,a=new e.SkeletonData;a.name="";var o=new n(i);a.hash=o.readString(),a.version=o.readString(),a.x=o.readFloat(),a.y=o.readFloat(),a.width=o.readFloat(),a.height=o.readFloat();var s=o.readBoolean();s&&(a.fps=o.readFloat(),a.imagesPath=o.readString(),a.audioPath=o.readString());var c=0;c=o.readInt(!0);for(var l=0;l<c;l++)o.strings.push(o.readString());for(c=o.readInt(!0),l=0;l<c;l++){var u=o.readString(),h=0==l?null:a.bones[o.readInt(!0)];(d=new e.BoneData(l,u,h)).rotation=o.readFloat(),d.x=o.readFloat()*r,d.y=o.readFloat()*r,d.scaleX=o.readFloat(),d.scaleY=o.readFloat(),d.shearX=o.readFloat(),d.shearY=o.readFloat(),d.length=o.readFloat()*r,d.transformMode=t.TransformModeValues[o.readInt(!0)],d.skinRequired=o.readBoolean(),s&&e.Color.rgba8888ToColor(d.color,o.readInt32()),a.bones.push(d)}for(c=o.readInt(!0),l=0;l<c;l++){var f=o.readString(),_=a.bones[o.readInt(!0)],d=new e.SlotData(l,f,_);e.Color.rgba8888ToColor(d.color,o.readInt32());var p=o.readInt32();-1!=p&&e.Color.rgb888ToColor(d.darkColor=new e.Color,p),d.attachmentName=o.readStringRef(),d.blendMode=t.BlendModeValues[o.readInt(!0)],a.slots.push(d)}c=o.readInt(!0),l=0;for(var m=void 0;l<c;l++){(d=new e.IkConstraintData(o.readString())).order=o.readInt(!0),d.skinRequired=o.readBoolean(),m=o.readInt(!0);for(var v=0;v<m;v++)d.bones.push(a.bones[o.readInt(!0)]);d.target=a.bones[o.readInt(!0)],d.mix=o.readFloat(),d.softness=o.readFloat()*r,d.bendDirection=o.readByte(),d.compress=o.readBoolean(),d.stretch=o.readBoolean(),d.uniform=o.readBoolean(),a.ikConstraints.push(d)}for(c=o.readInt(!0),l=0,m=void 0;l<c;l++){for((d=new e.TransformConstraintData(o.readString())).order=o.readInt(!0),d.skinRequired=o.readBoolean(),m=o.readInt(!0),v=0;v<m;v++)d.bones.push(a.bones[o.readInt(!0)]);d.target=a.bones[o.readInt(!0)],d.local=o.readBoolean(),d.relative=o.readBoolean(),d.offsetRotation=o.readFloat(),d.offsetX=o.readFloat()*r,d.offsetY=o.readFloat()*r,d.offsetScaleX=o.readFloat(),d.offsetScaleY=o.readFloat(),d.offsetShearY=o.readFloat(),d.rotateMix=o.readFloat(),d.translateMix=o.readFloat(),d.scaleMix=o.readFloat(),d.shearMix=o.readFloat(),a.transformConstraints.push(d)}for(c=o.readInt(!0),l=0,m=void 0;l<c;l++){for((d=new e.PathConstraintData(o.readString())).order=o.readInt(!0),d.skinRequired=o.readBoolean(),m=o.readInt(!0),v=0;v<m;v++)d.bones.push(a.bones[o.readInt(!0)]);d.target=a.slots[o.readInt(!0)],d.positionMode=t.PositionModeValues[o.readInt(!0)],d.spacingMode=t.SpacingModeValues[o.readInt(!0)],d.rotateMode=t.RotateModeValues[o.readInt(!0)],d.offsetRotation=o.readFloat(),d.position=o.readFloat(),d.positionMode==e.PositionMode.Fixed&&(d.position*=r),d.spacing=o.readFloat(),d.spacingMode!=e.SpacingMode.Length&&d.spacingMode!=e.SpacingMode.Fixed||(d.spacing*=r),d.rotateMix=o.readFloat(),d.translateMix=o.readFloat(),a.pathConstraints.push(d)}var g=this.readSkin(o,a,!0,s);for(null!=g&&(a.defaultSkin=g,a.skins.push(g)),l=a.skins.length,e.Utils.setArraySize(a.skins,c=l+o.readInt(!0));l<c;l++)a.skins[l]=this.readSkin(o,a,!1,s);for(c=this.linkedMeshes.length,l=0;l<c;l++){var y=this.linkedMeshes[l],S=null==y.skin?a.defaultSkin:a.findSkin(y.skin);if(null==S)throw new Error("Skin not found: "+y.skin);var x=S.getAttachment(y.slotIndex,y.parent);if(null==x)throw new Error("Parent mesh not found: "+y.parent);y.mesh.deformAttachment=y.inheritDeform?x:y.mesh,y.mesh.setParentMesh(x),y.mesh.updateUVs()}for(this.linkedMeshes.length=0,c=o.readInt(!0),l=0;l<c;l++)(d=new e.EventData(o.readStringRef())).intValue=o.readInt(!1),d.floatValue=o.readFloat(),d.stringValue=o.readString(),d.audioPath=o.readString(),null!=d.audioPath&&(d.volume=o.readFloat(),d.balance=o.readFloat()),a.events.push(d);for(c=o.readInt(!0),l=0;l<c;l++)a.animations.push(this.readAnimation(o,o.readString(),a));return a},t.prototype.readSkin=function(t,n,i,r){var a=null,o=0;if(i){if(0==(o=t.readInt(!0)))return null;a=new e.Skin("default")}else{(a=new e.Skin(t.readStringRef())).bones.length=t.readInt(!0);for(var s=0,c=a.bones.length;s<c;s++)a.bones[s]=n.bones[t.readInt(!0)];for(s=0,c=t.readInt(!0);s<c;s++)a.constraints.push(n.ikConstraints[t.readInt(!0)]);for(s=0,c=t.readInt(!0);s<c;s++)a.constraints.push(n.transformConstraints[t.readInt(!0)]);for(s=0,c=t.readInt(!0);s<c;s++)a.constraints.push(n.pathConstraints[t.readInt(!0)]);o=t.readInt(!0)}for(s=0;s<o;s++)for(var l=t.readInt(!0),u=0,h=t.readInt(!0);u<h;u++){var f=t.readStringRef(),_=this.readAttachment(t,n,a,l,f,r);null!=_&&a.setAttachment(l,f,_)}return a},t.prototype.readAttachment=function(n,r,a,o,s,c){var l=this.scale,u=n.readStringRef();null==u&&(u=s);var h=n.readByte();switch(t.AttachmentTypeValues[h]){case e.AttachmentType.Region:var f=n.readStringRef(),_=n.readFloat(),d=n.readFloat(),p=n.readFloat(),m=n.readFloat(),v=n.readFloat(),g=n.readFloat(),y=n.readFloat(),S=n.readInt32();null==f&&(f=u);var x=this.attachmentLoader.newRegionAttachment(a,u,f);return null==x?null:(x.path=f,x.x=d*l,x.y=p*l,x.scaleX=m,x.scaleY=v,x.rotation=_,x.width=g*l,x.height=y*l,e.Color.rgba8888ToColor(x.color,S),x.updateOffset(),x);case e.AttachmentType.BoundingBox:var E=n.readInt(!0),T=this.readVertices(n,E),C=(S=c?n.readInt32():0,this.attachmentLoader.newBoundingBoxAttachment(a,u));return null==C?null:(C.worldVerticesLength=E<<1,C.vertices=T.vertices,C.bones=T.bones,c&&e.Color.rgba8888ToColor(C.color,S),C);case e.AttachmentType.Mesh:f=n.readStringRef(),S=n.readInt32(),E=n.readInt(!0);var A=this.readFloatArray(n,E<<1,1),b=this.readShortArray(n),I=(T=this.readVertices(n,E),n.readInt(!0)),w=null;return g=0,y=0,c&&(w=this.readShortArray(n),g=n.readFloat(),y=n.readFloat()),null==f&&(f=u),null==(P=this.attachmentLoader.newMeshAttachment(a,u,f))?null:(P.path=f,e.Color.rgba8888ToColor(P.color,S),P.bones=T.bones,P.vertices=T.vertices,P.worldVerticesLength=E<<1,P.triangles=b,P.regionUVs=A,P.updateUVs(),P.hullLength=I<<1,c&&(P.edges=w,P.width=g*l,P.height=y*l),P);case e.AttachmentType.LinkedMesh:f=n.readStringRef(),S=n.readInt32();var P,R=n.readStringRef(),D=n.readStringRef(),O=n.readBoolean();return g=0,y=0,c&&(g=n.readFloat(),y=n.readFloat()),null==f&&(f=u),null==(P=this.attachmentLoader.newMeshAttachment(a,u,f))?null:(P.path=f,e.Color.rgba8888ToColor(P.color,S),c&&(P.width=g*l,P.height=y*l),this.linkedMeshes.push(new i(P,R,o,D,O)),P);case e.AttachmentType.Path:for(var N=n.readBoolean(),M=n.readBoolean(),L=(E=n.readInt(!0),T=this.readVertices(n,E),e.Utils.newArray(E/3,0)),F=0,B=L.length;F<B;F++)L[F]=n.readFloat()*l;return S=c?n.readInt32():0,null==(f=this.attachmentLoader.newPathAttachment(a,u))?null:(f.closed=N,f.constantSpeed=M,f.worldVerticesLength=E<<1,f.vertices=T.vertices,f.bones=T.bones,f.lengths=L,c&&e.Color.rgba8888ToColor(f.color,S),f);case e.AttachmentType.Point:_=n.readFloat(),d=n.readFloat(),p=n.readFloat(),S=c?n.readInt32():0;var z=this.attachmentLoader.newPointAttachment(a,u);return null==z?null:(z.x=d*l,z.y=p*l,z.rotation=_,c&&e.Color.rgba8888ToColor(z.color,S),z);case e.AttachmentType.Clipping:var U=n.readInt(!0),k=(E=n.readInt(!0),T=this.readVertices(n,E),S=c?n.readInt32():0,this.attachmentLoader.newClippingAttachment(a,u));return null==k?null:(k.endSlot=r.slots[U],k.worldVerticesLength=E<<1,k.vertices=T.vertices,k.bones=T.bones,c&&e.Color.rgba8888ToColor(k.color,S),k)}return null},t.prototype.readVertices=function(t,n){var i=n<<1,a=new r,o=this.scale;if(!t.readBoolean())return a.vertices=this.readFloatArray(t,i,o),a;for(var s=new Array,c=new Array,l=0;l<n;l++){var u=t.readInt(!0);c.push(u);for(var h=0;h<u;h++)c.push(t.readInt(!0)),s.push(t.readFloat()*o),s.push(t.readFloat()*o),s.push(t.readFloat())}return a.vertices=e.Utils.toFloatArray(s),a.bones=c,a},t.prototype.readFloatArray=function(e,t,n){var i=new Array(t);if(1==n)for(var r=0;r<t;r++)i[r]=e.readFloat();else for(r=0;r<t;r++)i[r]=e.readFloat()*n;return i},t.prototype.readShortArray=function(e){for(var t=e.readInt(!0),n=new Array(t),i=0;i<t;i++)n[i]=e.readShort();return n},t.prototype.readAnimation=function(n,i,r){for(var a=new Array,o=this.scale,s=0,c=new e.Color,l=new e.Color,u=0,h=n.readInt(!0);u<h;u++)for(var f=n.readInt(!0),_=0,d=n.readInt(!0);_<d;_++){var p=n.readByte(),m=n.readInt(!0);switch(p){case t.SLOT_ATTACHMENT:(S=new e.AttachmentTimeline(m)).slotIndex=f;for(var v=0;v<m;v++)S.setFrame(v,n.readFloat(),n.readStringRef());a.push(S),s=Math.max(s,S.frames[m-1]);break;case t.SLOT_COLOR:for((S=new e.ColorTimeline(m)).slotIndex=f,v=0;v<m;v++){var g=n.readFloat();e.Color.rgba8888ToColor(c,n.readInt32()),S.setFrame(v,g,c.r,c.g,c.b,c.a),v<m-1&&this.readCurve(n,v,S)}a.push(S),s=Math.max(s,S.frames[(m-1)*e.ColorTimeline.ENTRIES]);break;case t.SLOT_TWO_COLOR:for((S=new e.TwoColorTimeline(m)).slotIndex=f,v=0;v<m;v++)g=n.readFloat(),e.Color.rgba8888ToColor(c,n.readInt32()),e.Color.rgb888ToColor(l,n.readInt32()),S.setFrame(v,g,c.r,c.g,c.b,c.a,l.r,l.g,l.b),v<m-1&&this.readCurve(n,v,S);a.push(S),s=Math.max(s,S.frames[(m-1)*e.TwoColorTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var y=n.readInt(!0);for(_=0,d=n.readInt(!0);_<d;_++)switch(p=n.readByte(),m=n.readInt(!0),p){case t.BONE_ROTATE:for((S=new e.RotateTimeline(m)).boneIndex=y,v=0;v<m;v++)S.setFrame(v,n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,S);a.push(S),s=Math.max(s,S.frames[(m-1)*e.RotateTimeline.ENTRIES]);break;case t.BONE_TRANSLATE:case t.BONE_SCALE:case t.BONE_SHEAR:var S=void 0,x=1;for(p==t.BONE_SCALE?S=new e.ScaleTimeline(m):p==t.BONE_SHEAR?S=new e.ShearTimeline(m):(S=new e.TranslateTimeline(m),x=o),S.boneIndex=y,v=0;v<m;v++)S.setFrame(v,n.readFloat(),n.readFloat()*x,n.readFloat()*x),v<m-1&&this.readCurve(n,v,S);a.push(S),s=Math.max(s,S.frames[(m-1)*e.TranslateTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var E=n.readInt(!0);for(m=n.readInt(!0),(S=new e.IkConstraintTimeline(m)).ikConstraintIndex=E,v=0;v<m;v++)S.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat()*o,n.readByte(),n.readBoolean(),n.readBoolean()),v<m-1&&this.readCurve(n,v,S);a.push(S),s=Math.max(s,S.frames[(m-1)*e.IkConstraintTimeline.ENTRIES])}for(u=0,h=n.readInt(!0);u<h;u++){for(E=n.readInt(!0),m=n.readInt(!0),(S=new e.TransformConstraintTimeline(m)).transformConstraintIndex=E,v=0;v<m;v++)S.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,S);a.push(S),s=Math.max(s,S.frames[(m-1)*e.TransformConstraintTimeline.ENTRIES])}for(u=0,h=n.readInt(!0);u<h;u++){E=n.readInt(!0);var T=r.pathConstraints[E];for(_=0,d=n.readInt(!0);_<d;_++)switch(p=n.readByte(),m=n.readInt(!0),p){case t.PATH_POSITION:case t.PATH_SPACING:for(S=void 0,x=1,p==t.PATH_SPACING?(S=new e.PathConstraintSpacingTimeline(m),T.spacingMode!=e.SpacingMode.Length&&T.spacingMode!=e.SpacingMode.Fixed||(x=o)):(S=new e.PathConstraintPositionTimeline(m),T.positionMode==e.PositionMode.Fixed&&(x=o)),S.pathConstraintIndex=E,v=0;v<m;v++)S.setFrame(v,n.readFloat(),n.readFloat()*x),v<m-1&&this.readCurve(n,v,S);a.push(S),s=Math.max(s,S.frames[(m-1)*e.PathConstraintPositionTimeline.ENTRIES]);break;case t.PATH_MIX:for((S=new e.PathConstraintMixTimeline(m)).pathConstraintIndex=E,v=0;v<m;v++)S.setFrame(v,n.readFloat(),n.readFloat(),n.readFloat()),v<m-1&&this.readCurve(n,v,S);a.push(S),s=Math.max(s,S.frames[(m-1)*e.PathConstraintMixTimeline.ENTRIES])}}for(u=0,h=n.readInt(!0);u<h;u++){var C=r.skins[n.readInt(!0)];for(_=0,d=n.readInt(!0);_<d;_++){f=n.readInt(!0);for(var A=0,b=n.readInt(!0);A<b;A++){var I=C.getAttachment(f,n.readStringRef()),w=null!=I.bones,P=I.vertices,R=w?P.length/3*2:P.length;for(m=n.readInt(!0),(S=new e.DeformTimeline(m)).slotIndex=f,S.attachment=I,v=0;v<m;v++){g=n.readFloat();var D=void 0,O=n.readInt(!0);if(0==O)D=w?e.Utils.newFloatArray(R):P;else{D=e.Utils.newFloatArray(R);var N=n.readInt(!0);if(O+=N,1==o)for(var M=N;M<O;M++)D[M]=n.readFloat();else for(M=N;M<O;M++)D[M]=n.readFloat()*o;if(!w){M=0;for(var L=D.length;M<L;M++)D[M]+=P[M]}}S.setFrame(v,g,D),v<m-1&&this.readCurve(n,v,S)}a.push(S),s=Math.max(s,S.frames[m-1])}}}var F=n.readInt(!0);if(F>0){S=new e.DrawOrderTimeline(F);var B=r.slots.length;for(u=0;u<F;u++){g=n.readFloat();var z=n.readInt(!0),U=e.Utils.newArray(B,0);for(_=B-1;_>=0;_--)U[_]=-1;var k=e.Utils.newArray(B-z,0),G=0,H=0;for(_=0;_<z;_++){for(f=n.readInt(!0);G!=f;)k[H++]=G++;U[G+n.readInt(!0)]=G++}for(;G<B;)k[H++]=G++;for(_=B-1;_>=0;_--)-1==U[_]&&(U[_]=k[--H]);S.setFrame(u,g,U)}a.push(S),s=Math.max(s,S.frames[F-1])}var V=n.readInt(!0);if(V>0){for(S=new e.EventTimeline(V),u=0;u<V;u++){g=n.readFloat();var W=r.events[n.readInt(!0)],j=new e.Event(g,W);j.intValue=n.readInt(!1),j.floatValue=n.readFloat(),j.stringValue=n.readBoolean()?n.readString():W.stringValue,null!=j.data.audioPath&&(j.volume=n.readFloat(),j.balance=n.readFloat()),S.setFrame(u,j)}a.push(S),s=Math.max(s,S.frames[V-1])}return new e.Animation(i,a,s)},t.prototype.readCurve=function(e,n,i){switch(e.readByte()){case t.CURVE_STEPPED:i.setStepped(n);break;case t.CURVE_BEZIER:this.setCurve(i,n,e.readFloat(),e.readFloat(),e.readFloat(),e.readFloat())}},t.prototype.setCurve=function(e,t,n,i,r,a){e.setCurve(t,n,i,r,a)},t.AttachmentTypeValues=[0,1,2,3,4,5,6],t.TransformModeValues=[e.TransformMode.Normal,e.TransformMode.OnlyTranslation,e.TransformMode.NoRotationOrReflection,e.TransformMode.NoScale,e.TransformMode.NoScaleOrReflection],t.PositionModeValues=[e.PositionMode.Fixed,e.PositionMode.Percent],t.SpacingModeValues=[e.SpacingMode.Length,e.SpacingMode.Fixed,e.SpacingMode.Percent],t.RotateModeValues=[e.RotateMode.Tangent,e.RotateMode.Chain,e.RotateMode.ChainScale],t.BlendModeValues=[e.BlendMode.Normal,e.BlendMode.Additive,e.BlendMode.Multiply,e.BlendMode.Screen],t.BONE_ROTATE=0,t.BONE_TRANSLATE=1,t.BONE_SCALE=2,t.BONE_SHEAR=3,t.SLOT_ATTACHMENT=0,t.SLOT_COLOR=1,t.SLOT_TWO_COLOR=2,t.PATH_POSITION=0,t.PATH_SPACING=1,t.PATH_MIX=2,t.CURVE_LINEAR=0,t.CURVE_STEPPED=1,t.CURVE_BEZIER=2,t}();e.SkeletonBinary=t;var n=function(){function e(e,t,n,i){void 0===t&&(t=new Array),void 0===n&&(n=0),void 0===i&&(i=new DataView(e.buffer)),this.strings=t,this.index=n,this.buffer=i}return e.prototype.readByte=function(){return this.buffer.getInt8(this.index++)},e.prototype.readShort=function(){var e=this.buffer.getInt16(this.index);return this.index+=2,e},e.prototype.readInt32=function(){var e=this.buffer.getInt32(this.index);return this.index+=4,e},e.prototype.readInt=function(e){var t=this.readByte(),n=127&t;return 0!=(128&t)&&(n|=(127&(t=this.readByte()))<<7,0!=(128&t)&&(n|=(127&(t=this.readByte()))<<14,0!=(128&t)&&(n|=(127&(t=this.readByte()))<<21,0!=(128&t)&&(n|=(127&(t=this.readByte()))<<28)))),e?n:n>>>1^-(1&n)},e.prototype.readStringRef=function(){var e=this.readInt(!0);return 0==e?null:this.strings[e-1]},e.prototype.readString=function(){var e=this.readInt(!0);switch(e){case 0:return null;case 1:return""}e--;for(var t="",n=0;n<e;){var i=this.readByte();switch(i>>4){case 12:case 13:t+=String.fromCharCode((31&i)<<6|63&this.readByte()),n+=2;break;case 14:t+=String.fromCharCode((15&i)<<12|(63&this.readByte())<<6|63&this.readByte()),n+=3;break;default:t+=String.fromCharCode(i),n++}}return t},e.prototype.readFloat=function(){var e=this.buffer.getFloat32(this.index);return this.index+=4,e},e.prototype.readBoolean=function(){return 0!=this.readByte()},e}(),i=function(e,t,n,i,r){this.mesh=e,this.skin=t,this.slotIndex=n,this.parent=i,this.inheritDeform=r},r=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.bones=e,this.vertices=t}}(x6||(x6={})),function(e){var t=function(){function t(){this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.boundingBoxes=new Array,this.polygons=new Array,this.polygonPool=new e.Pool((function(){return e.Utils.newFloatArray(16)}))}return t.prototype.update=function(t,n){if(null==t)throw new Error("skeleton cannot be null.");var i=this.boundingBoxes,r=this.polygons,a=this.polygonPool,o=t.slots,s=o.length;i.length=0,a.freeAll(r),r.length=0;for(var c=0;c<s;c++){var l=o[c];if(l.bone.active){var u=l.getAttachment();if(u instanceof e.BoundingBoxAttachment){var h=u;i.push(h);var f=a.obtain();f.length!=h.worldVerticesLength&&(f=e.Utils.newFloatArray(h.worldVerticesLength)),r.push(f),h.computeWorldVertices(l,0,h.worldVerticesLength,f,0,2)}}}n?this.aabbCompute():(this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY)},t.prototype.aabbCompute=function(){for(var e=Number.POSITIVE_INFINITY,t=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,r=this.polygons,a=0,o=r.length;a<o;a++)for(var s=r[a],c=s,l=0,u=s.length;l<u;l+=2){var h=c[l],f=c[l+1];e=Math.min(e,h),t=Math.min(t,f),n=Math.max(n,h),i=Math.max(i,f)}this.minX=e,this.minY=t,this.maxX=n,this.maxY=i},t.prototype.aabbContainsPoint=function(e,t){return e>=this.minX&&e<=this.maxX&&t>=this.minY&&t<=this.maxY},t.prototype.aabbIntersectsSegment=function(e,t,n,i){var r=this.minX,a=this.minY,o=this.maxX,s=this.maxY;if(e<=r&&n<=r||t<=a&&i<=a||e>=o&&n>=o||t>=s&&i>=s)return!1;var c=(i-t)/(n-e),l=c*(r-e)+t;if(l>a&&l<s)return!0;if((l=c*(o-e)+t)>a&&l<s)return!0;var u=(a-t)/c+e;return u>r&&u<o||(u=(s-t)/c+e)>r&&u<o},t.prototype.aabbIntersectsSkeleton=function(e){return this.minX<e.maxX&&this.maxX>e.minX&&this.minY<e.maxY&&this.maxY>e.minY},t.prototype.containsPoint=function(e,t){for(var n=this.polygons,i=0,r=n.length;i<r;i++)if(this.containsPointPolygon(n[i],e,t))return this.boundingBoxes[i];return null},t.prototype.containsPointPolygon=function(e,t,n){for(var i=e,r=e.length,a=r-2,o=!1,s=0;s<r;s+=2){var c=i[s+1],l=i[a+1];if(c<n&&l>=n||l<n&&c>=n){var u=i[s];u+(n-c)/(l-c)*(i[a]-u)<t&&(o=!o)}a=s}return o},t.prototype.intersectsSegment=function(e,t,n,i){for(var r=this.polygons,a=0,o=r.length;a<o;a++)if(this.intersectsSegmentPolygon(r[a],e,t,n,i))return this.boundingBoxes[a];return null},t.prototype.intersectsSegmentPolygon=function(e,t,n,i,r){for(var a=e,o=e.length,s=t-i,c=n-r,l=t*r-n*i,u=a[o-2],h=a[o-1],f=0;f<o;f+=2){var _=a[f],d=a[f+1],p=u*d-h*_,m=u-_,v=h-d,g=s*v-c*m,y=(l*m-s*p)/g;if((y>=u&&y<=_||y>=_&&y<=u)&&(y>=t&&y<=i||y>=i&&y<=t)){var S=(l*v-c*p)/g;if((S>=h&&S<=d||S>=d&&S<=h)&&(S>=n&&S<=r||S>=r&&S<=n))return!0}u=_,h=d}return!1},t.prototype.getPolygon=function(e){if(null==e)throw new Error("boundingBox cannot be null.");var t=this.boundingBoxes.indexOf(e);return-1==t?null:this.polygons[t]},t.prototype.getWidth=function(){return this.maxX-this.minX},t.prototype.getHeight=function(){return this.maxY-this.minY},t}();e.SkeletonBounds=t}(x6||(x6={})),function(e){var t=function(){function t(){this.triangulator=new e.Triangulator,this.clippingPolygon=new Array,this.clipOutput=new Array,this.clippedVertices=new Array,this.clippedTriangles=new Array,this.scratch=new Array}return t.prototype.clipStart=function(n,i){if(null!=this.clipAttachment)return 0;this.clipAttachment=i;var r=i.worldVerticesLength,a=e.Utils.setArraySize(this.clippingPolygon,r);i.computeWorldVertices(n,0,r,a,0,2);var o=this.clippingPolygon;t.makeClockwise(o);for(var s=this.clippingPolygons=this.triangulator.decompose(o,this.triangulator.triangulate(o)),c=0,l=s.length;c<l;c++){var u=s[c];t.makeClockwise(u),u.push(u[0]),u.push(u[1])}return s.length},t.prototype.clipEndWithSlot=function(e){null!=this.clipAttachment&&this.clipAttachment.endSlot==e.data&&this.clipEnd()},t.prototype.clipEnd=function(){null!=this.clipAttachment&&(this.clipAttachment=null,this.clippingPolygons=null,this.clippedVertices.length=0,this.clippedTriangles.length=0,this.clippingPolygon.length=0)},t.prototype.isClipping=function(){return null!=this.clipAttachment},t.prototype.clipTriangles=function(t,n,i,r,a,o,s,c,l,u,h){void 0===l&&(l=2),void 0===u&&(u=0),void 0===h&&(h=0);var f=this.clipOutput,_=this.clippedVertices,d=this.clippedTriangles,p=this.clippingPolygons,m=this.clippingPolygons.length,v=c?12:8,g=0;_.length=0,d.length=0;e:for(var y=0;y<r;y+=3)for(var S=i[y]*l,x=t[S+u],E=t[S+u+1],T=a[S+h],C=a[S+h+1],A=t[(S=i[y+1]*l)+u],b=t[S+u+1],I=a[S+h],w=a[S+h+1],P=t[(S=i[y+2]*l)+u],R=t[S+u+1],D=a[S+h],O=a[S+h+1],N=0;N<m;N++){var M=_.length;if(!this.clip(x,E,A,b,P,R,p[N],f)){(V=e.Utils.setArraySize(_,M+3*v))[M]=x,V[M+1]=E,V[M+2]=o.r,V[M+3]=o.g,V[M+4]=o.b,V[M+5]=o.a,c?(V[M+6]=T,V[M+7]=C,V[M+8]=s.r,V[M+9]=s.g,V[M+10]=s.b,V[M+11]=s.a,V[M+12]=A,V[M+13]=b,V[M+14]=o.r,V[M+15]=o.g,V[M+16]=o.b,V[M+17]=o.a,V[M+18]=I,V[M+19]=w,V[M+20]=s.r,V[M+21]=s.g,V[M+22]=s.b,V[M+23]=s.a,V[M+24]=P,V[M+25]=R,V[M+26]=o.r,V[M+27]=o.g,V[M+28]=o.b,V[M+29]=o.a,V[M+30]=D,V[M+31]=O,V[M+32]=s.r,V[M+33]=s.g,V[M+34]=s.b,V[M+35]=s.a):(V[M+6]=T,V[M+7]=C,V[M+8]=A,V[M+9]=b,V[M+10]=o.r,V[M+11]=o.g,V[M+12]=o.b,V[M+13]=o.a,V[M+14]=I,V[M+15]=w,V[M+16]=P,V[M+17]=R,V[M+18]=o.r,V[M+19]=o.g,V[M+20]=o.b,V[M+21]=o.a,V[M+22]=D,V[M+23]=O),M=d.length,(Z=e.Utils.setArraySize(d,M+3))[M]=g,Z[M+1]=g+1,Z[M+2]=g+2,g+=3;continue e}var L=f.length;if(0!=L){for(var F=b-R,B=P-A,z=x-P,U=R-E,k=1/(F*z+B*(E-R)),G=L>>1,H=this.clipOutput,V=e.Utils.setArraySize(_,M+G*v),W=0;W<L;W+=2){var j=H[W],X=H[W+1];V[M]=j,V[M+1]=X,V[M+2]=o.r,V[M+3]=o.g,V[M+4]=o.b,V[M+5]=o.a;var q=j-P,Y=X-R,K=(F*q+B*Y)*k,Q=(U*q+z*Y)*k,J=1-K-Q;V[M+6]=T*K+I*Q+D*J,V[M+7]=C*K+w*Q+O*J,c&&(V[M+8]=s.r,V[M+9]=s.g,V[M+10]=s.b,V[M+11]=s.a),M+=v}M=d.length;var Z=e.Utils.setArraySize(d,M+3*(G-2));for(G--,W=1;W<G;W++)Z[M]=g,Z[M+1]=g+W,Z[M+2]=g+W+1,M+=3;g+=G+1}}},t.prototype.clip=function(e,t,n,i,r,a,o,s){var c=s,l=!1,u=null;o.length%4>=2?(u=s,s=this.scratch):u=this.scratch,u.length=0,u.push(e),u.push(t),u.push(n),u.push(i),u.push(r),u.push(a),u.push(e),u.push(t),s.length=0;for(var h=o,f=o.length-4,_=0;;_+=2){for(var d=h[_],p=h[_+1],m=h[_+2],v=h[_+3],g=d-m,y=p-v,S=u,x=u.length-2,E=s.length,T=0;T<x;T+=2){var C=S[T],A=S[T+1],b=S[T+2],I=S[T+3],w=g*(I-v)-y*(b-m)>0;if(g*(A-v)-y*(C-m)>0){if(w){s.push(b),s.push(I);continue}var P=(D=I-A)*(m-d)-(O=b-C)*(v-p);if(Math.abs(P)>1e-6){var R=(O*(p-A)-D*(d-C))/P;s.push(d+(m-d)*R),s.push(p+(v-p)*R)}else s.push(d),s.push(p)}else if(w){var D,O;P=(D=I-A)*(m-d)-(O=b-C)*(v-p),Math.abs(P)>1e-6?(R=(O*(p-A)-D*(d-C))/P,s.push(d+(m-d)*R),s.push(p+(v-p)*R)):(s.push(d),s.push(p)),s.push(b),s.push(I)}l=!0}if(E==s.length)return c.length=0,!0;if(s.push(s[0]),s.push(s[1]),_==f)break;var N=s;(s=u).length=0,u=N}if(c!=s){c.length=0,_=0;for(var M=s.length-2;_<M;_++)c[_]=s[_]}else c.length=c.length-2;return l},t.makeClockwise=function(e){for(var t=e,n=e.length,i=t[n-2]*t[1]-t[0]*t[n-1],r=0,a=0,o=0,s=0,c=n-3;s<c;s+=2)r=t[s],a=t[s+1],o=t[s+2],i+=r*t[s+3]-o*a;if(!(i<0)){s=0;var l=n-2;for(c=n>>1;s<c;s+=2){var u=t[s],h=t[s+1],f=l-s;t[s]=t[f],t[s+1]=t[f+1],t[f]=u,t[f+1]=h}}},t}();e.SkeletonClipping=t}(x6||(x6={})),function(e){var t=function(){function e(){this.bones=new Array,this.slots=new Array,this.skins=new Array,this.events=new Array,this.animations=new Array,this.ikConstraints=new Array,this.transformConstraints=new Array,this.pathConstraints=new Array,this.fps=0}return e.prototype.findBone=function(e){if(null==e)throw new Error("boneName cannot be null.");for(var t=this.bones,n=0,i=t.length;n<i;n++){var r=t[n];if(r.name==e)return r}return null},e.prototype.findBoneIndex=function(e){if(null==e)throw new Error("boneName cannot be null.");for(var t=this.bones,n=0,i=t.length;n<i;n++)if(t[n].name==e)return n;return-1},e.prototype.findSlot=function(e){if(null==e)throw new Error("slotName cannot be null.");for(var t=this.slots,n=0,i=t.length;n<i;n++){var r=t[n];if(r.name==e)return r}return null},e.prototype.findSlotIndex=function(e){if(null==e)throw new Error("slotName cannot be null.");for(var t=this.slots,n=0,i=t.length;n<i;n++)if(t[n].name==e)return n;return-1},e.prototype.findSkin=function(e){if(null==e)throw new Error("skinName cannot be null.");for(var t=this.skins,n=0,i=t.length;n<i;n++){var r=t[n];if(r.name==e)return r}return null},e.prototype.findEvent=function(e){if(null==e)throw new Error("eventDataName cannot be null.");for(var t=this.events,n=0,i=t.length;n<i;n++){var r=t[n];if(r.name==e)return r}return null},e.prototype.findAnimation=function(e){if(null==e)throw new Error("animationName cannot be null.");for(var t=this.animations,n=0,i=t.length;n<i;n++){var r=t[n];if(r.name==e)return r}return null},e.prototype.findIkConstraint=function(e){if(null==e)throw new Error("constraintName cannot be null.");for(var t=this.ikConstraints,n=0,i=t.length;n<i;n++){var r=t[n];if(r.name==e)return r}return null},e.prototype.findTransformConstraint=function(e){if(null==e)throw new Error("constraintName cannot be null.");for(var t=this.transformConstraints,n=0,i=t.length;n<i;n++){var r=t[n];if(r.name==e)return r}return null},e.prototype.findPathConstraint=function(e){if(null==e)throw new Error("constraintName cannot be null.");for(var t=this.pathConstraints,n=0,i=t.length;n<i;n++){var r=t[n];if(r.name==e)return r}return null},e.prototype.findPathConstraintIndex=function(e){if(null==e)throw new Error("pathConstraintName cannot be null.");for(var t=this.pathConstraints,n=0,i=t.length;n<i;n++)if(t[n].name==e)return n;return-1},e}();e.SkeletonData=t}(x6||(x6={})),function(e){var t=function(){function t(e){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=e}return t.prototype.readSkeletonData=function(n){var i=this.scale,r=new e.SkeletonData,a="string"==typeof n?JSON.parse(n):n,o=a.skeleton;if(null!=o&&(r.hash=o.hash,r.version=o.spine,r.x=o.x,r.y=o.y,r.width=o.width,r.height=o.height,r.fps=o.fps,r.imagesPath=o.images),a.bones)for(var s=0;s<a.bones.length;s++){var c=a.bones[s],l=null,u=this.getValue(c,"parent",null);if(null!=u&&null==(l=r.findBone(u)))throw new Error("Parent bone not found: "+u);(d=new e.BoneData(r.bones.length,c.name,l)).length=this.getValue(c,"length",0)*i,d.x=this.getValue(c,"x",0)*i,d.y=this.getValue(c,"y",0)*i,d.rotation=this.getValue(c,"rotation",0),d.scaleX=this.getValue(c,"scaleX",1),d.scaleY=this.getValue(c,"scaleY",1),d.shearX=this.getValue(c,"shearX",0),d.shearY=this.getValue(c,"shearY",0),d.transformMode=t.transformModeFromString(this.getValue(c,"transform","normal")),d.skinRequired=this.getValue(c,"skin",!1),r.bones.push(d)}if(a.slots)for(s=0;s<a.slots.length;s++){var h=(P=a.slots[s]).name,f=P.bone,_=r.findBone(f);if(null==_)throw new Error("Slot bone not found: "+f);var d=new e.SlotData(r.slots.length,h,_),p=this.getValue(P,"color",null);null!=p&&d.color.setFromString(p);var m=this.getValue(P,"dark",null);null!=m&&(d.darkColor=new e.Color(1,1,1,1),d.darkColor.setFromString(m)),d.attachmentName=this.getValue(P,"attachment",null),d.blendMode=t.blendModeFromString(this.getValue(P,"blend","normal")),r.slots.push(d)}if(a.ik)for(s=0;s<a.ik.length;s++){var v=a.ik[s];(d=new e.IkConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1);for(var g=0;g<v.bones.length;g++){if(f=v.bones[g],null==(b=r.findBone(f)))throw new Error("IK bone not found: "+f);d.bones.push(b)}var y=v.target;if(d.target=r.findBone(y),null==d.target)throw new Error("IK target bone not found: "+y);d.mix=this.getValue(v,"mix",1),d.softness=this.getValue(v,"softness",0)*i,d.bendDirection=this.getValue(v,"bendPositive",!0)?1:-1,d.compress=this.getValue(v,"compress",!1),d.stretch=this.getValue(v,"stretch",!1),d.uniform=this.getValue(v,"uniform",!1),r.ikConstraints.push(d)}if(a.transform)for(s=0;s<a.transform.length;s++){for(v=a.transform[s],(d=new e.TransformConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1),g=0;g<v.bones.length;g++){if(f=v.bones[g],null==(b=r.findBone(f)))throw new Error("Transform constraint bone not found: "+f);d.bones.push(b)}if(y=v.target,d.target=r.findBone(y),null==d.target)throw new Error("Transform constraint target bone not found: "+y);d.local=this.getValue(v,"local",!1),d.relative=this.getValue(v,"relative",!1),d.offsetRotation=this.getValue(v,"rotation",0),d.offsetX=this.getValue(v,"x",0)*i,d.offsetY=this.getValue(v,"y",0)*i,d.offsetScaleX=this.getValue(v,"scaleX",0),d.offsetScaleY=this.getValue(v,"scaleY",0),d.offsetShearY=this.getValue(v,"shearY",0),d.rotateMix=this.getValue(v,"rotateMix",1),d.translateMix=this.getValue(v,"translateMix",1),d.scaleMix=this.getValue(v,"scaleMix",1),d.shearMix=this.getValue(v,"shearMix",1),r.transformConstraints.push(d)}if(a.path)for(s=0;s<a.path.length;s++){for(v=a.path[s],(d=new e.PathConstraintData(v.name)).order=this.getValue(v,"order",0),d.skinRequired=this.getValue(v,"skin",!1),g=0;g<v.bones.length;g++){if(f=v.bones[g],null==(b=r.findBone(f)))throw new Error("Transform constraint bone not found: "+f);d.bones.push(b)}if(y=v.target,d.target=r.findSlot(y),null==d.target)throw new Error("Path target slot not found: "+y);d.positionMode=t.positionModeFromString(this.getValue(v,"positionMode","percent")),d.spacingMode=t.spacingModeFromString(this.getValue(v,"spacingMode","length")),d.rotateMode=t.rotateModeFromString(this.getValue(v,"rotateMode","tangent")),d.offsetRotation=this.getValue(v,"rotation",0),d.position=this.getValue(v,"position",0),d.positionMode==e.PositionMode.Fixed&&(d.position*=i),d.spacing=this.getValue(v,"spacing",0),d.spacingMode!=e.SpacingMode.Length&&d.spacingMode!=e.SpacingMode.Fixed||(d.spacing*=i),d.rotateMix=this.getValue(v,"rotateMix",1),d.translateMix=this.getValue(v,"translateMix",1),r.pathConstraints.push(d)}if(a.skins){var S=a.skins;if(!(S instanceof Array)){var x=[];for(var E in S)x.push({name:E,attachments:S[E]});S=x}for(s=0;s<S.length;s++){var T=S[s],C=new e.Skin(T.name);if(T.bones)for(var A=0;A<T.bones.length;A++){var b;if(null==(b=r.findBone(T.bones[A])))throw new Error("Skin bone not found: "+T.bones[s]);C.bones.push(b)}if(T.ik)for(A=0;A<T.ik.length;A++){if(null==(I=r.findIkConstraint(T.ik[A])))throw new Error("Skin IK constraint not found: "+T.ik[s]);C.constraints.push(I)}if(T.transform)for(A=0;A<T.transform.length;A++){if(null==(I=r.findTransformConstraint(T.transform[A])))throw new Error("Skin transform constraint not found: "+T.transform[s]);C.constraints.push(I)}if(T.path)for(A=0;A<T.path.length;A++){var I;if(null==(I=r.findPathConstraint(T.path[A])))throw new Error("Skin path constraint not found: "+T.path[s]);C.constraints.push(I)}for(var h in T.attachments){var w=r.findSlot(h);if(null==w)throw new Error("Slot not found: "+h);var P=T.attachments[h];for(var R in P){var D=this.readAttachment(P[R],C,w.index,R,r);null!=D&&C.setAttachment(w.index,R,D)}}r.skins.push(C),"default"==C.name&&(r.defaultSkin=C)}}s=0;for(var O=this.linkedMeshes.length;s<O;s++){var N=this.linkedMeshes[s];if(null==(C=null==N.skin?r.defaultSkin:r.findSkin(N.skin)))throw new Error("Skin not found: "+N.skin);var M=C.getAttachment(N.slotIndex,N.parent);if(null==M)throw new Error("Parent mesh not found: "+N.parent);N.mesh.deformAttachment=N.inheritDeform?M:N.mesh,N.mesh.setParentMesh(M),N.mesh.updateUVs()}if(this.linkedMeshes.length=0,a.events)for(var L in a.events){var F=a.events[L];(d=new e.EventData(L)).intValue=this.getValue(F,"int",0),d.floatValue=this.getValue(F,"float",0),d.stringValue=this.getValue(F,"string",""),d.audioPath=this.getValue(F,"audio",null),null!=d.audioPath&&(d.volume=this.getValue(F,"volume",1),d.balance=this.getValue(F,"balance",0)),r.events.push(d)}if(a.animations)for(var B in a.animations){var z=a.animations[B];this.readAnimation(z,B,r)}return r},t.prototype.readAttachment=function(t,i,r,a,o){var s=this.scale;switch(a=this.getValue(t,"name",a),this.getValue(t,"type","region")){case"region":var c=this.getValue(t,"path",a),l=this.attachmentLoader.newRegionAttachment(i,a,c);return null==l?null:(l.path=c,l.x=this.getValue(t,"x",0)*s,l.y=this.getValue(t,"y",0)*s,l.scaleX=this.getValue(t,"scaleX",1),l.scaleY=this.getValue(t,"scaleY",1),l.rotation=this.getValue(t,"rotation",0),l.width=t.width*s,l.height=t.height*s,null!=(y=this.getValue(t,"color",null))&&l.color.setFromString(y),l.updateOffset(),l);case"boundingbox":var u=this.attachmentLoader.newBoundingBoxAttachment(i,a);return null==u?null:(this.readVertices(t,u,t.vertexCount<<1),null!=(y=this.getValue(t,"color",null))&&u.color.setFromString(y),u);case"mesh":case"linkedmesh":c=this.getValue(t,"path",a);var h=this.attachmentLoader.newMeshAttachment(i,a,c);if(null==h)return null;h.path=c,null!=(y=this.getValue(t,"color",null))&&h.color.setFromString(y),h.width=this.getValue(t,"width",0)*s,h.height=this.getValue(t,"height",0)*s;var f=this.getValue(t,"parent",null);if(null!=f)return this.linkedMeshes.push(new n(h,this.getValue(t,"skin",null),r,f,this.getValue(t,"deform",!0))),h;var _=t.uvs;return this.readVertices(t,h,_.length),h.triangles=t.triangles,h.regionUVs=_,h.updateUVs(),h.edges=this.getValue(t,"edges",null),h.hullLength=2*this.getValue(t,"hull",0),h;case"path":if(null==(c=this.attachmentLoader.newPathAttachment(i,a)))return null;c.closed=this.getValue(t,"closed",!1),c.constantSpeed=this.getValue(t,"constantSpeed",!0);var d=t.vertexCount;this.readVertices(t,c,d<<1);for(var p=e.Utils.newArray(d/3,0),m=0;m<t.lengths.length;m++)p[m]=t.lengths[m]*s;return c.lengths=p,null!=(y=this.getValue(t,"color",null))&&c.color.setFromString(y),c;case"point":var v=this.attachmentLoader.newPointAttachment(i,a);return null==v?null:(v.x=this.getValue(t,"x",0)*s,v.y=this.getValue(t,"y",0)*s,v.rotation=this.getValue(t,"rotation",0),null!=(y=this.getValue(t,"color",null))&&v.color.setFromString(y),v);case"clipping":var g=this.attachmentLoader.newClippingAttachment(i,a);if(null==g)return null;var y,S=this.getValue(t,"end",null);if(null!=S){var x=o.findSlot(S);if(null==x)throw new Error("Clipping end slot not found: "+S);g.endSlot=x}return d=t.vertexCount,this.readVertices(t,g,d<<1),null!=(y=this.getValue(t,"color",null))&&g.color.setFromString(y),g}return null},t.prototype.readVertices=function(t,n,i){var r=this.scale;n.worldVerticesLength=i;var a=t.vertices;if(i!=a.length){var o=new Array,s=new Array;for(h=0,f=a.length;h<f;){var c=a[h++];s.push(c);for(var l=h+4*c;h<l;h+=4)s.push(a[h]),o.push(a[h+1]*r),o.push(a[h+2]*r),o.push(a[h+3])}n.bones=s,n.vertices=e.Utils.toFloatArray(o)}else{var u=e.Utils.toFloatArray(a);if(1!=r)for(var h=0,f=a.length;h<f;h++)u[h]*=r;n.vertices=u}},t.prototype.readAnimation=function(t,n,i){var r=this.scale,a=new Array,o=0;if(t.slots)for(var s in t.slots){var c=t.slots[s];if(-1==(J=i.findSlotIndex(s)))throw new Error("Slot not found: "+s);for(var l in c){var u=c[l];if("attachment"==l){(S=new e.AttachmentTimeline(u.length)).slotIndex=J;for(var h=0,f=0;f<u.length;f++){var _=u[f];S.setFrame(h++,this.getValue(_,"time",0),_.name)}a.push(S),o=Math.max(o,S.frames[S.getFrameCount()-1])}else if("color"==l){for((S=new e.ColorTimeline(u.length)).slotIndex=J,h=0,f=0;f<u.length;f++){_=u[f];var d=new e.Color;d.setFromString(_.color),S.setFrame(h,this.getValue(_,"time",0),d.r,d.g,d.b,d.a),this.readCurve(_,S,h),h++}a.push(S),o=Math.max(o,S.frames[(S.getFrameCount()-1)*e.ColorTimeline.ENTRIES])}else{if("twoColor"!=l)throw new Error("Invalid timeline type for a slot: "+l+" ("+s+")");for((S=new e.TwoColorTimeline(u.length)).slotIndex=J,h=0,f=0;f<u.length;f++){_=u[f];var p=new e.Color,m=new e.Color;p.setFromString(_.light),m.setFromString(_.dark),S.setFrame(h,this.getValue(_,"time",0),p.r,p.g,p.b,p.a,m.r,m.g,m.b),this.readCurve(_,S,h),h++}a.push(S),o=Math.max(o,S.frames[(S.getFrameCount()-1)*e.TwoColorTimeline.ENTRIES])}}}if(t.bones)for(var v in t.bones){var g=t.bones[v],y=i.findBoneIndex(v);if(-1==y)throw new Error("Bone not found: "+v);for(var l in g)if(u=g[l],"rotate"===l){for((S=new e.RotateTimeline(u.length)).boneIndex=y,h=0,f=0;f<u.length;f++)_=u[f],S.setFrame(h,this.getValue(_,"time",0),this.getValue(_,"angle",0)),this.readCurve(_,S,h),h++;a.push(S),o=Math.max(o,S.frames[(S.getFrameCount()-1)*e.RotateTimeline.ENTRIES])}else{if("translate"!==l&&"scale"!==l&&"shear"!==l)throw new Error("Invalid timeline type for a bone: "+l+" ("+v+")");var S=null,x=1,E=0;for("scale"===l?(S=new e.ScaleTimeline(u.length),E=1):"shear"===l?S=new e.ShearTimeline(u.length):(S=new e.TranslateTimeline(u.length),x=r),S.boneIndex=y,h=0,f=0;f<u.length;f++){_=u[f];var T=this.getValue(_,"x",E),C=this.getValue(_,"y",E);S.setFrame(h,this.getValue(_,"time",0),T*x,C*x),this.readCurve(_,S,h),h++}a.push(S),o=Math.max(o,S.frames[(S.getFrameCount()-1)*e.TranslateTimeline.ENTRIES])}}if(t.ik)for(var A in t.ik){var b=t.ik[A],I=i.findIkConstraint(A);for((S=new e.IkConstraintTimeline(b.length)).ikConstraintIndex=i.ikConstraints.indexOf(I),h=0,f=0;f<b.length;f++)_=b[f],S.setFrame(h,this.getValue(_,"time",0),this.getValue(_,"mix",1),this.getValue(_,"softness",0)*r,this.getValue(_,"bendPositive",!0)?1:-1,this.getValue(_,"compress",!1),this.getValue(_,"stretch",!1)),this.readCurve(_,S,h),h++;a.push(S),o=Math.max(o,S.frames[(S.getFrameCount()-1)*e.IkConstraintTimeline.ENTRIES])}if(t.transform)for(var A in t.transform){for(b=t.transform[A],I=i.findTransformConstraint(A),(S=new e.TransformConstraintTimeline(b.length)).transformConstraintIndex=i.transformConstraints.indexOf(I),h=0,f=0;f<b.length;f++)_=b[f],S.setFrame(h,this.getValue(_,"time",0),this.getValue(_,"rotateMix",1),this.getValue(_,"translateMix",1),this.getValue(_,"scaleMix",1),this.getValue(_,"shearMix",1)),this.readCurve(_,S,h),h++;a.push(S),o=Math.max(o,S.frames[(S.getFrameCount()-1)*e.TransformConstraintTimeline.ENTRIES])}var w=t.path||t.paths;if(w)for(var A in w){b=w[A];var P=i.findPathConstraintIndex(A);if(-1==P)throw new Error("Path constraint not found: "+A);var R=i.pathConstraints[P];for(var l in b)if(u=b[l],"position"===l||"spacing"===l){for(S=null,x=1,"spacing"===l?(S=new e.PathConstraintSpacingTimeline(u.length),R.spacingMode!=e.SpacingMode.Length&&R.spacingMode!=e.SpacingMode.Fixed||(x=r)):(S=new e.PathConstraintPositionTimeline(u.length),R.positionMode==e.PositionMode.Fixed&&(x=r)),S.pathConstraintIndex=P,h=0,f=0;f<u.length;f++)_=u[f],S.setFrame(h,this.getValue(_,"time",0),this.getValue(_,l,0)*x),this.readCurve(_,S,h),h++;a.push(S),o=Math.max(o,S.frames[(S.getFrameCount()-1)*e.PathConstraintPositionTimeline.ENTRIES])}else if("mix"===l){for((S=new e.PathConstraintMixTimeline(u.length)).pathConstraintIndex=P,h=0,f=0;f<u.length;f++)_=u[f],S.setFrame(h,this.getValue(_,"time",0),this.getValue(_,"rotateMix",1),this.getValue(_,"translateMix",1)),this.readCurve(_,S,h),h++;a.push(S),o=Math.max(o,S.frames[(S.getFrameCount()-1)*e.PathConstraintMixTimeline.ENTRIES])}}if(t.deform)for(var D in t.deform){var O=t.deform[D],N=i.findSkin(D);if(null==N)throw new Error("Skin not found: "+D);for(var s in O){if(c=O[s],-1==(J=i.findSlotIndex(s)))throw new Error("Slot not found: "+c.name);for(var l in c){u=c[l];var M=N.getAttachment(J,l);if(null!=M){var L=null!=M.bones,F=M.vertices,B=L?F.length/3*2:F.length;(S=new e.DeformTimeline(u.length)).slotIndex=J,S.attachment=M,h=0;for(var z=0;z<u.length;z++){_=u[z];var U=void 0,k=this.getValue(_,"vertices",null);if(null==k)U=L?e.Utils.newFloatArray(B):F;else{U=e.Utils.newFloatArray(B);var G=this.getValue(_,"offset",0);if(e.Utils.arrayCopy(k,0,U,G,k.length),1!=r)for(var H=(f=G)+k.length;f<H;f++)U[f]*=r;if(!L)for(f=0;f<B;f++)U[f]+=F[f]}S.setFrame(h,this.getValue(_,"time",0),U),this.readCurve(_,S,h),h++}a.push(S),o=Math.max(o,S.frames[S.getFrameCount()-1])}}}}var V=t.drawOrder;if(null==V&&(V=t.draworder),null!=V){S=new e.DrawOrderTimeline(V.length);var W=i.slots.length;for(h=0,z=0;z<V.length;z++){var j=V[z],X=null,q=this.getValue(j,"offsets",null);if(null!=q){X=e.Utils.newArray(W,-1);var Y=e.Utils.newArray(W-q.length,0),K=0,Q=0;for(f=0;f<q.length;f++){var J,Z=q[f];if(-1==(J=i.findSlotIndex(Z.slot)))throw new Error("Slot not found: "+Z.slot);for(;K!=J;)Y[Q++]=K++;X[K+Z.offset]=K++}for(;K<W;)Y[Q++]=K++;for(f=W-1;f>=0;f--)-1==X[f]&&(X[f]=Y[--Q])}S.setFrame(h++,this.getValue(j,"time",0),X)}a.push(S),o=Math.max(o,S.frames[S.getFrameCount()-1])}if(t.events){for(S=new e.EventTimeline(t.events.length),h=0,f=0;f<t.events.length;f++){var $=t.events[f],ee=i.findEvent($.name);if(null==ee)throw new Error("Event not found: "+$.name);var te=new e.Event(e.Utils.toSinglePrecision(this.getValue($,"time",0)),ee);te.intValue=this.getValue($,"int",ee.intValue),te.floatValue=this.getValue($,"float",ee.floatValue),te.stringValue=this.getValue($,"string",ee.stringValue),null!=te.data.audioPath&&(te.volume=this.getValue($,"volume",1),te.balance=this.getValue($,"balance",0)),S.setFrame(h++,te)}a.push(S),o=Math.max(o,S.frames[S.getFrameCount()-1])}if(isNaN(o))throw new Error("Error while parsing animation, duration is NaN");i.animations.push(new e.Animation(n,a,o))},t.prototype.readCurve=function(e,t,n){var i=e.curve;i&&("stepped"==i?t.setStepped(n):"[object Array]"===Object.prototype.toString.call(i)?t.setCurve(n,i[0],i[1],i[2],i[3]):t.setCurve(n,i,this.getValue(e,"c2",0),this.getValue(e,"c3",1),this.getValue(e,"c4",1)))},t.prototype.getValue=function(e,t,n){return void 0!==e[t]?e[t]:n},t.blendModeFromString=function(t){if("normal"==(t=t.toLowerCase()))return e.BlendMode.Normal;if("additive"==t)return e.BlendMode.Additive;if("multiply"==t)return e.BlendMode.Multiply;if("screen"==t)return e.BlendMode.Screen;throw new Error("Unknown blend mode: "+t)},t.positionModeFromString=function(t){if("fixed"==(t=t.toLowerCase()))return e.PositionMode.Fixed;if("percent"==t)return e.PositionMode.Percent;throw new Error("Unknown position mode: "+t)},t.spacingModeFromString=function(t){if("length"==(t=t.toLowerCase()))return e.SpacingMode.Length;if("fixed"==t)return e.SpacingMode.Fixed;if("percent"==t)return e.SpacingMode.Percent;throw new Error("Unknown position mode: "+t)},t.rotateModeFromString=function(t){if("tangent"==(t=t.toLowerCase()))return e.RotateMode.Tangent;if("chain"==t)return e.RotateMode.Chain;if("chainscale"==t)return e.RotateMode.ChainScale;throw new Error("Unknown rotate mode: "+t)},t.transformModeFromString=function(t){if("normal"==(t=t.toLowerCase()))return e.TransformMode.Normal;if("onlytranslation"==t)return e.TransformMode.OnlyTranslation;if("norotationorreflection"==t)return e.TransformMode.NoRotationOrReflection;if("noscale"==t)return e.TransformMode.NoScale;if("noscaleorreflection"==t)return e.TransformMode.NoScaleOrReflection;throw new Error("Unknown transform mode: "+t)},t}();e.SkeletonJson=t;var n=function(e,t,n,i,r){this.mesh=e,this.skin=t,this.slotIndex=n,this.parent=i,this.inheritDeform=r}}(x6||(x6={})),function(e){var t=function(e,t,n){this.slotIndex=e,this.name=t,this.attachment=n};e.SkinEntry=t;var n=function(){function n(e){if(this.attachments=new Array,this.bones=Array(),this.constraints=new Array,null==e)throw new Error("name cannot be null.");this.name=e}return n.prototype.setAttachment=function(e,t,n){if(null==n)throw new Error("attachment cannot be null.");var i=this.attachments;e>=i.length&&(i.length=e+1),i[e]||(i[e]={}),i[e][t]=n},n.prototype.addSkin=function(e){for(var t=0;t<e.bones.length;t++){for(var n=e.bones[t],i=!1,r=0;r<this.bones.length;r++)if(this.bones[r]==n){i=!0;break}i||this.bones.push(n)}for(t=0;t<e.constraints.length;t++){var a=e.constraints[t];for(i=!1,r=0;r<this.constraints.length;r++)if(this.constraints[r]==a){i=!0;break}i||this.constraints.push(a)}var o=e.getAttachments();for(t=0;t<o.length;t++){var s=o[t];this.setAttachment(s.slotIndex,s.name,s.attachment)}},n.prototype.copySkin=function(t){for(var n=0;n<t.bones.length;n++){for(var i=t.bones[n],r=!1,a=0;a<this.bones.length;a++)if(this.bones[a]==i){r=!0;break}r||this.bones.push(i)}for(n=0;n<t.constraints.length;n++){var o=t.constraints[n];for(r=!1,a=0;a<this.constraints.length;a++)if(this.constraints[a]==o){r=!0;break}r||this.constraints.push(o)}var s=t.getAttachments();for(n=0;n<s.length;n++){var c=s[n];null!=c.attachment&&(c.attachment instanceof e.MeshAttachment?(c.attachment=c.attachment.newLinkedMesh(),this.setAttachment(c.slotIndex,c.name,c.attachment)):(c.attachment=c.attachment.copy(),this.setAttachment(c.slotIndex,c.name,c.attachment)))}},n.prototype.getAttachment=function(e,t){var n=this.attachments[e];return n?n[t]:null},n.prototype.removeAttachment=function(e,t){var n=this.attachments[e];n&&(n[t]=null)},n.prototype.getAttachments=function(){for(var e=new Array,n=0;n<this.attachments.length;n++){var i=this.attachments[n];if(i)for(var r in i){var a=i[r];a&&e.push(new t(n,r,a))}}return e},n.prototype.getAttachmentsForSlot=function(e,n){var i=this.attachments[e];if(i)for(var r in i){var a=i[r];a&&n.push(new t(e,r,a))}},n.prototype.clear=function(){this.attachments.length=0,this.bones.length=0,this.constraints.length=0},n.prototype.attachAll=function(e,t){for(var n=0,i=0;i<e.slots.length;i++){var r=e.slots[i],a=r.getAttachment();if(a&&n<t.attachments.length){var o=t.attachments[n];for(var s in o)if(a==o[s]){var c=this.getAttachment(n,s);null!=c&&r.setAttachment(c);break}}n++}},n}();e.Skin=n}(x6||(x6={})),function(e){var t=function(){function t(t,n){if(this.deform=new Array,null==t)throw new Error("data cannot be null.");if(null==n)throw new Error("bone cannot be null.");this.data=t,this.bone=n,this.color=new e.Color,this.darkColor=null==t.darkColor?null:new e.Color,this.setToSetupPose()}return t.prototype.getSkeleton=function(){return this.bone.skeleton},t.prototype.getAttachment=function(){return this.attachment},t.prototype.setAttachment=function(e){this.attachment!=e&&(this.attachment=e,this.attachmentTime=this.bone.skeleton.time,this.deform.length=0)},t.prototype.setAttachmentTime=function(e){this.attachmentTime=this.bone.skeleton.time-e},t.prototype.getAttachmentTime=function(){return this.bone.skeleton.time-this.attachmentTime},t.prototype.setToSetupPose=function(){this.color.setFromColor(this.data.color),null!=this.darkColor&&this.darkColor.setFromColor(this.data.darkColor),null==this.data.attachmentName?this.attachment=null:(this.attachment=null,this.setAttachment(this.bone.skeleton.getAttachment(this.data.index,this.data.attachmentName)))},t}();e.Slot=t}(x6||(x6={})),function(e){e.SlotData=function(t,n,i){if(this.color=new e.Color(1,1,1,1),t<0)throw new Error("index must be >= 0.");if(null==n)throw new Error("name cannot be null.");if(null==i)throw new Error("boneData cannot be null.");this.index=t,this.name=n,this.boneData=i}}(x6||(x6={})),function(e){var t,n,i=function(){function e(e){this._image=e}return e.prototype.getImage=function(){return this._image},e.filterFromString=function(e){switch(e.toLowerCase()){case"nearest":return t.Nearest;case"linear":return t.Linear;case"mipmap":return t.MipMap;case"mipmapnearestnearest":return t.MipMapNearestNearest;case"mipmaplinearnearest":return t.MipMapLinearNearest;case"mipmapnearestlinear":return t.MipMapNearestLinear;case"mipmaplinearlinear":return t.MipMapLinearLinear;default:throw new Error("Unknown texture filter "+e)}},e.wrapFromString=function(e){switch(e.toLowerCase()){case"mirroredtepeat":return n.MirroredRepeat;case"clamptoedge":return n.ClampToEdge;case"repeat":return n.Repeat;default:throw new Error("Unknown texture wrap "+e)}},e}();e.Texture=i,function(e){e[e.Nearest=9728]="Nearest",e[e.Linear=9729]="Linear",e[e.MipMap=9987]="MipMap",e[e.MipMapNearestNearest=9984]="MipMapNearestNearest",e[e.MipMapLinearNearest=9985]="MipMapLinearNearest",e[e.MipMapNearestLinear=9986]="MipMapNearestLinear",e[e.MipMapLinearLinear=9987]="MipMapLinearLinear"}(t=e.TextureFilter||(e.TextureFilter={})),function(e){e[e.MirroredRepeat=33648]="MirroredRepeat",e[e.ClampToEdge=33071]="ClampToEdge",e[e.Repeat=10497]="Repeat"}(n=e.TextureWrap||(e.TextureWrap={}));e.TextureRegion=function(){this.u=0,this.v=0,this.u2=0,this.v2=0,this.width=0,this.height=0,this.rotate=!1,this.offsetX=0,this.offsetY=0,this.originalWidth=0,this.originalHeight=0};var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return E6(t,e),t.prototype.setFilters=function(){},t.prototype.setWraps=function(){},t.prototype.dispose=function(){},t}(i);e.FakeTexture=r}(x6||(x6={})),function(e){var t=function(){function t(e,t){this.pages=new Array,this.regions=new Array,this.load(e,t)}return t.prototype.load=function(t,a){if(null==a)throw new Error("textureLoader cannot be null.");for(var o=new n(t),s=new Array(4),c=null;;){var l=o.readLine();if(null==l)break;if(0==(l=l.trim()).length)c=null;else if(c){var u=new r;u.name=l,u.page=c;var h=o.readValue();"true"==h.toLocaleLowerCase()?u.degrees=90:"false"==h.toLocaleLowerCase()?u.degrees=0:u.degrees=parseFloat(h),u.rotate=90==u.degrees,o.readTuple(s);var f=parseInt(s[0]),_=parseInt(s[1]);o.readTuple(s);var d=parseInt(s[0]),p=parseInt(s[1]);u.u=f/c.width,u.v=_/c.height,u.rotate?(u.u2=(f+p)/c.width,u.v2=(_+d)/c.height):(u.u2=(f+d)/c.width,u.v2=(_+p)/c.height),u.x=f,u.y=_,u.width=Math.abs(d),u.height=Math.abs(p),4==o.readTuple(s)&&4==o.readTuple(s)&&o.readTuple(s),u.originalWidth=parseInt(s[0]),u.originalHeight=parseInt(s[1]),o.readTuple(s),u.offsetX=parseInt(s[0]),u.offsetY=parseInt(s[1]),u.index=parseInt(o.readValue()),u.texture=c.texture,this.regions.push(u)}else{(c=new i).name=l,2==o.readTuple(s)&&(c.width=parseInt(s[0]),c.height=parseInt(s[1]),o.readTuple(s)),o.readTuple(s),c.minFilter=e.Texture.filterFromString(s[0]),c.magFilter=e.Texture.filterFromString(s[1]);var m=o.readValue();c.uWrap=e.TextureWrap.ClampToEdge,c.vWrap=e.TextureWrap.ClampToEdge,"x"==m?c.uWrap=e.TextureWrap.Repeat:"y"==m?c.vWrap=e.TextureWrap.Repeat:"xy"==m&&(c.uWrap=c.vWrap=e.TextureWrap.Repeat),c.texture=a(l),c.texture.setFilters(c.minFilter,c.magFilter),c.texture.setWraps(c.uWrap,c.vWrap),c.width=c.texture.getImage().width,c.height=c.texture.getImage().height,this.pages.push(c)}}},t.prototype.findRegion=function(e){for(var t=0;t<this.regions.length;t++)if(this.regions[t].name==e)return this.regions[t];return null},t.prototype.dispose=function(){for(var e=0;e<this.pages.length;e++)this.pages[e].texture.dispose()},t}();e.TextureAtlas=t;var n=function(){function e(e){this.index=0,this.lines=e.split(/\r\n|\r|\n/)}return e.prototype.readLine=function(){return this.index>=this.lines.length?null:this.lines[this.index++]},e.prototype.readValue=function(){var e=this.readLine(),t=e.indexOf(":");if(-1==t)throw new Error("Invalid line: "+e);return e.substring(t+1).trim()},e.prototype.readTuple=function(e){var t=this.readLine(),n=t.indexOf(":");if(-1==n)throw new Error("Invalid line: "+t);for(var i=0,r=n+1;i<3;i++){var a=t.indexOf(",",r);if(-1==a)break;e[i]=t.substr(r,a-r).trim(),r=a+1}return e[i]=t.substring(r).trim(),i+1},e}(),i=function(){};e.TextureAtlasPage=i;var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return E6(t,e),t}(e.TextureRegion);e.TextureAtlasRegion=r}(x6||(x6={})),function(e){var t=function(){function t(t,n){if(this.rotateMix=0,this.translateMix=0,this.scaleMix=0,this.shearMix=0,this.temp=new e.Vector2,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==n)throw new Error("skeleton cannot be null.");this.data=t,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.scaleMix=t.scaleMix,this.shearMix=t.shearMix,this.bones=new Array;for(var i=0;i<t.bones.length;i++)this.bones.push(n.findBone(t.bones[i].name));this.target=n.findBone(t.target.name)}return t.prototype.isActive=function(){return this.active},t.prototype.apply=function(){this.update()},t.prototype.update=function(){this.data.local?this.data.relative?this.applyRelativeLocal():this.applyAbsoluteLocal():this.data.relative?this.applyRelativeWorld():this.applyAbsoluteWorld()},t.prototype.applyAbsoluteWorld=function(){for(var t=this.rotateMix,n=this.translateMix,i=this.scaleMix,r=this.shearMix,a=this.target,o=a.a,s=a.b,c=a.c,l=a.d,u=o*l-s*c>0?e.MathUtils.degRad:-e.MathUtils.degRad,h=this.data.offsetRotation*u,f=this.data.offsetShearY*u,_=this.bones,d=0,p=_.length;d<p;d++){var m=_[d],v=!1;if(0!=t){var g=m.a,y=m.b,S=m.c,x=m.d;(I=Math.atan2(c,o)-Math.atan2(S,g)+h)>e.MathUtils.PI?I-=e.MathUtils.PI2:I<-e.MathUtils.PI&&(I+=e.MathUtils.PI2),I*=t;var E=Math.cos(I),T=Math.sin(I);m.a=E*g-T*S,m.b=E*y-T*x,m.c=T*g+E*S,m.d=T*y+E*x,v=!0}if(0!=n){var C=this.temp;a.localToWorld(C.set(this.data.offsetX,this.data.offsetY)),m.worldX+=(C.x-m.worldX)*n,m.worldY+=(C.y-m.worldY)*n,v=!0}if(i>0){var A=Math.sqrt(m.a*m.a+m.c*m.c),b=Math.sqrt(o*o+c*c);A>1e-5&&(A=(A+(b-A+this.data.offsetScaleX)*i)/A),m.a*=A,m.c*=A,A=Math.sqrt(m.b*m.b+m.d*m.d),b=Math.sqrt(s*s+l*l),A>1e-5&&(A=(A+(b-A+this.data.offsetScaleY)*i)/A),m.b*=A,m.d*=A,v=!0}if(r>0){y=m.b,x=m.d;var I,w=Math.atan2(x,y);(I=Math.atan2(l,s)-Math.atan2(c,o)-(w-Math.atan2(m.c,m.a)))>e.MathUtils.PI?I-=e.MathUtils.PI2:I<-e.MathUtils.PI&&(I+=e.MathUtils.PI2),I=w+(I+f)*r,A=Math.sqrt(y*y+x*x),m.b=Math.cos(I)*A,m.d=Math.sin(I)*A,v=!0}v&&(m.appliedValid=!1)}},t.prototype.applyRelativeWorld=function(){for(var t=this.rotateMix,n=this.translateMix,i=this.scaleMix,r=this.shearMix,a=this.target,o=a.a,s=a.b,c=a.c,l=a.d,u=o*l-s*c>0?e.MathUtils.degRad:-e.MathUtils.degRad,h=this.data.offsetRotation*u,f=this.data.offsetShearY*u,_=this.bones,d=0,p=_.length;d<p;d++){var m,v=_[d],g=!1;if(0!=t){var y=v.a,S=v.b,x=v.c,E=v.d;(m=Math.atan2(c,o)+h)>e.MathUtils.PI?m-=e.MathUtils.PI2:m<-e.MathUtils.PI&&(m+=e.MathUtils.PI2),m*=t;var T=Math.cos(m),C=Math.sin(m);v.a=T*y-C*x,v.b=T*S-C*E,v.c=C*y+T*x,v.d=C*S+T*E,g=!0}if(0!=n){var A=this.temp;a.localToWorld(A.set(this.data.offsetX,this.data.offsetY)),v.worldX+=A.x*n,v.worldY+=A.y*n,g=!0}if(i>0){var b=(Math.sqrt(o*o+c*c)-1+this.data.offsetScaleX)*i+1;v.a*=b,v.c*=b,b=(Math.sqrt(s*s+l*l)-1+this.data.offsetScaleY)*i+1,v.b*=b,v.d*=b,g=!0}if(r>0)(m=Math.atan2(l,s)-Math.atan2(c,o))>e.MathUtils.PI?m-=e.MathUtils.PI2:m<-e.MathUtils.PI&&(m+=e.MathUtils.PI2),S=v.b,E=v.d,m=Math.atan2(E,S)+(m-e.MathUtils.PI/2+f)*r,b=Math.sqrt(S*S+E*E),v.b=Math.cos(m)*b,v.d=Math.sin(m)*b,g=!0;g&&(v.appliedValid=!1)}},t.prototype.applyAbsoluteLocal=function(){var e=this.rotateMix,t=this.translateMix,n=this.scaleMix,i=this.shearMix,r=this.target;r.appliedValid||r.updateAppliedTransform();for(var a=this.bones,o=0,s=a.length;o<s;o++){var c=a[o];c.appliedValid||c.updateAppliedTransform();var l=c.arotation;if(0!=e){var u=r.arotation-l+this.data.offsetRotation;l+=(u-=360*(16384-(16384.499999999996-u/360|0)))*e}var h=c.ax,f=c.ay;0!=t&&(h+=(r.ax-h+this.data.offsetX)*t,f+=(r.ay-f+this.data.offsetY)*t);var _=c.ascaleX,d=c.ascaleY;0!=n&&(_>1e-5&&(_=(_+(r.ascaleX-_+this.data.offsetScaleX)*n)/_),d>1e-5&&(d=(d+(r.ascaleY-d+this.data.offsetScaleY)*n)/d));var p=c.ashearY;0!=i&&(u=r.ashearY-p+this.data.offsetShearY,u-=360*(16384-(16384.499999999996-u/360|0)),c.shearY+=u*i),c.updateWorldTransformWith(h,f,l,_,d,c.ashearX,p)}},t.prototype.applyRelativeLocal=function(){var e=this.rotateMix,t=this.translateMix,n=this.scaleMix,i=this.shearMix,r=this.target;r.appliedValid||r.updateAppliedTransform();for(var a=this.bones,o=0,s=a.length;o<s;o++){var c=a[o];c.appliedValid||c.updateAppliedTransform();var l=c.arotation;0!=e&&(l+=(r.arotation+this.data.offsetRotation)*e);var u=c.ax,h=c.ay;0!=t&&(u+=(r.ax+this.data.offsetX)*t,h+=(r.ay+this.data.offsetY)*t);var f=c.ascaleX,_=c.ascaleY;0!=n&&(f>1e-5&&(f*=(r.ascaleX-1+this.data.offsetScaleX)*n+1),_>1e-5&&(_*=(r.ascaleY-1+this.data.offsetScaleY)*n+1));var d=c.ashearY;0!=i&&(d+=(r.ashearY+this.data.offsetShearY)*i),c.updateWorldTransformWith(u,h,l,f,_,c.ashearX,d)}},t}();e.TransformConstraint=t}(x6||(x6={})),function(e){var t=function(e){function t(t){var n=e.call(this,t,0,!1)||this;return n.bones=new Array,n.rotateMix=0,n.translateMix=0,n.scaleMix=0,n.shearMix=0,n.offsetRotation=0,n.offsetX=0,n.offsetY=0,n.offsetScaleX=0,n.offsetScaleY=0,n.offsetShearY=0,n.relative=!1,n.local=!1,n}return E6(t,e),t}(e.ConstraintData);e.TransformConstraintData=t}(x6||(x6={})),function(e){var t=function(){function t(){this.convexPolygons=new Array,this.convexPolygonsIndices=new Array,this.indicesArray=new Array,this.isConcaveArray=new Array,this.triangles=new Array,this.polygonPool=new e.Pool((function(){return new Array})),this.polygonIndicesPool=new e.Pool((function(){return new Array}))}return t.prototype.triangulate=function(e){var n=e,i=e.length>>1,r=this.indicesArray;r.length=0;for(var a=0;a<i;a++)r[a]=a;var o=this.isConcaveArray;o.length=0,a=0;for(var s=i;a<s;++a)o[a]=t.isConcave(a,i,n,r);var c=this.triangles;for(c.length=0;i>3;){for(var l=i-1,u=(a=0,1);;){e:if(!o[a]){for(var h=r[l]<<1,f=r[a]<<1,_=r[u]<<1,d=n[h],p=n[h+1],m=n[f],v=n[f+1],g=n[_],y=n[_+1],S=(u+1)%i;S!=l;S=(S+1)%i)if(o[S]){var x=r[S]<<1,E=n[x],T=n[x+1];if(t.positiveArea(g,y,d,p,E,T)&&t.positiveArea(d,p,m,v,E,T)&&t.positiveArea(m,v,g,y,E,T))break e}break}if(0==u){do{if(!o[a])break;a--}while(a>0);break}l=a,a=u,u=(u+1)%i}c.push(r[(i+a-1)%i]),c.push(r[a]),c.push(r[(a+1)%i]),r.splice(a,1),o.splice(a,1);var C=(--i+a-1)%i,A=a==i?0:a;o[C]=t.isConcave(C,i,n,r),o[A]=t.isConcave(A,i,n,r)}return 3==i&&(c.push(r[2]),c.push(r[0]),c.push(r[1])),c},t.prototype.decompose=function(e,n){var i=e,r=this.convexPolygons;this.polygonPool.freeAll(r),r.length=0;var a=this.convexPolygonsIndices;this.polygonIndicesPool.freeAll(a),a.length=0;var o=this.polygonIndicesPool.obtain();o.length=0;var s=this.polygonPool.obtain();s.length=0;for(var c=-1,l=0,u=0,h=n.length;u<h;u+=3){var f=n[u]<<1,_=n[u+1]<<1,d=n[u+2]<<1,p=i[f],m=i[f+1],v=i[_],g=i[_+1],y=i[d],S=i[d+1],x=!1;if(c==f){var E=s.length-4,T=t.winding(s[E],s[E+1],s[E+2],s[E+3],y,S),C=t.winding(y,S,s[0],s[1],s[2],s[3]);T==l&&C==l&&(s.push(y),s.push(S),o.push(d),x=!0)}x||(s.length>0?(r.push(s),a.push(o)):(this.polygonPool.free(s),this.polygonIndicesPool.free(o)),(s=this.polygonPool.obtain()).length=0,s.push(p),s.push(m),s.push(v),s.push(g),s.push(y),s.push(S),(o=this.polygonIndicesPool.obtain()).length=0,o.push(f),o.push(_),o.push(d),l=t.winding(p,m,v,g,y,S),c=f)}for(s.length>0&&(r.push(s),a.push(o)),u=0,h=r.length;u<h;u++)if(0!=(o=a[u]).length)for(var A=o[0],b=o[o.length-1],I=(s=r[u])[E=s.length-4],w=s[E+1],P=s[E+2],R=s[E+3],D=s[0],O=s[1],N=s[2],M=s[3],L=t.winding(I,w,P,R,D,O),F=0;F<h;F++)if(F!=u){var B=a[F];if(3==B.length){var z=B[0],U=B[1],k=B[2],G=r[F];y=G[G.length-2],S=G[G.length-1],z==A&&U==b&&(T=t.winding(I,w,P,R,y,S),C=t.winding(y,S,D,O,N,M),T==L&&C==L&&(G.length=0,B.length=0,s.push(y),s.push(S),o.push(k),I=P,w=R,P=y,R=S,F=0))}}for(u=r.length-1;u>=0;u--)0==(s=r[u]).length&&(r.splice(u,1),this.polygonPool.free(s),o=a[u],a.splice(u,1),this.polygonIndicesPool.free(o));return r},t.isConcave=function(e,t,n,i){var r=i[(t+e-1)%t]<<1,a=i[e]<<1,o=i[(e+1)%t]<<1;return!this.positiveArea(n[r],n[r+1],n[a],n[a+1],n[o],n[o+1])},t.positiveArea=function(e,t,n,i,r,a){return e*(a-i)+n*(t-a)+r*(i-t)>=0},t.winding=function(e,t,n,i,r,a){var o=n-e,s=i-t;return r*s-a*o+o*t-e*s>=0?1:-1},t}();e.Triangulator=t}(x6||(x6={})),function(e){var t=function(){function e(){this.array=new Array}return e.prototype.add=function(e){var t=this.contains(e);return this.array[0|e]=0|e,!t},e.prototype.contains=function(e){return null!=this.array[0|e]},e.prototype.remove=function(e){this.array[0|e]=void 0},e.prototype.clear=function(){this.array.length=0},e}();e.IntSet=t;var n=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.r=e,this.g=t,this.b=n,this.a=i}return e.prototype.set=function(e,t,n,i){return this.r=e,this.g=t,this.b=n,this.a=i,this.clamp(),this},e.prototype.setFromColor=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},e.prototype.setFromString=function(e){return e="#"==e.charAt(0)?e.substr(1):e,this.r=parseInt(e.substr(0,2),16)/255,this.g=parseInt(e.substr(2,2),16)/255,this.b=parseInt(e.substr(4,2),16)/255,this.a=(8!=e.length?255:parseInt(e.substr(6,2),16))/255,this},e.prototype.add=function(e,t,n,i){return this.r+=e,this.g+=t,this.b+=n,this.a+=i,this.clamp(),this},e.prototype.clamp=function(){return this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1),this},e.rgba8888ToColor=function(e,t){e.r=((4278190080&t)>>>24)/255,e.g=((16711680&t)>>>16)/255,e.b=((65280&t)>>>8)/255,e.a=(255&t)/255},e.rgb888ToColor=function(e,t){e.r=((16711680&t)>>>16)/255,e.g=((65280&t)>>>8)/255,e.b=(255&t)/255},e.WHITE=new e(1,1,1,1),e.RED=new e(1,0,0,1),e.GREEN=new e(0,1,0,1),e.BLUE=new e(0,0,1,1),e.MAGENTA=new e(1,0,1,1),e}();e.Color=n;var i=function(){function e(){}return e.clamp=function(e,t,n){return e<t?t:e>n?n:e},e.cosDeg=function(t){return Math.cos(t*e.degRad)},e.sinDeg=function(t){return Math.sin(t*e.degRad)},e.signum=function(e){return e>0?1:e<0?-1:0},e.toInt=function(e){return e>0?Math.floor(e):Math.ceil(e)},e.cbrt=function(e){var t=Math.pow(Math.abs(e),1/3);return e<0?-t:t},e.randomTriangular=function(t,n){return e.randomTriangularWith(t,n,.5*(t+n))},e.randomTriangularWith=function(e,t,n){var i=Math.random(),r=t-e;return i<=(n-e)/r?e+Math.sqrt(i*r*(n-e)):t-Math.sqrt((1-i)*r*(t-n))},e.PI=3.1415927,e.PI2=2*e.PI,e.radiansToDegrees=180/e.PI,e.radDeg=e.radiansToDegrees,e.degreesToRadians=e.PI/180,e.degRad=e.degreesToRadians,e}();e.MathUtils=i;var r=function(){function e(){}return e.prototype.apply=function(e,t,n){return e+(t-e)*this.applyInternal(n)},e}();e.Interpolation=r;var a=function(e){function t(t){var n=e.call(this)||this;return n.power=2,n.power=t,n}return E6(t,e),t.prototype.applyInternal=function(e){return e<=.5?Math.pow(2*e,this.power)/2:Math.pow(2*(e-1),this.power)/(this.power%2==0?-2:2)+1},t}(r);e.Pow=a;var o=function(e){function t(t){return e.call(this,t)||this}return E6(t,e),t.prototype.applyInternal=function(e){return Math.pow(e-1,this.power)*(this.power%2==0?-1:1)+1},t}(a);e.PowOut=o;var s=function(){function e(){}return e.arrayCopy=function(e,t,n,i,r){for(var a=t,o=i;a<t+r;a++,o++)n[o]=e[a]},e.setArraySize=function(e,t,n){void 0===n&&(n=0);var i=e.length;if(i==t)return e;if(e.length=t,i<t)for(var r=i;r<t;r++)e[r]=n;return e},e.ensureArrayCapacity=function(t,n,i){return void 0===i&&(i=0),t.length>=n?t:e.setArraySize(t,n,i)},e.newArray=function(e,t){for(var n=new Array(e),i=0;i<e;i++)n[i]=t;return n},e.newFloatArray=function(t){if(e.SUPPORTS_TYPED_ARRAYS)return new Float32Array(t);for(var n=new Array(t),i=0;i<n.length;i++)n[i]=0;return n},e.newShortArray=function(t){if(e.SUPPORTS_TYPED_ARRAYS)return new Int16Array(t);for(var n=new Array(t),i=0;i<n.length;i++)n[i]=0;return n},e.toFloatArray=function(t){return e.SUPPORTS_TYPED_ARRAYS?new Float32Array(t):t},e.toSinglePrecision=function(t){return e.SUPPORTS_TYPED_ARRAYS?Math.fround(t):t},e.webkit602BugfixHelper=function(){},e.contains=function(e,t){for(var n=0;n<e.length;n++)if(e[n]==t)return!0;return!1},e.SUPPORTS_TYPED_ARRAYS="undefined"!=typeof Float32Array,e}();e.Utils=s;var c=function(){function e(){}return e.logBones=function(e){for(var t=0;t<e.bones.length;t++){var n=e.bones[t];console.log(n.data.name+", "+n.a+", "+n.b+", "+n.c+", "+n.d+", "+n.worldX+", "+n.worldY)}},e}();e.DebugUtils=c;var l=function(){function e(e){this.items=new Array,this.instantiator=e}return e.prototype.obtain=function(){return this.items.length>0?this.items.pop():this.instantiator()},e.prototype.free=function(e){e.reset&&e.reset(),this.items.push(e)},e.prototype.freeAll=function(e){for(var t=0;t<e.length;t++)e[t].reset&&e[t].reset(),this.items[t]=e[t]},e.prototype.clear=function(){this.items.length=0},e}();e.Pool=l;var u=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.x=e,this.y=t}return e.prototype.set=function(e,t){return this.x=e,this.y=t,this},e.prototype.length=function(){var e=this.x,t=this.y;return Math.sqrt(e*e+t*t)},e.prototype.normalize=function(){var e=this.length();return 0!=e&&(this.x/=e,this.y/=e),this},e}();e.Vector2=u;var h=function(){function e(){this.maxDelta=.064,this.framesPerSecond=0,this.delta=0,this.totalTime=0,this.lastTime=Date.now()/1e3,this.frameCount=0,this.frameTime=0}return e.prototype.update=function(){var e=Date.now()/1e3;this.delta=e-this.lastTime,this.frameTime+=this.delta,this.totalTime+=this.delta,this.delta>this.maxDelta&&(this.delta=this.maxDelta),this.lastTime=e,this.frameCount++,this.frameTime>1&&(this.framesPerSecond=this.frameCount/this.frameTime,this.frameTime=0,this.frameCount=0)},e}();e.TimeKeeper=h;var f=function(){function e(e){void 0===e&&(e=32),this.addedValues=0,this.lastValue=0,this.mean=0,this.dirty=!0,this.values=new Array(e)}return e.prototype.hasEnoughData=function(){return this.addedValues>=this.values.length},e.prototype.addValue=function(e){this.addedValues<this.values.length&&this.addedValues++,this.values[this.lastValue++]=e,this.lastValue>this.values.length-1&&(this.lastValue=0),this.dirty=!0},e.prototype.getMean=function(){if(this.hasEnoughData()){if(this.dirty){for(var e=0,t=0;t<this.values.length;t++)e+=this.values[t];this.mean=e/this.values.length,this.dirty=!1}return this.mean}return 0},e}();e.WindowedMean=f}(x6||(x6={})),Math.fround||(Math.fround=function(e){return function(t){return e[0]=t,e[0]}}(new Float32Array(1))),function(e){var t=function(e){if(null==e)throw new Error("name cannot be null.");this.name=e};e.Attachment=t;var n=function(t){function n(e){var i=t.call(this,e)||this;return i.id=(65535&n.nextID++)<<11,i.worldVerticesLength=0,i.deformAttachment=i,i}return E6(n,t),n.prototype.computeWorldVertices=function(e,t,n,i,r,a){n=r+(n>>1)*a;var o=e.bone.skeleton,s=e.deform,c=this.vertices,l=this.bones;if(null!=l){for(var u=0,h=0,f=0;f<t;f+=2)u+=(m=l[u])+1,h+=m;var _=o.bones;if(0==s.length)for(w=r,C=3*h;w<n;w+=a){var d=0,p=0,m=l[u++];for(m+=u;u<m;u++,C+=3){S=_[l[u]],P=c[C],R=c[C+1];var v=c[C+2];d+=(P*S.a+R*S.b+S.worldX)*v,p+=(P*S.c+R*S.d+S.worldY)*v}i[w]=d,i[w+1]=p}else for(var g=s,y=(w=r,C=3*h,h<<1);w<n;w+=a){for(d=0,p=0,m=l[u++],m+=u;u<m;u++,C+=3,y+=2)S=_[l[u]],P=c[C]+g[y],R=c[C+1]+g[y+1],v=c[C+2],d+=(P*S.a+R*S.b+S.worldX)*v,p+=(P*S.c+R*S.d+S.worldY)*v;i[w]=d,i[w+1]=p}}else{s.length>0&&(c=s);for(var S,x=(S=e.bone).worldX,E=S.worldY,T=S.a,C=S.b,A=S.c,b=S.d,I=t,w=r;w<n;I+=2,w+=a){var P=c[I],R=c[I+1];i[w]=P*T+R*C+x,i[w+1]=P*A+R*b+E}}},n.prototype.copyTo=function(t){null!=this.bones?(t.bones=new Array(this.bones.length),e.Utils.arrayCopy(this.bones,0,t.bones,0,this.bones.length)):t.bones=null,null!=this.vertices?(t.vertices=e.Utils.newFloatArray(this.vertices.length),e.Utils.arrayCopy(this.vertices,0,t.vertices,0,this.vertices.length)):t.vertices=null,t.worldVerticesLength=this.worldVerticesLength,t.deformAttachment=this.deformAttachment},n.nextID=0,n}(t);e.VertexAttachment=n}(x6||(x6={})),function(e){var t;(t=e.AttachmentType||(e.AttachmentType={}))[t.Region=0]="Region",t[t.BoundingBox=1]="BoundingBox",t[t.Mesh=2]="Mesh",t[t.LinkedMesh=3]="LinkedMesh",t[t.Path=4]="Path",t[t.Point=5]="Point",t[t.Clipping=6]="Clipping"}(x6||(x6={})),function(e){var t=function(t){function n(n){var i=t.call(this,n)||this;return i.color=new e.Color(1,1,1,1),i}return E6(n,t),n.prototype.copy=function(){var e=new n(name);return this.copyTo(e),e.color.setFromColor(this.color),e},n}(e.VertexAttachment);e.BoundingBoxAttachment=t}(x6||(x6={})),function(e){var t=function(t){function n(n){var i=t.call(this,n)||this;return i.color=new e.Color(.2275,.2275,.8078,1),i}return E6(n,t),n.prototype.copy=function(){var e=new n(name);return this.copyTo(e),e.endSlot=this.endSlot,e.color.setFromColor(this.color),e},n}(e.VertexAttachment);e.ClippingAttachment=t}(x6||(x6={})),function(e){var t=function(t){function n(n){var i=t.call(this,n)||this;return i.color=new e.Color(1,1,1,1),i.tempColor=new e.Color(0,0,0,0),i}return E6(n,t),n.prototype.updateUVs=function(){var t=this.regionUVs;null!=this.uvs&&this.uvs.length==t.length||(this.uvs=e.Utils.newFloatArray(t.length));var n=this.uvs,i=this.uvs.length,r=this.region.u,a=this.region.v,o=0,s=0;if(this.region instanceof e.TextureAtlasRegion){var c=this.region,l=c.texture.getImage().width,u=c.texture.getImage().height;switch(c.degrees){case 90:r-=(c.originalHeight-c.offsetY-c.height)/l,a-=(c.originalWidth-c.offsetX-c.width)/u,o=c.originalHeight/l,s=c.originalWidth/u;for(var h=0;h<i;h+=2)n[h]=r+t[h+1]*o,n[h+1]=a+(1-t[h])*s;return;case 180:for(r-=(c.originalWidth-c.offsetX-c.width)/l,a-=c.offsetY/u,o=c.originalWidth/l,s=c.originalHeight/u,h=0;h<i;h+=2)n[h]=r+(1-t[h])*o,n[h+1]=a+(1-t[h+1])*s;return;case 270:for(r-=c.offsetY/l,a-=c.offsetX/u,o=c.originalHeight/l,s=c.originalWidth/u,h=0;h<i;h+=2)n[h]=r+(1-t[h+1])*o,n[h+1]=a+t[h]*s;return}r-=c.offsetX/l,a-=(c.originalHeight-c.offsetY-c.height)/u,o=c.originalWidth/l,s=c.originalHeight/u}else null==this.region?(r=a=0,o=s=1):(o=this.region.u2-r,s=this.region.v2-a);for(h=0;h<i;h+=2)n[h]=r+t[h]*o,n[h+1]=a+t[h+1]*s},n.prototype.getParentMesh=function(){return this.parentMesh},n.prototype.setParentMesh=function(e){this.parentMesh=e,null!=e&&(this.bones=e.bones,this.vertices=e.vertices,this.worldVerticesLength=e.worldVerticesLength,this.regionUVs=e.regionUVs,this.triangles=e.triangles,this.hullLength=e.hullLength,this.worldVerticesLength=e.worldVerticesLength)},n.prototype.copy=function(){if(null!=this.parentMesh)return this.newLinkedMesh();var t=new n(this.name);return t.region=this.region,t.path=this.path,t.color.setFromColor(this.color),this.copyTo(t),t.regionUVs=new Array(this.regionUVs.length),e.Utils.arrayCopy(this.regionUVs,0,t.regionUVs,0,this.regionUVs.length),t.uvs=new Array(this.uvs.length),e.Utils.arrayCopy(this.uvs,0,t.uvs,0,this.uvs.length),t.triangles=new Array(this.triangles.length),e.Utils.arrayCopy(this.triangles,0,t.triangles,0,this.triangles.length),t.hullLength=this.hullLength,null!=this.edges&&(t.edges=new Array(this.edges.length),e.Utils.arrayCopy(this.edges,0,t.edges,0,this.edges.length)),t.width=this.width,t.height=this.height,t},n.prototype.newLinkedMesh=function(){var e=new n(this.name);return e.region=this.region,e.path=this.path,e.color.setFromColor(this.color),e.deformAttachment=this.deformAttachment,e.setParentMesh(null!=this.parentMesh?this.parentMesh:this),e.updateUVs(),e},n}(e.VertexAttachment);e.MeshAttachment=t}(x6||(x6={})),function(e){var t=function(t){function n(n){var i=t.call(this,n)||this;return i.closed=!1,i.constantSpeed=!1,i.color=new e.Color(1,1,1,1),i}return E6(n,t),n.prototype.copy=function(){var t=new n(name);return this.copyTo(t),t.lengths=new Array(this.lengths.length),e.Utils.arrayCopy(this.lengths,0,t.lengths,0,this.lengths.length),t.closed=closed,t.constantSpeed=this.constantSpeed,t.color.setFromColor(this.color),t},n}(e.VertexAttachment);e.PathAttachment=t}(x6||(x6={})),function(e){var t=function(t){function n(n){var i=t.call(this,n)||this;return i.color=new e.Color(.38,.94,0,1),i}return E6(n,t),n.prototype.computeWorldPosition=function(e,t){return t.x=this.x*e.a+this.y*e.b+e.worldX,t.y=this.x*e.c+this.y*e.d+e.worldY,t},n.prototype.computeWorldRotation=function(t){var n=e.MathUtils.cosDeg(this.rotation),i=e.MathUtils.sinDeg(this.rotation),r=n*t.a+i*t.b,a=n*t.c+i*t.d;return Math.atan2(a,r)*e.MathUtils.radDeg},n.prototype.copy=function(){var e=new n(name);return e.x=this.x,e.y=this.y,e.rotation=this.rotation,e.color.setFromColor(this.color),e},n}(e.VertexAttachment);e.PointAttachment=t}(x6||(x6={})),function(e){var t=function(t){function n(n){var i=t.call(this,n)||this;return i.x=0,i.y=0,i.scaleX=1,i.scaleY=1,i.rotation=0,i.width=0,i.height=0,i.color=new e.Color(1,1,1,1),i.offset=e.Utils.newFloatArray(8),i.uvs=e.Utils.newFloatArray(8),i.tempColor=new e.Color(1,1,1,1),i}return E6(n,t),n.prototype.updateOffset=function(){var e=this.width/this.region.originalWidth*this.scaleX,t=this.height/this.region.originalHeight*this.scaleY,i=-this.width/2*this.scaleX+this.region.offsetX*e,r=-this.height/2*this.scaleY+this.region.offsetY*t,a=i+this.region.width*e,o=r+this.region.height*t,s=this.rotation*Math.PI/180,c=Math.cos(s),l=Math.sin(s),u=i*c+this.x,h=i*l,f=r*c+this.y,_=r*l,d=a*c+this.x,p=a*l,m=o*c+this.y,v=o*l,g=this.offset;g[n.OX1]=u-_,g[n.OY1]=f+h,g[n.OX2]=u-v,g[n.OY2]=m+h,g[n.OX3]=d-v,g[n.OY3]=m+p,g[n.OX4]=d-_,g[n.OY4]=f+p},n.prototype.setRegion=function(e){this.region=e;var t=this.uvs;e.rotate?(t[2]=e.u,t[3]=e.v2,t[4]=e.u,t[5]=e.v,t[6]=e.u2,t[7]=e.v,t[0]=e.u2,t[1]=e.v2):(t[0]=e.u,t[1]=e.v2,t[2]=e.u,t[3]=e.v,t[4]=e.u2,t[5]=e.v,t[6]=e.u2,t[7]=e.v2)},n.prototype.computeWorldVertices=function(e,t,i,r){var a=this.offset,o=e.worldX,s=e.worldY,c=e.a,l=e.b,u=e.c,h=e.d,f=0,_=0;f=a[n.OX1],_=a[n.OY1],t[i]=f*c+_*l+o,t[i+1]=f*u+_*h+s,i+=r,f=a[n.OX2],_=a[n.OY2],t[i]=f*c+_*l+o,t[i+1]=f*u+_*h+s,i+=r,f=a[n.OX3],_=a[n.OY3],t[i]=f*c+_*l+o,t[i+1]=f*u+_*h+s,i+=r,f=a[n.OX4],_=a[n.OY4],t[i]=f*c+_*l+o,t[i+1]=f*u+_*h+s},n.prototype.copy=function(){var t=new n(name);return t.region=this.region,t.rendererObject=this.rendererObject,t.path=this.path,t.x=this.x,t.y=this.y,t.scaleX=this.scaleX,t.scaleY=this.scaleY,t.rotation=this.rotation,t.width=this.width,t.height=this.height,e.Utils.arrayCopy(this.uvs,0,t.uvs,0,8),e.Utils.arrayCopy(this.offset,0,t.offset,0,8),t.color.setFromColor(this.color),t},n.OX1=0,n.OY1=1,n.OX2=2,n.OY2=3,n.OX3=4,n.OY3=5,n.OX4=6,n.OY4=7,n.X1=0,n.Y1=1,n.C1R=2,n.C1G=3,n.C1B=4,n.C1A=5,n.U1=6,n.V1=7,n.X2=8,n.Y2=9,n.C2R=10,n.C2G=11,n.C2B=12,n.C2A=13,n.U2=14,n.V2=15,n.X3=16,n.Y3=17,n.C3R=18,n.C3G=19,n.C3B=20,n.C3A=21,n.U3=22,n.V3=23,n.X4=24,n.Y4=25,n.C4R=26,n.C4G=27,n.C4B=28,n.C4A=29,n.U4=30,n.V4=31,n}(e.Attachment);e.RegionAttachment=t}(x6||(x6={})),function(e){var t=function(){function t(e,t){this.jitterX=0,this.jitterY=0,this.jitterX=e,this.jitterY=t}return t.prototype.begin=function(){},t.prototype.transform=function(t){t.x+=e.MathUtils.randomTriangular(-this.jitterX,this.jitterY),t.y+=e.MathUtils.randomTriangular(-this.jitterX,this.jitterY)},t.prototype.end=function(){},t}();e.JitterEffect=t}(x6||(x6={})),function(e){var t=function(){function t(e,t){this.centerX=0,this.centerY=0,this.radius=0,this.angle=0,this.worldX=0,this.worldY=0,this.radius=e,this.interpolation=t}return t.prototype.begin=function(e){this.worldX=e.x+this.centerX,this.worldY=e.y+this.centerY},t.prototype.transform=function(t){var n=this.angle*e.MathUtils.degreesToRadians,i=t.x-this.worldX,r=t.y-this.worldY,a=Math.sqrt(i*i+r*r);if(a<this.radius){var o=this.interpolation.apply(0,n,(this.radius-a)/this.radius),s=Math.cos(o),c=Math.sin(o);t.x=s*i-c*r+this.worldX,t.y=c*i+s*r+this.worldY}},t.prototype.end=function(){},t.interpolation=new e.PowOut(2),t}();e.SwirlEffect=t}(x6||(x6={}));var T6,C6,A6,b6,I6,w6,P6=x6,R6=function(){function e(){this.start=void 0,this.interrupt=void 0,this.end=void 0,this.dispose=void 0,this.complete=void 0,this.event=void 0}return e.getListeners=function(t){return t.listener||(t.listener=new e),t.listener},e}(),D6=1/60,O6=[],N6=[],M6=0,L6=0,F6=0,B6=null,z6=null,U6=0,k6=0,G6=0,H6=0,V6=null,W6=null,j6=0,X6=0,q6=new P6.Color(1,1,1,1),Y6=new P6.Color(1,1,1,1),K6=[0,1,2,2,3,0],Q6=function(){function e(){this.frames=[],this.totalTime=0,this.isCompleted=!1,this.maxVertexCount=0,this.maxIndexCount=0,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this._frameIdx=-1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this._frameIdx=-1,this.isCompleted=!1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}var t=e.prototype;return t.init=function(e,t){this._inited=!0,this._animationName=t,this._skeletonInfo=e},t.clear=function(){this._inited=!1;for(var e=0,t=this.frames.length;e<t;e++)this.frames[e].segments.length=0;this.invalidAllFrame()},t.bind=function(e){var t=this;e.complete=function(e){e&&e.animation.name===t._animationName&&(t.isCompleted=!0)}},t.unbind=function(e){e.complete=null},t.begin=function(){if(this._invalid){var e=this._skeletonInfo,t=null==e?void 0:e.curAnimationCache;t&&t!==this&&(this._privateMode?t.invalidAllFrame():t.updateToFrame());var n=null==e?void 0:e.skeleton,i=null==e?void 0:e.listener,r=null==e?void 0:e.state,a=null==n?void 0:n.data.findAnimation(this._animationName);null==r||r.setAnimationWith(0,a,!1),this.bind(i),e.curAnimationCache=this,this._frameIdx=-1,this.isCompleted=!1,this.totalTime=0,this._invalid=!1}},t.end=function(){this.needToUpdate()||(this._skeletonInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0,this.unbind(this._skeletonInfo.listener))},t.updateToFrame=function(e){if(this._inited&&(this.begin(),this.needToUpdate(e))){var t=this._skeletonInfo,n=null==t?void 0:t.skeleton,i=null==t?void 0:t.clipper,r=null==t?void 0:t.state;do{null==n||n.update(D6),null==r||r.update(D6),null==r||r.apply(n),null==n||n.updateWorldTransform(),this._frameIdx++,this.updateFrame(n,i,this._frameIdx),this.totalTime+=D6}while(this.needToUpdate(e));this.end()}},t.isInited=function(){return this._inited},t.isInvalid=function(){return this._invalid},t.invalidAllFrame=function(){this.isCompleted=!1,this._invalid=!0},t.updateAllFrame=function(){this.invalidAllFrame(),this.updateToFrame()},t.enableCacheAttachedInfo=function(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())},t.fillVertices=function(e,t,n,i,r){if(b6=n.a*t.a*e.a*255,T6=t.r*e.r*255,C6=t.g*e.g*255,A6=t.b*e.b*255,q6.r=T6*n.r,q6.g=C6*n.g,q6.b=A6*n.b,q6.a=b6,null==r.darkColor?Y6.set(0,0,0,1):(Y6.r=r.darkColor.r*T6,Y6.g=r.darkColor.g*C6,Y6.b=r.darkColor.b*A6),Y6.a=0,I6=(q6.a<<24>>>0)+(q6.b<<16)+(q6.g<<8)+q6.r,w6=(Y6.a<<24>>>0)+(Y6.b<<16)+(Y6.g<<8)+Y6.r,V6!==I6||W6!==w6){var a=this._tempColors;V6=I6,W6=w6,H6>0&&(a[H6-1].vfOffset=F6),a[H6++]={fr:q6.r,fg:q6.g,fb:q6.b,fa:q6.a,dr:Y6.r,dg:Y6.g,db:Y6.b,da:Y6.a,vfOffset:0}}if(i.isClipping()){i.clipTriangles(O6,j6,N6,X6,O6,q6,Y6,!0,6,F6,F6+2);var o=i.clippedVertices,s=i.clippedTriangles;X6=s.length,j6=o.length/12*6;for(var c=0,l=L6,u=s.length;c<u;)N6[l++]=s[c++];for(var h=0,f=o.length,_=F6;h<f;h+=12,_+=6)O6[_]=o[h],O6[_+1]=o[h+1],O6[_+2]=o[h+6],O6[_+3]=o[h+7],O6[_+4]=I6,O6[_+5]=w6}else for(var d=F6,p=F6+j6;d<p;d+=6)O6[d+4]=I6,O6[d+5]=w6},t.updateFrame=function(e,t,n){F6=0,M6=0,L6=0,B6=null,z6=null,U6=0,k6=0,G6=0,H6=0,V6=null,W6=null,this.frames[n]=this.frames[n]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};var i=this.frames[n],r=this._tempSegments=i.segments,a=this._tempColors=i.colors,o=this._tempBoneInfos=i.boneInfos;this.traverseSkeleton(e,t),H6>0&&(a[H6-1].vfOffset=F6),a.length=H6,o.length=M6;var s=G6-1;if(s>=0)if(k6>0){var c=r[s];c.indexCount=k6,c.vfCount=13*U6,c.vertexCount=U6,r.length=G6}else r.length=G6-1;if(0!==r.length){var l=i.vertices,u=F6/6,h=13*u;(!l||l.length<h)&&(l=i.vertices=new Float32Array(h));for(var f=0,_=0;f<h;)l[f]=O6[_++],l[f+1]=O6[_++],l[f+3]=O6[_++],l[f+4]=O6[_++],this._setVerticeColor(O6[_++],l,f+5),this._setVerticeColor(O6[_++],l,f+9),f+=13;var d=i.indices;(!d||d.length<L6)&&(d=i.indices=new Uint16Array(L6));for(var p=0;p<L6;p++)d[p]=N6[p];i.vertices=l,i.indices=d,this.maxVertexCount=u>this.maxVertexCount?u:this.maxVertexCount,this.maxIndexCount=d.length>this.maxIndexCount?d.length:this.maxIndexCount}},t.needToUpdate=function(e){return!this.isCompleted&&this.totalTime<30&&(void 0===e||this._frameIdx<e)},t.traverseSkeleton=function(e,t){var n,i,r,a,o,s,c,l,u,h,f,_,d=this._tempSegments,p=this._tempBoneInfos,m=e.color,v=e.bones;if(this._enableCacheAttachedInfo)for(var g=0,y=v.length;g<y;g++,M6++){var S=v[g],x=p[M6];x||(x=p[M6]={}),x.a=S.a,x.b=S.b,x.c=S.c,x.d=S.d,x.worldX=S.worldX,x.worldY=S.worldY}for(var E=0,T=e.drawOrder.length;E<T;E++)if((_=e.drawOrder[E]).bone.active)if(j6=0,X6=0,n=_.getAttachment())if(s=n instanceof P6.RegionAttachment,c=n instanceof P6.MeshAttachment,n instanceof P6.ClippingAttachment)t.clipStart(_,n);else if(s||c)if(l=n.region.texture.getRealTexture()){if(f=_.data.blendMode,B6===l.getId()&&z6===f||(B6=l.getId(),z6=f,(u=G6-1)>=0&&(k6>0?((h=d[u]).indexCount=k6,h.vertexCount=U6,h.vfCount=13*U6):G6--),d[G6]={tex:l,blendMode:f,indexCount:0,vertexCount:0,vfCount:0},G6++,k6=0,U6=0),s)o=K6,j6=24,X6=6,n.computeWorldVertices(_.bone,O6,F6,6);else if(c){var C=n;o=C.triangles,j6=6*(C.worldVerticesLength>>1),X6=o.length,C.computeWorldVertices(_,0,C.worldVerticesLength,O6,F6,6)}if(0!==j6&&0!==X6){for(var A=0,b=L6,I=o.length;A<I;)N6[b++]=o[A++];a=n.uvs;for(var w=F6,P=F6+j6,R=0;w<P;w+=6,R+=2)O6[w+2]=a[R],O6[w+3]=a[R+1];if(i=n.color,r=_.color,this.fillVertices(m,i,r,t,_),X6>0){for(var D=L6,O=L6+X6;D<O;D++)N6[D]+=U6;L6+=X6,F6+=j6,k6+=X6,U6+=j6/6}t.clipEndWithSlot(_)}else t.clipEndWithSlot(_)}else t.clipEndWithSlot(_);else t.clipEndWithSlot(_);else t.clipEndWithSlot(_);t.clipEnd()},t._setVerticeColor=function(e,t,n){t[n]=(255&e)/255,t[n+1]=(e>>8&255)/255,t[n+2]=(e>>16&255)/255,t[n+3]=(e>>24&255)/255},e}(),J6=function(){function e(){this._privateMode=void 0,this._skeletonCache=void 0,this._animationPool=void 0,this._privateMode=!1,this._animationPool={},this._skeletonCache={}}var t=e.prototype;return t.enablePrivateMode=function(){this._privateMode=!0},t.clear=function(){this._animationPool={},this._skeletonCache={}},t.removeSkeleton=function(e){var t=this._skeletonCache[e];if(t){var n=t.animationsCache;for(var i in n){var r=n[i];r&&(this._animationPool[e+"#"+i]=r,r.clear())}delete this._skeletonCache[e]}},t.getSkeletonCache=function(e,t){var n=this._skeletonCache[e];if(!n){var i=new P6.Skeleton(t),r=new P6.SkeletonClipping,a=new P6.AnimationStateData(i.data),o=new P6.AnimationState(a),s=new R6;o.addListener(s),this._skeletonCache[e]=n={skeleton:i,clipper:r,state:o,listener:s,animationsCache:{},curAnimationCache:null}}return n},t.getAnimationCache=function(e,t){var n=this._skeletonCache[e];return n?n.animationsCache[t]:null},t.invalidAnimationCache=function(e){var t=this._skeletonCache[e];if(t&&t.skeleton){var n=t.animationsCache;for(var i in n)n[i].invalidAllFrame()}},t.initAnimationCache=function(e,t){if(!t)return null;var n=this._skeletonCache[e],i=n&&n.skeleton;if(!i)return null;if(!i.data.findAnimation(t))return null;var r=n.animationsCache,a=r[t];if(!a){var o=e+"#"+t;(a=this._animationPool[o])?delete this._animationPool[o]:(a=new Q6)._privateMode=this._privateMode,a.init(n,t),r[t]=a}return a},t.updateAnimationCache=function(e,t){if(t){var n=this.initAnimationCache(e,t);if(!n)return;n.updateAllFrame()}else{var i=this._skeletonCache[e];if(!i||!i.skeleton)return;var r=i.animationsCache;for(var a in r)r[a].updateAllFrame()}},e}();J6.FrameTime=D6,J6.sharedCache=new J6;var Z6,$6,e7,t7,n7,i7,r7,a7,o7,s7,c7,l7=new Wn,u7=function(){function e(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null,this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}var t=e.prototype;return t.init=function(e){this._inited=!0,this._skeleton=e._skeleton,this._skeletonNode=e.node,this._skeletonComp=e},t.reset=function(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null},t._syncAttachedNode=function(){if(this._inited){var e=this._skeletonComp.socketNodes;if(0!==e.size){var t;if(t=this._skeletonComp.isAnimationCached()?this._skeletonComp._curFrame&&this._skeletonComp._curFrame.boneInfos:this._skeleton.bones)for(var n,i=function(e,t){var n=l7;n.m00=t.a,n.m01=t.c,n.m04=t.b,n.m05=t.d,n.m12=t.worldX,n.m13=t.worldY,e.matrix=l7},r=oe(e.keys());!(n=r()).done;){var a=n.value,o=e.get(a);if(o&&o.isValid){var s=t[a];s?i(o,s):(o.removeFromParent(),o.destroy(),e.delete(a))}else e.delete(a)}}}},e}(),h7=function(e){function t(t){var n;return(n=e.call(this,t)||this).name="sp.SkeletonTexture",n._texture=null,n._material=null,n}Z(t,e);var n=t.prototype;return n.setRealTexture=function(e){this._texture=e},n.getRealTexture=function(){return this._texture},n.setFilters=function(e,t){this._texture&&this.getRealTexture().setFilters(f7(e),f7(t))},n.setWraps=function(e,t){this._texture&&this.getRealTexture().setWrapMode(_7(e),_7(t))},n.dispose=function(){},t}(P6.Texture);function f7(e){switch(e){case P6.TextureFilter.Nearest:case P6.TextureFilter.MipMapNearestNearest:case P6.TextureFilter.MipMapLinearNearest:return xm.NEAREST;case P6.TextureFilter.MipMap:case P6.TextureFilter.MipMapNearestLinear:case P6.TextureFilter.MipMapLinearLinear:case P6.TextureFilter.Linear:default:return xm.LINEAR}}function _7(e){switch(e){case P6.TextureWrap.MirroredRepeat:return Sm.MIRRORED_REPEAT;case P6.TextureWrap.ClampToEdge:return Sm.CLAMP_TO_EDGE;case P6.TextureWrap.Repeat:default:return Sm.REPEAT}}var d7=(Z6=Tc("sp.SkeletonData"),$6=al([hv]),e7=al([Mt]),Z6((c7=function(e){function t(){var t;return se(t=e.call(this)||this,"_skeletonJson",i7,re(t)),se(t,"textures",r7,re(t)),se(t,"textureNames",a7,re(t)),se(t,"scale",o7,re(t)),se(t,"_atlasText",s7,re(t)),t._buffer=void 0,t._skeletonCache=null,t._atlasCache=null,t._skinsEnum=null,t._animsEnum=null,t.reset(),t}Z(t,e);var n=t.prototype;return n.createNode=function(e){var t=new ib(this.name);return t.addComponent("cc.Skeleton").skeletonData=this,e(null,t)},n.reset=function(){this._skeletonCache=null,this._atlasCache=null},n.resetEnums=function(){},n.getRuntimeData=function(e){if(this._skeletonCache)return this._skeletonCache;if(!(this.textures&&this.textures.length>0)&&this.textureNames&&this.textureNames.length>0)return e||console.error(this.name+" no textures found!"),null;var t=this._getAtlas(e);if(!t)return null;var n=new P6.AtlasAttachmentLoader(t),i=null,r=null;return this.skeletonJson?(r=new P6.SkeletonJson(n),i=this.skeletonJson):(r=new P6.SkeletonBinary(n),i=new Uint8Array(this._nativeAsset)),r.scale=this.scale,this._skeletonCache=r.readSkeletonData(i),t.dispose(),this._skeletonCache},n.getSkinsEnum=function(){if(this._skinsEnum)return this._skinsEnum;var e=this.getRuntimeData(!0);if(e){for(var t=e.skins,n={},i=0;i<t.length;i++)n[t[i].name]=i;return this._skinsEnum=rt(n)}return null},n.getAnimsEnum=function(){if(this._animsEnum&&Object.keys(this._animsEnum).length>1)return this._animsEnum;var e=this.getRuntimeData(!0);if(e){for(var t={"<None>":0},n=e.animations,i=0;i<n.length;i++)t[n[i].name]=i+1;return this._animsEnum=rt(t)}return null},n.destroy=function(){return J6.sharedCache.removeSkeleton(this._uuid),e.prototype.destroy.call(this)},n._getTexture=function(e){for(var t=this.textureNames,n=0;n<t.length;n++)if(t[n]===e){var i=this.textures[n],r=new h7({width:i.width,height:i.height});return r.setRealTexture(i),r}return console.error(this.name+" no textures found!"),null},n._getAtlas=function(e){return this._atlasCache?this._atlasCache:this.atlasText?this._atlasCache=new P6.TextureAtlas(this.atlasText,this._getTexture.bind(this)):(e||console.error(this.name+" no atlas found!"),null)},Q(t,[{key:"skeletonJsonStr",get:function(){return this._skeletonJson?JSON.stringify(this._skeletonJson):""}},{key:"skeletonJson",get:function(){return this._skeletonJson},set:function(e){this.reset(),this._skeletonJson="string"==typeof e?JSON.parse(e):e,!this._uuid&&e.skeleton&&(this._uuid=e.skeleton.hash)}},{key:"atlasText",get:function(){return this._atlasText},set:function(e){this._atlasText=e,this.reset()}},{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){this._buffer=e,this.reset()}}]),t}(wu),i7=ce((n7=c7).prototype,"_skeletonJson",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r7=ce(n7.prototype,"textures",[Dc,$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a7=ce(n7.prototype,"textureNames",[Dc,e7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),o7=ce(n7.prototype,"scale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),s7=ce(n7.prototype,"_atlasText",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),t7=n7))||t7);l.internal.SpineSkeletonData=d7;var p7,m7,v7,g7,y7,S7,x7,E7,T7,C7,A7,b7,I7,w7,P7,R7,D7,O7,N7,M7,L7,F7,B7,z7,U7,k7,G7,H7,V7,W7,j7,X7,q7,Y7,K7,Q7,J7,Z7,$7,e9,t9,n9,i9,r9,a9,o9,s9,c9,l9,u9,h9,f9,_9,d9,p9,m9=function(e){function t(){var t;return(t=e.call(this)||this)._skeletons=new Set,t}Z(t,e),t.getInstance=function(){return t._instance||(t._instance=new t,nN.registerSystem(t.ID,t._instance,HO.Priority.HIGH)),t._instance};var n=t.prototype;return n.add=function(e){e&&(this._skeletons.has(e)||this._skeletons.add(e))},n.remove=function(e){e&&this._skeletons.has(e)&&this._skeletons.delete(e)},n.postUpdate=function(e){this._skeletons&&this._skeletons.forEach((function(t){t.updateAnimation(e)}))},t}(HO);function v9(e,t,n){Zt.Attr.setClassAttr(e,t,"type","Enum"),Zt.Attr.setClassAttr(e,t,"enumList",rt.getList(n))}m9.ID="SKELETON",m9._instance=void 0,function(e){e[e.default=0]="default"}(f9||(f9={})),st(f9),function(e){e[e["<None>"]=0]="<None>"}(_9||(_9={})),st(_9),function(e){e[e.REALTIME=0]="REALTIME",e[e.SHARED_CACHE=1]="SHARED_CACHE",e[e.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(d9||(d9={})),st(d9),function(e){e[e.COLORED_TEXTURED=0]="COLORED_TEXTURED",e[e.TWO_COLORED=1]="TWO_COLORED"}(p9||(p9={}));var g9=(p7=Tc("sp.Skeleton.SpineSocket"),m7=al(ib),p7((y7=ce((g7=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),se(this,"path",y7,this),se(this,"target",S7,this),this.path=e,this.target=t}).prototype,"path",[Dc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),S7=ce(g7.prototype,"target",[m7,Hc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v7=g7))||v7);nt.setClassAlias(g9,"sp.Skeleton.SpineSocket");var y9=(x7=Tc("sp.Skeleton"),E7=Gc(),T7=Bc(),C7=al(Qv),A7=Zc(),b7=jc(),I7=al(d7),w7=jc(),P7=al(f9),R7=Xc(),D7=jc(),O7=al(_9),N7=Xc(),M7=jc(),L7=Xc(),F7=al(d9),B7=Xc(),z7=Xc(),U7=Xc(),k7=Xc(),G7=Xc(),H7=Xc(),V7=Xc(),W7=al([g9]),j7=Xc(),X7=Vc(),q7=Vc(),x7(Y7=E7(Y7=T7(Y7=Fc((h9=u9=function(e){function t(){var t;return se(t=e.call(this)||this,"loop",Q7,re(t)),t._frameCache=null,t._curFrame=null,t._effectDelegate=null,t._skeleton=void 0,t._clipper=void 0,t._debugRenderer=void 0,t._startSlotIndex=void 0,t._endSlotIndex=void 0,t._startEntry=void 0,t._endEntry=void 0,t.attachUtil=void 0,t.maxVertexCount=0,t.maxIndexCount=0,t._materialCache={},t._enumSkins=rt({}),t._enumAnimations=rt({}),t._playTimes=0,se(t,"_timeScale",J7,re(t)),t._paused=!1,t._accTime=0,t._playCount=0,t._skeletonCache=null,t._animationName="",t._animationQueue=[],t._headAniInfo=null,t._isAniComplete=!0,t._needUpdateSkeltonData=!0,se(t,"_useTint",Z7,re(t)),se(t,"_preCacheMode",$7,re(t)),se(t,"_cacheMode",e9,re(t)),se(t,"_defaultCacheMode",t9,re(t)),se(t,"_debugBones",n9,re(t)),se(t,"_debugSlots",i9,re(t)),se(t,"_skeletonData",r9,re(t)),se(t,"_premultipliedAlpha",a9,re(t)),se(t,"defaultSkin",o9,re(t)),se(t,"defaultAnimation",s9,re(t)),se(t,"_sockets",c9,re(t)),t._drawIdx=0,t._drawList=new Wl((function(){return{material:null,texture:null,indexOffset:0,indexCount:0}}),1),se(t,"_debugMesh",l9,re(t)),t._rootBone=void 0,t._state=void 0,t._listener=void 0,t._socketNodes=new Map,t._cachedSockets=new Map,t._effectDelegate=null,t._skeleton=null,t._rootBone=null,t._listener=null,t._debugRenderer=null,t._startSlotIndex=-1,t._endSlotIndex=-1,t._startEntry={animation:{name:""},trackIndex:0},t._endEntry={animation:{name:""},trackIndex:0},t.attachUtil=new u7,v9(re(t),"_defaultSkinIndex",t._enumSkins),v9(re(t),"_animationIndex",t._enumAnimations),t._useVertexOpacity=!0,t}Z(t,e);var n=t.prototype;return n.setSkeletonData=function(e){var t=this.node._uiProps.uiTransformComp;if(null!=e.width&&null!=e.height&&t.setContentSize(e.width,e.height),this._cacheMode===d9.SHARED_CACHE?this._skeletonCache=J6.sharedCache:this._cacheMode===d9.PRIVATE_CACHE&&(this._skeletonCache=new J6,this._skeletonCache.enablePrivateMode()),this.isAnimationCached()){(this.debugBones||this.debugSlots)&&S("Debug bones or slots is invalid in cached mode");var n=this._skeletonCache.getSkeletonCache(this.skeletonData._uuid,e);this._skeleton=n.skeleton,this._clipper=n.clipper,this._rootBone=this._skeleton.getRootBone()}else this._skeleton=new P6.Skeleton(e),this._clipper=new P6.SkeletonClipping,this._rootBone=this._skeleton.getRootBone();this._flushAssembler()},n.setSlotsRange=function(e,t){this.isAnimationCached()?S("Slots visible range can not be modified in cached mode."):(this._startSlotIndex=e,this._endSlotIndex=t)},n.setAnimationStateData=function(e){if(this.isAnimationCached())S("'setAnimationStateData' interface can not be invoked in cached mode.");else{var t=new P6.AnimationState(e);this._listener&&(this._state&&this._state.removeListener(this._listener),t.addListener(this._listener)),this._state=t}},n.__preload=function(){e.prototype.__preload.call(this);for(var t=this.node.children,n=0,i=t.length;n<i;n++){var r=t[n];r&&"DEBUG_DRAW_NODE"===r.name&&r.destroy()}this._updateSkeletonData(),this._updateDebugDraw(),this._updateUseTint(),this._indexBoneSockets(),this._updateSocketBindings()},n.setAnimationCacheMode=function(e){this._preCacheMode!==e&&(this._cacheMode=e,this._needUpdateSkeltonData=!0,this._updateSkeletonData(),this._updateUseTint(),this._updateSocketBindings(),this.markForUpdateRenderData())},n.isAnimationCached=function(){return this._cacheMode!==d9.REALTIME},n.updateAnimation=function(e){if(this.markForUpdateRenderData(),!this.paused)if(e*=1*this._timeScale,this.isAnimationCached()){if(this._isAniComplete){if(0===this._animationQueue.length&&!this._headAniInfo){var t=this._frameCache;if(t&&t.isInvalid()){t.updateToFrame();var n=t.frames;this._curFrame=n[n.length-1]}return}if(this._headAniInfo||(this._headAniInfo=this._animationQueue.shift()),this._accTime+=e,this._accTime>this._headAniInfo.delay){var i=this._headAniInfo;this._headAniInfo=null,this.setAnimation(0,i.animationName,i.loop)}return}this._updateCache(e)}else this._updateRealtime(e)},n.setVertexEffectDelegate=function(e){this._effectDelegate=e},n.setToSetupPose=function(){this._skeleton&&this._skeleton.setToSetupPose()},n.setBonesToSetupPose=function(){this._skeleton&&this._skeleton.setBonesToSetupPose()},n.setSlotsToSetupPose=function(){this._skeleton&&this._skeleton.setSlotsToSetupPose()},n.updateAnimationCache=function(e){if(this.isAnimationCached()){var t=this._skeletonData._uuid;this._skeletonCache&&this._skeletonCache.updateAnimationCache(t,e)}},n.invalidAnimationCache=function(){this.isAnimationCached()&&this._skeletonCache&&this._skeletonCache.invalidAnimationCache(this._skeletonData._uuid)},n.findBone=function(e){return this._skeleton?this._skeleton.findBone(e):null},n.findSlot=function(e){return this._skeleton?this._skeleton.findSlot(e):null},n.setSkin=function(e){this._skeleton&&(this._skeleton.setSkinByName(e),this._skeleton.setSlotsToSetupPose()),this.invalidAnimationCache()},n.getAttachment=function(e,t){return this._skeleton?this._skeleton.getAttachmentByName(e,t):null},n.setAttachment=function(e,t){this._skeleton&&this._skeleton.setAttachment(e,t),this.invalidAnimationCache()},n.getTextureAtlas=function(e){return e.region},n.setMix=function(e,t,n){this._state&&this._state.data.setMix(e,t,n)},n.setAnimation=function(e,t,n){if(this._playTimes=n?0:1,this._animationName=t,this.isAnimationCached()){if(0!==e&&S("Track index can not greater than 0 in cached mode."),!this._skeletonCache)return null;var i=this._skeletonCache.getAnimationCache(this._skeletonData._uuid,t);i||(i=this._skeletonCache.initAnimationCache(this._skeletonData._uuid,t)),i&&(this._isAniComplete=!1,this._accTime=0,this._playCount=0,this._frameCache=i,this._socketNodes.size>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._curFrame=this._frameCache.frames[0])}else if(this._skeleton){var r=this._skeleton.data.findAnimation(t);if(!r)return w(7509,t),null;var a=this._state.setAnimationWith(e,r,n);return this._state.apply(this._skeleton),a}return null},n.addAnimation=function(e,t,n,i){if(i=i||0,this.isAnimationCached())0!==e&&S("Track index can not greater than 0 in cached mode."),this._animationQueue.push({animationName:t,loop:n,delay:i});else if(this._skeleton){var r,a=this._skeleton.data.findAnimation(t);return a?null===(r=this._state)||void 0===r?void 0:r.addAnimationWith(e,a,n,i):(w(7510,t),null)}return null},n.findAnimation=function(e){return this._skeleton?this._skeleton.data.findAnimation(e):null},n.getCurrent=function(e){if(this.isAnimationCached())S("'getCurrent' interface can not be invoked in cached mode.");else if(this._state)return this._state.getCurrent(e);return null},n.clearTracks=function(){this.isAnimationCached()?S("'clearTracks' interface can not be invoked in cached mode."):this._state&&(this._state.clearTracks(),this.setToSetupPose())},n.clearTrack=function(e){this.isAnimationCached()?S("'clearTrack' interface can not be invoked in cached mode."):this._state&&this._state.clearTrack(e)},n.setStartListener=function(e){this._ensureListener(),this._listener.start=e},n.setInterruptListener=function(e){this._ensureListener(),this._listener.interrupt=e},n.setEndListener=function(e){this._ensureListener(),this._listener.end=e},n.setDisposeListener=function(e){this._ensureListener(),this._listener.dispose=e},n.setCompleteListener=function(e){this._ensureListener(),this._listener.complete=e},n.setEventListener=function(e){this._ensureListener(),this._listener.event=e},n.setTrackStartListener=function(e,t){R6.getListeners(e).start=t},n.setTrackInterruptListener=function(e,t){R6.getListeners(e).interrupt=t},n.setTrackEndListener=function(e,t){R6.getListeners(e).end=t},n.setTrackDisposeListener=function(e,t){R6.getListeners(e).dispose=t},n.setTrackCompleteListener=function(e,t){R6.getListeners(e).complete=function(e){var n=Math.floor(e.trackTime/e.animationEnd);t(e,n)}},n.setTrackEventListener=function(e,t){R6.getListeners(e).event=t},n.getState=function(){return this._state},n.onEnable=function(){e.prototype.onEnable.call(this),this._flushAssembler(),m9.getInstance().add(this)},n.onDisable=function(){e.prototype.onDisable.call(this),m9.getInstance().remove(this)},n.onDestroy=function(){this._cleanMaterialCache(),this._drawList.destroy(),e.prototype.onDestroy.call(this)},n.destroyRenderData=function(){this._drawList.reset(),e.prototype.destroyRenderData.call(this)},n.getMaterialForBlendAndTint=function(e,t,n){var i=n+"/"+e+"/"+t,r=this._materialCache[i];if(r)return r;var a=this.customMaterial;null===a&&(a=Sv.get("default-spine-material"));var o=!1;switch(n){case p9.TWO_COLORED:o=!0;break;case p9.COLORED_TEXTURED:}return r=new oy({parent:a,subModelIdx:0,owner:this}),this._materialCache[i]=r,r.overridePipelineStates({blendState:{blendColor:In.WHITE,targets:[{blendEq:Di.ADD,blendAlphaEq:Di.ADD,blendSrc:e,blendDst:t,blendSrcAlpha:e,blendDstAlpha:t}]}}),r.recompileShaders({TWO_COLORED:o,USE_LOCAL:!0}),r},n.onRestore=function(){this.updateMaterial(),this._renderFlag=this._canRender(),this.markForUpdateRenderData()},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._updateBlendFunc(),this._blendHash=-1},n.querySockets=function(){return this._skeleton?(0===this._cachedSockets.size&&this._indexBoneSockets(),this._cachedSockets.size>0?Array.from(this._cachedSockets.keys()).sort():[]):[]},n._requestDrawData=function(e,t,n,i){var r=this._drawList.add();return r.material=e,r.texture=t,r.indexOffset=n,r.indexCount=i,r},n._render=function(e){if(this._renderData&&this._drawList){var t=this._renderData,n=t.chunk,i=n.vertexAccessor,r=t.getMeshBuffer(),a=r.indexOffset;i.appendIndices(n.bufferId,t.indices);for(var o=0;o<this._drawList.length;o++){this._drawIdx=o;var s=this._drawList.data[o];if(s.texture){var c=r.requireFreeIA(e.device);c.firstIndex=a+s.indexOffset,c.indexCount=s.indexCount,e.commitIA(this,c,s.texture,s.material,this.node)}}}},n.updateWorldTransform=function(){this.isAnimationCached()&&this._skeleton&&this._skeleton.updateWorldTransform()},n._emitCacheCompleteEvent=function(){this._listener&&(this._endEntry.animation.name=this._animationName,this._listener.complete&&this._listener.complete(this._endEntry),this._listener.end&&this._listener.end(this._endEntry))},n._updateCache=function(e){var t=this._frameCache;if(t.isInited()){var n=t.frames,i=J6.FrameTime;0===this._accTime&&0===this._playCount&&(this._startEntry.animation.name=this._animationName,this._listener&&this._listener.start&&this._listener.start(this._startEntry)),this._accTime+=e;var r=Math.floor(this._accTime/i);if(t.isCompleted||(t.updateToFrame(r),this._renderData&&(this._renderData.vertexCount<t.maxVertexCount||this._renderData.indexCount<t.maxIndexCount)&&(this.maxVertexCount=t.maxVertexCount>this.maxVertexCount?t.maxVertexCount:this.maxVertexCount,this.maxIndexCount=t.maxIndexCount>this.maxIndexCount?t.maxIndexCount:this.maxIndexCount,this._renderData.resize(this.maxVertexCount,this.maxIndexCount),(!this._renderData.indices||this.maxIndexCount>this._renderData.indices.length)&&(this._renderData.indices=new Uint16Array(this.maxIndexCount)))),t.isCompleted&&r>=n.length){if(this._playCount++,this._playTimes>0&&this._playCount>=this._playTimes)return this._curFrame=n[n.length-1],this._accTime=0,this._playCount=0,this._isAniComplete=!0,void this._emitCacheCompleteEvent();this._accTime=0,r=0,this._emitCacheCompleteEvent()}this._curFrame=n[r]}},n._updateRealtime=function(e){var t=this._skeleton,n=this._state;t&&(t.update(e),n&&(n.update(e),n.apply(t)))},n._indexBoneSockets=function(){if(this._skeleton){this._cachedSockets.clear();for(var e=this._skeleton.bones,t=function t(n){return null==n.parent?n.data.name||"<Unamed>":t(e[n.parent.data.index])+"/"+n.data.name},n=0,i=e.length;n<i;n++){var r=e[n].data,a=t(e[n]);this._cachedSockets.set(a,r.index)}}},n._updateUseTint=function(){this._cleanMaterialCache(),this.destroyRenderData(),this._assembler&&this._skeleton&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},n._updateBatch=function(){this.markForUpdateRenderData()},n._updateAnimEnum=function(){var e;e=this.skeletonData?this.skeletonData.getAnimsEnum():_9,this._enumAnimations=rt({}),Object.assign(this._enumAnimations,e),rt.update(this._enumAnimations),v9(this,"_animationIndex",this._enumAnimations)},n._updateSkinEnum=function(){var e;e=this.skeletonData?this.skeletonData.getSkinsEnum():f9,this._enumSkins=rt({}),Object.assign(this._enumSkins,e),rt.update(this._enumSkins),v9(this,"_defaultSkinIndex",this._enumSkins)},n._ensureListener=function(){this._listener||(this._listener=new R6,this._state&&this._state.addListener(this._listener))},n._updateSkeletonData=function(){if(this.skeletonData&&!1!==this._needUpdateSkeltonData){this._needUpdateSkeltonData=!1;var e=this.skeletonData.getRuntimeData();if(e){try{this.setSkeletonData(e),this.isAnimationCached()||this.setAnimationStateData(new P6.AnimationStateData(this._skeleton.data)),this.defaultSkin&&this.setSkin(this.defaultSkin)}catch(e){S(e)}this._indexBoneSockets(),this.attachUtil.init(this),this._preCacheMode=this._cacheMode,this.animation=this.defaultAnimation}}},n._refreshInspector=function(){this._updateAnimEnum(),this._updateSkinEnum()},n._updateDebugDraw=function(){if(this.debugBones||this.debugSlots||this.debugMesh){if(!this._debugRenderer){var e=new ib("DEBUG_DRAW_NODE");e.hideFlags|=_l.Flags.DontSave|_l.Flags.HideInHierarchy;var t=e.addComponent(hG);t.lineWidth=1,t.strokeColor=new In(255,0,0,255),this._debugRenderer=t,e.parent=this.node}this.isAnimationCached()&&S("Debug bones or slots is invalid in cached mode")}else this._debugRenderer&&(this._debugRenderer.node.destroy(),this._debugRenderer=null)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._skeleton&&this._assembler&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())},n._updateSocketBindings=function(){if(this._skeleton){this._socketNodes.clear();for(var e=0,t=this._sockets.length;e<t;e++){var n=this._sockets[e];if(n.path&&n.target){var i=this._cachedSockets.get(n.path);if(!i){console.error("Skeleton data does not contain path "+n.path);continue}this._socketNodes.set(i,n.target)}}}},n._verifySockets=function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t].target;!i||i.parent&&i.parent===this.node||console.error("Target node "+i.name+" is expected to be a direct child of "+this.node.name)}var r=new Map;e.forEach((function(e){e.target&&(r.get(e.target)?console.error("Target node "+e.target.name+" has existed."):r.set(e.target,!0))}))},n._cleanMaterialCache=function(){for(var e in this._materialCache)this._materialCache[e].destroy();this._materialCache={}},Q(t,[{key:"drawList",get:function(){return this._drawList}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this._cleanMaterialCache()}},{key:"paused",get:function(){return this._paused},set:function(e){this._paused=e}},{key:"skeletonData",get:function(){return this._skeletonData},set:function(e){e&&e.resetEnums(),this._skeletonData!==e&&(this.destroyRenderData(),this._skeletonData=e,this._needUpdateSkeltonData=!0,this.defaultSkin="",this.defaultAnimation="",this._updateSkeletonData())}},{key:"animation",get:function(){if(this.isAnimationCached())return this._animationName;var e=this.getCurrent(0);return e&&e.animation.name||""},set:function(e){e?(this.setAnimation(0,e,this.loop),this.markForUpdateRenderData()):this.isAnimationCached()||(this.clearTrack(0),this.setToSetupPose())}},{key:"_defaultSkinIndex",get:function(){if(this.skeletonData){var e=this.skeletonData.getSkinsEnum();if(e)if(""===this.defaultSkin){if(e.hasOwnProperty(0))return this._defaultSkinIndex=0,0}else{var t=e[this.defaultSkin];if(void 0!==t)return t}}return 0},set:function(e){var t;if(this.skeletonData&&(t=this.skeletonData.getSkinsEnum()),t){var n=t[e];void 0!==n?(this.defaultSkin=n,this.setSkin(this.defaultSkin)):console.error(this.name+" skin enums are invalid")}else console.error(this.name+" skin enums are invalid")}},{key:"_animationIndex",get:function(){var e=this.animation;if(this.skeletonData)if(e){var t=this.skeletonData.getAnimsEnum();if(t){var n=t[e];if(void 0!==n)return n}}else this._refreshInspector();return 0},set:function(e){var t;if(this.skeletonData&&(t=this.skeletonData.getAnimsEnum()),t){var n=t[e];void 0!==n?(this.animation=n,this.animation=n):console.error(this.name+" animation enums are invalid")}else console.error(this.name+" animation enums are invalid")}},{key:"defaultCacheMode",get:function(){return this._defaultCacheMode},set:function(e){this._defaultCacheMode=e,this.setAnimationCacheMode(this._defaultCacheMode)}},{key:"premultipliedAlpha",get:function(){return this._premultipliedAlpha},set:function(e){e!==this._premultipliedAlpha&&(this._premultipliedAlpha=e,this.markForUpdateRenderData())}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){e!==this._timeScale&&(this._timeScale=e)}},{key:"debugSlots",get:function(){return this._debugSlots},set:function(e){e!==this._debugSlots&&(this._debugSlots=e,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"debugBones",get:function(){return this._debugBones},set:function(e){e!==this._debugBones&&(this._debugBones=e,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"debugMesh",get:function(){return this._debugMesh},set:function(e){e!==this._debugMesh&&(this._debugMesh=e,this._updateDebugDraw(),this.markForUpdateRenderData())}},{key:"useTint",get:function(){return this._useTint},set:function(e){e!==this._useTint&&(this._useTint=e,this._updateUseTint())}},{key:"sockets",get:function(){return this._sockets},set:function(e){this._sockets=e,this._updateSocketBindings(),this.attachUtil._syncAttachedNode()}},{key:"socketNodes",get:function(){return this._socketNodes}}]),t}(JU),u9.SpineSocket=g9,u9.AnimationCacheMode=d9,ce((K7=h9).prototype,"customMaterial",[sl,C7,A7,b7],Object.getOwnPropertyDescriptor(K7.prototype,"customMaterial"),K7.prototype),ce(K7.prototype,"skeletonData",[Hc,I7],Object.getOwnPropertyDescriptor(K7.prototype,"skeletonData"),K7.prototype),ce(K7.prototype,"_defaultSkinIndex",[w7,P7,R7],Object.getOwnPropertyDescriptor(K7.prototype,"_defaultSkinIndex"),K7.prototype),ce(K7.prototype,"_animationIndex",[D7,O7,N7],Object.getOwnPropertyDescriptor(K7.prototype,"_animationIndex"),K7.prototype),ce(K7.prototype,"defaultCacheMode",[M7,L7,Hc,F7],Object.getOwnPropertyDescriptor(K7.prototype,"defaultCacheMode"),K7.prototype),Q7=ce(K7.prototype,"loop",[Dc,B7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ce(K7.prototype,"premultipliedAlpha",[Hc,z7],Object.getOwnPropertyDescriptor(K7.prototype,"premultipliedAlpha"),K7.prototype),ce(K7.prototype,"timeScale",[U7,Hc],Object.getOwnPropertyDescriptor(K7.prototype,"timeScale"),K7.prototype),ce(K7.prototype,"debugSlots",[Hc,k7],Object.getOwnPropertyDescriptor(K7.prototype,"debugSlots"),K7.prototype),ce(K7.prototype,"debugBones",[Hc,G7],Object.getOwnPropertyDescriptor(K7.prototype,"debugBones"),K7.prototype),ce(K7.prototype,"debugMesh",[Hc,H7],Object.getOwnPropertyDescriptor(K7.prototype,"debugMesh"),K7.prototype),ce(K7.prototype,"useTint",[Hc,V7],Object.getOwnPropertyDescriptor(K7.prototype,"useTint"),K7.prototype),ce(K7.prototype,"sockets",[W7,j7],Object.getOwnPropertyDescriptor(K7.prototype,"sockets"),K7.prototype),J7=ce(K7.prototype,"_timeScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Z7=ce(K7.prototype,"_useTint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$7=ce(K7.prototype,"_preCacheMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),e9=ce(K7.prototype,"_cacheMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return d9.REALTIME}}),t9=ce(K7.prototype,"_defaultCacheMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return d9.REALTIME}}),n9=ce(K7.prototype,"_debugBones",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i9=ce(K7.prototype,"_debugSlots",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),r9=ce(K7.prototype,"_skeletonData",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a9=ce(K7.prototype,"_premultipliedAlpha",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),o9=ce(K7.prototype,"defaultSkin",[Dc,X7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),s9=ce(K7.prototype,"defaultAnimation",[q7,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),c9=ce(K7.prototype,"_sockets",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),l9=ce(K7.prototype,"_debugMesh",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y7=K7))||Y7)||Y7)||Y7)||Y7);l.internal.SpineSkeleton=y9;var S9,x9,E9,T9,C9,A9,b9,I9,w9,P9,R9,D9,O9,N9,M9,L9,F9,B9,z9,U9,k9,G9,H9,V9,W9,j9,X9,q9,Y9,K9,Q9,J9,Z9,$9,eee,tee=function(){function e(){this.name="sp.VertexEffectDelegate",this._vertexEffect=null,this._interpolation=null,this._effectType=void 0,this._vertexEffect=null,this._interpolation=null,this._effectType="none"}var t=e.prototype;return t.clear=function(){this._vertexEffect=null,this._interpolation=null,this._effectType="none"},t.initJitter=function(e,t){return this._effectType="jitter",this._vertexEffect=new P6.JitterEffect(e,t),this._vertexEffect},t.initSwirlWithPow=function(e,t){return this._interpolation=new P6.Pow(t),this._vertexEffect=new P6.SwirlEffect(e,this._interpolation),this._vertexEffect},t.initSwirlWithPowOut=function(e,t){return this._interpolation=new P6.PowOut(t),this._vertexEffect=new P6.SwirlEffect(e,this._interpolation),this._vertexEffect},t.getJitterVertexEffect=function(){return this._vertexEffect},t.getSwirlVertexEffect=function(){return this._vertexEffect},t.getVertexEffect=function(){return this._vertexEffect},t.getEffectType=function(){return this._effectType},e}(),nee=[0,1,2,2,3,0],iee=new In(0,0,255,255),ree=new In(255,0,0,255),aee=new In(0,255,0,255),oee=new In(255,255,0,255),see=new P6.Color(1,1,1,1),cee=new P6.Color(1,1,1,1),lee=new P6.Vector2,uee=new P6.Vector2,hee=new Float32Array(4),fee=new Float32Array(4),_ee=0,dee=0,pee=0,mee=0,vee=0,gee=0,yee=0,See=0,xee=null,Eee=null,Tee=null;function Cee(e){var t,n;switch(e){case P6.BlendMode.Additive:t=S9?Ri.ONE:Ri.SRC_ALPHA,n=Ri.ONE;break;case P6.BlendMode.Multiply:t=Ri.DST_COLOR,n=Ri.ONE_MINUS_SRC_ALPHA;break;case P6.BlendMode.Screen:t=Ri.ONE,n=Ri.ONE_MINUS_SRC_COLOR;break;case P6.BlendMode.Normal:default:t=S9?Ri.ONE:Ri.SRC_ALPHA,n=Ri.ONE_MINUS_SRC_ALPHA}return Q9.getMaterialForBlendAndTint(t,n,C9?p9.TWO_COLORED:p9.COLORED_TEXTURED)}function Aee(e){j9=e.fa*D9,U9=w9*(x9=S9?j9/255:1),k9=P9*x9,G9=R9*x9,H9=e.fr*U9,V9=e.fg*k9,W9=e.fb*G9,hee[0]=H9/255,hee[1]=V9/255,hee[2]=W9/255,hee[3]=j9/255,X9=e.dr*U9,q9=e.dg*k9,Y9=e.db*G9,K9=S9?255:0,fee[0]=X9/255,fee[1]=q9/255,fee[2]=Y9/255,fee[3]=K9/255}var bee=new Float32Array(4);function Iee(e){return bee[0]=e.r/255,bee[1]=e.g/255,bee[2]=e.b/255,bee[3]=e.a/255,bee}var wee=null,Pee=null,Ree={vCount:32767,ensureAccessor:function(e){var t=e?Pee:wee;if(!t){var n=nN.root.device,i=nN.root.batcher2D,r=e?MB:NB;e?(t=Pee=new yq(n,r,this.vCount),i.registerBufferAccessor(Number.parseInt("SPINETINT",36),Pee)):(t=wee=new yq(n,r,this.vCount),i.registerBufferAccessor(Number.parseInt("SPINE",36),wee))}return t},createData:function(e){var t=e.renderData;if(!t){for(var n=e.useTint||e.isAnimationCached(),i=this.ensureAccessor(n),r=e._skeleton.data.skins,a=0,o=0,s=0;s<r.length;++s)for(var c=r[s].attachments,l=0;l<c.length;l++){var u=c[l];for(var h in u){var f=u[h];f instanceof P6.RegionAttachment?(a+=4,o+=6):f instanceof P6.MeshAttachment&&(a+=f.worldVerticesLength>>1,o+=f.triangles.length)}}(t=nz.add(n?MB:NB,i)).resize(a,o),t.indices&&o===t.indices.length||(t.indices=new Uint16Array(o)),e.maxVertexCount=a,e.maxIndexCount=o}return t},updateRenderData:function(e){Q9=e;var t=e._skeleton;!e.isAnimationCached()&&t&&t.updateWorldTransform(),t&&function(e){if(e._skeleton){var t=e.color;w9=t.r/255,P9=t.g/255,R9=t.b/255,D9=e.node._uiProps.opacity,C9=e.useTint||e.isAnimationCached(),O9=C9?13:9,e.drawList.reset(),Q9=e,e.node,J9=e.renderData,Eee=null,z9=!0,S9=e.premultipliedAlpha,x9=1,eee=!1,xee=e._effectDelegate&&e._effectDelegate._vertexEffect,(4294967295!==t._val||S9)&&(eee=!0),e.isAnimationCached()?function(){var e=Q9._curFrame;if(e){var t=e.segments;if(0!==t.length){N9=12,mee=0,vee=0,pee=0,gee=0;var n=null,i=e.vertices,r=e.indices,a=0,o=0,s=0,c=0,l=e.colors,u=0,h=l[u++],f=h.vfOffset;Aee(h);for(var _=0,d=J9,p=d.chunk.vb,m=d.indices,v=0,g=t.length;v<g;v++){var y=t[v];if(n=Cee(y.blendMode)){if(Eee||(Eee=n),z9||n.hash!==Eee.hash||y.tex&&y.tex!==Tee){z9=!1;var S=gee-_;S>0&&(Q9._requestDrawData(Eee,Tee,_,S),_=gee),Eee=n,Tee=y.tex}dee=y.vertexCount,vee=y.indexCount,a=d.chunk.vertexOffset;for(var x=gee,E=gee+vee;x<E;x++)m[x]=a+pee+r[s++];if(c=y.vfCount,p.set(i.subarray(o,o+c),o),eee)for(var T=o/13*6,C=o,A=o+c;C<A;C+=O9,T+=6)T>=f&&(Aee(h=l[u++]),f=h.vfOffset),p.set(hee,C+5),p.set(fee,C+9);o+=c,pee+=dee,gee+=vee,dee=0,vee=0}}var b=gee-_;Tee&&b>0&&Q9._requestDrawData(Eee,Tee,_,b)}}}():(xee&&xee.begin(e._skeleton),function(){var e=J9;$9=e.chunk.vb,Z9=e.indices,yee=Q9.maxVertexCount,See=Q9.maxIndexCount;var t,n,i,r,a,o,s=Q9._skeleton,c=s.color,l=Q9._debugRenderer,u=Q9._clipper,h=null;E9=Q9._startSlotIndex,T9=Q9._endSlotIndex,B9=!1,-1===E9&&(B9=!0),A9=Q9.debugSlots,b9=Q9.debugBones,I9=Q9.debugMesh,l&&(b9||A9||I9)&&(l.clear(),l.lineWidth=5),N9=12,_ee=0,pee=0,mee=0,vee=0,gee=0;for(var f=0,_=0,d=s.drawOrder.length;_<d;_++)if(void 0!==(o=s.drawOrder[_])&&o.bone.active)if(E9>=0&&E9===o.data.index&&(B9=!0),B9)if(T9>=0&&T9===o.data.index&&(B9=!1),_ee=0,vee=0,t=o.getAttachment())if(r=t instanceof P6.RegionAttachment,a=t instanceof P6.MeshAttachment,t instanceof P6.ClippingAttachment)u.clipStart(o,t);else if(r||a){var p=t.region.texture.getRealTexture();if(h=Cee(o.data.blendMode)){if(Eee||(Eee=h),z9||h.hash!==Eee.hash||p&&Tee!==p){z9=!1;var m=gee-f;m>0&&(Q9._requestDrawData(Eee,Tee,f,m),f=gee),Tee=p,Eee=h}if(r){if(i=nee,_ee=(dee=4)*O9,vee=6,t.computeWorldVertices(o.bone,$9,mee,O9),l&&A9){l.strokeColor=iee,l.moveTo($9[mee],$9[mee+1]);for(var v=mee+O9,g=mee+_ee;v<g;v+=O9)l.lineTo($9[v],$9[v+1]);l.close(),l.stroke()}}else if(a){var y=t;if(i=y.triangles,dee=y.worldVerticesLength>>1,_ee=dee*O9,vee=i.length,y.computeWorldVertices(o,0,y.worldVerticesLength,$9,mee,O9),l&&I9){l.strokeColor=oee;for(var S=0,x=i.length;S<x;S+=3){var E=i[S]*O9+mee,T=i[S+1]*O9+mee,C=i[S+2]*O9+mee;l.moveTo($9[E],$9[E+1]),l.lineTo($9[T],$9[T+1]),l.lineTo($9[C],$9[C+1]),l.close(),l.stroke()}}}if(0!==_ee&&0!==vee){var A=t;(Z9=e.indices).set(i,gee),n=A.uvs;for(var b=mee,I=mee+_ee,w=0;b<I;b+=O9,w+=2)$9[b+3]=n[w],$9[b+4]=n[w+1];if(Dee(c,A.color,o.color,u,o),vee>0)for(var P=e.chunk.vertexOffset,R=gee,D=gee+vee;R<D;R++)Z9[R]+=pee+P;mee+=_ee,pee+=dee,gee+=vee,dee=0,vee=0,u.clipEndWithSlot(o)}else u.clipEndWithSlot(o)}else u.clipEndWithSlot(o)}else u.clipEndWithSlot(o);else u.clipEndWithSlot(o);else u.clipEndWithSlot(o);var O=gee-f;if(Tee&&O>0&&Q9._requestDrawData(Eee,Tee,f,O),u.clipEnd(),l&&b9){var N;l.strokeColor=ree,l.fillColor=iee;for(var M=0,L=s.bones.length;M<L;M++){var F=(N=s.bones[M]).data.length*N.a+N.worldX,B=N.data.length*N.c+N.worldY;l.moveTo(N.worldX,N.worldY),l.lineTo(F,B),l.stroke(),l.circle(N.worldX,N.worldY,1.5*Math.PI),l.fill(),0===M&&(l.fillColor=aee)}}}(),xee&&xee.end()),(C9?Pee:wee).getMeshBuffer(J9.chunk.bufferId).setDirty(),e.attachUtil._syncAttachedNode(),Q9=void 0,xee=null}}(e)},updateColor:function(e){e&&(Q9=e).markForUpdateRenderData()},fillBuffers:function(){}};function Dee(e,t,n,i,r){if(see.a=n.a*t.a*e.a*D9*255,x9=S9?see.a:255,M9=w9*t.r*e.r*x9,L9=P9*t.g*e.g*x9,F9=R9*t.b*e.b*x9,see.r=M9*n.r,see.g=L9*n.g,see.b=F9*n.b,null==r.darkColor?cee.set(0,0,0,1):(cee.r=r.darkColor.r*M9,cee.g=r.darkColor.g*L9,cee.b=r.darkColor.b*F9),cee.a=S9?255:0,i.isClipping()){N9=C9?12:8;var a=$9.subarray(mee),o=$9.subarray(mee+3);i.clipTriangles(a,_ee,Z9.subarray(gee),vee,o,see,cee,C9,O9);var s=i.clippedVertices,c=i.clippedTriangles;if(function(e,t){var n=dee,i=vee,r=J9;vee=t.length,dee=e.length/N9,_ee=dee*O9,yee+=dee-n,See+=vee-i;var a=Z9,o=r.chunk.vertexOffset,s=!1;if(yee>r.vertexCount&&(r.resizeAndCopy(yee,See>r.indexCount?See:r.indexCount),$9=r.chunk.vb,s=!0),See>Z9.length&&(Z9=r.indices=new Uint16Array(See),s=!0),s)for(var c=r.chunk.vertexOffset-o,l=0;l<gee;++l)Z9[l]=a[l]+c}(s,c),c.length>0&&Z9.set(c,gee),xee)for(var l=0,u=s.length,h=mee;l<u;l+=N9,h+=O9)lee.x=s[l],lee.y=s[l+1],see.set(s[l+2],s[l+3],s[l+4],s[l+5]),uee.x=s[l+6],uee.y=s[l+7],C9?cee.set(s[l+8],s[l+9],s[l+10],s[l+11]):cee.set(0,0,0,0),xee.transform(lee,uee,see,cee),$9[h]=lee.x,$9[h+1]=lee.y,$9[h+3]=uee.x,$9[h+4]=uee.y,$9.set(Iee(see),h+5),C9&&$9.set(Iee(cee),h+9);else for(var f=0,_=s.length,d=mee;f<_;f+=N9,d+=O9)$9[d]=s[f],$9[d+1]=s[f+1],$9[d+3]=s[f+6],$9[d+4]=s[f+7],$9[d+5]=s[f+2]/255,$9[d+6]=s[f+3]/255,$9[d+7]=s[f+4]/255,$9[d+8]=s[f+5]/255,C9&&($9[d+9]=s[f+8]/255,$9[d+10]=s[f+9]/255,$9[d+11]=s[f+10]/255,$9[d+12]=s[f+11]/255)}else if(xee)for(var p=mee,m=mee+_ee;p<m;p+=O9)lee.x=$9[p],lee.y=$9[p+1],uee.x=$9[p+3],uee.y=$9[p+4],xee.transform(lee,uee,see,cee),$9[p]=lee.x,$9[p+1]=lee.y,$9[p+3]=uee.x,$9[p+4]=uee.y,$9.set(Iee(see),p+5),C9&&$9.set(Iee(cee),p+9);else{hee.set(Iee(see)),fee.set(Iee(cee));for(var v=mee,g=mee+_ee;v<g;v+=O9)$9.set(hee,v+5),C9&&$9.set(fee,v+9)}}l.internal.SpineAssembler=Ree;var Oee,Nee,Mee={getAssembler:function(){return Ree}};y9.Assembler=Mee,k(y9.prototype,"Skeleton",[{name:"enableBatch",suggest:"Not support batch render mode"}]),function(e){e[e.REGION=0]="REGION",e[e.BOUNDING_BOX=1]="BOUNDING_BOX",e[e.MESH=2]="MESH",e[e.SKINNED_MESH=3]="SKINNED_MESH"}(Oee||(Oee={})),st(Oee),function(e){e[e.START=0]="START",e[e.INTERRUPT=1]="INTERRUPT",e[e.END=2]="END",e[e.DISPOSE=3]="DISPOSE",e[e.COMPLETE=4]="COMPLETE",e[e.EVENT=5]="EVENT"}(Nee||(Nee={})),st(Nee),e("sp",Object.freeze({__proto__:null,spine:P6,get ATTACHMENT_TYPE(){return Oee},get AnimationEventType(){return Nee},timeScale:1,get DefaultSkinsEnum(){return f9},get DefaultAnimsEnum(){return _9},get AnimationCacheMode(){return d9},get SpineMaterialType(){return p9},SpineSocket:g9,Skeleton:y9,SkeletonData:d7,SkeletonTexture:h7,convertFilter:f7,convertWraps:_7,VertexEffectDelegate:tee,simpleSpineAssembler:Mee}));var Lee=function(){function e(){this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}var t=e.prototype;return t.clone=function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t},t.isDone=function(){return!0},t.startWithTarget=function(e){this.originalTarget=e,this.target=e},t.stop=function(){this.target=null},t.step=function(){w(1006)},t.update=function(){w(1007)},t.getTarget=function(){return this.target},t.setTarget=function(e){this.target=e},t.getOriginalTarget=function(){return this.originalTarget},t.setOriginalTarget=function(e){this.originalTarget=e},t.getTag=function(){return this.tag},t.setTag=function(e){this.tag=e},t.reverse=function(){return w(1008),null},t.retain=function(){},t.release=function(){},e}();Lee.TAG_INVALID=-1;var Fee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._duration=0,t._timesForRepeat=1,t}Z(t,e);var n=t.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(e){this._duration=e},n.clone=function(){return new t},t}(Lee),Bee=(function(e){function t(t,n){var i;return void 0===n&&(n=1),(i=e.call(this)||this)._speed=0,i._innerAction=null,t&&i.initWithAction(t,n),i}Z(t,e);var n=t.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(e){this._speed=e},n.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(O(1021),!1)},n.clone=function(){var e=new t;return e.initWithAction(this._innerAction.clone(),this._speed),e},n.startWithTarget=function(e){Lee.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),Lee.prototype.stop.call(this)},n.step=function(e){this._innerAction.step(e*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new t(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction}}(Lee),0),zee=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},Uee=function(){function e(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var t=e.prototype;return t._searchElementByTarget=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].target)return e[n];return null},t._getElement=function(e,t){var n=this._elementPool.pop();return n||(n=new zee),n.target=e,n.paused=!!t,n},t._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},t.addAction=function(e,t,n){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+Bee++);var i=this._hashTargets.get(t);i?i.actions||(i.actions=[]):(i=this._getElement(t,n),this._hashTargets.set(t,i),this._arrayTargets.push(i)),i.target=t,i.actions.push(e),e.startWithTarget(t)}else O(1e3)},t.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var n=e[t];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},t.removeAllActionsFromTarget=function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}},t.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),n=this._hashTargets.get(t);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===e){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},t._removeActionByTag=function(e,t,n){for(var i=0,r=t.actions.length;i<r;++i){var a=t.actions[i];if(a&&a.getTag()===e){if(n&&a.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t);break}}},t._removeAllActionsByTag=function(e,t,n){for(var i=t.actions.length-1;i>=0;--i){var r=t.actions[i];if(r&&r.getTag()===e){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t)}}},t.removeActionByTag=function(e,t){var n=this;e===Lee.TAG_INVALID&&w(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeActionByTag(e,r,t)}else i.forEach((function(t){n._removeActionByTag(e,t)}))},t.removeAllActionsByTag=function(e,t){var n=this;e===Lee.TAG_INVALID&&w(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeAllActionsByTag(e,r,t)}else i.forEach((function(t){n._removeAllActionsByTag(e,t)}))},t.getActionByTag=function(e,t){e===Lee.TAG_INVALID&&w(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===e)return r}w(1005,e)}return null},t.getNumberOfRunningActionsInTarget=function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0},t.pauseTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)},t.resumeTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)},t.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,n=0;n<t.length;n++){var i=t[n];i&&!i.paused&&(i.paused=!0,e.push(i.target))}return e},t.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},t.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},t.purgeSharedManager=function(){l.director.getScheduler().unscheduleUpdate(this)},t._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},t._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}this._putElement(e),t=!0}return t},t.update=function(e){for(var t,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(t=this._currentTarget).target;if(r instanceof _l&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var a=t.currentAction;t.currentAction=null,this.removeAction(a)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&i--}}},e}(),kee=e("TweenSystem",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).actionMgr=new Uee,t}return Z(t,e),t.prototype.update=function(e){this.actionMgr.update(e)},Q(t,[{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(HO));kee.ID="TWEEN",kee.instance=void 0,nN.on(tN.EVENT_INIT,(function(){var e=new kee;kee.instance=e,nN.registerSystem(kee.ID,e,HO.Priority.MEDIUM)}));var Gee=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new t},t}(Fee),Hee=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(SF),t=0;t<e.length;++t)e[t].enabled=!0},n.reverse=function(){return new Vee},n.clone=function(){return new t},t}(Gee),Vee=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(SF),t=0;t<e.length;++t)e[t].enabled=!1},n.reverse=function(){return new Hee},n.clone=function(){return new t},t}(Gee);!function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;n.update=function(){for(var e=this.target.getComponentsInChildren(SF),t=0;t<e.length;++t){var n=e[t];n.enabled=!n.enabled}},n.reverse=function(){return new t},n.clone=function(){return new t}}(Gee);var Wee=function(e){function t(t){var n;return(n=e.call(this)||this)._isNeedCleanUp=!0,void 0!==t&&n.init(t),n}Z(t,e);var n=t.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(e){return this._isNeedCleanUp=e,!0},n.reverse=function(){return new t(this._isNeedCleanUp)},n.clone=function(){return new t(this._isNeedCleanUp)},t}(Gee),jee=function(e){function t(t,n,i){var r;return(r=e.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(t,n,i),r}Z(t,e);var n=t.prototype;return n.initWithFunction=function(e,t,n){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},n.clone=function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},t}(Gee),Xee=function(e){function t(t){var n;return(n=e.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===t||isNaN(t)||n.initWithDuration(t),n}Z(t,e);var n=t.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(e){return this._duration=0===e?lt.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},n._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},n.clone=function(){var e=new t(this._duration);return this._cloneDecoration(e),e},n.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},n._computeEaseTime=function(e){return e},n.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(e){Lee.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return w(1010),this},n.setAmplitudeRate=function(){w(1011)},n.getAmplitudeRate=function(){return w(1012),0},n.speed=function(e){return e<=0?(w(1013),this):(this._speedMethod=!0,this._speed*=e,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(e){return this._speed=e,this},n.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?(w(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},t}(Fee),qee=function(e){function t(n){var i;(i=e.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return O(1019),re(i);var a=r.length-1;if(a>=0&&null==r[a]&&w(1015),a>=0){for(var o,s=r[0],c=1;c<a;c++)r[c]&&(o=s,s=t._actionOneTwo(o,r[c]));i.initWithTwoActions(s,r[a])}return i}Z(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return O(1025),!1;var n=e._duration,i=t._duration,r=(n*=e._repeatMethod?e._timesForRepeat:1)+(i*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},n.startWithTarget=function(e){Xee.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),Lee.prototype.stop.call(this)},n.update=function(e){var t,n,i=0,r=this._split,a=this._actions,o=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===i&&1===o&&this._reversed&&(a[1].update(0),a[1].stop())):(i=1,t=1===r?1:(e-r)/(1-r),-1===o&&(a[0].startWithTarget(this.target),a[0].update(1),a[0].stop()),0===o&&(a[0].update(1),a[0].stop())),n=a[i],o===i&&n.isDone()||(o!==i&&n.startWithTarget(this.target),t*=n._timesForRepeat,n.update(t>1?t%1:t),this._last=i)},n.reverse=function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},t}(Xee);function Yee(e){var t=e instanceof Array?e:arguments;if(1===t.length)return O(1019),null;var n=t.length-1;n>=0&&null==t[n]&&w(1015);var i=null;if(n>=0){i=t[0];for(var r=1;r<=n;r++)t[r]&&(i=qee._actionOneTwo(i,t[r]))}return i}qee._actionOneTwo=function(e,t){var n=new qee;return n.initWithTwoActions(e,t),n};var Kee=function(e){function t(t,n){var i;return(i=e.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(t,n),i}Z(t,e);var n=t.prototype;return n.initWithAction=function(e,t){var n=e._duration*t;return!!this.initWithDuration(n)&&(this._times=t,this._innerAction=e,e instanceof Gee&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},n.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Xee.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),Lee.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<i;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/n,this._nextDt=r>1?1:r;e>=1&&this._total<i&&(t.update(1),this._total++),this._actionInstant||(this._total===i?t.stop():t.update(e-(r-t._duration/n)))}else t.update(e*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(Xee),Qee=function(e){function t(t){var n;return(n=e.call(this)||this)._innerAction=null,t&&n.initWithAction(t),n}Z(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?(this._innerAction=e,!0):(O(1026),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},n.startWithTarget=function(e){Xee.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},n.isDone=function(){return!1},n.reverse=function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(Xee),Jee=function(e){function t(n){var i;(i=e.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return O(1020),re(i);var a=r.length-1;if(a>=0&&null==r[a]&&w(1015),a>=0){for(var o,s=r[0],c=1;c<a;c++)r[c]&&(o=s,s=t._actionOneTwo(o,r[c]));i.initWithTwoActions(s,r[a])}return i}Z(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return O(1027),!1;var n=!1,i=e._duration,r=t._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=e,this._two=t,i>r?this._two=qee._actionOneTwo(t,ete(i-r)):i<r&&(this._one=qee._actionOneTwo(e,ete(r-i))),n=!0),n},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},n.startWithTarget=function(e){Xee.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},n.stop=function(){this._one.stop(),this._two.stop(),Lee.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},n.reverse=function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},t}(Xee);function Zee(e){var t=e instanceof Array?e:arguments;if(1===t.length)return O(1020),null;t.length>0&&null==t[t.length-1]&&w(1015);for(var n=t[0],i=1;i<t.length;i++)null!=t[i]&&(n=Jee._actionOneTwo(n,t[i]));return n}Jee._actionOneTwo=function(e,t){var n=new Jee;return n.initWithTwoActions(e,t),n};var $ee=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.update=function(){},n.reverse=function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e},t}(Xee);function ete(e){return new $ee(e)}var tte,nte,ite,rte,ate,ote,ste,cte,lte,ute,hte,fte,_te,dte,pte,mte,vte,gte,yte,Ste,xte,Ete,Tte,Cte,Ate,bte,Ite,wte,Pte,Rte,Dte,Ote,Nte,Mte,Lte,Fte,Bte,zte,Ute,kte,Gte,Hte,Vte,Wte,jte,Xte,qte,Yte,Kte,Qte,Jte,Zte,$te,ene,tne,nne,ine,rne,ane,one,sne=function(e){function t(t){var n;return(n=e.call(this)||this)._other=null,t&&n.initWithAction(t),n}Z(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?e===this._other?(O(1029),!1):!!Xee.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(O(1028),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},n.startWithTarget=function(e){Xee.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},n.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),Lee.prototype.stop.call(this)},t}(Xee),cne=e("TweenAction",function(e){function t(t,n,i){var r;if((r=e.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==i)i=Object.create(null);else if(function(e){var t=" [Tween:] ",n=" option is not support in v + "+u,i=e;i.delay&&S(t+"delay"+n),i.repeat&&S(t+"repeat"+n),i.repeatDelay&&S(t+"repeatDelay"+n),i.interpolation&&S(t+"interpolation"+n),i.onStop&&S(t+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var n=(e=e.replace(t,t.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)e="linear";else{var r=n[1];switch(i){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=i+r}}}}return e}(i.easing)),i.progress||(i.progress=r.progress),i.easing&&"string"==typeof i.easing){var a=i.easing;i.easing=Jf[a],i.easing||R(1031,a)}for(var o in r._opts=i,r._props=Object.create(null),n)if(n.hasOwnProperty(o)){var s=n[o];if("function"==typeof s&&(s=s()),null!=s&&"string"!=typeof s){var c=void 0,l=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(c=Jf[s.easing])||R(1031,s.easing):c=s.easing,l=s.progress,s=s.value);var h=Object.create(null);h.value=s,h.easing=c,h.progress=l,r._props[o]=h}}return r._originProps=n,r.initWithDuration(t),r}Z(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},n.startWithTarget=function(e){Xee.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var i in n){var r=e[i];if(void 0!==r){var a=n[i],o=a.value;if("number"==typeof r)a.start=r,a.current=r,a.end=t?r+o:o;else if("object"==typeof r)for(var s in null==a.start&&(a.start={},a.current={},a.end={}),o)isNaN(r[s])||(a.start[s]=r[s],a.current[s]=r[s],a.end[s]=t?r[s]+o[s]:o[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(e){var t=this.target;if(t){var n=this._props,i=this._opts,r=e;i.easing&&(r=i.easing(e));var a=i.progress;for(var o in n){var s=n[o],c=s.easing?s.easing(e):r,l=s.progress?s.progress:a,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var f in u)s.current[f]=l(u[f],h[f],s.current[f],c);t[o]=s.current}i.onUpdate&&i.onUpdate(this.target,e),1===e&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(e,t,n,i){return e+(t-e)*i},t}(Xee)),lne=function(e){function t(t){var n;return(n=e.call(this)||this)._props=void 0,n._props={},void 0!==t&&n.init(t),n}Z(t,e);var n=t.prototype;return n.init=function(e){for(var t in e)this._props[t]=e[t];return!0},n.update=function(){var e=this._props,t=this.target;for(var n in e)t[n]=e[n]},n.clone=function(){var e=new t;return e.init(this._props),e},t}(Gee),une=e("Tween",function(){function e(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=Lee.TAG_INVALID,this._target=void 0===e?null:e}var t=e.prototype;return t.tag=function(e){return this._tag=e,this},t.then=function(e){return e instanceof Lee?this._actions.push(e.clone()):this._actions.push(e._union()),this},t.target=function(e){return this._target=e,this},t.start=function(){return this._target?(this._finalAction&&kee.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),kee.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(S("Please set target to tween first"),this)},t.stop=function(){return this._finalAction&&kee.instance.ActionManager.removeAction(this._finalAction),this},t.clone=function(e){var t=this._union();return hne(e).then(t.clone())},t.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},t.to=function(e,t,n){(n=n||Object.create(null)).relative=!1;var i=new cne(e,t,n);return this._actions.push(i),this},t.by=function(e,t,n){(n=n||Object.create(null)).relative=!0;var i=new cne(e,t,n);return this._actions.push(i),this},t.set=function(e){var t=new lne(e);return this._actions.push(t),this},t.delay=function(e){var t=ete(e);return this._actions.push(t),this},t.call=function(e){var t=new jee(e,undefined,undefined);return this._actions.push(t),this},t.sequence=function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this},t.parallel=function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this},t.repeat=function(t,n){if(t===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof e?n._union():r.pop(),r.push(function(e,t){return new Kee(e,t)}(i,t)),this},t.repeatForever=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new Qee(e)}(n)),this},t.reverseTime=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new sne(e)}(n)),this},t.hide=function(){var e=new Vee;return this._actions.push(e),this},t.show=function(){var e=new Hee;return this._actions.push(e),this},t.removeSelf=function(){var e=new Wee(!1);return this._actions.push(e),this},e.stopAll=function(){kee.instance.ActionManager.removeAllActions()},e.stopAllByTag=function(e,t){kee.instance.ActionManager.removeAllActionsByTag(e,t)},e.stopAllByTarget=function(e){kee.instance.ActionManager.removeAllActionsFromTarget(e)},t._union=function(){var e=this._actions;return 1===e.length?e[0]:Yee(e)},t._destroy=function(){this.stop()},e._wrappedSequence=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return Yee.apply(Yee,t)},e._wrappedParallel=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return Zee.apply(Zee,t)},e}());function hne(e){return new une(e)}function fne(e){return S("tweenUtil' is deprecated, please use 'tween' instead "),new une(e)}une._tmp_args=[],l.Tween=une,l.tween=hne,l.tweenUtil=fne;var _ne,dne,pne,mne=new In;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(_ne||(_ne={})),st(_ne),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(dne||(dne={})),function(e){e.CLICK="click"}(pne||(pne={}));var vne=function(t){return e({Button:t,ButtonComponent:t}),t}((tte=Tc("cc.Button"),nte=Gc(),ite=Ac(110),rte=Bc(),ate=Cc(_z),ote=al(ib),ste=Zc(),cte=Xc(),lte=Zc(),ute=Xc(),hte=al(_ne),fte=Zc(),_te=Xc(),dte=Zc(),pte=Xc(),mte=Zc(),vte=Xc(),gte=Zc(),yte=Xc(),Ste=Zc(),xte=Xc(),Ete=Yc(),Tte=Kc(),Cte=Zc(),Ate=Xc(),bte=Zc(),Ite=Xc(),wte=al(BF),Pte=Zc(),Rte=Xc(),Dte=al(BF),Ote=Zc(),Nte=Xc(),Mte=al(BF),Lte=Zc(),Fte=Xc(),Bte=al(BF),zte=Zc(),Ute=Xc(),kte=al([eF]),Gte=Zc(),Hte=Xc(),tte(Vte=nte(Vte=ite(Vte=rte(Vte=ate(Vte=Fc((one=ane=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",jte,re(t)),se(t,"_interactable",Xte,re(t)),se(t,"_transition",qte,re(t)),se(t,"_normalColor",Yte,re(t)),se(t,"_hoverColor",Kte,re(t)),se(t,"_pressedColor",Qte,re(t)),se(t,"_disabledColor",Jte,re(t)),se(t,"_normalSprite",Zte,re(t)),se(t,"_hoverSprite",$te,re(t)),se(t,"_pressedSprite",ene,re(t)),se(t,"_disabledSprite",tne,re(t)),se(t,"_duration",nne,re(t)),se(t,"_zoomScale",ine,re(t)),se(t,"_target",rne,re(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new In,t._toColor=new In,t._time=0,t._transitionFinished=!0,t._fromScale=new Pn,t._toScale=new Pn,t._originalScale=null,t._sprite=null,t._targetScale=new Pn,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(DH);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===_ne.COLOR||this._transition===_ne.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===_ne.COLOR){var i=t._uiProps.uiComp;In.lerp(mne,this._fromColor,this._toColor,n),i&&(i.color=mne)}else this.transition===_ne.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=un(this._fromScale.x,this._toScale.x,n),this._targetScale.y=un(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===_ne.COLOR&&this._interactable){var n=e.getComponent(JU);n&&(n.color=this._normalColor)}else t===_ne.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(tC.TOUCH_START,this._onTouchBegan,this),this.node.on(tC.TOUCH_MOVE,this._onTouchMove,this),this.node.on(tC.TOUCH_END,this._onTouchEnded,this),this.node.on(tC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(tC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(tC.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(tC.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(tC.TOUCH_START,this._onTouchBegan,this),this.node.off(tC.TOUCH_MOVE,this._onTouchMove,this),this.node.off(tC.TOUCH_END,this._onTouchEnded,this),this.node.off(tC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(tC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(tC.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(tC.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(DH)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Pn),Pn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===_ne.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case dne.NORMAL:this._normalSprite=e;break;case dne.HOVER:this._hoverSprite=e;break;case dne.PRESSED:this._pressedSprite=e;break;case dne.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===_ne.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case dne.NORMAL:this._normalColor=e;break;case dne.HOVER:this._hoverColor=e;break;case dne.PRESSED:this._pressedColor=e;break;case dne.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&my.SCALE&&this._originalScale&&this._transition===_ne.SCALE&&this._transitionFinished&&Pn.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.hitTest(t.getLocation());this._transition===_ne.SCALE&&this.target&&this._originalScale?i?(Pn.copy(this._fromScale,this._originalScale),Pn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?dne.PRESSED:dne.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(eF.emitEvents(this.clickEvents,e),this.node.emit(pne.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==_ne.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=dne.NORMAL;return this._interactable?this._pressed?e=dne.PRESSED:this._hovered&&(e=dne.HOVER):e=dne.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(JU);i&&(e===dne.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===dne.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(Pn.copy(this._fromScale,this._originalScale),Pn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(Pn.copy(this._fromScale,this.target.getScale()),Pn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===_ne.COLOR?this._updateColorTransition(e):t===_ne.SPRITE?this._updateSpriteTransition(e):t===_ne.SCALE&&this._updateScaleTransition(e)},Q(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable!==e&&(this._interactable=e,this._updateState(),this._interactable||this._resetState())}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===_ne.COLOR?this._updateColorTransition(dne.NORMAL):this._transition===_ne.SPRITE&&this._updateSpriteTransition(dne.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(DH);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(Ku),ane.Transition=_ne,ane.EventType=pne,ce((Wte=one).prototype,"target",[ote,ste,cte],Object.getOwnPropertyDescriptor(Wte.prototype,"target"),Wte.prototype),ce(Wte.prototype,"interactable",[lte,ute],Object.getOwnPropertyDescriptor(Wte.prototype,"interactable"),Wte.prototype),ce(Wte.prototype,"transition",[hte,fte,_te],Object.getOwnPropertyDescriptor(Wte.prototype,"transition"),Wte.prototype),ce(Wte.prototype,"normalColor",[dte,pte],Object.getOwnPropertyDescriptor(Wte.prototype,"normalColor"),Wte.prototype),ce(Wte.prototype,"pressedColor",[mte,vte],Object.getOwnPropertyDescriptor(Wte.prototype,"pressedColor"),Wte.prototype),ce(Wte.prototype,"hoverColor",[gte,yte],Object.getOwnPropertyDescriptor(Wte.prototype,"hoverColor"),Wte.prototype),ce(Wte.prototype,"disabledColor",[Ste,xte],Object.getOwnPropertyDescriptor(Wte.prototype,"disabledColor"),Wte.prototype),ce(Wte.prototype,"duration",[Ete,Tte,Cte,Ate],Object.getOwnPropertyDescriptor(Wte.prototype,"duration"),Wte.prototype),ce(Wte.prototype,"zoomScale",[bte,Ite],Object.getOwnPropertyDescriptor(Wte.prototype,"zoomScale"),Wte.prototype),ce(Wte.prototype,"normalSprite",[wte,Pte,Rte],Object.getOwnPropertyDescriptor(Wte.prototype,"normalSprite"),Wte.prototype),ce(Wte.prototype,"pressedSprite",[Dte,Ote,Nte],Object.getOwnPropertyDescriptor(Wte.prototype,"pressedSprite"),Wte.prototype),ce(Wte.prototype,"hoverSprite",[Mte,Lte,Fte],Object.getOwnPropertyDescriptor(Wte.prototype,"hoverSprite"),Wte.prototype),ce(Wte.prototype,"disabledSprite",[Bte,zte,Ute],Object.getOwnPropertyDescriptor(Wte.prototype,"disabledSprite"),Wte.prototype),jte=ce(Wte.prototype,"clickEvents",[kte,Dc,Gte,Hte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xte=ce(Wte.prototype,"_interactable",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qte=ce(Wte.prototype,"_transition",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _ne.NONE}}),Yte=ce(Wte.prototype,"_normalColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.WHITE.clone()}}),Kte=ce(Wte.prototype,"_hoverColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(211,211,211,255)}}),Qte=ce(Wte.prototype,"_pressedColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.WHITE.clone()}}),Jte=ce(Wte.prototype,"_disabledColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(124,124,124,255)}}),Zte=ce(Wte.prototype,"_normalSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$te=ce(Wte.prototype,"_hoverSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ene=ce(Wte.prototype,"_pressedSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tne=ce(Wte.prototype,"_disabledSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nne=ce(Wte.prototype,"_duration",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),ine=ce(Wte.prototype,"_zoomScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),rne=ce(Wte.prototype,"_target",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vte=Wte))||Vte)||Vte)||Vte)||Vte)||Vte)||Vte));l.Button=vne;var gne,yne,Sne,xne=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();xne._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(gne||(gne={})),rt(gne),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(yne||(yne={})),rt(yne),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(Sne||(Sne={})),rt(Sne);var Ene,Tne,Cne,Ane,bne,Ine,wne,Pne,Rne,Dne,One,Nne,Mne,Lne,Fne,Bne,zne,Une,kne,Gne,Hne,Vne,Wne,jne,Xne,qne,Yne,Kne,Qne,Jne,Zne,$ne,eie,tie,nie,iie,rie,aie,oie,sie,cie,lie,uie,hie,fie,_ie,die,pie,mie,vie,gie,yie,Sie,xie,Eie,Tie,Cie,Aie,bie,Iie,wie,Pie=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),Rie=new Wn,Die=new Wn,Oie=new Pn,Nie=null,Mie=0,Lie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++Mie,t}Z(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===yne.ANY?this._createTextArea():this._createInput(),xne.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),xne.remove(this),Nie===this&&(Nie=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,xne.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){Nie&&Nie!==this&&Nie.setFocus(!1),this._editing=!0,Nie=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){l.GAME_VIEW&&this._edTxt?(l.gameView.container.appendChild(this._edTxt),l.gameView.head.appendChild(this._placeholderStyleSheet)):eN.container&&this._edTxt&&(eN.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(l.GAME_VIEW?vt(l.gameView.container,this._edTxt):vt(eN.container,this._edTxt))&&this._edTxt&&(l.GAME_VIEW?l.gameView.container.removeChild(this._edTxt):eN.container.removeChild(this._edTxt)),(l.GAME_VIEW?vt(l.gameView.head,this._placeholderStyleSheet):vt(document.head,this._placeholderStyleSheet))&&(l.GAME_VIEW?l.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),ah.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),ah.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){ah.os!==iu.ANDROID&&ah.os!==iu.OHOS||(nh.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){ah.os!==iu.ANDROID&&ah.os!==iu.OHOS||(nh.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){ah.browserType!==eu.WECHAT||ah.os!==iu.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=fN.getScaleX(),n=fN.getScaleY(),i=1,r=1;l.GAME_VIEW&&(i=l.gameView.canvas.width/l.game.canvas.width,r=l.gameView.canvas.height/l.game.canvas.height),t*=i,n*=r;var a=fN.getViewportRect(),o=nh.devicePixelRatio;e.getWorldMatrix(Rie);var s=e._uiProps.uiTransformComp;if(s&&Pn.set(Oie,-s.anchorX*s.width,-s.anchorY*s.height,Oie.z),Wn.transform(Rie,Rie,Oie),e._uiProps.uiTransformComp){var c=nN.root.batcher2D.getFirstRenderCamera(e);if(c){c.node.getWorldRT(Die);var u=Die.m12,h=Die.m13,f=aN.center;Die.m12=f.x-(Die.m00*u+Die.m04*h),Die.m13=f.y-(Die.m01*u+Die.m05*h),Wn.multiply(Die,Die,Rie),t/=o,n/=o;var _=l.GAME_VIEW?l.gameView.container:eN.container,d=Die.m00*t,p=Rie.m01,m=Rie.m04,v=Die.m05*n,g=parseInt(_&&_.style.paddingLeft||"0");g+=a.x*i/o;var y=parseInt(_&&_.style.paddingBottom||"0");y+=a.y/o;var S="matrix("+d+","+-p+","+-m+","+v+","+(Die.m12*t+g)+","+-(Die.m13*n+y)+")";this._edTxt.style.transform=S,this._edTxt.style["-webkit-transform"]=S,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var a="none";return n===Sne.INITIAL_CAPS_ALL_CHARACTERS?a="uppercase":n===Sne.INITIAL_CAPS_WORD&&(a="capitalize"),void(r.style.textTransform=a)}if(r=r,n===Sne.PASSWORD)return r.type="password",void(r.style.textTransform="none");var o=r.type;t===yne.EMAIL_ADDR?o="email":t===yne.NUMERIC||t===yne.DECIMAL?o="number":t===yne.PHONE_NUMBER?(o="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===yne.URL?o="url":(o="text",i===gne.SEARCH&&(o="search")),r.type=o;var s="none";n===Sne.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===Sne.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,this._updateTextLabel(e.textLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof rB?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case tk.HorizontalAlign.LEFT:i.style.textAlign="left";break;case tk.HorizontalAlign.CENTER:i.style.textAlign="center";break;case tk.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof rB?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),a=e.fontSize,o="";switch(e.horizontalAlign){case tk.HorizontalAlign.LEFT:o="left";break;case tk.HorizontalAlign.CENTER:o="center";break;case tk.HorizontalAlign.RIGHT:o="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+a+"px;text-align: "+o+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+a+"px;text-align: "+o+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+a+"px;text-align: "+o+";}",ah.browserType===eu.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&ah.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===sR.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===sR.TAB&&(n.propagationStopped=!0,n.preventDefault(),xne.next(e))},i.onBlur=function(){ah.isMobile&&n&&i.compositionEnd(),e._editing=!1,Nie=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}(Pie);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(wie||(wie={}));var Fie,Bie,zie,Uie,kie,Gie,Hie,Vie,Wie,jie,Xie,qie,Yie,Kie,Qie,Jie,Zie,$ie,ere,tre,nre,ire,rre,are,ore,sre,cre,lre,ure,hre,fre,_re,dre,pre,mre,vre,gre,yre,Sre,xre,Ere,Tre,Cre,Are,bre,Ire,wre,Pre,Rre,Dre,Ore,Nre,Mre,Lre,Fre,Bre,zre,Ure,kre,Gre,Hre,Vre=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((Ene=Tc("cc.EditBox"),Tne=Gc(),Cne=Ac(110),Ane=Bc(),bne=Cc(_z),Ine=Zc(),wne=Xc(),Pne=Zc(),Rne=Xc(),Dne=al(tk),One=Zc(),Nne=Xc(),Mne=al(tk),Lne=Zc(),Fne=Xc(),Bne=al(BF),zne=Zc(),Une=Xc(),kne=al(Sne),Gne=Zc(),Hne=Xc(),Vne=al(yne),Wne=Zc(),jne=Xc(),Xne=al(gne),qne=Zc(),Yne=Xc(),Kne=Zc(),Qne=Xc(),Jne=Zc(),Zne=Xc(),$ne=al([eF]),eie=Zc(),tie=Xc(),nie=al([eF]),iie=Zc(),rie=Xc(),aie=al([eF]),oie=Zc(),sie=Xc(),cie=al([eF]),lie=Zc(),uie=Xc(),Ene(hie=Tne(hie=Cne(hie=Ane(hie=bne(hie=Fc((Iie=bie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",_ie,re(t)),se(t,"textChanged",die,re(t)),se(t,"editingDidEnded",pie,re(t)),se(t,"editingReturn",mie,re(t)),t._impl=null,t._background=null,se(t,"_textLabel",vie,re(t)),se(t,"_placeholderLabel",gie,re(t)),se(t,"_returnType",yie,re(t)),se(t,"_string",Sie,re(t)),se(t,"_tabIndex",xie,re(t)),se(t,"_backgroundImage",Eie,re(t)),se(t,"_inputFlag",Tie,re(t)),se(t,"_inputMode",Cie,re(t)),se(t,"_maxLength",Aie,re(t)),t._isLabelVisible=!1,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){eF.emitEvents(this.editingDidBegan,this),this.node.emit(wie.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){eF.emitEvents(this.editingDidEnded,this),this.node.emit(wie.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,eF.emitEvents(this.textChanged,e,this),this.node.emit(wie.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){eF.emitEvents(this.editingReturn,this),this.node.emit(wie.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(tC.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(DH);e||(e=this.node.addComponent(DH)),e!==this._background&&(e.type=DH.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||((t=new ib("TEXT_LABEL")).layer=this.node.layer),(e=t.getComponent(tk))||(e=t.addComponent(tk)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=tk.Overflow.CLAMP,this._inputMode===yne.ANY?(e.verticalAlign=YU.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||((t=new ib("PLACEHOLDER_LABEL")).layer=this.node.layer),(e=t.getComponent(tk))||(e=t.addComponent(tk)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),this._inputMode===yne.ANY?e.enableWrapText=!0:e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==Sne.PASSWORD)i===Sne.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===Sne.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===Sne.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",a=e.length,o=0;o<a;++o)r+="";e=r}return e},n._registerEvent=function(){this.node.on(tC.TOUCH_START,this._onTouchBegan,this),this.node.on(tC.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(tC.TOUCH_START,this._onTouchBegan,this),this.node.off(tC.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(DH.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(DH.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),a.node.setPosition(n+2,i+e.height,a.node.position.z),this._inputMode===yne.ANY&&(a.verticalAlign=YU.TOP),a.enableWrapText=this._inputMode===yne.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),r.enableWrapText=this._inputMode===yne.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize),this._syncSize()},Q(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string!==e&&(this._string=e,this._updateString(e))}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag!==e&&(this._inputFlag=e,this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(Ku),bie._EditBoxImpl=Pie,bie.KeyboardReturnType=gne,bie.InputFlag=Sne,bie.InputMode=yne,bie.EventType=wie,ce((fie=Iie).prototype,"string",[Ine,wne],Object.getOwnPropertyDescriptor(fie.prototype,"string"),fie.prototype),ce(fie.prototype,"placeholder",[Pne,Rne],Object.getOwnPropertyDescriptor(fie.prototype,"placeholder"),fie.prototype),ce(fie.prototype,"textLabel",[Dne,One,Nne],Object.getOwnPropertyDescriptor(fie.prototype,"textLabel"),fie.prototype),ce(fie.prototype,"placeholderLabel",[Mne,Lne,Fne],Object.getOwnPropertyDescriptor(fie.prototype,"placeholderLabel"),fie.prototype),ce(fie.prototype,"backgroundImage",[Bne,zne,Une],Object.getOwnPropertyDescriptor(fie.prototype,"backgroundImage"),fie.prototype),ce(fie.prototype,"inputFlag",[kne,Gne,Hne],Object.getOwnPropertyDescriptor(fie.prototype,"inputFlag"),fie.prototype),ce(fie.prototype,"inputMode",[Vne,Wne,jne],Object.getOwnPropertyDescriptor(fie.prototype,"inputMode"),fie.prototype),ce(fie.prototype,"returnType",[Xne,qne,Yne],Object.getOwnPropertyDescriptor(fie.prototype,"returnType"),fie.prototype),ce(fie.prototype,"maxLength",[Kne,Qne],Object.getOwnPropertyDescriptor(fie.prototype,"maxLength"),fie.prototype),ce(fie.prototype,"tabIndex",[Jne,Zne],Object.getOwnPropertyDescriptor(fie.prototype,"tabIndex"),fie.prototype),_ie=ce(fie.prototype,"editingDidBegan",[$ne,Dc,eie,tie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),die=ce(fie.prototype,"textChanged",[nie,Dc,iie,rie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pie=ce(fie.prototype,"editingDidEnded",[aie,Dc,oie,sie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mie=ce(fie.prototype,"editingReturn",[cie,Dc,lie,uie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vie=ce(fie.prototype,"_textLabel",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gie=ce(fie.prototype,"_placeholderLabel",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yie=ce(fie.prototype,"_returnType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gne.DEFAULT}}),Sie=ce(fie.prototype,"_string",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xie=ce(fie.prototype,"_tabIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eie=ce(fie.prototype,"_backgroundImage",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tie=ce(fie.prototype,"_inputFlag",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sne.DEFAULT}}),Cie=ce(fie.prototype,"_inputMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yne.ANY}}),Aie=ce(fie.prototype,"_maxLength",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),hie=fie))||hie)||hie)||hie)||hie)||hie)||hie));"object"==typeof window&&"object"==typeof document&&(Vre._EditBoxImpl=Lie),l.internal.EditBox=Vre,function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(Bre||(Bre={})),st(Bre),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(zre||(zre={})),st(zre),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Ure||(Ure={})),st(Ure),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(kre||(kre={})),st(kre),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Gre||(Gre={})),st(Gre),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(Hre||(Hre={})),st(Hre);var Wre,jre,Xre,qre,Yre,Kre,Qre,Jre,Zre,$re,eae,tae,nae,iae,rae,aae,oae,sae,cae,lae,uae,hae,fae,_ae=new Pn,dae=function(t){return e({Layout:t,LayoutComponent:t}),t}((Fie=Tc("cc.Layout"),Bie=Gc(),zie=Ac(110),Uie=Bc(),kie=Cc(_z),Gie=Vc(),Hie=Xc(),Vie=Vc(),Wie=Xc(),jie=al(Bre),Xie=Zc(),qie=Xc(),Yie=al(zre),Kie=Vc(),Qie=Xc(),Jie=Vc(),Zie=Xc(),$ie=al(Ure),ere=Xc(),tre=Xc(),nre=Xc(),ire=Xc(),rre=Xc(),are=Xc(),ore=Xc(),sre=al(kre),cre=Xc(),lre=al(Gre),ure=Xc(),hre=al(Hre),fre=Vc(),_re=Xc(),dre=Vc(),pre=Xc(),mre=Xc(),Fie(vre=Bie(vre=zie(vre=Uie(vre=kie(vre=Fc((Fre=Lre=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",yre,re(t)),se(t,"_layoutType",Sre,re(t)),se(t,"_cellSize",xre,re(t)),se(t,"_startAxis",Ere,re(t)),se(t,"_paddingLeft",Tre,re(t)),se(t,"_paddingRight",Cre,re(t)),se(t,"_paddingTop",Are,re(t)),se(t,"_paddingBottom",bre,re(t)),se(t,"_spacingX",Ire,re(t)),se(t,"_spacingY",wre,re(t)),se(t,"_verticalDirection",Pre,re(t)),se(t,"_horizontalDirection",Rre,re(t)),se(t,"_constraint",Dre,re(t)),se(t,"_constraintNum",Ore,re(t)),se(t,"_affectedByScale",Nre,re(t)),se(t,"_isAlign",Mre,re(t)),t._layoutSize=new ti(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}Z(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(ti.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){nN.on(tN.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(tC.SIZE_CHANGED,this._resized,this),this.node.on(tC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(tC.CHILD_ADDED,this._childAdded,this),this.node.on(tC.CHILD_REMOVED,this._childRemoved,this),this.node.on(tC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){nN.off(tN.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(tC.SIZE_CHANGED,this._resized,this),this.node.off(tC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(tC.CHILD_ADDED,this._childAdded,this),this.node.off(tC.CHILD_REMOVED,this._childRemoved,this),this.node.off(tC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(tC.SIZE_CHANGED,this._doLayoutDirty,this),n.on(tC.TRANSFORM_CHANGED,this._transformDirty,this),n.on(tC.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(tC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(tC.SIZE_CHANGED,this._doLayoutDirty,this),n.off(tC.TRANSFORM_CHANGED,this._transformDirty,this),n.off(tC.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(tC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(e){e.on(tC.SIZE_CHANGED,this._doLayoutDirty,this),e.on(tC.TRANSFORM_CHANGED,this._transformDirty,this),e.on(tC.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(tC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(tC.SIZE_CHANGED,this._doLayoutDirty,this),e.off(tC.TRANSFORM_CHANGED,this._transformDirty,this),e.off(tC.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(tC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,a=this._getFixedBreakingNum(),o=1,s=this._paddingLeft;this._horizontalDirection===Gre.RIGHT_TO_LEFT&&(o=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+o*s,l=c-o*this._spacingX,u=0,h=0,f=0,_=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==Bre.GRID&&this._resizeMode===zre.CHILDREN&&(m=(e-v-(p-1)*this._spacingX)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],x=S.node,E=x.scale,T=this._getUsedScaleValue(E.x),C=this._getUsedScaleValue(E.y);this._resizeMode===zre.CHILDREN&&(S.width=m/T,this._layoutType===Bre.GRID&&(S.height=this._cellSize.height/C));var A=Math.abs(this._horizontalDirection-S.anchorX),b=S.width*T,I=S.height*C;I>f&&(_=Math.max(f,_),h=f||I,f=I),l+=o*(A*b+this._spacingX);var w=o*(1-A)*b;if(t){if(a>0)(d=y/a>0&&y%a==0)&&(h=f>I?f:h);else if(b>e-v)l>c+o*A*b&&(d=!0);else{var P=(1-this._horizontalDirection-r.x)*e,R=l+w+o*(o>0?this._paddingRight:this._paddingLeft);d=Math.abs(R)>Math.abs(P)}d&&(l=c+o*A*b,I!==f&&(h=f),u+=h+this._spacingY,h=f=I)}var D=n(x,S,u);i&&x.setPosition(l,D),l+=w}return h=Math.max(h,f),Math.max(_,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,a=this._getFixedBreakingNum(),o=1,s=this._paddingBottom;this._verticalDirection===kre.TOP_TO_BOTTOM&&(o=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+o*s,l=c-o*this._spacingY,u=0,h=0,f=0,_=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==Bre.GRID&&this._resizeMode===zre.CHILDREN&&(m=(e-v-(p-1)*this._spacingY)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],x=S.node,E=x.scale,T=this._getUsedScaleValue(E.x),C=this._getUsedScaleValue(E.y);this._resizeMode===zre.CHILDREN&&(S.height=m/C,this._layoutType===Bre.GRID&&(S.width=this._cellSize.width/T));var A=Math.abs(this._verticalDirection-S.anchorY),b=S.width*T,I=S.height*C;b>u&&(h=Math.max(u,h),f=u||b,u=b),l+=o*(A*I+this._spacingY);var w=o*(1-A)*I;if(t){if(a>0)(d=y/a>0&&y%a==0)&&(f=u>I?u:f);else if(I>e-v)l>c+o*A*I&&(d=!0);else{var P=(1-this._verticalDirection-r.y)*e,R=l+w+o*(o>0?this._paddingTop:this._paddingBottom);d=Math.abs(R)>Math.abs(P)}d&&(l=c+o*A*I,b!==u&&(f=u),_+=f+this._spacingX,f=u=b)}var D=n(x,S,_);i&&(x.getPosition(_ae),x.setPosition(D,l,_ae.z)),l+=w}return f=Math.max(f,u),Math.max(h,_+f)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,a=-e.y*t.height,o=this._paddingBottom;this._verticalDirection===kre.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,o=this._paddingTop);var s=function(e,t,i){return a+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+o)},c=0;this._resizeMode===zre.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),a=-e.y*c,this._verticalDirection===kre.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===zre.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,a=-e.x*t.width,o=this._paddingLeft;this._horizontalDirection===Gre.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,o=this._paddingRight);var s=function(e,t,i){return a+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+o)},c=0;this._resizeMode===zre.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),a=-e.x*c,this._horizontalDirection===Gre.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===zre.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===Ure.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===Ure.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===zre.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],a=r.node.scale;t+=r.width*this._getUsedScaleValue(a.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===zre.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],a=r.node.scale;t+=r.height*this._getUsedScaleValue(a.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===Bre.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?Pn.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===Bre.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?Pn.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===Bre.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&my.SCALE&&e&my.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==Bre.GRID||this._constraint===Hre.NONE||this._constraintNum<=0)return 0;var e=this._constraint===Hre.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===Ure.VERTICAL&&(e=this._constraint===Hre.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},Q(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===Bre.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===Bre.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==Bre.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==Bre.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==Hre.NONE&&this._constraintNum!==e&&(e<=0&&S("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(Ku),Lre.Type=Bre,Lre.VerticalDirection=kre,Lre.HorizontalDirection=Gre,Lre.ResizeMode=zre,Lre.AxisDirection=Ure,Lre.Constraint=Hre,ce((gre=Fre).prototype,"alignHorizontal",[Gie,Hie],Object.getOwnPropertyDescriptor(gre.prototype,"alignHorizontal"),gre.prototype),ce(gre.prototype,"alignVertical",[Vie,Wie],Object.getOwnPropertyDescriptor(gre.prototype,"alignVertical"),gre.prototype),ce(gre.prototype,"type",[jie,Xie,qie],Object.getOwnPropertyDescriptor(gre.prototype,"type"),gre.prototype),ce(gre.prototype,"resizeMode",[Yie,Kie,Qie],Object.getOwnPropertyDescriptor(gre.prototype,"resizeMode"),gre.prototype),ce(gre.prototype,"cellSize",[Jie,Zie],Object.getOwnPropertyDescriptor(gre.prototype,"cellSize"),gre.prototype),ce(gre.prototype,"startAxis",[$ie,ere],Object.getOwnPropertyDescriptor(gre.prototype,"startAxis"),gre.prototype),ce(gre.prototype,"paddingLeft",[tre],Object.getOwnPropertyDescriptor(gre.prototype,"paddingLeft"),gre.prototype),ce(gre.prototype,"paddingRight",[nre],Object.getOwnPropertyDescriptor(gre.prototype,"paddingRight"),gre.prototype),ce(gre.prototype,"paddingTop",[ire],Object.getOwnPropertyDescriptor(gre.prototype,"paddingTop"),gre.prototype),ce(gre.prototype,"paddingBottom",[rre],Object.getOwnPropertyDescriptor(gre.prototype,"paddingBottom"),gre.prototype),ce(gre.prototype,"spacingX",[are],Object.getOwnPropertyDescriptor(gre.prototype,"spacingX"),gre.prototype),ce(gre.prototype,"spacingY",[ore],Object.getOwnPropertyDescriptor(gre.prototype,"spacingY"),gre.prototype),ce(gre.prototype,"verticalDirection",[sre,cre],Object.getOwnPropertyDescriptor(gre.prototype,"verticalDirection"),gre.prototype),ce(gre.prototype,"horizontalDirection",[lre,ure],Object.getOwnPropertyDescriptor(gre.prototype,"horizontalDirection"),gre.prototype),ce(gre.prototype,"constraint",[hre,fre,_re],Object.getOwnPropertyDescriptor(gre.prototype,"constraint"),gre.prototype),ce(gre.prototype,"constraintNum",[dre,pre],Object.getOwnPropertyDescriptor(gre.prototype,"constraintNum"),gre.prototype),ce(gre.prototype,"affectedByScale",[mre],Object.getOwnPropertyDescriptor(gre.prototype,"affectedByScale"),gre.prototype),yre=ce(gre.prototype,"_resizeMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zre.NONE}}),Sre=ce(gre.prototype,"_layoutType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bre.NONE}}),xre=ce(gre.prototype,"_cellSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(40,40)}}),Ere=ce(gre.prototype,"_startAxis",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ure.HORIZONTAL}}),Tre=ce(gre.prototype,"_paddingLeft",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cre=ce(gre.prototype,"_paddingRight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Are=ce(gre.prototype,"_paddingTop",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bre=ce(gre.prototype,"_paddingBottom",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ire=ce(gre.prototype,"_spacingX",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wre=ce(gre.prototype,"_spacingY",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pre=ce(gre.prototype,"_verticalDirection",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kre.TOP_TO_BOTTOM}}),Rre=ce(gre.prototype,"_horizontalDirection",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gre.LEFT_TO_RIGHT}}),Dre=ce(gre.prototype,"_constraint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hre.NONE}}),Ore=ce(gre.prototype,"_constraintNum",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Nre=ce(gre.prototype,"_affectedByScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mre=ce(gre.prototype,"_isAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vre=gre))||vre)||vre)||vre)||vre)||vre)||vre));l.Layout=dae,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(fae||(fae={})),rt(fae);var pae,mae,vae,gae,yae,Sae,xae,Eae,Tae,Cae,Aae,bae,Iae,wae,Pae,Rae,Dae,Oae,Nae,Mae,Lae,Fae,Bae,zae,Uae=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((Wre=Tc("cc.ProgressBar"),jre=Gc(),Xre=Ac(110),qre=Bc(),Yre=Cc(_z),Kre=al(DH),Qre=Xc(),Jre=al(fae),Zre=Xc(),$re=Xc(),eae=qc(),tae=Xc(),nae=Xc(),Wre(iae=jre(iae=Xre(iae=qre(iae=Yre((hae=uae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",aae,re(t)),se(t,"_mode",oae,re(t)),se(t,"_totalLength",sae,re(t)),se(t,"_progress",cae,re(t)),se(t,"_reverse",lae,re(t)),t}Z(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===DH.FillType.RADIAL&&(this._mode=fae.FILLED),this._mode===fae.HORIZONTAL?this.totalLength=r.width:this._mode===fae.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var a=-n.width*i.x;e.setPosition(a,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),a=new Yn(0,.5),o=ln(this._progress),s=this._totalLength*o,c=i,l=0,u=0;switch(this._mode){case fae.HORIZONTAL:this._reverse&&(a=new Yn(1,.5)),c=new ti(s,i.height),l=this._totalLength,u=i.height;break;case fae.VERTICAL:a=this._reverse?new Yn(.5,1):new Yn(.5,0),c=new ti(i.width,s),l=i.width,u=this._totalLength}if(this._mode===fae.FILLED)this._barSprite.type!==DH.Type.FILLED?S("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==DH.Type.FILLED){var h=a.x-n.x,f=a.y-n.y,_=new Pn(l*h,u*f,0);e.setPosition(r.x+_.x,r.y+_.y,r.z),t.setAnchorPoint(a),t.setContentSize(c)}else S("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},Q(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===fae.HORIZONTAL?this.totalLength=n.width:this._mode===fae.VERTICAL?this.totalLength=n.height:this._mode===fae.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===fae.FILLED&&(e=ln(e)),this._totalLength!==e&&(this._totalLength=e,this._updateBarStatus())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(Ku),uae.Mode=fae,ce((rae=hae).prototype,"barSprite",[Kre,Qre],Object.getOwnPropertyDescriptor(rae.prototype,"barSprite"),rae.prototype),ce(rae.prototype,"mode",[Jre,Zre],Object.getOwnPropertyDescriptor(rae.prototype,"mode"),rae.prototype),ce(rae.prototype,"totalLength",[$re],Object.getOwnPropertyDescriptor(rae.prototype,"totalLength"),rae.prototype),ce(rae.prototype,"progress",[eae,Jc,tae],Object.getOwnPropertyDescriptor(rae.prototype,"progress"),rae.prototype),ce(rae.prototype,"reverse",[nae],Object.getOwnPropertyDescriptor(rae.prototype,"reverse"),rae.prototype),aae=ce(rae.prototype,"_barSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oae=ce(rae.prototype,"_mode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fae.HORIZONTAL}}),sae=ce(rae.prototype,"_totalLength",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cae=ce(rae.prototype,"_progress",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),lae=ce(rae.prototype,"_reverse",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),iae=rae))||iae)||iae)||iae)||iae)||iae));l.ProgressBar=Uae;var kae,Gae=new Pn,Hae=new Pn,Vae=new Pn,Wae=new Yn,jae=new In,Xae=new Yn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(kae||(kae={})),st(kae);var qae,Yae=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((pae=Tc("cc.ScrollBar"),mae=Gc(),vae=Ac(110),gae=Bc(),yae=Cc(_z),Sae=al(DH),xae=Zc(),Eae=Xc(),Tae=al(kae),Cae=Zc(),Aae=Xc(),bae=Zc(),Iae=Xc(),wae=Zc(),Pae=Xc(),pae(Rae=mae(Rae=vae(Rae=gae(Rae=yae((zae=Bae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",Oae,re(t)),se(t,"_handle",Nae,re(t)),se(t,"_direction",Mae,re(t)),se(t,"_enableAutoHide",Lae,re(t)),se(t,"_autoHideTime",Fae,re(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}Z(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,o=0,s=0,c=0,l=0,u=Xae;u.set(0,0),this._direction===kae.HORIZONTAL?(a=n.width,o=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===kae.VERTICAL&&(a=n.height,o=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(a,o,l,s),f=Xae;this._calculatePosition(f,a,o,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(f)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(DH);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){Gae.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(Gae,Hae);var r=n.convertToNodeSpaceAR(Hae);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(Yn.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(DH);t&&(jae.set(t.color),jae.a=e,t.color=jae),(t=this._handle.getComponent(DH))&&(jae.set(t.color),jae.a=e,t.color=jae)}},n._updateHandlerPosition=function(e){if(this._handle){var t=Vae;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,a=this.handle.node.parent;Pn.set(Gae,-n.width*i.x,-n.height*i.y,0);var o=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(Gae,Hae),s=e;s.set(0,0,0),a._uiProps.uiTransformComp.convertToNodeSpaceAR(o,s),this.direction===kae.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===kae.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===kae.HORIZONTAL||e.height<=t.height&&this._direction===kae.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,a,o){var s=t-n;a&&(s+=Math.abs(a));var c=0;s&&(c=ln(c=r/s));var l=(i-o)*c;this._direction===kae.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===Wae.x&&i.y===Wae.y||t.setAnchorPoint(Wae),this._direction===kae.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},Q(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(Yn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(Yn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(Ku),Bae.Direction=kae,ce((Dae=zae).prototype,"handle",[Sae,xae,Eae],Object.getOwnPropertyDescriptor(Dae.prototype,"handle"),Dae.prototype),ce(Dae.prototype,"direction",[Tae,Cae,Aae],Object.getOwnPropertyDescriptor(Dae.prototype,"direction"),Dae.prototype),ce(Dae.prototype,"enableAutoHide",[bae,Iae],Object.getOwnPropertyDescriptor(Dae.prototype,"enableAutoHide"),Dae.prototype),ce(Dae.prototype,"autoHideTime",[wae,Pae],Object.getOwnPropertyDescriptor(Dae.prototype,"autoHideTime"),Dae.prototype),Oae=ce(Dae.prototype,"_scrollView",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nae=ce(Dae.prototype,"_handle",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mae=ce(Dae.prototype,"_direction",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kae.HORIZONTAL}}),Lae=ce(Dae.prototype,"_enableAutoHide",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fae=ce(Dae.prototype,"_autoHideTime",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Rae=Dae))||Rae)||Rae)||Rae)||Rae)||Rae));l.ScrollBar=Yae;var Kae,Qae,Jae,Zae,$ae,eoe,toe,noe,ioe,roe,aoe,ooe,soe,coe,loe,uoe,hoe,foe,_oe,doe,poe,moe,voe,goe,yoe,Soe,xoe,Eoe,Toe,Coe,Aoe,boe,Ioe,woe,Poe,Roe,Doe,Ooe,Noe,Moe,Loe,Foe,Boe,zoe,Uoe,koe,Goe,Hoe,Voe=e("ViewGroup",Tc("cc.ViewGroup")(qae=Ac(110)(qae=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(Ku))||qae)||qae);l.ViewGroup=Voe;var Woe,joe=1e-4,Xoe=new Pn,qoe=new Pn,Yoe=new Yn,Koe=new Yn,Qoe=function(){return(new Date).getMilliseconds()},Joe={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(Woe||(Woe={}));var Zoe,$oe,ese,tse,nse,ise,rse,ase,ose,sse,cse,lse,use,hse,fse,_se,dse,pse,mse,vse,gse,yse=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((Kae=Tc("cc.ScrollView"),Qae=Gc(),Jae=Ac(110),Zae=Bc(),$ae=Cc(_z),eoe=qc(),toe=Zc(),noe=Xc(),ioe=qc(),roe=Zc(),aoe=Xc(),ooe=Zc(),soe=Xc(),coe=Zc(),loe=Xc(),uoe=al(ib),hoe=Zc(),foe=Xc(),_oe=Zc(),doe=Xc(),poe=al(Yae),moe=Zc(),voe=Xc(),goe=Zc(),yoe=Xc(),Soe=al(Yae),xoe=Zc(),Eoe=Xc(),Toe=Zc(),Coe=Xc(),Aoe=al([eF]),boe=Zc(),Ioe=Xc(),Kae(woe=Qae(woe=Jae(woe=Zae(woe=$ae((Hoe=Goe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",Roe,re(t)),se(t,"brake",Doe,re(t)),se(t,"elastic",Ooe,re(t)),se(t,"inertia",Noe,re(t)),se(t,"horizontal",Moe,re(t)),se(t,"vertical",Loe,re(t)),se(t,"cancelInnerEvents",Foe,re(t)),se(t,"scrollEvents",Boe,re(t)),t._autoScrolling=!1,t._scrolling=!1,se(t,"_content",zoe,re(t)),se(t,"_horizontalScrollBar",Uoe,re(t)),se(t,"_verticalScrollBar",koe,re(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Pn,t._autoScrollTargetDelta=new Pn,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Pn,t._outOfBoundaryAmount=new Pn,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Pn,t._deltaPos=new Pn,t}Z(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Yn(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Yn(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Yn.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new Yn(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Yn(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Yn(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Yn(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<joe&&Math.abs(e.y-t.y)<joe||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Pn.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return joe},n.start=function(){this._calculateBoundary(),this._content&&nN.once(tN.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(tC.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(tC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(tC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(tC.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(tC.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(tC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(tC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(tC.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(tC.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(tC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(tC.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(tC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(tC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(tC.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(tC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(tC.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(tC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(tC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new Pn,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(Yoe);if(i.subtract(n.getUIStartLocation(Koe)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new oR(e.getTouches(),e.bubbles,Zb.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(Woe.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent(dae);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==tR.CAPTURING_PHASE)return!1;if(t)for(var n,i=oe(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(Voe));if(r.getComponent(Voe))return!0}return!1},n._startInertiaScroll=function(e){var t=new Pn(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,a=i.width-r.width,o=i.height-r.height,s=this._calculateAttenuatedFactor(a),c=this._calculateAttenuatedFactor(o);n.x=n.x*a*(1-this.brake)*s,n.y=n.y*o*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var f=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(f*=u=3),0===this.brake&&u>1&&(f*=u),this._startAutoScroll(n,f,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,Pn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(Pn.ZERO,joe)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new Pn,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(Pn.ZERO);else{var n=new Pn;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);Xoe.set(this._getContentPosition()),Xoe.add(n),Xoe.set(Math.round(1e4*Xoe.x)*joe,Math.round(1e4*Xoe.y)*joe,Xoe.z),this._setContentPosition(Xoe);var i=this._getHowMuchOutOfBoundary();Yoe.set(i.x,i.y),this._updateScrollBar(Yoe),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new Pn).equals(Pn.ZERO,joe)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Pn,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),a=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):a+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(a+e.y)),e.equals(Pn.ZERO,joe)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===Woe.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===Woe.SCROLL_TO_TOP||e===Woe.SCROLL_TO_BOTTOM||e===Woe.SCROLL_TO_LEFT||e===Woe.SCROLL_TO_RIGHT){var t=1<<Joe[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}eF.emitEvents(this.scrollEvents,this,Joe[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();Xoe.set(this._getContentPosition()),Xoe.add(e),this._content.setPosition(Xoe),this._updateScrollBar(Yn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===tR.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(Woe.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new Pn;n&&(t.getUILocation(Yoe),t.getUIPreviousLocation(Koe),Xoe.set(Yoe.x,Yoe.y,0),qoe.set(Koe.x,Koe.y,0),n.convertToNodeSpaceAR(Xoe,Xoe),n.convertToNodeSpaceAR(qoe,qoe),Pn.subtract(i,Xoe,qoe)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var a=this._content._uiProps.uiTransformComp,o=a.anchorX,s=a.anchorY,c=a.width,l=a.height,u=this._content.position||Pn.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=Woe.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=Woe.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-o*c+c+n.x<=this._rightBoundary&&(r=Woe.SCROLL_TO_RIGHT):n.x>0&&u.x-o*c+n.x>=this._leftBoundary&&(r=Woe.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(Woe.SCROLL_BEGAN)),this._dispatchEvent(Woe.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(Woe.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Qoe(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=Qoe();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(Pn.ZERO,joe))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(Woe.BOUNCE_TOP),e.y<0&&this._dispatchEvent(Woe.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(Woe.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(Woe.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(Xoe,joe)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(Pn.ZERO,joe)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,Pn.copy(this._autoScrollBrakingStartPosition,this._getContentPosition()),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var a=this._autoScrollTargetDelta.clone();a.multiplyScalar(r);var o=this._autoScrollStartPosition.clone();o.add(a);var s=Math.abs(r-1)<=joe;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(Woe.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=o.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),o.set(this._autoScrollBrakingStartPosition),o.add(c)}else{var l=o.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(Pn.ZERO,joe)||(o.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=o.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(Woe.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(Woe.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(Pn.ZERO,joe))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Woe.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Woe.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(Yn.ZERO,Yn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var a=this._getContentLeftBoundary()-this._leftBoundary;a=-a;var o=new Pn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,o.x=a-s*t.x),i&&(s=c.height-l.height,o.y=r-s*t.y)}return o},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new Pn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var a=this._content._uiProps.uiTransformComp.contentSize;a.height<e.height&&(i=a.height-e.height,n.y=t-i),a.width<e.width&&(i=a.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===my.SCALE&&this._calculateBoundary()},Q(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):w(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Yn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Yn.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(Voe),Goe.EventType=Woe,Roe=ce((Poe=Hoe).prototype,"bounceDuration",[Dc,eoe,toe,noe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Doe=ce(Poe.prototype,"brake",[Dc,ioe,roe,aoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Ooe=ce(Poe.prototype,"elastic",[Dc,ooe,soe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Noe=ce(Poe.prototype,"inertia",[Dc,coe,loe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ce(Poe.prototype,"content",[uoe,hoe,foe],Object.getOwnPropertyDescriptor(Poe.prototype,"content"),Poe.prototype),Moe=ce(Poe.prototype,"horizontal",[Dc,_oe,doe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ce(Poe.prototype,"horizontalScrollBar",[poe,moe,voe],Object.getOwnPropertyDescriptor(Poe.prototype,"horizontalScrollBar"),Poe.prototype),Loe=ce(Poe.prototype,"vertical",[Dc,goe,yoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ce(Poe.prototype,"verticalScrollBar",[Soe,xoe,Eoe],Object.getOwnPropertyDescriptor(Poe.prototype,"verticalScrollBar"),Poe.prototype),Foe=ce(Poe.prototype,"cancelInnerEvents",[Dc,Toe,Coe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Boe=ce(Poe.prototype,"scrollEvents",[Aoe,Dc,boe,Ioe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zoe=ce(Poe.prototype,"_content",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uoe=ce(Poe.prototype,"_horizontalScrollBar",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),koe=ce(Poe.prototype,"_verticalScrollBar",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),woe=Poe))||woe)||woe)||woe)||woe)||woe));l.ScrollView=yse;var Sse,xse=new Pn;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Sse||(Sse={})),st(Sse);var Ese,Tse,Cse,Ase,bse,Ise,wse,Pse,Rse,Dse,Ose,Nse,Mse,Lse,Fse,Bse,zse,Use,kse,Gse,Hse=function(t){return e({Slider:t,SliderComponent:t}),t}((Zoe=Tc("cc.Slider"),$oe=Gc(),ese=Ac(110),tse=Bc(),nse=Cc(_z),ise=al(DH),rse=Xc(),ase=al(Sse),ose=Xc(),sse=qc(),cse=Xc(),lse=al([eF]),use=Xc(),Zoe(hse=$oe(hse=ese(hse=tse(hse=nse((gse=vse=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",_se,re(t)),se(t,"_handle",dse,re(t)),se(t,"_direction",pse,re(t)),se(t,"_progress",mse,re(t)),t._offset=new Pn,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new Pn,t._touchPos=new Pn,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(tC.TOUCH_START,this._onTouchBegan,this),this.node.on(tC.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(tC.TOUCH_END,this._onTouchEnded,this),this.node.on(tC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(tC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(tC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(tC.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(tC.TOUCH_START,this._onTouchBegan,this),this.node.off(tC.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(tC.TOUCH_END,this._onTouchEnded,this),this.node.off(tC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(tC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(tC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(tC.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Pn.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Pn,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){eF.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();Pn.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,xse);this.direction===Sse.Horizontal?this.progress=ln(.5+(i.x-this._offset.x)/n.width):this.progress=ln(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===Sse.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===Sse.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},Q(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(Ku),vse.Direction=Sse,ce((fse=gse).prototype,"handle",[ise,rse],Object.getOwnPropertyDescriptor(fse.prototype,"handle"),fse.prototype),ce(fse.prototype,"direction",[ase,ose],Object.getOwnPropertyDescriptor(fse.prototype,"direction"),fse.prototype),ce(fse.prototype,"progress",[Jc,sse,cse],Object.getOwnPropertyDescriptor(fse.prototype,"progress"),fse.prototype),_se=ce(fse.prototype,"slideEvents",[lse,Dc,use],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dse=ce(fse.prototype,"_handle",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pse=ce(fse.prototype,"_direction",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sse.Horizontal}}),mse=ce(fse.prototype,"_progress",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),hse=fse))||hse)||hse)||hse)||hse)||hse));function Vse(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}l.Slider=Hse,function(e){e.TOGGLE="toggle"}(Gse||(Gse={}));var Wse,jse,Xse,qse,Yse,Kse,Qse,Jse,Zse,$se,ece,tce,nce=function(t){return e({Toggle:t,ToggleComponent:t}),t}((Ese=Tc("cc.Toggle"),Tse=Gc(),Cse=Ac(110),Ase=Bc(),bse=Cc(_z),Ise=Zc(),wse=Xc(),Pse=al(DH),Rse=Zc(),Dse=Xc(),Ose=al([eF]),Nse=Xc(),Ese(Mse=Tse(Mse=Cse(Mse=Ase(Mse=bse((kse=Use=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",Fse,re(t)),se(t,"_isChecked",Bse,re(t)),se(t,"_checkMark",zse,re(t)),t}Z(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&eF.emitEvents(this.checkEvents,this)},Q(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return l.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(vne),Use.EventType=Vse(Gse,pne),ce((Lse=kse).prototype,"isChecked",[Ise,wse],Object.getOwnPropertyDescriptor(Lse.prototype,"isChecked"),Lse.prototype),ce(Lse.prototype,"checkMark",[Pse,Rse,Dse],Object.getOwnPropertyDescriptor(Lse.prototype,"checkMark"),Lse.prototype),Fse=ce(Lse.prototype,"checkEvents",[Ose,Dc,Nse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bse=ce(Lse.prototype,"_isChecked",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zse=ce(Lse.prototype,"_checkMark",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mse=Lse))||Mse)||Mse)||Mse)||Mse)||Mse));l.Toggle=nce;var ice,rce,ace,oce,sce,cce,lce,uce,hce,fce,_ce,dce,pce,mce,vce,gce,yce,Sce,xce,Ece,Tce,Cce,Ace,bce,Ice,wce,Pce,Rce,Dce,Oce,Nce,Mce,Lce,Fce,Bce,zce,Uce,kce,Gce,Hce,Vce,Wce,jce,Xce,qce,Yce=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((Wse=Tc("cc.ToggleContainer"),jse=Gc(),Xse=Ac(110),qse=Bc(),Yse=Xc(),Kse=al([eF]),Qse=Xc(),Wse(Jse=jse(Jse=Xse(Jse=qse(Jse=Fc((tce=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",$se,re(t)),se(t,"checkEvents",ece,re(t)),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(tC.CHILD_ADDED,this.ensureValidState,this),this.node.on(tC.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(tC.CHILD_ADDED,this.ensureValidState,this),this.node.off(tC.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==e&&(t?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&l.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var a=n[r];a!==i&&(a.isChecked=!1)}},Q(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(Ku),$se=ce((Zse=tce).prototype,"_allowSwitchOff",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ce(Zse.prototype,"allowSwitchOff",[Yse],Object.getOwnPropertyDescriptor(Zse.prototype,"allowSwitchOff"),Zse.prototype),ece=ce(Zse.prototype,"checkEvents",[Kse,Dc,Qse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jse=Zse))||Jse)||Jse)||Jse)||Jse)||Jse));l.ToggleContainer=Yce;var Kce,Qce,Jce=new Yn;function Zce(e){return e instanceof MR?aN:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:ti.ZERO}function $ce(e,t,n,i){e.parent?Jce.set(e.parent.getScale().x,e.parent.getScale().y):Jce.set(0,0);for(var r=Jce.x,a=Jce.y,o=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(o+=l.x,s+=l.y,(c=c.parent)===t)break;c?Jce.set(c.getScale().x,c.getScale().y):Jce.set(0,0);var u=Jce.x,h=Jce.y;o*=u,s*=h,r*=u,a*=h}i.x=0!==r?1/r:1,i.y=0!==a?1/a:1,n.x=-o,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(Kce||(Kce={})),st(Kce),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(Qce||(Qce={}));var ele,tle,nle,ile,rle,ale,ole,sle,cle,lle,ule,hle,fle,_le,dle,ple,mle,vle,gle,yle=Qce.TOP|Qce.BOT,Sle=Qce.LEFT|Qce.RIGHT,xle=function(t){return e({Widget:t,WidgetComponent:t}),t}((ice=Tc("cc.Widget"),rce=Gc(),ace=Ac(110),oce=Bc(),sce=Cc(_z),cce=al(ib),lce=Xc(),uce=Xc(),hce=Xc(),fce=Xc(),_ce=Xc(),dce=Xc(),pce=Xc(),mce=Vc(),vce=Vc(),gce=Xc(),yce=Xc(),Sce=Xc(),xce=Xc(),Ece=Xc(),Tce=Xc(),Cce=al(Kce),Ace=Xc(),ice(bce=rce(bce=ace(bce=oce(bce=sce(bce=Fc((qce=Xce=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new Pn,t._lastSize=new ti,t._dirty=!0,t._hadAlignOnce=!1,se(t,"_alignFlags",wce,re(t)),se(t,"_target",Pce,re(t)),se(t,"_left",Rce,re(t)),se(t,"_right",Dce,re(t)),se(t,"_top",Oce,re(t)),se(t,"_bottom",Nce,re(t)),se(t,"_horizontalCenter",Mce,re(t)),se(t,"_verticalCenter",Lce,re(t)),se(t,"_isAbsLeft",Fce,re(t)),se(t,"_isAbsRight",Bce,re(t)),se(t,"_isAbsTop",zce,re(t)),se(t,"_isAbsBottom",Uce,re(t)),se(t,"_isAbsHorizontalCenter",kce,re(t)),se(t,"_isAbsVerticalCenter",Gce,re(t)),se(t,"_originalWidth",Hce,re(t)),se(t,"_originalHeight",Vce,re(t)),se(t,"_alignMode",Wce,re(t)),se(t,"_lockFlags",jce,re(t)),t}Z(t,e);var n=t.prototype;return n.updateAlignment=function(){l._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),l._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){l._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(tC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(tC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(tC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(tC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(tC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(tC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(tC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(tC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:aN;this.isAlignLeft&&e===Qce.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===Qce.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===Qce.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===Qce.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===Qce.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===Qce.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(_z)&&(e.on(tC.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(tC.SIZE_CHANGED,this._setDirtyByMode,this),e.on(tC.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(tC.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(tC.SIZE_CHANGED,this._setDirtyByMode,this),e.off(tC.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(tC.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(tC.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===Kce.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&Sle)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},Q(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&Qce.TOP)>0},set:function(e){this._setAlign(Qce.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&Qce.BOT)>0},set:function(e){this._setAlign(Qce.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&Qce.LEFT)>0},set:function(e){this._setAlign(Qce.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&Qce.RIGHT)>0},set:function(e){this._setAlign(Qce.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&Qce.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=Qce.MID):this._alignFlags&=~Qce.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&Qce.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=Qce.CENTER):this._alignFlags&=~Qce.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&Sle)===Sle}},{key:"isStretchHeight",get:function(){return(this._alignFlags&yle)===yle}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(Qce.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(Qce.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(Qce.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(Qce.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(Qce.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(Qce.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(Ku),Xce.AlignMode=Kce,ce((Ice=qce).prototype,"target",[cce,lce],Object.getOwnPropertyDescriptor(Ice.prototype,"target"),Ice.prototype),ce(Ice.prototype,"isAlignTop",[uce],Object.getOwnPropertyDescriptor(Ice.prototype,"isAlignTop"),Ice.prototype),ce(Ice.prototype,"isAlignBottom",[hce],Object.getOwnPropertyDescriptor(Ice.prototype,"isAlignBottom"),Ice.prototype),ce(Ice.prototype,"isAlignLeft",[fce],Object.getOwnPropertyDescriptor(Ice.prototype,"isAlignLeft"),Ice.prototype),ce(Ice.prototype,"isAlignRight",[_ce],Object.getOwnPropertyDescriptor(Ice.prototype,"isAlignRight"),Ice.prototype),ce(Ice.prototype,"isAlignVerticalCenter",[dce],Object.getOwnPropertyDescriptor(Ice.prototype,"isAlignVerticalCenter"),Ice.prototype),ce(Ice.prototype,"isAlignHorizontalCenter",[pce],Object.getOwnPropertyDescriptor(Ice.prototype,"isAlignHorizontalCenter"),Ice.prototype),ce(Ice.prototype,"isStretchWidth",[mce],Object.getOwnPropertyDescriptor(Ice.prototype,"isStretchWidth"),Ice.prototype),ce(Ice.prototype,"isStretchHeight",[vce],Object.getOwnPropertyDescriptor(Ice.prototype,"isStretchHeight"),Ice.prototype),ce(Ice.prototype,"top",[gce],Object.getOwnPropertyDescriptor(Ice.prototype,"top"),Ice.prototype),ce(Ice.prototype,"editorTop",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"editorTop"),Ice.prototype),ce(Ice.prototype,"bottom",[yce],Object.getOwnPropertyDescriptor(Ice.prototype,"bottom"),Ice.prototype),ce(Ice.prototype,"editorBottom",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"editorBottom"),Ice.prototype),ce(Ice.prototype,"left",[Sce],Object.getOwnPropertyDescriptor(Ice.prototype,"left"),Ice.prototype),ce(Ice.prototype,"editorLeft",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"editorLeft"),Ice.prototype),ce(Ice.prototype,"right",[xce],Object.getOwnPropertyDescriptor(Ice.prototype,"right"),Ice.prototype),ce(Ice.prototype,"editorRight",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"editorRight"),Ice.prototype),ce(Ice.prototype,"horizontalCenter",[Ece],Object.getOwnPropertyDescriptor(Ice.prototype,"horizontalCenter"),Ice.prototype),ce(Ice.prototype,"editorHorizontalCenter",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"editorHorizontalCenter"),Ice.prototype),ce(Ice.prototype,"verticalCenter",[Tce],Object.getOwnPropertyDescriptor(Ice.prototype,"verticalCenter"),Ice.prototype),ce(Ice.prototype,"editorVerticalCenter",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"editorVerticalCenter"),Ice.prototype),ce(Ice.prototype,"isAbsoluteTop",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"isAbsoluteTop"),Ice.prototype),ce(Ice.prototype,"isAbsoluteBottom",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"isAbsoluteBottom"),Ice.prototype),ce(Ice.prototype,"isAbsoluteLeft",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"isAbsoluteLeft"),Ice.prototype),ce(Ice.prototype,"isAbsoluteRight",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"isAbsoluteRight"),Ice.prototype),ce(Ice.prototype,"isAbsoluteHorizontalCenter",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"isAbsoluteHorizontalCenter"),Ice.prototype),ce(Ice.prototype,"isAbsoluteVerticalCenter",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"isAbsoluteVerticalCenter"),Ice.prototype),ce(Ice.prototype,"alignMode",[Cce,Ace],Object.getOwnPropertyDescriptor(Ice.prototype,"alignMode"),Ice.prototype),ce(Ice.prototype,"alignFlags",[Hc],Object.getOwnPropertyDescriptor(Ice.prototype,"alignFlags"),Ice.prototype),wce=ce(Ice.prototype,"_alignFlags",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pce=ce(Ice.prototype,"_target",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rce=ce(Ice.prototype,"_left",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dce=ce(Ice.prototype,"_right",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oce=ce(Ice.prototype,"_top",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nce=ce(Ice.prototype,"_bottom",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mce=ce(Ice.prototype,"_horizontalCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lce=ce(Ice.prototype,"_verticalCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fce=ce(Ice.prototype,"_isAbsLeft",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Bce=ce(Ice.prototype,"_isAbsRight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zce=ce(Ice.prototype,"_isAbsTop",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Uce=ce(Ice.prototype,"_isAbsBottom",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kce=ce(Ice.prototype,"_isAbsHorizontalCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Gce=ce(Ice.prototype,"_isAbsVerticalCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hce=ce(Ice.prototype,"_originalWidth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vce=ce(Ice.prototype,"_originalHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wce=ce(Ice.prototype,"_alignMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kce.ON_WINDOW_RESIZE}}),jce=ce(Ice.prototype,"_lockFlags",[Dc,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bce=Ice))||bce)||bce)||bce)||bce)||bce)||bce));l.internal.computeInverseTransForTarget=$ce,l.internal.getReadonlyNodeSize=Zce,l.Widget=xle;var Ele,Tle=new In;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Ele||(Ele={})),st(Ele);var Cle,Ale,ble,Ile,wle,Ple,Rle,Dle,Ole,Nle,Mle,Lle,Fle,Ble,zle,Ule,kle,Gle,Hle,Vle,Wle,jle,Xle,qle,Yle,Kle,Qle,Jle,Zle,$le,eue,tue,nue,iue,rue,aue,oue,sue,cue,lue,uue,hue,fue,_ue=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((ele=Tc("cc.PageViewIndicator"),tle=Gc(),nle=Ac(110),ile=Bc(),rle=al(BF),ale=Xc(),ole=al(Ele),sle=Xc(),cle=al(ti),lle=Xc(),ule=Xc(),ele(hle=tle(hle=nle(hle=ile((gle=vle=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"spacing",_le,re(t)),se(t,"_spriteFrame",dle,re(t)),se(t,"_direction",ple,re(t)),se(t,"_cellSize",mle,re(t)),t._layout=null,t._pageView=null,t._indicators=[],t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(dae),this._layout||(this._layout=this.addComponent(dae));var e=this._layout;this.direction===Ele.HORIZONTAL?(e.type=dae.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===Ele.VERTICAL&&(e.type=dae.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=dae.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new ib;e.layer=this.node.layer;var t=e.addComponent(DH);return t.spriteFrame=this.spriteFrame,t.sizeMode=DH.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;Tle.set(r.color),Tle.a=127.5,r.color=Tle}}if(e[t]._uiProps.uiComp){var a=e[t]._uiProps.uiComp;Tle.set(a.color),Tle.a=255,a.color=Tle}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},Q(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(Ku),vle.Direction=Ele,ce((fle=gle).prototype,"spriteFrame",[rle,ale],Object.getOwnPropertyDescriptor(fle.prototype,"spriteFrame"),fle.prototype),ce(fle.prototype,"direction",[ole,sle],Object.getOwnPropertyDescriptor(fle.prototype,"direction"),fle.prototype),ce(fle.prototype,"cellSize",[cle,lle],Object.getOwnPropertyDescriptor(fle.prototype,"cellSize"),fle.prototype),_le=ce(fle.prototype,"spacing",[Dc,ule],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dle=ce(fle.prototype,"_spriteFrame",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ple=ce(fle.prototype,"_direction",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ele.HORIZONTAL}}),mle=ce(fle.prototype,"_cellSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(20,20)}}),hle=fle))||hle)||hle)||hle)||hle));l.PageViewIndicator=_ue;var due,pue,mue,vue=new Yn;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(due||(due={})),st(due),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(pue||(pue={})),st(pue),function(e){e.PAGE_TURNING="page-turning"}(mue||(mue={}));var gue=function(t){return e({PageView:t,PageViewComponent:t}),t}((Cle=Tc("cc.PageView"),Ale=Gc(),ble=Ac(110),Ile=Bc(),wle=al(due),Ple=Xc(),Rle=al(pue),Dle=Xc(),Ole=qc(),Nle=Xc(),Mle=qc(),Lle=Xc(),Fle=al(_ue),Ble=Xc(),zle=Xc(),Ule=al(Yae),kle=Vc(),Gle=al(Yae),Hle=Vc(),Vle=Vc(),Wle=Vc(),jle=Vc(),Xle=al([eF]),qle=Vc(),Yle=Xc(),Kle=al([eF]),Qle=Xc(),Cle(Jle=Ale(Jle=ble(Jle=Ile((fue=hue=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",$le,re(t)),se(t,"horizontal",eue,re(t)),se(t,"vertical",tue,re(t)),se(t,"cancelInnerEvents",nue,re(t)),se(t,"scrollEvents",iue,re(t)),se(t,"pageTurningSpeed",rue,re(t)),se(t,"pageEvents",aue,re(t)),se(t,"_sizeMode",oue,re(t)),se(t,"_direction",sue,re(t)),se(t,"_scrollThreshold",cue,re(t)),se(t,"_pageTurningEventTiming",lue,re(t)),se(t,"_indicator",uue,re(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Pn,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Yn,t._touchEndPosition=new Yn,t}Z(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(tC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(tC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):w(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void w(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):R(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent(dae);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===pue.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===due.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(vue),Yn.set(this._touchBeganPosition,vue.x,vue.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(vue),Yn.set(this._touchEndPosition,vue.x,vue.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(vue),Yn.set(this._touchEndPosition,vue.x,vue.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===pue.Horizontal,this.vertical=this.direction===pue.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(dae);if(t){if(this._sizeMode===due.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===pue.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===pue.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,eF.emitEvents(this.pageEvents,this,mue.PAGE_TURNING),this.node.emit(mue.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===pue.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===pue.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new Yn;if(this._sizeMode===due.Free)this.direction===pue.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===pue.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===pue.Horizontal?t.x=e*n.width:this.direction===pue.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===pue.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===due.Free){var i=0,r=0;if(this.direction===pue.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===pue.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var a=this.view;if(!a)return!1;if(this.direction===pue.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===pue.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new Yn;Yn.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var a=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(a))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},Q(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(yse),hue.SizeMode=due,hue.Direction=pue,hue.EventType=Vse(mue,Woe),ce((Zle=fue).prototype,"sizeMode",[wle,Ple],Object.getOwnPropertyDescriptor(Zle.prototype,"sizeMode"),Zle.prototype),ce(Zle.prototype,"direction",[Rle,Dle],Object.getOwnPropertyDescriptor(Zle.prototype,"direction"),Zle.prototype),ce(Zle.prototype,"scrollThreshold",[Jc,Ole,Nle],Object.getOwnPropertyDescriptor(Zle.prototype,"scrollThreshold"),Zle.prototype),ce(Zle.prototype,"pageTurningEventTiming",[Jc,Mle,Lle],Object.getOwnPropertyDescriptor(Zle.prototype,"pageTurningEventTiming"),Zle.prototype),ce(Zle.prototype,"indicator",[Fle,Ble],Object.getOwnPropertyDescriptor(Zle.prototype,"indicator"),Zle.prototype),$le=ce(Zle.prototype,"autoPageTurningThreshold",[Dc,zle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),ce(Zle.prototype,"verticalScrollBar",[Ule,sl,kle],Object.getOwnPropertyDescriptor(Zle.prototype,"verticalScrollBar"),Zle.prototype),ce(Zle.prototype,"horizontalScrollBar",[Gle,sl,Hle],Object.getOwnPropertyDescriptor(Zle.prototype,"horizontalScrollBar"),Zle.prototype),eue=ce(Zle.prototype,"horizontal",[sl,Dc,Vle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tue=ce(Zle.prototype,"vertical",[sl,Dc,Wle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nue=ce(Zle.prototype,"cancelInnerEvents",[sl,Dc,jle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iue=ce(Zle.prototype,"scrollEvents",[Xle,Dc,sl,qle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rue=ce(Zle.prototype,"pageTurningSpeed",[Dc,Hc,Yle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),aue=ce(Zle.prototype,"pageEvents",[Kle,Dc,Qle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oue=ce(Zle.prototype,"_sizeMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return due.Unified}}),sue=ce(Zle.prototype,"_direction",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pue.Horizontal}}),cue=ce(Zle.prototype,"_scrollThreshold",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),lue=ce(Zle.prototype,"_pageTurningEventTiming",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),uue=ce(Zle.prototype,"_indicator",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jle=Zle))||Jle)||Jle)||Jle)||Jle));l.PageView=gue;var yue=new Pn,Sue=new Yn,xue=new Yn,Eue=new Yn(1,1),Tue=new Yn,Cue=new Yn;function Aue(e,t){if(!t._hadAlignOnce){t.alignMode===Kce.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=xue,a=Eue;i?$ce(e,n=i,r,a):n=e.parent;var o=Zce(n),s=n instanceof MR||!n.getComponent(_z),c=s?Sue:n.getComponent(_z).anchorPoint,l=s;e.getPosition(yue);var u=e._uiProps.uiTransformComp,h=yue.x,f=yue.y,_=u.anchorPoint,d=e.getScale();if(t.alignFlags&Qce.HORIZONTAL){var p=0,m=0,v=o.width;l?(p=aN.left.x,m=aN.right.x):m=(p=-c.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(p+=r.x,p*=a.x,m+=r.x,m*=a.x);var g=0,y=_.x,S=d.x;if(S<0&&(y=1-y,S=-S),t.isStretchWidth)g=m-p,0!==S&&(u.width=g/S),h=p+y*g;else if(g=u.width*S,t.isAlignHorizontalCenter){var x=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,E=(.5-c.x)*o.width;i&&(x*=a.x,E+=r.x,E*=a.x),h=E+(y-.5)*g+x}else h=t.isAlignLeft?p+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&Qce.VERTICAL){var T=0,C=0,A=o.height;l?(C=aN.bottom.y,T=aN.top.y):T=(C=-c.y*A)+A,C+=t.isAbsoluteBottom?t.bottom:t.bottom*A,T-=t.isAbsoluteTop?t.top:t.top*A,i&&(C+=r.y,C*=a.y,T+=r.y,T*=a.y);var b=0,I=_.y,w=d.y;if(w<0&&(I=1-I,w=-w),t.isStretchHeight)b=T-C,0!==w&&(u.height=b/w),f=C+I*b;else if(b=u.height*w,t.isAlignVerticalCenter){var P=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*A,R=(.5-c.y)*o.height;i&&(P*=a.y,R+=r.y,R*=a.y),f=R+(I-.5)*b+P}else f=t.isAlignBottom?C+I*b:T+(I-1)*b;t._lastSize.height=b}e.setPosition(h,f,yue.z),Pn.set(t._lastPos,h,f,yue.z)}}function bue(e){var t=e.getComponent(xle);if(t&&t.enabled){if(!l.isValid(e,!0))return;Pue.push(t)}for(var n,i=oe(e.children);!(n=i()).done;){var r=n.value;r.active&&bue(r)}}function Iue(){var e=nN.getScene();if(e){Rue.isAligning=!0,Rue._nodesOrderDirty&&(Pue.length=0,bue(e),Rue._nodesOrderDirty=!1);var t=null,n=Rue._activeWidgetsIterator;for(n.i=0;n.i<Pue.length;++n.i)(t=Pue[n.i])._dirty&&(Aue(t.node,t),t._dirty=!1);Rue.isAligning=!1}}var wue,Pue=[],Rue=e("widgetManager",l._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new tt.MutableForwardIterator(Pue),animationState:null,init:function(){nN.on(tN.EVENT_AFTER_SCENE_LAUNCH,Iue),nN.on(tN.EVENT_AFTER_UPDATE,Iue),cN.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);cN.instance.on("canvas-resize",e),nh.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=nN.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=ib.isNode(e)&&e.getComponent(xle);t&&t.enabled&&(t.alignMode===Kce.ON_WINDOW_RESIZE||t.alignMode===Kce.ALWAYS)&&t.setDirty();for(var n,i=oe(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var a=Tue;a.set(0,0);var o=Cue;if(o.set(1,1),e.target&&$ce(i,r=e.target,a,o),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:Sue,l=i._uiProps.uiTransformComp,u=Zce(r),h=l.anchorPoint,f=i.getPosition(),_=Qce,d=i.getScale(),p=0;if(t&_.LEFT){var m=-c.x*u.width;m+=a.x,m*=o.x,p=f.x-h.x*l.width*Math.abs(d.x)-m,e.isAbsoluteLeft||(p/=u.width),p/=o.x,e.left=n(e.left,p)}if(t&_.RIGHT){var v=(1-c.x)*u.width;v+=a.x,p=(v*=o.x)-(f.x+(1-h.x)*l.width*Math.abs(d.x)),e.isAbsoluteRight||(p/=u.width),p/=o.x,e.right=n(e.right,p)}if(t&_.TOP){var g=(1-c.y)*u.height;g+=a.y,p=(g*=o.y)-(f.y+(1-h.y)*l.height*Math.abs(d.y)),e.isAbsoluteTop||(p/=u.height),p/=o.y,e.top=n(e.top,p)}if(t&_.BOT){var y=-c.y*u.height;y+=a.y,y*=o.y,p=f.y-h.y*l.height*Math.abs(d.y)-y,e.isAbsoluteBottom||(p/=u.height),p/=o.y,e.bottom=n(e.bottom,p)}}},updateAlignment:function e(t){var n=t.parent;n&&ib.isNode(n)&&e(n);var i=t.getComponent(xle);i&&n&&Aue(t,i)},AlignMode:Kce,AlignFlags:Qce});nN.on(tN.EVENT_INIT,(function(){Rue.init()}));var Due,Oue,Nue,Mue,Lue,Fue,Bue,zue,Uue,kue,Gue,Hue,Vue,Wue,jue,Xue,que,Yue,Kue,Que=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(Tc("cc.SafeArea")(wue=Gc()(wue=Ac(110)(wue=Fc(wue=Bc()(wue=Cc(xle)(wue=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),nh.on("window-resize",this.updateArea,this),nh.on("orientation-change",this.updateArea,this)},n.onDisable=function(){nh.off("window-resize",this.updateArea,this),nh.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(xle),t=this.node.getComponent(_z);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=fN.getVisibleSize(),a=r.width,o=r.height,s=ah.getSafeAreaRect();e.top=o-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=a-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),Rue.add(e)}},t}(Ku))||wue)||wue)||wue)||wue)||wue)||wue);l.SafeArea=Que;var Jue,Zue=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((Due=Tc("cc.UICoordinateTracker"),Oue=Gc(),Nue=Bc(),Mue=Ac(110),Lue=al(ib),Fue=Xc(),Bue=al(gF),zue=Xc(),Uue=Xc(),kue=Xc(),Gue=al([eF]),Hue=Xc(),Due(Vue=Oue(Vue=Nue(Vue=Mue((ce((Wue=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",jue,re(t)),se(t,"_target",Xue,re(t)),se(t,"_camera",que,re(t)),se(t,"_useScale",Yue,re(t)),se(t,"_distance",Kue,re(t)),t._transformPos=new Pn,t._viewPos=new Pn,t._canMove=!0,t._lastWPos=new Pn,t._lastCameraPos=new Pn,t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&Pn.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);eF.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},Q(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(Ku)).prototype,"target",[Lue,Fue],Object.getOwnPropertyDescriptor(Wue.prototype,"target"),Wue.prototype),ce(Wue.prototype,"camera",[Bue,zue],Object.getOwnPropertyDescriptor(Wue.prototype,"camera"),Wue.prototype),ce(Wue.prototype,"useScale",[Uue],Object.getOwnPropertyDescriptor(Wue.prototype,"useScale"),Wue.prototype),ce(Wue.prototype,"distance",[kue],Object.getOwnPropertyDescriptor(Wue.prototype,"distance"),Wue.prototype),jue=ce(Wue.prototype,"syncEvents",[Gue,Dc,Hue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xue=ce(Wue.prototype,"_target",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),que=ce(Wue.prototype,"_camera",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yue=ce(Wue.prototype,"_useScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kue=ce(Wue.prototype,"_distance",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Vue=Wue))||Vue)||Vue)||Vue)||Vue)),$ue=[tC.TOUCH_START,tC.TOUCH_END,tC.TOUCH_MOVE,tC.MOUSE_DOWN,tC.MOUSE_MOVE,tC.MOUSE_UP,tC.MOUSE_ENTER,tC.MOUSE_LEAVE,tC.MOUSE_WHEEL];function ehe(e){e.propagationStopped=!0}var the,nhe,ihe,rhe,ahe,ohe,she,che,lhe,uhe,hhe,fhe,_he=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(Tc("cc.BlockInputEvents")(Jue=Gc()(Jue=Bc()(Jue=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<$ue.length;e++)this.node.on($ue[e],ehe,this)},n.onDisable=function(){for(var e=0;e<$ue.length;e++)this.node.off($ue[e],ehe,this)},t}(Ku))||Jue)||Jue)||Jue),dhe=e("SubContextView",(the=Tc("cc.SubContextView"),nhe=Gc(),ihe=Ac(110),rhe=Cc(_z),ahe=Bc(),ohe=Xc(),she=Xc(),the(che=nhe(che=ihe(che=rhe(che=ahe((ce((lhe=function(e){function t(){var t;return se(t=e.call(this)||this,"_fps",uhe,re(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,se(t,"_designResolutionSize",hhe,re(t)),t._content=new ib("content"),t._content.hideFlags|=_l.Flags.DontSave|_l.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new Hm,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new hv,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){CF.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=CF.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._designResolutionSize.width,n=this._designResolutionSize.height;e.width=t,e.height=n}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(DH),this._sprite||(this._sprite=this._content.addComponent(DH)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new BF;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(_z),t=this._content.getComponent(_z),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var a=fN.getViewportRect(),o=t.getBoundingBoxToWorld(),s=fN.getVisibleSize(),c=nh.devicePixelRatio,l=(a.width*(o.x/s.width)+a.x)/c,u=(a.height*(o.y/s.height)+a.y)/c,h=a.width*(o.width/s.width)/c,f=a.height*(o.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:f})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(tC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(tC.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(tC.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(tC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(tC.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(tC.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},Q(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(Ku)).prototype,"designResolutionSize",[ohe],Object.getOwnPropertyDescriptor(lhe.prototype,"designResolutionSize"),lhe.prototype),ce(lhe.prototype,"fps",[she],Object.getOwnPropertyDescriptor(lhe.prototype,"fps"),lhe.prototype),uhe=ce(lhe.prototype,"_fps",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),hhe=ce(lhe.prototype,"_designResolutionSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(640,960)}}),che=lhe))||che)||che)||che)||che)||che));l.SubContextView=dhe;var phe=e("UIReorderComponent",Tc("cc.UIReorderComponent")(fhe=function(){R(1408,"UIReorderComponent")})||fhe);l.UIReorderComponent=phe,l.ButtonComponent=vne,nt.setClassAlias(vne,"cc.ButtonComponent"),l.EditBoxComponent=Vre,nt.setClassAlias(Vre,"cc.EditBoxComponent"),l.LayoutComponent=dae,nt.setClassAlias(dae,"cc.LayoutComponent"),l.ProgressBarComponent=Uae,nt.setClassAlias(Uae,"cc.ProgressBarComponent"),l.ScrollViewComponent=yse,nt.setClassAlias(yse,"cc.ScrollViewComponent"),l.ScrollBarComponent=Yae,nt.setClassAlias(Yae,"cc.ScrollBarComponent"),l.SliderComponent=Hse,nt.setClassAlias(Hse,"cc.SliderComponent"),l.ToggleComponent=nce,nt.setClassAlias(nce,"cc.ToggleComponent"),l.ToggleContainerComponent=Yce,nt.setClassAlias(Yce,"cc.ToggleContainerComponent"),l.WidgetComponent=xle,nt.setClassAlias(xle,"cc.WidgetComponent"),l.PageViewComponent=gue,nt.setClassAlias(gue,"cc.PageViewComponent"),l.PageViewIndicatorComponent=_ue,nt.setClassAlias(_ue,"cc.PageViewIndicatorComponent"),l.SafeAreaComponent=Que,nt.setClassAlias(Que,"cc.SafeAreaComponent"),nt.setClassAlias(Zue,"cc.UICoordinateTrackerComponent"),l.BlockInputEventsComponent=_he,nt.setClassAlias(_he,"cc.BlockInputEventsComponent")}}}));
